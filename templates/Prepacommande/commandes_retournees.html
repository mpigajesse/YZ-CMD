{% extends 'composant_generale/operatPrepa/base.html' %}

{% block title %}Commandes Retournées - YZ-CMD{% endblock %}



{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg"
         style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-dark));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-undo mr-3"></i>
                Commandes Retournées
            </h1>
            <p style="color: var(--preparation-border-accent);">Commandes dont l'état actuel est "Retournée" et préparées par vous</p>
        </div>
        <div class="text-right">
            <div class="text-4xl font-bold">{{ commandes_count }}</div>
            <div class="text-sm opacity-90">Commandes</div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-lg border p-6 mb-8" style="border-color: var(--preparation-border-accent);">
        <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200">
                <thead style="background-color: var(--preparation-primary);">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID YZ</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N° Externe</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Téléphone</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville & Région</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date Retour</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Opérateur Retour</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Commentaire</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for commande in commandes_retournees %}
                    <tr class="hover:bg-yellow-50 transition-colors border-l-4 border-yellow-400">
                        <td class="px-4 py-4 whitespace-nowrap">
                            <a href="{% url 'Prepacommande:detail_prepa' commande.pk %}" class="text-sm font-medium hover:underline" style="color: var(--preparation-primary);">
                                {{ commande.id_yz }}
                            </a>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ commande.num_cmd|default:'-' }}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                        </td>
                        
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900 font-medium"><i class="fas fa-phone mr-1"></i>{{ commande.client.numero_tel|default:'-' }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                            <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-green-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">
                                {% if commande.date_retournee %}
                                    {{ commande.date_retournee|date:"d/m/Y H:i" }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% if commande.operateur_retour %}
                                <div class="text-sm text-gray-900">{{ commande.operateur_retour.prenom }} {{ commande.operateur_retour.nom }}</div>
                            {% else %}
                                <div class="text-sm text-gray-400">-</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4">
                            <div class="text-sm text-gray-900 max-w-xs truncate" title="{{ commande.commentaire_retournee|default:'' }}">
                                {% if commande.commentaire_retournee %}
                                    {{ commande.commentaire_retournee|truncatechars:50 }}
                                {% else %}
                                    <span class="text-gray-400">Aucun commentaire</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center">
                            <a href="{% url 'Prepacommande:detail_prepa' commande.pk %}"
                               class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 transition-colors mr-2">
                                <i class="fas fa-eye mr-1"></i> Détail
                            </a>
                            <button onclick="ouvrirModalTraitement({{ commande.pk }}, '{{ commande.id_yz }}', '{{ commande.num_cmd|default:commande.id_yz }}')"
                               class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-orange-600 hover:bg-orange-700 transition-colors">
                                <i class="fas fa-tools mr-1"></i> Traiter
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center py-10 text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-undo text-4xl text-yellow-400 mb-4"></i>
                                <p class="text-lg font-medium">Aucune commande retournée</p>
                                <p class="text-sm text-gray-400">Pas de commande en état "Retournée" vous concernant</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modale de traitement des commandes retournées -->
<div id="modalTraitement" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-tête de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-tools text-2xl mr-3" style="color: var(--preparation-primary);"></i>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Gérer le Stock</h3>
                        <p class="text-sm text-gray-600">Commande <span id="modalCommandeId"></span> (reste en état "Retournée")</p>
                    </div>
                </div>
                <button onclick="fermerModalTraitement()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>



            <!-- Options de réincrémentation du stock -->
            <div id="optionsStock" class="mb-6">
                <label class="text-sm font-medium text-gray-700 block mb-2">État des produits retournés</label>
                <div class="space-y-3">
                    <div class="flex items-center">
                        <input type="radio" id="stockBon" name="etat_stock" value="bon" 
                               class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300" checked>
                        <label for="stockBon" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            Produits en bon état (réincrémenter le stock)
                        </label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="stockMauvais" name="etat_stock" value="defectueux" 
                               class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300">
                        <label for="stockMauvais" class="ml-2 block text-sm text-gray-700">
                            <i class="fas fa-times-circle text-red-500 mr-2"></i>
                            Produits défectueux (ne pas réincrémenter)
                        </label>
                    </div>
                </div>
                <p class="mt-2 text-sm text-gray-500">
                    <i class="fas fa-info-circle text-blue-500 mr-1"></i>
                    Les produits en bon état seront automatiquement réincrémentés dans le stock disponible. La commande reste en état "Retournée".
                </p>
            </div>

            <!-- Commentaire obligatoire -->
            <div class="mb-6">
                <label for="commentaireTraitement" class="text-sm font-medium text-gray-700">Commentaire de traitement (obligatoire)</label>
                <textarea name="commentaireTraitement" id="commentaireTraitement" rows="4" 
                          class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" 
                          placeholder="Décrivez le traitement effectué sur cette commande retournée..." required></textarea>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button onclick="fermerModalTraitement()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="confirmerTraitement()" 
                        class="px-4 py-2 text-white rounded-md transition-colors" 
                        style="background-color: var(--preparation-primary);">
                    <i class="fas fa-check mr-2"></i>Confirmer la gestion du stock
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modale de confirmation personnalisée -->
<div id="modalConfirmation" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- En-tête de la modale -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-question-circle text-2xl mr-3 text-blue-500"></i>
                    <h3 class="text-lg font-semibold text-gray-900">Confirmation</h3>
                </div>
                <button onclick="fermerModalConfirmation()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Contenu de confirmation -->
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Commande:</strong> <span id="confirmationCommandeId"></span>
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-start">
                        <i class="fas fa-tasks text-green-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Action:</p>
                            <p class="text-sm text-gray-600">Gestion du stock (commande reste "Retournée")</p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-boxes text-blue-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">État du stock:</p>
                            <p class="text-sm text-gray-600" id="confirmationEtatStock"></p>
                        </div>
                    </div>
                    
                    <div class="flex items-start">
                        <i class="fas fa-comment text-purple-500 mt-1 mr-3"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-900">Commentaire:</p>
                            <p class="text-sm text-gray-600" id="confirmationCommentaire"></p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Êtes-vous sûr de vouloir procéder à cette action ?
                    </p>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button onclick="fermerModalConfirmation()" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button onclick="executerTraitement()" 
                        class="px-4 py-2 text-white rounded-md transition-colors bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-check mr-2"></i>Confirmer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- Token CSRF pour les requêtes AJAX -->
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Système de notifications toast -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Styles pour les notifications -->
<style>
.notification {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.notification-success {
    background: linear-gradient(135deg, #10b981, #059669);
    border-left-color: #047857;
}

.notification-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    border-left-color: #b91c1c;
}

.notification-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border-left-color: #b45309;
}

.notification-info {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border-left-color: #1d4ed8;
}

.notification:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.notification button:hover {
    transform: scale(1.1);
}

/* Animation d'entrée et de sortie */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.notification-enter {
    animation: slideInRight 0.3s ease-out;
}

.notification-exit {
    animation: slideOutRight 0.3s ease-in;
}
</style>

<script>
let commandeActuelle = null;

// Fonction de notification toast moderne
function showNotification(type, message, duration = 5000) {
    const container = document.getElementById('notificationContainer');
    
    // Créer la notification
    const notification = document.createElement('div');
    notification.className = `notification notification-${type} transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
    
    // Icônes selon le type
    const icons = {
        success: 'fas fa-check-circle',
        error: 'fas fa-exclamation-circle',
        warning: 'fas fa-exclamation-triangle',
        info: 'fas fa-info-circle'
    };
    
    // Couleurs selon le type
    const colors = {
        success: 'bg-green-500 border-green-600',
        error: 'bg-red-500 border-red-600',
        warning: 'bg-yellow-500 border-yellow-600',
        info: 'bg-blue-500 border-blue-600'
    };
    
    // Contenu de la notification
    notification.innerHTML = `
        <div class="flex items-center p-4 rounded-lg shadow-lg border-l-4 ${colors[type]} text-white min-w-80 max-w-md">
            <div class="flex-shrink-0">
                <i class="${icons[type]} text-xl"></i>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium">${message}</p>
            </div>
            <div class="ml-3 flex-shrink-0">
                <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    // Ajouter à la page
    container.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.classList.remove('translate-x-full', 'opacity-0');
    }, 100);
    
    // Suppression automatique
    setTimeout(() => {
        if (notification.parentElement) {
            notification.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, duration);
    
    // Suppression manuelle au clic
    notification.addEventListener('click', (e) => {
        if (e.target.closest('button')) return;
        notification.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    });
}

function ouvrirModalTraitement(commandeId, idYz, numCmd) {
    commandeActuelle = commandeId;
    
    // Mettre à jour l'ID de la commande dans la modale
    const commandeDisplay = numCmd || `YZ-${idYz}`;
    document.getElementById('modalCommandeId').textContent = commandeDisplay;
    
    // Réinitialiser le formulaire
    document.getElementById('commentaireTraitement').value = '';
    document.getElementById('stockBon').checked = true;
    
    // Afficher la modale
    document.getElementById('modalTraitement').classList.remove('hidden');
}

function fermerModalTraitement() {
    document.getElementById('modalTraitement').classList.add('hidden');
    commandeActuelle = null;
}

function confirmerTraitement() {
    if (!commandeActuelle) {
        showNotification('error', 'Erreur: Aucune commande sélectionnée');
        return;
    }
    
    const commentaire = document.getElementById('commentaireTraitement').value.trim();
    if (!commentaire) {
        showNotification('warning', 'Veuillez saisir un commentaire de traitement');
        return;
    }
    
    // Récupérer les valeurs
    const etatStock = document.querySelector('input[name="etat_stock"]:checked').value;
    const commandeId = document.getElementById('modalCommandeId').textContent;
    
    // Remplir la modale de confirmation
    document.getElementById('confirmationCommandeId').textContent = commandeId;
    document.getElementById('confirmationEtatStock').textContent = getEtatStockLabel(etatStock);
    document.getElementById('confirmationCommentaire').textContent = commentaire;
    
    // Masquer la modale de traitement et afficher la modale de confirmation
    document.getElementById('modalTraitement').classList.add('hidden');
    document.getElementById('modalConfirmation').classList.remove('hidden');
}

function fermerModalConfirmation() {
    document.getElementById('modalConfirmation').classList.add('hidden');
    // Remontrer la modale de traitement
    document.getElementById('modalTraitement').classList.remove('hidden');
}

function executerTraitement() {
    // Récupérer les valeurs depuis la modale de traitement
    const commentaire = document.getElementById('commentaireTraitement').value.trim();
    const etatStock = document.querySelector('input[name="etat_stock"]:checked').value;
    const typeTraitement = 'repreparer';
    
    // Fermer la modale de confirmation
    fermerModalConfirmation();
    
    // Appeler l'API pour traiter la commande
    traiterCommandeRetournee(typeTraitement, etatStock, commentaire);
}


function getEtatStockLabel(etat) {
    switch(etat) {
        case 'bon':
            return 'Produits en bon état (stock réincrémenté)';
        case 'defectueux':
            return 'Produits défectueux (stock non réincrémenté)';
        default:
            return etat;
    }
}



// Fermer la modale en cliquant à l'extérieur
document.getElementById('modalTraitement').addEventListener('click', function(e) {
    if (e.target === this) {
        fermerModalTraitement();
    }
});

// Fermer la modale de confirmation en cliquant à l'extérieur
document.getElementById('modalConfirmation').addEventListener('click', function(e) {
    if (e.target === this) {
        fermerModalConfirmation();
    }
});

// Fermer la modale avec la touche Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        fermerModalTraitement();
        fermerModalConfirmation();
    }
});



function traiterCommandeRetournee(typeTraitement, etatStock, commentaire) {
    const url = `/operateur-preparation/api/traiter-commande-retournee/${commandeActuelle}/`;
    
    // Récupérer le token CSRF depuis le template
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
        },
        body: JSON.stringify({
            type_traitement: typeTraitement,
            etat_stock: etatStock,
            commentaire: commentaire
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Commande traitée avec succès ! Redirection en cours...', 4000);
            fermerModalTraitement();
            // Recharger la page pour mettre à jour la liste
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showNotification('error', `Erreur lors du traitement: ${data.message}`, 6000);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('error', 'Erreur de réseau lors du traitement. Veuillez réessayer.', 6000);
    });
}


</script>
{% endblock %}


