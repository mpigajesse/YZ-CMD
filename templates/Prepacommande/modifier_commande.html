{% extends 'composant_generale/operatPrepa/base.html' %}
{% load static %}
{% load prepa_filters %}

{% block title %}Modifier Commande {{ commande.id_yz }} - Préparation{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .animate-slideInUp { animation: slideInUp 0.6s ease-out forwards; opacity: 0; }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .btn-prepa { background: linear-gradient(to right, #361f27, #4b2e3a); color: white; transition: all 0.3s; }
    .btn-prepa:hover { background: #412a34; }
    .section-title { color: #361f27; }
    .renvoi-alert { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; }
    .renvoi-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .modification-section { background: linear-gradient(135deg, #dbeafe, #bfdbfe); border: 2px solid #3b82f6; }
    .quick-action-btn { transition: all 0.3s ease; }
    .quick-action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .filter-btn { transition: all 0.3s ease; }
    .filter-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .filter-btn.active { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    
    /* Styles pour la logique upsell */
    .upsell-badge {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        color: white;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    .compteur-upsell {
        transition: all 0.3s ease;
    }
    
    .compteur-upsell.updated {
        animation: highlight 1s ease-out;
    }
    
    @keyframes highlight {
        0% { background-color: #fef3c7; }
        100% { background-color: transparent; }
    }
    
    .prix-upsell {
        color: #f59e0b;
        font-weight: bold;
    }
    
    .prix-normal {
        color: #059669;
    }
    
    .prix-promo {
        color: #dc2626;
    }
    
    .prix-liquidation {
        color: #ea580c;
    }
    
    .prix-test {
        color: #7c3aed;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
        <!-- En-tête avec informations de renvoi -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #361f27, #4b2e3a);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3"></i> Modifier Commande {{ commande.id_yz }}
                <button type="button" onclick="ouvrirModalInfoTotal()" class="ml-3 text-white/80 hover:text-white">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </h1>
            <p>Modification des détails de la commande en préparation</p>
            
            <!-- Badge de renvoi si applicable -->
            {% if is_commande_renvoyee %}
                <div class="mt-3 renvoi-badge inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fas fa-undo mr-2"></i>
                    Commande renvoyée par la logistique
                </div>
            {% endif %}
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold total-final-commande">{{ total_articles|add:commande.ville.frais_livraison|default:0|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold compteur-upsell" id="compteur-upsell-header">
                    {% if commande.compteur > 0 %}
                        <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                    {% else %}
                        <i class="fas fa-info-circle mr-1"></i>Aucun upsell
                    {% endif %}
                </div>
                <div class="text-sm opacity-80">Niveau upsell actuel</div>
            </div>
        </div>
    </div>

    <!-- Section d'alerte pour les commandes renvoyées -->
    {% if is_commande_renvoyee and operation_renvoi %}
        <div class="renvoi-alert rounded-lg p-4 mb-4 animate-slideInUp">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-amber-600 text-lg mr-3"></i>
                <div class="flex-1">
                    <h3 class="text-base font-bold text-amber-800 mb-1">
                        <i class="fas fa-undo mr-2"></i>Commande renvoyée pour modification
                    </h3>
                    <p class="text-sm text-amber-700 mb-1">{{ operation_renvoi.conclusion }}</p>
                    <div class="text-xs text-amber-600">
                        <i class="fas fa-clock mr-1"></i>
                        Renvoyée le {{ operation_renvoi.date_operation|date:"d/m/Y à H:i" }}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Section spéciale pour les commandes livrées partiellement -->
    {% if is_commande_livree_partiellement %}
    <div class="bg-orange-50 border-l-4 border-orange-400 rounded-lg p-6 mb-6 animate-slideInUp">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-orange-100">
                    <i class="fas fa-exclamation-triangle text-orange-400 text-xl"></i>
                </div>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-orange-800 mb-3">Modification d'une Commande Livrée Partiellement</h3>
                
                <div class="bg-orange-100 border border-orange-200 p-4 rounded-lg mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-orange-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-orange-700">
                                <strong>Important :</strong> Cette commande a été livrée partiellement. Certains articles ont été livrés au client, d'autres ont été renvoyés pour correction.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Articles Livrés -->
                {% if articles_livres %}
                <div class="mb-4">
                    <h4 class="font-medium text-green-800 mb-2 flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Articles Livrés au Client (Ne pas modifier)
                    </h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="space-y-2">
                            {% for article_data in articles_livres %}
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2 border border-green-200">
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-3">
                                        <i class="fas fa-check-circle mr-1"></i>Livré
                                    </span>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ article_data.article.nom }}</div>
                                        <div class="text-xs text-gray-500">
                                            Réf: {{ article_data.article.reference }} | 
                                            {{ article_data.article.couleur }} | 
                                            {{ article_data.article.pointure }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-green-600">
                                        {{ article_data.quantite_livree }}x
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ article_data.prix|floatformat:2 }} DH
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Articles Renvoyés -->
                {% if articles_renvoyes %}
                <div class="mb-4">
                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                        <i class="fas fa-undo text-red-500 mr-2"></i>
                        Articles Renvoyés pour Correction
                    </h4>
                    <!-- DEBUG: Afficher la liste complète des articles_renvoyes -->
                    <pre style="background:#fff0f0;color:#b91c1c;padding:8px;border-radius:6px;font-size:12px;overflow-x:auto;">DEBUG articles_renvoyes: {{ articles_renvoyes|safe }}</pre>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="space-y-2">
                            {% for article_data in articles_renvoyes %}
                            <!-- DEBUG: Afficher chaque article_data -->
                            <pre style="background:#fef9c3;color:#92400e;padding:4px 8px;border-radius:4px;font-size:11px;overflow-x:auto;">DEBUG article_data: {{ article_data|safe }}</pre>
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2 border border-red-200">
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-3">
                                        <i class="fas fa-undo mr-1"></i>Renvoyé
                                    </span>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 flex items-center">
                                            {{ article_data.article.nom }}
                                            {% if article_data.etat == 'defectueux' %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold bg-red-100 text-red-700 ml-3">
                                                    <i class="fas fa-times-circle mr-2"></i>Défectueux
                                                </span>
                                            {% elif article_data.etat == 'bon' %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold bg-green-100 text-green-700 ml-3">
                                                    <i class="fas fa-check-circle mr-2"></i>Bon
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-700 ml-3"><i class="fas fa-question-circle mr-2"></i>État inconnu: {{ article_data.etat }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            Réf: {{ article_data.article.reference }} | 
                                            {{ article_data.article.couleur }} | 
                                            {{ article_data.article.pointure }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-red-600">
                                        {{ article_data.quantite }}x
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ article_data.prix|floatformat:2 }} DH
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                        <i class="fas fa-list-ol text-blue-500 mr-2"></i>
                        Actions de Modification Autorisées
                    </h4>
                    <ol class="text-sm text-blue-700 space-y-2 ml-6">
                        <li><strong>1.</strong> <span class="text-red-600 font-medium">Remplacer</span> les articles renvoyés par des articles disponibles</li>
                        <li><strong>2.</strong> <span class="text-red-600 font-medium">Modifier</span> les quantités des articles renvoyés</li>
                        <li><strong>3.</strong> <span class="text-red-600 font-medium">Supprimer</span> les articles renvoyés si non disponibles</li>
                        <li><strong>4.</strong> <span class="text-green-600 font-medium">Conserver</span> les articles déjà livrés</li>
                        <li><strong>5.</strong> <span class="text-blue-600 font-medium">Ajouter</span> de nouveaux articles si nécessaire</li>
                    </ol>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        <span class="text-sm font-medium text-yellow-800">Conseil :</span>
                    </div>
                    <p class="text-sm text-yellow-700 mt-1">
                        Utilisez les filtres et la recherche pour trouver rapidement des articles de remplacement. 
                        Vérifiez toujours la disponibilité en stock avant de faire des modifications.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" id="modification-form">
        {% csrf_token %}
        <div class="space-y-6">
            
            <!-- Section Actions Rapides pour les commandes renvoyées -->
            {% if is_commande_renvoyee %}
                <div class="modification-section rounded-lg p-4 animate-slideInUp">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-blue-800">
                            <i class="fas fa-tools mr-2"></i>Actions Rapides
                        </h3>
                        <button type="button" onclick="ouvrirModalAjoutArticle()" class="quick-action-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Ajouter Article
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Informations principales -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                    <h3 class="text-lg font-semibold mb-4 section-title">
                        <i class="fas fa-receipt mr-3"></i>Informations Commande
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID YZ</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro Commande</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                    <h3 class="text-lg font-semibold mb-4 section-title">
                        <i class="fas fa-user mr-3"></i>Client
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" name="client_nom" value="{{ commande.client.nom }}" readonly class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" name="client_prenom" readonly value="{{ commande.client.prenom }}" class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                            <input type="text" name="client_telephone" readonly value="{{ commande.client.numero_tel }}" class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client</label>
                            <input type="text" value="{{ commande.ville_init|default:'Non spécifiée' }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Livraison -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <h3 class="text-lg font-semibold mb-4 section-title">
                    <i class="fas fa-truck mr-3"></i>Livraison
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                        <select name="ville_id" id="ville-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Sélectionner une ville --</option>
                            {% for ville in villes %}
                                <option value="{{ ville.id }}" 
                                        data-region="{{ ville.region.nom_region }}" 
                                        data-frais="{{ ville.frais_livraison|default:0 }}"
                                        {% if commande.ville.id == ville.id %}selected{% endif %}>
                                    {{ ville.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Région</label>
                        <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison</label>
                        <input type="text" id="frais-display" value="{{ commande.ville.frais_livraison|default:0 }} DH" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                    <textarea name="adresse" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Adresse complète de livraison">{{ commande.adresse }}</textarea>
                </div>
            </div>

            <!-- Panier avec fonctionnalités améliorées et logique upsell -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold section-title">
                    <i class="fas fa-box mr-3"></i>Articles du Panier
                        <span class="text-sm font-normal text-gray-600 ml-2">
                            (<span id="articles-count">{{ paniers.count }}</span> article<span id="articles-plural">{{ paniers.count|pluralize }}</span>)
                        </span>
                        {% if commande.compteur > 0 %}
                        <span class="inline-flex items-center px-2 py-1 upsell-badge rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                        </span>
                        {% endif %}
                        
                        <!-- Bouton de diagnostic du compteur upsell -->
                        <button type="button" onclick="diagnostiquerCompteur()" 
                                class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium ml-2 hover:bg-blue-200"
                                title="Diagnostiquer et corriger le compteur upsell">
                            <i class="fas fa-tools mr-1"></i>Diagnostic Upsell
                        </button>
                        
                        <!-- Bouton d'information sur la logique upsell -->
                        <button type="button" onclick="ouvrirModalInfoUpsell()" 
                                class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium ml-2 hover:bg-purple-200"
                                title="En savoir plus sur la logique upsell">
                            <i class="fas fa-info-circle mr-1"></i>Info Upsell
                        </button>
                        
                        <!-- Bouton de debug pour vérifier la base de données -->
                        <button type="button" onclick="verifierEtatBaseDeDonnees()" 
                                class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium ml-2 hover:bg-yellow-200"
                                title="Vérifier l'état de la base de données">
                            <i class="fas fa-database mr-1"></i>Debug DB
                        </button>
                        
                        <!-- Bouton pour forcer la synchronisation -->
                        <button type="button" onclick="forcerSynchronisation()" 
                                class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium ml-2 hover:bg-green-200"
                                title="Forcer la synchronisation des données">
                            <i class="fas fa-sync-alt mr-1"></i>Sync
                        </button>
                </h3>
                    <div class="flex gap-2">
                        <button type="button" class="btn-prepa px-3 py-2 rounded text-sm" onclick="ouvrirModalAjoutArticle()">
                            <i class="fas fa-plus mr-1"></i>Ajouter
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                <table class="w-full bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="px-4 py-3 text-left">Article</th>
                                <th class="px-4 py-3 text-left">Référence</th>
                                <th class="px-4 py-3 text-left">Couleur</th>
                                <th class="px-4 py-3 text-left">Pointure</th>
                                <th class="px-4 py-3 text-center">Quantité</th>
                                <th class="px-4 py-3 text-right">
                                    Prix 
                                    <button type="button" onclick="ouvrirModalInfoPrix()" class="ml-1 text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-right">
                                    Sous-total
                                    <button type="button" onclick="ouvrirModalInfoSousTotal()" class="ml-1 text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-center">État</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for panier in paniers %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50" data-panier-id="{{ panier.id }}" data-article-id="{{ panier.article.id }}">
                                <td class="px-4 py-3">
                                    <div class="font-medium flex items-center">
                                        {{ panier.article.nom }}
                                      
                                        {% if panier.article.isUpsell %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ml-2">
                                                <i class="fas fa-arrow-up mr-1"></i>Upsell
                                            </span>
                                        {% endif %}
                                        {% for article_data in articles_renvoyes %}
                                            {% if article_data.article.id == panier.article.id %}
                                                {% if article_data.etat == 'defectueux' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 ml-2">
                                                        <i class="fas fa-times-circle mr-1"></i>Défectueux
                                                    </span>
                                                {% elif article_data.etat == 'bon' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ml-2">
                                                        <i class="fas fa-check-circle mr-1"></i>Bon
                                                    </span>
                                                {% elif article_data.etat == 'inconnu' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 ml-2">
                                                        <i class="fas fa-question-circle mr-1"></i>Inconnu
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% if panier.article.description %}

                                        <div class="text-sm text-gray-500">{{ panier.article.description|truncatechars:50 }}</div>
                                    {% endif %}
                                    <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                        <i class="fas fa-boxes mr-1"></i>Stock: {{ panier.article.qte_disponible|default:0 }}
                                    </span>
                                </td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.reference }}</td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.couleur }}</td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.pointure }}</td>
                                <td class="px-4 py-3 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <button type="button" onclick="modifierQuantite({{ panier.id }}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-red-200">-</button>
                                        <input type="number" id="quantite-{{ panier.id }}" value="{{ panier.quantite }}" min="1" max="99" 
                                               data-previous-value="{{ panier.quantite }}"
                                               class="w-16 text-center font-medium border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                                               onchange="modifierQuantiteDirecte({{ panier.id }}, this.value)"
                                               onblur="modifierQuantiteDirecte({{ panier.id }}, this.value)">
                                        <button type="button" onclick="modifierQuantite({{ panier.id }}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-green-200">+</button>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    {% load commande_filters %}
                                    {% with prix_info=panier.article|get_prix_avec_phase_info:commande.compteur %}
                                        <div class="text-right">
                                            <div class="font-medium prix-{{ prix_info.type }}" id="prix-unitaire-{{ panier.id }}">
                                                {{ prix_info.prix|floatformat:2 }} DH
                                            </div>
                                            {% if prix_info.libelle != "Prix normal" %}
                                                <div class="text-xs prix-{{ prix_info.type }} flex items-center justify-end gap-1" id="prix-libelle-{{ panier.id }}">
                                                    {% if panier.article.isUpsell and commande.compteur > 0 %}
                                                        <i class="fas fa-arrow-up"></i>
                                                    {% elif panier.article.has_promo_active %}
                                                        <i class="fas fa-fire"></i>
                                                    {% elif panier.article.phase == 'LIQUIDATION' %}
                                                        <i class="fas fa-percentage"></i>
                                                    {% elif panier.article.phase == 'EN_TEST' %}
                                                        <i class="fas fa-flask"></i>
                                                    {% endif %}
                                                    {{ prix_info.libelle}}
                                                </div>
                                            {% endif %}
                                            {% if panier.article.prix_unitaire != prix_info.prix %}
                                                <div class="text-xs text-gray-400 line-through">{{ panier.article.prix_unitaire|floatformat:2 }} DH</div>
                                            {% endif %}
                                        </div>
                                    {% endwith %}
                                </td>
                                <td class="px-4 py-3 text-right font-bold" id="sous-total-{{ panier.id }}">{{ panier.sous_total|floatformat:2 }} DH</td>
                                <td class="px-4 py-3 text-center">
                                    <div class="flex flex-col gap-1">
                                        <!-- État de l'article (phase) -->
                                        {% if panier.article.phase == 'EN_COURS' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">
                                                <i class="fas fa-play-circle mr-1"></i>En Cours
                                            </span>
                                        {% elif panier.article.phase == 'LIQUIDATION' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                                                <i class="fas fa-percentage mr-1"></i>Liquidation
                                            </span>
                                        {% elif panier.article.phase == 'EN_TEST' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">
                                                <i class="fas fa-flask mr-1"></i>Test
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">
                                                <i class="fas fa-question-circle mr-1"></i>{{ panier.article.phase }}
                                            </span>
                                        {% endif %}
                                        
                                        <!-- État de retour (si applicable) -->
                                    {% for article_data in articles_renvoyes %}
                                        {% if article_data.article.id == panier.article.id %}
                                            {% if article_data.etat == 'defectueux' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-200 text-red-800">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>Défectueux
                                                </span>
                                            {% elif article_data.etat == 'bon' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-200 text-green-800">
                                                        <i class="fas fa-check-circle mr-1"></i>Retour Bon
                                                </span>
                                            {% else %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-800">
                                                        <i class="fas fa-question-circle mr-1"></i>{{ article_data.etat }}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                        
                                        <!-- État upsell (si applicable) -->
                                        {% if panier.article.isUpsell %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                                                <i class="fas fa-arrow-up mr-1"></i>Upsell
                                            </span>
                                    {% endif %}
                                        
                                        <!-- État promotion (si applicable) -->
                                        {% if panier.article.has_promo_active %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                                                <i class="fas fa-fire mr-1"></i>Promo
                                            </span>
                                        {% endif %}
                                        
                                        <!-- État du stock (si rupture) -->
                                        {% if panier.article.qte_disponible <= 0 %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Rupture
                                            </span>
                                        {% elif panier.article.qte_disponible <= 5 %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                                                <i class="fas fa-exclamation mr-1"></i>Stock Faible
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button type="button" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" onclick="supprimerArticle({{ panier.id }})" title="Supprimer cet article">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-box-open text-3xl mb-2"></i>
                                    <div>Aucun article dans le panier</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                
                <div class="flex justify-between items-center mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span id="articles-count-bottom">{{ paniers.count }}</span> article<span id="articles-plural-bottom">{{ paniers.count|pluralize }}</span> dans le panier
                        {% if commande.compteur > 0 %}
                            <span class="ml-2 text-purple-600 font-medium" id="upsell-badge-container">
                                <i class="fas fa-arrow-up mr-1"></i>
                                Upsell niveau <span id="niveau-upsell-dashboard">{{ commande.compteur }}</span>
                            </span>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Total articles</div>
                        <div class="text-2xl font-bold text-blue-600 total-commande" id="sous-total-articles">{{ commande.sous_total_articles|floatformat:2 }} DH</div>
                        <div class="text-sm text-gray-500 total-livraison">+ {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH livraison</div>
                        <div class="text-lg font-bold text-green-600 total-final-commande" id="total-commande">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        <button type="button" onclick="ouvrirModalInfoTotal()" class="text-xs text-blue-500 hover:text-blue-700 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>Détails
                        </button>
                    </div>
                </div>
            </div>

















            <!-- Section Commentaires -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <h3 class="text-lg font-semibold mb-4 section-title">
                    <i class="fas fa-sticky-note mr-3"></i>Commentaires
                </h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire opérateur <span class="text-gray-500">(optionnel)</span></label>
                    <textarea name="commentaire_operateur" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ajouter un commentaire sur les modifications effectuées..."></textarea>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-between items-center mt-6 p-6 bg-gray-50 rounded-xl">
                <div class="flex gap-3">
                    <a href="{% url 'Prepacommande:detail_prepa' commande.id %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-prepa px-8 py-3 rounded-lg text-lg font-bold">
                        <i class="fas fa-check mr-2"></i>Enregistrer les modifications
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modales améliorées -->
<div id="modalAjoutArticle" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold section-title">Ajouter un article</h3>
                    <button type="button" onclick="fermerModalAjoutArticle()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rechercher un article</label>
                    <div class="relative">
                        <input type="text" id="searchArticle" placeholder="Nom, référence, couleur, pointure..." 
                               class="w-full p-4 border rounded-lg pl-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Légende des types d'articles -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium text-blue-800">Légende des types d'articles :</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <div class="flex items-center">
                            <i class="fas fa-box text-gray-600 mr-1"></i>
                            <span class="text-gray-700">Normal</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-arrow-up text-purple-600 mr-1"></i>
                            <span class="text-green-500">Upsell</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-fire text-orange-600 mr-1"></i>
                            <span class="text-orange-700">Promotion</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-money-bill-wave text-red-600 mr-1"></i>
                            <span class="text-red-700">Liquidation</span>
                        </div>
                    </div>
                </div>

                <!-- Filtres rapides -->
                <div class="mb-4 flex flex-wrap gap-2">
                    <button type="button" onclick="filtrerArticles('tous')" class="filter-btn active px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-search mr-1"></i>
                        TOUS
                        <span class="ml-1 bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-tous">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('disponible')" class="filter-btn px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-check-circle mr-1"></i>
                        En stock
                        <span class="ml-1 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-disponible">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('promo')" class="filter-btn px-3 py-2 bg-orange-200 text-orange-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-fire mr-1"></i>
                        PROMO
                        <span class="ml-1 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-promo">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('upsell')" class="filter-btn px-3 py-2 bg-green-500 text-green-800 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i>
                        UPSELL
                        <span class="ml-1 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-upsell">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('liquidation')" class="filter-btn px-3 py-2 bg-red-200 text-red-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-money-bill-wave mr-1"></i>
                        LIQUIDATION
                        <span class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-liquidation">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('test')" class="filter-btn px-3 py-2 bg-yellow-200 text-yellow-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-flask mr-1"></i>
                        TEST
                        <span class="ml-1 bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-test">0</span>
                    </button>
                </div>
                
                <div id="articlesList" class="max-h-96 overflow-y-auto"></div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="fermerModalAjoutArticle()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Annuler</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modales d'information sur les calculs -->
<div id="modalInfoPrix" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-tag text-blue-500 mr-2"></i>Comment sont calculés les prix unitaires ?
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Prix de base</h4>
                        <p class="text-sm text-blue-700">Le prix unitaire défini pour chaque article.</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800 mb-2">
                            <i class="fas fa-arrow-up mr-1"></i>Prix Upsell (niveau {{ commande.compteur }})
                        </h4>
                        <p class="text-sm text-purple-700">
                            {% if commande.compteur > 0 %}
                                Les articles upsell bénéficient d'un prix réduit selon le niveau atteint dans la commande.
                                <br><strong>Logique simplifiée :</strong> prix_actuel par défaut, prix upsell seulement pour les articles marqués "Upsell".
                            {% else %}
                                Aucun niveau upsell actif pour cette commande.
                                <br><strong>Logique simplifiée :</strong> tous les articles utilisent leur prix_actuel.
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-red-800 mb-2">
                            <i class="fas fa-fire mr-1"></i>Prix Promotionnel
                        </h4>
                        <p class="text-sm text-red-700">Articles en promotion avec réduction appliquée.</p>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-800 mb-2">
                            <i class="fas fa-percentage mr-1"></i>Prix Liquidation
                        </h4>
                        <p class="text-sm text-orange-700">Articles en liquidation avec forte réduction.</p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoPrix()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalInfoSousTotal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-calculator text-green-500 mr-2"></i>Calcul des sous-totaux
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-2">Formule de base</h4>
                        <p class="text-sm text-green-700 font-mono bg-white p-2 rounded border">
                            Sous-total = Prix unitaire × Quantité
                        </p>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Prise en compte automatique</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>• Réductions promotionnelles</li>
                            <li>• Prix upsell selon le niveau de la commande</li>
                            <li>• Prix de liquidation</li>
                            <li>• Prix de test</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoSousTotal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalInfoTotal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-receipt text-purple-500 mr-2"></i>Détail complet du calcul - Commande {{ commande.id_yz }}
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Résumé des articles -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-list mr-2"></i>Articles de la commande
                        </h4>
                        {% for panier in paniers %}
                            {% load commande_filters %}
                            {% with prix_info=panier.article|get_prix_avec_phase_info:commande.compteur %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                                <div class="flex-1">
                                    <div class="font-medium">{{ panier.article.nom }}</div>
                                    <div class="text-sm text-gray-500">{{ panier.quantite }} × {{ prix_info.prix|floatformat:2 }} DH</div>
                                    {% if prix_info.libelle != "Prix normal" %}
                                        <div class="text-xs {{ prix_info.couleur_classe }}">{{ prix_info.libelle }}</div>
                                    {% endif %}
                                </div>
                                <div class="text-right font-semibold">{{ panier.sous_total|floatformat:2 }} DH</div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <!-- Calcul du total -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">
                            <i class="fas fa-calculator mr-2"></i>Calcul du total
                        </h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Sous-total articles :</span>
                                <span class="font-semibold">{{ total_articles|floatformat:2 }} DH</span>
                            </div>
                            {% if commande.ville.frais_livraison > 0 %}
                                <div class="flex justify-between">
                                    <span>Frais de livraison ({{ commande.ville.nom }}) :</span>
                                    <span class="font-semibold">+ {{ commande.ville.frais_livraison|floatformat:2 }} DH</span>
                                </div>
                            {% endif %}
                            <div class="border-t border-blue-300 pt-2 flex justify-between text-lg font-bold text-blue-800">
                                <span>Total final :</span>
                                <span>{{ total_articles|add:commande.ville.frais_livraison|default:0|floatformat:2 }} DH</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if commande.compteur > 0 %}
                    <!-- Informations sur l'upsell -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800 mb-2">
                            <i class="fas fa-arrow-up mr-2"></i>Niveau Upsell {{ commande.compteur }}
                        </h4>
                        <p class="text-sm text-purple-700">
                            Cette commande bénéficie du niveau upsell {{ commande.compteur }}, 
                            appliquant automatiquement les prix réduits aux articles éligibles.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoTotal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation améliorée -->
<div id="modalConfirmation" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div class="p-6 text-center">
                <i class="fas fa-question-circle text-4xl text-yellow-500 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Confirmation</h3>
                <p id="messageConfirmation" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center space-x-3">
                    <button type="button" onclick="fermerModalConfirmation()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">Annuler</button>
                    <button type="button" id="btnConfirmer" 
                            class="btn-prepa px-4 py-2 rounded-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'information sur la logique upsell -->
<div id="modalInfoUpsell" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-arrow-up text-orange-500 mr-2"></i>Système de Compteur Upsell
                    </h3>
                    <button type="button" onclick="fermerModalInfoUpsell()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Explication générale -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>Qu'est-ce que le compteur upsell ?
                        </h4>
                        <p class="text-blue-700 text-sm">
                            Le compteur upsell détermine automatiquement le niveau de réduction appliqué aux articles upsell 
                            selon le nombre total d'unités d'articles upsell dans la commande.
                            <br><br><strong>Logique simplifiée :</strong>
                            <br>• Articles normaux → Utilisent leur <strong>prix_actuel</strong>
                            <br>• Articles upsell → Utilisent les <strong>prix upsell</strong> selon le compteur
                        </p>
                    </div>

                    <!-- Logique de calcul -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>Logique de calcul du compteur (basée sur l'opérateur de confirmation)
                        </h4>
                        <div class="space-y-2 text-sm text-green-700">
                            <div class="flex items-center">
                                <span class="font-medium w-32">0-1 unité :</span>
                                <span>Compteur = 0 (pas de réduction)</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium w-32">2+ unités :</span>
                                <span>Compteur = Nombre total d'unités - 1</span>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-white rounded border border-green-300">
                            <div class="text-xs font-mono text-green-800">
                                <strong>Exemple :</strong> 5 unités d'articles upsell → Compteur = 4 → Niveau 4
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-100 rounded border border-blue-300">
                            <div class="text-xs text-blue-800">
                                <strong>Logique identique à l'opérateur de confirmation :</strong>
                                <br>• Compteur basé sur le total des unités d'articles upsell
                                <br>• Recalcul automatique de tous les prix après chaque modification
                                <br>• Prix upsell appliqués selon le niveau du compteur
                            </div>
                        </div>
                    </div>

                    <!-- Niveaux de prix -->
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
                            <i class="fas fa-tags mr-2"></i>Niveaux de prix upsell
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 1</div>
                                <div class="text-gray-600">Prix upsell 1 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 2</div>
                                <div class="text-gray-600">Prix upsell 2 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 3</div>
                                <div class="text-gray-600">Prix upsell 3 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 4+</div>
                                <div class="text-gray-600">Prix upsell 4 appliqué</div>
                            </div>
                        </div>
                    </div>

                    <!-- État actuel -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                            <i class="fas fa-chart-line mr-2"></i>État actuel de la commande
                        </h4>
                        <div class="space-y-2 text-sm text-purple-700">
                            <div class="flex justify-between">
                                <span>Compteur actuel :</span>
                                <span class="font-bold">{{ commande.compteur }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Articles upsell :</span>
                                <span class="font-bold">{{ paniers|length }} article(s)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total unités upsell :</span>
                                <span class="font-bold">
                                    {% with total_upsell=0 %}
                                        {% for panier in paniers %}
                                            {% if panier.article.isUpsell %}
                                                {% with total_upsell=total_upsell|add:panier.quantite %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ total_upsell }}
                                    {% endwith %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions disponibles -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                            <i class="fas fa-tools mr-2"></i>Actions disponibles
                        </h4>
                        <div class="space-y-2 text-sm text-yellow-700">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Diagnostic automatique du compteur</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Correction automatique si nécessaire</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Mise à jour dynamique des prix</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Recalcul automatique des totaux</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoUpsell()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let commandeId = {{ commande.id }};
    let articlesDisponibles = [];
    let modificationsQuantites = {};
    let compteurCommande = {{ commande.compteur|default:0 }};
    
    // Variables globales pour la gestion des variantes
    window.selectedArticleWithVariant = null;
    window._varianteSelection = {};
    window.articlesList = [];
    
    // Variables pour la gestion des articles
    let isEditingArticle = false;
    let currentArticleId = null;

    // Fonctions globales pour les `onclick`
    window.ouvrirModalAjoutArticle = function() {
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) {
            modal.classList.remove('hidden');
            chargerArticlesDisponibles();
        }
    };

    window.fermerModalAjoutArticle = function() {
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) modal.classList.add('hidden');
    };

    // Fonction pour diagnostiquer le compteur upsell
    window.diagnostiquerCompteur = function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Afficher un indicateur de chargement
        const diagnosticBtn = document.querySelector('[onclick="diagnostiquerCompteur()"]');
        const originalText = diagnosticBtn.innerHTML;
        diagnosticBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Diagnostic...';
        diagnosticBtn.disabled = true;
        
        fetch(`{% url "Prepacommande:diagnostiquer_compteur" commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Diagnostic upsell:', data.message);
                
                // Afficher le résultat avec mise à jour dynamique
                if (data.ancien_compteur !== undefined) {
                    // Utiliser l'animation pour la mise à jour du compteur
                    mettreAJourCompteurAvecAnimation(data.ancien_compteur, data.nouveau_compteur);
                    
                    // Afficher un résumé détaillé
                    afficherResumeDiagnostic(data);
                    
                    // Mise à jour dynamique au lieu de recharger la page
                    const updatedData = {
                        compteur: data.nouveau_compteur,
                        total_commande: data.total_commande || document.querySelector('.total-final-commande')?.textContent?.replace(' DH', ''),
                        articles_count: data.articles_count,
                        sous_total_articles: data.sous_total_articles
                    };
                    
                    // Appeler la fonction de mise à jour centralisée
                    mettreAJourTousLesTotaux(updatedData);
                    
                    // Rafraîchir la section des articles pour voir les prix upsell mis à jour
                    setTimeout(() => {
                        rafraichirSectionArticles();
                    }, 2000);
                    
                } else {
                    // Afficher un résumé même si pas de correction
                    afficherResumeDiagnostic(data);
                    
                    // Même si pas de correction, s'assurer que l'affichage est correct
                    const currentData = {
                        compteur: data.compteur,
                        total_commande: data.total_commande,
                        articles_count: data.articles_count,
                        sous_total_articles: data.sous_total_articles
                    };
                    mettreAJourTousLesTotaux(currentData);
                }
            } else {
                console.error('❌ Erreur:', data.error);
                showNotificationToast('❌ Erreur lors du diagnostic: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau:', error);
            showNotificationToast('❌ Erreur de réseau lors du diagnostic', 'error');
        })
        .finally(() => {
            // Restaurer le bouton
            diagnosticBtn.innerHTML = originalText;
            diagnosticBtn.disabled = false;
        });
    };

    // Fonction pour mettre à jour le compteur avec animation
    window.mettreAJourCompteurAvecAnimation = function(ancienCompteur, nouveauCompteur) {
        const compteurHeader = document.getElementById('compteur-upsell-header');
        
        // Vérification robuste de l'existence de l'élément
        if (!compteurHeader) {
            console.warn('⚠️ Élément compteur-upsell-header non trouvé');
            return;
        }
        
        if (!compteurHeader.style) {
            console.warn('⚠️ Propriété style non disponible sur compteur-upsell-header');
            return;
        }
        
        try {
            // Animation de transition
            compteurHeader.style.transition = 'all 0.5s ease';
            compteurHeader.style.transform = 'scale(1.1)';
            compteurHeader.style.backgroundColor = '#fef3c7';
            
            setTimeout(() => {
                // Vérification à nouveau dans le setTimeout
                if (!compteurHeader || !compteurHeader.style) {
                    console.warn('⚠️ Élément compteur-upsell-header non disponible dans setTimeout');
                    return;
                }
                
                try {
                    if (nouveauCompteur > 0) {
                        compteurHeader.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau ${nouveauCompteur}`;
                    } else {
                        compteurHeader.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Aucun upsell`;
                    }
                    
                    compteurHeader.style.transform = 'scale(1)';
                    compteurHeader.style.backgroundColor = 'transparent';
                    
                    // Ajouter une classe pour l'animation CSS
                    compteurHeader.classList.add('updated');
                    setTimeout(() => {
                        if (compteurHeader && compteurHeader.classList) {
                            compteurHeader.classList.remove('updated');
                        }
                    }, 1000);
                } catch (error) {
                    console.error('❌ Erreur lors de la mise à jour du compteur:', error);
                }
            }, 250);
        } catch (error) {
            console.error('❌ Erreur lors de l\'animation du compteur:', error);
        }
    };

    // Fonction pour afficher un résumé du diagnostic
    window.afficherResumeDiagnostic = function(data) {
        const message = `
            <div class="text-left">
                <div class="font-bold mb-2">📊 Résumé du diagnostic :</div>
                <div class="space-y-1 text-sm">
                    <div><strong>Compteur :</strong> ${data.ancien_compteur || data.compteur} → ${data.nouveau_compteur || data.compteur}</div>
                    <div><strong>Articles upsell :</strong> ${data.articles_upsell || 0}</div>
                    <div><strong>Unités totales :</strong> ${data.quantite_totale_upsell || 0}</div>
                    <div><strong>Logique :</strong> 0-1 unité = compteur 0 | 2+ unités = compteur total-1</div>
                </div>
            </div>
        `;
        
        showNotificationToast(message, 'info');
    };

    // Fonction pour mettre à jour tous les totaux et le compteur
    function mettreAJourTousLesTotaux(data) {
        console.log('🔄 Mise à jour des totaux:', data);
        
        // Mettre à jour le compteur upsell
        if (data.compteur !== undefined) {
            compteurCommande = data.compteur;
            mettreAJourCompteurUpsell(data.compteur);
        }
        
        // Mettre à jour le total des articles
        if (data.sous_total_articles !== undefined) {
            const totalElements = document.querySelectorAll('.total-commande');
            totalElements.forEach(element => {
                element.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le total final
        if (data.total_commande !== undefined) {
            const totalFinals = document.querySelectorAll('.total-final-commande');
            totalFinals.forEach(element => {
                element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le nombre d'articles
        if (data.articles_count !== undefined) {
            const articlesCount = document.getElementById('articles-count');
            const articlesPlural = document.getElementById('articles-plural');
            if (articlesCount) {
                articlesCount.textContent = data.articles_count;
            }
            if (articlesPlural) {
                articlesPlural.textContent = data.articles_count > 1 ? 's' : '';
            }
        }
        
        console.log('✅ Tous les totaux mis à jour:', {
            sous_total_articles: data.sous_total_articles,
            total_commande: data.total_commande,
            articles_count: data.articles_count,
            compteur: data.compteur
        });
    }

    // Fonction pour mettre à jour le compteur upsell dans tous les endroits
    window.mettreAJourCompteurUpsell = function(nouveauCompteur) {
        console.log(`🔄 Mise à jour du compteur upsell: ${nouveauCompteur}`);
        
        // Mettre à jour la variable globale
        compteurCommande = nouveauCompteur;
        
        // Mettre à jour l'en-tête du compteur
        const compteurHeader = document.getElementById('compteur-upsell-header');
        if (compteurHeader) {
            if (nouveauCompteur > 0) {
                compteurHeader.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau ${nouveauCompteur}`;
            } else {
                compteurHeader.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Aucun upsell`;
            }
            
            // Ajouter une animation de mise à jour
            compteurHeader.classList.add('updated');
            setTimeout(() => {
                compteurHeader.classList.remove('updated');
            }, 1000);
        }
        
        // Mettre à jour les prix unitaires
        mettreAJourPrixUnitaires(nouveauCompteur);
        
        console.log(`✅ Compteur upsell mis à jour vers: ${nouveauCompteur}`);
    };

    // Fonction pour mettre à jour dynamiquement les prix unitaires
    window.mettreAJourPrixUnitaires = function(nouveauCompteur) {
        console.log(`🔄 Mise à jour des prix unitaires pour le compteur: ${nouveauCompteur}`);
        
        // Faire un appel AJAX pour récupérer les prix mis à jour depuis le serveur
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`{% url "Prepacommande:api_prix_upsell_articles" commande.id %}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Prix récupérés depuis le serveur:', data.message);
                console.log('📊 Données reçues:', data.prix_articles);
                
                // Mettre à jour chaque article avec les nouveaux prix
                Object.keys(data.prix_articles).forEach(panierId => {
                    const prixInfo = data.prix_articles[panierId];
                    const prixElement = document.getElementById(`prix-unitaire-${panierId}`);
                    const libelleElement = document.getElementById(`prix-libelle-${panierId}`);
                    const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
                    
                    if (prixElement) {
                        // S'assurer que le prix est un nombre
                        const prix = parseFloat(prixInfo.prix) || 0;
                        const sousTotal = parseFloat(prixInfo.sous_total) || 0;
                        
                        console.log(`🔍 Traitement article ${panierId}:`, {
                            prix_original: prixInfo.prix,
                            prix_converti: prix,
                            sous_total_original: prixInfo.sous_total,
                            sous_total_converti: sousTotal,
                            type: prixInfo.type
                        });
                        
                        // Mettre à jour le prix
                        prixElement.textContent = `${prix.toFixed(2)} DH`;
                        prixElement.className = `font-medium prix-${prixInfo.type}`;
                        
                        // Mettre à jour le libellé
                        if (libelleElement) {
                            if (prixInfo.libelle !== "Prix normal") {
                                libelleElement.innerHTML = `<i class="${prixInfo.icone}"></i> ${prixInfo.libelle}`;
                                libelleElement.className = `text-xs prix-${prixInfo.type} flex items-center justify-end gap-1`;
                                if (libelleElement.style) {
                                    libelleElement.style.display = 'block';
                                }
                            } else {
                                if (libelleElement.style) {
                                    libelleElement.style.display = 'none';
                                }
                            }
                        }
                        
                        // Mettre à jour le sous-total
                        if (sousTotalElement) {
                            sousTotalElement.textContent = `${sousTotal.toFixed(2)} DH`;
                        }
                        
                        console.log(`✅ Prix mis à jour pour article ${panierId}: ${prixInfo.prix.toFixed(2)} DH (${prixInfo.libelle})`);
                    }
                });
                
                // Mettre à jour le total de la commande
                mettreAJourTotalCommande();
                
            } else {
                console.error('❌ Erreur lors de la récupération des prix:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau lors de la récupération des prix:', error);
        });
    };



    // Fonction pour mettre à jour le sous-total d'un article
    window.mettreAJourSousTotalArticle = function(panierId, prixUnitaire) {
        const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
        if (sousTotalElement) {
            // Récupérer la quantité depuis l'input
            const quantiteInput = document.getElementById(`quantite-${panierId}`);
            const quantite = quantiteInput ? parseInt(quantiteInput.value) || 1 : 1;
            
            // Calculer le nouveau sous-total
            const nouveauSousTotal = prixUnitaire * quantite;
            
            // Mettre à jour l'affichage
            sousTotalElement.textContent = `${nouveauSousTotal.toFixed(2)} DH`;
            
            console.log(`✅ Sous-total mis à jour pour article ${panierId}: ${nouveauSousTotal.toFixed(2)} DH`);
        }
    };

    // Fonction pour mettre à jour le total de la commande
    window.mettreAJourTotalCommande = function() {
        console.log('🔄 Mise à jour du total de la commande...');
        
        // Récupérer tous les sous-totaux
        const sousTotalElements = document.querySelectorAll('[id^="sous-total-"]');
        let totalArticles = 0;
        
        sousTotalElements.forEach(element => {
            const sousTotalText = element.textContent.replace(' DH', '');
            const sousTotal = parseFloat(sousTotalText) || 0;
            totalArticles += sousTotal;
        });
        
        // Mettre à jour l'affichage du total
        const totalElements = document.querySelectorAll('.total-commande');
        totalElements.forEach(element => {
            element.textContent = `${totalArticles.toFixed(2)} DH`;
        });
        
        // Calculer le total final avec livraison
        const fraisLivraisonElement = document.querySelector('.total-livraison');
        let fraisLivraison = 0;
        if (fraisLivraisonElement) {
            const livraisonMatch = fraisLivraisonElement.textContent.match(/\+ ([\d.]+) DH/);
            fraisLivraison = parseFloat(livraisonMatch?.[1] || 0);
        }
        
        const totalFinal = totalArticles + fraisLivraison;
        
        const totalFinalElements = document.querySelectorAll('.total-final-commande');
        totalFinalElements.forEach(element => {
            element.textContent = `Total: ${totalFinal.toFixed(2)} DH`;
        });
        
        console.log(`✅ Total mis à jour: ${totalArticles.toFixed(2)} DH + ${fraisLivraison.toFixed(2)} DH livraison = ${totalFinal.toFixed(2)} DH`);
    };

    // Fonction pour rafraîchir la section des articles (utilisée seulement en cas de problème)
    window.rafraichirSectionArticles = function() {
        console.log('🔄 Rafraîchissement complet de la section des articles...');
        
        // Trouver le conteneur des articles (tableau principal)
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
            console.error('❌ Conteneur d\'articles introuvable');
            showNotificationToast('❌ Erreur lors du rafraîchissement: conteneur introuvable', 'error');
            return;
        }
        
        // Afficher un indicateur de chargement
        const originalContent = tableBody.innerHTML;
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Rafraîchissement en cours...</p></td></tr>';

        fetch(`{% url 'Prepacommande:rafraichir_articles_commande_prepa' commande.id %}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mettre à jour la liste des articles avec le HTML du serveur
                    tableBody.innerHTML = data.html;

                    // Utiliser la fonction centralisée pour mettre à jour tous les totaux
                    mettreAJourTousLesTotaux(data);

                    showNotificationToast('🔄 Section des articles mise à jour.', 'info');
                    
                    // Déclencher des événements personnalisés pour d'autres scripts qui pourraient écouter
                    window.dispatchEvent(new CustomEvent('articlesRefreshed', { 
                        detail: { 
                            articles_count: data.articles_count,
                            total_commande: data.total_commande,
                            sous_total_articles: data.sous_total_articles,
                            compteur: data.compteur
                        }
                    }));
                } else {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 bg-red-100 text-red-700 rounded-lg">${data.error || 'Erreur inconnue'}</td></tr>`;
                    showNotificationToast(`❌ Erreur de rafraîchissement: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur de rafraîchissement:', error);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 bg-red-100 text-red-700 rounded-lg">
                    <div class="font-bold mb-2">Erreur de connexion</div>
                    <div class="text-sm">${error.message || 'Impossible de contacter le serveur'}</div>
                    <button onclick="rafraichirSectionArticles()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                        <i class="fas fa-sync-alt mr-1"></i>Réessayer
                    </button>
                </td></tr>`;
                showNotificationToast('❌ Erreur de connexion lors du rafraîchissement.', 'error');
            });
    };

    // Fonction pour mettre à jour une ligne d'article spécifique
    window.mettreAJourLigneArticle = function(panierId, nouvelleQuantite, nouveauSousTotal, nouveauPrix) {
        const ligne = document.querySelector(`tr[data-panier-id="${panierId}"]`);
        if (!ligne) {
            console.warn(`Ligne pour panier ${panierId} non trouvée`);
            return;
        }
        
        // Mettre à jour la quantité
        const quantiteInput = ligne.querySelector('input[type="number"]');
        if (quantiteInput) {
            quantiteInput.value = nouvelleQuantite;
        }
        
        // Mettre à jour le prix unitaire
        const prixCell = ligne.querySelector('.prix-unitaire');
        if (prixCell && nouveauPrix !== undefined) {
            prixCell.textContent = `${parseFloat(nouveauPrix).toFixed(2)} DH`;
        }
        
        // Mettre à jour le sous-total
        const sousTotalCell = ligne.querySelector('.sous-total');
        if (sousTotalCell) {
            sousTotalCell.textContent = `${parseFloat(nouveauSousTotal).toFixed(2)} DH`;
        }
    };

    // Fonction pour ajouter dynamiquement une nouvelle ligne d'article
    window.ajouterLigneArticle = function(articleData) {
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
            console.error('Table body non trouvé');
            return;
        }
        
        // Créer la ligne avec le même format que le template Django
        const newRow = document.createElement('tr');
        newRow.className = 'border-b border-gray-100 hover:bg-gray-50';
        newRow.setAttribute('data-panier-id', articleData.panier_id);
        newRow.setAttribute('data-article-id', articleData.article_id || '');
        
        // Fonction pour générer les badges d'état
        function genererBadgesEtat(article) {
            let badges = [];
            
            // État de phase
            const phase = article.phase || 'EN_COURS';
            if (phase === 'EN_COURS') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">
                        <i class="fas fa-play-circle mr-1"></i>En Cours
                    </span>
                `);
            } else if (phase === 'LIQUIDATION') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <i class="fas fa-percentage mr-1"></i>Liquidation
                    </span>
                `);
            } else if (phase === 'EN_TEST') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">
                        <i class="fas fa-flask mr-1"></i>Test
                    </span>
                `);
            } else {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">
                        <i class="fas fa-question-circle mr-1"></i>${phase}
                    </span>
                `);
            }
            
            // État upsell
            if (article.isUpsell || article.is_upsell) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                        <i class="fas fa-arrow-up mr-1"></i>Upsell
                    </span>
                `);
            }
            
            // État promotion
            if (article.has_promo_active) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                        <i class="fas fa-fire mr-1"></i>Promo
                    </span>
                `);
            }
            
            // État du stock
            if (article.qte_disponible <= 0) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Rupture
                    </span>
                `);
            } else if (article.qte_disponible <= 5) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                        <i class="fas fa-exclamation mr-1"></i>Stock Faible
                    </span>
                `);
            }
            
            return badges.join('');
        }
        
        // Construire le HTML de la ligne
        const upsellBadge = articleData.is_upsell ? 
            '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ml-2"><i class="fas fa-arrow-up mr-1"></i>Upsell</span>' : '';
        
        const prixClass = articleData.is_upsell ? 'prix-upsell' : 'prix-normal';
        const prixLibelle = articleData.is_upsell ? 
            `<div class="text-xs prix-upsell flex items-center justify-end gap-1" id="prix-libelle-${articleData.panier_id}"><i class="fas fa-arrow-up"></i>↑ Upsell Niveau ${articleData.compteur || 0}</div>` : '';
        
        newRow.innerHTML = `
            <td class="px-4 py-3">
                <div class="font-medium flex items-center">
                    ${articleData.nom}
                    ${upsellBadge}
                </div>
                ${articleData.description ? `<div class="text-sm text-gray-500">${articleData.description}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-sm">${articleData.reference || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${articleData.couleur_fr || ''}</td>
            <td class="px-4 py-3 text-sm">${articleData.pointure || ''}</td>
            <td class="px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-1">
                    <button type="button" onclick="modifierQuantite(${articleData.panier_id}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-red-200">-</button>
                    <input type="number" id="quantite-${articleData.panier_id}" value="${articleData.quantite}" min="1" max="99" 
                           data-previous-value="${articleData.quantite}"
                           class="w-16 text-center font-medium border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                           onchange="modifierQuantiteDirecte(${articleData.panier_id}, this.value)"
                           onblur="modifierQuantiteDirecte(${articleData.panier_id}, this.value)">
                    <button type="button" onclick="modifierQuantite(${articleData.panier_id}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-green-200">+</button>
                </div>
            </td>
            <td class="px-4 py-3 text-right">
                <div class="text-right">
                    <div class="font-medium ${prixClass}" id="prix-unitaire-${articleData.panier_id}">
                        ${parseFloat(articleData.prix).toFixed(2)} DH
                    </div>
                    ${prixLibelle}
                </div>
            </td>
            <td class="px-4 py-3 text-right font-bold" id="sous-total-${articleData.panier_id}">${parseFloat(articleData.sous_total).toFixed(2)} DH</td>
            <td class="px-4 py-3 text-center">
                <div class="flex flex-col gap-1">
                    ${genererBadgesEtat(articleData)}
                </div>
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" onclick="supprimerArticle(${articleData.panier_id})" title="Supprimer cet article">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        // Ajouter la ligne au tableau
        tableBody.appendChild(newRow);
        console.log(`✅ Nouvelle ligne d'article ${articleData.panier_id} ajoutée à l'interface`);
        
        // Ajouter une animation d'apparition
        newRow.style.opacity = '0';
        newRow.style.transform = 'translateY(-10px)';
        newRow.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            newRow.style.opacity = '1';
            newRow.style.transform = 'translateY(0)';
        }, 10);
    };

    // Fonction pour supprimer dynamiquement une ligne d'article
    window.supprimerLigneArticle = function(panierId) {
        const ligne = document.querySelector(`tr[data-panier-id="${panierId}"]`);
        if (ligne) {
            // Ajouter une animation de suppression
            ligne.style.transition = 'all 0.3s ease';
            ligne.style.opacity = '0';
            ligne.style.transform = 'translateX(-100%)';
            
            setTimeout(() => {
            ligne.remove();
            console.log(`✅ Ligne d'article ${panierId} supprimée de l'interface`);
            }, 300);
        } else {
            console.warn(`Ligne pour panier ${panierId} non trouvée pour suppression`);
        }
    };

    // Fonction centralisée pour mettre à jour tous les totaux et compteurs
    window.mettreAJourTousLesTotaux = function(data) {
        console.log('🔄 Mise à jour des totaux avec les données:', data);
        
        // Mettre à jour le sous-total global des articles
        if (data.sous_total_articles !== undefined) {
            const sousTotalGlobalElement = document.getElementById('sous-total-articles');
            if (sousTotalGlobalElement) {
                sousTotalGlobalElement.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
                console.log('✅ Sous-total articles mis à jour:', data.sous_total_articles);
            }
        }
        
        // Mettre à jour le total de la commande
        if (data.total_commande !== undefined) {
            const totalElement = document.getElementById('total-commande');
            if (totalElement) {
                totalElement.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                console.log('✅ Total commande mis à jour:', data.total_commande);
            }
            
            // Également mettre à jour tous les éléments avec la classe total-commande
            const totalElements = document.querySelectorAll('.total-commande');
            totalElements.forEach(el => {
                el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le compteur d'articles
        if (data.articles_count !== undefined) {
            // Compteur en haut
            const countElement = document.getElementById('articles-count');
            if (countElement) {
                countElement.textContent = data.articles_count;
            }
            
            const pluralElement = document.getElementById('articles-plural');
            if (pluralElement) {
                pluralElement.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            // Compteur en bas
            const countElementBottom = document.getElementById('articles-count-bottom');
            if (countElementBottom) {
                countElementBottom.textContent = data.articles_count;
            }
            
            const pluralElementBottom = document.getElementById('articles-plural-bottom');
            if (pluralElementBottom) {
                pluralElementBottom.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            console.log('✅ Compteur d\'articles mis à jour:', data.articles_count);
        }
        
        // Mettre à jour le compteur upsell dans tous les endroits possibles
        if (data.compteur !== undefined) {
            // Niveau upsell dashboard
            const niveauUpsellDash = document.getElementById('niveau-upsell-dashboard');
            if (niveauUpsellDash) {
                niveauUpsellDash.textContent = data.compteur;
            }
            
            // Mettre à jour le badge upsell s'il existe
            const upsellBadge = document.getElementById('upsell-badge-container');
            if (upsellBadge && data.compteur > 0) {
                upsellBadge.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell niveau <span id="niveau-upsell-dashboard">${data.compteur}</span>`;
            } else if (upsellBadge && data.compteur === 0) {
                upsellBadge.innerHTML = '';
            }
            
            console.log('✅ Compteur upsell mis à jour:', data.compteur);
        }
        
        console.log('✅ Tous les totaux mis à jour avec succès');
    };

    // Fonctions pour la modale d'information upsell
    window.ouvrirModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.remove('hidden');
            console.log('📖 Modal d\'information upsell ouverte');
        }
    };

    window.fermerModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.add('hidden');
            console.log('📖 Modal d\'information upsell fermée');
        }
    };

    // Fonction pour calculer le total des unités upsell
    window.calculerTotalUnitesUpsell = function() {
        let total = 0;
        const articleRows = document.querySelectorAll('tr[data-panier-id]');
        
        articleRows.forEach(row => {
            const articleId = row.getAttribute('data-article-id');
            const quantiteInput = document.getElementById(`quantite-${row.getAttribute('data-panier-id')}`);
            const quantite = quantiteInput ? parseInt(quantiteInput.value) || 0 : 0;
            
            // Vérifier si c'est un article upsell (on peut ajouter un attribut data-upsell)
            const upsellBadge = row.querySelector('.bg-orange-100.text-orange-700');
            if (upsellBadge) {
                total += quantite;
            }
        });
        
        return total;
    };

    // Fonction pour mettre à jour l'affichage du compteur avec animation
    function mettreAJourCompteurAvecAnimation(ancienCompteur, nouveauCompteur) {
        const compteurHeader = document.getElementById('compteur-upsell-header');
        
        // Vérification robuste de l'existence de l'élément
        if (!compteurHeader) {
            console.warn('⚠️ Élément compteur-upsell-header non trouvé');
            return;
        }
        
        if (!compteurHeader.style) {
            console.warn('⚠️ Propriété style non disponible sur compteur-upsell-header');
            return;
        }
        
        try {
            // Animation de transition
            compteurHeader.style.transition = 'all 0.5s ease';
            compteurHeader.style.transform = 'scale(1.1)';
            compteurHeader.style.backgroundColor = '#fef3c7';
            
            setTimeout(() => {
                // Vérification à nouveau dans le setTimeout
                if (!compteurHeader || !compteurHeader.style) {
                    console.warn('⚠️ Élément compteur-upsell-header non disponible dans setTimeout');
                    return;
                }
                
                try {
                    if (nouveauCompteur > 0) {
                        compteurHeader.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau ${nouveauCompteur}`;
                    } else {
                        compteurHeader.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Aucun upsell`;
                    }
                    
                    compteurHeader.style.transform = 'scale(1)';
                    compteurHeader.style.backgroundColor = 'transparent';
                    
                    // Ajouter une classe pour l'animation CSS
                    compteurHeader.classList.add('updated');
                    setTimeout(() => {
                        if (compteurHeader && compteurHeader.classList) {
                            compteurHeader.classList.remove('updated');
                        }
                    }, 1000);
                } catch (error) {
                    console.error('❌ Erreur lors de la mise à jour du compteur:', error);
                }
            }, 250);
        } catch (error) {
            console.error('❌ Erreur lors de l\'animation du compteur:', error);
        }
    }

    // Fonction pour afficher un résumé du diagnostic
    function afficherResumeDiagnostic(data) {
        const message = `
            <div class="text-left">
                <div class="font-bold mb-2">📊 Résumé du diagnostic :</div>
                <div class="space-y-1 text-sm">
                    <div><strong>Compteur :</strong> ${data.ancien_compteur || data.compteur} → ${data.nouveau_compteur || data.compteur}</div>
                    <div><strong>Articles upsell :</strong> ${data.articles_upsell || 0}</div>
                    <div><strong>Unités totales :</strong> ${data.quantite_totale_upsell || 0}</div>
                    <div><strong>Logique :</strong> 0-1 unité = compteur 0 | 2+ unités = compteur total-1</div>
                </div>
            </div>
        `;
        
        showNotificationToast(message, 'info');
    }

    window.ouvrirModalConfirmation = function(message, action) {
        const msgElem = document.getElementById('messageConfirmation');
        if (msgElem) msgElem.textContent = message;
        const btnConfirm = document.getElementById('btnConfirmer');
        if (btnConfirm) btnConfirm.onclick = action;
        const modal = document.getElementById('modalConfirmation');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalConfirmation = function() {
        const modal = document.getElementById('modalConfirmation');
        if (modal) modal.classList.add('hidden');
    };

    // Fonction pour sélectionner un article avec gestion des variantes
    window.selectionnerArticle = function(articleId, articleName) {
        console.log(`🎯 Sélection de l'article ${articleId}: "${articleName}"`);
        
        // Marquer l'article comme sélectionné (quantité sera définie lors de la sélection de variante)
        window.selectedArticleWithVariant = {
            articleId: articleId,
            articleName: articleName,
            quantite: 1, // Quantité par défaut, sera modifiée lors de la sélection de variante
            variante_id: null
        };
        
        // Masquer le bouton "Sélectionner" et afficher le bouton "Choisir variante"
        const btnSelectionner = document.getElementById(`btn-selectionner-${articleId}`);
        const btnVariantes = document.getElementById(`btn-variantes-${articleId}`);
        
        if (btnSelectionner) {
            btnSelectionner.classList.add('hidden');
        }
        
        if (btnVariantes) {
            btnVariantes.classList.remove('hidden');
            btnVariantes.classList.add('inline-flex');
        }
        
        // Vérifier si l'article a des variantes
        try {
            const article = window.articlesList?.find(a => a.id === articleId);
            const hasVar = article && Array.isArray(article.variantes_all) && article.variantes_all.length > 0;
            
            console.log('🔍 Vérification des variantes pour l\'article:', article);
            console.log('🔍 Variantes trouvées:', article?.variantes_all);
            
            if (hasVar) {
                // Si l'article a des variantes, afficher le bouton "Choisir variante"
                showNotificationToast(`Article "${articleName}" sélectionné. Cliquez sur "Choisir variante" pour continuer.`, 'info');
            } else {
                // Si l'article n'a pas de variantes, afficher directement le bouton "Ajouter au panier"
                const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
                if (btnAjouterPanier) {
                    btnAjouterPanier.classList.remove('hidden');
                    btnAjouterPanier.classList.add('inline-flex');
                }
                showNotificationToast(`Article "${articleName}" sélectionné. Cliquez sur "Ajouter au panier" pour confirmer.`, 'info');
            }
        } catch(e) { 
            console.warn('⚠️ Erreur détection variantes', e);
            // En cas d'erreur, afficher directement le bouton "Ajouter au panier"
            const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
            if (btnAjouterPanier) {
                btnAjouterPanier.classList.remove('hidden');
                btnAjouterPanier.classList.add('inline-flex');
            }
        }
    };



    window.supprimerArticle = function(panierId) {
        ouvrirModalConfirmation('Êtes-vous sûr de vouloir supprimer cet article ?', () => {
            const formData = new FormData();
            formData.append('action', 'delete_article');
            formData.append('panier_id', panierId);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
            
            fetch(`{% url 'Prepacommande:modifier_commande' commande.id %}`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    debugDatabaseInteraction('supprimer_article', data);
                    if (data.success) {
                        // Fermer la modale de confirmation
                        fermerModalConfirmation();
                        showNotificationToast('Article supprimé avec succès', 'success');
                        // Supprimer la ligne du tableau dynamiquement
                        supprimerLigneArticle(panierId);
                        // Mettre à jour tous les totaux et compteurs
                        mettreAJourTousLesTotaux(data);
                    } else {
                        // Fermer la modale de confirmation même en cas d'erreur
                        fermerModalConfirmation();
                        Swal.fire({
                            icon: 'error',
                            title: 'Erreur',
                            text: data.error || 'Impossible de supprimer l\'article.'
                        });
                    }
                })
                .catch(error => {
                    // Fermer la modale de confirmation en cas d'erreur réseau
                    fermerModalConfirmation();
                    handleError(error, 'suppression d\'article');
                });
        });
    };

    window.modifierQuantite = function(panierId, delta) {
        const input = document.getElementById(`quantite-${panierId}`);
        if (input) {
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(1, currentValue + delta);
            input.value = newValue;
            modifierQuantiteDirecte(panierId, newValue);
        }
    };

    window.modifierQuantiteDirecte = function(panierId, nouvelleQuantite) {
        const quantite = parseInt(nouvelleQuantite);
        
        // Validation
        if (isNaN(quantite) || quantite < 1) {
            // Restaurer la valeur précédente
            const input = document.getElementById(`quantite-${panierId}`);
            if (input) {
                input.value = input.getAttribute('data-previous-value') || 1;
            }
            Swal.fire({
                icon: 'warning',
                title: 'Quantité invalide',
                text: 'La quantité doit être au moins de 1.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        // Sauvegarder la valeur précédente
        const input = document.getElementById(`quantite-${panierId}`);
        if (input) {
            input.setAttribute('data-previous-value', input.value);
        }

        // Envoyer la modification au serveur
        const formData = new FormData();
        formData.append('action', 'modifier_quantite_directe');
        formData.append('panier_id', panierId);
        formData.append('nouvelle_quantite', quantite);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
        
        fetch(`{% url 'Prepacommande:modifier_commande' commande.id %}`, { 
            method: 'POST', 
            body: formData 
        })
        .then(res => res.json())
        .then(data => {
            debugDatabaseInteraction('modifier_quantite_directe', data);
            if (data.success) {
                if (quantite === 0) {
                    // Supprimer la ligne du tableau si l'article a été supprimé
                    const tableRow = document.querySelector(`tr[data-panier-id="${panierId}"]`);
                    if (tableRow) {
                        tableRow.remove();
                    }
                    showNotificationToast('Article supprimé', 'success');
                } else {
                    // Mettre à jour l'affichage du sous-total et du total
                    mettreAJourTotaux(panierId, data);
                    showNotificationToast('Quantité mise à jour', 'success');
                }
                
                // Mettre à jour le total général dans tous les cas
                if (data.total_commande) {
                    const totalElements = document.querySelectorAll('.total-commande');
                    totalElements.forEach(element => {
                        element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                    });
                }
                
                // Mettre à jour le compteur upsell si nécessaire
                if (data.compteur !== undefined) {
                    mettreAJourCompteurUpsell(data.compteur);
                }
            } else {
                // Restaurer la valeur précédente en cas d'erreur
                if (input) {
                    input.value = input.getAttribute('data-previous-value') || 1;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: data.error || 'Impossible de modifier la quantité.'
                });
            }
        })
        .catch(error => {
            // Restaurer la valeur précédente en cas d'erreur
            if (input) {
                input.value = input.getAttribute('data-previous-value') || 1;
            }
            handleError(error, 'modification de quantité');
        });
    };

    // Fonction pour mettre à jour les totaux après modification
    window.mettreAJourTotaux = function(panierId, data) {
        console.log('🔄 Mise à jour des totaux pour panier', panierId, ':', data);
        
        // Mettre à jour le sous-total de la ligne
        if (data.sous_total !== undefined) {
            const sousTotalCell = document.querySelector(`tr[data-panier-id="${panierId}"] td:nth-child(7)`);
            if (sousTotalCell) {
                sousTotalCell.textContent = `${parseFloat(data.sous_total).toFixed(2)} DH`;
                console.log('✅ Sous-total ligne mis à jour:', data.sous_total);
            }
        }
        
        // Mettre à jour le total articles
        if (data.sous_total_articles !== undefined) {
            const totalArticles = document.querySelectorAll('.total-commande');
            totalArticles.forEach(el => {
                el.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
            });
            console.log('✅ Total articles mis à jour:', data.sous_total_articles);
        }
        
        // Mettre à jour le total livraison et total final
        if (data.total_commande !== undefined) {
            // Total final (header, modale, etc.)
            const totalFinals = document.querySelectorAll('.total-final-commande');
            totalFinals.forEach(el => {
                el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
            
            // Si il y a un champ livraison
            if (data.frais_livraison !== undefined) {
                const livraisonEls = document.querySelectorAll('.total-livraison');
                livraisonEls.forEach(el => {
                    el.textContent = `+ ${parseFloat(data.frais_livraison).toFixed(2)} DH livraison`;
                });
            }
            
            console.log('✅ Total commande mis à jour:', data.total_commande);
        }
        
        // Mettre à jour le compteur d'articles
        if (data.articles_count !== undefined) {
            // Compteur en haut
            const countElement = document.getElementById('articles-count');
            if (countElement) {
                countElement.textContent = data.articles_count;
            }
            
            const pluralElement = document.getElementById('articles-plural');
            if (pluralElement) {
                pluralElement.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            // Compteur en bas
            const countElementBottom = document.getElementById('articles-count-bottom');
            if (countElementBottom) {
                countElementBottom.textContent = data.articles_count;
            }
            
            const pluralElementBottom = document.getElementById('articles-plural-bottom');
            if (pluralElementBottom) {
                pluralElementBottom.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            console.log('✅ Compteur d\'articles mis à jour:', data.articles_count);
        }
    };

    // Fonction de debug pour vérifier les interactions avec la base de données
    window.debugDatabaseInteraction = function(action, data) {
        console.log(`🔍 DEBUG - Action: ${action}`);
        console.log(`📊 Données reçues:`, data);
        console.log(`✅ Succès: ${data.success}`);
        if (data.success) {
            console.log(`💰 Total commande: ${data.total_commande}`);
            console.log(`📦 Nombre articles: ${data.nb_articles}`);
            console.log(`⬆️ Compteur upsell: ${data.compteur}`);
        } else {
            console.log(`❌ Erreur: ${data.error}`);
        }
        console.log('---');
    };

    // Fonction pour afficher des notifications toast discrètes
    window.showNotificationToast = function(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-full opacity-0`;
        
        if (type === 'success') {
            toast.classList.add('bg-green-500');
        } else if (type === 'error') {
            toast.classList.add('bg-red-500');
        } else if (type === 'info') {
            toast.classList.add('bg-blue-500');
        } else if (type === 'warning') {
            toast.classList.add('bg-yellow-500');
        } else {
            toast.classList.add('bg-gray-500');
        }
        
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        // Animation d'apparition
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 100);
        
        // Animation de disparition après 5 secondes
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                document.body.removeChild(toast);
                }
            }, 300);
        }, 5000);
    };

    // Alias pour showToast (utilisé dans certaines fonctions)
    window.showToast = window.showNotificationToast;

    // Fonctions pour les boutons individuels dans le template des articles
    window.modifierQuantitePrepa = function(panierId, quantiteActuelle) {
        // Ouvrir une modal simple pour modifier la quantité
        Swal.fire({
            title: 'Modifier la quantité',
            input: 'number',
            inputValue: quantiteActuelle,
            inputAttributes: {
                min: '0',
                step: '1'
            },
            showCancelButton: true,
            confirmButtonText: 'Modifier',
            cancelButtonText: 'Annuler',
            inputValidator: (value) => {
                if (value < 0) {
                    return 'La quantité ne peut pas être négative';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const nouvelleQuantite = parseInt(result.value);
                if (nouvelleQuantite === 0) {
                    // Supprimer l'article si quantité = 0
                    supprimerArticle(panierId);
                } else {
                    // Modifier la quantité
                    const formData = new FormData();
                    formData.append('action', 'modifier_quantite_directe');
                    formData.append('panier_id', panierId);
                    formData.append('nouvelle_quantite', nouvelleQuantite);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
                    
                    fetch(`{% url 'Prepacommande:modifier_commande' commande.id %}`, { 
                        method: 'POST', 
                        body: formData 
                    })
                    .then(res => res.json())
                    .then(data => {
                        debugDatabaseInteraction('modifier_quantite_prepa', data);
                        if (data.success) {
                            // Mettre à jour l'interface dynamiquement
                            mettreAJourTousLesTotaux(data);
                            
                            // Mettre à jour la ligne spécifique
                            mettreAJourLigneArticle(panierId, nouvelleQuantite, data.sous_total);
                            
                            // Mettre à jour les prix upsell si nécessaire
                            if (data.compteur !== undefined) {
                                mettreAJourPrixUnitaires();
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Succès !',
                                text: 'Quantité modifiée avec succès.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur',
                                text: data.error || 'Une erreur est survenue.'
                            });
                        }
                    })
                    .catch(handleError);
                }
            }
        });
    };

    window.supprimerArticlePrepa = function(panierId) {
        supprimerArticle(panierId);
    };

    // Fonction pour ajouter un nouvel article
    window.ajouterNouvelArticle = function() {
        isEditingArticle = false;
        currentArticleId = null;
        
        // Mettre à jour le titre
        document.getElementById('articleModalTitle').textContent = 'Ajouter un article';
        
        // Afficher le champ de sélection, cacher l'affichage
        document.getElementById('article-selection-field').classList.remove('hidden');
        document.getElementById('article-display-field').classList.add('hidden');
        
        // Réinitialiser le formulaire
        document.getElementById('articleSelect').value = '';
        document.getElementById('quantiteInput').value = '1';
        document.getElementById('article-info').classList.add('hidden');
        
        // Charger la liste des articles
        chargerArticlesDisponibles();
        
        // Afficher la modale
        const modal = document.getElementById('modalAjoutArticle');
        
        if (!modal) {
            console.error('❌ Modale modalAjoutArticle introuvable lors de l\'ajout d\'article');
            return;
        }
        
        if (!modal.style) {
            console.error('❌ Propriété style non disponible sur modalAjoutArticle');
            return;
        }
        
        try {
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } catch (error) {
            console.error('❌ Erreur lors de l\'ouverture de la modal:', error);
        }
    };

    // Fonction pour sauvegarder l'article
    window.saveArticle = function() {
        const quantite = parseInt(document.getElementById('quantiteInput').value);
        
        if (!quantite || quantite < 1) {
            alert('⚠️ Veuillez saisir une quantité valide (minimum 1)');
            return;
        }
        
        const select = document.getElementById('articleSelect');
        if (!select.value) {
            alert('⚠️ Veuillez sélectionner un article');
            return;
        }
        
        const articleId = select.value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        if (!csrfToken) {
            showToast('❌ Erreur: Token de sécurité manquant. Veuillez rafraîchir la page.', 'error');
            return;
        }

        let action = isEditingArticle ? 'update_article' : 'add_article';
        
        let body = new URLSearchParams({
            'action': action,
            'article_id': articleId,
            'quantite': quantite,
        });

        if(isEditingArticle) {
            body.append('panier_id', currentArticleId);
        }

        fetch('{% url "Prepacommande:modifier_commande" commande.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: body
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { 
                    throw new Error(`Erreur ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                let message = data.message || (isEditingArticle ? '✅ Article modifié' : '✅ Article ajouté');
                
                showToast(message, 'success');
                
                // Fermer la modale
                closeArticleModal();
                
             
            } else {
                showToast(`❌ Erreur: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            handleError(error, 'ajout d\'article');
        });
    };

    // Fonction pour fermer la modale d'ajout d'article
    window.closeArticleModal = function() {
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    };



    // Fonctions internes
    function chargerRegionEtFrais() {
        const select = document.getElementById('ville-select');
        if (!select) return;
        const selectedOption = select.options[select.selectedIndex];
        const region = selectedOption ? selectedOption.getAttribute('data-region') : '';
        const frais = selectedOption ? selectedOption.getAttribute('data-frais') : '0';
        const regionDisplay = document.getElementById('region-display');
        const fraisDisplay = document.getElementById('frais-display');
        if(regionDisplay) regionDisplay.value = region || '';
        if(fraisDisplay) fraisDisplay.value = `${frais || 0} DH`;
    }

    function chargerArticlesDisponibles(filterType = 'tous') {
        console.log('🔄 Chargement des articles avec filtre:', filterType);
        
        const url = new URL("{% url 'Prepacommande:api_articles_disponibles_prepa' %}", window.location.origin);
        url.searchParams.set('filter', filterType);
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📦 Données reçues de l\'API:', data);
                
                if (data.success && data.articles) {
                    console.log(`📦 ${data.articles.length} article(s) trouvé(s) (format objet)`);
                    articlesDisponibles = data.articles;
                    if (typeof window.afficherArticles === 'function') {
                        window.afficherArticles(data.articles);
                    } else {
                        console.error('❌ Fonction afficherArticles non trouvée');
                    }
                    
                    // Calculer les statistiques basiques si pas fournies
                    if (!data.stats) {
                        const stats = {
                            'tous': data.articles.length,
                            'disponible': data.articles.filter(a => a.qte_disponible > 0).length,
                            'upsell': data.articles.filter(a => a.isUpsell).length,
                            'promo': data.articles.filter(a => a.has_reduction).length,
                            'liquidation': data.articles.filter(a => a.phase === 'LIQUIDATION').length,
                            'test': data.articles.filter(a => a.phase === 'EN_TEST').length
                        };
                        if (typeof window.mettreAJourStatistiques === 'function') {
                            window.mettreAJourStatistiques(stats);
                        }
                    } else {
                        if (typeof window.mettreAJourStatistiques === 'function') {
                            window.mettreAJourStatistiques(data.stats);
                        }
                    }
                    
                    if (typeof window.mettreAJourFiltreActif === 'function') {
                        window.mettreAJourFiltreActif(filterType);
                    }
                } else {
                    console.warn('⚠️ Format de données inattendu:', data);
                    console.log('🔍 Propriétés disponibles:', Object.keys(data));
                    return;
                }
                
                console.log(`🎯 Articles à afficher:`, data.articles);
                window.articlesList = data.articles;
            }).catch(error => {
                console.error('❌ Erreur de chargement des articles:', error);
                showNotificationToast('❌ Erreur lors du chargement des articles', 'error');
            });
    }

    window.mettreAJourStatistiques = function(stats) {
        console.log('📊 Mise à jour des statistiques:', stats);
        if (!stats) {
            console.warn('⚠️ Stats non définies');
            return;
        }
        Object.keys(stats).forEach(key => {
            const element = document.getElementById(`count-${key}`);
            if (element) {
                element.textContent = stats[key];
                console.log(`✅ Stat ${key}: ${stats[key]}`);
            } else {
                console.warn(`⚠️ Element count-${key} non trouvé`);
            }
        });
    };

    window.mettreAJourFiltreActif = function(filterType) {
        console.log(`🎯 Mise à jour du filtre actif: ${filterType}`);
        // Retirer la classe active de tous les boutons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // Ajouter la classe active au bouton sélectionné
        const activeBtn = document.querySelector(`[onclick="filtrerArticles('${filterType}')"]`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
            console.log(`✅ Filtre ${filterType} activé`);
        } else {
            console.warn(`⚠️ Bouton pour le filtre ${filterType} non trouvé`);
        }
    };

    window.filtrerArticles = function(filterType) {
        chargerArticlesDisponibles(filterType);
    };

    // Fonction pour afficher les articles
    window.afficherArticles = function(articles) {
        const container = document.getElementById('articlesList');
        if (!container) {
            console.warn('Container articlesList non trouvé');
            return;
        }
        
        // Filtrer les doublons basés sur l'ID de l'article
        const articlesUniques = [];
        const articlesIds = new Set();
        
        articles.forEach(article => {
            if (!articlesIds.has(article.id)) {
                articlesIds.add(article.id);
                articlesUniques.push(article);
            }
        });
        
        console.log(`📊 Articles originaux: ${articles.length}, Articles uniques: ${articlesUniques.length}`);
        
        // Stocker les articles uniques dans une variable globale pour pouvoir les réutiliser
        window.articlesList = articlesUniques;
        
        container.innerHTML = '';
        
        if (articlesUniques.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-search text-4xl mb-4"></i>
                    <div class="text-lg font-medium">Aucun article trouvé</div>
                    <div class="text-sm">Essayez de modifier vos critères de recherche</div>
                </div>
            `;
            return;
        }
        
        // Créer un tableau HTML complet avec des bordures visibles
        const tableHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border-2 border-gray-300 rounded-lg shadow-lg" style="border-collapse: collapse;">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Article</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Prix</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Stock Général</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${articlesUniques.map(article => {
            // Badge de type d'article
            const typeBadge = article.article_type !== 'normal' ? `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${article.type_color ? article.type_color.replace('text-', 'bg-').replace('-600', '-100') : 'bg-blue-100 text-blue-600'} ${article.type_color || 'text-blue-600'} ml-2">
                    <i class="${article.type_icon || 'fas fa-tag'} mr-1"></i>
                    ${article.article_type.toUpperCase()}
                </span>
            ` : '';
            
            // Affichage du prix avec réduction si applicable
            const prixDisplay = article.has_reduction ? `
                <div class="text-sm">
                    <span class="font-semibold text-green-600">${article.prix} DH</span>
                    <span class="line-through text-gray-400 ml-2">${article.prix_original} DH</span>
                    <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs ml-2">-${article.reduction_pourcentage}%</span>
                </div>
            ` : `
                <div class="text-sm font-semibold text-green-600">${article.prix} DH</div>
            `;
            
            // Calculer le stock général (somme de tous les stocks des variantes)
            let stockGeneral = 0;
            let variantesEnRupture = [];
            
            if (article.variantes_all && Array.isArray(article.variantes_all)) {
                console.log(`🔍 Calcul stock général pour ${article.nom} - ${article.variantes_all.length} variantes:`);
                stockGeneral = article.variantes_all.reduce((total, variante) => {
                    const stockVariante = parseInt(variante.qte_disponible || variante.stock) || 0;
                    console.log(`  - Variante ${variante.id}: ${stockVariante} unités`);
                    if (stockVariante === 0) {
                        variantesEnRupture.push(variante);
                    }
                    return total + stockVariante;
                }, 0);
                console.log(`✅ Stock général calculé: ${stockGeneral} unités (${variantesEnRupture.length} variantes en rupture)`);
            } else {
                // Si pas de variantes, utiliser le stock de l'article principal
                stockGeneral = parseInt(article.qte_disponible) || 0;
            }
            
            // Statut du stock général amélioré
            let stockStatus;
            if (stockGeneral > 0) {
                const totalVariantes = article.variantes_all ? article.variantes_all.length : 1;
                const variantesDisponibles = totalVariantes - variantesEnRupture.length;
                
                if (variantesEnRupture.length === 0) {
                    // Toutes les variantes sont disponibles
                    stockStatus = `<span class="font-semibold text-green-600">${stockGeneral}</span>`;
                } else {
                    // Certaines variantes en rupture, d'autres disponibles
                    stockStatus = `<div class="text-center">
                        <span class="font-semibold text-green-600">${stockGeneral}</span>
                        <div class="text-xs text-orange-600 mt-1">
                            ${variantesDisponibles}/${totalVariantes} variantes disp.
                        </div>
                    </div>`;
                }
            } else {
                // Rupture totale
                stockStatus = `<span class="font-semibold text-red-600">Rupture</span>`;
            }
            
            // Icône d'information pour les variantes en rupture (si applicable)
            const infoIcon = variantesEnRupture.length > 0 && stockGeneral > 0 ? 
                `<button type="button" class="ml-2 text-blue-500 hover:text-blue-700" onclick="afficherVariantesEnRupture(${article.id}, ${JSON.stringify(variantesEnRupture).replace(/"/g, '&quot;')})" title="${variantesEnRupture.length} variante(s) en rupture">
                    <i class="fas fa-info-circle"></i>
                </button>` : '';
            
            return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-3 border-2 border-gray-300">
                        <div class="flex items-center">
                            <div>
                                <div class="text-sm font-medium text-gray-900">${article.nom}</div>
                                <div class="text-sm text-gray-500">Réf: ${article.reference || 'N/A'}</div>
                        ${typeBadge}
                    </div>
                </div>
                    </td>
                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                    ${prixDisplay}
                    </td>
                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                        <div class="flex items-center justify-center">
                        <span class="text-sm text-gray-900">${stockStatus}</span>
                            ${infoIcon}
                </div>
                    </td>
                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                        <div class="flex items-center justify-center gap-2">
                            <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors" 
                            onclick="selectionnerArticle(${article.id}, '${article.nom.replace(/'/g, "\\'")}')" 
                                    id="btn-selectionner-${article.id}">
                                <i class="fas fa-check mr-1"></i>Sélectionner
                    </button>
                            <button type="button" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors hidden" 
                                    id="btn-variantes-${article.id}"
                                    onclick="ouvrirModalVariantes(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                                <i class="fas fa-layer-group mr-1"></i>Choisir variante
                            </button>
                            <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors hidden btn-ajouter-panier" 
                                    id="btn-ajouter-panier-${article.id}"
                                    data-article-id="${article.id}"
                                    onclick="ajouterArticleAuPanierDepuisBouton(${article.id})"
                                    ${stockGeneral <= 0 ? 'disabled' : ''}>
                                <i class="fas fa-shopping-cart mr-1"></i>Ajouter au panier
                    </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = tableHTML;
    };

    // Fonction pour afficher les variantes en rupture
    window.afficherVariantesEnRupture = function(articleId, variantesEnRupture) {
        console.log('📋 Affichage des variantes en rupture pour l\'article', articleId, variantesEnRupture);
        
        // Créer le contenu HTML pour le modal
        let variantesHTML = '';
        if (variantesEnRupture && variantesEnRupture.length > 0) {
            variantesHTML = `
                <div class="space-y-3">
                    ${variantesEnRupture.map(variante => `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
                                            ${variante.couleur || 'N/A'}
                                        </span>
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
                                            ${variante.pointure || 'N/A'}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Réf: ${variante.reference_variante || 'N/A'}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-red-600">Rupture</div>
                                    <div class="text-xs text-gray-500">Stock: 0</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            variantesHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>Aucune variante en rupture</p>
                </div>
            `;
        }
        
        // Afficher le modal avec SweetAlert2
        Swal.fire({
            title: '<div class="flex items-center gap-2"><i class="fas fa-exclamation-triangle text-red-500"></i><span>Variantes en rupture</span></div>',
            html: `
                <div class="text-left">
                    <p class="mb-4 text-sm text-gray-600">Les variantes suivantes sont actuellement en rupture de stock :</p>
                    ${variantesHTML}
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Compris',
            confirmButtonColor: '#3085d6',
            width: '600px'
        });
    };

    // Fonction pour ajouter un article au panier depuis le bouton
    window.ajouterArticleAuPanierDepuisBouton = function(articleId) {
        console.log('🔄 ===== DÉBUT ajouterArticleAuPanierDepuisBouton =====');
        console.log('📦 articleId reçu:', articleId);
        console.log('📦 Type de articleId:', typeof articleId);
        console.log('📦 window.selectedArticleWithVariant:', window.selectedArticleWithVariant);
        console.log('📦 window._varianteSelection:', window._varianteSelection);
        console.log('🔍 Vérification des fonctions critiques:');
        console.log('- ouvrirModalConfirmation:', typeof window.ouvrirModalConfirmation);
        console.log('- ajouterArticleAuPanier:', typeof window.ajouterArticleAuPanier);
        
        // Récupérer la quantité depuis la sélection de variante ou utiliser 1 par défaut
        let quantite = 1;
        let articleName = 'Article';
        let varianteId = null;
        
        // Si une variante a été sélectionnée, récupérer la quantité depuis le modal de variantes
        console.log('🔍 Vérification selectedArticleWithVariant...');
        console.log('🔍 window.selectedArticleWithVariant:', window.selectedArticleWithVariant);
        console.log('🔍 window._varianteSelection:', window._varianteSelection);
        
        if (window.selectedArticleWithVariant && window.selectedArticleWithVariant.id === articleId) {
            // Récupérer la quantité depuis la variante sélectionnée
            const selectedVarianteId = window._varianteSelection[articleId];
            if (selectedVarianteId) {
                // Récupérer la quantité depuis l'input du modal de variantes
                const inputQuantite = document.getElementById(`qte-variante-${selectedVarianteId}`);
                if (inputQuantite) {
                    quantite = parseInt(inputQuantite.value) || 1;
                    console.log('✅ Quantité récupérée depuis l\'input du modal:', quantite);
                } else {
                    console.log('⚠️ Input de quantité non trouvé, utilisation de la quantité par défaut');
                    quantite = 1;
                }
            } else {
                console.log('⚠️ Aucune variante ID trouvée dans _varianteSelection');
                quantite = 1;
            }
            
            articleName = window.selectedArticleWithVariant.nom || 'Article';
            varianteId = selectedVarianteId;
            console.log('✅ Nom de l\'article récupéré:', articleName);
            console.log('✅ Variante ID récupéré:', varianteId);
        } else {
            console.log('⚠️ Aucune variante sélectionnée pour cet article');
            // Sinon, récupérer le nom de l'article depuis le tableau
            const row = document.querySelector(`[onclick*="selectionnerArticle(${articleId}"]`)?.closest('tr');
            console.log('🔍 Recherche de la ligne dans le tableau:', row);
            if (row) {
                articleName = row.querySelector('.text-sm.font-medium')?.textContent || 'Article';
                console.log('✅ Nom de l\'article trouvé dans le tableau:', articleName);
            } else {
                console.log('⚠️ Ligne non trouvée dans le tableau');
            }
            console.log('⚠️ Utilisation de la quantité par défaut (1)');
        }
        
        console.log('📊 Données finales:', { quantite, articleName, varianteId });
        
        // Ouvrir le modal de confirmation
        console.log('🔍 Tentative d\'ouverture du modal de confirmation...');
        if (typeof window.ouvrirModalConfirmation === 'function') {
            console.log('✅ Fonction ouvrirModalConfirmation trouvée, ouverture du modal...');
            window.ouvrirModalConfirmation(`Ajouter ${quantite} x "${articleName}" au panier ?`, () => {
                console.log('🔄 Callback du modal de confirmation exécuté');
                if (typeof window.ajouterArticleAuPanier === 'function') {
                    console.log('✅ Fonction ajouterArticleAuPanier trouvée, appel...');
                    // Passer l'ID de la variante si disponible
                    window.ajouterArticleAuPanier(articleId, quantite, varianteId);
                } else {
                    console.error('❌ Fonction ajouterArticleAuPanier non trouvée');
                }
                
                // Réinitialiser l'affichage après ajout
                const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
                const btnVariantes = document.getElementById(`btn-variantes-${articleId}`);
                const btnSelectionner = document.getElementById(`btn-selectionner-${articleId}`);
                
                if (btnAjouterPanier) {
                    btnAjouterPanier.classList.add('hidden');
                    btnAjouterPanier.classList.remove('inline-flex');
                }
                
                if (btnVariantes) {
                    btnVariantes.classList.add('hidden');
                    btnVariantes.classList.remove('inline-flex');
                }
                
                if (btnSelectionner) {
                    btnSelectionner.classList.remove('hidden');
                }
                
                // Réinitialiser les variables globales après l'ajout
                window.selectedArticleWithVariant = null;
                if (window._varianteSelection && window._varianteSelection[articleId]) {
                    delete window._varianteSelection[articleId];
                }
            });
        } else {
            console.error('❌ Fonction ouvrirModalConfirmation non trouvée');
            console.error('❌ ===== FIN ajouterArticleAuPanierDepuisBouton (ERREUR) =====');
        }
        console.log('✅ ===== FIN ajouterArticleAuPanierDepuisBouton =====');
    };

    function changeQuantite(articleId, delta) {
        const input = document.getElementById(`qte-article-${articleId}`);
        if (input) {
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
        }
    }

    window.ajouterArticleAuPanier = function(articleId, quantite, varianteId = null) {
        console.log('🔄 Ajout d\'article au panier:', { articleId, quantite, varianteId });
        
        const formData = new FormData();
        formData.append('action', 'add_article');
        formData.append('article_id', articleId);
        formData.append('quantite', quantite);
        if (varianteId) {
            formData.append('variante_id', varianteId);
        }
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
        
        fetch(`{% url 'Prepacommande:ajouter_article_commande_prepa' commande.id %}`, { 
            method: 'POST', 
            body: formData 
        })
            .then(res => res.json())
            .then(data => {
                debugDatabaseInteraction('ajouter_article', data);
                if (data.success) {
                    console.log('✅ Article ajouté avec succès:', data);
                    
                    // Fermer les modales
                    fermerModalConfirmation();
                    fermerModalAjoutArticle();
                    
                    // Si nous avons les données de l'article, l'ajouter dynamiquement
                    if (data.article_data) {
                        ajouterLigneArticle(data.article_data);
                        console.log('✅ Ligne d\'article ajoutée dynamiquement');
                    } else {
                        // Sinon, rafraîchir la section complète
                        setTimeout(() => {
                            rafraichirSectionArticles();
                        }, 300);
                    }
                    
                    // Mettre à jour tous les totaux et compteurs
                    mettreAJourTousLesTotaux(data);
                    
                    showNotificationToast(data.message || 'Article ajouté avec succès', 'success');
                } else {
                    console.error('❌ Erreur lors de l\'ajout:', data.error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: data.error || 'Impossible d\'ajouter l\'article.'
                    });
                }
            })
            .catch(error => {
                console.error('❌ Erreur réseau:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur de communication',
                    text: 'Impossible de contacter le serveur.'
                });
            });
    };

    window.handleResponse = function(data) {
        if (data.success) {
            // Mettre à jour l'interface dynamiquement au lieu de recharger
            if (data.total_commande !== undefined) {
                const totalElements = document.querySelectorAll('.total-commande, .total-final-commande');
                totalElements.forEach(element => {
                    element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                });
            }
            
            if (data.compteur !== undefined) {
                mettreAJourCompteurUpsell(data.compteur);
            }
            
            if (data.articles_count !== undefined) {
                const articlesCount = document.getElementById('articles-count');
                if (articlesCount) {
                    articlesCount.textContent = data.articles_count;
                }
            }
            
            // Mettre à jour les prix upsell si nécessaire
            if (data.compteur !== undefined) {
                mettreAJourPrixUnitaires();
            }
            
            Swal.fire({ 
                icon: 'success', 
                title: 'Succès !', 
                text: data.message || 'Opération réussie.', 
                timer: 2000, 
                showConfirmButton: false 
            });
        } else {
            Swal.fire({ 
                icon: 'error', 
                title: 'Erreur', 
                text: data.error || 'Une erreur est survenue.' 
            });
        }
    };

    window.handleError = function(error, context = '') {
        console.error(`❌ Erreur ${context}:`, error);
        
        let errorMessage = 'Une erreur inattendue s\'est produite.';
        
        if (error.message) {
            if (error.message.includes('couleur_fr')) {
                errorMessage = 'Erreur de configuration des couleurs d\'article. Veuillez contacter l\'administrateur.';
            } else if (error.message.includes('total_articles')) {
                errorMessage = 'Erreur de calcul des totaux. Veuillez rafraîchir la page.';
            } else {
                errorMessage = error.message;
            }
        }
        
        Swal.fire({ 
            icon: 'error', 
            title: 'Erreur',
            text: errorMessage,
            confirmButtonText: 'OK'
        });
    };

    // Event Listeners avec vérifications
    const searchInput = document.getElementById('searchArticle');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const filtered = window.articlesList.filter(article =>
                article.nom.toLowerCase().includes(query) ||
                (article.reference && article.reference.toLowerCase().includes(query)) ||
                (article.couleur && article.couleur.toLowerCase().includes(query)) ||
                (article.pointure && article.pointure.toLowerCase().includes(query))
            );
            window.afficherArticles(filtered);
        });
    } else {
        console.warn('Element searchArticle non trouvé');
    }

    const villeSelect = document.getElementById('ville-select');
    if (villeSelect) {
        villeSelect.addEventListener('change', chargerRegionEtFrais);
    } else {
        console.warn('Element ville-select non trouvé');
    }
    
    // Initialisation
    chargerRegionEtFrais();
    
    // Fonctions pour les modales d'information
    window.ouvrirModalInfoPrix = function() {
        const modal = document.getElementById('modalInfoPrix');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoPrix = function() {
        const modal = document.getElementById('modalInfoPrix');
        if (modal) modal.classList.add('hidden');
    };

    window.ouvrirModalInfoSousTotal = function() {
        const modal = document.getElementById('modalInfoSousTotal');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoSousTotal = function() {
        const modal = document.getElementById('modalInfoSousTotal');
        if (modal) modal.classList.add('hidden');
    };

    window.ouvrirModalInfoTotal = function() {
        const modal = document.getElementById('modalInfoTotal');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoTotal = function() {
        const modal = document.getElementById('modalInfoTotal');
        if (modal) modal.classList.add('hidden');
    };

    // Fonctions pour les modales d'information upsell
    window.ouvrirModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.remove('hidden');
            console.log('📖 Modal d\'information upsell ouverte');
        }
    };

    window.fermerModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.add('hidden');
            console.log('📖 Modal d\'information upsell fermée');
        }
    };

    // Vérification que tous les éléments critiques sont présents
    console.log('Vérification des éléments DOM:');
    console.log('- modalAjoutArticle:', document.getElementById('modalAjoutArticle') ? 'OK' : 'MANQUANT');
    console.log('- articlesList:', document.getElementById('articlesList') ? 'OK' : 'MANQUANT');
    console.log('- searchArticle:', document.getElementById('searchArticle') ? 'OK' : 'MANQUANT');
    console.log('- ville-select:', document.getElementById('ville-select') ? 'OK' : 'MANQUANT');
    console.log('- modalInfoUpsell:', document.getElementById('modalInfoUpsell') ? 'OK' : 'MANQUANT');
    console.log('- compteur-upsell-header:', document.getElementById('compteur-upsell-header') ? 'OK' : 'MANQUANT');
    
    // Initialisation du système upsell
    console.log('🚀 Initialisation du système upsell...');
    console.log(`📊 Compteur initial: ${compteurCommande}`);
    console.log(`📦 Articles dans le panier: ${document.querySelectorAll('tr[data-panier-id]').length}`);
    
    // Vérifier que l'élément compteur existe
    const compteurHeader = document.getElementById('compteur-upsell-header');
    if (!compteurHeader) {
        console.error('❌ Élément compteur-upsell-header non trouvé dans le DOM');
    } else {
        console.log('✅ Élément compteur-upsell-header trouvé');
    }
    
    // Fonction pour vérifier l'état de la base de données
    window.verifierEtatBaseDeDonnees = function() {
        console.log('🔍 Vérification de l\'état de la base de données...');
        
        // Vérifier les éléments de l'interface
        const articlesCount = document.querySelectorAll('tr[data-panier-id]').length;
        const compteurHeader = document.getElementById('compteur-upsell-header');
        const totalElements = document.querySelectorAll('.total-commande');
        
        console.log(`📦 Articles dans l'interface: ${articlesCount}`);
        console.log(`⬆️ Compteur upsell affiché: ${compteurHeader ? compteurHeader.textContent : 'Non trouvé'}`);
        console.log(`💰 Total affiché: ${totalElements.length > 0 ? totalElements[0].textContent : 'Non trouvé'}`);
        
        // Faire un appel API pour vérifier l'état réel
        fetch(`{% url 'Prepacommande:rafraichir_articles_commande_prepa' commande.id %}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 État réel de la base de données:');
                console.log(`📦 Articles en DB: ${data.articles_count || 'Non défini'}`);
                console.log(`💰 Total en DB: ${data.total_commande || 'Non défini'}`);
                console.log(`⬆️ Compteur en DB: ${data.compteur || 'Non défini'}`);
                
                // Comparer avec l'interface
                if (data.articles_count !== undefined && data.articles_count !== articlesCount) {
                    console.warn(`⚠️ Incohérence: nombre d'articles différent entre interface (${articlesCount}) et DB (${data.articles_count})`);
                }
                if (data.compteur !== undefined && data.compteur !== compteurCommande) {
                    console.warn(`⚠️ Incohérence: compteur upsell différent entre interface (${compteurCommande}) et DB (${data.compteur})`);
                }
                
                // Si tout est cohérent
                if (data.articles_count === articlesCount && data.compteur === compteurCommande) {
                    console.log('✅ Interface et base de données sont cohérentes');
                }
            })
            .catch(error => {
                console.error('❌ Erreur lors de la vérification:', error);
                console.log('💡 Essayez de rafraîchir la page ou de recharger les données');
            });
    };

    // Vérifier l'état de la base de données au chargement
    setTimeout(verifierEtatBaseDeDonnees, 1000);
    
    // Calculer et afficher le total des unités upsell
    const totalUpsell = calculerTotalUnitesUpsell();
    console.log(`⬆️ Total unités upsell: ${totalUpsell}`);
    
    // Vérifier la cohérence du compteur
    if (compteurCommande > 0 && totalUpsell === 0) {
        console.warn('⚠️ Compteur > 0 mais aucun article upsell trouvé');
        showNotificationToast('⚠️ Attention: Compteur upsell actif mais aucun article upsell détecté', 'warning');
    } else if (compteurCommande === 0 && totalUpsell > 1) {
        console.warn('⚠️ Articles upsell présents mais compteur = 0');
        showNotificationToast('⚠️ Attention: Articles upsell détectés mais compteur = 0. Utilisez le diagnostic pour corriger.', 'warning');
    }
    
    // Event listeners pour fermer les modales en cliquant à l'extérieur
    const modals = ['modalAjoutArticle', 'modalInfoUpsell', 'modalInfoPrix', 'modalInfoSousTotal', 'modalInfoTotal', 'modalConfirmation', 'modalVariantes'];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    // Fermer la modale selon son type
                    switch(modalId) {
                        case 'modalAjoutArticle':
                            fermerModalAjoutArticle();
                            break;
                        case 'modalInfoUpsell':
                            fermerModalInfoUpsell();
                            break;
                        case 'modalInfoPrix':
                            fermerModalInfoPrix();
                            break;
                        case 'modalInfoSousTotal':
                            fermerModalInfoSousTotal();
                            break;
                        case 'modalInfoTotal':
                            fermerModalInfoTotal();
                            break;
                        case 'modalConfirmation':
                            fermerModalConfirmation();
                            break;
                        case 'modalVariantes':
                            fermerModalVariantes();
                            break;
                    }
                }
            });
        }
    });
    
    // Event listener pour fermer les modales avec la touche Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            // Fermer la première modale ouverte
            if (!document.getElementById('modalAjoutArticle').classList.contains('hidden')) {
                fermerModalAjoutArticle();
            } else if (!document.getElementById('modalInfoUpsell').classList.contains('hidden')) {
                fermerModalInfoUpsell();
            } else if (!document.getElementById('modalInfoPrix').classList.contains('hidden')) {
                fermerModalInfoPrix();
            } else if (!document.getElementById('modalInfoSousTotal').classList.contains('hidden')) {
                fermerModalInfoSousTotal();
            } else if (!document.getElementById('modalInfoTotal').classList.contains('hidden')) {
                fermerModalInfoTotal();
            } else if (!document.getElementById('modalConfirmation').classList.contains('hidden')) {
                fermerModalConfirmation();
            } else if (!document.getElementById('modalVariantes').classList.contains('hidden')) {
                fermerModalVariantes();
            }
        }
    });
    
    // Event listener pour la sélection de ville (déjà défini plus haut)
    // Suppression de la double déclaration
    
    // Fonction pour forcer la synchronisation des données
    window.forcerSynchronisation = function() {
        console.log('🔄 Forçage de la synchronisation...');
        
        // Afficher un indicateur de chargement
        const syncBtn = document.querySelector('[onclick="forcerSynchronisation()"]');
        const originalText = syncBtn.innerHTML;
        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Sync...';
        syncBtn.disabled = true;
        
        // Vérifier l'état de la base de données
        verifierEtatBaseDeDonnees();
        
        // Restaurer le bouton après un délai
        setTimeout(() => {
            syncBtn.innerHTML = originalText;
            syncBtn.disabled = false;
        }, 2000);
    };

    // Suppression des sections dupliquées - ces fonctions sont déjà définies plus haut

    // ===== Gestion du modal des variantes =====
    window.fermerModalVariantes = function() {
        const modal = document.getElementById('modalVariantes');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    };

    window.chargerVariantesArticle = function(article) {
        const variantsList = document.getElementById('variantsList');
        if (!variantsList) {
            console.error('❌ Liste des variantes introuvable');
            return;
        }

        console.log('🔍 Chargement des variantes pour l\'article:', article);
        
        // Afficher un loader
        variantsList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement des variantes...</div>';

        // Utiliser les variantes déjà disponibles dans l'article
        if (article.variantes_all && Array.isArray(article.variantes_all) && article.variantes_all.length > 0) {
            console.log(`✅ ${article.variantes_all.length} variantes trouvées dans l'article`);
            afficherVariantes(article.variantes_all, article);
        } else {
            console.log('❌ Aucune variante disponible');
            variantsList.innerHTML = '<div class="text-center py-4 text-gray-500">Aucune variante disponible</div>';
        }
    };

    window.afficherVariantes = function(variants, article) {
        const variantsList = document.getElementById('variantsList');
        
        if (!variants || variants.length === 0) {
            variantsList.innerHTML = '<div class="text-center py-4 text-gray-500">Aucune variante disponible</div>';
            return;
        }

        // Créer un tableau HTML complet pour les variantes avec des bordures visibles
        const tableHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border-2 border-gray-300 rounded-lg shadow-lg" style="border-collapse: collapse;">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Variante</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Prix</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Stock</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Quantité</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Référence</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${variants.map(variant => {
                            const stockVariante = parseInt(variant.qte_disponible || variant.stock) || 0;
                            const stockClass = stockVariante > 0 ? 'text-green-600' : 'text-red-600';
                            const stockStatus = stockVariante > 0 ? 
                                `<span class="font-semibold text-green-600">${stockVariante}</span>` : 
                                `<span class="font-semibold text-red-600">Rupture</span>`;
                            
                            return `
                                <tr class="hover:bg-gray-50 transition-colors ${stockVariante <= 0 ? 'opacity-50' : ''}">
                                    <td class="px-4 py-3 border-2 border-gray-300">
                                        <div class="text-sm font-medium text-gray-900">
                                            ${variant.couleur || 'N/A'} - ${variant.pointure || 'N/A'}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <div class="text-sm font-semibold text-green-600">${variant.prix_actuel || variant.prix || 'N/A'} DH</div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <span class="text-sm ${stockClass}">${stockStatus}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        ${stockVariante > 0 ? `
                                            <div class="flex items-center justify-center gap-2">
                                                <button type="button" onclick="changeQuantiteVariante(${variant.id}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors">-</button>
                                                <input type="number" id="qte-variante-${variant.id}" class="w-16 p-2 border rounded-lg text-center text-sm" value="1" min="1" max="${stockVariante}">
                                                <button type="button" onclick="changeQuantiteVariante(${variant.id}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors">+</button>
                                            </div>
                                        ` : `
                                            <span class="text-red-500 text-sm font-medium">-</span>
                                        `}
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <div class="text-sm text-gray-600">${variant.reference_variante || 'N/A'}</div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        ${stockVariante > 0 ? `
                                            <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" 
                                                    onclick="selectionnerVariante(${variant.id}, ${article.id})">
                                                <i class="fas fa-check mr-1"></i>Sélectionner
                                            </button>
                                        ` : `
                                            <span class="text-red-500 text-sm font-medium">Indisponible</span>
                                        `}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        variantsList.innerHTML = tableHTML;
    }

    // Fonction pour changer la quantité d'une variante
    window.changeQuantiteVariante = function(variantId, delta) {
        const input = document.getElementById(`qte-variante-${variantId}`);
        if (input) {
            const currentValue = parseInt(input.value) || 1;
            const newValue = Math.max(1, currentValue + delta);
            const maxStock = parseInt(input.getAttribute('max')) || 99;
            
            if (newValue <= maxStock) {
                input.value = newValue;
                console.log(`✅ Quantité variante ${variantId} mise à jour: ${currentValue} → ${newValue}`);
            } else {
                console.warn(`⚠️ Quantité ${newValue} dépasse le stock maximum ${maxStock}`);
            }
        } else {
            console.error(`❌ Input de quantité pour variante ${variantId} non trouvé`);
        }
    };

    // Mise à jour de la fonction ouvrirModalVariantes existante
    window.ouvrirModalVariantes = function(article) {
        try {
            console.log('🔍 Ouverture modal variantes pour article:', article);
            
            const modal = document.getElementById('modalVariantes');
            if (!modal) {
                console.error('❌ Modal variantes introuvable');
            return;
        }
        
            // Afficher le modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Charger les variantes de l'article
            chargerVariantesArticle(article);
            
        } catch (e) {
            console.error('❌ Erreur ouverture modal variantes:', e);
            showNotificationToast('❌ Erreur lors de l\'ouverture du modal de variantes', 'error');
        }
    };

    // Fonction pour sélectionner une variante
    window.selectionnerVariante = function(variantId, articleId) {
        console.log('🔄 ===== DÉBUT selectionnerVariante =====');
        console.log('📦 Variante ID reçu:', variantId);
        console.log('📦 Article ID reçu:', articleId);
        console.log('📦 Type de variantId:', typeof variantId);
        console.log('📦 Type de articleId:', typeof articleId);
        
        try {
            // Récupérer les objets complets depuis les données stockées
            const article = window.articlesList ? window.articlesList.find(a => a.id === parseInt(articleId)) : null;
            const variant = article && article.variantes_all ? article.variantes_all.find(v => v.id === parseInt(variantId)) : null;
            
            console.log('🔍 Article trouvé:', article);
            console.log('🔍 Variante trouvée:', variant);
            
            if (!article || !variant) {
                console.error('❌ Article ou variante non trouvé');
            return;
        }
        
            console.log('🎯 Sélection de variante:', variant);
            
            // Fermer le modal des variantes
            fermerModalVariantes();
            
            // Récupérer la quantité depuis l'input de la variante
            const quantiteInput = document.getElementById(`qte-variante-${variant.id}`);
            if (!quantiteInput) {
                console.error(`❌ Input de quantité non trouvé pour la variante ${variant.id}`);
            return;
        }

            const quantite = parseInt(quantiteInput.value, 10);
            if (isNaN(quantite) || quantite <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Quantité invalide',
                    text: 'Veuillez entrer une quantité valide (minimum 1).',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Vérifier que la quantité ne dépasse pas le stock disponible
            const stockDisponible = parseInt(variant.qte_disponible || variant.stock) || 0;
            if (quantite > stockDisponible) {
                Swal.fire({
                    icon: 'error',
                    title: 'Quantité trop élevée',
                    text: `La quantité demandée (${quantite}) dépasse le stock disponible (${stockDisponible}).`,
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Créer un article combiné avec les données de la variante
            const articleAvecVariante = {
                ...article,
                // Ajouter les caractéristiques de la variante
                couleur: variant.couleur,
                pointure: variant.pointure,
                // Utiliser les prix et stock de la variante
                prix_actuel: variant.prix_actuel,
                qte_disponible: stockDisponible,
                // Ajouter l'ID de la variante pour référence
                variante_id: variant.id,
                reference_variante: variant.reference_variante,
                // Ajouter la quantité sélectionnée
                quantite: quantite
            };
            
            console.log('🔄 Article avec variante créé:', articleAvecVariante);
            
            // Stocker l'article avec variante pour l'utiliser lors de l'ajout
            window.selectedArticleWithVariant = articleAvecVariante;
            
            // Mettre à jour la variante sélectionnée dans la sélection globale
            window._varianteSelection = window._varianteSelection || {};
            window._varianteSelection[article.id] = variant.id;
            
            // Masquer le bouton "Choisir variante" et afficher le bouton "Ajouter au panier"
            console.log('🔧 Recherche des boutons pour article ID:', article.id);
            const btnVariantes = document.getElementById(`btn-variantes-${article.id}`);
            const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${article.id}`);
            
            if (btnVariantes) {
                btnVariantes.classList.add('hidden');
                btnVariantes.classList.remove('inline-flex');
                console.log('✅ Bouton "Choisir variante" masqué');
            } else {
                console.warn('⚠️ Bouton "Choisir variante" non trouvé');
            }
            
            if (btnAjouterPanier) {
                btnAjouterPanier.classList.remove('hidden');
                btnAjouterPanier.classList.add('inline-flex');
                console.log('✅ Bouton "Ajouter au panier" affiché');
            } else {
                console.warn('⚠️ Bouton "Ajouter au panier" non trouvé');
            }
            
            // Modifier l'affichage de l'article dans la liste pour montrer la variante sélectionnée
            const row = document.querySelector(`[onclick*="selectionnerArticle(${article.id}"]`)?.closest('tr');
            if (row) {
                const articleInfo = row.querySelector('.text-sm.text-gray-500');
                if (articleInfo) {
                    articleInfo.innerHTML = `Réf: ${article.reference || 'N/A'} | <span class="text-blue-600 font-medium">${variant.couleur || 'N/A'}</span> | <span class="text-blue-600 font-medium">${variant.pointure || 'N/A'}</span> | <span class="text-orange-600 font-medium">Qte: ${quantite}</span> <span class="text-green-600">(Variante sélectionnée)</span>`;
                }
            }
            
            // Afficher une notification de succès
            if (typeof showNotificationToast === 'function') {
                showNotificationToast(`✅ Variante sélectionnée: ${variant.couleur || 'N/A'} - ${variant.pointure || 'N/A'} (${quantite} unités). Cliquez sur "Ajouter au panier" pour confirmer.`, 'success');
            }
            
            console.log('✅ ===== FIN selectionnerVariante (SUCCÈS) =====');
            
        } catch (error) {
            console.error('❌ Erreur dans selectionnerVariante:', error);
            showNotificationToast('❌ Erreur lors de la sélection de la variante', 'error');
        }
    };


});
</script>

<!-- Modal de sélection des variantes -->
<div id="modalVariantes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-layer-group text-blue-500 mr-2"></i>
                        <span>Sélectionner une variante</span>
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600">
                        <span class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalVariantes()">
                            <i class="fas fa-times text-xl"></i>
                        </span>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600">Sélectionnez une variante de l'article pour l'ajouter au panier :</p>
                </div>
                
                <!-- Liste des variantes -->
                <div id="variantsList">
                    <!-- Les variantes seront chargées dynamiquement ici -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="fermerModalVariantes()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 