{% extends 'composant_generale/admin/base.html' %}
{% load static %}

{% block title %}Liste des Commandes - YZ-CMD{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/sync-enhanced.css' %}">
<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, var(--admin-gradient-start), var(--admin-gradient-end));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-shopping-cart mr-3" style="color: var(--admin-accent-color);"></i>
                Liste des Commandes
            </h1>
            <p style="color: var(--admin-accent-color);">Gérez les commandes du système</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <button id="syncAllBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-sync-alt mr-2"></i>Synchroniser
            </button>
            <a href="{% url 'commande:non_affectees' %}" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-user-clock mr-2"></i>Gérer Affectations
            </a>
            <a href="{% url 'commande:creer' %}" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-plus mr-2"></i>Nouvelle Commande
            </a>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
        <!-- Total Commandes -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-blue-300 animate-slideInUp" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-blue-100 to-blue-200 text-blue-600 transition-all duration-300 group-hover:from-blue-500 group-hover:to-blue-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-shopping-cart text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Total</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-blue-600">{{ total_commandes }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Nouvelles -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-green-300 animate-slideInUp" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-plus-circle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Nouvelles</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ commandes_nouvelles }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Non Affectées -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-orange-300 animate-slideInUp" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-orange-100 to-orange-200 text-orange-600 transition-all duration-300 group-hover:from-orange-500 group-hover:to-orange-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-clock text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Non Affectées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-orange-600">{{ commandes_non_affectees }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Affectées -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-teal-300 animate-slideInUp" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-teal-100 to-teal-200 text-teal-600 transition-all duration-300 group-hover:from-teal-500 group-hover:to-teal-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Affectées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-teal-600">{{ commandes_affectees }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Erronées -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-red-300 animate-slideInUp" style="animation-delay: 0.5s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-red-100 to-red-200 text-red-600 transition-all duration-300 group-hover:from-red-500 group-hover:to-red-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Erronées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-red-600">{{ commandes_erronnees }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes Doublons -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100 hover:border-purple-300 animate-slideInUp" style="animation-delay: 0.6s;">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-purple-100 to-purple-200 text-purple-600 transition-all duration-300 group-hover:from-purple-500 group-hover:to-purple-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-copy text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Doublons</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-purple-600">{{ commandes_doublons }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche et filtres -->
    <div class="bg-white rounded-xl shadow-md border p-6 mb-8" style="border-color: var(--admin-light-accent);">
        <form method="get" class="space-y-4" id="filterForm">
            <!-- Recherche générale -->
            <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-grow">
                <div class="relative">
                    <input type="text" name="search" value="{{ search_query|default:'' }}" 
                           class="w-full pl-10 pr-4 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                           style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);"
                               placeholder="Rechercher par N° commande, client, ville, état ou adresse...">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <button type="submit" class="px-6 py-2 rounded-lg text-white font-medium transition-all shadow-md hover:shadow-lg transform hover:scale-105" 
                    style="background-color: var(--admin-color);">
                Rechercher
            </button>
                {% if search_query or ville_filter or etat_filter %}
            <a href="{% url 'commande:liste' %}" class="px-6 py-2 rounded-lg bg-gray-500 text-white font-medium transition-all shadow-md hover:shadow-lg transform hover:scale-105">
                Réinitialiser
            </a>
            {% endif %}
            </div>
            
            <!-- Filtres spécifiques -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4 border-t border-gray-200">
                <!-- Filtre par ville du système -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-map-marker-alt mr-1"></i>Filtrer par ville système
                    </label>
                    <select name="ville_filter" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                            style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                        <option value="">Toutes les villes système</option>
                        {% for ville in villes %}
                        <option value="{{ ville.id }}" {% if ville_filter == ville.id|stringformat:"s" %}selected{% endif %}>
                            {{ ville.nom }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtre par ville initiale -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-file-alt mr-1"></i>Filtrer par ville fichier
                    </label>
                    <select name="ville_init_filter" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                            style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                        <option value="">Toutes les villes fichier</option>
                        {% for ville in villes_init %}
                        <option value="{{ ville }}" {% if ville_init_filter == ville %}selected{% endif %}>
                            {{ ville }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtre par région -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-globe-africa mr-1"></i>Filtrer par région
                    </label>
                    <select name="region_filter" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                            style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                        <option value="">Toutes les régions</option>
                        {% for region in regions %}
                        <option value="{{ region.id }}" {% if region_filter == region.id|stringformat:"s" %}selected{% endif %}>
                            {{ region.nom_region }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtre par état -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-tags mr-1"></i>Filtrer par état
                    </label>
                    <select name="etat_filter" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                            style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                        <option value="">Tous les états</option>
                        {% for etat in etats %}
                        <option value="{{ etat.id }}" {% if etat_filter == etat.id|stringformat:"s" %}selected{% endif %}>
                            {{ etat.libelle }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Nouveau Filtre pour les Commandes Synchronisées -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sync-alt mr-1"></i>Commandes Synchronisées
                    </label>
                    <select name="sync_filter" id="syncFilter" class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all" 
                            style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                        <option value="">Toutes les commandes</option>
                        <option value="last_minute" {% if sync_filter == 'last_minute' %}selected{% endif %}>Dernière minute</option>
                        <option value="last_hour" {% if sync_filter == 'last_hour' %}selected{% endif %}>Dernière heure</option>
                        <option value="today" {% if sync_filter == 'today' %}selected{% endif %}>Aujourd'hui</option>
                        <option value="last_24_hours" {% if sync_filter == 'last_24_hours' %}selected{% endif %}>Dernières 24 heures</option>
                        <option value="last_7_days" {% if sync_filter == 'last_7_days' %}selected{% endif %}>Derniers 7 jours</option>
                        <option value="custom_date" {% if sync_filter == 'custom_date' %}selected{% endif %}>Date personnalisée</option>
                    </select>
                    <input type="date" name="custom_sync_date" id="customSyncDate" 
                           value="{{ custom_sync_date|default:'' }}" 
                           class="w-full px-3 py-2 rounded-lg border focus:ring-2 focus:ring-offset-2 transition-all mt-2 {% if sync_filter != 'custom_date' %}hidden{% endif %}" 
                           style="border-color: var(--admin-accent-color); focus:ring-color: var(--admin-color);">
                </div>
            </div>
        </form>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="text-white text-lg mt-4">Chargement...</p>
        </div>
    </div>

    <!-- Message si aucun résultat -->
    <div id="noResultsMessage" class="{% if not page_obj %}block{% else %}hidden{% endif %} bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <span id="noResultsText">Aucune commande trouvée{% if search_query %} pour la recherche "{{ search_query }}"{% endif %}.</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Boutons d'actions en masse -->
    <div class="flex justify-between items-center mb-4">
        <!-- Bouton de raccourci vers les commandes affectées -->
        <div class="flex gap-4">
            <a href="{% url 'commande:affectees' %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-user-check mr-2"></i> Voir les Affectées
            </a>
            <a href="{% url 'commande:non_affectees' %}" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-user-clock mr-2"></i> Gérer les Non Affectées
            </a>
        </div>
        
        <!-- Actions rapides -->
        <div class="flex gap-4">
            <a href="{% url 'commande:paniers' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-shopping-cart mr-2"></i> Voir tous les paniers
            </a>
        </div>
    </div>

    <!-- Vue tableau des commandes -->
    <div class="overflow-x-auto mb-8" id="tableView">
        <table class="min-w-full divide-y divide-gray-200 border border-gray-200" style="border-collapse: collapse;">
            <thead class="bg-gray-50" style="background-color: var(--admin-color);">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">ID YZ</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">N° Externe</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">Client</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">Date</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">Ville</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">Total</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">État Commande</th>
                    <th class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider border-r border-b border-gray-200">Panier</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider border-b border-gray-200">Actions</th>
                </tr>
            </thead>
            <tbody id="commandTableBody" class="bg-white divide-y divide-gray-200">
                {% include 'commande/partials/_commande_table_body.html' with page_obj=page_obj %}
            </tbody>
        </table>
    </div>
    
    <!-- Contrôles de pagination flexible (style Excel) -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4 mb-6 transition-all duration-300 hover:shadow-xl">
        <div class="flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0">
            <!-- Section Éléments par page -->
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-list-ol text-sm" style="color: var(--admin-color);"></i>
                    <label class="text-xs font-semibold text-gray-700">Éléments par page:</label>
                </div>
                <select id="itemsPerPageSelect" class="px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                    <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100</option>
                    <option value="250" {% if items_per_page == 250 %}selected{% endif %}>250</option>
                    <option value="500" {% if items_per_page == 500 %}selected{% endif %}>500</option>
                    <option value="1000" {% if items_per_page == 1000 %}selected{% endif %}>1000</option>
                    <option value="2500" {% if items_per_page == 2500 %}selected{% endif %}>2500</option>
                    <option value="5000" {% if items_per_page == 5000 %}selected{% endif %}>5000</option>
                    <option value="10000" {% if items_per_page == 10000 %}selected{% endif %}>10000</option>
                    <option value="all" {% if items_per_page == 'all' %}selected{% endif %}>Tous</option>
                </select>
            </div>
            
            <!-- Section Plage personnalisée -->
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-arrows-alt-h text-sm" style="color: var(--admin-color);"></i>
                    <label class="text-xs font-semibold text-gray-700">Plage personnalisée:</label>
                </div>
                <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-2 border border-gray-200">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="startRangeInput" placeholder="Début" min="1" value="{{ start_range|default:'' }}" 
                               class="px-2 py-1 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-16 text-center bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" 
                               style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                        <span class="text-gray-500 text-xs font-medium">à</span>
                        <input type="number" id="endRangeInput" placeholder="Fin" min="1" value="{{ end_range|default:'' }}" 
                               class="px-2 py-1 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-16 text-center bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" 
                               style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="applyRangeBtn" class="px-3 py-1 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-md hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md text-xs font-medium">
                            <i class="fas fa-check mr-1"></i>Appliquer
                        </button>
                        <button id="clearRangeBtn" class="px-3 py-1 bg-gradient-to-r from-red-400 to-red-500 text-white rounded-md hover:from-red-500 hover:to-red-600 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md text-xs font-medium">
                            <i class="fas fa-times mr-1"></i>Effacer
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Section Statistiques -->
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-3 py-1.5 border border-blue-200">
                    <i class="fas fa-chart-bar text-sm" style="color: var(--admin-color);"></i>
                    <span class="text-xs font-semibold text-gray-700">Total: <span class="text-blue-600 font-bold">{{ page_obj.paginator.count }}</span> commandes</span>
                </div>
            </div>
        </div>
        
        <!-- Indicateur de statut -->
        <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-600">Pagination active</span>
                    </div>
                    {% if start_range and end_range %}
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-filter text-xs text-blue-500"></i>
                        <span class="text-xs text-blue-600 font-medium">Plage personnalisée: {{ start_range }} - {{ end_range }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-info-circle text-xs text-gray-400"></i>
                    <span class="text-xs text-gray-500">Utilisez les contrôles ci-dessus pour personnaliser l'affichage</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div id="paginationControls" class="flex justify-center mt-8">
        {% include 'commande/partials/_pagination.html' %}
    </div>

    <!-- Informations de pagination -->
    <div id="totalCommandsDisplay" class="flex justify-center mt-4">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-4 py-2 border border-blue-200 shadow-sm">
            <div class="flex items-center space-x-2">
                <i class="fas fa-info-circle text-sm" style="color: var(--admin-color);"></i>
                <span id="paginationInfo" class="text-sm font-medium text-gray-700">
                    Affichage de <span class="font-bold text-blue-600">{{ page_obj.start_index }}</span> à <span class="font-bold text-blue-600">{{ page_obj.end_index }}</span> sur <span class="font-bold text-blue-600">{{ page_obj.paginator.count }}</span> commandes
                </span>
            </div>
        </div>
    </div>
</div>

{% include 'synchronisation/_sync_progress_modal.html' %}

<script src="{% static 'js/sync-enhanced.js' %}"></script>
<script>
    // Fonction pour construire le HTML du panier
    function buildCartHTML(data) {
        const commande = data.commande;
        const articles = data.articles;
        
        let html = `
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-blue-800">Commande YZ-${commande.id_yz}</h4>
                            <p class="text-blue-700 text-sm">Client: ${commande.client_nom}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-lg font-bold text-blue-800">${commande.total_articles} article${commande.total_articles > 1 ? 's' : ''}</div>
                            <div class="text-sm text-blue-600">Total: ${commande.total_montant.toFixed(2)} DH</div>
                        </div>
                    </div>
                </div>`;
        
        if (articles.length > 0) {
            html += `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Article</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Référence</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prix unitaire</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantité</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sous-total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">`;
            
            articles.forEach(article => {
                html += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${article.nom}</div>
                                    ${article.description ? `<div class="text-sm text-gray-500">${article.description}</div>` : ''}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${article.reference}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    ${article.prix_unitaire.toFixed(2)} DH
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        ${article.quantite}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                                    ${article.sous_total.toFixed(2)} DH
                                </td>
                            </tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>`;
        } else {
            html += `
                <div class="text-center py-8">
                    <i class="fas fa-shopping-basket text-4xl text-gray-400 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Panier vide</h3>
                    <p class="text-gray-500">Cette commande ne contient aucun article.</p>
                </div>`;
        }
        
        html += `
                <div class="bg-gray-50 rounded-lg p-4 mt-4">
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-600">Sous-total articles:</span>
                            <span class="text-sm font-medium">${commande.total_montant.toFixed(2)} DH</span>
                        </div>
                        <hr class="border-gray-300">
                        <div class="flex justify-between">
                            <span class="text-lg font-semibold text-gray-900">Total commande:</span>
                            <span class="text-lg font-bold text-green-600">${commande.total_montant.toFixed(2)} DH</span>
                        </div>
                    </hr>
                </div>
            </div>`;
        
        return html;
    }

    function viewCart(commandeId) {
        fetch(`/api/commande/${commandeId}/panier/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const html = buildCartHTML(data);
                    document.getElementById('cartContent').innerHTML = html;
                    document.getElementById('cartModal').classList.remove('hidden');
                } else {
                    alert(data.error || 'Erreur lors du chargement du panier');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement du panier: ' + error.message);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Page des commandes - Aucune fonctionnalité de suppression
        console.log('Page des commandes chargée');
        
        // Gestion de la synchronisation
        const syncAllBtn = document.getElementById('syncAllBtn');
        if (syncAllBtn) {
            syncAllBtn.addEventListener('click', function() {
                const syncManager = new SyncEnhanced();
                syncManager.show();

                fetch("{% url 'synchronisation:sync_all' %}")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erreur HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        syncManager.showResult(data);
                        // Recharger la page après un court délai pour afficher les nouvelles données
                        setTimeout(() => {
                            location.reload();
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('Erreur lors de la synchronisation globale:', error);
                        syncManager.showResult({ success: false, sync_summary: 'Erreur technique', errors: [error.message] });
                    });
            });
        }
        
        // Gestionnaires pour la modal du panier
        const closeCartModalBtn = document.getElementById('closeCartModal');
        const cartModal = document.getElementById('cartModal');
        
        if (closeCartModalBtn) {
            closeCartModalBtn.addEventListener('click', function() {
                if (cartModal) {
                    cartModal.classList.add('hidden');
                }
            });
        }
        
        // Fermer la modal du panier en cliquant à l'extérieur
        window.addEventListener('click', function(event) {
            if (cartModal && event.target === cartModal) {
                cartModal.classList.add('hidden');
            }
        });
        
        // AJAX filtering logic
        const filterForm = document.getElementById('filterForm');
        const commandTableBody = document.getElementById('commandTableBody');
        const paginationControls = document.getElementById('paginationControls');
        const totalCommandsDisplay = document.getElementById('totalCommandsDisplay');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const noResultsMessage = document.getElementById('noResultsMessage');
        const noResultsText = document.getElementById('noResultsText');

        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
        }

        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function applyFilters(page = 1) {
            showLoading();
            const formData = new FormData(filterForm);
            const params = new URLSearchParams();

            // Append all form data, including hidden custom_sync_date if visible
            for (let [key, value] of formData.entries()) {
                if (key === 'custom_sync_date' && document.getElementById('syncFilter').value !== 'custom_date') {
                    // Skip custom_sync_date if custom_date is not selected
                    continue;
                }
                params.append(key, value);
            }
            params.append('page', page); // Add current page to params

            try {
                const response = await fetch(`{% url 'commande:liste' %}?${params.toString()}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest' // Indicate AJAX request
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                commandTableBody.innerHTML = data.html_table_body;
                paginationControls.innerHTML = data.html_pagination;
                
                // Mettre à jour l'affichage des informations de pagination
                const paginationInfo = document.getElementById('paginationInfo');
                if (paginationInfo) {
                    const parts = data.total_commands_display.split(' ');
                    paginationInfo.innerHTML = `
                        Affichage de <span class="font-bold text-blue-600">${parts[2]}</span> à <span class="font-bold text-blue-600">${parts[4]}</span> sur <span class="font-bold text-blue-600">${parts[6]}</span> commandes
                    `;
                }

                // Update no results message
                if (data.total_commands_count === 0) {
                    noResultsMessage.classList.remove('hidden');
                    noResultsText.textContent = `Aucune commande trouvée{% if search_query %} pour la recherche "{{ search_query }}"{% endif %}.`;
                    const currentSearchQuery = filterForm.querySelector('input[name="search"]').value;
                    noResultsText.textContent = `Aucune commande trouvée${currentSearchQuery ? ` pour la recherche "${currentSearchQuery}"` : ''}.`;
                } else {
                    noResultsMessage.classList.add('hidden');
                }


                // Re-attach event listeners to new pagination links
                attachPaginationListeners();

            } catch (error) {
                console.error('Erreur lors du filtrage AJAX:', error);
                alert('Erreur lors du chargement des commandes: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function attachPaginationListeners() {
            document.querySelectorAll('#paginationControls a').forEach(link => {
                link.removeEventListener('click', handlePaginationClick); // Remove old listeners
                link.addEventListener('click', handlePaginationClick); // Add new listeners
            });
        }

        function handlePaginationClick(e) {
            e.preventDefault();
            const url = new URL(this.href);
            const page = url.searchParams.get('page');
            applyFilters(page);
        }

        // Attach event listeners to filters for immediate update
        const filterInputs = filterForm.querySelectorAll('input, select');
        filterInputs.forEach(input => {
            input.addEventListener('change', () => applyFilters(1)); // Reset to page 1 on filter change
        });

        // Event listener for search input for dynamic updates, with a debounce for performance
        let searchTimeout;
        const searchInput = document.querySelector('input[name="search"]');
        if (searchInput) {
            searchInput.addEventListener('keyup', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters(1); // Reset to page 1 on search change
                }, 300); // Debounce for 300ms
            });
        }
        
        // Sync filter and custom date input visibility
        const syncFilterSelect = document.getElementById('syncFilter');
        const customSyncDateInput = document.getElementById('customSyncDate');
        
        if (syncFilterSelect) {
            syncFilterSelect.addEventListener('change', function() {
                if (this.value === 'custom_date') {
                    customSyncDateInput.classList.remove('hidden');
                } else {
                    customSyncDateInput.classList.add('hidden');
                    customSyncDateInput.value = ''; // Clear date if filter changes
                }
                applyFilters(1); // Apply filters when sync filter changes
            });
        }
        if (customSyncDateInput) {
            customSyncDateInput.addEventListener('change', () => applyFilters(1));
        }

        // Initial setup for pagination links
        attachPaginationListeners();
        
        // Gestion des contrôles de pagination flexible
        const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
        const startRangeInput = document.getElementById('startRangeInput');
        const endRangeInput = document.getElementById('endRangeInput');
        const applyRangeBtn = document.getElementById('applyRangeBtn');
        const clearRangeBtn = document.getElementById('clearRangeBtn');
        
        // Gestion du changement d'éléments par page
        if (itemsPerPageSelect) {
            itemsPerPageSelect.addEventListener('change', function() {
                const newItemsPerPage = this.value;
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('items_per_page', newItemsPerPage);
                currentParams.delete('start_range'); // Effacer les plages personnalisées
                currentParams.delete('end_range');
                currentParams.set('page', '1'); // Retour à la première page
                applyFiltersWithParams(currentParams.toString());
            });
        }
        
        // Gestion de l'application d'une plage personnalisée
        if (applyRangeBtn) {
            applyRangeBtn.addEventListener('click', function() {
                const startRange = startRangeInput.value.trim();
                const endRange = endRangeInput.value.trim();
                
                if (!startRange || !endRange) {
                    alert('Veuillez saisir une plage valide (début et fin)');
                    return;
                }
                
                const start = parseInt(startRange);
                const end = parseInt(endRange);
                
                if (isNaN(start) || isNaN(end) || start < 1 || end < start) {
                    alert('Veuillez saisir une plage valide (début < fin, nombres positifs)');
                    return;
                }
                
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.set('start_range', startRange);
                currentParams.set('end_range', endRange);
                currentParams.delete('page'); // La page sera calculée automatiquement
                applyFiltersWithParams(currentParams.toString());
            });
        }
        
        // Gestion de l'effacement de la plage personnalisée
        if (clearRangeBtn) {
            clearRangeBtn.addEventListener('click', function() {
                startRangeInput.value = '';
                endRangeInput.value = '';
                const currentParams = new URLSearchParams(window.location.search);
                currentParams.delete('start_range');
                currentParams.delete('end_range');
                currentParams.set('page', '1');
                applyFiltersWithParams(currentParams.toString());
            });
        }
        
        // Gestion de l'appui sur Entrée dans les champs de plage
        [startRangeInput, endRangeInput].forEach(input => {
            if (input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        applyRangeBtn.click();
                    }
                });
            }
        });
        
        // Fonction pour appliquer les filtres avec des paramètres spécifiques
        function applyFiltersWithParams(paramsString) {
            showLoading();
            
            fetch(`{% url 'commande:liste' %}?${paramsString}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                commandTableBody.innerHTML = data.html_table_body;
                paginationControls.innerHTML = data.html_pagination;
                
                // Mettre à jour l'affichage des informations de pagination
                const paginationInfo = document.getElementById('paginationInfo');
                if (paginationInfo) {
                    const parts = data.total_commands_display.split(' ');
                    paginationInfo.innerHTML = `
                        Affichage de <span class="font-bold text-blue-600">${parts[2]}</span> à <span class="font-bold text-blue-600">${parts[4]}</span> sur <span class="font-bold text-blue-600">${parts[6]}</span> commandes
                    `;
                }
                
                // Mettre à jour l'URL sans recharger la page
                const newUrl = `${window.location.pathname}?${paramsString}`;
                window.history.pushState({}, '', newUrl);
                
                // Réattacher les événements
                attachPaginationListeners();
                
                // Mettre à jour les contrôles de pagination
                updatePaginationControls();
            })
            .catch(error => {
                console.error('Erreur lors de l\'application des filtres:', error);
                alert('Erreur lors du chargement des commandes: ' + error.message);
            })
            .finally(() => {
                hideLoading();
            });
        }
        
        // Fonction pour mettre à jour les contrôles de pagination
        function updatePaginationControls() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentItemsPerPage = urlParams.get('items_per_page') || '10';
            const currentStartRange = urlParams.get('start_range') || '';
            const currentEndRange = urlParams.get('end_range') || '';
            
            // Mettre à jour le sélecteur d'éléments par page
            if (itemsPerPageSelect) {
                itemsPerPageSelect.value = currentItemsPerPage;
            }
            
            // Mettre à jour les champs de plage
            if (startRangeInput) {
                startRangeInput.value = currentStartRange;
            }
            if (endRangeInput) {
                endRangeInput.value = currentEndRange;
            }
        }
        
        // Initialiser les contrôles de pagination
        updatePaginationControls();
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        
        // Si le cookie n'est pas trouvé et qu'on cherche le token CSRF, essayer la méta tag
        if (!cookieValue && name === 'csrftoken') {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            if (metaTag) {
                cookieValue = metaTag.getAttribute('content');
            }
        }
        
        return cookieValue;
    }

    // Fonction pour ouvrir le modal d'affectation (commande unique)
    function openAffectationModal(commandeId, commandeIdYz) {
        document.getElementById('affectationCommandeIds').value = commandeId;
        document.getElementById('affectationCommandeIdYz').textContent = commandeIdYz;
        document.getElementById('affectationModal').classList.remove('hidden');
    }

    // Fonction pour ouvrir le modal d'affectation (commandes multiples)
    function openBulkAffectationModal(commandeIds) {
        document.getElementById('affectationCommandeIds').value = commandeIds.join(',');
        document.getElementById('affectationCommandeIdYz').textContent = `${commandeIds.length} commandes sélectionnées`;
        document.getElementById('affectationModal').classList.remove('hidden');
    }

    // Fonction pour fermer le modal d'affectation
    function closeAffectationModal() {
        document.getElementById('affectationModal').classList.add('hidden');
        document.getElementById('affectationForm').reset();
    }

    // Gestion de la soumission du formulaire d'affectation
    document.addEventListener('DOMContentLoaded', function() {
        const affectationForm = document.getElementById('affectationForm');
        if (affectationForm) {
            affectationForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const commandeIds = document.getElementById('affectationCommandeIds').value.split(',');
                const operateurId = document.getElementById('affectationOperateur').value;
                const commentaire = document.getElementById('affectationCommentaire').value;
                
                if (!operateurId) {
                    alert('Veuillez sélectionner un opérateur');
                    return;
                }
                
                const formData = new FormData();
                commandeIds.forEach(id => {
                    formData.append('commande_ids[]', id);
                });
                formData.append('operateur_id', operateurId);
                formData.append('commentaire', commentaire);
                
                fetch('{% url "commande:affecter_commandes" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Pas de modal de notification, rechargement direct
                        location.reload();
                    } else {
                        alert('Erreur: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue');
                });
            });
        }
    });

    // Fonction pour désaffecter une commande individuelle
    function desaffecterCommande(commandeId, commandeIdYz) {
        if (confirm(`Êtes-vous sûr de vouloir désaffecter la commande ${commandeIdYz} ?`)) {
            desaffecterCommandes([commandeId]);
        }
    }

    // Fonction pour désaffecter des commandes (simple ou multiple)
    function desaffecterCommandes(commandeIds) {
        const formData = new FormData();
        commandeIds.forEach(id => {
            formData.append('commande_ids[]', id);
        });
        
        fetch('{% url "commande:desaffecter_commandes" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue');
        });
    }
</script>

<!-- Modal du panier -->
<div id="cartModal" class="fixed inset-0 flex items-center justify-center z-50 hidden" style="background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(8px);">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">Détails du panier</h3>
                <button id="closeCartModal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
        </div>
        <div id="cartContent" class="p-6">
            <!-- Contenu du panier sera chargé ici -->
        </div>
    </div>
</div>

<!-- Modal d'affectation -->
<div id="affectationModal" class="fixed inset-0 flex items-center justify-center z-50 hidden" style="background-color: rgba(0, 0, 0, 0.2); backdrop-filter: blur(8px);">
    <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div class="text-center mb-6">
            <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-blue-100 mb-4">
                <i class="fas fa-user-plus text-blue-600 text-3xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Affecter les Commandes</h3>
            <p class="text-gray-600"><span id="affectationCommandeIdYz" class="font-semibold"></span></p>
        </div>
        <form id="affectationForm">
            <input type="hidden" id="affectationCommandeIds" />
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Opérateur</label>
                <select id="affectationOperateur" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    <option value="">Sélectionner un opérateur</option>
                    {% for operateur in operateurs %}
                    <option value="{{ operateur.id }}">{{ operateur.mail }} ({{ operateur.get_full_name }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire (optionnel)</label>
                <textarea id="affectationCommentaire" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" rows="3" placeholder="Ajouter un commentaire..."></textarea>
            </div>
            <div class="flex justify-center gap-4">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                    <i class="fas fa-user-plus mr-2"></i>Affecter
                </button>
                <button type="button" onclick="closeAffectationModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-lg transition duration-300 transform hover:scale-105">
                    <i class="fas fa-times mr-2"></i>Annuler
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock content %} 