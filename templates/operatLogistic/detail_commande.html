{% extends 'composant_generale/operatLogistic/base.html' %}
{% load static %}

{% block title %}Détail Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    
    .animate-fadeIn {
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    :root {
        --logistic-primary: #2563eb;
        --logistic-dark: #1d4ed8;
        --logistic-light: #dbeafe;
        --logistic-border: #3b82f6;
    }

    .sav-action-btn {
        color: white;
        padding: 12px;
        border-radius: 8px;
        font-weight: 500;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .sav-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête avec navigation -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, var(--logistic-primary), var(--logistic-dark));">
        <div class="flex items-center space-x-4">
            <a href="{% url 'operatLogistic:liste_commandes' %}" 
               class="flex items-center px-4 py-2 bg-white text-gray-700 hover:bg-gray-100 rounded-lg transition-all duration-300 shadow-sm border border-gray-200 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>
                Retour à la liste
            </a>
            <div class="text-2xl font-bold">
                <i class="fas fa-truck mr-3" style="color: var(--logistic-light);"></i>
                Commande {{ commande.id_yz }}
            </div>
        </div>
        

    </div>

    <!-- Section Actions Rapides de Livraison -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-bolt mr-2"></i>Actions Rapides de Livraison
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Statut de livraison -->
            <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-truck text-blue-600 text-xl"></i>
                    <span class="text-xs font-medium text-blue-700 px-2 py-1 bg-blue-200 rounded-full">
                        {{ commande.etat_actuel.enum_etat.libelle|default:"En cours" }}
                    </span>
                </div>
                <h3 class="font-semibold text-blue-800 mb-2">Statut Actuel</h3>
                <p class="text-sm text-blue-600">
                    {% if commande.etat_actuel %}
                        {{ commande.etat_actuel.enum_etat.libelle }}
                    {% else %}
                        En attente de traitement
                    {% endif %}
                </p>
            </div>

            <!-- Contact client -->
            <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-phone text-green-600 text-xl"></i>
                    <span class="text-xs font-medium text-green-700 px-2 py-1 bg-green-200 rounded-full">
                        Contact
                    </span>
                </div>
                <h3 class="font-semibold text-green-800 mb-2">Contact Client</h3>
                <p class="text-sm text-green-600">
                    {{ commande.client.numero_tel|default:"Non renseigné" }}
                </p>
                {% if commande.client.numero_tel %}
                    <a href="tel:{{ commande.client.numero_tel }}" 
                       class="inline-flex items-center mt-2 px-3 py-1 bg-green-600 text-white text-xs rounded-full hover:bg-green-700 transition-colors">
                        <i class="fas fa-phone mr-1"></i>Appeler
                    </a>
                {% endif %}
            </div>

            <!-- Localisation -->
            <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-map-marker-alt text-purple-600 text-xl"></i>
                    <span class="text-xs font-medium text-purple-700 px-2 py-1 bg-purple-200 rounded-full">
                        {{ commande.ville.nom }}
                    </span>
                </div>
                <h3 class="font-semibold text-purple-800 mb-2">Zone de Livraison</h3>
                <p class="text-sm text-purple-600">
                    {{ commande.ville.nom }}
                    {% if commande.ville.region %}
                        <br><span class="text-xs">Région: {{ commande.ville.region.nom_region }}</span>
                    {% endif %}
                </p>
            </div>

            <!-- Valeur commande -->
            <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                <div class="flex items-center justify-between mb-3">
                    <i class="fas fa-money-bill-wave text-orange-600 text-xl"></i>
                    <span class="text-xs font-medium text-orange-700 px-2 py-1 bg-orange-200 rounded-full">
                        {{ commande.paniers.count }} articles
                    </span>
                </div>
                <h3 class="font-semibold text-orange-800 mb-2 flex items-center">
                    Valeur Totale
                    <button type="button" 
                            onclick="afficherModalValeurTotale()" 
                            class="ml-2 text-orange-600 hover:text-orange-800 transition-colors"
                            title="Voir le détail du calcul">
                        <i class="fas fa-info-circle text-sm"></i>
                    </button>
                </h3>
                <p class="text-lg font-bold text-orange-600">
                    {{ commande.total_cmd|floatformat:2 }} DH
                </p>
                <p class="text-xs text-orange-500 mt-1 flex items-center">
                    + {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH livraison
                    <button type="button" 
                            onclick="afficherModalFraisLivraison()" 
                            class="ml-1 text-orange-500 hover:text-orange-700 transition-colors"
                            title="Voir le détail des frais de livraison">
                        <i class="fas fa-info-circle text-xs"></i>
                    </button>
                </p>
            </div>
        </div>
    </div>

    <!-- Section Timeline de Livraison -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold flex items-center" style="color: var(--logistic-primary);">
                <i class="fas fa-history mr-2"></i>Timeline de Livraison
            </h2>
            <button type="button" 
                    onclick="toggleTimeline()" 
                    class="flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200"
                    id="timeline-toggle-btn">
                <i class="fas fa-chevron-down mr-2" id="timeline-icon"></i>
                <span id="timeline-toggle-text">Masquer</span>
            </button>
        </div>
        
        <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 transition-all duration-300 ease-in-out" id="timeline-content">
            <div class="space-y-4">
                {% for etat in commande.etats.all|slice:":8" %}
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-3 h-3 rounded-full mt-2" 
                         style="background-color: {{ etat.enum_etat.couleur|default:'#6b7280' }};"></div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">{{ etat.enum_etat.libelle }}</p>
                        <p class="text-xs text-gray-500">
                            {{ etat.date_debut|date:"d/m/Y à H:i" }}
                            {% if etat.operateur %}
                                par {{ etat.operateur.nom_complet }}
                            {% endif %}
                        </p>
                        {% if etat.commentaire %}
                            <p class="text-xs text-gray-400 mt-1 italic">{{ etat.commentaire|truncatechars:80 }}</p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-sm text-gray-500 italic">Aucun historique disponible</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert mb-6 p-4 rounded-xl border-l-4 animate-slideInUp alert-dismissible
                    {% if message.tags == 'success' %}border-green-500 bg-green-50 text-green-700{% endif %}
                    {% if message.tags == 'error' %}border-red-500 bg-red-50 text-red-700{% endif %}
                    {% if message.tags == 'warning' %}border-yellow-500 bg-yellow-50 text-yellow-700{% endif %}"
             data-message-id="message-{{ forloop.counter }}">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="{% if message.tags == 'success' %}fas fa-check-circle{% elif message.tags == 'error' %}fas fa-exclamation-circle{% else %}fas fa-info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
                <button type="button" class="ml-4 text-gray-400 hover:text-gray-600 transition-colors" onclick="dismissMessage('message-{{ forloop.counter }}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Section 1: Informations Client -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-user mr-2"></i>Informations Client
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Nom complet -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Nom complet :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-user mr-2" style="color: var(--logistic-primary);"></i>
                    {{ commande.client.prenom }} {{ commande.client.nom }}
                </p>
            </div>
            
            <!-- Téléphone -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Téléphone :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-phone mr-2" style="color: var(--logistic-primary);"></i>
                    {{ commande.client.numero_tel|default:"Non renseigné" }}
                </p>
            </div>

            <!-- Email -->
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <label class="block text-sm font-semibold mb-2 text-gray-600">Email :</label>
                <p class="text-lg font-medium text-gray-800">
                    <i class="fas fa-envelope mr-2" style="color: var(--logistic-primary);"></i>
                    {% if commande.client.email %}
                        <a href="mailto:{{ commande.client.email }}" class="text-blue-600 hover:text-blue-800 underline">
                            {{ commande.client.email }}
                        </a>
                    {% else %}
                        <span class="text-gray-500">Non renseigné</span>
                    {% endif %}
                </p>
            </div>

            <!-- Ville Client (origine) -->
            <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <label class="block text-sm font-semibold mb-2 text-orange-600">Ville Client (origine) :</label>
                <p class="text-lg font-medium text-orange-800">
                    <i class="fas fa-home mr-2"></i>
                    {{ commande.ville_init|default:"Non spécifiée" }}
                </p>
            </div>

            <!-- Ville de livraison -->
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <label class="block text-sm font-semibold mb-2 text-green-600">Ville de livraison :</label>
                <p class="text-lg font-medium text-green-800">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    {{ commande.ville.nom }}
                </p>
                {% if commande.ville.region %}
                    <p class="text-sm text-green-600 mt-1">
                        <i class="fas fa-globe mr-1"></i>
                        Région : {{ commande.ville.region.nom_region }}
                    </p>
                {% endif %}
            </div>

            <!-- Frais de livraison -->
            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                <label class="block text-sm font-semibold mb-2 text-purple-600 flex items-center">
                    Frais de livraison :
                    <button type="button" 
                            onclick="afficherModalFraisLivraison()" 
                            class="ml-2 text-purple-600 hover:text-purple-800 transition-colors"
                            title="Voir le détail des frais de livraison">
                        <i class="fas fa-info-circle text-sm"></i>
                    </button>
                </label>
                <p class="text-lg font-medium text-purple-800">
                    <i class="fas fa-truck mr-2"></i>
                    {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH
                </p>
            </div>

            <!-- Adresse de livraison -->
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 col-span-1 md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-semibold mb-2 text-blue-600">
                    <i class="fas fa-map-marked-alt mr-2"></i>Adresse de livraison complète :
                </label>
                <p class="text-lg font-medium text-blue-800">
                    {{ commande.adresse|default:"Adresse non renseignée" }}
                </p>
            </div>
        </div>
    </div>

    <!-- Section 2: Informations Générales de la Commande -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-info-circle mr-2"></i>Informations Générales de la Commande
        </h2>
        
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             <!-- ID YZ -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">ID YZ :</label>
                 <p class="text-lg font-bold text-gray-800">
                     <i class="fas fa-barcode mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.id_yz }}
                 </p>
             </div>
             
             <!-- N° Externe -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">N° Externe :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-hashtag mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.num_cmd|default:"-" }}
                 </p>
             </div>
             
             <!-- Date de commande -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">Date de commande :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-calendar-alt mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.date_cmd|date:"d/m/Y" }}
                 </p>
             </div>

             <!-- Date de création -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">Date de création :</label>
                 <p class="text-lg font-medium text-gray-800">
                     <i class="fas fa-clock mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.date_creation|date:"d/m/Y H:i" }}
                 </p>
             </div>

             <!-- Valeur de la commande -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">Valeur de la commande :</label>
                 <p class="text-xl font-bold text-gray-800">
                     <i class="fas fa-money-bill-wave mr-2" style="color: var(--logistic-primary);"></i>
                     {{ commande.total_cmd|floatformat:2 }} DH
                 </p>
             </div>

             <!-- État actuel -->
             <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                 <label class="block text-sm font-semibold mb-2 text-gray-600">État actuel :</label>
                 <div class="flex items-center">
                     <div class="w-3 h-3 rounded-full mr-2" style="background-color: #10b981;"></div>
                     <p class="text-lg font-medium text-gray-800">
                         <i class="fas fa-truck mr-2" style="color: var(--logistic-primary);"></i>
                         {{ commande.etat_actuel.enum_etat.libelle|default:"En cours de livraison" }}
                     </p>
                 </div>
                 <p class="text-xs text-gray-600 mt-1">
                     <i class="fas fa-clock mr-1"></i>
                     {% if commande.etat_actuel %}
                         Dernière mise à jour : {{ commande.etat_actuel.date_debut|date:"d/m/Y à H:i" }}
                     {% else %}
                         État en cours de mise à jour
                     {% endif %}
                 </p>
             </div>

             <!-- Informations de livraison -->
             {% with dernier_envoi=commande.envois.last %}
             {% if dernier_envoi %}
             <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                 <label class="block text-sm font-semibold mb-2 text-blue-600">Informations de livraison :</label>
                 <div class="space-y-2">
                     <p class="text-sm text-blue-800">
                         <i class="fas fa-calendar-alt mr-2"></i>
                         Date de livraison prévue : {{ dernier_envoi.date_livraison_prevue|date:"d/m/Y" }}
                     </p>
                     
                     {% if dernier_envoi.status == 'reporte' and dernier_envoi.date_report %}
                     <div class="mt-2">
                         <p class="text-sm text-orange-800">
                             <i class="fas fa-clock mr-2"></i>
                             Reportée au : {{ dernier_envoi.date_report|date:"d/m/Y" }}
                         </p>
                         {% if dernier_envoi.motif_report %}
                         <p class="text-xs text-orange-600 mt-1">
                             <i class="fas fa-info-circle mr-1"></i>
                             Motif : {{ dernier_envoi.motif_report }}
                         </p>
                         {% endif %}
                     </div>
                     {% endif %}

                     {% if dernier_envoi.status == 'livre' %}
                     <p class="text-sm text-green-800">
                         <i class="fas fa-check-circle mr-2"></i>
                         Livrée le : {{ dernier_envoi.date_modification|date:"d/m/Y" }}
                     </p>
                     {% endif %}

                     <p class="text-xs text-gray-600 mt-1">
                         <i class="fas fa-user mr-1"></i>
                         Opérateur : {{ dernier_envoi.operateur.nom_complet|default:"Non assigné" }}
                     </p>
                 </div>
             </div>
             {% endif %}
             {% endwith %}
         </div>
    </div>

    <!-- Section 3: Articles du Panier (Modifiable) -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold flex items-center" style="color: var(--logistic-primary);">
            <i class="fas fa-shopping-basket mr-2"></i>Articles du Panier ({{ commande.paniers.count }}articles)
            {% if commande.compteur > 0 %}
            <span class="px-3 py-1 bg-orange-100 text-orange-800 text-sm font-semibold rounded-full flex items-center">
                <i class="fas fa-arrow-alt-circle-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
            </span>
            {% endif %}
        </h2>
        {# Ancien bouton "Ajouter un article" supprimé #}
        </div>
        
        <!-- Avertissement pour les commandes confirmées -->
        {% if commande_confirmee %}
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                    <h3 class="font-semibold text-yellow-800">Commande confirmée - Impact sur le stock</h3>
                </div>
                <p class="text-sm text-yellow-700 mt-2">
                    <strong>Cette commande a déjà été confirmée et a impacté le stock.</strong> 
                    Toute modification d'articles (ajout, suppression, modification de quantité) 
                    mettra automatiquement à jour le stock des articles concernés.
                </p>
                <ul class="list-disc list-inside text-xs text-yellow-600 mt-2 space-y-1">
                    <li><strong>Ajout d'articles :</strong> Le stock sera décrémenté</li>
                    <li><strong>Suppression d'articles :</strong> Le stock sera incrémenté</li>
                    <li><strong>Augmentation de quantité :</strong> Le stock sera décrémenté pour la différence</li>
                    <li><strong>Diminution de quantité :</strong> Le stock sera incrémenté pour la différence</li>
                </ul>
            </div>
                                 {% endif %}
        
        <!-- Indicateur de livraison partielle -->
        {% if commande.etat_actuel.enum_etat.libelle == 'Livrée Partiellement' %}
        <div class="mb-4 p-4 bg-gradient-to-r from-green-50 to-blue-50 border border-green-300 rounded-lg">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-box-open text-2xl text-green-600 mt-1"></i>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-semibold text-green-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>Livraison Partielle Effectuée
                    </h3>
                    <p class="text-green-700 mb-3">
                        Cette commande a été livrée partiellement. Certains articles ont été livrés au client, 
                        tandis que d'autres ont été renvoyés en préparation pour traitement.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded border border-green-200">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="font-medium text-green-800">Articles Livrés</span>
                            </div>
                            <p class="text-sm text-green-700">
                                Les articles affichés ci-dessous ont été livrés au client avec les quantités indiquées.
                            </p>
                        </div>
                        <div class="bg-white p-3 rounded border border-orange-200">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-undo text-orange-600 mr-2"></i>
                                <span class="font-medium text-orange-800">Articles Renvoyés</span>
                            </div>
                            <p class="text-sm text-orange-700">
                                Les articles non livrés ont été transférés vers une commande de renvoi pour traitement.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Liste des articles existants -->
        <div id="articles-container" class="space-y-3 mb-6">
            {% include 'operatLogistic/partials/_articles_section.html' %}
        </div>

        <!-- Résumé total -->
        <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
            <div class="flex flex-col space-y-2">
                <!-- Ligne principale du total -->
            <div class="flex justify-between items-center">
                    <div class="text-lg font-semibold text-gray-700 flex items-center">
                    <i class="fas fa-calculator mr-2"></i>Total de la commande:
                        <button type="button" 
                                onclick="afficherModalCalculs()" 
                                class="ml-2 text-blue-600 hover:text-blue-800 transition-colors"
                                title="Voir le détail des calculs">
                            <i class="fas fa-info-circle"></i>
                        </button>
                </div>
                <div class="text-2xl font-bold" style="color: var(--logistic-primary);" id="total-commande">
                        {% with total_avec_livraison=commande.total_cmd|add:commande.ville.frais_livraison|default:0 %}
                            {{ total_avec_livraison|floatformat:2 }} DH
                        {% endwith %}
                    </div>
                </div>
                
                <!-- Détail des frais de livraison -->
                <div class="flex justify-end items-center text-xs text-gray-600">
                    <i class="fas fa-truck mr-1"></i>
                    Inclut frais de livraison: {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH
                    <button type="button" 
                            onclick="afficherModalFraisLivraison()" 
                            class="ml-1 text-purple-600 hover:text-purple-800 transition-colors"
                            title="Voir le détail des frais de livraison">
                        <i class="fas fa-info-circle text-xs"></i>
                    </button>
                </div>
            </div>
         </div>
    </div>

    <!-- Section SAV - Création de Commande pour Articles Défectueux -->
    {% if commande.etat_actuel.enum_etat.libelle == 'Retournée' or commande.etat_actuel.enum_etat.libelle == 'Livrée' or commande.etat_actuel.enum_etat.libelle == 'Livrée Partiellement' or commande.etat_actuel.enum_etat.libelle == 'Livrée avec changement' %}
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-tools mr-2"></i>Service Après-Vente - Articles Défectueux
        </h2>
        
        <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
            <div class="flex items-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl mr-3"></i>
                <h3 class="text-lg font-semibold text-red-800">
                    {% if commande.etat_actuel.enum_etat.libelle == 'Retournée' %}
                        Commande Retournée - Articles Défectueux
                    {% else %}
                        Service Après-Vente - Articles Défectueux
                    {% endif %}
                </h3>
            </div>
            <p class="text-red-700 mb-4">
                {% if commande.etat_actuel.enum_etat.libelle == 'Retournée' %}
                    Cette commande a été retournée par le client en raison de défauts sur un ou plusieurs articles. 
                    Créez une nouvelle commande SAV avec des articles neufs en parfait état pour améliorer l'expérience client.
                {% else %}
                    Le client a signalé des défauts sur un ou plusieurs articles de cette commande. 
                    Créez une nouvelle commande SAV avec des articles neufs en parfait état pour améliorer l'expérience client.
                {% endif %}
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Informations sur la commande -->
                <div class="bg-white p-4 rounded-lg border border-red-200">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                        Détails de la Commande
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Commande:</span>
                            <span class="font-medium">{{ commande.id_yz }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Client:</span>
                            <span class="font-medium">{{ commande.client.prenom }} {{ commande.client.nom }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Valeur totale:</span>
                            <span class="font-medium">{{ commande.total_cmd|floatformat:2 }} DH</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Articles:</span>
                            <span class="font-medium">{{ commande.paniers.count }} article(s)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">État actuel:</span>
                            <span class="font-medium">{{ commande.etat_actuel.enum_etat.libelle }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Actions SAV -->
                <div class="bg-white p-4 rounded-lg border border-red-200">
                    <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                        <i class="fas fa-cogs mr-2 text-green-600"></i>
                        Actions Disponibles
                    </h4>
                    <div class="space-y-3">
                        <button onclick="ouvrirModalSavDefectueux()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center">
                            <i class="fas fa-box-open mr-2"></i>
                            Créer Commande SAV avec Articles Neufs
                        </button>
                        <p class="text-xs text-gray-600 text-center">
                            <i class="fas fa-star mr-1"></i>
                            Nouveaux articles en parfait état pour améliorer l'expérience client
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Section 4: Historique des États -->
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mb-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-history mr-2"></i>Historique des États
        </h2>
        
        <div class="space-y-4">
            {% for etat in commande.etats.all %}
                <div class="flex items-center p-4 rounded-lg border border-gray-200 bg-gray-50">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center mr-4" 
                         style="background-color: {{ etat.enum_etat.couleur|default:'#6b7280' }};">
                        <i class="fas fa-circle text-white text-xs"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-900">{{ etat.enum_etat.libelle }}</p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-calendar mr-1"></i>
                            Début : {{ etat.date_debut|date:"d/m/Y à H:i" }}
                            {% if etat.date_fin %}
                                - Fin : {{ etat.date_fin|date:"d/m/Y à H:i" }}
                            {% endif %}
                        </p>
                        {% if etat.operateur %}
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-user mr-1"></i>
                                Opérateur : {{ etat.operateur.username }}
                            </p>
                        {% endif %}
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-clock text-4xl mb-2 opacity-50"></i>
                    <p>Aucun historique d'état disponible.</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Section Actions de Modification du Panier Client -->
    {% if commande.etat_actuel.enum_etat.libelle == 'En cours de livraison' %}
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mt-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-undo mr-2"></i>Renvoi en Préparation
        </h2>
        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg border border-purple-200 p-4 mb-4">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-purple-600 mt-1 mr-3"></i>
                <div>
                    <h3 class="font-semibold text-purple-800 mb-2">Cas d'utilisation</h3>
                    <p class="text-sm text-purple-700 mb-2">
                        Utilisez cette fonctionnalité quand le client souhaite modifier sa commande :
                    </p>
                    <ul class="text-sm text-purple-700 list-disc list-inside space-y-1">
                        <li>Ajouter un ou plusieurs articles à sa commande</li>
                        <li>Modifier les quantités d'articles existants</li>
                        <li>Supprimer des articles de sa commande</li>
                        <li>Changer d'articles</li>
                    </ul>
                    <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <strong>Note :</strong> La commande sera renvoyée aux opérateurs de préparation qui effectueront les modifications demandées par le client.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-center">
            <button onclick="openRenvoyerModal()" class="sav-action-btn" style="background-color: #8B5CF6;">
                <i class="fas fa-undo mr-2"></i>Renvoi en Préparation
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Section Actions de Livraison (SAV) -->
    {% if commande.etat_actuel.enum_etat.libelle != 'Retournée' %}
    <div class="bg-white rounded-xl shadow-lg border p-6 md:p-8 mt-6" style="border-color: var(--logistic-border);">
        <h2 class="text-2xl font-bold flex items-center mb-6" style="color: var(--logistic-primary);">
            <i class="fas fa-shipping-fast mr-2"></i>Actions de Livraison (SAV)
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <button onclick="openSavModal('Reportée')" class="sav-action-btn" style="background-color: #F59E0B;">
                <i class="fas fa-clock mr-2"></i>Reporter
            </button>
            <button onclick="openSavModal('Livrée')" class="sav-action-btn" style="background-color: #10B981;">
                <i class="fas fa-check-circle mr-2"></i>Livrée
            </button>
            <button onclick="ouvrirModalLivraisonPartielle()" class="sav-action-btn" style="background-color: #3B82F6;">
                <i class="fas fa-box-open mr-2"></i>Livraison Partielle
            </button>
            <button onclick="openSavModal('Livrée avec changement')" class="sav-action-btn" style="background-color: #8B5CF6;">
                <i class="fas fa-exchange-alt mr-2"></i>Avec Changement
            </button>
            <button onclick="openSavModal('Retournée')" class="sav-action-btn" style="background-color: #EF4444;">
                <i class="fas fa-times-circle mr-2"></i>Retournée
            </button>
        </div>
    </div>
    {% endif %}

    <!-- Modale de Confirmation SAV -->
    <div id="savModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="savModalTitle">Mettre à jour l'état</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="savForm" action="{% url 'operatLogistic:changer_etat_sav' commande.id %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="nouvel_etat" id="nouvel_etat_input">
                        <div class="text-left">
                            <!-- Champ date de report (caché par défaut) -->
                            <div id="dateReportDiv" class="mb-4 hidden">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Date de report de la commande</h3>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <label for="date_report" class="block text-sm font-medium text-gray-700">
                                        Nouvelle date de livraison pour tous les articles
                                    </label>
                                    <input type="date" 
                                           name="date_report" 
                                           id="date_report"
                                           class="w-full mt-2 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
                                           required>
                                    <p class="mt-2 text-sm text-gray-500">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Cette date sera appliquée à tous les articles de la commande
                                    </p>
                                    <!-- Résumé des articles -->
                                    <div class="mt-4 border-t border-gray-200 pt-4">
                                        <p class="text-sm font-medium text-gray-700 mb-2">Articles concernés :</p>
                                        <ul class="space-y-2">
                                        {% for panier in commande.paniers.all %}
                                            <li class="text-sm text-gray-600">
                                                <i class="fas fa-box mr-2"></i>
                                                {{ panier.article.nom }}
                                                {% if panier.article.reference %}
                                                    <span class="text-xs text-gray-500">(Réf: {{ panier.article.reference }})</span>
                                                {% endif %}
                                                <span class="text-xs text-gray-500 ml-2">Quantité: {{ panier.quantite }}</span>
                                            </li>
                                        {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Options d'annulation (cachées par défaut) -->
                            <div id="annulationOptionsDiv" class="mb-4 hidden">
                                <label class="text-sm font-medium text-gray-700 block mb-2">Type d'annulation</label>
                                <div class="space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" id="bonneAnnulation" name="type_annulation" value="bonne" 
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                        <label for="bonneAnnulation" class="ml-2 block text-sm text-gray-700">
                                            Produit en bonne état (réincrémenter le stock)
                                        </label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" id="mauvaiseAnnulation" name="type_annulation" value="mauvaise" 
                                               class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
                                        <label for="mauvaiseAnnulation" class="ml-2 block text-sm text-gray-700">
                                            Produit en mauvaise état
                                        </label>
                                    </div>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">
                                Un Produit en bonne état  réincrementera automatiquement le stock des articles.
                                </p>
                            </div>

                            <label for="commentaire" class="text-sm font-medium text-gray-700">Commentaire (obligatoire)</label>
                            <textarea name="commentaire" id="commentaire" rows="4" class="w-full mt-1 p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmSavBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-300">
                        Confirmer la mise à jour
                    </button>
                    <button id="cancelSavBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de Livraison Partielle -->
    <div id="livraisonPartielleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-box-open mr-3 text-blue-600"></i>
                        Livraison Partielle - Commande {{ commande.id_yz }}
                    </h3>
                    <button onclick="fermerModalLivraisonPartielle()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-lg">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Instructions :</strong> Sélectionnez les articles que vous allez livrer au client. 
                                Les articles non sélectionnés seront automatiquement renvoyés aux opérateurs de préparation 
                                pour traitement (remplacement, correction, etc.).
                            </p>
                        </div>
                    </div>
                </div>

                <form id="livraisonPartielleForm" action="{% url 'operatLogistic:livraison_partielle' commande.id %}" method="POST">
                    {% csrf_token %}
                    
                    <!-- Ces champs seront remplis dynamiquement par JavaScript juste avant la soumission -->
                    <input type="hidden" name="articles_livres_json" id="articlesLivresJsonInput">
                    <input type="hidden" name="articles_renvoyes_json" id="articlesRenvoyesJsonInput">
                    
                    <!-- Section Articles à Livrer -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-green-700 mb-4 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            Articles à Livrer au Client
                        </h4>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="articlesALivrerContainer">
                                {% for panier in commande.paniers.all %}
                                <div class="article-livraison-card bg-white rounded-lg border border-green-300 p-4 hover:border-green-400 transition-colors"
                                     data-panier-id="{{ panier.id }}" 
                                     data-article-id="{{ panier.article.id }}"
                                     data-article-nom="{{ panier.article.nom }}"
                                     data-article-prix="{{ panier.prix_actuel_pour_affichage|stringformat:"%.2f" }}"
                                     data-quantite-max="{{ panier.quantite }}">
                                    <div class="flex items-start space-x-3">
                                        <input type="checkbox" 
                                               id="livrer_{{ panier.id }}" 
                                               class="article-livrer-checkbox h-5 w-5 text-green-600 focus:ring-green-500 border-gray-300 rounded mt-1"
                                               data-panier-id="{{ panier.id }}"
                                               checked>
                                        <div class="flex-1">
                                            <label for="livrer_{{ panier.id }}" class="cursor-pointer">
                                                <div class="font-medium text-gray-900">{{ panier.article.nom }}</div>
                                                <div class="text-sm text-gray-500">
                                                    {% if panier.article.reference %}
                                                        Réf: {{ panier.article.reference }}<br>
                                                    {% endif %}
                                                    {% if panier.article.couleur %}
                                                        Couleur: {{ panier.article.couleur }}<br>
                                                    {% endif %}
                                                    {% if panier.article.pointure %}
                                                        Pointure: {{ panier.article.pointure }}<br>
                                                    {% endif %}
                                                    Prix: {{ panier.prix_actuel_pour_affichage|stringformat:"%.2f" }} DH
                                                </div>
                                            </label>
                                            <div class="mt-3">
                                                <label class="block text-xs font-medium text-gray-700 mb-1">
                                                    Quantité à livrer:
                                                </label>
                                                <input type="number" 
                                                       min="1" 
                                                       max="{{ panier.quantite }}" 
                                                       value="{{ panier.quantite }}"
                                                       class="quantite-livrer-input w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                                       data-panier-id="{{ panier.id }}">
                                                <div class="text-xs text-gray-500 mt-1">
                                                    Max: {{ panier.quantite }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Section Articles à Renvoyer -->
                    <div class="mb-8">
                        <h4 class="text-lg font-semibold text-orange-700 mb-4 flex items-center">
                            <i class="fas fa-undo mr-2"></i>
                            Articles à Renvoyer en Préparation
                        </h4>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="articlesARenvoyerContainer">
                                <!-- Les articles non sélectionnés apparaîtront ici dynamiquement -->
                                <!-- Pour chaque article à renvoyer, on ajoute un champ select pour l'état -->
                            </div>
                            <div id="aucunArticleRenvoyer" class="text-center py-8 text-gray-500">
                                <i class="fas fa-info-circle text-2xl mb-2"></i>
                                <p>Aucun article à renvoyer. Tous les articles seront livrés.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Résumé -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>
                            Résumé de la Livraison Partielle
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="totalArticlesLivres">0</div>
                                <div class="text-sm text-gray-600">Articles à livrer</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600" id="totalArticlesRenvoyes">0</div>
                                <div class="text-sm text-gray-600">Articles à renvoyer</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="totalValeurLivree">0.00 DH</div>
                                <div class="text-sm text-gray-600">Valeur livrée</div>
                            </div>
                        </div>
                    </div>

                    <!-- Commentaire -->
                    <div class="mb-6">
                        <label for="commentaireLivraisonPartielle" class="block text-sm font-medium text-gray-700 mb-2">
                            Commentaire sur la livraison partielle (obligatoire)
                        </label>
                        <textarea name="commentaire" 
                                  id="commentaireLivraisonPartielle" 
                                  rows="4" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Expliquez pourquoi certains articles ne peuvent pas être livrés (défaut, indisponibilité, changement demandé, etc.)"
                                  required></textarea>
                    </div>

                    <!-- Boutons d'action -->
                    <div class="flex justify-end space-x-4">
                        <button type="button" 
                                onclick="fermerModalLivraisonPartielle()" 
                                class="px-6 py-2 bg-gray-500 text-white font-medium rounded-lg hover:bg-gray-600 transition-colors">
                            Annuler
                        </button>
                        <button type="submit" 
                                id="confirmerLivraisonPartielleBtn"
                                class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-check mr-2"></i>
                            Confirmer la Livraison Partielle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal d'ajout/modification d'articles -->
    <div id="addArticleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900" id="articleModalTitle">Ajouter un article</h3>
                <div class="mt-2 px-7 py-3">
                    <form id="articleForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Sélection d'article -->
                            <div id="article-selection-field">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                
                                <!-- Légende des badges -->
                                <div class="mb-3 p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200 shadow-sm">
                                    <div class="text-xs font-semibold text-gray-700 mb-2 flex items-center">
                                        <i class="fas fa-info-circle mr-1 text-blue-500"></i>
                                        Légende des types d'articles :
                                    </div>
                                    <div class="flex flex-wrap gap-2 mb-2">
                                        <span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium cursor-pointer hover:bg-blue-200" 
                                              onclick="filtrerArticles('all')" id="filter-all">
                                            <i class="fas fa-search mr-1"></i>TOUS <span class="ml-1 bg-blue-200 px-1 rounded" id="count-all">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium cursor-pointer hover:bg-red-200" 
                                              onclick="filtrerArticles('promo')" id="filter-promo">
                                            <i class="fas fa-fire mr-1"></i>PROMO <span class="ml-1 bg-red-200 px-1 rounded" id="count-promo">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-medium cursor-pointer hover:bg-orange-200" 
                                              onclick="filtrerArticles('liquidation')" id="filter-liquidation">
                                            <i class="fas fa-tags mr-1"></i>LIQUIDATION <span class="ml-1 bg-orange-200 px-1 rounded" id="count-liquidation">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium cursor-pointer hover:bg-purple-200" 
                                              onclick="filtrerArticles('test')" id="filter-test">
                                            <i class="fas fa-flask mr-1"></i>TEST <span class="ml-1 bg-purple-200 px-1 rounded" id="count-test">0</span>
                                        </span>
                                        <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium cursor-pointer hover:bg-green-200" 
                                              onclick="filtrerArticles('upsell')" id="filter-upsell">
                                            <i class="fas fa-arrow-up mr-1"></i>UPSELL <span class="ml-1 bg-green-200 px-1 rounded" id="count-upsell">0</span>
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2 italic">
                                        💡 Les articles sont colorés dans la liste selon leur type pour faciliter l'identification<br>
                                        ⌨️ Raccourcis: Alt+1 (Tous), Alt+2 (Promo), Alt+3 (Liquidation), Alt+4 (Test), Alt+5 (Upsell)
                                    </div>
                                </div>
                                
                                <select id="articleSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Sélectionner un article --</option>
                                </select>
                            </div>
                            
                            <!-- Affichage du nom d'article (pour modifications) -->
                            <div id="article-display-field" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                                <input type="text" id="articleDisplay" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                            </div>
                            
                            <!-- Quantité -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Quantité</label>
                                <input type="number" id="quantiteInput" min="1" step="1" value="1" 
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <!-- Informations de l'article sélectionné -->
                        <div id="article-info" class="hidden mt-4">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                                    <i class="fas fa-info-circle mr-2"></i>Détails de l'article
                                </h4>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                                        <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-tag mr-2 text-blue-600"></i>Informations produit
                                        </h5>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Référence :</span>
                                                <span id="info-reference" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Prix actuel :</span>
                                                <span id="info-prix" class="font-bold text-green-600"></span>
                                            </div>
                                            <div class="flex justify-between border-t pt-2">
                                                <span class="text-gray-700 font-medium">Sous-total :</span>
                                                <span id="info-sous-total" class="font-bold text-blue-600 text-lg"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                                        <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-boxes mr-2 text-green-600"></i>Détails techniques
                                        </h5>
                                        <div class="space-y-2">
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Taille :</span>
                                                <span id="info-pointure" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Couleur :</span>
                                                <span id="info-couleur" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Catégorie :</span>
                                                <span id="info-categorie" class="font-medium text-gray-800"></span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-gray-600">Stock :</span>
                                                <span id="info-stock" class="font-medium text-green-600"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmerArticleBtn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300">
                        Confirmer
                    </button>
                    <button id="annulerArticleBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de Renvoi en Préparation -->
    <div id="renvoyerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4 flex items-center justify-center">
                    <i class="fas fa-undo mr-2 text-purple-600"></i>
                    Renvoi en Préparation
                </h3>
                <div class="mt-2 px-7 py-3">
                    <form id="renvoyerForm" action="{% url 'operatLogistic:renvoyer_preparation' commande.id %}" method="POST">
                        {% csrf_token %}
                        
                        <!-- Informations de la commande -->
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 mb-4">
                            <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                Détails de la commande
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-purple-600">ID:</span>
                                    <span class="font-medium ml-2">{{ commande.id_yz }}</span>
                                </div>
                                <div>
                                    <span class="text-purple-600">Client:</span>
                                    <span class="font-medium ml-2">{{ commande.client.prenom }} {{ commande.client.nom }}</span>
                                </div>
                                <div>
                                    <span class="text-purple-600">Articles:</span>
                                    <span class="font-medium ml-2">{{ commande.paniers.count }} article(s)</span>
                                </div>
                                <div>
                                    <span class="text-purple-600">Total:</span>
                                    <span class="font-medium ml-2">{{ commande.total_cmd|floatformat:2 }} DH</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Liste des articles actuels -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-box mr-2"></i>
                                Articles actuels de la commande
                            </h4>
                            <div class="max-h-40 overflow-y-auto">
                                <ul class="space-y-2">
                                {% for panier in commande.paniers.all %}
                                    <li class="text-sm text-gray-700 flex items-center justify-between">
                                        <div class="flex items-center">
                                            <i class="fas fa-circle text-gray-400 mr-2 text-xs"></i>
                                            <span class="font-medium">{{ panier.article.nom }}</span>
                                            {% if panier.article.reference %}
                                                <span class="text-gray-500 ml-1">({{ panier.article.reference }})</span>
                                            {% endif %}
                                        </div>
                                        <span class="text-gray-600">x{{ panier.quantite }}</span>
                                    </li>
                                {% endfor %}
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Motif du renvoi -->
                        <div class="text-left">
                            <label for="commentaire_renvoi" class="text-sm font-medium text-gray-700 block mb-2">
                                Demande de modification du client <span class="text-red-500">*</span>
                            </label>
                            <textarea 
                                name="commentaire" 
                                id="commentaire_renvoi" 
                                rows="4" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                                placeholder="Décrivez les modifications demandées par le client (ex: client veut ajouter un article, modifier les quantités, supprimer un article, etc.)"
                                required></textarea>
                            <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <p class="text-sm text-blue-700">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <strong>Processus :</strong> La commande sera renvoyée aux opérateurs de préparation qui effectueront les modifications demandées par le client, puis la commande sera remise en livraison.
                                </p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="confirmRenvoyerBtn" class="px-4 py-2 bg-purple-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-300">
                        <i class="fas fa-undo mr-2"></i>Confirmer le Renvoi
                    </button>
                    <button id="cancelRenvoyerBtn" class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-300 mt-2">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale SAV - Création de Commande pour Articles Défectueux -->
    <div id="savDefectueuxModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-box-open mr-2 text-green-600"></i>
                    Créer une Commande SAV avec Articles Neufs
                </h3>
                <div class="px-7 py-3">
                    <form id="savDefectueuxForm" action="{% url 'operatLogistic:creer_commande_sav' commande.id %}" method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="articles_defectueux" id="articlesDefectueuxSav" value="[]">
                        
                        <!-- Informations de la commande originale -->
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                            <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                                <i class="fas fa-info-circle mr-2"></i>
                                Commande Originale avec Articles Défectueux
                            </h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="text-blue-600">ID:</span>
                                    <span class="font-medium ml-2">{{ commande.id_yz }}</span>
                                </div>
                                <div>
                                    <span class="text-blue-600">Client:</span>
                                    <span class="font-medium ml-2">{{ commande.client.prenom }} {{ commande.client.nom }}</span>
                                </div>
                                <div>
                                    <span class="text-blue-600">Ville:</span>
                                    <span class="font-medium ml-2">{{ commande.ville.nom }}</span>
                                </div>
                                <div>
                                    <span class="text-blue-600">Total:</span>
                                    <span class="font-medium ml-2">{{ commande.total_cmd|floatformat:2 }} DH</span>
                                </div>
                            </div>
                            <div class="mt-3 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                <strong>Problème détecté :</strong> Articles défectueux signalés par le client
                            </div>
                        </div>

                        <!-- Sélection des articles pour la nouvelle commande -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-star mr-2 text-green-600"></i>
                                Articles Neufs pour la Commande SAV
                            </h4>
                            <p class="text-sm text-gray-600 mb-4">
                                Sélectionnez les articles défectueux qui seront remplacés par des articles neufs en parfait état pour améliorer l'expérience client.
                            </p>
                            
                            <div id="articlesDefectueuxContainer" class="space-y-3 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-4">
                                {% for panier in commande.paniers.all %}
                                <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <input type="checkbox" 
                                           id="defectueux_{{ panier.article.id }}" 
                                           class="article-defectueux-checkbox h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"
                                           data-id="{{ panier.article.id }}" 
                                           data-max="{{ panier.quantite }}"
                                           data-nom="{{ panier.article.nom }}"
                                           data-prix="{{ panier.article.prix_unitaire }}"
                                           checked>
                                    <label for="defectueux_{{ panier.article.id }}" class="flex-1 text-sm">
                                        <div class="font-medium text-gray-900">{{ panier.article.nom }}</div>
                                        <div class="text-gray-500">
                                            {% if panier.article.reference %}
                                                Réf: {{ panier.article.reference }} | 
                                            {% endif %}
                                            Quantité: {{ panier.quantite }} | 
                                            Prix: {{ panier.article.prix_unitaire|floatformat:2 }} DH
                                        </div>
                                    </label>
                                    <input type="number" 
                                           min="1" 
                                           max="{{ panier.quantite }}" 
                                           value="{{ panier.quantite }}" 
                                           class="quantite-defectueux-input w-20 border-gray-300 rounded text-sm p-1" 
                                           data-id="{{ panier.article.id }}">
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Commentaire -->
                        <div class="mb-6">
                            <label for="commentaireSav" class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-comment mr-2 text-gray-600"></i>
                                Commentaire sur les articles neufs
                            </label>
                            <textarea name="commentaire" 
                                      id="commentaireSav" 
                                      rows="4" 
                                      class="w-full border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 sm:text-sm" 
                                      placeholder="Décrivez les défauts constatés et les améliorations apportées avec les articles neufs..."></textarea>
                        </div>

                        <!-- Résumé de la commande SAV -->
                        <div id="resumeSavCommande" class="bg-green-50 p-4 rounded-lg border border-green-200 mb-6">
                            <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                                <i class="fas fa-calculator mr-2"></i>
                                Résumé de la Commande SAV avec Articles Neufs
                            </h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-green-600">Articles neufs sélectionnés:</span>
                                    <span id="nbArticlesSav" class="font-medium">{{ commande.paniers.count }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-600">Total estimé:</span>
                                    <span id="totalSavCommande" class="font-bold text-lg">{{ commande.total_cmd|floatformat:2 }} DH</span>
                                </div>
                                <div class="mt-3 p-2 bg-green-50 border border-green-200 rounded text-xs text-green-700">
                                    <i class="fas fa-star mr-1"></i>
                                    <strong>Amélioration de l'expérience client :</strong> Tous les articles seront neufs et en parfait état
                                </div>
                                <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-700">
                                    <i class="fas fa-tools mr-1"></i>
                                    <strong>Service après-vente premium :</strong> Remplacement complet par des articles neufs pour garantir la satisfaction client
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" 
                            form="savDefectueuxForm"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-star mr-2"></i>
                        Créer Commande SAV avec Articles Neufs
                    </button>
                    <button type="button" 
                            onclick="fermerModalSavDefectueux()" 
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Annuler
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale de confirmation livraison partielle -->
    <div id="confirmationLivraisonPartielleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-32 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-check-circle text-green-500 text-4xl mr-2"></i>
                    <span class="text-2xl font-bold text-green-700">Livraison partielle réussie !</span>
                </div>
                <div class="mb-4">
                    <div class="text-lg text-gray-800 mb-2" id="confirmation-livraison-details"></div>
                </div>
                <button id="fermerConfirmationLivraisonBtn" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors mt-2">
                    OK
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Variables globales pour les articles
let articlesDisponibles = [];
let currentArticleId = null;
let isEditingArticle = false;
let compteurCommande = {{ commande.compteur }};
let filtreActuel = 'all'; // Filtre actuellement actif
let commandeId = {{ commande.id }};

// Fonction pour calculer le prix upsell selon le compteur
function getPrixUpsell(article, compteur) {
    // Utiliser le compteur de la commande pour déterminer le prix
    const prixUnitaire = article.prix_actuel || article.prix_unitaire;
    
    if (compteur === 0) {
        // Pas d'upsell actif
        return prixUnitaire;
    } else if (compteur === 1 && article.prix_upsell_1) {
        // Niveau 1 d'upsell
        return parseFloat(article.prix_upsell_1);
    } else if (compteur === 2 && article.prix_upsell_2) {
        // Niveau 2 d'upsell
        return parseFloat(article.prix_upsell_2);
    } else if (compteur === 3 && article.prix_upsell_3) {
        // Niveau 3 d'upsell
        return parseFloat(article.prix_upsell_3);
    } else if (compteur >= 4 && article.prix_upsell_4) {
        // Niveau 4 d'upsell (pour compteur >= 4)
        return parseFloat(article.prix_upsell_4);
    }
    
    // Si pas de prix upsell défini pour ce niveau, utiliser le prix unitaire
    return prixUnitaire;
}

// ================== GESTION DU SAV ==================

function openSavModal(etat) {
    document.getElementById('nouvel_etat_input').value = etat;
    
    // Titre et couleur selon l'état
    let titre = '';
    let couleur = '';
    let icone = '';
    
    switch(etat) {
        case 'Reportée':
            titre = 'Reporter la Livraison';
            couleur = 'text-yellow-600';
            icone = 'fa-clock';
            break;
        case 'Livrée':
            titre = 'Marquer comme Livrée';
            couleur = 'text-green-600';
            icone = 'fa-check-circle';
            break;
        case 'Livrée avec changement':
            titre = 'Livrée avec Changement';
            couleur = 'text-purple-600';
            icone = 'fa-exchange-alt';
            break;
        case 'Retournée':
            titre = 'Retourner la Commande';
            couleur = 'text-red-600';
            icone = 'fa-times-circle';
            break;
        default:
            titre = `Mettre à jour vers ${etat}`;
            couleur = 'text-blue-600';
            icone = 'fa-edit';
    }
    
    document.getElementById('savModalTitle').innerHTML = `<i class="fas ${icone} mr-2 ${couleur}"></i>${titre}`;
    
    // Afficher/masquer les sections selon l'état
    const dateReportDiv = document.getElementById('dateReportDiv');
    const annulationOptionsDiv = document.getElementById('annulationOptionsDiv');
    
    // Masquer tous les champs spéciaux d'abord
    dateReportDiv.classList.add('hidden');
    annulationOptionsDiv.classList.add('hidden');
    
    // Afficher les champs appropriés selon l'état
    if (etat === 'Reportée') {
        dateReportDiv.classList.remove('hidden');
        // Définir la date minimale à aujourd'hui
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date_report').min = today;
        document.getElementById('date_report').required = true;
        document.getElementById('date_report').value = '';
    } else if (etat === 'Retournée') {
        annulationOptionsDiv.classList.remove('hidden');
        // Réinitialiser la sélection
        document.querySelectorAll('input[name="type_annulation"]').forEach(radio => radio.checked = false);
    }
    
    // Réinitialiser le formulaire
    document.getElementById('commentaire').value = '';
    document.getElementById('savModal').classList.remove('hidden');
}

// ================== GESTION DES ARTICLES ==================

function ajouterNouvelArticle() {
    isEditingArticle = false;
    currentArticleId = null;
    
        // Réinitialiser le formulaire
    document.getElementById('articleForm').reset();
    document.getElementById('articleModalTitle').textContent = 'Ajouter un article';
    document.getElementById('confirmerArticleBtn').textContent = 'Ajouter';
    
    // Afficher le champ de sélection d'article
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Masquer les informations de l'article
    document.getElementById('article-info').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticles();
    
    // Afficher la modale
    document.getElementById('addArticleModal').classList.remove('hidden');
}

function modifierArticle(panierId) {
    isEditingArticle = true;
    currentArticleId = panierId;
    
    // Trouver l'article correspondant dans le DOM
    const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
    if (!articleCard) {
        showNotification('Article non trouvé', 'error');
        return;
    }
    
    const articleData = JSON.parse(articleCard.dataset.article);
    const quantiteActuelle = articleCard.querySelector('.text-blue-600').textContent.match(/\d+/)[0];
    
    // Remplir le formulaire avec les données actuelles
    document.getElementById('articleModalTitle').textContent = 'Modifier l\'article';
    document.getElementById('confirmerArticleBtn').textContent = 'Modifier';
    document.getElementById('quantiteInput').value = quantiteActuelle;
    
    // Afficher le champ de nom d'article (lecture seule)
    document.getElementById('article-selection-field').classList.add('hidden');
    document.getElementById('article-display-field').classList.remove('hidden');
    document.getElementById('articleDisplay').value = articleData.nom;
    
    // Afficher les informations de l'article
    afficherInfosArticle(articleData);
    
    // Afficher la modale
    document.getElementById('addArticleModal').classList.remove('hidden');
}

function supprimerArticle(panierId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Récupérer les informations de l'article avant suppression de manière sécurisée
        const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
        if (!articleCard) {
            showNotification('❌ Article non trouvé dans l\'interface', 'error');
            return;
        }
        
        let articleData = null;
        let quantiteActuelle = 0;
        
        try {
            const articleDataString = articleCard.dataset.article;
            articleData = JSON.parse(articleDataString);
            
            const quantiteElement = articleCard.querySelector('.text-blue-600');
            if (quantiteElement) {
                const match = quantiteElement.textContent.match(/\d+/);
                quantiteActuelle = match ? parseInt(match[0]) : 0;
            }
        } catch (jsonError) {
            console.error('Erreur de parsing JSON:', jsonError);
            console.log('Données brutes:', articleCard.dataset.article);
            showNotification('❌ Erreur de données article', 'error');
            return;
        }
        
        fetch(`/operateur-logistique/commande/{{ commande.id }}/supprimer-article/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'panier_id': panierId
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Afficher une notification adaptée selon le statut de la commande
                if (isCommandeConfirmee()) {
                    showStockNotification('suppression', articleData.nom, quantiteActuelle, true);
                } else {
                    showNotification('✅ Article supprimé avec succès', 'success');
                }
                
                rafraichirSectionArticles();
            } else {
                showNotification('❌ Erreur: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('❌ Erreur de réseau: ' + error.message, 'error');
        });
    }
}

function modifierQuantite(panierId, quantiteActuelle) {
    const nouvelleQuantite = prompt('Nouvelle quantité:', quantiteActuelle);
    
    if (nouvelleQuantite !== null && nouvelleQuantite !== '' && parseInt(nouvelleQuantite) > 0) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Récupérer les informations de l'article de manière sécurisée
        const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
        if (!articleCard) {
            showNotification('❌ Article non trouvé dans l\'interface', 'error');
            return;
        }
        
        let articleData = null;
        try {
            const articleDataString = articleCard.dataset.article;
            articleData = JSON.parse(articleDataString);
        } catch (jsonError) {
            console.error('Erreur de parsing JSON:', jsonError);
            console.log('Données brutes:', articleCard.dataset.article);
            showNotification('❌ Erreur de données article', 'error');
            return;
        }
        
        fetch(`/operateur-logistique/commande/{{ commande.id }}/modifier-quantite/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'panier_id': panierId,
                'quantite': nouvelleQuantite
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Afficher une notification adaptée selon le statut de la commande
                if (isCommandeConfirmee()) {
                    const difference = parseInt(nouvelleQuantite) - parseInt(quantiteActuelle);
                    showStockNotification('modification', articleData.nom, nouvelleQuantite, difference);
                } else {
                    showNotification('✅ Quantité modifiée avec succès', 'success');
                }
                
                rafraichirSectionArticles();
            } else {
                // Vérifier si c'est une erreur de stock
                if (data.error && data.error.includes('Stock insuffisant')) {
                    const difference = parseInt(nouvelleQuantite) - parseInt(quantiteActuelle);
                    showStockNotification('stock_insuffisant', articleData.nom, Math.abs(difference));
                } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                }
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('❌ Erreur de réseau: ' + error.message, 'error');
        });
    }
}

function chargerArticles() {
    // Afficher un indicateur de chargement
    const select = document.getElementById('articleSelect');
    if (select) {
        select.innerHTML = '<option value="">Chargement des articles...</option>';
    }
    
    fetch(`/operateur-logistique/api/articles/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                articlesDisponibles = data.articles || [];
            remplirSelectArticles();
            } else {
                throw new Error(data.error || 'Erreur lors du chargement des articles');
            }
        })
        .catch(error => {
            console.error('Erreur lors du chargement des articles:', error);
            showNotification('❌ Erreur lors du chargement des articles: ' + error.message, 'error');
            
            // Réinitialiser le select en cas d'erreur
            if (select) {
                select.innerHTML = '<option value="">Erreur de chargement</option>';
            }
        });
}

function remplirSelectArticles() {
    const select = document.getElementById('articleSelect');
    select.innerHTML = '<option value="">-- Sélectionner un article --</option>';
    
    // Compter les articles par type
    const counts = {
        all: 0,
        promo: 0,
        liquidation: 0,
        test: 0,
        upsell: 0
    };
    
    let articlesAffiches = 0;
    
    articlesDisponibles.forEach(article => {
        // Compter tous les articles
        counts.all++;
        
        // Compter par type
        if (article.has_promo_active || article.phase === 'PROMO') counts.promo++;
        if (article.phase === 'LIQUIDATION') counts.liquidation++;
        if (article.phase === 'EN_TEST') counts.test++;
        if (article.isUpsell) counts.upsell++;
        
        // Appliquer le filtre
        let afficher = false;
        switch (filtreActuel) {
            case 'all':
                afficher = true;
                break;
            case 'promo':
                afficher = article.has_promo_active || article.phase === 'PROMO';
                break;
            case 'liquidation':
                afficher = article.phase === 'LIQUIDATION';
                break;
            case 'test':
                afficher = article.phase === 'EN_TEST';
                break;
            case 'upsell':
                afficher = article.isUpsell;
                break;
        }
        
        if (afficher) {
            const option = document.createElement('option');
            option.value = article.id;
            
            // Construire le texte de l'option
            let optionText = article.nom || 'Article sans nom';
            
            // Ajouter les badges de statut
            const badges = [];
            if (article.has_promo_active || article.phase === 'PROMO') badges.push('🔥PROMO');
            if (article.phase === 'LIQUIDATION') badges.push('🏷️LIQUIDATION');
            if (article.phase === 'EN_TEST') badges.push('🧪TEST');
            if (article.isUpsell) badges.push('⬆️UPSELL');
            
            if (badges.length > 0) {
                optionText += ` [${badges.join(' ')}]`;
            }
            
            // Utiliser getPrixUpsell pour calculer le prix à afficher
            const prixAffiche = getPrixUpsell(article, compteurCommande);
            if (prixAffiche > 0) {
                optionText += ` - ${prixAffiche.toFixed(2)} DH`;
            }
            
            // Ajouter détails
            const details = [];
            if (article.pointure && article.pointure.trim()) {
                details.push(`T:${article.pointure}`);
            }
            if (article.couleur && article.couleur.trim()) {
                details.push(`C:${article.couleur}`);
            }
            
            if (details.length > 0) {
                optionText += ` (${details.join(', ')})`;
            }
            
            option.textContent = optionText;
            option.dataset.article = JSON.stringify(article);
            
            // Appliquer le style selon le type
            appliquerStyleOption(option, article);
            
            select.appendChild(option);
            articlesAffiches++;
        }
    });
    
    // Mettre à jour les compteurs
    document.getElementById('count-all').textContent = counts.all;
    document.getElementById('count-promo').textContent = counts.promo;
    document.getElementById('count-liquidation').textContent = counts.liquidation;
    document.getElementById('count-test').textContent = counts.test;
    document.getElementById('count-upsell').textContent = counts.upsell;
    
    // Mettre à jour l'apparence des filtres
    mettreAJourFiltres();
}

function appliquerStyleOption(option, article) {
    // Couleurs selon le type d'article
    if (article.has_promo_active || article.phase === 'PROMO') {
        option.style.backgroundColor = '#fee2e2';
        option.style.color = '#dc2626';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'LIQUIDATION') {
        option.style.backgroundColor = '#fed7aa';
        option.style.color = '#ea580c';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'EN_TEST') {
        option.style.backgroundColor = '#e9d5ff';
        option.style.color = '#9333ea';
        option.style.fontWeight = 'bold';
    } else if (article.isUpsell) {
        option.style.backgroundColor = '#dcfce7';
        option.style.color = '#16a34a';
        option.style.fontWeight = 'bold';
    } else {
        option.style.backgroundColor = '#f8fafc';
        option.style.color = '#374151';
    }
}

function filtrerArticles(type) {
    filtreActuel = type;
    remplirSelectArticles();
}

function mettreAJourFiltres() {
    // Réinitialiser tous les filtres
    document.querySelectorAll('[id^="filter-"]').forEach(filter => {
        filter.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-200');
        filter.classList.add('hover:bg-blue-200');
    });
    
    // Mettre en évidence le filtre actuel
    const filtreActif = document.getElementById(`filter-${filtreActuel}`);
    if (filtreActif) {
        filtreActif.classList.add('ring-2', 'ring-blue-500', 'bg-blue-200');
        filtreActif.classList.remove('hover:bg-blue-200');
    }
}

function afficherInfosArticle(article) {
    const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
    const prixActuel = getPrixUpsell(article, compteurCommande);
    const sousTotal = (prixActuel * quantite).toFixed(2);
    
    // Informations de base
    document.getElementById('info-reference').textContent = article.reference || '-';
    document.getElementById('info-prix').textContent = `${prixActuel.toFixed(2)} DH`;
    document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    
    // Informations détaillées
    document.getElementById('info-pointure').textContent = article.pointure || 'Non spécifiée';
    document.getElementById('info-couleur').textContent = article.couleur || 'Non spécifiée';
    document.getElementById('info-categorie').textContent = article.categorie || 'Non spécifiée';
    document.getElementById('info-stock').textContent = `${article.qte_disponible || 0} unité(s)`;
    
    // Afficher la section des informations
    document.getElementById('article-info').classList.remove('hidden');
}

function rafraichirSectionArticles() {
    const container = document.getElementById('articles-container');
    container.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Chargement des articles...</p></div>';

    fetch(`/operateur-logistique/commande/{{ commande.id }}/rafraichir-articles/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                container.innerHTML = data.html;
                
                // Mettre à jour le compteur d'articles
                document.getElementById('articles-count').textContent = data.count;
                document.getElementById('articles-plural').textContent = data.count > 1 ? 's' : '';
                
                // Mettre à jour le total
                document.getElementById('total-commande').textContent = `${parseFloat(data.total).toFixed(2)} DH`;
                
                // Mettre à jour le compteur upsell global
                if (data.compteur !== undefined) {
                    compteurCommande = data.compteur;
                    console.log(`🎯 Compteur upsell mis à jour: ${compteurCommande}`);
                    
                    // Mettre à jour l'affichage du compteur dans l'interface
                    const compteurSpan = document.querySelector('.bg-orange-100');
                    if (compteurSpan) {
                        if (data.compteur > 0) {
                            compteurSpan.style.display = 'inline-flex';
                            if (data.compteur == 1) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 1';
                            } else if (data.compteur == 2) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 2';
                            } else if (data.compteur == 3) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 3';
                            } else if (data.compteur >= 4) {
                                compteurSpan.innerHTML = '<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau 4+';
                            }
                        } else {
                            compteurSpan.style.display = 'none';
                        }
                    }
                }
            } else {
                container.innerHTML = '<div class="text-center p-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Erreur lors du chargement des articles</p></div>';
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            container.innerHTML = '<div class="text-center p-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl mb-2"></i><p>Erreur de réseau</p></div>';
        });
}

function showNotification(message, type = 'info') {
    // Créer et afficher une notification toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-500 text-white' : 
        type === 'error' ? 'bg-red-500 text-white' : 
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    
    // Permettre les retours à la ligne
    toast.style.whiteSpace = 'pre-line';
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Supprimer automatiquement après 3 secondes (plus long pour les avertissements)
    const duration = type === 'warning' ? 7000 : 3000;
    setTimeout(() => {
        toast.remove();
    }, duration);
}

function showStockNotification(action, articleName, quantite, stockChange = null) {
    let message = '';
    let type = 'info';
    
    switch(action) {
        case 'ajout':
            message = `✅ Article ajouté: ${articleName}`;
            if (stockChange) {
                message += `\n📦 Stock décrémenté: -${quantite} unités`;
            }
            type = 'success';
            break;
        case 'suppression':
            message = `🗑️ Article supprimé: ${articleName}`;
            if (stockChange) {
                message += `\n📦 Stock incrémenté: +${quantite} unités`;
            }
            type = 'success';
            break;
        case 'modification':
            message = `📝 Quantité modifiée: ${articleName}`;
            if (stockChange && stockChange > 0) {
                message += `\n📦 Stock décrémenté: -${stockChange} unités`;
            } else if (stockChange && stockChange < 0) {
                message += `\n📦 Stock incrémenté: +${Math.abs(stockChange)} unités`;
            }
            type = 'success';
            break;
        case 'stock_insuffisant':
            message = `❌ Stock insuffisant pour ${articleName}`;
            if (quantite) {
                message += `\nStock demandé: ${quantite} unités`;
            }
            type = 'error';
            break;
        default:
            message = `Action effectuée: ${articleName}`;
    }
    
    showNotification(message, type);
}

function isCommandeConfirmee() {
    // Utiliser la variable définie côté serveur
    return {{ commande_confirmee|yesno:"true,false" }};
}

// ================== GESTIONNAIRES D'ÉVÉNEMENTS ==================

document.addEventListener('DOMContentLoaded', function() {
    // Vérifier s'il y a un paramètre d'action dans l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const actionParam = urlParams.get('action');
    
    if (actionParam) {
        // Ouvrir automatiquement la modale appropriée selon l'action
        switch(actionParam) {
            case 'Reportée':
            case 'Livrée':
            case 'Livrée avec changement':
            case 'Retournée':
                openSavModal(actionParam);
                break;
            case 'Livrée Partiellement':
                ouvrirModalLivraisonPartielle();
                break;
            case 'Annulée (SAV)':
                openSavModal(actionParam);
                break;
        }
        
        // Nettoyer l'URL en supprimant le paramètre
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
    
    // Gestionnaires pour le modal SAV
    const savModal = document.getElementById('savModal');
    const cancelSavBtn = document.getElementById('cancelSavBtn');
    const confirmSavBtn = document.getElementById('confirmSavBtn');
    const savForm = document.getElementById('savForm');

    if (cancelSavBtn) {
        cancelSavBtn.addEventListener('click', function() {
            savModal.classList.add('hidden');
            savForm.reset();
        });
    }

    if (confirmSavBtn) {
        confirmSavBtn.addEventListener('click', function() {
            // Validation du formulaire SAV
        const commentaire = document.getElementById('commentaire').value.trim();
        if (commentaire === '') {
                showNotification('⚠️ Le commentaire est obligatoire', 'warning');
            return;
        }

        const etat = document.getElementById('nouvel_etat_input').value;
        if (etat === 'Reportée') {
            const dateReportInput = document.getElementById('date_report');
            if (!dateReportInput.value) {
                    showNotification('⚠️ Veuillez sélectionner une date de report', 'warning');
                return;
            }
        }
        
        if (etat === 'Retournée') {
            const typeAnnulation = document.querySelector('input[name="type_annulation"]:checked');
            if (!typeAnnulation) {
                    showNotification('⚠️ Veuillez sélectionner le type d\'annulation', 'warning');
                return;
            }
        }
        
            // Désactiver le bouton pour éviter les doubles soumissions
            const submitBtn = this;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement...';
            
            // Soumettre le formulaire via AJAX
            fetch(savForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(new FormData(savForm))
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification(`✅ ${data.message}`, 'success');
                    // Fermer la modale
                    document.getElementById('savModal').classList.add('hidden');
                    // Recharger la page pour afficher les changements
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                    // Réactiver le bouton
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Confirmer la mise à jour';
            }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                // Réactiver le bouton
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Confirmer la mise à jour';
            });
        });
    }

    // Gestionnaires pour le modal d'articles
    const articleModal = document.getElementById('addArticleModal');
    const annulerArticleBtn = document.getElementById('annulerArticleBtn');
    const confirmerArticleBtn = document.getElementById('confirmerArticleBtn');
    const articleSelect = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');

    if (annulerArticleBtn) {
        annulerArticleBtn.addEventListener('click', function() {
            articleModal.classList.add('hidden');
            document.getElementById('articleForm').reset();
            document.getElementById('article-info').classList.add('hidden');
        });
    }

    if (confirmerArticleBtn) {
        confirmerArticleBtn.addEventListener('click', function() {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            if (isEditingArticle) {
                // Modifier l'article
                const quantite = parseInt(quantiteInput.value);
                if (!quantite || quantite <= 0) {
                    alert('Veuillez saisir une quantité valide.');
                    return;
                }
                
                fetch(`/operateur-logistique/commande/{{ commande.id }}/modifier-quantite/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'panier_id': currentArticleId,
                        'quantite': quantite
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Afficher une notification adaptée selon le statut de la commande
                        const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
                        
                        if (articleCard) {
                            try {
                                const articleData = JSON.parse(articleCard.dataset.article);
                                
                                if (isCommandeConfirmee()) {
                                    const quantiteElement = articleCard.querySelector('.text-blue-600');
                                    let quantiteActuelle = 0;
                                    if (quantiteElement) {
                                        const match = quantiteElement.textContent.match(/\d+/);
                                        quantiteActuelle = match ? parseInt(match[0]) : 0;
                                    }
                                    
                                    const difference = quantite - quantiteActuelle;
                                    showStockNotification('modification', articleData.nom, quantite, difference);
                                } else {
                                    showNotification('✅ Article modifié avec succès', 'success');
                                }
                            } catch (jsonError) {
                                console.error('Erreur de parsing JSON:', jsonError);
                                showNotification('✅ Article modifié avec succès', 'success');
                            }
                        } else {
                            showNotification('✅ Article modifié avec succès', 'success');
                        }
                        
                        rafraichirSectionArticles();
                        articleModal.classList.add('hidden');
                    } else {
                        // Vérifier si c'est une erreur de stock
                        if (data.error && data.error.includes('Stock insuffisant')) {
                            const articleCard = document.querySelector(`[data-article-id="${currentArticleId}"]`);
                            
                            if (articleCard) {
                                try {
                                    const articleData = JSON.parse(articleCard.dataset.article);
                                    showStockNotification('stock_insuffisant', articleData.nom, quantite);
                                } catch (jsonError) {
                                    showNotification('❌ Stock insuffisant', 'error');
                                }
                            } else {
                                showNotification('❌ Stock insuffisant', 'error');
                            }
                        } else {
                            showNotification('❌ Erreur: ' + data.error, 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                });
            } else {
                // Ajouter un nouvel article
                const articleId = articleSelect.value;
                const quantite = parseInt(quantiteInput.value);
                
                if (!articleId) {
                    alert('Veuillez sélectionner un article.');
                    return;
                }
                
                if (!quantite || quantite <= 0) {
                    alert('Veuillez saisir une quantité valide.');
                    return;
                }
                
                fetch(`/operateur-logistique/commande/{{ commande.id }}/ajouter-article/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: new URLSearchParams({
                        'article_id': articleId,
                        'quantite': quantite
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Afficher une notification adaptée selon le statut de la commande
                        const selectedOption = articleSelect.options[articleSelect.selectedIndex];
                        let articleData = null;
                        
                        try {
                            articleData = JSON.parse(selectedOption.dataset.article);
                        } catch (jsonError) {
                            console.error('Erreur de parsing JSON article:', jsonError);
                            showNotification('✅ Article ajouté avec succès', 'success');
                            rafraichirSectionArticles();
                            articleModal.classList.add('hidden');
                            return;
                        }
                        
                        if (isCommandeConfirmee()) {
                            showStockNotification('ajout', articleData.nom, quantite, true);
                        } else {
                            showNotification('✅ Article ajouté avec succès', 'success');
                        }
                        
                        rafraichirSectionArticles();
                        articleModal.classList.add('hidden');
                    } else {
                        // Vérifier si c'est une erreur de stock
                        if (data.error && data.error.includes('Stock insuffisant')) {
                            const selectedOption = articleSelect.options[articleSelect.selectedIndex];
                            try {
                                const articleData = JSON.parse(selectedOption.dataset.article);
                                showStockNotification('stock_insuffisant', articleData.nom, quantite);
                            } catch (jsonError) {
                                showNotification('❌ Stock insuffisant', 'error');
                            }
                        } else {
                            showNotification('❌ Erreur: ' + data.error, 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                });
            }
        });
    }

    // Gestionnaire pour le changement d'article sélectionné
    if (articleSelect) {
        articleSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const articleData = JSON.parse(selectedOption.dataset.article);
                afficherInfosArticle(articleData);
            } else {
                document.getElementById('article-info').classList.add('hidden');
            }
        });
    }

    // Gestionnaire pour le changement de quantité
    if (quantiteInput) {
        quantiteInput.addEventListener('input', function() {
            const selectedOption = articleSelect.options[articleSelect.selectedIndex];
            if (selectedOption.value) {
                const articleData = JSON.parse(selectedOption.dataset.article);
                afficherInfosArticle(articleData);
            }
        });
    }

    // Fermer la modale si on clique en dehors
    savModal.addEventListener('click', function(e) {
        if (e.target === savModal) {
            savModal.classList.add('hidden');
            savForm.reset();
        }
    });

    // Raccourcis clavier pour les filtres
    document.addEventListener('keydown', function(e) {
        if (e.altKey) {
            switch(e.key) {
                case '1':
                    e.preventDefault();
                    filtrerArticles('all');
                    break;
                case '2':
                    e.preventDefault();
                    filtrerArticles('promo');
                    break;
                case '3':
                    e.preventDefault();
                    filtrerArticles('liquidation');
                    break;
                case '4':
                    e.preventDefault();
                    filtrerArticles('test');
                    break;
                case '5':
                    e.preventDefault();
                    filtrerArticles('upsell');
                    break;
            }
        }
    });

    // Auto-masquer les messages
    const successMessages = document.querySelectorAll('.alert-dismissible');
    successMessages.forEach(function(message, index) {
        if (message.classList.contains('bg-green-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 5000);
        }
        
        if (message.classList.contains('bg-red-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 10000);
        }
        
        if (message.classList.contains('bg-yellow-50')) {
            setTimeout(function() {
                dismissMessage(message.getAttribute('data-message-id'));
            }, 7000);
        }
    });
});

// Fonction pour fermer un message
function dismissMessage(messageId) {
    const message = document.querySelector(`[data-message-id="${messageId}"]`);
    if (message) {
        message.style.transition = 'all 0.5s ease-out';
        message.style.opacity = '0';
        message.style.transform = 'translateY(-20px)';
        setTimeout(function() {
            message.remove();
        }, 500);
    }
}

// Fonction pour fermer tous les messages
function dismissAllMessages() {
    const messages = document.querySelectorAll('.alert-dismissible');
    messages.forEach(function(message) {
        const messageId = message.getAttribute('data-message-id');
        dismissMessage(messageId);
    });
}

// Fonction pour ouvrir la modale SAV pour articles défectueux
function ouvrirModalSavDefectueux() {
    document.getElementById('savDefectueuxModal').classList.remove('hidden');
    
    // Initialiser les événements pour les checkboxes (toutes cochées par défaut)
    document.querySelectorAll('.article-defectueux-checkbox').forEach(checkbox => {
        checkbox.checked = true; // Tous les articles sont cochés par défaut
        checkbox.addEventListener('change', function() {
            const quantiteInput = document.querySelector(`.quantite-defectueux-input[data-id="${this.dataset.id}"]`);
            quantiteInput.disabled = !this.checked;
            updateArticlesDefectueuxSav();
        });
    });
    
    // Initialiser les événements pour les inputs de quantité
    document.querySelectorAll('.quantite-defectueux-input').forEach(input => {
        input.disabled = false; // Tous les inputs sont activés par défaut
        input.addEventListener('change', updateArticlesDefectueuxSav);
    });
    
    // Mettre à jour le résumé initial
    updateArticlesDefectueuxSav();
}

// Fonction pour fermer la modale SAV pour articles défectueux
function fermerModalSavDefectueux() {
    document.getElementById('savDefectueuxModal').classList.add('hidden');
    // Réinitialiser le formulaire
    document.getElementById('savDefectueuxForm').reset();
    document.getElementById('articlesDefectueuxSav').value = '[]';
    // Remettre tous les articles cochés et les quantités par défaut
    document.querySelectorAll('.article-defectueux-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    document.querySelectorAll('.quantite-defectueux-input').forEach(input => {
        input.disabled = false;
        input.value = input.getAttribute('max');
    });
    updateArticlesDefectueuxSav();
}

// Fonction pour mettre à jour les articles défectueux sélectionnés
function updateArticlesDefectueuxSav() {
    const articles = [];
    let total = 0;
    let nbArticles = 0;
    
    document.querySelectorAll('.article-defectueux-checkbox:checked').forEach(checkbox => {
        const quantiteInput = document.querySelector(`.quantite-defectueux-input[data-id="${checkbox.dataset.id}"]`);
        const quantite = parseInt(quantiteInput.value);
        const prix = parseFloat(checkbox.dataset.prix);
        
        articles.push({
            article_id: parseInt(checkbox.dataset.id),
            quantite: quantite,
            nom: checkbox.dataset.nom,
            prix: prix
        });
        
        total += quantite * prix;
        nbArticles += quantite;
    });
    
    document.getElementById('articlesDefectueuxSav').value = JSON.stringify(articles);
    
    // Mettre à jour le résumé
    const resumeDiv = document.getElementById('resumeSavCommande');
    if (articles.length > 0) {
        document.getElementById('nbArticlesSav').textContent = nbArticles;
        document.getElementById('totalSavCommande').textContent = total.toFixed(2) + ' DH';
        resumeDiv.classList.remove('hidden');
    } else {
        resumeDiv.classList.add('hidden');
    }
}

// Gestionnaire pour le formulaire SAV
document.addEventListener('DOMContentLoaded', function() {
    const savForm = document.getElementById('savDefectueuxForm');
    if (savForm) {
        savForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const articlesDefectueux = document.getElementById('articlesDefectueuxSav').value;
            const articles = JSON.parse(articlesDefectueux);
            
            if (articles.length === 0) {
                showNotification('⚠️ Veuillez sélectionner au moins un article à remplacer par un neuf', 'warning');
                return;
            }
            
            const commentaire = document.getElementById('commentaireSav').value.trim();
            if (!commentaire) {
                showNotification('⚠️ Veuillez décrire les défauts constatés et les améliorations apportées', 'warning');
                return;
            }
            
            // Afficher une notification de traitement
            showNotification('⏳ Création de la commande SAV en cours...', 'info');
            
            // Soumettre le formulaire
            const formData = new FormData(savForm);
            
            fetch(savForm.action, {
                method: 'POST',
                body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                    showNotification(`✅ ${data.message}`, 'success');
                    fermerModalSavDefectueux();
                    // Rediriger vers la nouvelle commande SAV après 2 secondes
                    setTimeout(() => {
                        window.location.href = `/operateur-logistique/commande/${data.commande_sav_id}/`;
                    }, 2000);
            } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau lors de la création de la commande SAV', 'error');
            });
        });
    }
});

// Fonction pour afficher les notifications
function showNotification(message, type = 'info') {
    // Créer l'élément de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
    
    // Couleurs selon le type
    const colors = {
        'success': 'bg-green-500 text-white',
        'error': 'bg-red-500 text-white',
        'warning': 'bg-yellow-500 text-white',
        'info': 'bg-blue-500 text-white'
    };
    
    notification.className += ` ${colors[type] || colors.info}`;
    
    // Icônes selon le type
    const icons = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-circle',
        'warning': 'fas fa-exclamation-triangle',
        'info': 'fas fa-info-circle'
    };
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="${icons[type] || icons.info} mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto-suppression après 5 secondes
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

// Fonction pour rafraîchir la section des articles
function rafraichirSectionArticles() {
    const container = document.getElementById('articles-container');
    if (container) {
        fetch(`/operateur-logistique/commande/{{ commande.id }}/rafraichir-articles/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    container.innerHTML = data.html;
                    // Mettre à jour le total affiché
                    const totalElement = document.getElementById('total-commande');
                    if (totalElement && data.total_commande !== undefined) {
                        totalElement.textContent = data.total_commande.toFixed(2) + ' DH';
                    }
        }
    })
    .catch(error => {
                console.error('Erreur lors du rafraîchissement:', error);
            });
    }
}

// Fonction pour vérifier si la commande est confirmée
function isCommandeConfirmee() {
    const statutElement = document.querySelector('[data-statut-commande]');
    return statutElement && statutElement.dataset.statutCommande === 'confirmée';
}

// Fonction pour afficher les notifications de stock
function showStockNotification(action, articleNom, quantite, isConfirmee = false) {
    let message = '';
    let type = 'info';
    
    switch(action) {
        case 'ajout':
            if (isConfirmee) {
                message = `✅ Article "${articleNom}" ajouté (${quantite} unité(s)). Stock décrémenté automatiquement.`;
                type = 'success';
            } else {
                message = `✅ Article "${articleNom}" ajouté (${quantite} unité(s))`;
                type = 'success';
            }
            break;
        case 'modification':
            if (isConfirmee) {
                message = `🔄 Article "${articleNom}" modifié. Stock ajusté automatiquement.`;
                type = 'info';
            } else {
                message = `🔄 Article "${articleNom}" modifié`;
                type = 'info';
            }
            break;
        case 'suppression':
            if (isConfirmee) {
                message = `🗑️ Article "${articleNom}" supprimé. Stock réincrémenté automatiquement.`;
                type = 'warning';
            } else {
                message = `🗑️ Article "${articleNom}" supprimé`;
                type = 'warning';
            }
            break;
        case 'stock_insuffisant':
            message = `⚠️ Stock insuffisant pour "${articleNom}" (demandé: ${quantite})`;
            type = 'error';
            break;
    }
    
    showNotification(message, type);
}

// Fonction pour modifier la quantité d'un article
function modifierQuantite(panierId, delta, nouvelleQuantite = null) {
    const input = document.querySelector(`input[data-panier-id="${panierId}"]`);
    if (!input) return;
    
    let quantite = parseInt(input.value);
    
    if (nouvelleQuantite !== null) {
        quantite = parseInt(nouvelleQuantite);
    } else {
        quantite += delta;
    }
    
    // Validation
    const min = parseInt(input.min);
    const max = parseInt(input.max);
    
    if (quantite < min) quantite = min;
    if (quantite > max) quantite = max;
    
    // Mettre à jour l'affichage
    input.value = quantite;
    
    // Envoyer la modification au serveur
    const formData = new FormData();
    formData.append('quantite', quantite);
    formData.append('panier_id', panierId);
    
    fetch(`/operateur-logistique/commande/{{ commande.id }}/modifier-quantite/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            // Mettre à jour le sous-total de l'article
            const articleCard = input.closest('.article-card');
            const sousTotalElement = articleCard.querySelector('.text-lg.font-bold');
            if (sousTotalElement) {
                sousTotalElement.textContent = data.sous_total.toFixed(2) + ' DH';
            }
            
            // Mettre à jour le total de la commande
            const totalElement = document.getElementById('total-commande');
            if (totalElement) {
                const fraisLivraison = parseFloat('{{ commande.ville.frais_livraison|default:0 }}') || 0;
                const totalAvecLivraison = data.total_commande + fraisLivraison;
                totalElement.textContent = totalAvecLivraison.toFixed(2) + ' DH';
            }
            
            showNotification(`✅ Quantité modifiée pour "${data.article_nom}"`, 'success');
            } else {
                showNotification('❌ Erreur: ' + data.error, 'error');
            // Restaurer l'ancienne valeur en cas d'erreur
            input.value = data.ancienne_quantite || quantite - delta;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
        showNotification('❌ Erreur de réseau lors de la modification', 'error');
        // Restaurer l'ancienne valeur en cas d'erreur
        input.value = quantite - delta;
    });
}

// Fonction pour calculer le total avec frais de livraison
function calculerTotalAvecLivraison() {
    const fraisLivraison = parseFloat('{{ commande.ville.frais_livraison|default:0 }}') || 0;
    const totalArticles = parseFloat('{{ commande.total_cmd|floatformat:2 }}') || 0;
    const totalAvecLivraison = totalArticles + fraisLivraison;
    
    // Mettre à jour l'affichage du total
    const totalElement = document.getElementById('total-commande');
    if (totalElement) {
        totalElement.textContent = totalAvecLivraison.toFixed(2) + ' DH';
    }
}

// Fonction pour basculer l'affichage de la timeline
function toggleTimeline() {
    const content = document.getElementById('timeline-content');
    const icon = document.getElementById('timeline-icon');
    const text = document.getElementById('timeline-toggle-text');
    const button = document.getElementById('timeline-toggle-btn');
    
    if (!content || !icon || !text || !button) {
        console.error('Éléments de timeline non trouvés');
        return;
    }
    
    // Vérifier si la timeline est actuellement visible
    const isVisible = content.style.display !== 'none' && content.style.opacity !== '0';
    
    if (isVisible) {
        // Masquer la timeline
        content.style.opacity = '0';
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
        setTimeout(() => {
            content.style.display = 'none';
        }, 300);
        icon.className = 'fas fa-chevron-down mr-2';
        text.textContent = 'Afficher';
        button.classList.remove('bg-gray-100', 'text-gray-700');
        button.classList.add('bg-green-100', 'text-green-700');
    } else {
        // Afficher la timeline
        content.style.display = 'block';
        content.style.opacity = '1';
        content.style.maxHeight = 'none';
        content.style.overflow = 'visible';
        icon.className = 'fas fa-chevron-up mr-2';
        text.textContent = 'Masquer';
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100', 'text-gray-700');
    }
}

// Fonction pour afficher la modale des calculs détaillés
function afficherModalCalculs() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.id = 'modal-calculs';
    
    const totalArticles = parseFloat('{{ commande.total_cmd|floatformat:2 }}') || 0;
    const fraisLivraison = parseFloat('{{ commande.ville.frais_livraison|default:0|floatformat:2 }}') || 0;
    const totalFinal = totalArticles + fraisLivraison;
    
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-900">
                        <i class="fas fa-calculator mr-2 text-blue-600"></i>
                        Détail des Calculs de la Commande
                    </h3>
                    <button onclick="fermerModalCalculs()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
            </div>
                
                <div class="space-y-4">
                    <!-- Calcul des articles -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-boxes mr-2"></i>
                            Calcul du Total des Articles
                        </h4>
                        <div class="space-y-2 text-sm">
                            {% for panier in commande.paniers.all %}
                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                <div class="flex-1">
                                    <div class="font-medium">{{ panier.article.nom }}</div>
                                    <div class="text-xs text-gray-500">Réf: {{ panier.article.reference }}</div>
                        </div>
                                <div class="text-right">
                                    <div class="font-medium">{{ panier.quantite }} × {{ panier.article.prix_unitaire|floatformat:2 }} DH</div>
                                    <div class="text-blue-600 font-bold">= {{ panier.sous_total|floatformat:2 }} DH</div>
                                </div>
                            </div>
                            {% endfor %}
                            <div class="border-t border-blue-200 pt-2 mt-2">
                                <div class="flex justify-between items-center font-bold text-blue-800">
                                    <span>Total Articles:</span>
                                    <span>{{ commande.total_cmd|floatformat:2 }} DH</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frais de livraison -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-truck mr-2"></i>
                            Frais de Livraison
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                <div>
                                    <div class="font-medium">Livraison vers {{ commande.ville.nom }}</div>
                                    <div class="text-xs text-gray-500">
                                        {% if commande.ville.region %}
                                            Région: {{ commande.ville.region.nom_region }}
                                        {% endif %}
                                </div>
                                </div>
                                <div class="text-green-600 font-bold">
                                    {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH
                            </div>
                                </div>
                                </div>
                            </div>
                    
                    <!-- Total final -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>
                            Total Final
                        </h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                <span class="font-medium">Total Articles:</span>
                                <span>{{ commande.total_cmd|floatformat:2 }} DH</span>
                        </div>
                            <div class="flex justify-between items-center bg-white p-2 rounded border">
                                <span class="font-medium">Frais de livraison:</span>
                                <span>+ {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH</span>
                    </div>
                            <div class="border-t border-purple-200 pt-2 mt-2">
                                <div class="flex justify-between items-center font-bold text-purple-800 text-lg">
                                    <span>Total Final:</span>
                                    <span>' + totalFinal.toFixed(2) + ' DH</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="fermerModalCalculs()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Compris
                    </button>
                </div>
            </div>
            </div>
        `;
    
    document.body.appendChild(modal);
}

// Fonction pour fermer la modale des calculs
function fermerModalCalculs() {
    const modal = document.getElementById('modal-calculs');
    if (modal) {
        modal.remove();
    }
}

// Fonction pour afficher la modale de la valeur totale
function afficherModalValeurTotale() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.id = 'modal-valeur-totale';
    
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        <i class="fas fa-money-bill-wave mr-2 text-orange-600"></i>
                        Calcul de la Valeur Totale
                </h3>
                    <button onclick="fermerModalValeurTotale()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-3 text-sm">
                    <p class="text-gray-700">
                        La <strong>valeur totale</strong> représente la somme de tous les articles de la commande, 
                        calculée selon les règles suivantes :
                    </p>
                    
                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-2">Règles de calcul :</h4>
                        <ul class="space-y-1 text-sm text-orange-700">
                            <li><i class="fas fa-check mr-2"></i>Prix unitaire × Quantité pour chaque article</li>
                            <li><i class="fas fa-check mr-2"></i>Application des prix upsell si applicable</li>
                            <li><i class="fas fa-check mr-2"></i>Somme de tous les sous-totaux</li>
                            <li><i class="fas fa-check mr-2"></i>Exclusion des frais de livraison (ajoutés séparément)</li>
                        </ul>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <div class="font-semibold text-gray-800 mb-2">Valeur actuelle :</div>
                        <div class="text-2xl font-bold text-orange-600">
                            {{ commande.total_cmd|floatformat:2 }} DH
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                            Pour {{ commande.paniers.count }} article(s)
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="fermerModalValeurTotale()" 
                            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Compris
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Fonction pour fermer la modale de la valeur totale
function fermerModalValeurTotale() {
    const modal = document.getElementById('modal-valeur-totale');
    if (modal) {
        modal.remove();
    }
}

// Fonction pour afficher la modale des frais de livraison
function afficherModalFraisLivraison() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
    modal.id = 'modal-frais-livraison';
    
    modal.innerHTML = `
        <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-900">
                        <i class="fas fa-truck mr-2 text-purple-600"></i>
                        Frais de Livraison
                    </h3>
                    <button onclick="fermerModalFraisLivraison()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-3 text-sm">
                    <p class="text-gray-700">
                        Les <strong>frais de livraison</strong> sont calculés selon la destination de livraison :
                    </p>
                    
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-2">Détails de livraison :</h4>
                        <div class="space-y-2 text-sm text-purple-700">
                            <div class="flex justify-between">
                                <span>Ville de livraison :</span>
                                <span class="font-medium">{{ commande.ville.nom }}</span>
                            </div>
                            {% if commande.ville.region %}
                            <div class="flex justify-between">
                                <span>Région :</span>
                                <span class="font-medium">{{ commande.ville.region.nom_region }}</span>
                            </div>
                            {% endif %}
                            <div class="flex justify-between">
                                <span>Frais appliqués :</span>
                                <span class="font-medium">{{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-2">Comment ça marche :</h4>
                        <ul class="space-y-1 text-sm text-gray-700">
                            <li><i class="fas fa-info-circle mr-2 text-purple-600"></i>Frais fixes par ville/région</li>
                            <li><i class="fas fa-info-circle mr-2 text-purple-600"></i>Indépendant du nombre d'articles</li>
                            <li><i class="fas fa-info-circle mr-2 text-purple-600"></i>Ajouté au total de la commande</li>
                            <li><i class="fas fa-info-circle mr-2 text-purple-600"></i>Peut varier selon la zone géographique</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="fermerModalFraisLivraison()" 
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        <i class="fas fa-check mr-2"></i>Compris
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

// Fonction pour fermer la modale des frais de livraison
function fermerModalFraisLivraison() {
    const modal = document.getElementById('modal-frais-livraison');
    if (modal) {
        modal.remove();
    }
}

// Fonction pour valider tous les calculs
function validerCalculs() {
    try {
    const totalArticles = parseFloat('{{ commande.total_cmd|floatformat:2 }}') || 0;
    const fraisLivraison = parseFloat('{{ commande.ville.frais_livraison|default:0|floatformat:2 }}') || 0;
    const totalAttendu = totalArticles + fraisLivraison;
    
    // Vérifier le total affiché
    const totalElement = document.getElementById('total-commande');
    if (totalElement) {
            const totalText = totalElement.textContent || totalElement.innerText || '';
            const totalAffiche = parseFloat(totalText.replace(' DH', '').replace(',', '.').trim()) || 0;
        if (Math.abs(totalAffiche - totalAttendu) > 0.01) {
            console.warn('⚠️ Incohérence détectée dans les calculs:', {
                totalArticles: totalArticles,
                fraisLivraison: fraisLivraison,
                totalAttendu: totalAttendu,
                totalAffiche: totalAffiche
            });
            // Corriger automatiquement
            totalElement.textContent = totalAttendu.toFixed(2) + ' DH';
        }
    }
    
    // Vérifier les sous-totaux des articles
    const articles = document.querySelectorAll('.article-card');
    let totalArticlesCalcule = 0;
    
    articles.forEach(article => {
            try {
        const sousTotalElement = article.querySelector('.text-lg.font-bold'); // Récupère l'élément qui affiche le sous-total du panier
        
        if (sousTotalElement) {
                    const sousTotalText = sousTotalElement.textContent || sousTotalElement.innerText || '';
                    const sousTotalValeur = parseFloat(sousTotalText.replace(' DH', '').replace(',', '.').trim()) || 0;

                    if (!isNaN(sousTotalValeur) && isFinite(sousTotalValeur)) {
            totalArticlesCalcule += sousTotalValeur; // Somme directement la valeur du sous-total
                    }
                }
            } catch (articleError) {
                console.warn('Erreur lors du calcul d\'un article:', articleError);
        }
    });
    
    // Vérifier la cohérence avec le total des articles
    if (Math.abs(totalArticlesCalcule - totalArticles) > 0.01) {
        console.warn('⚠️ Incohérence dans les sous-totaux des articles:', {
            totalArticlesCalcule: totalArticlesCalcule,
            totalArticles: totalArticles
        });
    }
    
    console.log('✅ Validation des calculs terminée:', {
        totalArticles: totalArticles,
        fraisLivraison: fraisLivraison,
        totalFinal: totalAttendu
    });
        
        return {
            success: true,
            totalArticles: totalArticles,
            fraisLivraison: fraisLivraison,
            totalFinal: totalAttendu
        };
        
    } catch (error) {
        console.error('❌ Erreur lors de la validation des calculs:', error);
        return {
            success: false,
            error: error.message
        };
    }
}

// ================== GESTION DU RENVOI EN PRÉPARATION ==================

function openRenvoyerModal() {
    document.getElementById('renvoyerModal').classList.remove('hidden');
}

function closeRenvoyerModal() {
    document.getElementById('renvoyerModal').classList.add('hidden');
    document.getElementById('renvoyerForm').reset();
}

// Gestionnaire pour le bouton de confirmation du renvoi
document.addEventListener('DOMContentLoaded', function() {
    const confirmRenvoyerBtn = document.getElementById('confirmRenvoyerBtn');
    const cancelRenvoyerBtn = document.getElementById('cancelRenvoyerBtn');
    
    if (confirmRenvoyerBtn) {
        confirmRenvoyerBtn.addEventListener('click', function() {
            const form = document.getElementById('renvoyerForm');
            const commentaire = document.getElementById('commentaire_renvoi').value.trim();
            
            if (!commentaire) {
                showNotification('❌ Veuillez décrire les modifications demandées par le client', 'error');
                return;
            }
            
            // Désactiver le bouton pour éviter les doubles clics
            confirmRenvoyerBtn.disabled = true;
            confirmRenvoyerBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement...';
            
            // Soumettre le formulaire
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(new FormData(form))
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('✅ ' + data.message, 'success');
                    closeRenvoyerModal();
                    
                    // Rediriger vers la liste des commandes après un délai
                    setTimeout(() => {
                        window.location.href = '{% url "operatLogistic:liste_commandes" %}';
                    }, 2000);
                } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                    // Réactiver le bouton
                    confirmRenvoyerBtn.disabled = false;
                    confirmRenvoyerBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>Confirmer le Renvoi';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                // Réactiver le bouton
                confirmRenvoyerBtn.disabled = false;
                confirmRenvoyerBtn.innerHTML = '<i class="fas fa-undo mr-2"></i>Confirmer le Renvoi';
            });
        });
    }
    
    if (cancelRenvoyerBtn) {
        cancelRenvoyerBtn.addEventListener('click', closeRenvoyerModal);
    }
    
    // Fermer la modale en cliquant à l'extérieur
    const renvoyerModal = document.getElementById('renvoyerModal');
    if (renvoyerModal) {
        renvoyerModal.addEventListener('click', function(event) {
            if (event.target === renvoyerModal) {
                closeRenvoyerModal();
            }
        });
    }
});

// Initialiser les calculs avec frais de livraison et la timeline au chargement
document.addEventListener('DOMContentLoaded', function() {
    calculerTotalAvecLivraison();
    validerCalculs(); // Valider tous les calculs
    
    // Initialiser l'état de la timeline (ouverte par défaut)
    const content = document.getElementById('timeline-content');
    const icon = document.getElementById('timeline-icon');
    const text = document.getElementById('timeline-toggle-text');
    const button = document.getElementById('timeline-toggle-btn');
    
    if (content && icon && text && button) {
        // S'assurer que la timeline est visible par défaut
        content.style.display = 'block';
        content.style.opacity = '1';
        content.style.maxHeight = 'none';
        icon.className = 'fas fa-chevron-up mr-2';
        text.textContent = 'Masquer';
        button.classList.remove('bg-green-100', 'text-green-700');
        button.classList.add('bg-gray-100', 'text-gray-700');
    }
});

// ================== GESTION DE LA LIVRAISON PARTIELLE ==================

function ouvrirModalLivraisonPartielle() {
    document.getElementById('livraisonPartielleModal').classList.remove('hidden');
    initialiserModalLivraisonPartielle();
}

function fermerModalLivraisonPartielle() {
    document.getElementById('livraisonPartielleModal').classList.add('hidden');
    // Réinitialiser le formulaire
    document.getElementById('livraisonPartielleForm').reset();
    // Remettre tous les articles cochés et les quantités par défaut
    document.querySelectorAll('.article-livrer-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    document.querySelectorAll('.quantite-livrer-input').forEach(input => {
        input.value = input.getAttribute('max');
    });
    
    // Réinitialiser les selects d'état à 'bon'
    document.querySelectorAll('.etat-article-renvoye').forEach(select => {
        select.value = 'bon';
    });

    // Masquer la section des articles à renvoyer
    document.getElementById('aucunArticleRenvoyer').classList.remove('hidden');
    document.getElementById('articlesARenvoyerContainer').innerHTML = '';
    // Mettre à jour le résumé
    mettreAJourResumeLivraisonPartielle();
}

function initialiserModalLivraisonPartielle() {
    // Initialiser les événements pour les checkboxes
    document.querySelectorAll('.article-livrer-checkbox').forEach(checkbox => {
        checkbox.removeEventListener('change', handleCheckboxChange); // Éviter les doubles écouteurs
        checkbox.addEventListener('change', handleCheckboxChange);
    });
    
    // Initialiser les événements pour les inputs de quantité
    document.querySelectorAll('.quantite-livrer-input').forEach(input => {
        input.removeEventListener('change', mettreAJourResumeLivraisonPartielle); // Éviter les doubles écouteurs
        input.removeEventListener('input', mettreAJourResumeLivraisonPartielle); // Éviter les doubles écouteurs
        input.addEventListener('change', mettreAJourResumeLivraisonPartielle);
        input.addEventListener('input', mettreAJourResumeLivraisonPartielle);
    });

    // Initialiser les événements pour les selects d'état
    document.querySelectorAll('.etat-article-renvoye').forEach(select => {
        select.removeEventListener('change', mettreAJourResumeLivraisonPartielle); // Éviter les doubles écouteurs
        select.addEventListener('change', mettreAJourResumeLivraisonPartielle);
    });
    
    // Mettre à jour le résumé initial
    mettreAJourResumeLivraisonPartielle();
}

// Handler pour le changement de checkbox
function handleCheckboxChange() {
    const quantiteInput = document.querySelector(`.quantite-livrer-input[data-panier-id="${this.dataset.panierId}"]`);
    const etatSelect = document.querySelector(`.etat-article-renvoye[data-article-id="${this.dataset.panierId}"]`); // Utilise panierId comme articleId ici
    
    if (quantiteInput) {
        quantiteInput.disabled = !this.checked;
        if (!this.checked) {
            quantiteInput.value = quantiteInput.getAttribute('max'); // Réinitialise la quantité si décoché
        }
    }
    if (etatSelect) {
        etatSelect.disabled = this.checked; // Désactive le select si l'article est livré
        if (this.checked) {
            etatSelect.value = 'bon'; // Remet à bon état si l'article est livré (pour ne pas envoyer défectueux par erreur)
        }
    }
    mettreAJourResumeLivraisonPartielle();
}

function mettreAJourResumeLivraisonPartielle() {
    const articlesLivres = [];
    const articlesRenvoyes = [];
    let totalArticlesLivres = 0;
    let totalArticlesRenvoyes = 0;
    let totalValeurLivree = 0;
    
    // Parcourir tous les articles du panier original
    document.querySelectorAll('.article-livraison-card').forEach(card => {
        const panierId = parseInt(card.dataset.panierId);
        const articleId = parseInt(card.dataset.articleId);
        const articleNom = card.dataset.articleNom;
        
        // --- DEBUG PRIX START ---
        console.log('DEBUG LP - Raw data-article-prix:', card.dataset.articlePrix); // Log 1: Raw string from DOM
        const articlePrix = parseFloat(card.dataset.articlePrix);
        console.log('DEBUG LP - Parsed articlePrix (float):', articlePrix); // Log 2: Result of parseFloat
        // --- DEBUG PRIX END ---

        const quantiteMax = parseInt(card.dataset.quantiteMax);
        
        const checkbox = card.querySelector('.article-livrer-checkbox');
        const quantiteInput = card.querySelector('.quantite-livrer-input');
        const etatSelect = card.querySelector('.etat-article-renvoye');

        let quantiteLivree = 0;
        let quantiteRenvoyee = 0;
        let etatArticleRenvoye = 'bon';
        
        if (checkbox.checked) {
            quantiteLivree = parseInt(quantiteInput.value) || 0;
            quantiteRenvoyee = quantiteMax - quantiteLivree;

            if (quantiteLivree > 0) {
                articlesLivres.push({
                    panier_id: panierId,
                    article_id: articleId,
                    quantite: quantiteLivree,
                    nom: articleNom,
                    prix_unitaire: articlePrix // This should be a float
                });
                totalArticlesLivres += quantiteLivree;
                totalValeurLivree += quantiteLivree * articlePrix;
            }
            
            if (quantiteRenvoyee > 0) {
                const selectEtat = document.querySelector(`.etat-article-renvoye[data-article-id="${articleId}"][data-panier-id="${panierId}"]`);
                etatArticleRenvoye = selectEtat ? selectEtat.value : 'bon';
                
                articlesRenvoyes.push({
                    panier_id: panierId,
                    article_id: articleId,
                    quantite: quantiteRenvoyee,
                    nom: articleNom,
                    prix_unitaire: articlePrix,
                    etat: etatArticleRenvoye
                });
                totalArticlesRenvoyes += quantiteRenvoyee;
            }
        } else {
            quantiteRenvoyee = quantiteMax;
            const selectEtat = document.querySelector(`.etat-article-renvoye[data-article-id="${articleId}"][data-panier-id="${panierId}"]`);
            etatArticleRenvoye = selectEtat ? selectEtat.value : 'bon';
            
            articlesRenvoyes.push({
                panier_id: panierId,
                article_id: articleId,
                quantite: quantiteRenvoyee,
                nom: articleNom,
                prix_unitaire: articlePrix,
                etat: etatArticleRenvoye
            });
            totalArticlesRenvoyes += quantiteRenvoyee;
        }
    });
    
    // --- DEBUG PRIX FINAL ---
    console.log('DEBUG LP - Final articlesLivres before send:', articlesLivres); // Log 3: Final array
    console.log('DEBUG LP - Final articlesRenvoyes before send:', articlesRenvoyes); // Log 4: Final array
    // --- DEBUG PRIX FINAL ---

    // Mettre à jour les champs cachés (qui seront utilisés par le submit handler)
    document.getElementById('articlesLivresJsonInput').value = JSON.stringify(articlesLivres);
    document.getElementById('articlesRenvoyesJsonInput').value = JSON.stringify(articlesRenvoyes);
    
    // Mettre à jour l'affichage du résumé
    document.getElementById('totalArticlesLivres').textContent = totalArticlesLivres;
    document.getElementById('totalArticlesRenvoyes').textContent = totalArticlesRenvoyes;
    document.getElementById('totalValeurLivree').textContent = totalValeurLivree.toFixed(2) + ' DH';
    
    // Mettre à jour la section des articles à renvoyer
    mettreAJourSectionArticlesRenvoyes(articlesRenvoyes);
    
    // Activer/désactiver le bouton de confirmation
    const confirmerBtn = document.getElementById('confirmerLivraisonPartielleBtn');
    const commentaireInput = document.getElementById('commentaireLivraisonPartielle');
    
    confirmerBtn.disabled = !(commentaireInput.value.trim().length > 0 && (totalArticlesLivres > 0 || totalArticlesRenvoyes > 0));
}

// Fonction qui gère l'affichage des articles à renvoyer dans la section dédiée
function mettreAJourSectionArticlesRenvoyes(articlesRenvoyes) {
    const container = document.getElementById('articlesARenvoyerContainer');
    const aucunArticleDiv = document.getElementById('aucunArticleRenvoyer');
    
    // Sauvegarder les états sélectionnés avant de régénérer le DOM (clé = article_id + panier_id)
    const etatsSelectionnes = {};
    document.querySelectorAll('.etat-article-renvoye').forEach(select => {
        const key = `${select.dataset.articleId}_${select.dataset.panierId}`;
        etatsSelectionnes[key] = select.value;
    });

    container.innerHTML = '';

    if (articlesRenvoyes.length === 0) {
        aucunArticleDiv.classList.remove('hidden');
        return;
    }

    aucunArticleDiv.classList.add('hidden');

    articlesRenvoyes.forEach(article => {
        const articleCard = document.createElement('div');
        articleCard.className = 'article-renvoi-card bg-white rounded-lg border border-orange-300 p-4';
        articleCard.dataset.articleId = article.article_id;
        articleCard.dataset.panierId = article.panier_id;
        articleCard.innerHTML = `
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <i class="fas fa-undo text-orange-600 text-lg mt-1"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-gray-900">${article.nom}</div>
                    <div class="text-sm text-gray-500">
                        Quantité à renvoyer: <span class="font-semibold text-orange-600">${article.quantite}</span><br>
                        Prix unitaire: ${article.prix_unitaire.toFixed(2)} DH<br>
                        Valeur: <span class="font-semibold text-orange-600">${(article.quantite * article.prix_unitaire).toFixed(2)} DH</span>
                    </div>
                    <label class="block text-xs font-medium text-gray-700 mt-2 mb-1">État :</label>
                    <select class="etat-article-renvoye w-full px-2 py-1 border border-gray-300 rounded" data-article-id="${article.article_id}" data-panier-id="${article.panier_id}">
                        <option value="bon">Bon état</option>
                        <option value="defectueux">Défectueux</option>
                    </select>
                </div>
            </div>
        `;
        container.appendChild(articleCard);

        // Rétablir la valeur sélectionnée si elle existe (clé = article_id + panier_id)
        const select = articleCard.querySelector('.etat-article-renvoye');
        const key = `${article.article_id}_${article.panier_id}`;
        if (etatsSelectionnes[key]) {
            select.value = etatsSelectionnes[key];
        } else if (article.etat) {
            select.value = article.etat;
        }
    });

    // Rattacher les écouteurs d'événements aux nouveaux selects
    document.querySelectorAll('.etat-article-renvoye').forEach(select => {
        select.removeEventListener('change', mettreAJourResumeLivraisonPartielle);
        select.addEventListener('change', mettreAJourResumeLivraisonPartielle);
    });
}

// ================== Ancien Gestionnaire de Soumission de Formulaire ==================
// Ce bloc est maintenant simplifié et doit utiliser les hidden inputs JSON
// qui sont mis à jour par mettreAJourResumeLivraisonPartielle()
document.addEventListener('DOMContentLoaded', function() {
    const livraisonPartielleForm = document.getElementById('livraisonPartielleForm');
    if (livraisonPartielleForm) {
        livraisonPartielleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Le commentaire est déjà validé via le bouton Confirmer
            const commentaire = document.getElementById('commentaireLivraisonPartielle').value.trim();
            
            const articlesLivres = JSON.parse(document.getElementById('articlesLivresJsonInput').value);
            const articlesRenvoyes = JSON.parse(document.getElementById('articlesRenvoyesJsonInput').value);
            
            // DEBUG: Afficher les valeurs collectées
            console.log('=== DEBUG LIVRAISON PARTIELLE ===');
            console.log('Articles renvoyés:', articlesRenvoyes);
            articlesRenvoyes.forEach((article, index) => {
                console.log(`Article ${index + 1}: ${article.nom} - État: ${article.etat}`);
            });
            console.log('=== FIN DEBUG ===');
            
            const totalArticlesLivres = articlesLivres.reduce((acc, a) => acc + (a.quantite || 0), 0);
            const totalArticlesRenvoyes = articlesRenvoyes.reduce((acc, a) => acc + (a.quantite || 0), 0);
            const totalValeurLivree = articlesLivres.reduce((acc, a) => acc + (a.quantite * a.prix || 0), 0);
            
            // Validation de base
            if (articlesLivres.length === 0 && articlesRenvoyes.length === 0) {
                showNotification('⚠️ Veuillez sélectionner au moins un article à livrer ou à renvoyer', 'warning');
                return;
            }
            
            // Désactiver le bouton pour éviter les doubles soumissions
            const submitBtn = document.getElementById('confirmerLivraisonPartielleBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Traitement...';
            
            // Créer un FormData pour envoyer les données
            const formData = new FormData();
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            formData.append('articles_livres', JSON.stringify(articlesLivres));
            formData.append('articles_renvoyes', JSON.stringify(articlesRenvoyes));
            formData.append('commentaire', commentaire);

            fetch(livraisonPartielleForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Affichage du toast
                    showNotification(
                        `✅ Livraison partielle effectuée avec succès !\n` +
                        `Articles livrés : ${totalArticlesLivres}\n` +
                        `Articles renvoyés : ${totalArticlesRenvoyes}\n` +
                        `Valeur totale livrée : ${totalValeurLivree.toFixed(2)} DH`,
                        'success'
                    );
                    // Affichage de la modale de confirmation
                    const confirmationModal = document.getElementById('confirmationLivraisonPartielleModal');
                    const detailsDiv = document.getElementById('confirmation-livraison-details');
                    if (data.recap_articles_renvoyes && Array.isArray(data.recap_articles_renvoyes) && data.recap_articles_renvoyes.length > 0) {
                        let table = `<table class='min-w-full text-sm text-left border mt-4'>`;
                        table += `<thead><tr><th class='px-2 py-1 border'>Article</th><th class='px-2 py-1 border'>Qté</th><th class='px-2 py-1 border'>État</th><th class='px-2 py-1 border'>Stock avant</th><th class='px-2 py-1 border'>Stock après</th></tr></thead><tbody>`;
                        data.recap_articles_renvoyes.forEach(a => {
                            table += `<tr>` +
                                `<td class='px-2 py-1 border'>${a.nom || '-'}</td>` +
                                `<td class='px-2 py-1 border text-center'>${a.quantite}</td>` +
                                `<td class='px-2 py-1 border text-center'>${a.etat === 'bon' ? 'Bon état' : 'Défectueux'}</td>` +
                                `<td class='px-2 py-1 border text-center'>${a.stock_avant !== null ? a.stock_avant : '-'}</td>` +
                                `<td class='px-2 py-1 border text-center'>${a.stock_apres !== null ? a.stock_apres : '-'}</td>` +
                            `</tr>`;
                        });
                        table += `</tbody></table>`;
                        let stockTable = '';
                        if (data.recap_stock_commande && Array.isArray(data.recap_stock_commande) && data.recap_stock_commande.length > 0) {
                            stockTable = `<div class='mt-6 mb-2 font-semibold text-gray-700'>Stock de tous les articles de la commande :</div>`;
                            stockTable += `<table class='min-w-full text-sm text-left border'>`;
                            stockTable += `<thead><tr><th class='px-2 py-1 border'>Article</th><th class='px-2 py-1 border'>Stock avant</th><th class='px-2 py-1 border'>Stock après</th><th class='px-2 py-1 border'>Statut</th></tr></thead><tbody>`;
                            data.recap_stock_commande.forEach(a => {
                                stockTable += `<tr>` +
                                    `<td class='px-2 py-1 border'>${a.nom || '-'}</td>` +
                                    `<td class='px-2 py-1 border text-center'>${a.stock_avant !== null ? a.stock_avant : '-'}</td>` +
                                    `<td class='px-2 py-1 border text-center'>${a.stock_apres !== null ? a.stock_apres : '-'}</td>` +
                                    `<td class='px-2 py-1 border text-center'>${a.statut || '-'}</td>` +
                                `</tr>`;
                            });
                            stockTable += `</tbody></table>`;
                        }
                        detailsDiv.innerHTML = `
                            <div><strong>Articles livrés :</strong> ${totalArticlesLivres}</div>
                            <div><strong>Articles renvoyés :</strong> ${totalArticlesRenvoyes}</div>
                            <div><strong>Valeur totale livrée :</strong> ${totalValeurLivree.toFixed(2)} DH</div>
                            <div class='mt-4 mb-2 font-semibold text-gray-700'>Détail des articles renvoyés :</div>
                            ${table}
                            ${stockTable}
                        `;
                    } else {
                        detailsDiv.innerHTML = `
                            <div><strong>Articles livrés :</strong> ${totalArticlesLivres}</div>
                            <div><strong>Articles renvoyés :</strong> ${totalArticlesRenvoyes}</div>
                            <div><strong>Valeur totale livrée :</strong> ${totalValeurLivree.toFixed(2)} DH</div>
                        `;
                    }
                    confirmationModal.classList.remove('hidden');
                    fermerModalLivraisonPartielle();
                    // Gestion du bouton OK
                    const fermerBtn = document.getElementById('fermerConfirmationLivraisonBtn');
                    if (fermerBtn) {
                        fermerBtn.onclick = function() {
                            confirmationModal.classList.add('hidden');
                        window.location.reload();
                        };
                    }
                } else {
                    showNotification('❌ Erreur: ' + data.error, 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer la Livraison Partielle';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showNotification('❌ Erreur de réseau: ' + error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Confirmer la Livraison Partielle';
            });
        });
    }
});

// ================== FIN GESTION DE LA LIVRAISON PARTIELLE ==================

// ================== GESTION DE LA LIVRAISON PARTIELLE (duplication à supprimer) ==================
// Cette section est une duplication qui doit être supprimée. La logique a été déplacée plus haut.
// Je vais la supprimer après la confirmation de cette modification.
// ... existing code ...
</script>
{% endblock %} 