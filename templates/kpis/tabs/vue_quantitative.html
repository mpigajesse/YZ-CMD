<!-- Onglet Vue Quantitative - Suivi des √©tats de commandes -->
<div class="space-y-6">
  <!-- Section principale: Suivi de l'√©tat des commandes -->
  <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-3">
          <div class="w-8 h-8 bg-gradient-to-r from-purple-600 to-purple-800 rounded-lg flex items-center justify-center">
            <i class="fas fa-chart-bar text-white text-sm"></i>
          </div>Suivi de l'√©tat des commandes
        </h3>
        <p class="text-gray-600 mt-1">R√©partition des commandes par √©tat de traitement</p>
      </div>

      <!-- Filtres temporels et export -->
      <div class="flex items-center gap-3">
        <!-- Filtres temporels -->
        <div class="flex items-center gap-2">
          <label class="text-sm font-medium text-gray-700">P√©riode :</label>
          <select id="vue-quantitative-period-filter" class="text-sm border border-gray-300 rounded-lg px-3 py-1 bg-white focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
            <option value="aujourd_hui" selected>Aujourd'hui</option>
            <option value="ce_mois">Ce mois</option>
            <option value="cette_annee">Cette ann√©e</option>
            <option value="personnalisee">Personnalis√©e</option>
          </select>

          <!-- S√©lecteur de date pour p√©riode personnalis√©e -->
          <div id="custom-date-container" class="hidden items-center gap-2 ml-2">
            <label class="text-sm text-gray-600">Du :</label>
            <input type="date" id="custom-date-from" class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" />
            <label class="text-sm text-gray-600">au :</label>
            <input type="date" id="custom-date-to" class="text-sm border border-gray-300 rounded px-2 py-1 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" />
            <button id="apply-custom-date" class="text-sm bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700 transition-colors">Appliquer</button>
            <div id="date-error-message" class="hidden text-xs text-red-600 ml-2"></div>
          </div>
        </div>

        <!-- Boutons d'export -->
        <div class="flex items-center gap-2 border-l border-gray-300 pl-3">
          <button id="export-excel-btn" class="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200" title="Exporter en Excel">
            <i class="fas fa-file-excel text-xs"></i>
            <span>Excel</span>
          </button>
        </div>

        <!-- Bouton de rafra√Æchissement -->
        <button id="refresh-vue-quantitative" class="flex items-center gap-1 px-3 py-1 text-sm text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-all duration-200" title="Actualiser les donn√©es">
          <i class="fas fa-sync-alt text-xs"></i>
          <span>Actualiser</span>
        </button>
      </div>
    </div>

    <!-- Grille des √©tats de commandes -->
    <div id="vue-quantitative-etats-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4">
      <!-- Contenu charg√© dynamiquement -->
      <div class="col-span-full flex items-center justify-center py-12">
        <div class="text-center">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
          <p class="text-gray-500">Chargement des donn√©es...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Styles CSS sp√©cifiques -->
<style>
  .etat-card {
    @apply bg-white rounded-lg border border-gray-200 p-4 transition-all duration-200 hover:shadow-md hover:border-gray-300;
  }
  
  .etat-card-header {
    @apply flex items-center justify-between mb-2;
  }
  
  .etat-number {
    @apply text-2xl font-bold;
  }
  
  .etat-label {
    @apply text-sm font-medium text-gray-600;
  }
  
  .etat-icon {
    @apply w-8 h-8 rounded-full flex items-center justify-center text-white text-sm;
  }
  
  /* Couleurs par type d'√©tat */
  .etat-recue .etat-icon {
    @apply bg-blue-500;
  }
  .etat-affectee .etat-icon {
    @apply bg-green-500;
  }
  .etat-non_affectee .etat-icon {
    @apply bg-yellow-500;
  }
  .etat-erronnee .etat-icon {
    @apply bg-red-500;
  }
  .etat-doublon .etat-icon {
    @apply bg-orange-500;
  }
  .etat-en_cours_confirmation .etat-icon {
    @apply bg-indigo-500;
  }
  .etat-confirmee .etat-icon {
    @apply bg-emerald-500;
  }
  .etat-en_cours_preparation .etat-icon {
    @apply bg-cyan-500;
  }
  .etat-preparee .etat-icon {
    @apply bg-teal-500;
  }
  .etat-en_cours_livraison .etat-icon {
    @apply bg-purple-500;
  }
  .etat-livree .etat-icon {
    @apply bg-green-600;
  }
  .etat-retournee .etat-icon {
    @apply bg-gray-500;
  }
  
  .etat-recue .etat-number {
    @apply text-blue-600;
  }
  .etat-affectee .etat-number {
    @apply text-green-600;
  }
  .etat-non_affectee .etat-number {
    @apply text-yellow-600;
  }
  .etat-erronnee .etat-number {
    @apply text-red-600;
  }
  .etat-doublon .etat-number {
    @apply text-orange-600;
  }
  .etat-en_cours_confirmation .etat-number {
    @apply text-indigo-600;
  }
  .etat-confirmee .etat-number {
    @apply text-emerald-600;
  }
  .etat-en_cours_preparation .etat-number {
    @apply text-cyan-600;
  }
  .etat-preparee .etat-number {
    @apply text-teal-600;
  }
  .etat-en_cours_livraison .etat-number {
    @apply text-purple-600;
  }
  .etat-livree .etat-number {
    @apply text-green-700;
  }
  .etat-retournee .etat-number {
    @apply text-gray-600;
  }
  
  /* Styles pour la validation des dates */
  .border-red-500 {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 1px #ef4444 !important;
  }
  
  #date-error-message {
    @apply text-xs text-red-600 font-medium;
  }
  
  /* Am√©liorer l'apparence du conteneur de dates personnalis√©es */
  #custom-date-container {
    @apply bg-gray-50 rounded-lg p-3 border border-gray-200;
  }
</style>

<!-- JavaScript pour le chargement des donn√©es -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let currentData = null // Stocker les donn√©es actuelles pour l'export
  
    // Charger les donn√©es de l'onglet Vue Quantitative
    function loadVueQuantitativeData(period = 'aujourd_hui') {
      // Afficher un indicateur de chargement
      showLoadingState()
  
      const url = '/kpis/api/vue-quantitative/?period=' + period
      console.log('üîç Chargement des donn√©es pour la p√©riode:', period)
      console.log('üåê URL appel√©e:', url)
  
      fetch(url)
        .then((response) => {
          console.log('üì° R√©ponse re√ßue, status:', response.status)
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`)
          }
          return response.json()
        })
        .then((data) => {
          console.log('üìä Donn√©es re√ßues:', data)
          if (data.success) {
            currentData = data.data // Stocker pour l'export
            renderEtatsCommandes(data.data.etats_commandes)
            console.log('‚úÖ Donn√©es rendues avec succ√®s')
            // updatePeriodInfo supprim√© - plus de ligne de r√©sum√© selon demande client
          } else {
            console.error('‚ùå √âchec API:', data.message || 'Erreur inconnue')
            showError('Erreur lors du chargement des donn√©es: ' + (data.message || 'Erreur inconnue'))
          }
        })
        .catch((error) => {
          console.error('‚ùå Erreur compl√®te:', error)
          showError('Erreur de connexion: ' + error.message)
        })
    }
  
    // Afficher l'√©tat de chargement
    function showLoadingState() {
      const container = document.getElementById('vue-quantitative-etats-grid')
      container.innerHTML = '<div class="col-span-full flex items-center justify-center py-12">' + '<div class="text-center">' + '<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>' + '<p class="text-gray-500">Chargement des donn√©es...</p>' + '</div>' + '</div>'
    }
  
    // Mettre √† jour les informations de p√©riode
    function updatePeriodInfo(period, totalCommandes) {
      // Supprimer cette fonction car nous ne voulons plus afficher la ligne de r√©sum√©
      // selon les demandes du client
    }
  
    // Rendu des cartes d'√©tats de commandes
    function renderEtatsCommandes(etats) {
      var container = document.getElementById('vue-quantitative-etats-grid')
  
      var etatsConfig = {
        recue: { label: 'Re√ßues', icon: 'fas fa-inbox' },
        affectee: { label: 'Affect√©es', icon: 'fas fa-user-check' },
        non_affectee: { label: 'Non affect√©es', icon: 'fas fa-user-times' },
        erronnee: { label: 'Erron√©es', icon: 'fas fa-exclamation-triangle' },
        doublon: { label: 'Doublons', icon: 'fas fa-copy' },
        en_cours_confirmation: { label: 'En confirmation', icon: 'fas fa-clock' },
        confirmee: { label: 'Confirm√©es', icon: 'fas fa-check-circle' },
        en_cours_preparation: { label: 'En pr√©paration', icon: 'fas fa-box-open' },
        preparee: { label: 'Pr√©par√©es', icon: 'fas fa-box' },
        en_cours_livraison: { label: 'En livraison', icon: 'fas fa-truck' },
        livree: { label: 'Livr√©es', icon: 'fas fa-check-double' },
        retournee: { label: 'Retourn√©es', icon: 'fas fa-undo' }
      }
  
      var html = ''
      for (var etat in etats) {
        if (etats.hasOwnProperty(etat)) {
          var count = etats[etat]
          var config = etatsConfig[etat]
          if (config) {
            html += '<div class="etat-card etat-' + etat + '">'
            html += '  <div class="etat-card-header">'
            html += '    <div class="etat-icon">'
            html += '      <i class="' + config.icon + '"></i>'
            html += '    </div>'
            html += '  </div>'
            html += '  <div class="etat-number">' + count.toLocaleString() + '</div>'
            html += '  <div class="etat-label">' + config.label + '</div>'
            html += '</div>'
          }
        }
      }
  
      container.innerHTML = html
    }
  
    // Fonction d'erreur
    function showError(message) {
      var container = document.getElementById('vue-quantitative-etats-grid')
      container.innerHTML = '<div class="col-span-full bg-red-50 border border-red-200 rounded-lg p-6 text-center">' + '  <div class="text-red-600 mb-2">' + '    <i class="fas fa-exclamation-triangle text-2xl"></i>' + '  </div>' + '  <p class="text-red-800 font-medium">' + message + '</p>' + '</div>'
    }
  
    // Fonction pour valider les dates
    function validateCustomDates(fromDate, toDate) {
      const today = new Date().toISOString().split('T')[0]
      const errorMessage = document.getElementById('date-error-message')
  
      // R√©initialiser les styles d'erreur
      document.getElementById('custom-date-from').classList.remove('border-red-500')
      document.getElementById('custom-date-to').classList.remove('border-red-500')
      errorMessage.classList.add('hidden')
  
      // V√©rifier que les dates sont saisies
      if (!fromDate) {
        showDateError('Veuillez s√©lectionner une date de d√©but', 'from')
        return false
      }
  
      if (!toDate) {
        showDateError('Veuillez s√©lectionner une date de fin', 'to')
        return false
      }
  
      // V√©rifier que la date de d√©but n'est pas apr√®s la date de fin
      if (fromDate > toDate) {
        showDateError('La date de d√©but ne peut pas √™tre apr√®s la date de fin', 'from')
        return false
      }
  
      // V√©rifier que la date de fin ne d√©passe pas aujourd'hui
      if (toDate > today) {
        showDateError('La date de fin ne peut pas √™tre dans le futur', 'to')
        return false
      }
  
      return true
    }
  
    function showDateError(message, field) {
      const errorMessage = document.getElementById('date-error-message')
      errorMessage.textContent = message
      errorMessage.classList.remove('hidden')
  
      if (field === 'from') {
        document.getElementById('custom-date-from').classList.add('border-red-500')
      } else if (field === 'to') {
        document.getElementById('custom-date-to').classList.add('border-red-500')
      }
    }
  
    // ...existing code... */
    function exportToExcel() {
      if (!currentData) {
        alert("Aucune donn√©e √† exporter. Veuillez charger les donn√©es d'abord.")
        return
      }
  
      const etats = currentData.etats_commandes
      const periode = document.getElementById('vue-quantitative-period-filter').value
      const total = currentData.total_commandes
  
      // Labels fran√ßais corrects avec tous les accents
      const etatsLabels = {
        recue: 'Re√ßues',
        affectee: 'Affect√©es',
        non_affectee: 'Non affect√©es',
        erronnee: 'Erron√©es',
        doublon: 'Doublons',
        en_cours_confirmation: 'En confirmation',
        confirmee: 'Confirm√©es',
        en_cours_preparation: 'En pr√©paration',
        preparee: 'Pr√©par√©es',
        en_cours_livraison: 'En livraison',
        livree: 'Livr√©es',
        retournee: 'Retourn√©es'
      }
  
      // Cr√©er un vrai format Excel avec HTML table (Excel peut l'interpr√©ter)
      let htmlContent = `<?xml version="1.0"?>
  <Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
   xmlns:o="urn:schemas-microsoft-com:office:office"
   xmlns:x="urn:schemas-microsoft-com:office:excel"
   xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
   xmlns:html="http://www.w3.org/TR/REC-html40">
   <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
    <Title>√âtats des commandes</Title>
   </DocumentProperties>
   <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
    <WindowHeight>12000</WindowHeight>
    <WindowWidth>18000</WindowWidth>
    <WindowTopX>0</WindowTopX>
    <WindowTopY>0</WindowTopY>
   </ExcelWorkbook>
   <Styles>
    <Style ss:ID="header">
     <Font ss:Bold="1"/>
     <Interior ss:Color="#D3D3D3" ss:Pattern="Solid"/>
    </Style>
    <Style ss:ID="total">
     <Font ss:Bold="1"/>
     <Interior ss:Color="#F0F0F0" ss:Pattern="Solid"/>
    </Style>
   </Styles>
   <Worksheet ss:Name="√âtats des commandes">
    <Table>
     <Row>
      <Cell ss:StyleID="header"><Data ss:Type="String">√âtat de commande</Data></Cell>
      <Cell ss:StyleID="header"><Data ss:Type="String">Nombre</Data></Cell>
      <Cell ss:StyleID="header"><Data ss:Type="String">Pourcentage</Data></Cell>
     </Row>`
  
      // Ajouter les donn√©es des √©tats
      for (const [etat, count] of Object.entries(etats)) {
        const label = etatsLabels[etat] || etat
        const pourcentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0'
  
        htmlContent += `
     <Row>
      <Cell><Data ss:Type="String">${label}</Data></Cell>
      <Cell><Data ss:Type="Number">${count}</Data></Cell>
      <Cell><Data ss:Type="String">${pourcentage}%</Data></Cell>
     </Row>`
      }
  
      // Ajouter une ligne vide et le total
      htmlContent += `
     <Row></Row>
     <Row>
      <Cell ss:StyleID="total"><Data ss:Type="String">Total</Data></Cell>
      <Cell ss:StyleID="total"><Data ss:Type="Number">${total}</Data></Cell>
      <Cell ss:StyleID="total"><Data ss:Type="String">100.0%</Data></Cell>
     </Row>
    </Table>
   </Worksheet>
  </Workbook>`
  
      // Cr√©er et t√©l√©charger le fichier Excel (.xls format XML Excel)
      const blob = new Blob(['\ufeff' + htmlContent], {
        type: 'application/vnd.ms-excel;charset=utf-8;'
      })
      const link = document.createElement('a')
      const url = URL.createObjectURL(blob)
      link.setAttribute('href', url)
  
      // Nom de fichier avec extension .xls (format XML Excel)
      const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '')
      link.setAttribute('download', 'etats_commandes_' + periode + '_' + dateStr + '.xls')
  
      link.style.visibility = 'hidden'
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  
    // Gestionnaires d'√©v√©nements
    document.getElementById('vue-quantitative-period-filter').addEventListener('change', function () {
      const selectedPeriod = this.value
      const customContainer = document.getElementById('custom-date-container')
  
      if (selectedPeriod === 'personnalisee') {
        // Afficher le s√©lecteur de date personnalis√©
        customContainer.classList.remove('hidden')
        customContainer.classList.add('flex')
  
        // Configurer les dates par d√©faut : aujourd'hui et il y a 7 jours
        const today = new Date().toISOString().split('T')[0]
        const weekAgo = new Date()
        weekAgo.setDate(weekAgo.getDate() - 7)
        const weekAgoStr = weekAgo.toISOString().split('T')[0]
  
        // D√©finir les dates par d√©faut
        const fromInput = document.getElementById('custom-date-from')
        const toInput = document.getElementById('custom-date-to')
  
        if (!fromInput.value) {
          fromInput.value = weekAgoStr
        }
        if (!toInput.value) {
          toInput.value = today
        }
  
        // Configurer les contraintes des inputs
        fromInput.max = today
        toInput.min = fromInput.value
        toInput.max = today
  
        // Ne pas charger les donn√©es imm√©diatement, attendre l'application
      } else {
        // Masquer le s√©lecteur de date personnalis√©
        customContainer.classList.add('hidden')
        customContainer.classList.remove('flex')
  
        // R√©initialiser les messages d'erreur
        document.getElementById('date-error-message').classList.add('hidden')
        document.getElementById('custom-date-from').classList.remove('border-red-500')
        document.getElementById('custom-date-to').classList.remove('border-red-500')
  
        // Charger les donn√©es pour les p√©riodes pr√©d√©finies
        loadVueQuantitativeData(selectedPeriod)
      }
    })
  
    // Gestionnaire pour la date personnalis√©e - date de d√©but
    document.getElementById('custom-date-from').addEventListener('change', function () {
      const fromDate = this.value
      const toDateInput = document.getElementById('custom-date-to')
      const today = new Date().toISOString().split('T')[0]
  
      if (fromDate) {
        // D√©finir la date minimum pour la date de fin (= date de d√©but)
        toDateInput.min = fromDate
        // D√©finir la date maximum pour la date de fin (= aujourd'hui)
        toDateInput.max = today
  
        // Si aucune date de fin n'est d√©finie, utiliser aujourd'hui
        if (!toDateInput.value) {
          toDateInput.value = today
        }
  
        // Si la date de fin actuelle est avant la nouvelle date de d√©but, l'ajuster
        if (toDateInput.value < fromDate) {
          toDateInput.value = fromDate
        }
      }
  
      // Valider en temps r√©el
      validateCustomDates(fromDate, toDateInput.value)
    })
  
    // Gestionnaire pour la date personnalis√©e - date de fin
    document.getElementById('custom-date-to').addEventListener('change', function () {
      const toDate = this.value
      const fromDate = document.getElementById('custom-date-from').value
  
      // Valider en temps r√©el
      validateCustomDates(fromDate, toDate)
    })
  
    document.getElementById('apply-custom-date').addEventListener('click', function () {
      const fromDate = document.getElementById('custom-date-from').value
      const toDate = document.getElementById('custom-date-to').value
  
      // Valider les dates avant d'appliquer
      if (!validateCustomDates(fromDate, toDate)) {
        return
      }
  
      // Construire le param√®tre de p√©riode personnalis√©e
      const customPeriod = 'custom:' + fromDate + ':' + toDate
      loadVueQuantitativeData(customPeriod)
    })
  
    document.getElementById('export-excel-btn').addEventListener('click', exportToExcel)
  
    document.getElementById('refresh-vue-quantitative').addEventListener('click', function () {
      const currentPeriod = document.getElementById('vue-quantitative-period-filter').value
      loadVueQuantitativeData(currentPeriod)
  
      // Animation du bouton
      const icon = this.querySelector('i')
      icon.classList.add('animate-spin')
      setTimeout(() => {
        icon.classList.remove('animate-spin')
      }, 1000)
    })
  
    // √âcouter l'√©v√©nement de changement d'onglet
    document.addEventListener('tabChanged', function (e) {
      if (e.detail.tab === 'vue-quantitative') {
        const currentPeriod = document.getElementById('vue-quantitative-period-filter').value
        loadVueQuantitativeData(currentPeriod)
      }
    })
  
    // Charger les donn√©es si l'onglet est d√©j√† actif
    var activeTab = document.querySelector('.kpi-tab-button.active')
    if (activeTab && activeTab.getAttribute('data-tab') === 'vue-quantitative') {
      loadVueQuantitativeData()
    }
  })
</script>
