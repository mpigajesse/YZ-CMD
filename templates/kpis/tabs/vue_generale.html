<!-- Onglet Vue G√©n√©rale - KPIs Critiques Yoozak -->
{% load static %}

<!-- Message d'erreur (masqu√© par d√©faut) -->
<div class="kpi-error-message hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
  <i class="fas fa-exclamation-triangle mr-2"></i>
  <span>Message d'erreur</span>
</div>

<!-- KPIs Critiques (Top 4) -->
<div class="mb-8">
  <div class="flex items-center justify-between mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Vue d'Ensemble</h2>
      <p class="text-gray-600">Les 4 indicateurs critiques pour le pilotage quotidien de Yoozak</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
    <!-- KPI 1: CA du Mois -->
    <div data-kpi="ca-mois">
      {% include 'kpis/components/kpi_card.html' with title="Chiffre d'Affaires" subtitle='Ce mois' value='--' unit='DH' icon='fas fa-coins' color='blue' trend='--' trend_label='vs mois dernier' status='loading' sub_value='Chargement...' %}
    </div>

    <!-- KPI 2: Commandes du Jour -->
    <div data-kpi="commandes-jour">
      {% include 'kpis/components/kpi_card.html' with title='Commandes' subtitle="Aujourd'hui" value='--' unit='commandes' icon='fas fa-shopping-cart' color='green' trend='--' trend_label='vs hier' sub_value='Chargement...' status='loading' %}
    </div> <!-- KPI 3: Stock Critique Articles Populaires -->
    <div data-kpi="stock-critique">
      {% include 'kpis/components/kpi_card.html' with title='Stock Critique' subtitle='Articles populaires' value='--' unit='articles' icon='fas fa-exclamation-triangle' color='orange' trend='--' trend_label='risque rupture' sub_value='Chargement...' status='loading' %}
    </div>

    <!-- KPI 4: Taux Conversion T√©l√©phonique -->
    <div data-kpi="taux-conversion">
      {% include 'kpis/components/kpi_card.html' with title='Taux Conversion' subtitle='Appels t√©l√©phoniques' value='--' unit='%' icon='fas fa-phone' color='purple' trend='--' trend_label='vs objectif 70%' sub_value='Chargement...' status='loading' %}
    </div>
  </div>
</div>

<!-- KPIs Secondaires - Vue Synth√©tique -->
<div class="mb-8">
  <h3 class="text-xl font-semibold text-gray-900 mb-4 flex items-center gap-2">
    <i class="fas fa-tachometer-alt text-gray-600"></i>
    Indicateurs Synth√©tiques
  </h3>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    <div data-kpi="panier-moyen">
      {% include 'kpis/components/kpi_card.html' with title='Panier Moyen' value='--' unit='DH' size='small' color='green' trend='--' %}
    </div>
    <div data-kpi="delai-livraison">
      {% include 'kpis/components/kpi_card.html' with title='D√©lai Livraison' value='--' unit='jours' size='small' color='purple' trend='--' %}
    </div>
    <div data-kpi="taux-retour">
      {% include 'kpis/components/kpi_card.html' with title='Taux Retour' value='--' unit='%' size='small' color='yellow' trend='--' %}
    </div>
    <div data-kpi="taux-confirmation">
      {% include 'kpis/components/kpi_card.html' with title='Taux Confirmation' value='--' unit='%' size='small' color='green' trend='--' %}
    </div>
  </div>
</div>

<!-- Graphique Principal: Evolution CA -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
  <!-- Evolution CA 12 mois -->
  <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">üìà Evolution du Chiffre d'Affaires</h3>
      </div>
      <div class="flex items-center gap-2">
        <!-- S√©lecteur de p√©riode style moderne -->
        <div class="flex items-center bg-gray-100 rounded-lg p-1" id="ca-period-selector-wrapper">
          <button data-period="7j" class="ca-period-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800">7j</button>
          <button data-period="30j" class="ca-period-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200 bg-blue-600 text-white shadow-sm">30j</button>
          <button data-period="90j" class="ca-period-btn px-3 py-1.5 text-sm font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-800">90j</button>
        </div>
      </div>
    </div>

    <!-- Canvas pour Chart.js -->
    <div class="relative h-64">
      <canvas id="vue-generale-ca-evolution-chart" class="w-full h-full"></canvas>
    </div> <!-- L√©gende/R√©sum√© - Donn√©es dynamiques -->
    <div class="mt-4 grid grid-cols-3 gap-4 pt-4 border-t border-gray-100" id="ca-evolution-summary">
      <div class="text-center">
        <div class="text-2xl font-bold text-blue-600" id="ca-ce-mois">--</div>
        <div class="text-sm text-gray-600">Ce mois</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-green-600" id="ca-croissance">--%</div>
        <div class="text-sm text-gray-600">Tendance</div>
      </div>
      <div class="text-center">
        <div class="text-2xl font-bold text-purple-600" id="ca-annee">--</div>
        <div class="text-sm text-gray-600">30 derniers jours</div>
      </div>
    </div>
  </div>
  <!-- Performance par R√©gion (Donn√©es Dynamiques) -->
  <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h3 class="text-lg font-semibold text-gray-900">üåç Performance par R√©gion</h3>
        <p class="text-sm text-gray-600">R√©partition CA - 30 derniers jours</p>
      </div>
      <div class="flex items-center gap-2">
        <div class="text-sm text-gray-500" id="regions-stats">
          <i class="fas fa-chart-pie text-blue-500"></i>
          <span>Chargement...</span>
        </div>
      </div>
    </div>

    <!-- Graphique en barres pour les r√©gions -->
    <div class="relative h-64" id="regions-chart-container">
      <div class="h-full flex items-center justify-center text-gray-500">
        <div class="text-center">
          <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
          <p>Chargement des donn√©es...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Section supprim√©e: Alertes, Activit√© et √âquipe Active (donn√©es statiques) -->
<!-- Ces sections seront impl√©ment√©es plus tard avec des donn√©es dynamiques -->

<!-- Script pour initialiser les graphiques avec donn√©es r√©elles -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Variables globales pour le graphique
    let caEvolutionChart = null
    // Initialiser le graphique Evolution CA avec donn√©es r√©elles
    function initEvolutionCAChart() {
      loadEvolutionData('30j')
    }
  
    // Mettre √† jour le r√©sum√© avec les donn√©es r√©elles
    function updateEvolutionSummary(data) {
      const resume = data.resume
  
      // CA du mois en cours (approximation bas√©e sur les 30 derniers jours)
      const caMois = resume.ca_total
      document.getElementById('ca-ce-mois').textContent = formatCurrency(caMois)
  
      // Tendance
      const tendance = resume.tendance || 0
      const tendanceElement = document.getElementById('ca-croissance')
      tendanceElement.textContent = (tendance >= 0 ? '+' : '') + tendance.toFixed(1) + '%'
      tendanceElement.className = `text-2xl font-bold ${tendance >= 0 ? 'text-green-600' : 'text-red-600'}`
  
      // CA des 30 derniers jours
      document.getElementById('ca-annee').textContent = formatCurrency(caMois)
    }
  
    // Afficher une erreur si les donn√©es ne peuvent pas √™tre charg√©es
    function showEvolutionError() {
      const ctx = document.getElementById('vue-generale-ca-evolution-chart')
      if (ctx) {
        const parent = ctx.parentElement
        parent.innerHTML = `
                                                                            <div class="h-64 flex items-center justify-center text-gray-500">
                                                                              <div class="text-center">
                                                                                <i class="fas fa-chart-line text-4xl mb-2"></i>
                                                                                <p>Donn√©es en cours de chargement...</p>
                                                                                <p class="text-sm">ou aucune donn√©e disponible</p>
                                                                              </div>
                                                                            </div>
                                                                          `
      }
  
      // Valeurs par d√©faut pour le r√©sum√©
      document.getElementById('ca-ce-mois').textContent = '0 DH'
      document.getElementById('ca-croissance').textContent = '0%'
      document.getElementById('ca-annee').textContent = '0 DH'
    }
  
    // Fonction utilitaire pour formater les montants
    function formatCurrency(amount) {
      if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M DH'
      } else if (amount >= 1000) {
        return (amount / 1000).toFixed(0) + 'K DH'
      }
      return amount.toLocaleString() + ' DH'
    }
  
    // Initialiser le graphique
    initEvolutionCAChart()
  
    // G√©rer le changement de p√©riode avec les nouveaux boutons
    const periodButtons = document.querySelectorAll('.ca-period-btn')
    if (periodButtons.length > 0) {
      periodButtons.forEach((button) => {
        button.addEventListener('click', function () {
          const newPeriod = this.dataset.period
  
          // Mettre √† jour l'√©tat visuel des boutons
          periodButtons.forEach((btn) => {
            btn.classList.remove('bg-blue-600', 'text-white', 'shadow-sm')
            btn.classList.add('text-gray-600', 'hover:text-gray-800')
          })
  
          // Activer le bouton s√©lectionn√©
          this.classList.add('bg-blue-600', 'text-white', 'shadow-sm')
          this.classList.remove('text-gray-600', 'hover:text-gray-800')
  
          // D√©truire l'ancien graphique
          if (caEvolutionChart) {
            caEvolutionChart.destroy()
          }
  
          // Recharger avec la nouvelle p√©riode
          loadEvolutionData(newPeriod)
        })
      })
    }
  
    // Fonction pour charger les donn√©es avec une p√©riode sp√©cifique
    function loadEvolutionData(period = '30j') {
      const ctx = document.getElementById('vue-generale-ca-evolution-chart')
      if (!ctx || typeof Chart === 'undefined') {
        console.warn('Chart.js non disponible ou canvas non trouv√©')
        return
      }
  
      // Afficher un indicateur de chargement
      const parent = ctx.parentElement
      const originalContent = parent.innerHTML
      parent.innerHTML = `
                                                                          <div class="h-64 flex items-center justify-center text-gray-500">
                                                                            <div class="text-center">
                                                                              <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                                                              <p>Chargement des donn√©es...</p>
                                                                            </div>
                                                                          </div>
                                                                        `
  
      fetch(`/kpis/api/evolution-ca/?period=${period}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Restaurer le canvas
            parent.innerHTML = '<canvas id="vue-generale-ca-evolution-chart" class="w-full h-full"></canvas>'
            const newCtx = document.getElementById('vue-generale-ca-evolution-chart')
  
            // Pr√©parer les donn√©es pour Chart.js
            const labels = data.evolution.map((d) => d.date_formatee)
            const values = data.evolution.map((d) => d.ca)
  
            // Cr√©er le nouveau graphique
            caEvolutionChart = new Chart(newCtx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  {
                    label: 'CA Quotidien (DH)',
                    data: values,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                  }
                ]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  },
                  tooltip: {
                    callbacks: {
                      label: function (context) {
                        return `CA: ${context.parsed.y.toLocaleString()} DH`
                      }
                    }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: {
                      callback: function (value) {
                        if (value >= 1000000) {
                          return (value / 1000000).toFixed(1) + 'M DH'
                        } else if (value >= 1000) {
                          return (value / 1000).toFixed(0) + 'K DH'
                        }
                        return value + ' DH'
                      }
                    }
                  },
                  x: {
                    ticks: {
                      maxTicksLimit: 10
                    }
                  }
                }
              }
            })
  
            // Mettre √† jour le r√©sum√©
            updateEvolutionSummary(data)
          } else {
            console.error('Erreur API Evolution CA:', data.message)
            parent.innerHTML = originalContent
            showEvolutionError()
          }
        })
        .catch((error) => {
          console.error('Erreur r√©seau Evolution CA:', error)
          parent.innerHTML = originalContent
          showEvolutionError()
        })
    }
  
    // R√©gions : g√©r√©es par dashboard.js pour √©viter les conflits
  })
  
  // Fonctions des r√©gions supprim√©es - g√©r√©es par dashboard.js pour √©viter les conflits
</script>
