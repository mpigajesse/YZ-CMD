{% extends 'composant_generale/admin/base.html' %}
{% load static %}

{% block title %}
  Configuration KPIs - Yoozak
{% endblock %}

{% block page_title %}
  ‚öôÔ∏è Configuration KPIs
{% endblock %}
{% block page_subtitle %}
  Gestion des param√®tres et seuils du Dashboard
{% endblock %}

{% block extra_head %}
  <meta name="csrf-token" content="{{ csrf_token }}" />
{% endblock %}

{% block extra_css %}
  <style>
    .kpi-card {
      @apply bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow duration-300;
    }
    .kpi-icon {
      @apply w-12 h-12 rounded-full flex items-center justify-center text-white text-xl mb-4;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="max-w-7xl mx-auto">
    <!-- Header avec navigation -->
    <div class="flex items-center justify-between mb-8">
      <a href="{% url 'app_admin:home' %}" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all">
        <i class="fas fa-arrow-left"></i>
        <span>Retour</span>
      </a>

      <!--   Bouton Documentation temporairement d√©sactiv√©
      <a href="{% url 'kpis:documentation' %}" class="flex items-center gap-2 px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg transition-all">
        <i class="fas fa-book"></i>
        <span>Documentation</span>
      </a>
        -->
    </div>

    <!-- Configuration des KPIs -->
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">‚öôÔ∏è Configuration des Param√®tres</h2>
      <p class="text-gray-600 mb-6">Personnalisez les seuils et param√®tres de calcul selon vos besoins m√©tier.</p>

      <!-- Bouton de test temporaire -->
      <div class="mb-6 p-4 bg-yellow-100 border border-yellow-300 rounded-lg">
        <h4 class="font-semibold text-yellow-800 mb-2">üß™ Debug Mode</h4>
        <button onclick="testLoadConfigurations()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">Test Charger Configurations</button>
        <button onclick="diagnoseDOMContent()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">Diagnostic DOM</button>
        <button onclick="console.clear()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Clear Console</button>
        <div id="debug-status" class="mt-2 text-sm text-gray-700"></div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6" id="config-form">
        <!-- Seuils d'Alerte -->
        <div class="bg-gray-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-orange-600">üö® Seuils d'Alerte</h3>
          <div class="space-y-4" id="seuils-container">
            <!-- Sera peupl√© dynamiquement -->
          </div>
        </div>

        <!-- Param√®tres de Calcul -->
        <div class="bg-gray-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-blue-600">üßÆ Param√®tres de Calcul</h3>
          <div class="space-y-4" id="calcul-container">
            <!-- Sera peupl√© dynamiquement -->
          </div>
        </div>

        <!-- Pr√©f√©rences d'Affichage -->
        <div class="bg-gray-50 rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-green-600">üé® Pr√©f√©rences d'Affichage</h3>
          <div class="space-y-4" id="affichage-container">
            <!-- Sera peupl√© dynamiquement -->
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
        <button id="btn-reset" onclick="resetConfigurations()" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-all">
          <i class="fas fa-undo"></i>
          <span>Restaurer par d√©faut</span>
        </button>

        <div class="flex gap-3">
          <button id="btn-preview" onclick="previewChanges()" class="flex items-center gap-2 px-4 py-2 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 rounded-lg transition-all">
            <i class="fas fa-eye"></i>
            <span>Aper√ßu</span>
          </button>
          <button id="btn-save" onclick="saveConfigurations()" class="flex items-center gap-2 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all">
            <i class="fas fa-save"></i>
            <span>Sauvegarder</span>
          </button>
        </div>
      </div>

      <!-- Messages de notification -->
      <div id="notification-container" class="mt-4"></div>
    </div>
  </div>

  <script>
    // Variables globales
    let configurations = {}
    let integerFields = [] // Liste des champs qui doivent √™tre des entiers
    let isDirty = false
    
    // Les configurations seront charg√©es quand l'onglet sera activ√©
    document.addEventListener('DOMContentLoaded', function () {
      console.log('üìÑ Page charg√©e - Chargement automatique des configurations')
      console.log('üîç V√©rification des fonctions disponibles:')
      console.log('   - loadConfigurations:', typeof loadConfigurations)
      console.log('   - renderConfigurationForm:', typeof renderConfigurationForm)
      console.log('   - generateConfigField:', typeof generateConfigField)
    
      // Charger automatiquement les configurations
      console.log('üöÄ Chargement automatique des configurations...')
      loadConfigurations()
    })
    
    // Charger les configurations depuis l'API
    async function loadConfigurations() {
      console.log('üöÄ === D√âBUT loadConfigurations() ===')
      try {
        showLoading(true)
        console.log('üîÑ Chargement des configurations...')
        const response = await fetch('/kpis/api/configurations/')
    
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`)
        }
    
        const data = await response.json()
        console.log('üìä R√©ponse API compl√®te:', data)
    
        if (data.success) {
          configurations = data.configurations
          integerFields = data.integer_fields || []
    
          console.log('‚úÖ Configurations charg√©es:', configurations)
          console.log('üî¢ Champs entiers:', integerFields)
    
          // V√©rifier si on a des donn√©es
          let totalConfigs = 0
          Object.keys(configurations).forEach((cat) => {
            totalConfigs += configurations[cat].length
            console.log(`üìÅ ${cat}: ${configurations[cat].length} configurations`)
          })
    
          if (totalConfigs === 0) {
            console.warn('‚ö†Ô∏è Aucune configuration trouv√©e!')
            showNotification('Aucune configuration trouv√©e en base de donn√©es', 'warning')
          } else {
            renderConfigurationForm()
            showNotification('Configurations charg√©es avec succ√®s', 'success')
          }
        } else {
          console.error('‚ùå Erreur API:', data.message)
          showNotification('Erreur lors du chargement: ' + data.message, 'error')
        }
      } catch (error) {
        console.error('‚ùå Erreur:', error)
        showNotification('Erreur de connexion lors du chargement: ' + error.message, 'error')
      } finally {
        showLoading(false)
      }
    }
    
    // Fonction de test pour debug
    function testLoadConfigurations() {
      console.log('üß™ === TEST MANUEL loadConfigurations() ===')
      const statusDiv = document.getElementById('debug-status')
      statusDiv.innerHTML = 'Test en cours...'
    
      // Test √©tape par √©tape
      console.log('1. V√©rification que la fonction existe:', typeof loadConfigurations)
      console.log('2. Appel direct de loadConfigurations()')
    
      try {
        loadConfigurations()
          .then(() => {
            statusDiv.innerHTML = '‚úÖ Test termin√© - V√©rifiez la console'
          })
          .catch((error) => {
            statusDiv.innerHTML = '‚ùå Erreur: ' + error.message
            console.error('‚ùå Erreur test:', error)
          })
      } catch (error) {
        statusDiv.innerHTML = '‚ùå Erreur sync: ' + error.message
        console.error('‚ùå Erreur sync:', error)
      }
    }
    
    // Fonction de diagnostic pour v√©rifier le DOM
    function diagnoseDOMContent() {
      console.log('üîç === DIAGNOSTIC DOM ===')
    
      const containers = ['seuils-container', 'calcul-container', 'affichage-container']
      containers.forEach((containerId) => {
        const container = document.getElementById(containerId)
        console.log(`üìÅ Container ${containerId}:`)
        console.log(`   Existe: ${container !== null}`)
    
        if (container) {
          console.log(`   innerHTML length: ${container.innerHTML.length}`)
          console.log(`   Enfants: ${container.children.length}`)
    
          const inputs = container.querySelectorAll('input')
          const selects = container.querySelectorAll('select')
    
          console.log(`   Inputs trouv√©s: ${inputs.length}`)
          console.log(`   Selects trouv√©s: ${selects.length}`)
    
          // V√©rifier les valeurs des 2 premiers inputs
          inputs.forEach((input, i) => {
            if (i < 2) {
              console.log(`   Input ${i + 1}: id=${input.id}, value="${input.value}", type=${input.type}, checked=${input.checked}`)
            }
          })
    
          // Aper√ßu du contenu HTML (si pas trop long)
          if (container.innerHTML.length > 0 && container.innerHTML.length < 500) {
            console.log(`   HTML preview:`, container.innerHTML.substring(0, 200))
          }
        }
      })
    }
    
    // G√©n√©rer le formulaire de configuration
    function renderConfigurationForm() {
      console.log('üé® G√©n√©ration du formulaire de configuration...')
      console.log('üìä Configurations disponibles:', configurations)
    
      // DEBUG: Afficher les donn√©es re√ßues en d√©tail
      console.log('üîç DEBUGGING - V√©rification des donn√©es:')
      Object.keys(configurations).forEach((cat) => {
        console.log(`   üìÅ ${cat}: ${configurations[cat].length} items`)
        if (configurations[cat].length > 0) {
          configurations[cat].forEach((config, i) => {
            if (i < 2) {
              // Afficher les 2 premiers
              console.log(`      ${i + 1}. ${config.nom_parametre} = ${config.valeur} (${typeof config.valeur})`)
            }
          })
        }
      })
    
      const categories = {
        seuils: {
          container: 'seuils-container',
          colorClass: 'orange'
        },
        calcul: {
          container: 'calcul-container',
          colorClass: 'blue'
        },
        affichage: {
          container: 'affichage-container',
          colorClass: 'green'
        }
      }
    
      let totalFieldsGenerated = 0
    
      Object.keys(categories).forEach((categoryKey) => {
        const container = document.getElementById(categories[categoryKey].container)
        const colorClass = categories[categoryKey].colorClass
    
        console.log(`üìÅ Traitement cat√©gorie: ${categoryKey}`)
        console.log(`   Container trouv√©:`, container !== null)
        console.log(`   Container ID attendu: ${categories[categoryKey].container}`)
        console.log(`   Donn√©es disponibles:`, configurations[categoryKey] !== undefined)
    
        if (!container) {
          console.error(`‚ùå Container non trouv√© pour ${categoryKey}! ID recherch√©: ${categories[categoryKey].container}`)
          return
        }
    
        if (configurations[categoryKey]) {
          console.log(`   Nombre d'items: ${configurations[categoryKey].length}`)
    
          if (configurations[categoryKey].length > 0) {
            console.log(`   üîß G√©n√©ration HTML pour ${categoryKey}...`)
            const html = configurations[categoryKey]
              .map((config, index) => {
                console.log(`      ${index + 1}. G√©n√©ration champ: ${config.nom_parametre} = ${config.valeur}`)
                return generateConfigField(config, colorClass)
              })
              .join('')
            console.log(`   ‚úÖ HTML g√©n√©r√© pour ${categoryKey} (${html.length} caract√®res)`)
    
            // DEBUG: Afficher un extrait du HTML g√©n√©r√©
            const htmlPreview = html.substring(0, 200) + (html.length > 200 ? '...' : '')
            console.log(`   üìù Aper√ßu HTML: ${htmlPreview}`)
    
            console.log(`   üîÑ Insertion du HTML dans le container...`)
            container.innerHTML = html
            console.log(`   ‚úÖ HTML ins√©r√©! Container innerHTML length: ${container.innerHTML.length}`)
    
            totalFieldsGenerated += configurations[categoryKey].length
    
            // V√©rifier que les champs ont bien √©t√© cr√©√©s
            const createdFields = container.querySelectorAll('input, select')
            console.log(`   üéØ Champs cr√©√©s dans ${categoryKey}: ${createdFields.length}`)
            createdFields.forEach((field, i) => {
              if (i < 2) {
                // V√©rifier les 2 premiers champs en d√©tail
                console.log(`      Champ ${i + 1}: type=${field.type}, value="${field.value}", checked=${field.checked}, id=${field.id}`)
    
                // V√©rification sp√©ciale pour les inputs num√©riques
                if (field.type === 'number' && !field.value) {
                  console.warn(`      ‚ö†Ô∏è Champ num√©rique vide! V√©rifier la g√©n√©ration.`)
                }
              }
            })
          } else {
            container.innerHTML = '<div class="text-gray-500 italic p-4">Aucune configuration dans cette cat√©gorie</div>'
            console.log(`   ‚ö†Ô∏è Aucune configuration dans ${categoryKey}`)
          }
        } else {
          // Afficher un message si pas de donn√©es
          container.innerHTML = '<div class="text-gray-500 italic p-4">Cat√©gorie non trouv√©e dans les donn√©es</div>'
          console.error(`   ‚ùå Cat√©gorie ${categoryKey} non trouv√©e dans les donn√©es API`)
        }
      })
    
      console.log(`üî¢ Total de champs g√©n√©r√©s: ${totalFieldsGenerated}`)
    
      if (totalFieldsGenerated === 0) {
        console.error('‚ùå AUCUN CHAMP G√âN√âR√â! V√©rifiez:')
        console.error('   1. Les conteneurs HTML existent')
        console.error('   2. Les donn√©es API sont correctes')
        console.error('   3. Le mapping des cat√©gories')
        console.error('   4. La fonction generateConfigField fonctionne')
        showNotification('Aucun champ de configuration g√©n√©r√©. V√©rifiez les donn√©es.', 'warning')
      } else {
        console.log(`‚úÖ Formulaire g√©n√©r√© avec succ√®s: ${totalFieldsGenerated} champs`)
      }
    
      // Ajouter les listeners pour d√©tecter les changements
      addChangeListeners()
      console.log('‚úÖ Formulaire g√©n√©r√©')
    }
    
    // G√©n√©rer un champ de configuration
    function generateConfigField(config, colorClass) {
      console.log(`üîß G√©n√©ration du champ: ${config.nom_parametre} = ${config.valeur} (${typeof config.valeur})`)
    
      const isBoolean = config.valeur_min === 0 && config.valeur_max === 1
      const isSelect = config.nom_parametre === 'periode_analyse_defaut' || config.nom_parametre === 'rafraichissement_auto'
    
      const div = document.createElement('div')
      div.className = 'bg-white p-4 rounded border'
      div.setAttribute('data-field-id', config.id)
    
      if (isBoolean) {
        const label = document.createElement('label')
        label.className = 'flex items-center'
    
        const input = document.createElement('input')
        input.type = 'checkbox'
        input.id = 'config_' + config.id
        input.setAttribute('data-config-id', config.id)
    
        // D√©finir l'√©tat de la checkbox selon la valeur
        const isChecked = config.valeur == 1 || config.valeur === true || config.valeur === 'true'
        input.checked = isChecked // Pour l'√©l√©ment JS
        if (isChecked) {
          input.setAttribute('checked', 'checked') // Pour l'HTML
        }
        console.log(`${isChecked ? '‚òëÔ∏è' : '‚òê'} Checkbox ${config.nom_parametre}: ${config.valeur} -> ${isChecked ? 'coch√©e' : 'non coch√©e'}`)
    
        input.className = 'mr-2 text-' + colorClass + '-600 focus:ring-' + colorClass + '-500'
    
        const span = document.createElement('span')
        span.className = 'text-sm font-medium text-gray-700'
        span.textContent = config.nom_parametre.replace(/_/g, ' ')
    
        const p = document.createElement('p')
        p.className = 'text-xs text-gray-500 mt-1'
        p.textContent = config.description
    
        // Conteneur pour l'erreur de validation
        const errorDiv = document.createElement('div')
        errorDiv.id = 'error_' + config.id
        errorDiv.className = 'validation-error mt-1 hidden'
    
        label.appendChild(input)
        label.appendChild(span)
        div.appendChild(label)
        div.appendChild(p)
        div.appendChild(errorDiv)
      } else if (isSelect) {
        const label = document.createElement('label')
        label.className = 'block text-sm font-medium text-gray-700 mb-2'
        label.textContent = config.nom_parametre.replace(/_/g, ' ') + (config.unite ? ' (' + config.unite + ')' : '')
    
        const select = document.createElement('select')
        select.id = 'config_' + config.id
        select.setAttribute('data-config-id', config.id)
        select.className = 'w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-' + colorClass + '-500 focus:border-' + colorClass + '-500'
    
        let options = []
        if (config.nom_parametre === 'periode_analyse_defaut') {
          options = [7, 15, 30, 60, 90].map((val) => ({ value: val, label: val + ' jours' }))
        } else if (config.nom_parametre === 'rafraichissement_auto') {
          options = [
            { value: 1, label: '1 minute' },
            { value: 2, label: '2 minutes' },
            { value: 5, label: '5 minutes' },
            { value: 10, label: '10 minutes' },
            { value: 0, label: 'D√©sactiv√©' }
          ]
        }
    
        options.forEach((opt) => {
          const option = document.createElement('option')
          option.value = opt.value
          option.textContent = opt.label
    
          // Comparaison plus flexible pour la s√©lection
          const currentValue = parseFloat(config.valeur)
          const optionValue = parseFloat(opt.value)
    
          if (currentValue === optionValue) {
            option.selected = true // Pour l'√©l√©ment JS
            option.setAttribute('selected', 'selected') // Pour l'HTML
            console.log(`üéØ Option s√©lectionn√©e pour ${config.nom_parametre}: ${opt.label} (valeur: ${opt.value})`)
          }
          select.appendChild(option)
        })
    
        const p = document.createElement('p')
        p.className = 'text-xs text-gray-500 mt-1'
        p.textContent = config.description
    
        // Conteneur pour l'erreur de validation
        const errorDiv = document.createElement('div')
        errorDiv.id = 'error_' + config.id
        errorDiv.className = 'validation-error mt-1 hidden'
    
        div.appendChild(label)
        div.appendChild(select)
        div.appendChild(p)
        div.appendChild(errorDiv)
      } else {
        // Champs num√©riques (input number)
        const label = document.createElement('label')
        label.className = 'block text-sm font-medium text-gray-700 mb-2'
        label.textContent = config.nom_parametre.replace(/_/g, ' ') + (config.unite ? ' (' + config.unite + ')' : '')
    
        const input = document.createElement('input')
        input.type = 'number'
        input.id = 'config_' + config.id
        input.setAttribute('data-config-id', config.id)
    
        // V√©rifier si c'est un champ entier
        const isIntegerField = integerFields.includes(config.nom_parametre)
        console.log(`üîç Configuration du champ ${config.nom_parametre}:`, {
          valeur: config.valeur,
          type: typeof config.valeur,
          isInteger: isIntegerField
        })
    
        if (isIntegerField) {
          input.step = '1' // Pas de 1 pour les entiers
          input.setAttribute('data-integer', 'true') // Marquer comme entier
    
          // Convertir en entier si possible
          const numValue = parseFloat(config.valeur)
          if (!isNaN(numValue)) {
            const intValue = Math.floor(numValue).toString()
            input.value = intValue // Pour l'√©l√©ment JS
            input.setAttribute('value', intValue) // Pour l'HTML
            console.log(`üî¢ Champ entier ${config.nom_parametre}: ${config.valeur} -> ${intValue}`)
          } else {
            input.value = '0'
            input.setAttribute('value', '0')
            console.log(`‚ö†Ô∏è Champ entier ${config.nom_parametre}: valeur non num√©rique, d√©faut √† 0`)
          }
        } else {
          input.step = '0.1' // D√©cimales autoris√©es pour les autres
    
          const numValue = parseFloat(config.valeur)
          if (!isNaN(numValue)) {
            const strValue = numValue.toString()
            input.value = strValue // Pour l'√©l√©ment JS
            input.setAttribute('value', strValue) // Pour l'HTML
            console.log(`üìä Champ d√©cimal ${config.nom_parametre}: ${config.valeur} -> ${strValue}`)
          } else {
            input.value = '0'
            input.setAttribute('value', '0')
            console.log(`‚ö†Ô∏è Champ d√©cimal ${config.nom_parametre}: valeur non num√©rique, d√©faut √† 0`)
          }
        }
    
        // D√©finir les limites min/max
        if (config.valeur_min !== null && config.valeur_min !== undefined) {
          input.min = config.valeur_min.toString()
        }
        if (config.valeur_max !== null && config.valeur_max !== undefined) {
          input.max = config.valeur_max.toString()
        }
    
        input.className = 'w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-' + colorClass + '-500 focus:border-' + colorClass + '-500'
    
        const p = document.createElement('p')
        p.className = 'text-xs text-gray-500 mt-1'
        p.textContent = config.description
    
        // Conteneur pour l'erreur de validation
        const errorDiv = document.createElement('div')
        errorDiv.id = 'error_' + config.id
        errorDiv.className = 'validation-error mt-1 hidden'
    
        div.appendChild(label)
        div.appendChild(input)
        div.appendChild(p)
        div.appendChild(errorDiv)
      }
    
      return div.outerHTML
    }
    
    // Ajouter les listeners de changement
    function addChangeListeners() {
      document.querySelectorAll('[data-config-id]').forEach((input) => {
        input.addEventListener('change', () => {
          isDirty = true
          updateSaveButtonState()
          // Nettoyer l'erreur de validation pour ce champ
          clearFieldError(input.dataset.configId)
        })
    
        // Nettoyer l'erreur aussi quand l'utilisateur tape (pour les inputs num√©riques)
        if (input.type === 'number') {
          input.addEventListener('input', () => {
            clearFieldError(input.dataset.configId)
          })
        }
      })
    }
    
    // Fonction pour nettoyer l'erreur d'un champ sp√©cifique
    function clearFieldError(configId) {
      const errorDiv = document.getElementById('error_' + configId)
      const inputElement = document.getElementById('config_' + configId)
    
      if (errorDiv && inputElement) {
        errorDiv.classList.add('hidden')
        errorDiv.textContent = ''
        inputElement.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500')
      }
    }
    
    // Mettre √† jour l'√©tat du bouton sauvegarder
    function updateSaveButtonState() {
      const saveBtn = document.getElementById('btn-save')
      if (isDirty) {
        saveBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700')
        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700')
        saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Sauvegarder *</span>'
      } else {
        saveBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700')
        saveBtn.classList.add('bg-green-600', 'hover:bg-green-700')
        saveBtn.innerHTML = '<i class="fas fa-save"></i><span>Sauvegarder</span>'
      }
    }
    
    // Fonction pour nettoyer les erreurs de validation
    function clearValidationErrors() {
      document.querySelectorAll('.validation-error').forEach((errorDiv) => {
        errorDiv.classList.add('hidden')
        errorDiv.textContent = ''
      })
      // Remettre les bordures normales
      document.querySelectorAll('[data-config-id]').forEach((input) => {
        input.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500')
      })
    }
    
    // Fonction pour afficher une erreur sur un champ sp√©cifique
    function showFieldError(configId, errorMessage) {
      const errorDiv = document.getElementById('error_' + configId)
      const inputElement = document.getElementById('config_' + configId)
    
      if (errorDiv && inputElement) {
        // Afficher l'erreur
        errorDiv.textContent = errorMessage
        errorDiv.classList.remove('hidden')
        errorDiv.className = 'text-xs text-red-600 mt-1 bg-red-50 p-2 rounded border border-red-200'
    
        // Mettre en surbrillance le champ en erreur
        inputElement.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500')
    
        // Faire d√©filer vers le premier champ en erreur
        inputElement.scrollIntoView({ behavior: 'smooth', block: 'center' })
    
        // Focus sur le champ
        setTimeout(() => {
          inputElement.focus()
        }, 500)
      }
    }
    
    // Sauvegarder les configurations
    async function saveConfigurations() {
      if (!isDirty) {
        showNotification('Aucune modification √† sauvegarder', 'info')
        return
      }
    
      // Nettoyer les erreurs pr√©c√©dentes
      clearValidationErrors()
    
      try {
        showLoading(true)
    
        // V√©rifier le token CSRF
        const csrfToken = getCookie('csrftoken')
        if (!csrfToken) {
          showNotification('‚ùå Token CSRF manquant. Veuillez recharger la page.', 'error')
          return
        }
        console.log('üîê Token CSRF trouv√©:', csrfToken.substring(0, 10) + '...')
    
        // Collecter les valeurs actuelles
        const updatedConfigs = []
        document.querySelectorAll('[data-config-id]').forEach((input) => {
          const configId = input.dataset.configId
          let value
    
          if (input.type === 'checkbox') {
            value = input.checked ? 1 : 0
          } else {
            // V√©rifier si c'est un champ entier
            const isIntegerField = input.hasAttribute('data-integer')
            if (isIntegerField) {
              // Convertir en entier pour les champs entiers
              value = parseInt(input.value) || 0
            } else {
              // Laisser en d√©cimal pour les autres champs
              value = parseFloat(input.value) || 0
            }
          }
          updatedConfigs.push({
            id: parseInt(configId),
            valeur: value
          })
        })
    
        const response = await fetch('/kpis/api/configurations/save/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            configurations: updatedConfigs
          })
        })
    
        console.log('üì° R√©ponse serveur:', response.status, response.statusText)
    
        // V√©rifier si la r√©ponse est bien du JSON
        const contentType = response.headers.get('content-type')
        if (!contentType || !contentType.includes('application/json')) {
          console.error('‚ùå R√©ponse non-JSON:', contentType)
          const textResponse = await response.text()
          console.error('üìÑ Contenu de la r√©ponse:', textResponse.substring(0, 500))
          showNotification('‚ùå Erreur serveur: r√©ponse non-JSON re√ßue', 'error')
          return
        }
    
        const data = await response.json()
        if (data.success) {
          isDirty = false
          updateSaveButtonState()
          showNotification('‚úÖ ' + data.message, 'success')
          // Recharger pour avoir les donn√©es fra√Æches
          await loadConfigurations()
        } else {
          // Affichage des erreurs de validation
          if (data.field_errors && Object.keys(data.field_errors).length > 0) {
            // Erreurs sp√©cifiques par champ
            let firstErrorField = null
            Object.entries(data.field_errors).forEach(([configId, errorMessage]) => {
              showFieldError(configId, errorMessage)
              if (!firstErrorField) firstErrorField = configId
            })
            showNotification('‚ùå Veuillez corriger les erreurs de validation', 'error')
          } else {
            // Erreur g√©n√©rale
            showNotification('‚ùå ' + data.message, 'error')
          }
    
          // Erreurs additionnelles (liste)
          if (data.errors && data.errors.length > 0) {
            data.errors.forEach((error) => {
              showNotification('‚ö†Ô∏è ' + error, 'warning')
            })
          }
        }
      } catch (error) {
        console.error('Erreur:', error)
        showNotification('‚ùå Erreur de connexion lors de la sauvegarde', 'error')
      } finally {
        showLoading(false)
      }
    }
    
    // Restaurer les configurations par d√©faut
    async function resetConfigurations() {
      if (!confirm('√ätes-vous s√ªr de vouloir restaurer toutes les configurations par d√©faut ?\\nCette action ne peut pas √™tre annul√©e.')) {
        return
      }
      try {
        showLoading(true)
    
        // V√©rifier le token CSRF
        const csrfToken = getCookie('csrftoken')
        if (!csrfToken) {
          showNotification('‚ùå Token CSRF manquant. Veuillez recharger la page.', 'error')
          return
        }
    
        const response = await fetch('/kpis/api/configurations/reset/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          }
        })
    
        const data = await response.json()
        if (data.success) {
          isDirty = false
          updateSaveButtonState()
          showNotification('‚úÖ ' + data.message, 'success')
          // Recharger les configurations
          await loadConfigurations()
        } else {
          showNotification('‚ùå ' + data.message, 'error')
        }
      } catch (error) {
        console.error('Erreur:', error)
        showNotification('‚ùå Erreur de connexion lors de la restauration', 'error')
      } finally {
        showLoading(false)
      }
    }
    
    // Aper√ßu des changements
    function previewChanges() {
      if (!isDirty) {
        showNotification('Aucune modification √† pr√©visualiser', 'info')
        return
      }
    
      let changes = []
      document.querySelectorAll('[data-config-id]').forEach((input) => {
        const configId = input.dataset.configId
    
        // Trouver la configuration originale
        let originalConfig = null
        Object.values(configurations).forEach((category) => {
          category.forEach((config) => {
            if (config.id == configId) {
              originalConfig = config
            }
          })
        })
    
        if (originalConfig) {
          let currentValue
          if (input.type === 'checkbox') {
            currentValue = input.checked ? 1 : 0
          } else {
            currentValue = parseFloat(input.value) || 0
          }
    
          if (currentValue != originalConfig.valeur) {
            changes.push({
              nom: originalConfig.nom_parametre.replace(/_/g, ' '),
              ancienne: originalConfig.valeur,
              nouvelle: currentValue,
              unite: originalConfig.unite || ''
            })
          }
        }
      })
    
      if (changes.length === 0) {
        showNotification('Aucune modification d√©tect√©e', 'info')
        return
      }
    
      let message = 'Modifications √† appliquer (' + changes.length + '):\\n\\n'
      changes.forEach((change) => {
        message += '‚Ä¢ ' + change.nom + ': ' + change.ancienne + change.unite + ' ‚Üí ' + change.nouvelle + change.unite + '\\n'
      })
    
      alert(message)
    }
    
    // Afficher/masquer le loading
    function showLoading(show) {
      const buttons = ['btn-save', 'btn-reset', 'btn-preview']
      buttons.forEach((btnId) => {
        const btn = document.getElementById(btnId)
        if (btn) {
          btn.disabled = show
          if (show) {
            btn.style.opacity = '0.6'
            btn.style.cursor = 'not-allowed'
          } else {
            btn.style.opacity = '1'
            btn.style.cursor = 'pointer'
          }
        }
      })
    }
    
    // Afficher une notification
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notification-container')
    
      const colors = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      }
    
      const notification = document.createElement('div')
      notification.className = colors[type] + ' border rounded-lg p-4 mb-2 transition-all duration-300'
      notification.innerHTML = '<div class="flex items-start justify-between">' + '<span class="text-sm">' + message + '</span>' + '<button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-500 hover:text-gray-700">' + '<i class="fas fa-times text-xs"></i>' + '</button>' + '</div>'
    
      container.appendChild(notification)
    
      // Auto-suppression apr√®s 5 secondes pour les messages de succ√®s
      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove()
          }
        }, 5000)
      }
    }
    
    // Fonction utilitaire pour r√©cup√©rer le token CSRF
    function getCookie(name) {
      let cookieValue = null
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';')
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim()
          if (cookie.substring(0, name.length + 1) === name + '=') {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1))
            break
          }
        }
      }
    
      // Fallback: essayer de r√©cup√©rer depuis les m√©tadonn√©es
      if (!cookieValue && name === 'csrftoken') {
        const metaTag = document.querySelector('meta[name="csrf-token"]')
        if (metaTag) {
          cookieValue = metaTag.getAttribute('content')
        }
      }
    
      return cookieValue
    }
    
    // Pr√©venir la fermeture avec modifications non sauvegard√©es
    window.addEventListener('beforeunload', function (e) {
      if (isDirty) {
        e.preventDefault()
        e.returnValue = 'Vous avez des modifications non sauvegard√©es. √ätes-vous s√ªr de vouloir quitter ?'
      }
    })
  </script>
{% endblock %}
