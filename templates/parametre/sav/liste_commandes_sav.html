{% extends 'composant_generale/admin/base.html' %}
{% load static %}

{% block title %}{{ title }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-fadeInUp {
        animation: fadeInUp 0.6s ease-out forwards;
    }
    
    .badge-{{ color }}-500 {
        background-color: {% if color == 'red' %}#EF4444{% elif color == 'orange' %}#F59E0B{% elif color == 'yellow' %}#EAB308{% elif color == 'green' %}#10B981{% elif color == 'blue' %}#3B82F6{% else %}#6B7280{% endif %};
    }
</style>
<script src="{% static 'js/sav-search.js' %}"></script>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg animate-fadeInUp" style="background: linear-gradient(to right, var(--admin-gradient-start), var(--admin-gradient-end));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas {{ icon }} mr-3" style="color: var(--admin-accent-color);"></i>
                {{ title }}
            </h1>
            <p style="color: var(--admin-accent-color);">{{ subtitle }}</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <a href="{% url 'app_admin:home' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                <i class="fas fa-arrow-left mr-2"></i> Retour Dashboard
            </a>
        </div>
    </div>

    <!-- Barre de recherche flexible -->
    {% include 'parametre/sav/_search_bar.html' %}

    <!-- Statistiques -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-{{ color }}-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-{{ color }}-100 text-{{ color }}-600">
                    <i class="fas {{ icon }} text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total</p>
                    <p class="text-2xl font-bold text-gray-900">{{ page_obj.paginator.count }}</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-calendar-day text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Aujourd'hui</p>
                    <p class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-chart-line text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Cette semaine</p>
                    <p class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-euro-sign text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Montant total</p>
                    <p class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des commandes -->
    <div class="bg-white rounded-xl shadow-lg border overflow-hidden animate-fadeInUp">
        <div class="p-6 border-b">
            <h3 class="text-xl font-semibold text-gray-800">Liste des commandes</h3>
            <p class="text-sm text-gray-600 mt-1">{{ page_obj.paginator.count }} commande{{ page_obj.paginator.count|pluralize }} au total</p>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead style="background: linear-gradient(135deg, #023535, #034a4a);">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">#</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID YZ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Téléphone</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Panier</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État actuel</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="commandeTableBody">
                    {% include 'parametre/sav/partials/_commande_table_body.html' %}
                </tbody>
            </table>
        </div>
                            </div>

    <!-- Contrôles de pagination flexible (style Excel) -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 p-4 mb-6 transition-all duration-300 hover:shadow-xl">
        <div class="flex flex-col lg:flex-row items-center justify-between space-y-4 lg:space-y-0">
            <!-- Section Éléments par page -->
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-list-ol text-sm" style="color: var(--admin-color);"></i>
                    <label class="text-xs font-semibold text-gray-700">Éléments par page:</label>
                                    </div>
                <select id="itemsPerPageSelect" class="px-3 py-1.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                    <option value="10" {% if items_per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if items_per_page == 20 %}selected{% endif %}>20</option>
                    <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100</option>
                    <option value="250" {% if items_per_page == 250 %}selected{% endif %}>250</option>
                    <option value="500" {% if items_per_page == 500 %}selected{% endif %}>500</option>
                    <option value="1000" {% if items_per_page == 1000 %}selected{% endif %}>1000</option>
                    <option value="all" {% if items_per_page == 'all' %}selected{% endif %}>Tous</option>
                </select>
                            </div>
            
            <!-- Section Plage personnalisée -->
            <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-arrows-alt-h text-sm" style="color: var(--admin-color);"></i>
                    <label class="text-xs font-semibold text-gray-700">Plage personnalisée:</label>
                </div>
                <div class="flex items-center space-x-2 bg-gray-50 rounded-lg p-2 border border-gray-200">
                    <div class="flex items-center space-x-2">
                        <input type="number" id="startRangeInput" placeholder="Début" min="1" value="{{ start_range|default:'' }}" 
                               class="px-2 py-1 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-16 text-center bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" 
                               style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                        <span class="text-gray-500 text-xs font-medium">à</span>
                        <input type="number" id="endRangeInput" placeholder="Fin" min="1" value="{{ end_range|default:'' }}" 
                               class="px-2 py-1 border border-gray-200 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-16 text-center bg-white shadow-sm transition-all duration-200 hover:border-gray-300 focus:shadow-md text-sm" 
                               style="color: var(--admin-color); border-color: var(--admin-light-accent);">
                    </div>
                    <div class="flex items-center space-x-1">
                        <button id="applyRangeBtn" class="px-3 py-1 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-md hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md text-xs font-medium">
                            <i class="fas fa-check mr-1"></i>Appliquer
                                    </button>
                        <button id="clearRangeBtn" class="px-3 py-1 bg-gradient-to-r from-red-400 to-red-500 text-white rounded-md hover:from-red-500 hover:to-red-600 transition-all duration-200 transform hover:scale-105 shadow-sm hover:shadow-md text-xs font-medium">
                            <i class="fas fa-times mr-1"></i>Effacer
                                    </button>
                    </div>
                </div>
            </div>
            
            <!-- Section Statistiques -->
            <div class="flex items-center space-x-2">
                <div class="flex items-center space-x-2 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-3 py-1.5 border border-blue-200">
                    <i class="fas fa-chart-bar text-sm" style="color: var(--admin-color);"></i>
                    <span class="text-xs font-semibold text-gray-700">Total: <span class="text-blue-600 font-bold">{{ page_obj.paginator.count }}</span> commandes</span>
                </div>
            </div>
        </div>
        
        <!-- Indicateur de statut -->
        <div class="mt-3 pt-3 border-t border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-xs text-gray-600">Pagination active</span>
                    </div>
                    {% if start_range and end_range %}
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-filter text-xs text-blue-500"></i>
                        <span class="text-xs text-blue-600 font-medium">Plage personnalisée: {{ start_range }} - {{ end_range }}</span>
                    </div>
                                {% endif %}
                            </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-info-circle text-xs text-gray-400"></i>
                    <span class="text-xs text-gray-500">Utilisez les contrôles ci-dessus pour personnaliser l'affichage</span>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Pagination -->
    <div id="paginationControls" class="flex justify-center mt-8">
        {% include 'parametre/sav/partials/_pagination.html' %}
                </div>

    <!-- Informations de pagination -->
    <div id="totalCommandsDisplay" class="flex justify-center mt-4">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg px-4 py-2 border border-blue-200 shadow-sm">
            <div class="flex items-center space-x-2">
                <i class="fas fa-info-circle text-sm" style="color: var(--admin-color);"></i>
                <span id="paginationInfo" class="text-sm font-medium text-gray-700">
                    Affichage de <span class="font-bold text-blue-600">{{ page_obj.start_index }}</span> à <span class="font-bold text-blue-600">{{ page_obj.end_index }}</span> sur <span class="font-bold text-blue-600">{{ page_obj.paginator.count }}</span> commandes
                                </span>
                </div>
            </div>
    </div>
</div>

<!-- Modal pour créer une commande SAV -->
<div id="savModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="savForm" method="post" action="">
                {% csrf_token %}
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-plus-circle text-green-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Créer une commande SAV
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Créer une nouvelle commande pour les articles défectueux de la commande <span id="commandeNum"></span>.
                                </p>
                                <div class="mt-4">
                                    <label class="block text-sm font-medium text-gray-700">Articles défectueux</label>
                                    <input type="hidden" name="articles_defectueux" id="articlesDefectueux" value="[]">
                                    <div id="articlesContainer" class="mt-2 space-y-2">
                                        <!-- Articles seront ajoutés dynamiquement -->
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label for="commentaire" class="block text-sm font-medium text-gray-700">Commentaire</label>
                                    <textarea name="commentaire" id="commentaire" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Détails sur les défauts..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Créer commande SAV
                    </button>
                    <button type="button" onclick="closeSavModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour renvoyer en préparation -->
<div id="preparationModal" class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <form id="preparationForm" method="post" action="">
                {% csrf_token %}
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-redo text-orange-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">
                                Renvoyer en préparation
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">
                                    Renvoyer la commande <span id="preparationCommandeNum"></span> aux opérateurs de préparation.
                                </p>
                                <div class="mt-4">
                                    <label for="modifications" class="block text-sm font-medium text-gray-700">Modifications demandées</label>
                                    <textarea name="modifications" id="modifications" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Détails des modifications..."></textarea>
                                </div>
                                <div class="mt-4">
                                    <label for="commentairePreparation" class="block text-sm font-medium text-gray-700">Commentaire</label>
                                    <textarea name="commentaire" id="commentairePreparation" rows="2" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500 sm:text-sm" placeholder="Commentaire additionnel..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="submit" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-orange-600 text-base font-medium text-white hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Renvoyer en préparation
                    </button>
                    <button type="button" onclick="closePreparationModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openSavModal(commandeId, commandeNum) {
    document.getElementById('commandeNum').textContent = commandeNum;
    document.getElementById('savForm').action = "{% url 'app_admin:sav_creer_nouvelle_commande' 0 %}".replace('0', commandeId);
    document.getElementById('savModal').classList.remove('hidden');
    
    // Charger les articles de la commande via AJAX
    fetch(`/commande/api/panier/${commandeId}/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('articlesContainer');
            container.innerHTML = '';
            const articles = [];
            
            data.paniers.forEach(panier => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="checkbox" id="article_${panier.article.id}" class="article-checkbox" 
                           data-id="${panier.article.id}" data-max="${panier.quantite}">
                    <label for="article_${panier.article.id}" class="flex-1 text-sm">
                        ${panier.article.nom} (Max: ${panier.quantite})
                    </label>
                    <input type="number" min="1" max="${panier.quantite}" value="1" 
                           class="quantite-input w-20 border-gray-300 rounded text-sm" 
                           data-id="${panier.article.id}" disabled>
                `;
                container.appendChild(div);
            });
            
            // Événements pour les checkboxes
            document.querySelectorAll('.article-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const quantiteInput = document.querySelector(`.quantite-input[data-id="${this.dataset.id}"]`);
                    quantiteInput.disabled = !this.checked;
                    updateArticlesDefectueux();
                });
            });
            
            document.querySelectorAll('.quantite-input').forEach(input => {
                input.addEventListener('change', updateArticlesDefectueux);
            });
        });
}

function updateArticlesDefectueux() {
    const articles = [];
    document.querySelectorAll('.article-checkbox:checked').forEach(checkbox => {
        const quantiteInput = document.querySelector(`.quantite-input[data-id="${checkbox.dataset.id}"]`);
        articles.push({
            article_id: parseInt(checkbox.dataset.id),
            quantite: parseInt(quantiteInput.value)
        });
    });
    document.getElementById('articlesDefectueux').value = JSON.stringify(articles);
}

function closeSavModal() {
    document.getElementById('savModal').classList.add('hidden');
}

function openPreparationModal(commandeId, commandeNum) {
    document.getElementById('preparationCommandeNum').textContent = commandeNum;
    document.getElementById('preparationForm').action = "{% url 'app_admin:sav_renvoyer_preparation' 0 %}".replace('0', commandeId);
    document.getElementById('preparationModal').classList.remove('hidden');
}

function closePreparationModal() {
    document.getElementById('preparationModal').classList.add('hidden');
}

// ==================== GESTION DE LA PAGINATION FLEXIBLE ====================

// Éléments DOM
const commandeTableBody = document.getElementById('commandeTableBody');
const paginationControls = document.getElementById('paginationControls');
const totalCommandsDisplay = document.getElementById('totalCommandsDisplay');
const paginationInfo = document.getElementById('paginationInfo');

// Fonction pour appliquer les filtres avec pagination
async function applyFilters(page = 1) {
    const params = new URLSearchParams();
    
    // Ajouter les paramètres de pagination
    const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
    const startRangeInput = document.getElementById('startRangeInput');
    const endRangeInput = document.getElementById('endRangeInput');
    
    if (itemsPerPageSelect) {
        params.append('items_per_page', itemsPerPageSelect.value);
    }
    
    if (startRangeInput && startRangeInput.value.trim()) {
        params.append('start_range', startRangeInput.value.trim());
    }
    
    if (endRangeInput && endRangeInput.value.trim()) {
        params.append('end_range', endRangeInput.value.trim());
    }
    
    params.append('page', page);

    try {
        const response = await fetch(`${window.location.pathname}?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }

        const data = await response.json();
        
        // Vérifier que toutes les propriétés nécessaires sont présentes
        if (!data.html_table_body || !data.html_pagination) {
            throw new Error('Réponse incomplète du serveur');
        }
        
        // Mettre à jour le tableau
        commandeTableBody.innerHTML = data.html_table_body;
        
        // Mettre à jour la pagination
        paginationControls.innerHTML = data.html_pagination;
        
        // Mettre à jour l'affichage des informations de pagination
        if (paginationInfo && data.total_commands_display) {
            try {
                const parts = data.total_commands_display.split(' ');
                if (parts.length >= 7) {
                    paginationInfo.innerHTML = `
                        Affichage de <span class="font-bold text-blue-600">${parts[2]}</span> à <span class="font-bold text-blue-600">${parts[4]}</span> sur <span class="font-bold text-blue-600">${parts[6]}</span> commandes
                    `;
                } else {
                    // Fallback si le format n'est pas attendu
                    paginationInfo.innerHTML = data.total_commands_display;
                }
            } catch (error) {
                console.warn('Erreur lors du parsing des informations de pagination:', error);
                // Fallback avec le texte brut
                paginationInfo.innerHTML = data.total_commands_display || 'Informations de pagination non disponibles';
            }
        }

        // Réattacher les événements de pagination
        attachPaginationListeners();
        
        // Mettre à jour l'URL sans recharger la page
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, '', newUrl);

    } catch (error) {
        console.error('Erreur lors du chargement des commandes:', error);
        alert('Erreur lors du chargement des commandes: ' + error.message);
    }
}

// Fonction pour attacher les écouteurs d'événements de pagination
function attachPaginationListeners() {
    document.querySelectorAll('#paginationControls a').forEach(link => {
        link.removeEventListener('click', handlePaginationClick);
        link.addEventListener('click', handlePaginationClick);
    });
}

// Gestionnaire de clic sur les liens de pagination
function handlePaginationClick(e) {
    e.preventDefault();
    const url = new URL(this.href);
    const page = url.searchParams.get('page');
    applyFilters(page);
}

// Gestion du changement d'éléments par page
const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
if (itemsPerPageSelect) {
    itemsPerPageSelect.addEventListener('change', function() {
        const newItemsPerPage = this.value;
        const currentParams = new URLSearchParams(window.location.search);
        currentParams.set('items_per_page', newItemsPerPage);
        currentParams.delete('start_range'); // Effacer les plages personnalisées
        currentParams.delete('end_range');
        currentParams.set('page', '1'); // Retour à la première page
        applyFilters(1);
    });
}

// Gestion de l'application d'une plage personnalisée
const applyRangeBtn = document.getElementById('applyRangeBtn');
if (applyRangeBtn) {
    applyRangeBtn.addEventListener('click', function() {
        const startRange = document.getElementById('startRangeInput').value.trim();
        const endRange = document.getElementById('endRangeInput').value.trim();
        
        if (!startRange || !endRange) {
            alert('Veuillez saisir une plage valide (début et fin)');
            return;
        }
        
        const start = parseInt(startRange);
        const end = parseInt(endRange);
        
        if (isNaN(start) || isNaN(end) || start < 1 || end < start) {
            alert('Veuillez saisir une plage valide (début < fin, nombres positifs)');
            return;
        }
        
        applyFilters(1);
    });
}

// Gestion de l'effacement de la plage personnalisée
const clearRangeBtn = document.getElementById('clearRangeBtn');
if (clearRangeBtn) {
    clearRangeBtn.addEventListener('click', function() {
        document.getElementById('startRangeInput').value = '';
        document.getElementById('endRangeInput').value = '';
        applyFilters(1);
    });
}

// Gestion de l'appui sur Entrée dans les champs de plage
const startRangeInput = document.getElementById('startRangeInput');
const endRangeInput = document.getElementById('endRangeInput');

[startRangeInput, endRangeInput].forEach(input => {
    if (input) {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyRangeBtn.click();
            }
        });
    }
});

// Attacher les écouteurs d'événements de pagination au chargement
document.addEventListener('DOMContentLoaded', function() {
    attachPaginationListeners();
});
</script>
{% endblock %} 