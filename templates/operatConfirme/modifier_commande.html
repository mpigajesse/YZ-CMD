{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}
{% load commande_filters %}

{% block title %}Modifier Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .verification-item {
        transition: all 0.3s ease;
    }
    
    .verification-item.verified {
        background-color: #dcfce7 !important;
        border-color: #16a34a !important;
    }
    
    .check-icon {
        display: none;
        color: #16a34a;
    }
    
    .verification-item.verified .check-icon {
        display: inline;
    }
    
    .btn-verification {
        background: linear-gradient(to right, #16a34a, #15803d);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-verification:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-operation {
        background-color: #8B5A2B !important;
        color: white !important;
        transition: all 0.3s ease;
    }
    
    .btn-operation:hover {
        background-color: #6d4b3b !important;
        transform: scale(1.05);
    }
    
    .btn-confirm {
        background: linear-gradient(to right, #4B352A, #6d4b3b);
        color: white;
        transition: all 0.3s ease;
    }
    
    .btn-confirm:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Styles pour la modale d'articles - amélioration de l'affichage */
    #articleModal {
        z-index: 9999;
    }
    
    /* Styles pour la barre de navigation personnalisée */
    #articlesScrollContainer {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE/Edge */
    }
    
    #articlesScrollContainer::-webkit-scrollbar {
        display: none; /* Chrome/Safari/Opera */
    }
    
    #customScrollbar {
        opacity: 0.3;
        transition: opacity 0.3s ease;
        pointer-events: auto;
    }
    
    #articlesScrollContainer:hover ~ #customScrollbar,
    #customScrollbar:hover {
        opacity: 1;
    }
    
    #scrollThumb {
        transition: all 0.2s ease;
        position: absolute;
        cursor: grab;
    }
    
    #scrollThumb:active {
        cursor: grabbing;
    }
    
    #scrollThumb:hover {
        background-color: #6b7280;
        transform: scaleX(1.2);
    }
    
    /* Animation pour les boutons de navigation */
    #scrollUp, #scrollDown {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #scrollUp:hover, #scrollDown:hover {
        background-color: #e5e7eb;
        transform: scale(1.1);
    }
    
    /* Amélioration de la visibilité */
    #customScrollbar {
        background-color: #f3f4f6;
        border-left: 1px solid #e5e7eb;
    }
    
    #articleModal .bg-white.rounded-xl {
        max-height: 90vh;
        overflow-y: auto;
    }
    
    /* Animation pour la modale */
    #articleModal.flex {
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.95);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* Amélioration de l'affichage des badges */
    .article-card .gap-2 span {
        white-space: nowrap;
    }
    
    /* Style pour les informations d'article dans la modale */
    #article-info {
        transition: all 0.3s ease;
    }
    
    /* Amélioration du responsiveness */
    @media (max-width: 768px) {
        #articleModal .max-w-2xl {
            margin: 1rem;
            max-width: calc(100% - 2rem);
        }
        
        #article-info .grid-cols-2 {
            grid-template-columns: 1fr;
        }
    }
    
    /* Styles pour la liste déroulante d'articles avec badges */
    #articleSelect option {
        padding: 8px 12px;
        border-radius: 4px;
        margin: 2px 0;
    }
    
    /* Animations pour les badges de légende */
    .filter-badge {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .filter-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .filter-badge.active {
        box-shadow: 0 0 0 2px #3b82f6;
        transform: scale(1.1);
        font-weight: bold;
    }
    
    .filter-badge.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.2), transparent);
        pointer-events: none;
    }
    
    /* Animation de comptage */
    .article-count {
        display: inline-block;
        background: #3b82f6;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 4px;
        font-weight: bold;
        min-width: 20px;
        text-align: center;
    }
    
    /* Animations pour les notifications */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
    }
    
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .animate-fade-out {
        animation: fadeOut 0.3s ease-in-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3" style="color: #f7d9c4;"></i>
                Modifier Commande {{ commande.id_yz }}
            </h1>
            <p style="color: #f7d9c4;">Modification complète des détails de la commande</p>
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold" style="color: #f7d9c4;" id="total_commande_haut_page">{{ commande.total_cmd|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold" style="color: #f7d9c4;" id="compteur-upsell-header">Niveau {{ commande.compteur }}</div>
                <div class="text-sm opacity-80">Upsell actuel</div>
          
            </div>
        </div>
    </div>



    <!-- Formulaire de modification -->
    <form method="post" id="modification-form">
        {% csrf_token %}
        
        <!-- Disposition en une seule colonne pour éliminer les espaces vides -->
        <div class="space-y-6">
            <!-- Section 1: Informations principales (2 colonnes) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Informations de commande -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.3s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-receipt mr-3" style="color: #6d4b3b;"></i>Informations Commande
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID YZ (Non modifiable)</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande (Non modifiable)</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total (Non modifiable)</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    
                   
                    
                    <!-- Bouton de validation pour cette section -->
                    <!-- Bouton supprimé - Section informations-commande -->
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

                <!-- Informations client -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.4s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-user mr-3" style="color: #6d4b3b;"></i>Informations Client
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" name="client_nom" value="{{ commande.client.nom }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" name="client_prenom" value="{{ commande.client.prenom | default:' ' }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro de téléphone</label>
                            <input type="tel" name="client_telephone" value="{{ commande.client.numero_tel }}"
                                   class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                   style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client (Non modifiable)</label>
                            <input type="text" value="{{ commande.ville_init|default:'Non spécifiée' }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-client')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-user-check mr-2"></i>Valider les infos client
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>
            </div>

            <!-- Section 2: Informations de livraison (largeur complète) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.5s;">
                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                        <i class="fas fa-truck mr-3" style="color: #6d4b3b;"></i>Informations Livraison
                    </h3>
                    
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                            <select name="ville_livraison" id="ville-select" onchange="chargerRegionEtFrais()"
                                    class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                    style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;">
                                <option value="">-- Sélectionner une ville --</option>
                                {% for ville in villes %}
                                    <option value="{{ ville.id }}" 
                                            data-region="{{ ville.region.nom_region }}" 
                                            data-frais="{{ ville.frais_livraison|default:0 }}"
                                            {% if commande.ville.id == ville.id %}selected{% endif %}>
                                        {{ ville.nom }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Région (Automatique)</label>
                            <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison (Automatique)</label>
                            <input type="text" id="frais-display" value="{{ commande.ville.frais_livraison|default:0 }} DH" readonly
                                   class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                            <textarea name="adresse_livraison" rows="3"
                                      class="w-full p-3 border rounded-lg focus:ring-2 transition-all" 
                                      style="border-color: #f7d9c4; focus:ring-color: #6d4b3b;"
                                      placeholder="Adresse complète de livraison">{{ commande.adresse }}</textarea>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="validerSection('informations-livraison')" 
                                class="px-4 py-2 text-white rounded-lg font-medium transition-all flex items-center" 
                                style="background: linear-gradient(135deg, #4B352A, #6d4b3b); hover:shadow-lg;">
                            <i class="fas fa-truck mr-2"></i>Valider la livraison
                        </button>
                    </div>
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

            <!-- Section 3: Gestion des Opérations (largeur complète) -->
            <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.6s;">
                                    <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                    <i class="fas fa-cogs mr-3" style="color: #6d4b3b;"></i>Gestion des Opérations de Confirmation
                    </h3>
                    
                    <div class="space-y-6">

                        
                        <!-- Gestion des opérations -->
                        <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <h4 class="text-md font-medium text-blue-800 mb-3">
                                <i class="fas fa-cogs mr-2"></i>Gestion des Opérations de Confirmation
                            </h4>
                            
                            <div id="operations-container" class="space-y-4">
                                <!-- Tableau des opérations -->
                                <div class="overflow-x-auto">
                                    <table class="w-full bg-white rounded-lg shadow-sm border border-gray-200">
                                        <thead>
                                            <tr class="bg-gray-50 border-b border-gray-200">
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-hashtag mr-1"></i>ID
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-cogs mr-1"></i>Type d'opération
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-calendar mr-1"></i>Date d'opération
                                                </th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                    <i class="fas fa-comment mr-1"></i>Commentaire
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="operations-table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Les lignes seront ajoutées dynamiquement par JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Bouton pour ajouter une nouvelle opération -->
                                <div class="text-center mt-4">
                                    <button type="button" onclick="ajouterNouvelleOperation()" 
                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                                        <i class="fas fa-plus mr-2"></i>Ajouter une opération
                                    </button>
                            </div>
                                
                                <!-- Étape 1: Sélection du type principal d'opération -->
                                <div id="type-principal-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fas fa-step-forward mr-2"></i>Choisissez le type d'opération :
                                    </h5>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                        <button type="button" onclick="choisirTypePrincipal('APPEL')" 
                                                class="p-4 border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-phone text-2xl text-blue-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-blue-800">Appel Téléphonique</div>
                                                <div class="text-xs text-blue-600 mt-1">Appels de confirmation client</div>
                                </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('SMS')" 
                                                class="p-4 border-2 border-green-200 bg-green-50 hover:bg-green-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fas fa-sms text-2xl text-green-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-green-800">SMS</div>
                                                <div class="text-xs text-green-600 mt-1">Messages texte courts</div>
                            </div>
                                        </button>
                                        
                                        <button type="button" onclick="choisirTypePrincipal('WHATSAPP')" 
                                                class="p-4 border-2 border-emerald-200 bg-emerald-50 hover:bg-emerald-100 rounded-lg transition-all group">
                                            <div class="text-center">
                                                <i class="fab fa-whatsapp text-2xl text-emerald-600 mb-2 group-hover:scale-110 transition-transform"></i>
                                                <div class="font-medium text-emerald-800">WhatsApp</div>
                                                <div class="text-xs text-emerald-600 mt-1">Messages WhatsApp</div>
                        </div>
                                        </button>
                            </div>
                                    
                                    <div class="mt-4 text-center">
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                    </div>
                                
                                <!-- Étape 2: Sélection de l'opération spécifique -->
                                <div id="operation-selector" class="hidden mt-4 p-4 bg-white rounded-lg border border-gray-300">
                                    <h5 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fab fa-whatsapp mr-2 text-emerald-600"></i>Sélectionnez le type de communication WhatsApp :
                                    </h5>
                                    <div id="operations-list" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                        <!-- Les opérations seront ajoutées dynamiquement par JavaScript -->
                </div>

                                    <div class="mt-4 flex justify-between">
                                        <button type="button" onclick="retourTypePrincipal()" 
                                                class="px-3 py-1 bg-gray-400 hover:bg-gray-500 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-arrow-left mr-1"></i>Retour
                        </button>
                                        <button type="button" onclick="annulerSelectionOperation()" 
                                                class="px-3 py-1 bg-gray-500 hover:bg-gray-600 text-white text-xs rounded transition-colors">
                                            <i class="fas fa-times mr-1"></i>Annuler
                                        </button>
                        </div>
                        </div>
                        
                                <div class="text-center mt-4">
                                    <div class="text-sm text-red-600 mb-2 font-medium">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        IMPORTANT : Chaque opération sélectionnée DOIT avoir un commentaire rédigé par l'opérateur
                            </div>


                        </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton de validation pour cette section -->
                  
                    <i class="fas fa-check-circle check-icon text-2xl float-right"></i>
                </div>

                        <!-- Section 4: Articles de la commande (largeur complète) -->
                <div class="verification-item bg-white rounded-xl shadow-lg p-4 animate-slideInUp" style="animation-delay: 0.8s;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" style="color: #4B352A;">
                            <i class="fas fa-box mr-3" style="color: #6d4b3b;"></i>Articles de la Commande (<span id="articles-count">{{ commande.paniers.count }}</span> article<span id="articles-plural">{{ commande.paniers.count|pluralize }}</span>) 
                        {% if commande.compteur > 0 %}
                        <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                        </span>
                        {% endif %}
                    {% if commande.produit_init %}
                <div class="mt-4">
                            <p class="block text-sm font-medium text-gray-700 mb-2">Produit Initial (Sheets)</p>
                            <div class="w-full p-3 bg-blue-50 border border-blue-200 rounded-lg text-gray-700 whitespace-pre-line">
                    {{ commande.produit_init }}
                            </div>
                    </div>
                    {% endif %}
                        
                        </h3>
                        <div class="flex space-x-3">
                            <button type="button" onclick="ajouterNouvelArticle()" 
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all">
                                <i class="fas fa-plus mr-2"></i>Ajouter un article
                            </button>
                      
                        </div>
                    </div>
                    
                    <!-- Liste des articles existants -->
                    <div id="articles-container" class="space-y-3 mb-6">
                        {% include 'operatConfirme/partials/_articles_section.html' %}
                    </div>

                    <!-- Résumé total avec détail -->
                    <div class="mt-6 p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border">
                        <div class="space-y-2 mb-3 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">
                                    <i class="fas fa-shopping-cart mr-2"></i>Sous-total des articles:
                                </span>
                                <span id="sous-total-articles" class="font-medium text-gray-800">
                                    {{ commande.total_articles|floatformat:2 }} DH
                                </span>
                            </div>
                            <hr class="border-gray-300">
                        </div>

                        <!-- Total final -->
                        <div class="flex justify-between items-center">
                            <div class="text-lg font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-calculator mr-2"></i>Total de la commande:
                            </div>
                            <div class="text-2xl font-bold" style="color: #4B352A;" id="total-commande">
                                {{ commande.total_cmd|floatformat:2 }} DH
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bouton supprimé - Section articles-commande -->
                
                </div>
        </div>

        <!-- Boutons d'action -->
        <div class="flex justify-between items-center mt-6 p-4 bg-white rounded-xl shadow-lg">
            <div class="flex gap-4">
                <a href="{% url 'operatConfirme:confirmation' %}" 
                   class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Retour à la confirmation
                </a>
                

            </div>
            
            <div class="flex gap-4">
                
                {% if commande.etat_actuel.enum_etat.libelle == 'Affectée' %}
                <button type="button" onclick="lancerConfirmation()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
                    <i class="fas fa-play mr-2"></i>
                    Lancer Confirmation
                </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'En cours de confirmation' %}
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                <button type="button" onclick="confirmerCommande()" 
                class="btn-confirm px-6 py-3 rounded-lg font-medium">
            <i class="fas fa-check-circle mr-2"></i>
            Confirmer la Commande
                    </button>
                {% elif commande.etat_actuel.enum_etat.libelle == 'Retour Confirmation' %}
                <button type="button" onclick="annulerCommande()" 
                        class="px-6 py-3 rounded-lg font-medium text-white transition-all" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                    <i class="fas fa-ban mr-2"></i>
                    Annuler la Commande
                </button>
                <button type="button" onclick="confirmerCommande()" 
                class="btn-confirm px-6 py-3 rounded-lg font-medium">
            <i class="fas fa-check-circle mr-2"></i>
            Confirmer la Commande
                    </button>
                {% endif %}
  
                
               
            </div>
        </div>
    </form>
</div>

<!-- Modale de commentaire pour les opérations -->
<div id="commentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-comment text-blue-500 mr-3"></i>
            Commentaire pour <span id="operationName" class="text-blue-600"></span>
        </h3>
        
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Conclusion de l'opérateur
            </label>
            <select id="commentSelect" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">-- Sélectionnez une conclusion --</option>
                <!-- Les options seront remplies dynamiquement selon le type d'opération -->
            </select>
            <div class="mt-1 text-xs text-red-600 font-medium">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Sélection obligatoire - l'opération sera ignorée sans conclusion
            </div>
        </div>
        
        <div class="flex justify-end space-x-3">
            <button onclick="closeCommentModal()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-1"></i>Annuler
            </button>
            <button onclick="saveComment()" 
                    class="px-4 py-2 rounded-lg font-medium transition-all bg-blue-600 hover:bg-blue-700 text-white">
                <i class="fas fa-save mr-1"></i>Enregistrer
            </button>
        </div>
    </div>
</div>

<!-- Modale pour ajouter/modifier un article -->
<div id="articleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-6xl mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
            <div class="flex items-center">
            <i class="fas fa-box text-blue-500 mr-3"></i>
            <span id="articleModalTitle">Ajouter un article</span>
            </div>
            <span id="FermerModalAjouterArticle" class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalAjouterArticle()">
                <i class="fas fa-times text-xl"></i>
            </span>
        </h3>

           <!-- Barre de recherche -->
           <div class="mt-3 mb-3">
            <p class="text-sm text-gray-500 mb-2">Rechercher un article</p>
            <input id="recherche-article-input" type="text" placeholder="Nom, référence, couleur, pointure..." 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   oninput="rechercherArticles(this.value)" />
        </div>
        
        
        <form id="articleForm" class="space-y-4">
                <!-- Sélection d'article (pour nouveaux articles) -->
                <div id="article-selection-field">
                    <!-- Légende des badges -->
                    <div class="mb-3 p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200 shadow-sm">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                             types d'articles :
                        </div>
                         
                        </div>
                        <div class="badge-legend flex justify-between gap-3 text-sm">
                            <span id="filter-all" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 rounded-full font-medium cursor-pointer filter-badge active whitespace-nowrap hover:bg-gray-200 transition-colors" 
                                  onclick="filtrerArticles('all')" title="Afficher tous les articles">
                                🔍 TOUS
                            </span>
                            <span id="filter-promo" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-red-100 text-red-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-red-200 transition-colors" 
                                  onclick="filtrerArticles('promo')" title="Filtrer les articles en promotion">
                                🔥 PROMO
                            </span>
                            <span id="filter-liquidation" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-orange-100 text-orange-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-orange-200 transition-colors" 
                                  onclick="filtrerArticles('liquidation')" title="Filtrer les articles en liquidation">
                                🏷️ LIQUIDATION
                            </span>
                            <span id="filter-test" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-blue-200 transition-colors" 
                                  onclick="filtrerArticles('test')" title="Filtrer les articles en test">
                                🧪 TEST
                            </span>
                            <span id="filter-upsell" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-green-100 text-green-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-green-200 transition-colors" 
                                  onclick="filtrerArticles('upsell')" title="Filtrer les articles upsell">
                                ⬆️ UPSELL
                            </span>
                        </div>
                    </div>
                    
                <!-- Select d'origine conservé (masqué) pour compatibilité -->
                <select id="articleSelect" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hidden">
                        <option value="">-- Sélectionner un article --</option>
                        <!-- Les articles seront chargés dynamiquement -->
                    </select>

                <!-- Section des articles avec navigation fixe -->
                <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
                    <!-- En-tête fixe du tableau -->
                    <div class="bg-gray-50 border-b border-gray-200">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Article</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Prix</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    
                    <!-- Zone de scroll avec barre de navigation personnalisée -->
                    <div class="relative">
                        <!-- Conteneur principal avec scroll -->
                        <div id="articlesScrollContainer" class="max-h-96 overflow-y-auto">
                            <table class="min-w-full">
                                <tbody id="articlesTableBody" class="bg-white divide-y divide-gray-100">
                                    <!-- Lignes d'articles rendues dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Barre de navigation personnalisée -->
                        <div id="customScrollbar" class="absolute right-0 top-0 bottom-0 w-3 bg-gray-100 rounded-r-lg">
                            <div id="scrollThumb" class="w-3 bg-gray-400 rounded-full cursor-pointer hover:bg-gray-500 transition-colors" style="height: 50px; top: 0; position: absolute;"></div>
                        </div>
                    </div>
                    
                    <!-- Indicateur de navigation -->
                    <div class="bg-gray-50 border-t border-gray-200 px-4 py-2 flex items-center justify-between text-xs text-gray-500">
                        <span id="scrollInfo">Articles disponibles</span>
                        <div class="flex items-center space-x-2">
                            <button id="scrollUp" class="p-1 hover:bg-gray-200 rounded" title="Monter">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button id="scrollDown" class="p-1 hover:bg-gray-200 rounded" title="Descendre">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Affichage du nom d'article (pour modifications) -->
                <div id="article-display-field" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Article</label>
                    <input type="text" id="articleDisplay" readonly class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600">
                </div>
                
            <!-- Quantité (masquée car gérée dans le tableau) -->
            <div class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Quantité </label>
                    <input type="number" id="quantiteInput" min="1" step="1" value="1" 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            
            <!-- Informations de l'article sélectionné -->
            <div id="article-info" class="hidden mt-4">
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>Détails de l'article
                    </h4>
                    
                    <!-- Informations principales organisées en cartes -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Carte Informations produit -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-tag mr-2 text-blue-600"></i>Informations produit
                            </h5>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Référence :</span>
                                    <span id="info-reference" class="font-medium text-gray-800"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Prix unitaire :</span>
                                    <span id="info-prix" class="font-bold text-green-600"></span>
                                </div>
                                <div class="flex justify-between border-t pt-2">
                                    <span class="text-gray-700 font-medium">Sous-total :</span>
                                    <span id="info-sous-total" class="font-bold text-blue-600 text-lg"></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Carte Caractéristiques -->
                        <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                            <h5 class="font-medium text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-palette mr-2 text-purple-600"></i>Caractéristiques du produit
                            </h5>
                            
                            <!-- Conteneur pour les badges de caractéristiques -->
                            <div id="caracteristiques-badges" class="flex flex-wrap gap-2 mb-3">
                                <!-- Les badges seront ajoutés dynamiquement par JavaScript -->
                            </div>
                            
                            <!-- Affichage classique formaté -->
                            <div class="space-y-2 text-sm">
                                <div>
                                    <span class="text-gray-700 font-medium">Taille : </span>
                                    <span id="info-pointure" class="text-purple-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Couleur : </span>
                                    <span id="info-couleur" class="text-orange-600 font-medium"></span>
                                </div>
                                <div>
                                    <span class="text-gray-700 font-medium">Catégorie : </span>
                                    <span id="info-categorie" class="text-indigo-600 font-medium"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stock et description -->
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h5 class="font-medium text-gray-800 flex items-center">
                                <i class="fas fa-boxes mr-2 text-teal-600"></i>Stock disponible
                            </h5>
                            <span id="info-stock" class="px-3 py-1 rounded-full font-medium transition-all duration-300"></span>
                        </div>
                        <div class="flex items-center mt-2 mb-2">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div id="stock-progress" class="h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="stock-percentage" class="ml-2 text-xs font-medium"></div>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            Le stock affiché est mis à jour en temps réel depuis la base de données
                        </div>
                        <div id="info-description" class="text-sm text-gray-600 italic"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
// Fonction pour charger automatiquement la région et les frais
function chargerRegionEtFrais() {
    const villeSelect = document.getElementById('ville-select');
    const selectedOption = villeSelect.options[villeSelect.selectedIndex];
    
    if (selectedOption.value) {
        const region = selectedOption.getAttribute('data-region');
        const frais = selectedOption.getAttribute('data-frais');
        
        document.getElementById('region-display').value = region;
        document.getElementById('frais-display').value = frais + ' DH';
        
        // Recalculer le total avec les nouveaux frais de livraison
        mettreAJourTotalCommande();
        
        console.log(`🏙️ Ville changée: ${selectedOption.text}, Frais: ${frais} DH, Région: ${region}`);
    } else {
        document.getElementById('region-display').value = '';
        document.getElementById('frais-display').value = '0 DH';
        
        // Recalculer le total sans frais de livraison
        mettreAJourTotalCommande();
    }
}

// Fonction pour vérifier une section
function verifierSection(section) {
    const sectionElement = document.querySelector(`[onclick="verifierSection('${section}')"]`).closest('.verification-item');
    sectionElement.classList.add('verified');
}

// Fonction pour vérifier toutes les sections
function verifierTout() {
    const sections = document.querySelectorAll('.verification-item');
    sections.forEach(section => {
        section.classList.add('verified');
    });
}

// Variables globales pour la modale
let currentOperationType = '';
let currentOperationName = '';

// Fonction pour ouvrir la modale de commentaire
function openCommentModal(operationType, operationName) {
    console.log('Ouverture modale pour:', operationType, operationName);
    
    try {
        currentOperationType = operationType;
        currentOperationName = operationName;
        
        // Vérifier que la modale existe
        const modal = document.getElementById('commentModal');
        if (!modal) {
            console.error('Modale commentModal introuvable !');
            alert('Erreur : Modale de commentaire introuvable');
            return;
        }
        
        // Mettre à jour le titre de la modale
        const operationNameElement = document.getElementById('operationName');
        if (operationNameElement) {
            operationNameElement.textContent = operationName;
        }
        
        // Remplir la liste déroulante selon le type d'opération
        remplirListeCommentaires(operationType);
        
        // Charger le commentaire existant s'il y en a un
        const commentField = document.getElementById('comment_' + operationType);
        const select = document.getElementById('commentSelect');
        
        if (commentField && select) {
            select.value = commentField.value || '';
        }
        
        // Afficher la modale avec animation
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Force le navigateur à reconnaître les changements
        modal.offsetHeight;
        
        console.log('Modale affichée avec succès');
        
        // Focus sur le select après un délai court
        setTimeout(() => {
            if (select) {
                select.focus();
            }
        }, 150);
        
    } catch (error) {
        console.error('Erreur lors de l\'ouverture de la modale:', error);
        alert('Erreur lors de l\'ouverture de la modale: ' + error.message);
    }
}

// Fonction pour fermer la modale
function closeCommentModal() {
    try {
        const modal = document.getElementById('commentModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        currentOperationType = '';
        currentOperationName = '';
        console.log('Modale fermée');
    } catch (error) {
        console.error('Erreur lors de la fermeture de la modale:', error);
    }
}

// Fonction pour sauvegarder le commentaire
function saveComment() {
    const select = document.getElementById('commentSelect');
    const commentText = (select ? select.value : '').trim();
    
    if (commentText) {
        // Sauvegarder dans le champ hidden
        document.getElementById('comment_' + currentOperationType).value = commentText;
        
        // Mettre à jour l'aperçu
        const previewElement = document.getElementById('preview_' + currentOperationType);
        previewElement.textContent = 'Commentaire: ' + (commentText.length > 50 ? commentText.substring(0, 50) + '...' : commentText);
        previewElement.classList.remove('hidden');
        
        // Cocher automatiquement l'opération si ce n'est pas déjà fait
        document.getElementById('op_' + currentOperationType).checked = true;
    } else {
        // Supprimer le commentaire et l'aperçu
        document.getElementById('comment_' + currentOperationType).value = '';
        document.getElementById('preview_' + currentOperationType).classList.add('hidden');
    }
    
    closeCommentModal();
}

// Variables globales pour le système de tableau
let operationCounter = 1;
let operationsTable = [];

// Variables globales pour le système en deux étapes
let typePrincipalSelectionne = '';

// Fonction pour ajouter une nouvelle opération dans le tableau
function ajouterNouvelleOperation() {
    // Afficher le sélecteur de type principal (Étape 1)
    document.getElementById('type-principal-selector').classList.remove('hidden');
}

// Fonction pour choisir le type principal d'opération (Étape 1)
function choisirTypePrincipal(typePrincipal) {
    typePrincipalSelectionne = typePrincipal;
    
    // Cacher le sélecteur de type principal
    document.getElementById('type-principal-selector').classList.add('hidden');
    
    // Pour WhatsApp, afficher les sous-options
    if (typePrincipal === 'WHATSAPP') {
        // Afficher les opérations spécifiques selon le type choisi
        afficherOperationsSpecifiques(typePrincipal);
        
        // Afficher le sélecteur d'opération (Étape 2)
        document.getElementById('operation-selector').classList.remove('hidden');
    } else {
        // Pour APPEL et SMS, aller directement à la sélection
        console.log(`⚡ Sélection directe pour ${typePrincipal} (pas de sous-menu)`);
        
        if (typePrincipal === 'APPEL') {
            selectionnerTypeOperation('APPEL', 'Appel', 'bg-blue-100 text-blue-800');
        } else if (typePrincipal === 'SMS') {
            selectionnerTypeOperation('ENVOI_SMS', 'Envoi de SMS', 'bg-green-100 text-green-800');
        }
    }
}

// Fonction pour afficher les opérations spécifiques selon le type (uniquement pour WhatsApp)
function afficherOperationsSpecifiques(typePrincipal) {
    const operationsList = document.getElementById('operations-list');
    let operationsHTML = '';
    
    // Cette fonction ne gère maintenant que WhatsApp
    if (typePrincipal === 'WHATSAPP') {
        operationsHTML = `
            <button type="button" onclick="selectionnerTypeOperation('Appel Whatsapp', 'Appel WhatsApp', 'bg-emerald-100 text-emerald-800')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800">
                    <i class="fab fa-whatsapp mr-1"></i>Appel WhatsApp
                </span>
            </button>
            <button type="button" onclick="selectionnerTypeOperation('Message Whatsapp', 'Message WhatsApp', 'bg-emerald-200 text-emerald-900')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-emerald-200 text-emerald-900">
                    <i class="fas fa-message mr-1"></i>Message WhatsApp
                </span>
            </button>
            <button type="button" onclick="selectionnerTypeOperation('Vocal Whatsapp', 'Vocal WhatsApp', 'bg-teal-100 text-teal-800')" 
                    class="p-2 text-xs rounded-lg border hover:bg-gray-50 transition-colors">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                    <i class="fas fa-microphone mr-1"></i>Vocal WhatsApp
                </span>
            </button>
        `;
    } else {
        console.warn(`⚠️ afficherOperationsSpecifiques() appelée pour un type non-WhatsApp: ${typePrincipal}`);
    }
    
    operationsList.innerHTML = operationsHTML;
}

// Fonction pour retourner au choix du type principal
function retourTypePrincipal() {
    // Cacher le sélecteur d'opération
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Afficher à nouveau le sélecteur de type principal
    document.getElementById('type-principal-selector').classList.remove('hidden');
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
}

// Fonction pour annuler la sélection d'opération
function annulerSelectionOperation() {
    // Cacher tous les sélecteurs
    document.getElementById('type-principal-selector').classList.add('hidden');
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
}

// Fonction pour sélectionner un type d'opération
function selectionnerTypeOperation(typeOperation, nomOperation, classeCouleur) {
    // Cacher tous les sélecteurs
    document.getElementById('type-principal-selector').classList.add('hidden');
    document.getElementById('operation-selector').classList.add('hidden');
    
    // Générer un ID unique pour les nouvelles opérations
    const operationId = 'NEW-' + operationCounter.toString().padStart(3, '0');
    operationCounter++;
    
    // Date/heure actuelle
    const maintenant = new Date();
    const dateOperation = maintenant.toLocaleDateString('fr-FR') + ' ' + 
                         maintenant.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
    
    // Ajouter le type principal au nom pour plus de clarté
    const nomComplet = `${typePrincipalSelectionne} - ${nomOperation}`;
    
    // Créer l'objet opération
    const nouvelleOperation = {
        id: operationId,
        type: typeOperation,
        nom: nomComplet,
        classe: classeCouleur,
        date: dateOperation,
        commentaire: '',
        typePrincipal: typePrincipalSelectionne
    };
    
    // Ajouter à la liste
    operationsTable.push(nouvelleOperation);
    
    // Mettre à jour l'affichage du tableau
    mettreAJourTableauOperations();
    
    // Réinitialiser la sélection
    typePrincipalSelectionne = '';
    
    console.log(`✅ Opération ajoutée: ${typeOperation} (${nomComplet})`);
    console.log('🗃️ Types d\'opérations valides en base:', ['APPEL', 'Appel Whatsapp', 'Message Whatsapp', 'Vocal Whatsapp', 'ENVOI_SMS']);
    
    // Ouvrir immédiatement la modale de commentaire
    setTimeout(() => {
        ouvrirModaleCommentaireTableau(operationId, nomComplet);
    }, 100);
}

// Fonction pour mettre à jour l'affichage du tableau
function mettreAJourTableauOperations() {
    const tbody = document.getElementById('operations-table-body');
    
    if (operationsTable.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-2xl mb-2"></i>
                    <div>Aucune opération ajoutée</div>
                    <div class="text-xs">Cliquez sur "Ajouter une opération" pour commencer</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = operationsTable.map(operation => {
        // Déterminer l'icône selon le type principal
        let iconeType = 'fas fa-cogs';
        let couleurType = 'text-gray-600';
        
        if (operation.typePrincipal === 'APPEL') {
            iconeType = 'fas fa-phone';
            couleurType = 'text-blue-600';
        } else if (operation.typePrincipal === 'SMS') {
            iconeType = 'fas fa-sms';
            couleurType = 'text-green-600';
        } else if (operation.typePrincipal === 'WHATSAPP') {
            iconeType = 'fab fa-whatsapp';
            couleurType = 'text-emerald-600';
        }
        
        return `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    <i class="fas fa-hashtag mr-1" style="font-size: 8px;"></i>${operation.id}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">
                <div class="flex items-center space-x-2">
                    <i class="${iconeType} ${couleurType}" title="${operation.typePrincipal || 'Type non défini'}"></i>
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${operation.classe}">
                        ${operation.nom}
                    </span>
                </div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">
                <i class="fas fa-clock mr-1"></i>${operation.date}
            </td>
            <td class="px-4 py-3 text-sm">
                                <div class="flex items-center justify-center">
                        <button type="button" onclick="ouvrirModaleCommentaireTableau('${operation.id}', '${operation.nom}')" 
                                class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center">
                            <i class="fas fa-edit mr-1"></i>
                            Modifier
                        </button>
                </div>
                ${operation.commentaire ? `
                    <div class="mt-1 text-xs text-gray-600 italic flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-1"></i>
                        "${operation.commentaire.length > 50 ? operation.commentaire.substring(0, 50) + '...' : operation.commentaire}"
                    </div>
                ` : '<div class="mt-1 text-xs text-red-500 flex items-center"><i class="fas fa-exclamation-circle mr-1"></i>Commentaire requis</div>'}
            </td>
        </tr>
        `;
    }).join('');
}

// Fonction pour ouvrir la modale de commentaire spécifique au tableau
function ouvrirModaleCommentaireTableau(operationId, nomOperation) {
    currentOperationType = operationId; // Réutiliser la variable globale
    currentOperationName = nomOperation;
    
    // Trouver l'opération dans le tableau
    const operation = operationsTable.find(op => op.id === operationId);
    
    // Mettre à jour le titre de la modale
    document.getElementById('operationName').textContent = nomOperation + ' (' + operationId + ')';
    
    // Remplir la liste déroulante selon le type d'opération
    if (operation) {
        remplirListeCommentaires(operation.type);
    }
    
    // Charger le commentaire existant
    const select = document.getElementById('commentSelect');
    select.value = operation ? operation.commentaire : '';
    
    // Afficher la modale
    const modal = document.getElementById('commentModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale commentModal introuvable lors de l\'affichage');
    }
    
    // Focus sur le select
    setTimeout(() => {
        select.focus();
    }, 150);
}

// Fonction pour sauvegarder le commentaire (modifiée pour le tableau)
function saveComment() {
    const commentText = document.getElementById('commentSelect').value.trim();
    
    if (!commentText) {
        alert('Vous devez sélectionner une conclusion pour enregistrer l\'opération !');
        return;
    }
    
    console.log(`💾 DEBUG: Sauvegarde du commentaire: "${commentText}" pour ${currentOperationType}`);
    
    // Trouver et mettre à jour l'opération dans le tableau
    const operation = operationsTable.find(op => op.id === currentOperationType);
    if (operation) {
        const ancienCommentaire = operation.commentaire;
        operation.commentaire = commentText;
        
        console.log(`🔍 DEBUG: Opération trouvée: ${operation.id}, fromDatabase: ${operation.fromDatabase}`);
        console.log(`📝 DEBUG: Commentaire ancien: "${ancienCommentaire}" → nouveau: "${commentText}"`);
        
        // NOUVEAU: Sauvegarder TOUTES les opérations immédiatement en base de données
        if (operation.fromDatabase) {
            // Opération existante : utiliser update_operation
            console.log(`🔄 DEBUG: Sauvegarde d'une opération existante (DB)`);
            sauvegarderOperationExistante(operation, commentText);
        } else {
            // Nouvelle opération : créer en base de données immédiatement
            console.log(`🆕 DEBUG: Sauvegarde d'une nouvelle opération`);
            sauvegarderNouvelleOperation(operation, commentText);
        }
        
        // Mettre à jour l'affichage
        mettreAJourTableauOperations();
    }
    
    closeCommentModal();
}

// Fonction pour sauvegarder immédiatement une opération existante en base de données
function sauvegarderOperationExistante(operation, nouveauCommentaire) {
    console.log(`🔄 DEBUG: Sauvegarde immédiate de l'opération ${operation.id} en base de données...`);
    console.log(`📝 DEBUG: Nouveau commentaire à sauvegarder: "${nouveauCommentaire}"`);
    
    // Extraire l'ID numérique de l'opération (ex: "DB-51" -> "51")
    const operationDbId = operation.id.replace('DB-', '');
    console.log(`🔢 DEBUG: ID numérique extrait: ${operationDbId}`);
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        console.log(`🔐 DEBUG: Token CSRF ajouté: ${csrfToken.value.substring(0, 10)}...`);
    } else {
        console.error('❌ DEBUG: Token CSRF introuvable !');
    }
    
    // Ajouter l'action spécifique pour modifier une opération existante
    formData.append('action', 'update_operation');
    formData.append('operation_id', operationDbId);
    formData.append('nouveau_commentaire', nouveauCommentaire);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Debug des données envoyées
    console.log('📦 DEBUG: Données envoyées au serveur:');
    for (let [key, value] of formData.entries()) {
        console.log(`   - ${key}: ${value}`);
    }
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse reçue, status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données de réponse:', data);
        
        if (data.success) {
            console.log('✅ DEBUG: Opération mise à jour en base de données avec succès');
            console.log(`📋 DEBUG: Ancien commentaire: "${data.ancien_commentaire}"`);
            console.log(`📝 DEBUG: Nouveau commentaire: "${data.nouveau_commentaire}"`);
            
            if (data.debug_info) {
                console.log(`🔍 DEBUG: Vérification en base: "${data.debug_info.verification_conclusion}"`);
                console.log(`📊 DEBUG: Total opérations: ${data.debug_info.total_operations}`);
            }
            
            showNotification(`✅ Opération "${operation.nom}" mise à jour en base de données`, 'success');
            
            // Recharger les opérations depuis la base de données pour refléter les changements
            rechargerOperationsDepuisBase();
            } else {
            console.error('❌ DEBUG: Erreur lors de la mise à jour:', data.error);
            showNotification('❌ Erreur lors de la sauvegarde: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors de la sauvegarde', 'error');
    });
}

// Fonction pour sauvegarder immédiatement une nouvelle opération en base de données
function sauvegarderNouvelleOperation(operation, commentaire) {
    console.log(`🆕 DEBUG: Création immédiate d'une nouvelle opération en base de données...`);
    console.log(`📝 DEBUG: Type: ${operation.type}, Commentaire: "${commentaire}"`);
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        console.log(`🔐 DEBUG: Token CSRF ajouté`);
    } else {
        console.error('❌ DEBUG: Token CSRF introuvable !');
    }
    
    // Ajouter l'action pour créer une nouvelle opération
    formData.append('action', 'create_operation');
    formData.append('type_operation', operation.type);
    formData.append('commentaire', commentaire);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Debug des données envoyées
    console.log('📦 DEBUG: Données envoyées pour création opération:');
    for (let [key, value] of formData.entries()) {
        console.log(`   - ${key}: ${value}`);
    }
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse création reçue, status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données de réponse création:', data);
        
        if (data.success) {
            console.log('✅ DEBUG: Nouvelle opération créée en base de données avec succès');
            console.log(`🔢 DEBUG: Nouvel ID en base: ${data.operation_id}`);
            
            // Transformer l'opération locale en opération de base de données
            operation.id = `DB-${data.operation_id}`;
            operation.fromDatabase = true;
            
            console.log(`🔄 DEBUG: Opération transformée: ${operation.id} (fromDatabase: true)`);
            
            showNotification(`✅ Opération "${operation.nom}" créée et sauvegardée en base de données`, 'success');
            
            // Recharger les opérations depuis la base de données pour refléter les changements
            rechargerOperationsDepuisBase();
        } else {
            console.error('❌ DEBUG: Erreur lors de la création:', data.error);
            showNotification('❌ Erreur lors de la création: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion lors de la création:', error);
        showNotification('❌ Erreur de connexion lors de la création', 'error');
    });
}





// Types d'opérations valides selon la base de données
const TYPES_OPERATIONS_VALIDES = ['APPEL', 'Appel Whatsapp', 'Message Whatsapp', 'Vocal Whatsapp', 'ENVOI_SMS'];

// Variable globale pour stocker les commentaires chargés depuis l'API
let COMMENTAIRES_PREDEFINIES = {};

// Charger les commentaires depuis l'API Django au démarrage
function chargerCommentairesDisponibles() {
    console.log('🔄 Chargement des commentaires depuis l\'API Django...');
    
    fetch('{% url "operatConfirme:api_commentaires_disponibles" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                COMMENTAIRES_PREDEFINIES = data.commentaires;
                console.log('✅ Commentaires chargés depuis la base de données:', COMMENTAIRES_PREDEFINIES);
                
                // Afficher le nombre de commentaires par type d'opération
                Object.keys(COMMENTAIRES_PREDEFINIES).forEach(type => {
                    console.log(`📝 ${type}: ${COMMENTAIRES_PREDEFINIES[type].length} commentaires disponibles`);
                });
            } else {
                console.error('❌ Erreur lors du chargement des commentaires:', data.error);
                // Utiliser un fallback en cas d'erreur
                utiliserCommentairesFallback();
            }
        })
        .catch(error => {
            console.error('❌ Erreur de connexion à l\'API commentaires:', error);
            // Utiliser un fallback en cas d'erreur
            utiliserCommentairesFallback();
        });
}

// Fonction de fallback en cas d'erreur de chargement des commentaires
function utiliserCommentairesFallback() {
    console.warn('⚠️ Utilisation des commentaires de fallback');
    COMMENTAIRES_PREDEFINIES = {
        'APPEL': [
            { value: 'Client contacté avec succès', label: 'Client contacté avec succès' }
        ],
        'ENVOI_SMS': [
            { value: 'SMS envoyé avec succès', label: 'SMS envoyé avec succès' }
        ],
        'Appel Whatsapp': [
            { value: 'Appel WhatsApp réussi', label: 'Appel WhatsApp réussi' }
        ],
        'Message Whatsapp': [
            { value: 'Message WhatsApp envoyé', label: 'Message WhatsApp envoyé' }
        ],
        'Vocal Whatsapp': [
            { value: 'Message vocal envoyé', label: 'Message vocal envoyé' }
        ]
    };
}

// Fonction pour recharger les opérations depuis la base de données via AJAX
function rechargerOperationsDepuisBase() {
    console.log('🔄 DEBUG: Rechargement des opérations depuis la base de données...');
    console.log(`📊 DEBUG: État actuel du tableau: ${operationsTable.length} opération(s)`);
    
    // Faire une requête AJAX pour récupérer les opérations mises à jour
    fetch(`{% url 'operatConfirme:api_operations_commande' commande.id %}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log(`🌐 DEBUG: Réponse API reçue, status: ${response.status}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📬 DEBUG: Données API reçues:', data);
        
        if (data.success) {
            console.log(`🔄 DEBUG: ${data.operations.length} opération(s) rechargée(s) depuis la base`);
            
            // Séparer les nouvelles opérations des existantes (celles qui ne sont pas encore en base)
            const nouvellesOperations = operationsTable.filter(op => !op.fromDatabase);
            console.log(`📝 DEBUG: ${nouvellesOperations.length} nouvelle(s) opération(s) locale(s) conservée(s)`);
            
            // Remplacer les opérations existantes par les données fraîches de la base
            const operationsFromDatabase = data.operations.map(op => {
                console.log(`🔍 DEBUG: Opération de la base DB-${op.id}: "${op.conclusion}"`);
                return {
                    id: `DB-${op.id}`,
                    type: op.type_operation,
                    nom: op.nom_display,
                    classe: op.classe_css,
                    date: op.date_operation,
                    commentaire: op.conclusion,
                    typePrincipal: op.type_principal,
                    fromDatabase: true
                };
            });
            
            // Debug avant recombination
            console.log('📋 DEBUG: Comparaison avant/après recombination:');
            console.log('   - Ancien tableau operationsTable:', operationsTable);
            console.log('   - Nouvelles opérations de la base:', operationsFromDatabase);
            console.log('   - Nouvelles opérations locales conservées:', nouvellesOperations);
            
            // Recombiner : opérations de base + nouvelles opérations
            operationsTable = [...operationsFromDatabase, ...nouvellesOperations];
            
            console.log(`📊 DEBUG: Tableau final: ${operationsTable.length} opération(s) total`);
            console.log('   - Depuis la base:', operationsFromDatabase.length);
            console.log('   - Nouvelles locales:', nouvellesOperations.length);
            console.log('📋 DEBUG: Nouveau tableau operationsTable:', operationsTable);
            
            // Mettre à jour l'affichage
            mettreAJourTableauOperations();
            
            console.log('✅ DEBUG: Tableau des opérations mis à jour avec les données fraîches de la base');
            showNotification('🔄 Tableau rechargé depuis la base de données', 'info');
        } else {
            console.error('❌ DEBUG: Erreur lors du rechargement:', data.error);
            showNotification('❌ Erreur lors du rechargement: ' + (data.error || 'Erreur inconnue'), 'error');
        }
    })
    .catch(error => {
        console.error('❌ DEBUG: Erreur de connexion:', error);
        showNotification('❌ Erreur lors du rechargement des opérations: ' + (error.message || 'Erreur de connexion'), 'error');
        
        // Continuer avec les opérations locales uniquement
        console.log('⚠️ Continuez avec les opérations locales uniquement en raison de l\'erreur réseau');
        mettreAJourTableauOperations();
    });
}

// Fonction pour charger les opérations existantes depuis la base de données
function chargerOperationsExistantes() {
    console.log('🔄 Chargement des opérations existantes depuis la base de données...');
    
    // Récupérer les opérations déjà effectuées depuis les données Django
    {% if commande.operations.all %}
    const operationsExistantes = [
        {% for operation in commande.operations.all %}
        {
            id: 'DB-{{ operation.id }}',
            type: '{{ operation.type_operation }}',
            nom: '{{ operation.get_type_operation_display }}',
            classe: '{% if operation.type_operation == "APPEL" %}bg-blue-100 text-blue-800{% elif operation.type_operation == "ENVOI_SMS" %}bg-green-100 text-green-800{% elif operation.type_operation == "Appel Whatsapp" %}bg-emerald-100 text-emerald-800{% elif operation.type_operation == "Message Whatsapp" %}bg-emerald-100 text-emerald-800{% elif operation.type_operation == "Vocal Whatsapp" %}bg-emerald-100 text-emerald-800{% else %}bg-gray-100 text-gray-800{% endif %}',
            date: '{{ operation.date_operation|date:"d/m/Y H:i" }}',
            commentaire: '{{ operation.conclusion|escapejs }}',
            typePrincipal: '{% if operation.type_operation == "APPEL" %}APPEL{% elif operation.type_operation == "ENVOI_SMS" %}SMS{% elif "Whatsapp" in operation.type_operation %}WHATSAPP{% else %}OTHER{% endif %}',
            fromDatabase: true
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Ajouter les opérations existantes au tableau
    operationsTable = [...operationsExistantes];
    console.log(`✅ ${operationsExistantes.length} opération(s) existante(s) chargée(s) depuis la base`);
    
    // Mettre à jour l'affichage du tableau
    mettreAJourTableauOperations();
    
    // Créer les champs cachés pour ces opérations
    creerChampsFormulaire();
    
    {% else %}
    console.log('ℹ️ Aucune opération existante trouvée en base de données');
    {% endif %}
    
    // Mettre à jour le compteur global des opérations
    if (operationCounter <= operationsTable.length) {
        operationCounter = operationsTable.length + 1;
    }
}

// Fonction pour valider un type d'opération
function validerTypeOperation(typeOperation) {
    const isValid = TYPES_OPERATIONS_VALIDES.includes(typeOperation);
    if (!isValid) {
        console.warn(`⚠️ Type d'opération invalide: "${typeOperation}"`);
        console.log('✅ Types valides:', TYPES_OPERATIONS_VALIDES);
    }
    return isValid;
}

// Fonction pour remplir la liste déroulante de commentaires selon le type d'opération
function remplirListeCommentaires(typeOperation) {
    const select = document.getElementById('commentSelect');
    
    // Réinitialiser la liste
    select.innerHTML = '<option value="">-- Sélectionnez une conclusion --</option>';
    
    // Déterminer le type d'opération à utiliser pour chercher les commentaires
    let typeOperationKey = typeOperation;
    
    // Si c'est un ID d'opération du tableau, extraire le vrai type
    if (typeOperation.startsWith('OP-')) {
        const operation = operationsTable.find(op => op.id === typeOperation);
        if (operation) {
            typeOperationKey = operation.type;
        }
    }
    
    console.log(`📝 Remplissage commentaires pour: ${typeOperationKey}`);
    
    // Remplir avec les commentaires prédéfinis depuis l'API
    const commentaires = COMMENTAIRES_PREDEFINIES[typeOperationKey];
    if (commentaires && commentaires.length > 0) {
        commentaires.forEach(commentaireObj => {
            const option = document.createElement('option');
            // Utiliser la structure {value, label} depuis l'API
            option.value = commentaireObj.value;
            option.textContent = commentaireObj.label;
            select.appendChild(option);
        });
        
        console.log(`✅ ${commentaires.length} commentaires ajoutés pour ${typeOperationKey}`);
    } else {
        console.warn(`⚠️ Aucun commentaire prédéfini trouvé pour: ${typeOperationKey}`);
        
        // Ajouter une option générique si aucun commentaire prédéfini
        const option = document.createElement('option');
        option.value = 'Opération effectuée avec succès';
        option.textContent = 'Opération effectuée avec succès';
        select.appendChild(option);
    }
}

// Fonction pour créer les champs cachés du formulaire
function creerChampsFormulaire() {
    console.log('🔧 Création des champs cachés pour le formulaire...');
    
    // Supprimer les anciens champs
    const anciensChampsOperations = document.querySelectorAll('input[name="operations[]"]');
    const anciensChampsCommentaires = document.querySelectorAll('input[name^="comment_"]');
    
    console.log(`🗑️ Suppression de ${anciensChampsOperations.length} anciens champs d'opérations`);
    console.log(`🗑️ Suppression de ${anciensChampsCommentaires.length} anciens champs de commentaires`);
    
    anciensChampsOperations.forEach(input => input.remove());
    anciensChampsCommentaires.forEach(input => input.remove());
    
    // Vérifier que le formulaire existe
    const form = document.getElementById('modification-form');
    if (!form) {
        console.error('❌ Formulaire modification-form introuvable !');
        return;
    }
    
    let champsCreesOperations = 0;
    let champsCreesCommentaires = 0;
    
    // Créer les nouveaux champs pour chaque opération (sauf celles déjà en base)
    operationsTable.forEach((operation, index) => {
        // Ignorer les opérations déjà sauvegardées en base de données
        if (operation.fromDatabase) {
            console.log(`⏭️ Opération ${index + 1} ignorée (déjà en base): ${operation.type}`);
            return;
        }
        
        if (operation.commentaire && operation.commentaire.trim()) {
            // Valider le type d'opération
            if (!validerTypeOperation(operation.type)) {
                console.error(`❌ Opération ${index + 1} ignorée (type invalide): ${operation.type}`);
                return;
            }
            
            console.log(`➕ Ajout opération ${index + 1}: ${operation.type} = "${operation.commentaire}"`);
            
            // Champ pour le type d'opération
            const inputType = document.createElement('input');
            inputType.type = 'hidden';
            inputType.name = 'operations[]';
            inputType.value = operation.type;
            form.appendChild(inputType);
            champsCreesOperations++;
            
            // Champ pour le commentaire
            const inputComment = document.createElement('input');
            inputComment.type = 'hidden';
            inputComment.name = 'comment_' + operation.type;
            inputComment.value = operation.commentaire;
            form.appendChild(inputComment);
            champsCreesCommentaires++;
            
        } else {
            console.warn(`⚠️ Opération ${index + 1} ignorée (pas de commentaire): ${operation.type}`);
        }
    });
    
    console.log(`✅ ${champsCreesOperations} champs d'opérations créés`);
    console.log(`✅ ${champsCreesCommentaires} champs de commentaires créés`);
    
    // Afficher un résumé des données qui seront envoyées
    if (champsCreesOperations > 0) {
        console.log('📤 Données d\'opérations qui seront envoyées au serveur:');
        const operationsValues = Array.from(document.querySelectorAll('input[name="operations[]"]')).map(input => input.value);
        const commentairesValues = Array.from(document.querySelectorAll('input[name^="comment_"]')).map(input => `${input.name}: "${input.value}"`);
        
        console.log('  - Opérations:', operationsValues);
        console.log('  - Commentaires:', commentairesValues);
    }
}

// Fonction pour vérifier qu'au moins une opération est dans le tableau avant la soumission
function verifierOperationsSelectionnees() {
    console.log('🔍 Vérification des opérations avant sauvegarde...');
    console.log('📊 Opérations dans le tableau:', operationsTable);
    
    const operationsAvecCommentaire = operationsTable.filter(op => op.commentaire && op.commentaire.trim());
    
    // Permettre la sauvegarde sans opérations (pour sauvegarder juste les infos de commande/articles)
    if (operationsTable.length === 0) {
        console.log('ℹ️ Aucune opération ajoutée - sauvegarde des informations de commande uniquement');
        showNotification('💾 Sauvegarde des informations de commande', 'success');
        return true;
    }
    
    const operationsSansCommentaire = operationsTable.filter(op => !op.commentaire || !op.commentaire.trim());
    if (operationsSansCommentaire.length > 0) {
        alert(`❌ COMMENTAIRES OBLIGATOIRES MANQUANTS\n\nLes opérations suivantes nécessitent un commentaire :\n• ${operationsSansCommentaire.map(op => op.nom + ' (' + op.id + ')').join('\n• ')}\n\nVeuillez ajouter des commentaires pour toutes les opérations ou les supprimer du tableau.`);
        return false;
    }
    
    // Créer les champs du formulaire avant la soumission
    console.log('📋 Création des champs cachés pour les opérations...');
    creerChampsFormulaire();
    
    // Vérifier que les champs ont bien été créés
    const operationsFields = document.querySelectorAll('input[name="operations[]"]');
    const commentFields = document.querySelectorAll('input[name^="comment_"]');
    
    console.log(`✅ ${operationsFields.length} champs d'opérations créés`);
    console.log(`✅ ${commentFields.length} champs de commentaires créés`);
    
    if (operationsAvecCommentaire.length > 0) {
        showNotification(`💾 Sauvegarde : ${operationsAvecCommentaire.length} opération(s) avec commentaires`, 'success');
    }
    
    return true;
}

// Fermer la modale avec Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeCommentModal();
    }
});

// Vérification et initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Page chargée, initialisation du système...');
    
    try {
        // Vérifier que la modale existe
        const modal = document.getElementById('commentModal');
        if (!modal) {
            console.error('❌ Modale commentModal introuvable !');
            } else {
            console.log('✅ Modale commentModal trouvée');
            
            // Fermer la modale en cliquant à l'extérieur
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    closeCommentModal();
                }
            });
        }
        
        // Vérifier les éléments de la modale
        const operationNameElement = document.getElementById('operationName');
        const commentSelectEl = document.getElementById('commentSelect');
        
        if (!operationNameElement) {
            console.warn('⚠️ Élément operationName introuvable');
        } else {
            console.log('✅ Élément operationName trouvé');
        }
        
        if (!commentSelectEl) {
            console.warn('⚠️ Select commentSelect introuvable');
        } else {
            console.log('✅ Select commentSelect trouvé');
        }
        
        // Vérifier les éléments du nouveau système
        const typePrincipalSelector = document.getElementById('type-principal-selector');
        const operationSelector = document.getElementById('operation-selector');
        const operationsList = document.getElementById('operations-list');
        const operationsTableBody = document.getElementById('operations-table-body');
        
        if (typePrincipalSelector) {
            console.log('✅ Sélecteur de type principal trouvé');
        } else {
            console.warn('⚠️ Sélecteur de type principal introuvable');
        }
        
        if (operationSelector) {
            console.log('✅ Sélecteur d\'opération trouvé');
        } else {
            console.warn('⚠️ Sélecteur d\'opération introuvable');
        }
        
        if (operationsList) {
            console.log('✅ Liste des opérations trouvée');
        } else {
            console.warn('⚠️ Liste des opérations introuvable');
        }
        
        if (operationsTableBody) {
            console.log('✅ Corps du tableau des opérations trouvé');
        } else {
            console.warn('⚠️ Corps du tableau des opérations introuvable');
        }
        
        console.log('✅ Système de modales initialisé avec succès');
        
        // Initialiser le tableau des opérations avec vérification
        if (typeof mettreAJourTableauOperations === 'function') {
            mettreAJourTableauOperations();
            console.log('✅ Tableau des opérations initialisé');
        } else {
            console.error('❌ Fonction mettreAJourTableauOperations introuvable');
        }
        
        // Fonction de test pour vérifier que les modales fonctionnent
        window.testModal = function() {
            console.log('🧪 Test de la modale...');
            if (typeof openCommentModal === 'function') {
                openCommentModal('TEST', 'Test Opération');
            } else {
                console.error('❌ Fonction openCommentModal introuvable');
            }
        };
        
        // Fonction de test pour le nouveau système d'opérations
        window.testNouveauSysteme = function() {
            console.log('🧪 Test du nouveau système d\'opérations...');
            console.log('Variables globales:');
            console.log('- operationCounter:', typeof operationCounter !== 'undefined' ? operationCounter : 'Non défini');
            console.log('- operationsTable:', typeof operationsTable !== 'undefined' ? operationsTable : 'Non défini');
            console.log('- typePrincipalSelectionne:', typeof typePrincipalSelectionne !== 'undefined' ? typePrincipalSelectionne : 'Non défini');
            
            // Tester l'ajout d'une opération de test
            if (typeof ajouterNouvelleOperation === 'function') {
                ajouterNouvelleOperation();
                console.log('✅ Sélecteur de type principal affiché');
            } else {
                console.error('❌ Fonction ajouterNouvelleOperation introuvable');
            }
        };
        
        // Fonction de debug global
        window.debugSysteme = function() {
            console.log('🔍 Debug du système:');
            console.log('- DOMContentLoaded: ✅');
            console.log('- Modal:', document.getElementById('commentModal') ? '✅' : '❌');
            console.log('- Type principal selector:', document.getElementById('type-principal-selector') ? '✅' : '❌');
            console.log('- Operation selector:', document.getElementById('operation-selector') ? '✅' : '❌');
            console.log('- Operations list:', document.getElementById('operations-list') ? '✅' : '❌');
            console.log('- Operations table body:', document.getElementById('operations-table-body') ? '✅' : '❌');
            console.log('- operationCounter:', typeof operationCounter);
            console.log('- operationsTable:', typeof operationsTable);
            console.log('- typePrincipalSelectionne:', typeof typePrincipalSelectionne);
        };
        
        // Fonction de debug pour les articles
        window.debugArticles = function() {
            console.log('🔍 Debug des articles:');
            console.log('- articleSelect element:', document.getElementById('articleSelect') ? '✅' : '❌');
            console.log('- CSRF token:', document.querySelector('[name=csrfmiddlewaretoken]') ? '✅' : '❌');
            console.log('- API URL: {% url "operatConfirme:api_articles_disponibles" %}');
            console.log('- articlesDisponibles length:', articlesDisponibles ? articlesDisponibles.length : 'Non défini');
            
            // Test direct de l'API
            console.log('🧪 Test de l\'API en cours...');
            chargerArticlesDisponibles();
        };
        
        // Fonction pour vérifier les stocks des articles
        window.verifierStocks = function() {
            console.log('📊 Vérification des stocks:');
            
            if (!articlesDisponibles || articlesDisponibles.length === 0) {
                console.log('❌ Aucun article chargé. Chargement...');
                chargerArticlesDisponibles();
                setTimeout(() => verifierStocks(), 1000);
                return;
            }
            
            console.log(`📦 ${articlesDisponibles.length} articles chargés`);
            
            // Afficher les articles avec stock > 0
            const articlesAvecStock = articlesDisponibles.filter(a => a.qte_disponible > 0);
            console.log(`✅ ${articlesAvecStock.length} articles avec stock > 0:`);
            articlesAvecStock.slice(0, 5).forEach((article, i) => {
                console.log(`   ${i+1}. ${article.nom} (ID: ${article.id}): Stock = ${article.qte_disponible}`);
            });
            
            // Afficher les articles sans stock
            const articlesSansStock = articlesDisponibles.filter(a => !a.qte_disponible || a.qte_disponible === 0);
            console.log(`❌ ${articlesSansStock.length} articles avec stock = 0:`);
            articlesSansStock.slice(0, 5).forEach((article, i) => {
                console.log(`   ${i+1}. ${article.nom} (ID: ${article.id}): Stock = ${article.qte_disponible}`);
            });
            
            // Vérifier l'affichage dans le DOM
            const articleCards = document.querySelectorAll('.article-card');
            console.log(`🔍 ${articleCards.length} cartes d'articles dans le DOM`);
            
            articleCards.forEach((card, i) => {
                const stockBadge = card.querySelector('.bg-green-100.text-green-700');
                const stockText = stockBadge ? stockBadge.textContent.trim() : 'Non trouvé';
                const articleData = JSON.parse(card.dataset.article || '{}');
                
                console.log(`   Article ${i+1}: ${articleData.nom || 'Sans nom'}`);
                console.log(`      - Stock affiché: ${stockText}`);
                console.log(`      - Stock dans data: ${articleData.qte_disponible}`);
            });
            
            return {
                total: articlesDisponibles.length,
                avecStock: articlesAvecStock.length,
                sansStock: articlesSansStock.length
            };
        };
        
        // Fonction pour tester le système de filtrage
        window.testFiltrage = function() {
            console.log('🧪 Test du système de filtrage...');
            console.log('📊 Articles disponibles:', articlesDisponibles ? articlesDisponibles.length : 'Non chargés');
            
            if (!articlesDisponibles || articlesDisponibles.length === 0) {
                console.log('❌ Aucun article chargé. Chargement...');
                chargerArticlesDisponibles();
                return;
            }
            
            // Tester chaque type de filtre
            const types = ['all', 'promo', 'liquidation', 'test', 'upsell'];
            types.forEach(type => {
                const count = compterArticlesParType(type);
                console.log(`📊 ${type.toUpperCase()}: ${count} article(s)`);
            });
            
            // Afficher quelques exemples d'articles par type
            console.log('\n📋 Exemples d\'articles par type:');
            
            const promosExemples = articlesDisponibles.filter(a => a.has_promo_active).slice(0, 2);
            console.log('🔥 PROMO:', promosExemples.map(a => `${a.nom} (${a.has_promo_active})`));
            
            const liquidationExemples = articlesDisponibles.filter(a => a.phase === 'LIQUIDATION').slice(0, 2);
            console.log('🏷️ LIQUIDATION:', liquidationExemples.map(a => `${a.nom} (${a.phase})`));
            
            const testExemples = articlesDisponibles.filter(a => a.phase === 'EN_TEST').slice(0, 2);
            console.log('🧪 TEST:', testExemples.map(a => `${a.nom} (${a.phase})`));
            
            const upsellExemples = articlesDisponibles.filter(a => a.isUpsell).slice(0, 2);
            console.log('⬆️ UPSELL:', upsellExemples.map(a => `${a.nom} (${a.isUpsell})`));
            
            // Tester un filtrage
            console.log('\n🔍 Test de filtrage par PROMO...');
            filtrerArticles('promo');
        };
        
        // Fonction pour tester manuellement l'API des articles
        window.testApiArticles = function() {
            console.log('🧪 Test manuel de l\'API des articles...');
            
            const apiUrl = '{% url "operatConfirme:api_articles_disponibles" %}';
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            
            console.log('📋 Informations de test:');
            console.log('- URL:', apiUrl);
            console.log('- CSRF Token présent:', csrfToken ? 'OUI' : 'NON');
            console.log('- Utilisateur connecté:', '{{ user.username }}');
            console.log('- Type d\'utilisateur:', '{{ user.profil_operateur.type_operateur|default:"Non défini" }}');
            
            if (!csrfToken) {
                console.error('❌ Token CSRF manquant');
                return;
            }
            
            fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken.value,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin',
            })
            .then(response => {
                console.log('📡 Statut de la réponse:', response.status, response.statusText);
                console.log('📋 Headers de réponse:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('❌ Réponse d\'erreur:', text);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log('✅ Données reçues:', data);
                
                // Gestion des deux formats possibles (tableau direct ou objet avec propriété articles)
                let articles = [];
                if (Array.isArray(data)) {
                    articles = data;
                    console.log(`📦 ${articles.length} article(s) trouvé(s) (format tableau)`);
                } else if (data.success && data.articles) {
                    articles = data.articles;
                    console.log(`📦 ${articles.length} article(s) trouvé(s) (format objet)`);
                } else {
                    console.warn('⚠️ Format de données inattendu:', data);
                    return;
                }
                
                // Afficher les informations des articles
                articles.forEach((article, index) => {
                        console.log(`   Article ${index + 1}:`, {
                            id: article.id,
                            nom: article.nom,
                            reference: article.reference,
                            prix: article.prix_actuel,
                            pointure: article.pointure,
                            couleur: article.couleur,
                            stock: article.qte_disponible
                        });
                    });
            })
            .catch(error => {
                console.error('❌ Erreur lors du test:', error);
            });
        };
        
            console.log('💡 Fonctions de test disponibles:');
    console.log('   - testModal() : Tester la modale');
    console.log('   - testNouveauSysteme() : Tester le système d\'opérations');
    console.log('   - debugSysteme() : Debug complet du système');
    console.log('   - debugArticles() : Debug et test des articles');
    console.log('   - testApiArticles() : Test manuel de l\'API des articles');
    console.log('   - testFiltrage() : Tester le système de filtrage');
        
        // Afficher les informations sur les opérations
        console.log('🗃️ SYSTÈME D\'OPÉRATIONS:');
        console.log('   - Types valides en base de données:', TYPES_OPERATIONS_VALIDES);
        console.log('   - Sauvegarde: Table Operation (commande/models.py)');
        console.log('   - Validation: Automatique côté JavaScript + Django');
        console.log('   - Commentaires: Liste déroulante prédéfinie (plus rapide)');
        
        // Afficher le nombre de commentaires par type
        console.log('📝 COMMENTAIRES PRÉDÉFINIS:');
        Object.keys(COMMENTAIRES_PREDEFINIES).forEach(type => {
            console.log(`   - ${type}: ${COMMENTAIRES_PREDEFINIES[type].length} options`);
        });
        
        console.log('📋 Système complet initialisé avec succès');
        
    } catch (error) {
        console.error('❌ Erreur lors de l\'initialisation:', error);
    }
});

// Fonction pour changer l'opération (ancienne fonction - gardée pour compatibilité)
function changerOperation() {
    // Cette fonction n'est plus utilisée avec le nouveau système
    console.log('Fonction changerOperation() appelée - système d\'opérations individuelles actif');
    
    // Cette fonction est désactivée dans le nouveau système de tableau
    console.log('⚠️ Fonction désactivée - utilisez le système de tableau à la place');
}

// Fonction pour afficher des notifications discrètes
function showNotification(message, type = 'info') {
    try {
        const notification = document.createElement('div');
        
        // Déterminer les couleurs selon le type
        let bgColor = 'bg-blue-500'; // info par défaut
        if (type === 'success') bgColor = 'bg-green-500';
        else if (type === 'error') bgColor = 'bg-red-500';
        else if (type === 'warning') bgColor = 'bg-yellow-500';
        
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-all duration-300 ${bgColor} max-w-sm`;
        
        // Permettre les retours à la ligne dans les notifications
        notification.style.whiteSpace = 'pre-line';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Durée d'affichage variable selon le type et la longueur du message
        let duration = 3000; // 3 secondes par défaut
        if (type === 'success' && message.includes('décrémenté')) {
            duration = 5000; // 5 secondes pour les messages de stock
        } else if (type === 'error') {
            duration = 6000; // 6 secondes pour les erreurs
        }
        
        // Supprimer après la durée déterminée avec vérifications de sécurité
        setTimeout(() => {
            try {
                if (notification && notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        try {
                            if (notification && notification.parentNode) {
                                document.body.removeChild(notification);
                            }
                        } catch (error) {
                            console.warn('⚠️ Erreur lors de la suppression de la notification:', error);
                        }
                    }, 300);
                }
            } catch (error) {
                console.warn('⚠️ Erreur lors de la modification de l\'opacité de la notification:', error);
            }
        }, duration);
    } catch (error) {
        console.error('❌ Erreur lors de la création de la notification:', error);
        // Fallback vers une alerte simple
        alert(message);
    }
}

// Fonction pour afficher des notifications de stock avec plus de détails
function showStockNotification(detailsStock, type = 'success') {
    if (!detailsStock || detailsStock.length === 0) return;
    
    let message = '';
    if (type === 'success') {
        message = `📦 Stock mis à jour avec succès :\n\n`;
        detailsStock.forEach((item, index) => {
            message += `${index + 1}. ${item.article}\n`;
            message += `   ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})\n\n`;
        });
    }
    
    showNotification(message, type);
}



// Fonction pour lancer la confirmation (change l'état de Affectée à En cours)
function lancerConfirmation() {
        fetch(`{% url 'operatConfirme:lancer_confirmation' commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Confirmation lancée avec succès !', 'success');
                // Recharger la page pour voir les changements
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                alert('Erreur lors du lancement : ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Une erreur est survenue lors du lancement de la confirmation.');
        });
}

// Fonction pour annuler définitivement la commande (En cours de confirmation -> Annulée)
function annulerCommande() {
    // Créer et afficher la modal d'annulation
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-bold text-gray-900">Annuler la commande {{ commande.id_yz }}</h3>
                    <p class="text-sm text-gray-600">Cette action est irréversible</p>
                </div>
            </div>
            
            <div class="mb-4">
                <label for="motifAnnulationSelect" class="block text-sm font-semibold mb-2 text-gray-700">
                    Motif d'annulation <span class="text-red-500">*</span>
                </label>
                <select id="motifAnnulationSelect" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent mb-3" 
                        required>
                    <option value="">Sélectionner un motif...</option>
                    <option value="Doublon confirmé">Doublon confirmé</option>
                    <option value="Numéro tel incorrect">Numéro tel incorrect</option>
                    <option value="Numéro de téléphone injoignable">Numéro de téléphone injoignable</option>
                    <option value="Client non intéressé">Client non intéressé</option>
                    <option value="Adresse erronée">Adresse erronée</option>
                    <option value="Erreur de saisie">Erreur de saisie</option>
                    <option value="Autre">Autre (préciser ci-dessous)</option>
                </select>
                
                <div id="motifPersonnaliseDiv" style="display: none;">
                    <label for="motifAnnulation" class="block text-sm font-medium mb-2 text-gray-700">
                        Motif personnalisé
                    </label>
                    <textarea id="motifAnnulation" rows="2" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" 
                            placeholder="Précisez le motif..."></textarea>
                </div>
                
                <p class="text-xs text-gray-500 mt-1">Le motif est obligatoire et sera visible dans l'historique</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" id="btnAnnulerModal" 
                        class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">
                    Annuler
                </button>
                <button type="button" id="btnConfirmerAnnulation" 
                        class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    <i class="fas fa-ban mr-1"></i>Confirmer l'annulation
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Focus sur le select
    const motifSelect = document.getElementById('motifAnnulationSelect');
    const motifInput = document.getElementById('motifAnnulation');
    const motifPersonnaliseDiv = document.getElementById('motifPersonnaliseDiv');
    
    motifSelect.focus();
    
    // Gérer l'affichage du champ personnalisé
    motifSelect.addEventListener('change', function() {
        if (this.value === 'Autre') {
            motifPersonnaliseDiv.style.display = 'block';
            motifInput.focus();
        } else {
            motifPersonnaliseDiv.style.display = 'none';
            motifInput.value = '';
        }
    });
    
    // Fermer la modal
    document.getElementById('btnAnnulerModal').addEventListener('click', function() {
        document.body.removeChild(modal);
    });
    
    // Confirmer l'annulation
    document.getElementById('btnConfirmerAnnulation').addEventListener('click', function() {
        let motif = '';
        
        if (motifSelect.value === 'Autre') {
            motif = motifInput.value.trim();
            if (!motif) {
                motifInput.classList.add('border-red-500');
                motifInput.focus();
                return;
            }
        } else {
            motif = motifSelect.value;
            if (!motif) {
                motifSelect.classList.add('border-red-500');
                motifSelect.focus();
                return;
            }
        }
        
        // Envoyer la requête d'annulation
        fetch(`{% url 'operatConfirme:annuler_commande_confirmation' commande.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                motif: motif
            })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                showNotification('Commande annulée avec succès !', 'success');
                // Rediriger vers la liste des commandes confirmées après un court délai
            setTimeout(() => {
                    window.location.href = '{% url "operatConfirme:commandes_confirmees" %}';
            }, 1500);
        } else {
            alert('Erreur lors de l\'annulation : ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
            alert('Une erreur est survenue lors de l\'annulation de la commande.');
        })
        .finally(() => {
            document.body.removeChild(modal);
        });
    });
    
    // Fermer en cliquant à l'extérieur
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
}

// Fonction utilitaire pour sauvegarder les opérations avant une action
function sauvegarderOperationsAvantAction() {
    console.log('💾 Sauvegarde préventive des opérations avant action...');
    
    // Vérifier s'il y a des opérations à sauvegarder
    const operationsAvecCommentaire = operationsTable.filter(op => op.commentaire && op.commentaire.trim());
    
    if (operationsAvecCommentaire.length > 0) {
        // S'assurer que les champs sont créés pour la sauvegarde
        creerChampsFormulaire();
        
        // Soumettre silencieusement le formulaire pour sauvegarder les opérations
        const form = document.getElementById('modification-form');
        if (form) {
            console.log(`📤 Sauvegarde de ${operationsAvecCommentaire.length} opération(s) en cours...`);
            
            // Créer un FormData pour envoi AJAX
            const formData = new FormData(form);
            
            // Envoyer via AJAX pour éviter de recharger la page
            return fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => {
                if (response.ok) {
                    console.log('✅ Opérations sauvegardées avec succès');
                    showNotification('💾 Opérations sauvegardées', 'success');
                    return true;
                } else {
                    console.warn('⚠️ Erreur lors de la sauvegarde des opérations');
                    return false;
                }
            })
            .catch(error => {
                console.error('❌ Erreur de sauvegarde:', error);
                return false;
            });
        }
    }
    
    return Promise.resolve(true);
}

// Fonction pour confirmer la commande
function confirmerCommande() {
    // Vérifier que les sections essentielles sont remplies
    const nomClient = document.querySelector('[name="client_nom"]')?.value?.trim();
    const telephoneClient = document.querySelector('[name="client_telephone"]')?.value?.trim();
    const villeId = document.querySelector('[name="ville_livraison"]')?.value;
    const adresse = document.querySelector('[name="adresse_livraison"]')?.value?.trim();
    
    // Vérifications essentielles
    if (!nomClient) {
        showNotification('⚠️ Veuillez renseigner le nom ', 'error');
        return;
    }
    
    if (!telephoneClient) {
        showNotification('⚠️ Veuillez renseigner le numéro de téléphone du client', 'error');
            return;
        }
        
    if (!villeId) {
        showNotification('⚠️ Veuillez sélectionner une ville de livraison', 'error');
        return;
    }
    
    // Vérifier que la région est bien remplie (automatiquement quand on sélectionne une ville)
    const regionDisplay = document.getElementById('region-display')?.value?.trim();
    if (!regionDisplay || regionDisplay === '') {
        showNotification('⚠️ La région n\'est pas définie. Veuillez re-sélectionner une ville de livraison', 'error');
        return;
    }
    
    if (!adresse) {
        showNotification('⚠️ Veuillez renseigner l\'adresse de livraison', 'error');
        return;
    }
    
    // Vérifier qu'il y a au moins un article dans la commande
    const articles = document.querySelectorAll('.article-card');
    if (articles.length === 0) {
        showNotification('⚠️ La commande doit contenir au moins un article', 'error');
        return;
                }
                
    console.log('✅ Toutes les vérifications passées, confirmation en cours...');
    
    // Afficher le modal de confirmation
    showConfirmationModal();
    return;
    
    // Afficher une notification de traitement en cours
    showNotification('⏳ Confirmation en cours... (vérification du stock)', 'info');
    
    // Confirmer directement la commande
    fetch(`/operateur-confirme/commandes/{{ commande.id }}/confirmer-ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'commentaire': 'Commande confirmée après vérification complète'
                })
        })
        .then(response => response.json())
        .then(data => {
            console.log('📬 DEBUG: Réponse de confirmation reçue:', data);
            
            if (data.success) {
                // Message de succès avec détails du stock
                let successMessage = '✅ Commande confirmée avec succès !';
                
                if (data.articles_decrémentes && data.articles_decrémentes > 0) {
                    successMessage += `\n📦 ${data.articles_decrémentes} article(s) décrémenté(s) du stock.`;
                    
                    // Log détaillé des modifications de stock
                    if (data.details_stock && data.details_stock.length > 0) {
                        console.log('📊 DEBUG: Détails de la décrémentation du stock:');
                        data.details_stock.forEach((item, index) => {
                            console.log(`   Article ${index + 1}: ${item.article}`);
                            console.log(`      - Stock: ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})`);
                        });
                    }
                }
                
                showNotification(successMessage, 'success');
                
                // Rediriger après un court délai pour voir la notification
                setTimeout(() => {
                window.location.href = '{% url "operatConfirme:confirmation" %}';
                }, 1000); // 3 secondes pour lire les détails
                
            } else {
                // Gestion des erreurs de stock insuffisant
                console.error('❌ DEBUG: Erreur de confirmation:', data.message);
                
                if (data.stock_insuffisant && data.stock_insuffisant.length > 0) {
                    // Préparer les données pour le modal de stock insuffisant
                    window.stockInsuffisantData = data.stock_insuffisant;
                    showStockInsuffisantModal();
                } else {
                    showNotification('❌ Erreur lors de la confirmation : ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('❌ DEBUG: Erreur de connexion:', error);
            showNotification('❌ Une erreur de connexion est survenue : ' + error.message, 'error');
        });
}

// ================== GESTION DES ARTICLES ==================

// Variables globales pour les articles
let articlesDisponibles = [];
let currentArticleId = null;
let isEditingArticle = false;
let compteurCommande = {{ commande.compteur }};
let filtreActuel = 'all'; // Filtre actuellement actif

// Fonction pour ajouter un nouvel article
function ajouterNouvelArticle() {
    isEditingArticle = false;
    currentArticleId = null;
    
    // Mettre à jour le titre
    document.getElementById('articleModalTitle').textContent = 'Ajouter un article';
    
    // Afficher le champ de sélection, cacher l'affichage
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Réinitialiser le formulaire
    document.getElementById('articleSelect').value = '';
    document.getElementById('quantiteInput').value = '1';
    document.getElementById('article-info').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticlesDisponibles();
    
    // Afficher la modale
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de l\'ajout d\'article');
    }
}

// Fonction pour modifier un article existant
function modifierArticle(panierId) {
    console.log('🔧 Modification article demandée pour ID:', panierId);
    
    isEditingArticle = true;
    currentArticleId = panierId;
    
    // Mettre à jour le titre
    document.getElementById('articleModalTitle').textContent = 'Modifier l\'article';
    
    // Toujours afficher le champ de sélection pour permettre de changer l'article
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticlesDisponibles();
    
    // Récupérer les données de l'article depuis la carte
    const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
    console.log('🔍 Article card trouvé:', articleCard ? 'OUI' : 'NON', articleCard);
    
    if (articleCard) {
        // Récupérer la quantité avec vérification de sécurité
        const quantiteElement = articleCard.querySelector('input[type="number"]');
        if (quantiteElement && quantiteElement.value) {
            document.getElementById('quantiteInput').value = quantiteElement.value;
        } else {
            document.getElementById('quantiteInput').value = '1'; // Valeur par défaut
        }
        
        // Récupérer la référence de l'article pour le pré-sélectionner avec vérification de sécurité
        const referenceElement = articleCard.querySelector('.text-sm.text-gray-500');
        let reference = '';
        if (referenceElement && referenceElement.textContent) {
            const referenceText = referenceElement.textContent;
            reference = referenceText.replace('Réf: ', '').replace('Référence: ', '').trim();
        }
        
        // Récupérer les données complètes de l'article depuis le dataset
        try {
            const articleData = JSON.parse(articleCard.dataset.article || '{}');
            console.log('📊 Données article récupérées:', articleData);
            
            // Afficher les informations de l'article avec les données complètes
            if (articleData && articleData.id) {
                afficherInfosArticle(articleData);
            } else {
                // Fallback à l'ancienne méthode si les données ne sont pas disponibles
                afficherInfosArticleExistant(articleCard);
            }
        } catch (error) {
            console.error('❌ Erreur lors de la récupération des données article:', error);
            // Fallback à l'ancienne méthode
            afficherInfosArticleExistant(articleCard);
        }
        
        // Attendre que les articles soient chargés puis pré-sélectionner l'article actuel
        setTimeout(() => {
            preselectionnerArticle(reference);
        }, 500);
    }
    
    // Afficher la modale avec vérification de sécurité
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de la modification d\'article');
        showNotification('❌ Erreur: Modale de modification introuvable', 'error');
        return;
    }
}

// Fonction pour pré-sélectionner un article dans la liste déroulante
function preselectionnerArticle(reference) {
    const select = document.getElementById('articleSelect');
    if (!select) {
        console.error('❌ Élément articleSelect introuvable');
        return;
    }
    
    // Chercher l'option correspondant à la référence
    for (let i = 0; i < select.options.length; i++) {
        const option = select.options[i];
        if (option.dataset.article) {
            try {
                const article = JSON.parse(option.dataset.article);
                if (article.reference === reference) {
                    select.selectedIndex = i;
                    console.log('✅ Article pré-sélectionné:', reference);
                    
                    // Déclencher l'événement de changement pour mettre à jour les informations
                    onArticleSelectionChange();
                    return;
                }
            } catch (error) {
                console.warn('⚠️ Erreur lors de l\'analyse des données article:', error);
            }
        }
    }
    
    console.warn('⚠️ Article non trouvé dans la liste pour référence:', reference);
}

// Fonction pour afficher les infos d'un article existant
function afficherInfosArticleExistant(articleCard) {
    // Chercher la référence dans la section des informations de l'article
    const referenceElement = articleCard.querySelector('.text-sm.text-gray-500');
    const reference = referenceElement ? referenceElement.textContent.replace('Réf: ', '').replace('Référence: ', '') : '';
    
    // Chercher le prix dans la section "Prix actuel"
    const prixElement = articleCard.querySelector('.text-center.min-w-0 .text-green-600, .text-center.min-w-0 .text-gray-600');
    const prixText = prixElement ? prixElement.textContent : '';
    
    // Chercher le sous-total
    const sousTotalElement = articleCard.querySelector('.text-lg.font-bold');
    const sousTotal = sousTotalElement ? sousTotalElement.textContent : '';
    
    // Informations de base (récupérées du DOM)
    const infoReference = document.getElementById('info-reference');
    const infoPrix = document.getElementById('info-prix');
    const infoSousTotal = document.getElementById('info-sous-total');
    
    if (infoReference) infoReference.textContent = reference;
    if (infoPrix) infoPrix.textContent = prixText;
    if (infoSousTotal) infoSousTotal.textContent = sousTotal;
    
    // Récupérer les caractéristiques depuis les badges
    const caracteristiques = extraireCaracteristiquesDepuisBadges(articleCard);
    
    // Mettre à jour les informations dans la modale
    console.log('📝 Mise à jour des infos modale:', {
        taille: caracteristiques.taille,
        couleur: caracteristiques.couleur,
        categorie: caracteristiques.categorie
    });
    
    const infoPointure = document.getElementById('info-pointure');
    const infoCouleur = document.getElementById('info-couleur');
    const infoCategorie = document.getElementById('info-categorie');
    
    if (infoPointure) infoPointure.textContent = caracteristiques.taille || 'Non spécifiée';
    if (infoCouleur) infoCouleur.textContent = caracteristiques.couleur || 'Non spécifiée';
    if (infoCategorie) infoCategorie.textContent = caracteristiques.categorie || 'Non spécifiée';
    
    // Mettre à jour les badges dans la modale
    mettreAJourBadgesModale(caracteristiques);
    
    // Récupérer le stock depuis le badge vert s'il existe
    const infoStock = document.getElementById('info-stock');
    const infoDescription = document.getElementById('info-description');
    
    if (caracteristiques.stock && infoStock) {
        infoStock.textContent = caracteristiques.stock;
    } else {
        // Essayer de récupérer depuis l'API
        chargerInfosCompletesArticle(reference);
    }
    
    if (infoDescription) infoDescription.textContent = caracteristiques.description || '';
    
    console.log('📋 Caractéristiques extraites:', caracteristiques);
    
    document.getElementById('article-info').classList.remove('hidden');
}

// Fonction pour extraire les caractéristiques depuis les badges de l'article
function extraireCaracteristiquesDepuisBadges(articleCard) {
    const caracteristiques = {
        taille: null,
        couleur: null,
        categorie: null,
        stock: null,
        description: ''
    };
    
    // Essayer d'abord de récupérer les données depuis le dataset de la carte
    try {
        const articleData = JSON.parse(articleCard.dataset.article || '{}');
        if (articleData && articleData.id) {
            console.log('📊 Utilisation des données du dataset pour les caractéristiques');
            
            // Récupérer les données directement depuis le dataset
            caracteristiques.taille = articleData.pointure || null;
            caracteristiques.couleur = articleData.couleur || null;
            caracteristiques.categorie = articleData.categorie || null;
            
            // Convertir le stock en nombre
            const stock = typeof articleData.qte_disponible === 'number' ? 
                          articleData.qte_disponible : 
                          (articleData.qte_disponible ? parseInt(articleData.qte_disponible) : 0);
            
            caracteristiques.stock = `Stock: ${stock}`;
            console.log('📦 Stock récupéré depuis dataset:', stock);
            
            return caracteristiques;
        }
    } catch (error) {
        console.warn('⚠️ Erreur lors de la récupération des données depuis le dataset:', error);
        // Continuer avec la méthode des badges
    }
    
    // Chercher la section contenant les badges
    const badgesContainer = articleCard.querySelector('.flex.flex-wrap.gap-2');
    
    if (badgesContainer) {
        const badges = badgesContainer.querySelectorAll('span');
        
        badges.forEach(badge => {
            const badgeText = badge.textContent.trim();
            const icon = badge.querySelector('i');
            
            if (icon) {
                const iconClasses = icon.className;
                
                // Détecter le type selon l'icône
                if (iconClasses.includes('fa-ruler-vertical')) {
                    // Badge de taille - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.taille = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-palette')) {
                    // Badge de couleur - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.couleur = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-tag')) {
                    // Badge de catégorie - la valeur est directement dans le badge sans préfixe
                    if (!badgeText.includes('N/A')) {
                        caracteristiques.categorie = badgeText.trim();
                    }
                } else if (iconClasses.includes('fa-boxes')) {
                    // Badge de stock - garde le format complet "Stock: X"
                    caracteristiques.stock = badgeText.trim();
                    console.log('📦 Stock récupéré depuis badge:', badgeText.trim());
                }
            }
        });
        
        console.log('🏷️ Badges trouvés et analysés:', {
            totalBadges: badges.length,
            caracteristiques: caracteristiques
        });
        
        // Debug détaillé de chaque badge
        badges.forEach((badge, index) => {
            console.log(`Badge ${index + 1}:`, {
                text: badge.textContent.trim(),
                classes: badge.className,
                iconClasses: badge.querySelector('i')?.className || 'Pas d\'icône'
            });
        });
    } else {
        console.warn('⚠️ Conteneur de badges non trouvé pour cet article');
        
        // Fallback : essayer l'ancien format
        const oldInfoSection = articleCard.querySelector('.text-xs.text-gray-600');
        if (oldInfoSection) {
            const infoText = oldInfoSection.textContent;
            
            // Extraire avec regex de l'ancien format
            const tailleMatch = infoText.match(/Taille:\s*([^,\s]+)/i);
            const couleurMatch = infoText.match(/Couleur:\s*([^,\s]+)/i);
            const categorieMatch = infoText.match(/Catégorie:\s*([^,\s]+)/i);
            const stockMatch = infoText.match(/Stock:\s*(\d+)/i);
            
            if (tailleMatch) caracteristiques.taille = tailleMatch[1];
            if (couleurMatch) caracteristiques.couleur = couleurMatch[1];
            if (categorieMatch) caracteristiques.categorie = categorieMatch[1];
            if (stockMatch) caracteristiques.stock = `Stock: ${stockMatch[1]}`;
            
            console.log('🔄 Fallback vers ancien format utilisé');
        }
    }
    
    // Si aucun stock n'a été trouvé, mettre une valeur par défaut
    if (!caracteristiques.stock) {
        caracteristiques.stock = 'Stock: 0';
        console.log('⚠️ Aucun stock trouvé, valeur par défaut utilisée');
    }
    
    return caracteristiques;
}

// Fonction pour mettre à jour les badges de caractéristiques dans la modale
function mettreAJourBadgesModale(caracteristiques) {
    const badgesContainer = document.getElementById('caracteristiques-badges');
    
    if (!badgesContainer) {
        console.warn('⚠️ Conteneur de badges de la modale non trouvé (ID: caracteristiques-badges)');
        return;
    }
    
    // Vider le conteneur
    badgesContainer.innerHTML = '';
    
    // Créer un fragment pour améliorer les performances
    const fragment = document.createDocumentFragment();

    // Fonction pour créer un badge
    const createBadge = (text, iconClass, colorClass) => {
        if (!text) return;
        const badge = document.createElement('span');
        badge.className = `inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${colorClass}`;
        badge.innerHTML = `<i class="fas ${iconClass} mr-1.5"></i>${text}`;
        fragment.appendChild(badge);
    };

    // Ajouter les badges pour chaque caractéristique
    createBadge(caracteristiques.taille, 'fa-ruler-vertical', 'bg-purple-100 text-purple-800');
    createBadge(caracteristiques.couleur, 'fa-palette', 'bg-orange-100 text-orange-800');
    createBadge(caracteristiques.categorie, 'fa-tag', 'bg-indigo-100 text-indigo-800');
    
    // Badge Stock avec couleur selon la quantité
    if (caracteristiques.stock) {
        let stockValue = 0;
        const stockMatch = caracteristiques.stock.match(/-?\d+/); // Gère les nombres négatifs au cas où
        if (stockMatch) {
            stockValue = parseInt(stockMatch[0], 10);
        }
        
        if (stockValue <= 0) {
            createBadge('Stock épuisé', 'fa-times-circle', 'bg-red-100 text-red-800');
        } else if (stockValue < 10) {
            createBadge(`Stock: ${stockValue} (faible)`, 'fa-exclamation-triangle', 'bg-yellow-100 text-yellow-800');
    } else {
            createBadge(`${caracteristiques.stock}`, 'fa-check-circle', 'bg-green-100 text-green-800');
        }
    } else {
        createBadge('Stock inconnu', 'fa-question-circle', 'bg-gray-100 text-gray-800');
    }
    
    // Ajouter tous les badges au DOM en une seule fois
    badgesContainer.appendChild(fragment);
}

// Fonction pour charger les informations complètes d'un article par sa référence
function chargerInfosCompletesArticle(reference) {
    // Chercher l'article dans la liste déjà chargée
    if (articlesDisponibles && articlesDisponibles.length > 0) {
        const article = articlesDisponibles.find(a => a.reference === reference);
        if (article) {
            // Mettre à jour avec les informations complètes
            const infoPointure = document.getElementById('info-pointure');
            const infoCouleur = document.getElementById('info-couleur');
            const infoCategorie = document.getElementById('info-categorie');
            const infoStock = document.getElementById('info-stock');
            
            // Vérifier que qte_disponible est bien défini et convertir en nombre
            const stock = typeof article.qte_disponible === 'number' ? article.qte_disponible : 
                         (article.qte_disponible ? parseInt(article.qte_disponible) : 0);
            
            if (infoPointure) infoPointure.textContent = article.pointure || '-';
            if (infoCouleur) infoCouleur.textContent = article.couleur || '-';
            if (infoCategorie) infoCategorie.textContent = article.categorie || '-';
            if (infoStock) infoStock.textContent = `${stock} unité(s)`;
            
            console.log('📋 Informations complètes trouvées pour:', reference, article);
            console.log('📊 Stock affiché:', stock, 'Type:', typeof stock);
            return;
        }
    }
    
    // Si l'article n'est pas dans la liste, afficher des valeurs par défaut
    document.getElementById('info-pointure').textContent = '-';
    document.getElementById('info-couleur').textContent = '-';
    document.getElementById('info-categorie').textContent = '-';
    document.getElementById('info-stock').textContent = '0 unité(s)';
    
    console.log('⚠️ Informations complètes non trouvées pour:', reference);
}

// Fonction pour charger les articles disponibles via API
function chargerArticlesDisponibles() {
    const select = document.getElementById('articleSelect');
    const tableBody = document.getElementById('articlesTableBody');
    if (!select || !tableBody) {
        console.error('❌ Élément articleSelect ou articlesTableBody introuvable');
        return;
    }
    // état de chargement
    tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">
        <i class="fas fa-spinner fa-spin mr-2"></i>Chargement des articles...
    </td></tr>`;
    select.innerHTML = '<option value="">-- Chargement des articles... --</option>';
    console.log('🔄 Début du chargement des articles...');
    
    // Récupérer le token CSRF avec vérification
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('❌ Token CSRF introuvable');
        select.innerHTML = '<option value="">-- Erreur: Token CSRF manquant --</option>';
        return;
    }
    
    // URL de l'API
    const apiUrl = '{% url "operatConfirme:api_articles_disponibles" %}';
    console.log('🌐 URL API:', apiUrl);
    
    // Appel AJAX pour récupérer les articles
    fetch(apiUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        console.log('📡 Réponse reçue, status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('📊 Données reçues:', data);
        
        // Correction: La vue renvoie directement un tableau d'articles, pas un objet avec une propriété 'success'
        // Vérifier si data est un tableau ou un objet avec une propriété 'articles'
        if (Array.isArray(data)) {
            articlesDisponibles = data;
        } else if (data && data.articles) {
            articlesDisponibles = data.articles;
        } else {
            articlesDisponibles = [];
        }
        
        // Remplir le select (compatibilité) et le tableau (nouveau rendu)
        select.innerHTML = '<option value="">-- Sélectionner un article --</option>';
        tableBody.innerHTML = '';
        
        if (articlesDisponibles.length === 0) {
            select.innerHTML = '<option value="">-- Aucun article disponible --</option>';
            tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Aucun article disponible</td></tr>`;
            console.warn('⚠️ Aucun article trouvé dans la base de données');
            showNotification('⚠️ Aucun article disponible', 'error');
            return;
        }
        
        articlesDisponibles.forEach((article, index) => {
            try {
                const option = document.createElement('option');
                option.value = article.id;
                
                // Construire un texte plus informatif avec vérifications
                let optionText = article.nom || 'Article sans nom';
                
                // Ajouter les badges de statut AVANT le prix
                const badges = [];
                
                // Vérifier les différents statuts
                if (article.has_promo_active) {
                    badges.push('🔥PROMO');
                }
                if (article.phase === 'LIQUIDATION') {
                    badges.push('🏷️LIQUIDATION');
                }
                if (article.phase === 'EN_TEST') {
                    badges.push('🧪TEST');
                }
                if (article.isUpsell) {
                    badges.push('⬆️UPSELL');
                }
                
                // Ajouter les badges au nom
                if (badges.length > 0) {
                    optionText += ` [${badges.join(' ')}]`;
                }
                
                if (article.prix_actuel) {
                    optionText += ` - ${article.prix_actuel} DH`;
                }
                
                // Ajouter taille et couleur si disponibles
                const details = [];
                if (article.pointure && article.pointure.trim()) {
                    details.push(`T:${article.pointure}`);
                }
                if (article.couleur && article.couleur.trim()) {
                    details.push(`C:${article.couleur}`);
                }
                
                if (details.length > 0) {
                    optionText += ` (${details.join(', ')})`;
                }
                
                option.textContent = optionText;
                option.dataset.article = JSON.stringify(article);
                
                // Ajouter des classes CSS pour styliser selon le type
                if (article.has_promo_active) {
                    option.style.backgroundColor = '#fef2f2';
                    option.style.color = '#dc2626';
                    option.style.fontWeight = 'bold';
                } else if (article.phase === 'LIQUIDATION') {
                    option.style.backgroundColor = '#fff7ed';
                    option.style.color = '#ea580c';
                    option.style.fontWeight = 'bold';
                } else if (article.phase === 'EN_TEST') {
                    option.style.backgroundColor = '#eff6ff';
                    option.style.color = '#2563eb';
                    option.style.fontWeight = 'bold';
                } else if (article.isUpsell) {
                    option.style.backgroundColor = '#f0fdf4';
                    option.style.color = '#16a34a';
                    option.style.fontWeight = 'bold';
                }
                
                select.appendChild(option);

                // Ligne du tableau
                const tr = document.createElement('tr');
                tr.dataset.article = JSON.stringify(article);

                // Déterminer classes de fond/texte selon type pour garder les mêmes couleurs
                let rowBg = '';
                let badgeHtml = '';
                if (article.has_promo_active) {
                    rowBg = 'bg-red-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-fire mr-1"></i>PROMO</span>';
                }
                if (article.phase === 'LIQUIDATION') {
                    rowBg = 'bg-orange-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-tags mr-1"></i>LIQUIDATION</span>';
                }
                if (article.phase === 'EN_TEST') {
                    rowBg = 'bg-blue-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-flask mr-1"></i>TEST</span>';
                }
                if (article.isUpsell) {
                    rowBg = 'bg-green-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-arrow-up mr-1"></i>UPSELL</span>';
                }
                tr.className = rowBg;

                const prixActuel = (typeof article.prix_actuel === 'number' ? article.prix_actuel : (article.prix_unitaire || 0));
                const stock = (typeof article.qte_disponible === 'number' ? article.qte_disponible : (parseInt(article.qte_disponible || '0') || 0));

                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-start space-x-4">
                            <!-- Image de l'article -->
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 border-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                    ${article.image_url ? 
                                        `<img src="${article.image_url}" alt="Image de ${article.nom}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
                                        ''
                                    }
                                    <div class="w-full h-full flex items-center justify-center text-gray-400 ${article.image_url ? 'hidden' : ''}">
                                        <i class="fas fa-image text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informations de l'article -->
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900">${article.nom || ''}</div>
                                <div class="text-xs text-gray-500">Réf: ${article.reference || '-'}</div>
                                <div class="mt-1">${badgeHtml}</div>
                                <div class="mt-1 flex flex-wrap gap-2 text-xs">
                                    ${typeof article.categorie === 'string' ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full"><i class=\"fas fa-tag mr-1\"></i>${article.categorie}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center font-semibold text-green-600">${prixActuel} DH</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${stock <= 0 ? 'bg-red-100 text-red-700' : (stock < 5 ? 'bg-orange-100 text-orange-700' : 'bg-teal-100 text-teal-700')}">
                            ${stock <= 0 ? 'Épuisé' : stock + ' unités'}
                        </span>
                    </td>

                    <td class="px-4 py-3 text-center">
                        <button type="button" class="px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg" onclick="ajouterDepuisLigne(this)">
                            <i class="fas fa-plus mr-1"></i>Ajouter
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
                
                console.log(`📦 Article ${index + 1} ajouté:`, {
                    id: article.id,
                    nom: article.nom,
                    prix: article.prix_actuel,
                    pointure: article.pointure,
                    couleur: article.couleur
                });
                
            } catch (error) {
                console.error(`❌ Erreur lors de l'ajout de l'article ${index + 1}:`, error, article);
            }
        });
        
        console.log(`✅ ${articlesDisponibles.length} articles chargés avec succès`);
        
        // Debug des premiers articles pour vérifier les données
        if (articlesDisponibles.length > 0) {
            console.log('🔍 DEBUG: Premier article chargé:', articlesDisponibles[0]);
            console.log('🔍 DEBUG: Champs disponibles:', Object.keys(articlesDisponibles[0]));
        }
        
        // Sauvegarder dans la variable globale
        window.articlesDisponibles = articlesDisponibles;
        
        showNotification(`✅ ${articlesDisponibles.length} article(s) chargé(s)`, 'success');
        
        // Mettre à jour les compteurs des badges
        mettreAJourCompteursFiltre();
        
        // Réinitialiser la scrollbar après le chargement des articles
        reinitScrollbarAfterArticlesLoad();
    })
    .catch(error => {
        select.innerHTML = '<option value="">-- Erreur de connexion --</option>';
        if (tableBody) {
            tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-red-600 bg-red-50">Erreur de connexion</td></tr>`;
        }
        console.error('❌ Erreur AJAX complète:', error);
        
        // Messages d'erreur plus spécifiques
        let errorMessage = 'Erreur de connexion';
        if (error.message.includes('403')) {
            errorMessage = 'Accès refusé - Vérifiez vos permissions';
        } else if (error.message.includes('404')) {
            errorMessage = 'API introuvable - Vérifiez l\'URL';
        } else if (error.message.includes('500')) {
            errorMessage = 'Erreur serveur - Vérifiez les logs Django';
        }
        
        showNotification(`❌ ${errorMessage}`, 'error');
        
        // Proposer une solution de fallback
        console.log('💡 Solutions possibles:');
        console.log('   1. Vérifiez que vous êtes connecté comme opérateur de confirmation');
        console.log('   2. Vérifiez qu\'il y a des articles dans la base de données');
        console.log('   3. Vérifiez les logs Django pour plus de détails');
        
        // Utiliser des données de fallback pour permettre de continuer à travailler
        utiliserArticlesFallback();
    });
}

// Fonction de fallback pour les articles en cas d'erreur de chargement
function utiliserArticlesFallback() {
    console.log('⚠️ Utilisation des articles de fallback pour permettre de continuer à travailler');
    
    // Créer quelques articles de base pour pouvoir continuer
    articlesDisponibles = [
        {
            id: 'fallback-1',
            nom: '[FALLBACK] Article test 1',
            reference: 'REF001',
            prix_unitaire: 299,
            prix_actuel: 299,
            pointure: '37',
            couleur: 'Noir',
            categorie: 'Chaussure',
            qte_disponible: 10,
            has_promo_active: false,
            phase: 'NORMAL',
            isUpsell: false
        },
        {
            id: 'fallback-2',
            nom: '[FALLBACK] Article test 2',
            reference: 'REF002',
            prix_unitaire: 399,
            prix_actuel: 399,
            pointure: '38',
            couleur: 'Blanc',
            categorie: 'Chaussure',
            qte_disponible: 5,
            has_promo_active: false,
            phase: 'NORMAL',
            isUpsell: true
        }
    ];
    
    // Mettre à jour l'interface avec ces articles de fallback
    const select = document.getElementById('articleSelect');
    const tableBody = document.getElementById('articlesTableBody');
    if (select) {
        select.innerHTML = '<option value="">-- Données de fallback --</option>';
        
        articlesDisponibles.forEach((article, index) => {
            const option = document.createElement('option');
            option.value = article.id;
            option.textContent = `${article.nom} - ${article.prix_actuel} DH (T:${article.pointure}, C:${article.couleur})`;
            option.dataset.article = JSON.stringify(article);
            select.appendChild(option);
        });
    }
    if (tableBody) {
        tableBody.innerHTML = '';
        articlesDisponibles.forEach(article => {
            const tr = document.createElement('tr');
            tr.dataset.article = JSON.stringify(article);
            tr.innerHTML = `
                <td class="px-4 py-3">
                    <div class="flex items-start space-x-4">
                        <!-- Image de l'article -->
                        <div class="flex-shrink-0">
                            <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 border-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                <div class="w-full h-full flex items-center justify-center text-gray-400">
                                    <i class="fas fa-image text-xl"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informations de l'article -->
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-gray-900">${article.nom}</div>
                            <div class="text-xs text-gray-500">Réf: ${article.reference}</div>
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center font-semibold text-green-600">${article.prix_actuel} DH</td>
                <td class="px-4 py-3 text-center"><span class="px-2 py-0.5 bg-teal-100 text-teal-700 rounded-full text-xs">${article.qte_disponible} unités</span></td>

                <td class="px-4 py-3 text-center">
                    <button type="button" class="px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg" onclick="ajouterDepuisLigne(this)">
                        <i class="fas fa-plus mr-1"></i>Ajouter
                    </button>
                </td>`;
            tableBody.appendChild(tr);
        });
    }
    
    showNotification('⚠️ Utilisation de données de fallback pour continuer à travailler', 'warning');
}

// ===== Fonctions utilitaires pour le tableau d'articles (nouvelle UI) =====

function ajouterDepuisLigne(button) {
    try {
        const tr = button.closest('tr');
        if (!tr) return;
        const article = JSON.parse(tr.dataset.article || '{}');
        
        // Ouvrir le modal de sélection des variantes
        ouvrirModalVariantes(article);
    } catch (e) {
        console.error('❌ Erreur ajout depuis ligne:', e);
        showToast('❌ Erreur lors de l\'ouverture du modal de variantes', 'error');
    }
}

function rechercherArticles(terme) {
    const value = (terme || '').toString().toLowerCase();
    const rows = document.querySelectorAll('#articlesTableBody tr');
    rows.forEach(row => {
        try {
            const article = JSON.parse(row.dataset.article || '{}');
            const cible = [article.nom, article.reference, article.couleur, article.pointure, article.categorie]
                .filter(Boolean)
                .join(' ')
                .toLowerCase();
            row.style.display = !value || cible.includes(value) ? '' : 'none';
        } catch (_) {}
    });
}

function fermerModalAjouterArticle() {
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// ===== Gestion du modal des variantes =====
function ouvrirModalVariantes(article) {
    try {
        console.log('🎯 Ouverture modal variantes pour article:', article);
        
        // Vérifier que l'article a un ID valide
        if (!article || !article.id) {
            console.error('❌ Article invalide ou sans ID:', article);
            showToast('❌ Erreur: Article invalide', 'error');
            return;
        }
        
        // Fermer le modal "Ajouter un article" s'il est ouvert
        fermerModalAjouterArticle();
        
        // Mettre à jour les informations de l'article
        document.getElementById('articleNom').textContent = article.nom || 'Article';
        document.getElementById('articleReference').textContent = `Réf: ${article.reference || ''}`;
        
        // Réinitialiser l'état du modal AVANT de définir l'article
        reinitialiserModalVariantes();
        
        // Stocker l'article actuel APRÈS la réinitialisation
        window.currentArticle = article;
        console.log('🔍 DEBUG ouvrirModalVariantes - window.currentArticle défini:', window.currentArticle);
        
        // Charger les variantes de l'article
        chargerVariantesArticle(article);
        
        // Afficher le modal
        const modal = document.getElementById('variantModal');
        if (modal) {
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
    } catch (e) {
        console.error('❌ Erreur ouverture modal variantes:', e);
        showToast('❌ Erreur lors de l\'ouverture du modal', 'error');
    }
}

function fermerModalVariantes() {
    console.log('🔍 DEBUG fermerModalVariantes - avant nettoyage, window.currentArticle:', window.currentArticle);
    
    const modal = document.getElementById('variantModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    
    // Réinitialiser les informations des variantes sélectionnées
    const selectedVariantsInfo = document.getElementById('selectedVariantsInfo');
    const addSelectedVariantsBtn = document.getElementById('addSelectedVariantsBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    
    if (selectedVariantsInfo) selectedVariantsInfo.classList.add('hidden');
    if (addSelectedVariantsBtn) addSelectedVariantsBtn.classList.add('hidden');
    if (clearSelectionBtn) clearSelectionBtn.classList.add('hidden');
    
    // Nettoyer les variables globales
    window.selectedVariants = [];
    window.currentArticle = null;
    window.variantsData = null;
    console.log('🔍 DEBUG fermerModalVariantes - après nettoyage, window.currentArticle:', window.currentArticle);
}

function reinitialiserModalVariantes() {
    // Réinitialiser les informations des variantes sélectionnées
    const selectedVariantsInfo = document.getElementById('selectedVariantsInfo');
    const addSelectedVariantsBtn = document.getElementById('addSelectedVariantsBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    
    if (selectedVariantsInfo) selectedVariantsInfo.classList.add('hidden');
    if (addSelectedVariantsBtn) addSelectedVariantsBtn.classList.add('hidden');
    if (clearSelectionBtn) clearSelectionBtn.classList.add('hidden');
    
    // Nettoyer les variables globales
    window.selectedVariants = [];
    window.currentArticle = null;
    window.variantsData = null;
}

function chargerVariantesArticle(article) {
    try {
        const variantsTableContainer = document.getElementById('variantsTableContainer');
        if (!variantsTableContainer) return;
        
        console.log('🔍 Chargement des variantes pour l\'article:', article);
        console.log('🔍 ID de l\'article:', article.id, 'Type:', typeof article.id);
        
        if (!article.id) {
            console.error('❌ ID d\'article manquant');
            variantsTableContainer.innerHTML = '<div class="text-center py-4 text-red-500">❌ ID d\'article manquant</div>';
            return;
        }
        
        variantsTableContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement des variantes...</div>';
        
        const url = `/operateur-confirme/get-article-variants/${article.id}/`;
        console.log('📡 URL de requête:', url);
        
        // Faire une requête AJAX pour récupérer les variantes
        fetch(url)
            .then(response => {
                console.log('📥 Réponse reçue:', response.status, response.statusText);
                return response.json();
            })
            .then(data => {
                console.log('📊 Données reçues:', data);
                if (data.success && data.variants) {
                    console.log(`✅ ${data.variants.length} variantes trouvées`);
                    afficherVariantes(data.variants, article);
                } else {
                    console.log('❌ Aucune variante ou erreur:', data.error);
                    variantsTableContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Aucune variante disponible</div>';
                }
            })
            .catch(error => {
                console.error('❌ Erreur chargement variantes:', error);
                variantsTableContainer.innerHTML = '<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors du chargement</div>';
            });
    } catch (e) {
        console.error('❌ Erreur chargerVariantesArticle:', e);
    }
}

function afficherVariantes(variants, article) {
    const variantsTableContainer = document.getElementById('variantsTableContainer');
    if (!variantsTableContainer) return;
    
    if (variants.length === 0) {
        variantsTableContainer.innerHTML = '<div class="text-center py-4 text-gray-500">Aucune variante disponible</div>';
        return;
    }
    
    // Analyser les variantes pour créer le tableau croisé
    const { tableHtml, variantMap } = creerTableauCroise(variants);
    variantsTableContainer.innerHTML = tableHtml;
    
    // Stocker les données des variantes pour la sélection
    window.variantsData = variantMap;
    // window.currentArticle est déjà défini dans ouvrirModalVariantes
    
    // Ajouter les event listeners pour les checkboxes
    ajouterEventListenersCheckboxes();
}

function creerTableauCroise(variants) {
    // Extraire les valeurs uniques pour chaque attribut
    const couleurs = [...new Set(variants.map(v => v.couleur).filter(Boolean))];
    const pointures = [...new Set(variants.map(v => v.pointure).filter(Boolean))];
    const tailles = [...new Set(variants.map(v => v.taille).filter(Boolean))];
    
    // Déterminer les dimensions du tableau
    let dimension1, dimension2, valeurs1, valeurs2;
    
    if (couleurs.length > 0 && pointures.length > 0) {
        dimension1 = 'couleur';
        dimension2 = 'pointure';
        valeurs1 = couleurs;
        valeurs2 = pointures;
    } else if (couleurs.length > 0 && tailles.length > 0) {
        dimension1 = 'couleur';
        dimension2 = 'taille';
        valeurs1 = couleurs;
        valeurs2 = tailles;
    } else if (pointures.length > 0 && tailles.length > 0) {
        dimension1 = 'pointure';
        dimension2 = 'taille';
        valeurs1 = pointures;
        valeurs2 = tailles;
    } else if (couleurs.length > 0) {
        // Seulement des couleurs
        dimension1 = 'couleur';
        dimension2 = null;
        valeurs1 = couleurs;
        valeurs2 = [];
    } else if (pointures.length > 0) {
        // Seulement des pointures
        dimension1 = 'pointure';
        dimension2 = null;
        valeurs1 = pointures;
        valeurs2 = [];
    } else if (tailles.length > 0) {
        // Seulement des tailles
        dimension1 = 'taille';
        dimension2 = null;
        valeurs1 = tailles;
        valeurs2 = [];
    } else {
        // Aucune dimension claire, afficher en liste simple
        return creerListeSimple(variants);
    }
    
    // Créer une map pour accéder rapidement aux variantes
    const variantMap = {};
    
    // Si on n'a qu'une dimension, créer un tableau simple
    if (!dimension2) {
        return creerTableauSimple(variants, dimension1, valeurs1, variantMap);
    }
    
    let tableHtml = `
        <div class="overflow-x-auto">
            <table class="variant-table min-w-full rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th>
                            ${dimension1.charAt(0).toUpperCase() + dimension1.slice(1)} / ${dimension2.charAt(0).toUpperCase() + dimension2.slice(1)}
                        </th>
    `;
    
    // En-têtes de colonnes
    valeurs2.forEach(val2 => {
        tableHtml += `
            <th>
                ${val2 || 'N/A'}
            </th>
        `;
    });
    
    tableHtml += '</tr></thead><tbody>';
    
    // Lignes du tableau
    valeurs1.forEach(val1 => {
        tableHtml += `
            <tr>
                <td class="font-medium">
                    ${val1 || 'N/A'}
                </td>
        `;
        
        valeurs2.forEach(val2 => {
            // Trouver la variante correspondante
            const variant = variants.find(v => {
                const v1 = dimension1 === 'couleur' ? v.couleur : (dimension1 === 'pointure' ? v.pointure : v.taille);
                const v2 = dimension2 === 'couleur' ? v.couleur : (dimension2 === 'pointure' ? v.pointure : v.taille);
                return v1 === val1 && v2 === val2;
            });
            
            if (variant) {
                const stockClass = variant.stock > 0 ? 'stock-disponible' : 'stock-rupture';
                const stockText = variant.stock > 0 ? `${variant.stock} en stock` : 'Rupture';
                const checkboxDisabled = variant.stock <= 0 ? 'disabled' : '';
                
                // Créer une clé unique pour cette variante
                const variantKey = `${variant.id}`;
                variantMap[variantKey] = variant;
                
                tableHtml += `
                    <td>
                        <div class="space-y-2">
                            <div class="flex justify-center items-center">
                                <input type="checkbox" name="variantSelection" value="${variantKey}" 
                                       id="variant_${variantKey}" class="variant-checkbox" ${checkboxDisabled}
                                       onchange="selectionnerVarianteFromTable('${variantKey}', this.checked)">
                                <label for="variant_${variantKey}" class="ml-2 text-sm font-medium ${variant.stock > 0 ? 'cursor-pointer' : 'cursor-not-allowed'}">
                                    ${variant.prix_unitaire} DH
                                </label>
                            </div>
                            <div class="text-xs ${stockClass} font-medium">${stockText}</div>
                        </div>
                    </td>
                `;
            } else {
                tableHtml += `
                    <td class="bg-gray-100">
                        <span class="text-gray-400 text-xs">-</span>
                    </td>
                `;
            }
        });
        
        tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table></div>';
    
    return { tableHtml, variantMap };
}

function creerTableauSimple(variants, dimension, valeurs, variantMap) {
    let tableHtml = `
        <div class="overflow-x-auto">
            <table class="variant-table min-w-full rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th>${dimension.charAt(0).toUpperCase() + dimension.slice(1)}</th>
                        <th>Prix</th>
                        <th>Stock</th>
                        <th>Sélection</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    valeurs.forEach(val => {
        const variant = variants.find(v => {
            const v1 = dimension === 'couleur' ? v.couleur : (dimension === 'pointure' ? v.pointure : v.taille);
            return v1 === val;
        });
        
        if (variant) {
            const stockClass = variant.stock > 0 ? 'stock-disponible' : 'stock-rupture';
            const stockText = variant.stock > 0 ? `${variant.stock} en stock` : 'Rupture';
            const checkboxDisabled = variant.stock <= 0 ? 'disabled' : '';
            
            const variantKey = `${variant.id}`;
            variantMap[variantKey] = variant;
            
            tableHtml += `
                <tr>
                    <td class="font-medium">${val || 'N/A'}</td>
                    <td class="font-semibold">${variant.prix_unitaire} DH</td>
                    <td class="${stockClass}">${stockText}</td>
                    <td class="text-center">
                        <input type="checkbox" name="variantSelection" value="${variantKey}" 
                               id="variant_${variantKey}" class="variant-checkbox" ${checkboxDisabled}
                               onchange="selectionnerVarianteFromTable('${variantKey}', this.checked)">
                    </td>
                </tr>
            `;
        }
    });
    
    tableHtml += '</tbody></table></div>';
    return { tableHtml, variantMap };
}

function creerListeSimple(variants) {
    const variantMap = {};
    
    let tableHtml = `
        <div class="overflow-x-auto">
            <table class="variant-table min-w-full rounded-lg overflow-hidden">
                <thead>
                    <tr>
                        <th>Variante</th>
                        <th>Prix</th>
                        <th>Stock</th>
                        <th>Sélection</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    variants.forEach((variant, index) => {
        const stockClass = variant.stock > 0 ? 'stock-disponible' : 'stock-rupture';
        const stockText = variant.stock > 0 ? `${variant.stock} en stock` : 'Rupture';
        const checkboxDisabled = variant.stock <= 0 ? 'disabled' : '';
        
        const variantKey = `${variant.id}`;
        variantMap[variantKey] = variant;
        
        const variantInfo = [
            variant.couleur ? `Couleur: ${variant.couleur}` : '',
            variant.pointure ? `Pointure: ${variant.pointure}` : '',
            variant.taille ? `Taille: ${variant.taille}` : ''
        ].filter(Boolean).join(' | ');
        
        tableHtml += `
            <tr>
                <td class="font-medium">${variantInfo || 'Variante ' + (index + 1)}</td>
                <td class="font-semibold">${variant.prix_unitaire} DH</td>
                <td class="${stockClass}">${stockText}</td>
                <td class="text-center">
                    <input type="checkbox" name="variantSelection" value="${variantKey}" 
                           id="variant_${variantKey}" class="variant-checkbox" ${checkboxDisabled}
                           onchange="selectionnerVarianteFromTable('${variantKey}', this.checked)">
                </td>
            </tr>
        `;
    });
    
    tableHtml += '</tbody></table></div>';
    return { tableHtml, variantMap };
}

function ajouterEventListenersCheckboxes() {
    const checkboxes = document.querySelectorAll('.variant-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            // Pas besoin de décocher les autres pour les checkboxes multiples
            // La logique est gérée dans selectionnerVarianteFromTable
        });
    });
}

function selectionnerVarianteFromTable(variantKey, isChecked) {
    if (!window.variantsData || !window.variantsData[variantKey]) {
        console.error('❌ Variante non trouvée:', variantKey);
        return;
    }
    
    const variant = window.variantsData[variantKey];
    
    // Initialiser le tableau des variantes sélectionnées s'il n'existe pas
    if (!window.selectedVariants) {
        window.selectedVariants = [];
    }
    
    if (isChecked) {
        // Ajouter la variante à la sélection
        if (!window.selectedVariants.find(v => v.id === variant.id)) {
            window.selectedVariants.push(variant);
        }
    } else {
        // Retirer la variante de la sélection
        window.selectedVariants = window.selectedVariants.filter(v => v.id !== variant.id);
    }
    
    // Mettre à jour l'affichage des informations
    mettreAJourAffichageVariantesSelectionnees();
    
    // Afficher un message de confirmation
    if (isChecked) {
        showToast(`✅ Variante ajoutée à la sélection (${window.selectedVariants.length} sélectionnée(s))`, 'success');
    } else {
        showToast(`🔄 Variante retirée de la sélection (${window.selectedVariants.length} sélectionnée(s))`, 'info');
    }
}

function mettreAJourAffichageVariantesSelectionnees() {
    const selectedVariantsInfo = document.getElementById('selectedVariantsInfo');
    const selectedVariantsDetails = document.getElementById('selectedVariantsDetails');
    const addSelectedVariantsBtn = document.getElementById('addSelectedVariantsBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    
    if (!selectedVariantsInfo || !selectedVariantsDetails || !addSelectedVariantsBtn || !clearSelectionBtn) {
        return;
    }
    
    if (window.selectedVariants && window.selectedVariants.length > 0) {
        // Afficher les informations des variantes sélectionnées
        let details = `<div class="mb-3"><strong>${window.selectedVariants.length} variante(s) sélectionnée(s):</strong></div>`;
        
        window.selectedVariants.forEach((variant, index) => {
            const stockStatus = variant.stock > 0 ? 
                `<span class="text-green-600">${variant.stock} en stock</span>` : 
                '<span class="text-red-600">Rupture</span>';
            
            details += `
                <div class="border-l-4 border-blue-200 pl-3 mb-2 ${index > 0 ? 'mt-3' : ''}">
                    <div class="font-medium">Variante ${index + 1}</div>
                    <div class="text-sm text-gray-600">
                        <strong>Prix:</strong> ${variant.prix_unitaire} DH | 
                        <strong>Stock:</strong> ${stockStatus}
                    </div>
                    <div class="text-xs text-gray-500">
                        ${variant.couleur ? `Couleur: ${variant.couleur} | ` : ''}
                        ${variant.pointure ? `Pointure: ${variant.pointure} | ` : ''}
                        ${variant.taille ? `Taille: ${variant.taille}` : ''}
                    </div>
                </div>
            `;
        });
        
        selectedVariantsDetails.innerHTML = details;
        selectedVariantsInfo.classList.remove('hidden');
        addSelectedVariantsBtn.classList.remove('hidden');
        clearSelectionBtn.classList.remove('hidden');
        
        // Mettre à jour le texte du bouton d'ajout
        addSelectedVariantsBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Ajouter ${window.selectedVariants.length} variante(s)`;
    } else {
        // Masquer les informations si aucune variante n'est sélectionnée
        selectedVariantsInfo.classList.add('hidden');
        addSelectedVariantsBtn.classList.add('hidden');
        clearSelectionBtn.classList.add('hidden');
    }
}

function effacerSelectionVariantes() {
    // Décocher tous les checkboxes
    const checkboxes = document.querySelectorAll('.variant-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    
    // Masquer les informations des variantes sélectionnées
    const selectedVariantsInfo = document.getElementById('selectedVariantsInfo');
    const addSelectedVariantsBtn = document.getElementById('addSelectedVariantsBtn');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    
    if (selectedVariantsInfo) selectedVariantsInfo.classList.add('hidden');
    if (addSelectedVariantsBtn) addSelectedVariantsBtn.classList.add('hidden');
    if (clearSelectionBtn) clearSelectionBtn.classList.add('hidden');
    
    // Nettoyer la variante sélectionnée
    window.selectedVariants = [];
    
    showToast('🔄 Sélection effacée', 'info');
}

function ajouterVariantesSelectionnees() {
    console.log('🔍 DEBUG ajouterVariantesSelectionnees - window.currentArticle:', window.currentArticle);
    console.log('🔍 DEBUG ajouterVariantesSelectionnees - window.selectedVariants:', window.selectedVariants);
    
    if (!window.selectedVariants || window.selectedVariants.length === 0) {
        showToast('❌ Aucune variante sélectionnée', 'error');
        return;
    }
    
    if (!window.currentArticle) {
        console.error('❌ Article parent non trouvé - window.currentArticle est:', window.currentArticle);
        console.error('🔍 DEBUG - Toutes les variables globales:');
        console.error('  - window.selectedVariants:', window.selectedVariants);
        console.error('  - window.variantsData:', window.variantsData);
        showToast('❌ Erreur: Article parent non trouvé', 'error');
        return;
    }
    
    try {
        // Ajouter chaque variante sélectionnée
        let ajoutees = 0;
        window.selectedVariants.forEach(variant => {
            try {
                // Créer un article combiné avec les données de la variante
                const articleAvecVariante = {
                    ...window.currentArticle,
                    ...variant,
                    id: variant.id,
                    article_id: window.currentArticle.id,  // ID de l'article parent
                    variante_id: variant.id, // ID de la variante
                    prix_actuel: variant.prix_unitaire,
                    prix_unitaire: variant.prix_unitaire,
                    stock_disponible: variant.stock
                };
                
                // Utiliser la logique existante pour ajouter l'article
                const hiddenSelect = document.getElementById('articleSelect');
                if (!hiddenSelect) return;
                
                hiddenSelect.value = variant.id;
                const qteInput = document.getElementById('quantiteInput');
                if (qteInput) qteInput.value = '1';
                
                // Créer ou mettre à jour l'option dans le select
                let opt = Array.from(hiddenSelect.options).find(o => String(o.value) === String(variant.id));
                if (!opt) {
                    opt = new Option('', variant.id);
                    hiddenSelect.appendChild(opt);
                }
                opt.dataset.article = JSON.stringify(articleAvecVariante);
                hiddenSelect.selectedIndex = opt.index;
                
                afficherInfosArticle(articleAvecVariante);
                isEditingArticle = false;
                saveArticle();
                
                ajoutees++;
                
            } catch (e) {
                console.error('❌ Erreur ajout variante individuelle:', e);
            }
        });
        
        if (ajoutees > 0) {
            showToast(`✅ ${ajoutees} variante(s) ajoutée(s) avec succès`, 'success');
        } else {
            showToast('❌ Aucune variante n\'a pu être ajoutée', 'error');
        }
        
        // Fermer le modal des variantes après le traitement
        fermerModalVariantes();
        
        // Nettoyer les variables globales
        window.selectedVariants = [];
        window.currentArticle = null;
        window.variantsData = null;
        
    } catch (e) {
        console.error('❌ Erreur ajout variantes:', e);
        showToast('❌ Erreur lors de l\'ajout des variantes', 'error');
    }
}

function selectionnerVariante(variant, article) {
    try {
        // Fermer le modal des variantes
        fermerModalVariantes();
        
        // Créer un article combiné avec les données de la variante
        const articleAvecVariante = {
            ...article,
            ...variant,
            id: variant.id,
            article_id: article.id,  // ID de l'article parent
            variante_id: variant.id, // ID de la variante
            prix_actuel: variant.prix_unitaire,
            prix_unitaire: variant.prix_unitaire,
            stock_disponible: variant.stock
        };
        
        // Utiliser la logique existante pour ajouter l'article
        const hiddenSelect = document.getElementById('articleSelect');
        if (!hiddenSelect) return;
        
        hiddenSelect.value = variant.id;
        const qteInput = document.getElementById('quantiteInput');
        if (qteInput) qteInput.value = '1';
        
        // Créer ou mettre à jour l'option dans le select
        let opt = Array.from(hiddenSelect.options).find(o => String(o.value) === String(variant.id));
        if (!opt) {
            opt = new Option('', variant.id);
            hiddenSelect.appendChild(opt);
        }
        opt.dataset.article = JSON.stringify(articleAvecVariante);
        hiddenSelect.selectedIndex = opt.index;
        
        afficherInfosArticle(articleAvecVariante);
        isEditingArticle = false;
        saveArticle();
        
        showToast('✅ Variante ajoutée avec succès', 'success');
    } catch (e) {
        console.error('❌ Erreur sélection variante:', e);
        showToast('❌ Erreur lors de la sélection de la variante', 'error');
    }
}



function rechercherArticlesPourVariantes(terme) {
    try {
        if (!terme || terme.length < 2) {
            document.getElementById('resultatsRechercheVariantes').innerHTML = '';
            return;
        }
        
        const resultatsDiv = document.getElementById('resultatsRechercheVariantes');
        resultatsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Recherche en cours...</div>';
        
        // Utiliser la même API que pour la recherche normale d'articles
        fetch(`/operatConfirme/api/articles-disponibles/?q=${encodeURIComponent(terme)}`)
            .then(response => response.json())
            .then(data => {
                if (data.articles && data.articles.length > 0) {
                    const articlesHtml = data.articles.slice(0, 5).map(article => `
                        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer mb-3" onclick="ouvrirModalVariantes(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <h5 class="font-medium text-gray-900">${article.nom}</h5>
                                    <p class="text-sm text-gray-600">Réf: ${article.reference || 'N/A'}</p>
                                    <div class="flex gap-2 mt-2">
                                        ${article.couleur ? `<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded text-xs">${article.couleur}</span>` : ''}
                                        ${article.pointure ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${article.pointure}</span>` : ''}
                                        ${article.categorie ? `<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs">${article.categorie}</span>` : ''}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-semibold text-green-600">${article.prix_actuel} DH</div>
                                    <button class="mt-2 px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm">
                                        Voir variantes
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    resultatsDiv.innerHTML = articlesHtml;
                } else {
                    resultatsDiv.innerHTML = '<div class="text-center py-4 text-gray-500">Aucun article trouvé</div>';
                }
            })
            .catch(error => {
                console.error('❌ Erreur recherche articles:', error);
                resultatsDiv.innerHTML = '<div class="text-center py-4 text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Erreur lors de la recherche</div>';
            });
    } catch (e) {
        console.error('❌ Erreur rechercherArticlesPourVariantes:', e);
    }
}

// ===== Gestion de la barre de navigation personnalisée =====
let scrollThumbDragging = false;

function initCustomScrollbar() {
    const container = document.getElementById('articlesScrollContainer');
    const scrollbar = document.getElementById('customScrollbar');
    const thumb = document.getElementById('scrollThumb');
    const scrollUp = document.getElementById('scrollUp');
    const scrollDown = document.getElementById('scrollDown');
    const scrollInfo = document.getElementById('scrollInfo');
    
    if (!container || !scrollbar || !thumb) {
        console.log('❌ Éléments de scrollbar manquants');
        return;
    }
    
    console.log('✅ Initialisation de la scrollbar personnalisée');
    
    function updateScrollbar() {
        const scrollTop = container.scrollTop;
        const scrollHeight = container.scrollHeight;
        const clientHeight = container.clientHeight;
        const maxScroll = scrollHeight - clientHeight;
        
        console.log('📊 Scroll info:', { scrollTop, scrollHeight, clientHeight, maxScroll });
        
        if (maxScroll <= 0) {
            scrollbar.style.display = 'none';
            return;
        }
        
        scrollbar.style.display = 'block';
        const thumbHeight = Math.max(50, (clientHeight / scrollHeight) * clientHeight);
        const thumbTop = (scrollTop / maxScroll) * (clientHeight - thumbHeight);
        
        thumb.style.height = thumbHeight + 'px';
        thumb.style.top = thumbTop + 'px';
        
        // Mettre à jour l'info de scroll
        const visibleItems = Math.ceil(clientHeight / 80);
        const totalItems = document.querySelectorAll('#articlesTableBody tr:not([style*="display: none"])').length;
        const currentPosition = Math.ceil(scrollTop / 80) + 1;
        
        if (scrollInfo) {
            scrollInfo.textContent = `${currentPosition}-${Math.min(currentPosition + visibleItems - 1, totalItems)} sur ${totalItems} articles`;
        }
    }
    
    // Événements de scroll
    container.addEventListener('scroll', () => {
        if (!scrollThumbDragging) {
            updateScrollbar();
        }
    });
    
    // Drag du thumb
    thumb.addEventListener('mousedown', (e) => {
        e.preventDefault();
        scrollThumbDragging = true;
        const startY = e.clientY;
        const startTop = parseFloat(thumb.style.top) || 0;
        
        function onMouseMove(e) {
            if (!scrollThumbDragging) return;
            const deltaY = e.clientY - startY;
            const newTop = Math.max(0, Math.min(container.clientHeight - thumb.offsetHeight, startTop + deltaY));
            const scrollTop = (newTop / (container.clientHeight - thumb.offsetHeight)) * (container.scrollHeight - container.clientHeight);
            container.scrollTop = scrollTop;
        }
        
        function onMouseUp() {
            scrollThumbDragging = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        }
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
    
    // Clic sur la barre de scroll
    scrollbar.addEventListener('click', (e) => {
        if (e.target === thumb) return;
        const rect = scrollbar.getBoundingClientRect();
        const clickY = e.clientY - rect.top;
        const scrollTop = (clickY / rect.height) * (container.scrollHeight - container.clientHeight);
        container.scrollTop = scrollTop;
    });
    
    // Boutons de navigation
    if (scrollUp) {
        scrollUp.addEventListener('click', () => {
            container.scrollBy({ top: -100, behavior: 'smooth' });
        });
    }
    
    if (scrollDown) {
        scrollDown.addEventListener('click', () => {
            container.scrollBy({ top: 100, behavior: 'smooth' });
        });
    }
    
    // Initialisation
    updateScrollbar();
    
    // Observer les changements dans le contenu
    const observer = new MutationObserver(() => {
        setTimeout(updateScrollbar, 50);
    });
    observer.observe(container, { childList: true, subtree: true });
    
    // Mettre à jour après le chargement des articles
    setTimeout(updateScrollbar, 200);
}

// Initialiser la barre de navigation quand le modal s'ouvre
function setupScrollbarObserver() {
    const modal = document.getElementById('articleModal');
    if (modal) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (modal.style.display === 'flex') {
                        console.log('🔄 Modal ouvert, initialisation de la scrollbar...');
                        setTimeout(initCustomScrollbar, 100);
                    }
                }
            });
        });
        observer.observe(modal, { attributes: true });
    }
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', setupScrollbarObserver);

// Réinitialiser après le chargement des articles
function reinitScrollbarAfterArticlesLoad() {
    setTimeout(initCustomScrollbar, 300);
}

// Fonction appelée quand un article est sélectionné
function onArticleSelectionChange() {
    const select = document.getElementById('articleSelect');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        const article = JSON.parse(selectedOption.dataset.article);
        
        // Afficher d'abord les informations disponibles
        afficherInfosArticle(article);
        
        // Puis rafraîchir les données de stock en temps réel
        if (article.id && !article.id.toString().startsWith('fallback-')) {
            // Indiquer que le stock est en cours de rafraîchissement
            const infoStock = document.getElementById('info-stock');
            const stockProgressBar = document.getElementById('stock-progress');
            const stockPercentage = document.getElementById('stock-percentage');
            
            if (infoStock) {
                infoStock.innerHTML = '<i class="fas fa-sync fa-spin mr-1"></i> Actualisation...';
                infoStock.className = 'px-3 py-1 bg-blue-100 text-blue-700 rounded-full font-medium';
            }
            
            if (stockProgressBar) {
                stockProgressBar.className = 'h-2.5 rounded-full bg-blue-500 animate-pulse';
                stockProgressBar.style.width = '50%';
            }
            
            if (stockPercentage) {
                stockPercentage.textContent = '...';
                stockPercentage.className = 'ml-2 text-xs font-medium text-blue-700';
            }
            
            // Appeler l'API pour obtenir les données à jour
            rafraichirStockArticle(article.id)
                .then(articleMisAJour => {
                    if (articleMisAJour) {
                        // Mettre à jour les données de l'article dans le dataset de l'option
                        article.qte_disponible = articleMisAJour.qte_disponible;
                        selectedOption.dataset.article = JSON.stringify(article);
                        
                        // Réafficher les informations avec les données mises à jour
        afficherInfosArticle(article);
                    } else {
                        // Si l'API n'a pas retourné de données, utiliser les données existantes
                        console.log('⚠️ Utilisation des données existantes pour le stock');
                        afficherInfosArticle(article);
                    }
                })
                .catch(error => {
                    console.error('❌ Erreur lors du rafraîchissement du stock:', error);
                    // En cas d'erreur, utiliser les données existantes sans notification d'erreur
                    // pour ne pas perturber l'expérience utilisateur
                    afficherInfosArticle(article);
                });
        }
    } else {
        document.getElementById('article-info').classList.add('hidden');
    }
}

// Fonction pour afficher les informations d'un article
function afficherInfosArticle(article) {
    try {
        if (!article) {
            console.error('❌ Article non défini dans afficherInfosArticle');
            return;
        }
        
        // Vérifier et récupérer les valeurs avec sécurité
        const quantite = parseInt(document.getElementById('quantiteInput')?.value) || 1;
        const prixActuel = typeof article.prix_actuel === 'number' ? article.prix_actuel : 
                         (article.prix_actuel ? parseFloat(article.prix_actuel) : 
                         (article.prix_unitaire ? parseFloat(article.prix_unitaire) : 0));
        
        const sousTotal = (prixActuel * quantite).toFixed(2);
    
        // Informations de base avec vérification des éléments DOM
        const refElement = document.getElementById('info-reference');
        const prixElement = document.getElementById('info-prix');
        const sousTotalElement = document.getElementById('info-sous-total');
        const pointureElement = document.getElementById('info-pointure');
        const couleurElement = document.getElementById('info-couleur');
        const categorieElement = document.getElementById('info-categorie');
        const descriptionElement = document.getElementById('info-description');
        
        if (refElement) refElement.textContent = article.reference || '-';
        if (prixElement) prixElement.textContent = `${prixActuel} DH`;
        if (sousTotalElement) sousTotalElement.textContent = `${sousTotal} DH`;
        
        // Vérifier que qte_disponible est bien défini et convertir en nombre
        let stock = 0;
        try {
            stock = typeof article.qte_disponible === 'number' ? article.qte_disponible : 
                   (article.qte_disponible ? parseInt(article.qte_disponible) : 0);
            
            // Si la conversion a échoué, utiliser 0
            if (isNaN(stock)) {
                console.warn('⚠️ Valeur de stock non numérique:', article.qte_disponible);
                stock = 0;
            }
        } catch (e) {
            console.error('❌ Erreur lors de la conversion du stock:', e);
            stock = 0;
        }
    
    // Nouvelles informations détaillées
        if (pointureElement) pointureElement.textContent = article.pointure || 'Non spécifiée';
        if (couleurElement) couleurElement.textContent = article.couleur || 'Non spécifiée';
        if (categorieElement) categorieElement.textContent = typeof article.categorie === 'string' ? article.categorie : 'Non spécifiée';
        
        // Mettre à jour l'affichage du stock avec style conditionnel
        const stockElement = document.getElementById('info-stock');
        const stockProgressBar = document.getElementById('stock-progress');
        const stockPercentage = document.getElementById('stock-percentage');
        
        if (stockElement && stockProgressBar && stockPercentage) {
            // Définir une capacité maximale théorique pour la barre de progression (ajuster selon vos besoins)
            const capaciteMaximale = Math.max(stock, 100); // Au moins 100 ou la valeur actuelle du stock
            
            // Calculer le pourcentage du stock
            const pourcentage = Math.min(Math.round((stock / capaciteMaximale) * 100), 100);
            
            // Mettre à jour le texte et la couleur selon le niveau de stock
            if (stock <= 0) {
                stockElement.textContent = 'Épuisé';
                stockElement.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-full font-medium';
                stockProgressBar.style.width = '0%';
                stockProgressBar.className = 'h-2.5 rounded-full bg-red-500';
                stockPercentage.textContent = '0%';
                stockPercentage.className = 'ml-2 text-xs font-medium text-red-700';
            } else if (stock < 5) {
                stockElement.textContent = `${stock} unité(s) - Faible`;
                stockElement.className = 'px-3 py-1 bg-orange-100 text-orange-700 rounded-full font-medium';
                stockProgressBar.style.width = `${pourcentage}%`;
                stockProgressBar.className = 'h-2.5 rounded-full bg-orange-500';
                stockPercentage.textContent = `${pourcentage}%`;
                stockPercentage.className = 'ml-2 text-xs font-medium text-orange-700';
            } else {
                stockElement.textContent = `${stock} unité(s)`;
                stockElement.className = 'px-3 py-1 bg-teal-100 text-teal-700 rounded-full font-medium';
                stockProgressBar.style.width = `${pourcentage}%`;
                stockProgressBar.className = 'h-2.5 rounded-full bg-teal-600';
                stockPercentage.textContent = `${pourcentage}%`;
                stockPercentage.className = 'ml-2 text-xs font-medium text-teal-700';
            }
        }
    
    // Mettre à jour les badges avec les informations de l'article
        try {
    const caracteristiques = {
        taille: article.pointure || null,
        couleur: article.couleur || null,
                categorie: typeof article.categorie === 'string' ? article.categorie : null,
                stock: `Stock: ${stock}`,
        description: article.description || ''
    };
    mettreAJourBadgesModale(caracteristiques);
        } catch (e) {
            console.warn('⚠️ Erreur lors de la mise à jour des badges:', e);
        }
    
    // Description
        if (descriptionElement) descriptionElement.textContent = article.description || '';
    
    // Afficher la section des informations
        const articleInfoSection = document.getElementById('article-info');
        if (articleInfoSection) articleInfoSection.classList.remove('hidden');
    
    console.log('📋 Informations article affichées:', {
            nom: article.nom || 'Sans nom',
            reference: article.reference || '-',
            pointure: article.pointure || '-',
            couleur: article.couleur || '-',
            categorie: typeof article.categorie === 'string' ? article.categorie : '-',
            stock: stock
        });
    } catch (error) {
        console.error('❌ Erreur lors de l\'affichage des informations de l\'article:', error);
        // Ne pas laisser l'erreur se propager pour éviter de bloquer l'interface
    }
}

// Fonction pour mettre à jour le sous-total quand la quantité change
function onQuantiteChange() {
    if (!isEditingArticle) {
        const select = document.getElementById('articleSelect');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            const article = JSON.parse(selectedOption.dataset.article);
            afficherInfosArticle(article);
        }
    } else {
        // Pour les modifications, on recalcule avec le prix actuel
        const prixText = document.getElementById('info-prix').textContent;
        const prix = parseFloat(prixText.replace(' DH', ''));
        const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
        const sousTotal = (prix * quantite).toFixed(2);
        
        document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    }
}

// Fonction pour sauvegarder l'article
function saveArticle() {
    const quantite = parseInt(document.getElementById('quantiteInput').value);
    
    if (!quantite || quantite < 1) {
        alert('⚠️ Veuillez saisir une quantité valide (minimum 1)');
        return;
    }
    
        const select = document.getElementById('articleSelect');
        if (!select.value) {
            alert('⚠️ Veuillez sélectionner un article');
            return;
        }
        
    const articleId = select.value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

    if (!csrfToken) {
        showToast('❌ Erreur: Token de sécurité manquant. Veuillez rafraîchir la page.', 'error');
        return;
    }

    let action = isEditingArticle ? 'update_article' : 'add_article';
    
    // Récupérer les données de l'article sélectionné pour voir s'il y a une variante
    const selectedOption = select.options[select.selectedIndex];
    const articleData = selectedOption ? JSON.parse(selectedOption.dataset.article || '{}') : {};
    
    let body = new URLSearchParams({
        'action': action,
        'article_id': articleId,
        'quantite': quantite,
    });
    
    // Si c'est une variante, ajouter l'ID de la variante
    if (articleData.variante_id) {
        body.append('variante_id', articleData.variante_id);
    }

    if(isEditingArticle) {
        body.append('panier_id', currentArticleId); // currentArticleId est l'ID du *panier*
    }

    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: body
    })
    .then(response => {
        if (!response.ok) {
            // Si le statut est une erreur (4xx, 5xx), lire en tant que texte
            return response.text().then(text => { 
                throw new Error(`Erreur ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Afficher un message approprié selon l'action et le résultat
            let message = data.message || (isEditingArticle ? '✅ Article modifié' : '✅ Article ajouté');
            
            showToast(message, 'success');
            rafraichirSectionArticles();
            closeArticleModal();
        } else {
            showToast(`❌ Erreur: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erreur Fetch:', error);
        // Essayer d'extraire un message d'erreur plus clair de l'HTML
        const match = error.message.match(/<title>(.*?)<\/title>/);
        const htmlTitle = match ? match[1] : 'Erreur de communication avec le serveur.';
        showToast(`❌ Erreur: ${htmlTitle}`, 'error');
    });
}

// Nouvelle fonction pour rafraîchir la section des articles
function rafraichirSectionArticles() {
    const container = document.getElementById('articles-container');
    if (!container) {
        console.error('❌ Conteneur d\'articles introuvable');
        showToast('❌ Erreur lors du rafraîchissement: conteneur introuvable', 'error');
        return;
    }
    
    container.innerHTML = '<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Rafraîchissement en cours...</p></div>';

    fetch(`{% url 'operatConfirme:api_rafraichir_articles' commande.id %}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mettre à jour la liste des articles
                container.innerHTML = data.html;

                // Utiliser la fonction centralisée pour mettre à jour tous les totaux
                mettreAJourTousLesTotaux(data);

                showToast('🔄 Section des articles mise à jour.', 'info', 1500);
                
                // Déclencher des événements personnalisés pour d'autres scripts qui pourraient écouter
                window.dispatchEvent(new CustomEvent('articlesRefreshed', { 
                    detail: { 
                        articles_count: data.articles_count,
                        total_commande: data.total_commande,
                        sous_total_articles: data.sous_total_articles,
                        compteur: data.compteur
                    }
                }));
            } else {
                container.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">${data.error || 'Erreur inconnue'}</div>`;
                showToast(`❌ Erreur de rafraîchissement: ${data.error || 'Erreur inconnue'}`, 'error');
            }
        })
        .catch(error => {
            console.error('Erreur de rafraîchissement:', error);
            container.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg">
                <div class="font-bold mb-2">Erreur de connexion</div>
                <div class="text-sm">${error.message || 'Impossible de contacter le serveur'}</div>
                <button onclick="rafraichirSectionArticles()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                    <i class="fas fa-sync-alt mr-1"></i>Réessayer
                </button>
            </div>`;
            showToast('❌ Erreur de connexion lors du rafraîchissement.', 'error');
        });
}

// Fonction centralisée pour mettre à jour tous les totaux et compteurs
function mettreAJourTousLesTotaux(data) {
    // Mettre à jour le sous-total global des articles
    if (data.sous_total_articles !== undefined) {
        const sousTotalGlobalElement = document.getElementById('sous-total-articles');
        if (sousTotalGlobalElement) {
            sousTotalGlobalElement.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
        }
    }
    
    
    // Mettre à jour le total de la commande (corriger getElementById)
    if (data.total_commande !== undefined) {
        const totalElement = document.getElementById('total-commande');
        const totalElementHautPage = document.getElementById('total_commande_haut_page');
        if (totalElement) {
            totalElement.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
        }
        if (totalElementHautPage) {
            totalElementHautPage.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
        }
        
        // Également mettre à jour tous les éléments avec la classe total-commande
        const totalElements = document.querySelectorAll('.total-commande');
        totalElements.forEach(el => {
            el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
        });
        // Mettre à jour le total de la commande dans la section du haut de la page 
        const totalElementHautPages = document.querySelectorAll('.total_commande_haut_page');
        totalElementHautPages.forEach(el => {
            el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
        });
        
    }
    
    // Mettre à jour le compteur d'articles
    if (data.articles_count !== undefined) {
        const countElement = document.getElementById('articles-count');
        if (countElement) {
            countElement.textContent = data.articles_count;
        }
        
        const pluralElement = document.getElementById('articles-plural');
        if (pluralElement) {
            pluralElement.textContent = data.articles_count > 1 ? 's' : '';
        }
    }
    
    // Mettre à jour le compteur upsell dans tous les endroits possibles
    if (data.compteur !== undefined) {
        // Compteur principal
        const compteurSpan = document.getElementById('compteur-display');
        if (compteurSpan) {
            compteurSpan.textContent = data.compteur;
        }
        
        // Niveau upsell dashboard
        const niveauUpsellDash = document.getElementById('niveau-upsell-dashboard');
        if (niveauUpsellDash) {
            niveauUpsellDash.textContent = data.compteur;
        }
        
        // Niveau upsell articles
        const niveauUpsellArticles = document.getElementById('niveau-upsell-articles');
        if (niveauUpsellArticles) {
            niveauUpsellArticles.textContent = data.compteur;
        }
        
         // Mettre à jour les éléments avec la classe compteur-upsell
        const compteurElements = document.querySelectorAll('.compteur-upsell');
        compteurElements.forEach(el => {
            el.textContent = data.compteur;
        });
        
        // Mettre à jour le compteur dans l'en-tête de la page
        const compteurHeader = document.getElementById('compteur-upsell-header');
        if (compteurHeader) {
            compteurHeader.textContent = `Niveau ${data.compteur}`;
        }
        
        // Mettre à jour les prix unitaires si le compteur a changé
        mettreAJourPrixUnitaires(data.compteur);
        
        // Mettre à jour le badge upsell s'il existe
        const upsellBadge = document.getElementById('upsell-badge-container');
        if (upsellBadge && data.compteur > 0) {
            upsellBadge.innerHTML = `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                <i class="fas fa-arrow-up mr-1"></i>Niveau ${data.compteur}
            </span>`;
        } else if (upsellBadge && data.compteur === 0) {
            upsellBadge.innerHTML = '';
        }
    }
    
    console.log('✅ Tous les totaux mis à jour:', {
        sous_total_articles: data.sous_total_articles,
        total_commande: data.total_commande,
        articles_count: data.articles_count,
        compteur: data.compteur
    });
}

// Fonction utilitaire pour mettre à jour le compteur upsell dans tous les endroits
function mettreAJourCompteurUpsell(nouveauCompteur) {
    console.log(`🔄 Mise à jour du compteur upsell: ${nouveauCompteur}`);
    
    // Mettre à jour la variable globale
    if (typeof compteurCommande !== 'undefined') {
        compteurCommande = nouveauCompteur;
    }
    
    // Mettre à jour tous les éléments d'affichage
    const data = { compteur: nouveauCompteur };
    mettreAJourTousLesTotaux(data);
    
    // Mettre à jour les prix unitaires
    mettreAJourPrixUnitaires(nouveauCompteur);
    
    console.log(`✅ Compteur upsell mis à jour vers: ${nouveauCompteur}`);
}

// Fonction de test pour vérifier la mise à jour dynamique du compteur
function testerMiseAJourCompteur() {
    const compteurActuel = parseInt(document.getElementById('compteur-upsell-header').textContent.replace('Niveau ', '')) || 0;
    const nouveauCompteur = (compteurActuel + 1) % 5; // Cycle entre 0 et 4
    
    console.log(`🧪 Test de mise à jour: ${compteurActuel} → ${nouveauCompteur}`);
    mettreAJourCompteurUpsell(nouveauCompteur);
    
    showToast(`🧪 Test: Compteur mis à jour de ${compteurActuel} à ${nouveauCompteur}`, 'info', 2000);
}

// Fonction pour mettre à jour dynamiquement les prix unitaires
function mettreAJourPrixUnitaires(nouveauCompteur) {
    console.log(`🔄 Mise à jour des prix unitaires pour le compteur: ${nouveauCompteur}`);
    
    // Récupérer tous les articles
    const articleCards = document.querySelectorAll('.article-card');
    
    articleCards.forEach(articleCard => {
        const panierId = articleCard.getAttribute('data-article-id');
        const dataArticleAttr = articleCard.getAttribute('data-article');
        
        const articleData = parseArticleData(dataArticleAttr, panierId);
        
        if (articleData && !articleData.error) {
            // Calculer le nouveau prix selon le compteur
            const prixInfo = calculerPrixAvecPhaseInfo(articleData, nouveauCompteur);
            
            // Mettre à jour l'affichage du prix
            const prixElement = document.getElementById(`prix-unitaire-${panierId}`);
            const libelleElement = document.getElementById(`prix-libelle-${panierId}`);
            
            if (prixElement && libelleElement) {
                // Mettre à jour le prix
                prixElement.textContent = `${prixInfo.prix.toFixed(2)} DH`;
                
                // Mettre à jour la classe de couleur
                prixElement.className = `font-medium ${prixInfo.couleur_classe}`;
                
                // Mettre à jour le libellé
                libelleElement.textContent = prixInfo.libelle;
                libelleElement.className = `text-xs ${prixInfo.couleur_classe} mt-1`;
                
                console.log(`✅ Prix mis à jour pour article ${panierId}: ${prixInfo.prix.toFixed(2)} DH (${prixInfo.libelle})`);
            }
            
            // Mettre à jour le sous-total
            mettreAJourSousTotalArticle(panierId, prixInfo.prix);
        } else {
            // En cas d'erreur de parsing, on peut essayer de rafraîchir la section des articles
            console.log('🔄 Tentative de rafraîchissement de la section des articles...');
            setTimeout(() => {
                rafraichirSectionArticles();
            }, 1000);
        }
    });
}

// Fonction utilitaire pour mettre à jour le sous-total d'un article
function mettreAJourSousTotalArticle(panierId, prixUnitaire) {
    const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
    if (sousTotalElement) {
        // Récupérer la quantité depuis l'input
        const quantiteInput = document.getElementById(`quantite-${panierId}`);
        const quantite = quantiteInput ? parseInt(quantiteInput.value) || 1 : 1;
        
        // Calculer le nouveau sous-total
        const nouveauSousTotal = prixUnitaire * quantite;
        
        // Mettre à jour l'affichage
        sousTotalElement.textContent = `${nouveauSousTotal.toFixed(2)} DH`;
        
        console.log(`✅ Sous-total mis à jour pour article ${panierId}: ${quantite} × ${prixUnitaire.toFixed(2)} = ${nouveauSousTotal.toFixed(2)} DH`);
        
        return nouveauSousTotal;
    }
    return 0;
}

// Fonction pour recalculer tous les sous-totaux selon le compteur actuel
function recalculerTousLesSousTotaux() {
    console.log('🔄 Recalcul de tous les sous-totaux...');
    
    const articleCards = document.querySelectorAll('.article-card');
    let totalSousTotaux = 0;
    
    articleCards.forEach(articleCard => {
        const panierId = articleCard.getAttribute('data-article-id');
        const dataArticleAttr = articleCard.getAttribute('data-article');
        
        const articleData = parseArticleData(dataArticleAttr, panierId);
        
        if (articleData && !articleData.error) {
            // Récupérer le compteur actuel
            const compteurActuel = parseInt(document.getElementById('compteur-upsell-header').textContent.replace('Niveau ', '')) || 0;
            
            // Calculer le prix selon le compteur
            const prixInfo = calculerPrixAvecPhaseInfo(articleData, compteurActuel);
            
            // Mettre à jour le sous-total
            const sousTotal = mettreAJourSousTotalArticle(panierId, prixInfo.prix);
            totalSousTotaux += sousTotal;
        }
    });
    
    console.log(`💰 Total de tous les sous-totaux: ${totalSousTotaux.toFixed(2)} DH`);
    return totalSousTotaux;
}

// Fonction pour calculer le prix avec les informations de phase (version JavaScript)
function calculerPrixAvecPhaseInfo(article, compteur) {
    // Déterminer le prix de base
    let prix;
    if (compteur !== null && compteur !== undefined && article.isUpsell) {
        prix = getPrixUpsellAvecCompteur(article, compteur);
    } else {
        prix = article.prix_actuel || article.prix_unitaire || 0;
    }
    
    // Déterminer le libellé selon la phase et les promotions
    let libelle, couleur_classe;
    
    if (article.has_promo_active) {
        libelle = "Prix promotion";
        couleur_classe = "text-red-600";
    } else if (article.phase === 'LIQUIDATION') {
        libelle = "Prix liquidation";
        couleur_classe = "text-orange-600";
    } else if (article.phase === 'EN_TEST') {
        libelle = "Prix test";
        couleur_classe = "text-blue-600";
    } else if (compteur !== null && compteur !== undefined && compteur > 0 && article.isUpsell) {
        libelle = `Prix upsell niveau ${compteur}`;
        couleur_classe = "text-green-600";
    } else {
        libelle = "Prix normal";
        couleur_classe = "text-gray-600";
    }
    
    return {
        prix: prix,
        libelle: libelle,
        couleur_classe: couleur_classe
    };
}

// Fonction pour calculer le prix upsell avec compteur (version JavaScript)
function getPrixUpsellAvecCompteur(article, compteur) {
    if (!article.isUpsell) {
        return article.prix_actuel || article.prix_unitaire || 0;
    }
    
    // Utiliser le compteur pour déterminer le prix upsell
    if (compteur === 0) {
        return article.prix_actuel || article.prix_unitaire || 0;
    } else if (compteur === 1 && article.prix_upsell_1) {
        return parseFloat(article.prix_upsell_1);
    } else if (compteur === 2 && article.prix_upsell_2) {
        return parseFloat(article.prix_upsell_2);
    } else if (compteur === 3 && article.prix_upsell_3) {
        return parseFloat(article.prix_upsell_3);
    } else if (compteur >= 4 && article.prix_upsell_4) {
        return parseFloat(article.prix_upsell_4);
    }
    
    // Si pas de prix upsell défini pour ce niveau, utiliser le prix unitaire
    return article.prix_actuel || article.prix_unitaire || 0;
}

// Fonction de test pour vérifier la mise à jour des prix unitaires
function testerMiseAJourPrix() {
    const compteurActuel = parseInt(document.getElementById('compteur-upsell-header').textContent.replace('Niveau ', '')) || 0;
    const nouveauCompteur = (compteurActuel + 1) % 5; // Cycle entre 0 et 4
    
    console.log(`🧪 Test de mise à jour des prix: ${compteurActuel} → ${nouveauCompteur}`);
    mettreAJourPrixUnitaires(nouveauCompteur);
    
    showToast(`🧪 Test: Prix mis à jour pour le compteur ${nouveauCompteur}`, 'info', 2000);
}

// Fonction de test pour valider le JSON des articles
function testerJSONArticles() {
    console.log('🧪 Test de validation JSON des articles...');
    
    const articleCards = document.querySelectorAll('.article-card');
    let validCount = 0;
    let errorCount = 0;
    
    articleCards.forEach((articleCard, index) => {
        const panierId = articleCard.getAttribute('data-article-id');
        const dataArticleAttr = articleCard.getAttribute('data-article');
        
        console.log(`\n📦 Article ${index + 1} (ID: ${panierId}):`);
        console.log('JSON brut:', dataArticleAttr);
        
        const articleData = parseArticleData(dataArticleAttr, panierId);
        
        if (articleData && !articleData.error) {
            validCount++;
            console.log('✅ JSON valide:', articleData);
        } else {
            errorCount++;
            console.log('❌ JSON invalide');
        }
    });
    
    console.log(`\n📊 Résultats: ${validCount} valides, ${errorCount} erreurs`);
    showToast(`🧪 Test JSON: ${validCount} valides, ${errorCount} erreurs`, errorCount > 0 ? 'error' : 'success', 3000);
}

// Fonction de test pour tester la mise à jour des sous-totaux
function testerSousTotaux() {
    console.log('🧪 Test de mise à jour des sous-totaux...');
    
    const compteurActuel = parseInt(document.getElementById('compteur-upsell-header').textContent.replace('Niveau ', '')) || 0;
    const nouveauCompteur = (compteurActuel + 1) % 5; // Cycle entre 0 et 4
    
    console.log(`🧪 Test de mise à jour des sous-totaux: ${compteurActuel} → ${nouveauCompteur}`);
    
    // Mettre à jour le compteur
    mettreAJourCompteurUpsell(nouveauCompteur);
    
    // Recalculer tous les sous-totaux
    const totalSousTotaux = recalculerTousLesSousTotaux();
    
    showToast(`🧪 Test: Sous-totaux mis à jour pour le compteur ${nouveauCompteur} (Total: ${totalSousTotaux.toFixed(2)} DH)`, 'info', 3000);
}

// Fonction utilitaire pour valider et parser le JSON des articles
function parseArticleData(dataArticleAttr, panierId) {
    try {
        if (!dataArticleAttr || dataArticleAttr.trim() === '') {
            throw new Error('Données JSON vides ou manquantes');
        }
        
        // Nettoyer les données JSON de manière plus robuste
        let cleanedData = dataArticleAttr.trim();
        
        console.log(`🔍 Article ${panierId} - JSON brut (premiers 100 chars):`, cleanedData.substring(0, 100));
        
        // Remplacer les caractères problématiques
        cleanedData = cleanedData.replace(/\n/g, '\\n')
                                .replace(/\r/g, '\\r')
                                .replace(/\t/g, '\\t');
        
        // Méthode de nettoyage complète et systématique
        // 1. D'abord gérer les séquences d'échappement
        cleanedData = cleanedData.replace(/\\u002D/g, '-');
        
        // 2. Corriger les nombres avec virgules vers points (avec ou sans guillemets)
        cleanedData = cleanedData.replace(/:\s*(\d+),(\d+)"/g, ': $1.$2');
        cleanedData = cleanedData.replace(/:\s*(\d+),(\d+)/g, ': $1.$2');
        
        // 3. Supprimer les guillemets en trop après les valeurs booléennes et numériques
        cleanedData = cleanedData.replace(/:\s*false"\s*([,}])/g, ': false$1');
        cleanedData = cleanedData.replace(/:\s*true"\s*([,}])/g, ': true$1');
        cleanedData = cleanedData.replace(/:\s*(\d+(?:\.\d+)?)\"\s*([,}])/g, ': $1$2');
        
        // 4. Nettoyer les espaces autour des séparateurs
        cleanedData = cleanedData.replace(/\s*:\s*/g, ': ');
        cleanedData = cleanedData.replace(/\s*,\s*/g, ', ');
        
        console.log(`🔧 Article ${panierId} - JSON nettoyé (premiers 150 chars):`, cleanedData.substring(0, 150));
        
        // Tentative de parsing
        const articleData = JSON.parse(cleanedData);
        
        // Valider que les données essentielles sont présentes
        if (!articleData.id || !articleData.nom) {
            throw new Error('Données d\'article incomplètes');
        }
        
        // Convertir les prix en nombres si nécessaire
        const prixFields = ['prix_actuel', 'prix_unitaire', 'prix_upsell_1', 'prix_upsell_2', 'prix_upsell_3', 'prix_upsell_4'];
        prixFields.forEach(field => {
            if (articleData[field] !== undefined && articleData[field] !== null) {
                articleData[field] = parseFloat(articleData[field]) || 0;
            }
        });
        
        return articleData;
    } catch (error) {
        console.error(`❌ Erreur de parsing JSON pour l'article ${panierId}:`, error);
        console.error('Données JSON problématiques (premiers 200 chars):', dataArticleAttr ? dataArticleAttr.substring(0, 200) : 'undefined');
        
        // Retourner un objet article minimal pour éviter les erreurs en cascade
        return {
            id: panierId,
            nom: 'Article endommagé',
            prix_actuel: 0,
            prix_unitaire: 0,
            error: true,
            errorMessage: error.message
        };
    }
}

// Fonction pour supprimer un article
function supprimerArticle(panierId) {
    currentPanierIdToDelete = panierId; // Stocke l'ID du panier à supprimer
    showDeleteArticleModal();
}

// Variables globales pour la suppression
let currentPanierIdToDelete = null;

// Fonction pour afficher la modale de suppression d'article
function showDeleteArticleModal() {
    const modal = document.getElementById('deleteArticleModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        // Mettre à jour l'ID sur le bouton de confirmation
        const confirmBtn = document.getElementById('confirmDeleteArticleBtn');
        if (confirmBtn) {
            confirmBtn.onclick = function() { proceedWithArticleDeletion(); };
        }
    }
}

// Fonction pour masquer la modale de suppression d'article
function hideDeleteArticleModal() {
    const modal = document.getElementById('deleteArticleModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    currentPanierIdToDelete = null; // Réinitialise l'ID
}

// Fonction pour procéder à la suppression après confirmation
function proceedWithArticleDeletion() {
    if (currentPanierIdToDelete) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: new URLSearchParams({
                'action': 'delete_panier',
                'panier_id': currentPanierIdToDelete
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('✅ Article supprimé avec succès', 'success');
                rafraichirSectionArticles();
                hideDeleteArticleModal(); // Masquer la modale après succès
            } else {
                showToast('❌ Erreur: ' + data.error, 'error');
                hideDeleteArticleModal(); // Masquer la modale même en cas d'erreur
            }
        })
        .catch(error => {
            console.error('❌ Erreur:', error);
            showToast('❌ Erreur de réseau', 'error');
            hideDeleteArticleModal(); // Masquer la modale en cas d'erreur réseau
        });
    }
}

// Fonction pour fermer la modale d'article
function closeArticleModal() {
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de la fermeture');
    }
}

// Fonction pour mettre à jour le compteur d'articles
function mettreAJourCompteurArticles() {
    const articles = document.querySelectorAll('.article-card');
    const count = articles.length;
    
    document.getElementById('articles-count').textContent = count;
    document.getElementById('articles-plural').textContent = count > 1 ? 's' : '';
}

function getPrixUpsell(article, compteur) {
    // Utiliser le compteur de la commande pour déterminer le prix
    const prixUnitaire = article.prix_actuel || article.prix_unitaire;
    
    if (compteur === 0) {
        // Pas d'upsell actif
        return prixUnitaire;
    } else if (compteur === 1 && article.prix_upsell_1) {
        // Niveau 1 d'upsell
        return parseFloat(article.prix_upsell_1);
    } else if (compteur === 2 && article.prix_upsell_2) {
        // Niveau 2 d'upsell
        return parseFloat(article.prix_upsell_2);
    } else if (compteur === 3 && article.prix_upsell_3) {
        // Niveau 3 d'upsell
        return parseFloat(article.prix_upsell_3);
    } else if (compteur >= 4 && article.prix_upsell_4) {
        // Niveau 4 d'upsell (pour compteur >= 4)
        return parseFloat(article.prix_upsell_4);
    }
    
    // Si pas de prix upsell défini pour ce niveau, utiliser le prix unitaire
    return prixUnitaire;
}

function mettreAJourTotalCommande() {
    const articlesContainer = document.getElementById('articles-container');
    if (!articlesContainer) {
        console.error("L'élément 'articles-container' est introuvable.");
        return;
    }

    const articles = articlesContainer.querySelectorAll('.article-card');
    let sousTotal = 0;
    
    console.log(`🔄 Recalcul du total pour ${articles.length} article(s)`);
    
    articles.forEach((article, index) => {
        const sousTotalElement = article.querySelector('.text-lg.font-bold');
        
        if (sousTotalElement) {
            // Simplement additionner les sous-totaux déjà affichés
            const sousTotalText = sousTotalElement.textContent;
            const sousTotal_article = parseFloat(sousTotalText.replace(' DH', '').replace(',', '.'));
            
            if (!isNaN(sousTotal_article)) {
                console.log(`   Article ${index + 1}: Sous-total = ${sousTotal_article} DH`);
                sousTotal += sousTotal_article;
            } else {
                console.warn(`   ⚠️ Sous-total ${index + 1} non valide: "${sousTotalText}"`);
            }
        }
    });
    
    // Récupérer les frais de livraison
    const fraisElement = document.getElementById('frais-display');
    let fraisLivraison = 0;
    if (fraisElement) {
        const fraisText = fraisElement.value.replace(' DH', '').replace(',', '.');
        fraisLivraison = parseFloat(fraisText) || 0;
    }
    
    const totalFinal = sousTotal ;
    
    console.log(`📊 Sous-total articles: ${sousTotal.toFixed(2)} DH`);
    console.log(`🚚 Frais de livraison: ${fraisLivraison.toFixed(2)} DH`);
    console.log(`💰 Total final calculé: ${totalFinal.toFixed(2)} DH`);
    
    const totalElement = document.getElementById('total-commande');
    if (totalElement) {
        const ancienTotal = totalElement.textContent;
        totalElement.textContent = `${totalFinal.toFixed(2)} DH`;
        console.log(`📊 Total mis à jour: ${ancienTotal} → ${totalFinal.toFixed(2)} DH`);
    }
    const totalElementHautPage = document.getElementById('total_commande_haut_page');
    if (totalElementHautPage) {
        const ancienTotal = totalElementHautPage.textContent;
        totalElementHautPage.textContent = `${totalFinal.toFixed(2)} DH`;
        console.log(`📊 Total mis à jour: ${ancienTotal} → ${totalFinal.toFixed(2)} DH`);
    }
    
    // Mettre à jour le sous-total des articles dans le détail si l'élément existe
    const sousTotalElement = document.getElementById('sous-total-articles');
    if (sousTotalElement) {
        const ancienSousTotal = sousTotalElement.textContent;
        sousTotalElement.textContent = `${sousTotal.toFixed(2)} DH`;
        console.log(`📊 Sous-total mis à jour: ${ancienSousTotal} → ${sousTotal.toFixed(2)} DH`);
    }
    
}

// Fonction alternative qui additionne directement les sous-totaux affichés
function recalculerTotalDepuisSousTotaux() {
    console.log('🧮 Recalcul du total en additionnant les sous-totaux affichés...');
    
    const sousTotalElements = document.querySelectorAll('.text-lg.font-bold');
    let total = 0;
    
    sousTotalElements.forEach((element, index) => {
        const texte = element.textContent;
        const valeur = parseFloat(texte.replace(' DH', '').replace(',', '.'));
        
        if (!isNaN(valeur)) {
            console.log(`   Sous-total ${index + 1}: ${valeur} DH`);
            total += valeur;
        } else {
            console.warn(`   ⚠️ Sous-total ${index + 1} non valide: "${texte}"`);
        }
    });
    
    console.log(`💰 Total calculé depuis sous-totaux: ${total.toFixed(2)} DH`);
    
    const totalElement = document.getElementById('total-commande');
    if (totalElement) {
        const ancienTotal = totalElement.textContent;
        totalElement.textContent = `${total.toFixed(2)} DH`;
        console.log(`📊 Total mis à jour: ${ancienTotal} → ${total.toFixed(2)} DH`);
    }
    
    return total;
}

// Fonction pour sauvegarder un nouvel article immédiatement
function sauvegarderNouvelArticle(article, quantite) {
    console.log('💾 Sauvegarde immédiate d\'un nouvel article...');
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
        }
        
    // Ajouter les données de l'article
    formData.append('action', 'add_article');
    formData.append('article_id', article.id);
    formData.append('quantite', quantite);
    formData.append('commande_id', '{{ commande.id }}');
        
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
            method: 'POST',
            body: formData,
            headers: {
            'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
            console.log('✅ Nouvel article sauvegardé en base de données');
            
            // Mettre à jour l'ID de l'article dans le DOM avec l'ID réel de la base
            if (data.article_id) {
                const articleCard = document.querySelector(`[data-article-id^="new-"]`);
                if (articleCard) {
                    articleCard.setAttribute('data-article-id', data.article_id);
                    articleCard.removeAttribute('data-is-new');
                }
            }
            
            // Utiliser la fonction centralisée pour mettre à jour tous les totaux et compteurs
            const updateData = {
                total_commande: data.total_commande,
                articles_count: data.nb_articles,
                compteur: data.compteur,
                sous_total_articles: data.sous_total_articles
            };
            mettreAJourTousLesTotaux(updateData);
                
        } else {
            console.error('❌ Erreur lors de la sauvegarde:', data.error);
            showNotification('❌ Erreur lors de la sauvegarde: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors de la sauvegarde', 'error');
    });
}

// Fonction pour sauvegarder le remplacement d'un article immédiatement
function sauvegarderRemplacementArticle(ancienArticleId, nouvelArticle, nouvelleQuantite) {
    console.log('🔄 Sauvegarde immédiate du remplacement d\'article...');
    
    const formData = new FormData();
    
    // Ajouter le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        formData.append('csrfmiddlewaretoken', csrfToken.value);
    }
    
    // Ajouter les données du remplacement
    formData.append('action', 'replace_article');
    formData.append('ancien_article_id', ancienArticleId);
    formData.append('nouvel_article_id', nouvelArticle.id);
    formData.append('nouvelle_quantite', nouvelleQuantite);
    formData.append('commande_id', '{{ commande.id }}');
    
    // Envoyer via AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('✅ Remplacement d\'article sauvegardé en base de données');
            
            // Mettre à jour l'ID de l'article dans le DOM avec l'ID réel du nouveau panier
            if (data.nouvel_article_id) {
                const articleCard = document.querySelector(`[data-article-id="${ancienArticleId}"]`);
                if (articleCard) {
                    articleCard.setAttribute('data-article-id', data.nouvel_article_id);
                    articleCard.removeAttribute('data-is-replaced');
                }
            }
            
            // Utiliser la fonction centralisée pour mettre à jour tous les totaux et compteurs
            const updateData = {
                total_commande: data.total_commande,
                articles_count: data.nb_articles,
                compteur: data.compteur,
                sous_total_articles: data.sous_total_articles
            };
            mettreAJourTousLesTotaux(updateData);
            
            console.log('🔄 Remplacement terminé:', {
                ancien: ancienArticleId,
                nouveau: data.nouvel_article_id,
                article: nouvelArticle.nom
            });
            
            } else {
            console.error('❌ Erreur lors du remplacement:', data.error);
            showNotification('❌ Erreur lors du remplacement: ' + data.error, 'error');
            }
        })
        .catch(error => {
        console.error('❌ Erreur de connexion:', error);
        showNotification('❌ Erreur de connexion lors du remplacement', 'error');
        });
}



// Ajouter les événements pour la modale d'articles et les raccourcis clavier
document.addEventListener('DOMContentLoaded', function() {
    // Événement pour la sélection d'article
    const articleSelect = document.getElementById('articleSelect');
    if (articleSelect) {
        articleSelect.addEventListener('change', onArticleSelectionChange);
    }
    
    // Événement pour le changement de quantité
    const quantiteInput = document.getElementById('quantiteInput');
    if (quantiteInput) {
        quantiteInput.addEventListener('input', onQuantiteChange);
    }
    
    // Fermer la modale en cliquant à l'extérieur
    const articleModal = document.getElementById('articleModal');
    if (articleModal) {
        articleModal.addEventListener('click', function(event) {
            if (event.target === this) {
                closeArticleModal();
            }
        });
    }
    
    // Raccourcis clavier pour l'interface
    document.addEventListener('keydown', function(event) {
        // Ctrl+S désactivé - sauvegarde automatique avec les boutons "Enregistrer"
        if (event.ctrlKey && event.key === 's') {
            event.preventDefault();
            showNotification('ℹ️ Sauvegarde automatique active - utilisez les boutons "Enregistrer"', 'success');
        }
        
        // Ctrl+Enter pour confirmer la commande
        if (event.ctrlKey && event.key === 'Enter') {
            event.preventDefault();
            console.log('⌨️ Raccourci Ctrl+Enter détecté - Confirmation...');
            confirmerCommande();
        }
        
        // Escape pour fermer les modales
        if (event.key === 'Escape') {
            const commentModal = document.getElementById('commentModal');
            const articleModal = document.getElementById('articleModal');
            
            if (commentModal && commentModal.style.display === 'flex') {
                closeCommentModal();
            }
            if (articleModal && articleModal.style.display === 'flex') {
                closeArticleModal();
            }
        }
    });
    
    // Charger les commentaires depuis l'API Django
    chargerCommentairesDisponibles();
    
    // Charger les articles disponibles au chargement de la page
    chargerArticlesDisponibles();
    
    // Charger les opérations existantes depuis la base de données
    chargerOperationsExistantes();
    
    // Recalculer le total de la commande au chargement de la page
    // pour s'assurer que l'affichage correspond à la nouvelle logique de calcul
    console.log('🚀 Initialisation: Recalcul du total de la commande...');
    mettreAJourTotalCommande();
    
    // Fonction alternative pour tester
    window.recalculerTotal = recalculerTotalDepuisSousTotaux;
    
    // Fonction de debug pour tester le calcul des totaux
    window.debugTotalCommande = function() {
        console.log('🔍 Debug du calcul du total de la commande:');
        
        const articlesContainer = document.getElementById('articles-container');
        if (!articlesContainer) {
            console.error('❌ Conteneur des articles introuvable');
            return;
        }
        
        const articles = articlesContainer.querySelectorAll('.article-card');
        console.log(`📦 ${articles.length} article(s) trouvé(s)`);
        
        let totalCalcule = 0;
        articles.forEach((article, index) => {
            const quantiteElement = article.querySelector('.text-blue-600');
            const sousTotalElement = article.querySelector('.text-lg.font-bold');
            const articleData = JSON.parse(article.dataset.article || '{}');
            
            if (quantiteElement && articleData) {
                const quantite = parseInt(quantiteElement.textContent);
                const prix = getPrixUpsell(articleData, quantite);
                const sousTotal = articleData.isUpsell ? prix : prix * quantite;
                
                console.log(`   Article ${index + 1}: ${articleData.nom}`);
                console.log(`      - Quantité: ${quantite}`);
                console.log(`      - Prix unitaire: ${articleData.prix_unitaire} DH`);
                console.log(`      - Prix upsell 1: ${articleData.prix_upsell_1} DH`);
                console.log(`      - Prix upsell 2: ${articleData.prix_upsell_2} DH`);
                console.log(`      - Prix upsell 3: ${articleData.prix_upsell_3} DH`);
                console.log(`      - Prix upsell 4: ${articleData.prix_upsell_4} DH`);
                console.log(`      - isUpsell: ${articleData.isUpsell}`);
                console.log(`      - Prix calculé: ${prix} DH`);
                console.log(`      - Sous-total calculé: ${sousTotal} DH`);
                console.log(`      - Sous-total affiché: ${sousTotalElement ? sousTotalElement.textContent : 'Non trouvé'}`);
                
                totalCalcule += sousTotal;
            }
        });
        
        console.log(`💰 Total calculé: ${totalCalcule.toFixed(2)} DH`);
        
        const totalElement = document.getElementById('total-commande');
        if (totalElement) {
            console.log(`📊 Total affiché avant recalcul: ${totalElement.textContent}`);
        }
        
        // Forcer le recalcul avec la méthode principale
        mettreAJourTotalCommande();
        
        if (totalElement) {
            console.log(`📊 Total affiché après recalcul principal: ${totalElement.textContent}`);
        }
        
        // Essayer aussi la méthode alternative
        console.log('\n🧮 Test de la méthode alternative...');
        const totalAlternatif = recalculerTotalDepuisSousTotaux();
        
        console.log('🔄 Recalcul forcé effectué avec les deux méthodes');
    };
    
    console.log('💡 Fonction de debug disponible: debugTotalCommande()');

});

// ================== SYSTÈME DE FILTRAGE DES ARTICLES ==================

// Fonction principale de filtrage des articles
function filtrerArticles(typeFiltre) {
    console.log(`🔍 Filtrage des articles par type: ${typeFiltre}`);
    
    filtreActuel = typeFiltre;
    
    // Mettre à jour l'état visuel des badges
    mettreAJourBadgesActifs(typeFiltre);
    
    // Appliquer le filtre sur la liste déroulante
    appliquerFiltreSelect(typeFiltre);
    
    // Afficher une notification
    const compteur = compterArticlesParType(typeFiltre);
    const message = typeFiltre === 'all' ? 
        `🔍 Affichage de tous les articles (${compteur} total)` :
        `🔍 Filtrage par ${typeFiltre.toUpperCase()}: ${compteur} article(s) trouvé(s)`;
    
    showNotification(message, 'info', 2000);
}

// Fonction pour mettre à jour l'état visuel des badges
function mettreAJourBadgesActifs(typeActif) {
    // Retirer la classe active de tous les badges
    document.querySelectorAll('.filter-badge').forEach(badge => {
        badge.classList.remove('active');
    });
    
    // Ajouter la classe active au badge sélectionné
    const badgeActif = document.getElementById(`filter-${typeActif}`);
    if (badgeActif) {
        badgeActif.classList.add('active');
    }
}

// Fonction pour appliquer le filtre sur la liste déroulante
function appliquerFiltreSelect(typeFiltre) {
    const select = document.getElementById('articleSelect');
    const tableBody = document.getElementById('articlesTableBody');
    if (!select) {
        console.warn('⚠️ Select des articles introuvable');
        return;
    }
    
    // Sauvegarder la sélection actuelle
    const selectionActuelle = select.value;
    
    // Vider et reconstruire la liste
    select.innerHTML = '<option value="">-- Sélectionner un article --</option>';
    if (tableBody) tableBody.innerHTML = '';
    
    if (!articlesDisponibles || articlesDisponibles.length === 0) {
        select.innerHTML = '<option value="">-- Aucun article disponible --</option>';
        return;
    }
    
    let articlesAffiches = 0;
    
    articlesDisponibles.forEach((article, index) => {
        // Vérifier si l'article correspond au filtre
        if (typeFiltre === 'all' || correspondAuFiltre(article, typeFiltre)) {
            try {
                const option = document.createElement('option');
                option.value = article.id;
                
                // Construire le texte de l'option
                let optionText = article.nom || 'Article sans nom';
                
                // Ajouter les badges de statut
                const badges = [];
                if (article.has_promo_active) badges.push('🔥PROMO');
                if (article.phase === 'LIQUIDATION') badges.push('🏷️LIQUIDATION');
                if (article.phase === 'EN_TEST') badges.push('🧪TEST');
                if (article.isUpsell) badges.push('⬆️UPSELL');
                
                if (badges.length > 0) {
                    optionText += ` [${badges.join(' ')}]`;
                }
                
                if (article.prix_actuel) {
                    optionText += ` - ${article.prix_actuel} DH`;
                }
                
                // Ajouter détails
                const details = [];
                if (article.pointure && article.pointure.trim()) {
                    details.push(`T:${article.pointure}`);
                }
                if (article.couleur && article.couleur.trim()) {
                    details.push(`C:${article.couleur}`);
                }
                
                if (details.length > 0) {
                    optionText += ` (${details.join(', ')})`;
                }
                
                option.textContent = optionText;
                option.dataset.article = JSON.stringify(article);
                
                // Appliquer le style selon le type
                appliquerStyleOption(option, article);
                
                select.appendChild(option);

                // Rendu tableau
                if (tableBody) {
                    const tr = document.createElement('tr');
                    tr.dataset.article = JSON.stringify(article);
                    let rowBg = '';
                    let badgeHtml = '';
                    if (article.has_promo_active) { rowBg = 'bg-red-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-fire mr-1"></i>PROMO</span>'; }
                    if (article.phase === 'LIQUIDATION') { rowBg = 'bg-orange-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-tags mr-1"></i>LIQUIDATION</span>'; }
                    if (article.phase === 'EN_TEST') { rowBg = 'bg-blue-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-flask mr-1"></i>TEST</span>'; }
                    if (article.isUpsell) { rowBg = 'bg-green-50'; badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-arrow-up mr-1"></i>UPSELL</span>'; }
                    tr.className = rowBg;
                    const prixActuel = (typeof article.prix_actuel === 'number' ? article.prix_actuel : (article.prix_unitaire || 0));
                    const stock = (typeof article.qte_disponible === 'number' ? article.qte_disponible : (parseInt(article.qte_disponible || '0') || 0));
                    tr.innerHTML = `
                        <td class="px-4 py-3">
                            <div class="flex items-start space-x-4">
                                <!-- Image de l'article -->
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 border-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                        ${article.image_url ? 
                                            `<img src="${article.image_url}" alt="Image de ${article.nom}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
                                            ''
                                        }
                                        <div class="w-full h-full flex items-center justify-center text-gray-400 ${article.image_url ? 'hidden' : ''}">
                                            <i class="fas fa-image text-xl"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Informations de l'article -->
                                <div class="flex-1 min-w-0">
                                    <div class="font-medium text-gray-900">${article.nom || ''}</div>
                                    <div class="text-xs text-gray-500">Réf: ${article.reference || '-'}</div>
                                    <div class="mt-1">${badgeHtml}</div>
                                    <div class="mt-1 flex flex-wrap gap-2 text-xs">
                                        ${article.pointure ? `<span class=\"px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full\"><i class=\"fas fa-ruler-vertical mr-1\"></i>${article.pointure}</span>` : ''}
                                        ${article.couleur ? `<span class=\"px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full\"><i class=\"fas fa-palette mr-1\"></i>${article.couleur}</span>` : ''}
                                        ${typeof article.categorie === 'string' ? `<span class=\"px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full\"><i class=\"fas fa-tag mr-1\"></i>${article.categorie}</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center font-semibold text-green-600">${prixActuel} DH</td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-0.5 rounded-full text-xs font-medium ${stock <= 0 ? 'bg-red-100 text-red-700' : (stock < 5 ? 'bg-orange-100 text-orange-700' : 'bg-teal-100 text-teal-700')}">${stock <= 0 ? 'Épuisé' : stock + ' unités'}</span>
                        </td>

                        <td class="px-4 py-3 text-center">
                            <button type="button" class="px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg" onclick="ajouterDepuisLigne(this)"><i class="fas fa-plus mr-1"></i>Ajouter</button>
                        </td>`;
                    tableBody.appendChild(tr);
                }
                articlesAffiches++;
                
            } catch (error) {
                console.error(`❌ Erreur lors de l'ajout de l'article filtré ${index + 1}:`, error);
            }
        }
    });
    
    // Restaurer la sélection si elle est toujours visible
    if (selectionActuelle) {
        select.value = selectionActuelle;
    }
    
    console.log(`📊 Filtrage terminé: ${articlesAffiches} article(s) affiché(s) sur ${articlesDisponibles.length} total`);
    
    // Réinitialiser la scrollbar après le filtrage
    setTimeout(() => {
        if (typeof reinitScrollbarAfterArticlesLoad === 'function') {
            reinitScrollbarAfterArticlesLoad();
        }
    }, 100);
}

// Fonction pour vérifier si un article correspond au filtre
function correspondAuFiltre(article, typeFiltre) {
    switch (typeFiltre) {
        case 'promo':
            return Boolean(article.has_promo_active);
        case 'liquidation':
            return article.phase === 'LIQUIDATION';
        case 'test':
            return article.phase === 'EN_TEST';
        case 'upsell':
            return Boolean(article.isUpsell);
        case 'all':
        default:
            return true;
    }
}

// Fonction pour appliquer le style à une option selon le type d'article
function appliquerStyleOption(option, article) {
    if (article.has_promo_active) {
        option.style.backgroundColor = '#fef2f2';
        option.style.color = '#dc2626';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'LIQUIDATION') {
        option.style.backgroundColor = '#fff7ed';
        option.style.color = '#ea580c';
        option.style.fontWeight = 'bold';
    } else if (article.phase === 'EN_TEST') {
        option.style.backgroundColor = '#eff6ff';
        option.style.color = '#2563eb';
        option.style.fontWeight = 'bold';
    } else if (article.isUpsell) {
        option.style.backgroundColor = '#f0fdf4';
        option.style.color = '#16a34a';
        option.style.fontWeight = 'bold';
    }
}

// Fonction pour compter les articles par type
function compterArticlesParType(typeFiltre) {
    if (!articlesDisponibles || articlesDisponibles.length === 0) {
        return 0;
    }
    
    if (typeFiltre === 'all') {
        return articlesDisponibles.length;
    }
    
    return articlesDisponibles.filter(article => correspondAuFiltre(article, typeFiltre)).length;
}

// Fonction pour mettre à jour les compteurs sur les badges
function mettreAJourCompteursFiltre() {
    const types = ['all', 'promo', 'liquidation', 'test', 'upsell'];
    
    types.forEach(type => {
        const badge = document.getElementById(`filter-${type}`);
        if (badge) {
            const compteur = compterArticlesParType(type);
            
            // Supprimer l'ancien compteur s'il existe
            const ancienCompteur = badge.querySelector('.article-count');
            if (ancienCompteur) {
                ancienCompteur.remove();
            }
            
            // Ajouter le nouveau compteur
            if (compteur > 0) {
                const compteurElement = document.createElement('span');
                compteurElement.className = 'article-count';
                compteurElement.textContent = compteur;
                badge.appendChild(compteurElement);
            }
        }
    });
    
    console.log('📊 Compteurs des filtres mis à jour:', {
        tous: compterArticlesParType('all'),
        promo: compterArticlesParType('promo'),
        liquidation: compterArticlesParType('liquidation'),
        test: compterArticlesParType('test'),
        upsell: compterArticlesParType('upsell')
    });
}

// Fonction pour réinitialiser le filtre
function reinitialiserFiltre() {
    filtrerArticles('all');
}

// Ajouter des raccourcis clavier pour le filtrage
document.addEventListener('keydown', function(event) {
    // Uniquement si la modale d'articles est ouverte
    const articleModal = document.getElementById('articleModal');
    if (articleModal && articleModal.style.display === 'flex') {
        if (event.altKey) {
            switch (event.key) {
                case '1':
                    event.preventDefault();
                    filtrerArticles('all');
                    break;
                case '2':
                    event.preventDefault();
                    filtrerArticles('promo');
                    break;
                case '3':
                    event.preventDefault();
                    filtrerArticles('liquidation');
                    break;
                case '4':
                    event.preventDefault();
                    filtrerArticles('test');
                    break;
                case '5':
                    event.preventDefault();
                    filtrerArticles('upsell');
                    break;
            }
        }
    }
});

// ================== MODAL DE CONFIRMATION ==================

// Fonction pour afficher le modal de confirmation
function showConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
}

// Fonction pour masquer le modal de confirmation
function hideConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// Fonction pour procéder à la confirmation
function proceedWithConfirmation() {
    hideConfirmationModal();
    
    // Afficher une notification de traitement en cours
    showNotification('⏳ Confirmation en cours... (vérification du stock)', 'info');
    
    // Récupérer les informations de livraison du formulaire
    const villeSelect = document.getElementById('ville-select');
    const adresseTextarea = document.querySelector('textarea[name="adresse_livraison"]');
    
    const villeId = villeSelect ? villeSelect.value : '';
    const adresse = adresseTextarea ? adresseTextarea.value.trim() : '';
    
    console.log('🏙️ DEBUG: Données de livraison à envoyer:', {
        ville_livraison: villeId,
        adresse_livraison: adresse
    });
    
    // Confirmer la commande avec les informations de livraison
    fetch(`/operateur-confirme/commandes/{{ commande.id }}/confirmer-ajax/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    'commentaire': 'Commande confirmée après vérification complète',
                    'ville_livraison': villeId,
                    'adresse_livraison': adresse
                })
        })
        .then(response => response.json())
        .then(data => {
            console.log('📬 DEBUG: Réponse de confirmation reçue:', data);
            
            if (data.success) {
                // Message de succès avec détails du stock
                let successMessage = '✅ Commande confirmée avec succès !';
                
                if (data.articles_decrémentes && data.articles_decrémentes > 0) {
                    successMessage += `\n📦 ${data.articles_decrémentes} article(s) décrémenté(s) du stock.`;
                    
                    // Log détaillé des modifications de stock
                    if (data.details_stock && data.details_stock.length > 0) {
                        console.log('📊 DEBUG: Détails de la décrémentation du stock:');
                        data.details_stock.forEach((item, index) => {
                            console.log(`   Article ${index + 1}: ${item.article}`);
                            console.log(`      - Stock: ${item.ancien_stock} → ${item.nouveau_stock} (-${item.quantite_decrémententée})`);
                        });
                    }
                }
                
                showNotification(successMessage, 'success');
                
                // Rediriger après un court délai pour voir la notification
                setTimeout(() => {
                window.location.href = '{% url "operatConfirme:confirmation" %}';
                }, 1000); // 1 seconde pour voir la notification
                
            } else {
                // Gestion des erreurs de stock insuffisant
                console.error('❌ DEBUG: Erreur de confirmation:', data.message);
                
                if (data.stock_insuffisant && data.stock_insuffisant.length > 0) {
                    // Préparer les données pour le modal de stock insuffisant
                    window.stockInsuffisantData = data.stock_insuffisant;
                    showStockInsuffisantModal();
                } else {
                    showNotification('❌ Erreur lors de la confirmation : ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            console.error('❌ DEBUG: Erreur de connexion:', error);
            showNotification('❌ Une erreur de connexion est survenue : ' + error.message, 'error');
        });
}

// ================== MODAL DE STOCK INSUFFISANT ==================

// Fonction pour afficher le modal de stock insuffisant
function showStockInsuffisantModal() {
    // Remplir le contenu du modal avec les données de stock
    const stockList = document.getElementById('stockInsuffisantList');
    if (stockList && window.stockInsuffisantData) {
        stockList.innerHTML = '';
        window.stockInsuffisantData.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center py-2 px-3 bg-red-50 rounded-lg border border-red-200';
            li.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-red-500 rounded-full"></div>
                    <span class="font-medium text-gray-900">${item.article}</span>
                </div>
                <div class="text-sm text-red-600">
                    <span class="font-medium">Stock: ${item.stock_actuel}</span> | 
                    <span class="font-medium">Demandé: ${item.quantite_demandee}</span>
                </div>
            `;
            stockList.appendChild(li);
        });
    }
    
    const modal = document.getElementById('stockInsuffisantModal');
    if (modal) {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
}

// Fonction pour masquer le modal de stock insuffisant
function hideStockInsuffisantModal() {
    const modal = document.getElementById('stockInsuffisantModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// ================== VALIDATION DES SECTIONS ==================

// Fonction pour valider une section
function validerSection(sectionId) {
    const sectionElement = event.target.closest('.verification-item');
    const sectionName = getSectionName(sectionId);
    
    // Traitement spécifique pour les informations de livraison
    if (sectionId === 'informations-livraison') {
        sauvegarderInformationsLivraison(sectionElement, sectionName);
        return;
    }

    // Traitement spécifique pour les informations client
    if (sectionId === 'informations-client') {
        sauvegarderInformationsClient(sectionElement, sectionName);
        return;
    }

    // Animation de validation pour les autres sections
    sectionElement.classList.add('verified');

    // Afficher une notification de succès
    showToast(`✅ ${sectionName} validée avec succès !`, 'success');

    // Optionnel : Désactiver le bouton après validation
    const button = event.target;
    button.innerHTML = '<i class="fas fa-check-double mr-2"></i>Validé';
    button.disabled = true;
    button.style.background = '#6b7280';
    button.style.cursor = 'not-allowed';
    button.classList.add('cursor-not-allowed');

    // Vérifier si toutes les sections sont validées
    checkAllSectionsValidated();
}

// Nouvelle fonction pour sauvegarder les informations client
function sauvegarderInformationsClient(sectionElement, sectionName) {
    const button = event.target;

    // Récupérer les données des champs
    const nom = document.querySelector('[name="client_nom"]').value.trim();
    const prenom = document.querySelector('[name="client_prenom"]').value.trim();
    const telephone = document.querySelector('[name="client_telephone"]').value.trim();

    // Simple validation côté client
    if (!nom || !telephone) {
        showToast('⚠️ Tous les champs client Nom, Téléphone sont obligatoires.', 'warning');
        return;
    }

    // Désactiver le bouton pendant la sauvegarde
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde...';

    // Préparer les données à envoyer
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('action', 'save_client_info');
    formData.append('nom', nom);
    formData.append('prenom', prenom);
    formData.append('telephone', telephone);

    // Envoyer la requête AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animation de validation
            sectionElement.classList.add('verified');

            // Afficher une notification de succès
            showToast(`✅ ${sectionName} sauvegardée avec succès !`, 'success');

            // Mettre à jour le bouton
            button.innerHTML = '<i class="fas fa-check-double mr-2"></i>Validé';
            button.style.background = '#6b7280';
            button.style.cursor = 'not-allowed';
            button.classList.add('cursor-not-allowed');

            // Vérifier si toutes les sections sont validées
            checkAllSectionsValidated();
        } else {
            // Erreur lors de la sauvegarde
            showToast(`❌ Erreur lors de la sauvegarde : ${data.error || 'Erreur inconnue'}`, 'error');

            // Réactiver le bouton
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-user-check mr-2"></i>Valider les infos client';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la sauvegarde des informations client:', error);
        showToast('❌ Erreur de connexion lors de la sauvegarde', 'error');

        // Réactiver le bouton
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-user-check mr-2"></i>Valider les infos client';
    });
}

// Fonction pour sauvegarder les informations de livraison
function sauvegarderInformationsLivraison(sectionElement, sectionName) {
    const button = event.target;
    
    // Récupérer les données de livraison
    const villeSelect = document.querySelector('select[name="ville_livraison"]');
    const adresseTextarea = document.querySelector('textarea[name="adresse_livraison"]');
    
    const villeId = villeSelect ? villeSelect.value : '';
    const adresse = adresseTextarea ? adresseTextarea.value.trim() : '';
    
    // Validation simple côté client
    if (!villeId) {
        showToast('⚠️ Veuillez sélectionner une ville de livraison.', 'warning');
        return;
    }
    if (!adresse || adresse === '' || adresse === 'N/A') {
        showToast('⚠️ Le champ Adresse doit être renseigné.', 'warning');
        return;
    }
    
    // Désactiver le bouton pendant la sauvegarde
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sauvegarde...';
    
    // Préparer les données à envoyer (ville + adresse)
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    formData.append('action', 'save_livraison');
    formData.append('ville_livraison', villeId);
    formData.append('adresse_livraison', adresse);
    
    // Envoyer la requête AJAX
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Animation de validation
            sectionElement.classList.add('verified');
            
            // Mettre à jour les champs affichés si des données sont retournées
            if (data.ville_nom) {
                const regionDisplay = document.getElementById('region-display');
                if (regionDisplay && data.region_nom) {
                    regionDisplay.value = data.region_nom;
                }
                
                const fraisDisplay = document.getElementById('frais-display');
                if (fraisDisplay && data.frais_livraison !== null) {
                    fraisDisplay.value = `${data.frais_livraison} DH`;
                }
                
                // Mettre à jour le total avec les nouveaux calculs du serveur
                if (data.nouveau_total !== undefined) {
                    const totalElement = document.getElementById('total-commande');
                    if (totalElement) {
                        totalElement.textContent = `${data.nouveau_total.toFixed(2)} DH`;
                    }
                }
                
                // Mettre à jour le sous-total des articles
                if (data.sous_total_articles !== undefined) {
                    const sousTotalElement = document.getElementById('sous-total-articles');
                    if (sousTotalElement) {
                        sousTotalElement.textContent = `${data.sous_total_articles.toFixed(2)} DH`;
                    }
                }
            }
            
            // Afficher une notification de succès avec le message du serveur
            showToast(`✅ ${data.message}`, 'success');
            
            // Mettre à jour le bouton
            button.innerHTML = '<i class="fas fa-check-double mr-2"></i>Validé';
            button.style.background = '#6b7280';
            button.style.cursor = 'not-allowed';
            button.classList.add('cursor-not-allowed');
            
            // Vérifier si toutes les sections sont validées
            checkAllSectionsValidated();
        } else {
            // Erreur lors de la sauvegarde
            showToast(`❌ Erreur lors de la sauvegarde : ${data.error || 'Erreur inconnue'}`, 'error');
            
            // Réactiver le bouton
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-truck mr-2"></i>Valider la livraison';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la sauvegarde des informations de livraison:', error);
        showToast('❌ Erreur de connexion lors de la sauvegarde', 'error');
        
        // Réactiver le bouton
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-truck mr-2"></i>Valider la livraison';
    });
}

// Fonction pour obtenir le nom de la section
function getSectionName(sectionId) {
    const sectionNames = {
        'informations-commande': 'Section Informations Commande',
        'informations-client': 'Section Informations Client',
        'informations-livraison': 'Section Informations Livraison',
        'gestion-operations': 'Section Gestion des Opérations',
        'articles-commande': 'Section Articles de la Commande'
    };
    return sectionNames[sectionId] || 'Section';
}



// Fonction pour modifier la quantité d'un article (avec boutons +/-)
function modifierQuantite(panierId, delta) {
    const input = document.getElementById(`quantite-${panierId}`);
    if (input) {
        const currentValue = parseInt(input.value) || 0;
        const newValue = Math.max(1, currentValue + delta);
        input.value = newValue;
        modifierQuantiteDirecte(panierId, newValue);
    }
}

// Fonction pour modifier directement la quantité d'un article
function modifierQuantiteDirecte(panierId, nouvelleQuantite) {
    const quantite = parseInt(nouvelleQuantite);
    
    // Validation
    if (isNaN(quantite) || quantite < 1) {
        // Restaurer la valeur précédente
        const input = document.getElementById(`quantite-${panierId}`);
        if (input) {
            input.value = input.getAttribute('data-previous-value') || 1;
        }
        showToast('⚠️ La quantité doit être au moins de 1.', 'warning');
        return;
    }

    // Sauvegarder la valeur précédente
    const input = document.getElementById(`quantite-${panierId}`);
    if (input) {
        input.setAttribute('data-previous-value', input.value);
    }

    // Envoyer la modification au serveur
    const formData = new FormData();
    formData.append('action', 'update_quantity');
    formData.append('panier_id', panierId);
    formData.append('nouvelle_quantite', quantite);
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
    
    fetch('{% url "operatConfirme:modifier_commande" commande.id %}', { 
        method: 'POST', 
        body: formData 
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            // Mettre à jour l'affichage du sous-total et du total
            mettreAJourTotauxConfirmation(panierId, data);
            showToast('✅ Quantité mise à jour', 'success');
        } else {
            // Restaurer la valeur précédente en cas d'erreur
            if (input) {
                input.value = input.getAttribute('data-previous-value') || 1;
            }
            showToast('❌ ' + (data.error || 'Impossible de modifier la quantité.'), 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erreur:', error);
        // Restaurer la valeur précédente en cas d'erreur
        if (input) {
            input.value = input.getAttribute('data-previous-value') || 1;
        }
        showToast('❌ Erreur de communication', 'error');
    });
}

// Fonction pour mettre à jour les totaux en temps réel (utilisée lors des changements de quantité)
function mettreAJourTotauxConfirmation(panierId, data) {
    // Mettre à jour le sous-total de la ligne spécifique (seulement pour les changements de quantité)
    if (data.sous_total !== undefined && panierId) {
        const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
        if (sousTotalElement) {
            sousTotalElement.textContent = `${parseFloat(data.sous_total).toFixed(2)} DH`;
            console.log(`✅ Sous-total mis à jour pour article ${panierId}: ${parseFloat(data.sous_total).toFixed(2)} DH`);
        }
    }
    
    // Utiliser la fonction centralisée pour tous les autres totaux
    mettreAJourTousLesTotaux(data);
    
    // Déclencher un événement personnalisé pour signaler la mise à jour
    window.dispatchEvent(new CustomEvent('totauxMisAJour', { 
        detail: { 
            panierId: panierId,
            data: data
        }
    }));
}

// Fonction pour vérifier si toutes les sections sont validées
function checkAllSectionsValidated() {
    const allSections = document.querySelectorAll('.verification-item');
    const validatedSections = document.querySelectorAll('.verification-item.verified');
    
    if (allSections.length === validatedSections.length) {
        showToast('🎉 Toutes les sections ont été validées ! Vous pouvez maintenant confirmer la commande.', 'success', 5000);
        
        // Optionnel : Mettre en évidence le bouton de confirmation finale
        const confirmButton = document.querySelector('.btn-confirm');
        if (confirmButton) {
            confirmButton.classList.add('animate-pulse');
            setTimeout(() => {
                confirmButton.classList.remove('animate-pulse');
            }, 3000);
        }
    }
}

// Fonction pour afficher les notifications toast
function showToast(message, type = 'info', duration = 3000) {
    // Créer l'élément toast
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
    
    // Définir les couleurs selon le type
    const colors = {
        'success': 'bg-green-600',
        'error': 'bg-red-600',
        'warning': 'bg-yellow-600',
        'info': 'bg-blue-600'
    };
    
    toast.classList.add(colors[type] || colors['info']);
    toast.innerHTML = message;
    
    // Ajouter au DOM
    document.body.appendChild(toast);
    
    // Animation d'entrée
    setTimeout(() => {
        toast.classList.remove('translate-x-full');
    }, 100);
    
    // Animation de sortie et suppression
    setTimeout(() => {
        toast.classList.add('translate-x-full');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, duration);
}



// Fermer la modal avec Escape (uniquement si elle est ouverte)
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const modal = document.getElementById('modalExplicationTotal');
        if (modal && modal.style.display === 'flex') {
            fermerModalExplicationTotal();
        }
    }
});

// Dans le script JavaScript, ajouter une vérification pour le prix
function afficherInfosArticle(article) {
    const quantite = parseInt(document.getElementById('quantiteInput').value) || 1;
    
    // Vérifier si le prix actuel est défini, sinon utiliser le prix unitaire
    const prixActuel = article.prix_actuel !== undefined ? article.prix_actuel : article.prix_unitaire;
    const sousTotal = (prixActuel * quantite).toFixed(2);
    
    // Informations de base
    document.getElementById('info-reference').textContent = article.reference || '-';
    document.getElementById('info-prix').textContent = `${prixActuel} DH`;
    document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
}

// Autres modifications similaires dans le script
function mettreAJourSousTotal() {
    const articleSelectionne = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');
    
    if (articleSelectionne && quantiteInput) {
        const selectedArticle = JSON.parse(articleSelectionne.value);
        const quantite = parseInt(quantiteInput.value) || 1;
        
        // Vérifier si le prix actuel est défini, sinon utiliser le prix unitaire
        const prixActuel = selectedArticle.prix_actuel !== undefined ? selectedArticle.prix_actuel : selectedArticle.prix_unitaire;
        const sousTotal = (prixActuel * quantite).toFixed(2);
        
        document.getElementById('info-sous-total').textContent = `${sousTotal} DH`;
    }
}

function ajouterArticleAuPanier() {
    const articleSelect = document.getElementById('articleSelect');
    const quantiteInput = document.getElementById('quantiteInput');
    const articlesContainer = document.getElementById('articles-container');

    if (!articleSelect || !quantiteInput || !articlesContainer) {
        console.error('❌ Éléments de sélection ou conteneur d\'articles introuvables');
        showNotification('❌ Erreur de chargement des éléments', 'error');
        return;
    }

    const selectedOption = articleSelect.options[articleSelect.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        showNotification('❌ Veuillez sélectionner un article', 'error');
        return;
    }

    const article = JSON.parse(selectedOption.dataset.article);
    const quantite = parseInt(quantiteInput.value) || 1;
    const prixActuel = article.prix_actuel !== undefined ? article.prix_actuel : article.prix_unitaire;
    const sousTotal = (prixActuel * quantite).toFixed(2);

    // Créer la nouvelle carte d'article
    const articleCard = document.createElement('div');
    articleCard.className = 'article-card p-4 bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all shadow-sm';
    // On ajoute un attribut pour pouvoir le supprimer/modifier plus tard si besoin.
    // NOTE: Cet ID est temporaire côté client. Il devra être mis à jour avec l'ID de la base de données après sauvegarde.
    articleCard.dataset.articleId = `new-${Date.now()}`; 

    articleCard.innerHTML = `
        <div class="flex items-center justify-between">
            <div class="flex-1">
                <div class="flex items-center space-x-4">
                    <div class="min-w-0 flex-1">
                        <div class="font-semibold text-lg" style="color: #4B352A;">${article.nom}</div>
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-hashtag mr-1"></i>Réf: ${article.reference || 'N/A'}
                        </div>
                        <div class="mt-2 flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">
                                <i class="fas fa-ruler-vertical mr-1"></i>${article.pointure || 'N/A'}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium">
                                <i class="fas fa-palette mr-1"></i>${article.couleur || 'N/A'}
                            </span>
                             <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">
                                <i class="fas fa-boxes mr-1"></i>Stock: ${article.qte_disponible}
                            </span>
                        </div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Quantité</div>
                        <div class="font-medium text-blue-600">${quantite} unité${quantite > 1 ? 's' : ''}</div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Prix actuel</div>
                        <div class="font-medium text-green-600">${prixActuel} DH</div>
                    </div>
                    <div class="text-center min-w-0">
                        <div class="text-sm text-gray-500">Sous-total</div>
                        <div class="text-lg font-bold" style="color: #6d4b3b;">${sousTotal} DH</div>
                    </div>
                </div>
            </div>
            <div class="flex space-x-2 ml-4">
                <button type="button" onclick="modifierArticle(${articleCard.dataset.articleId})" class="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-lg transition-colors flex items-center" title="Modifier">
                    <i class="fas fa-edit mr-1"></i>Modifier
                </button>
                <button type="button" onclick="supprimerArticle(this)" class="px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm rounded-lg transition-colors flex items-center" title="Supprimer">
                    <i class="fas fa-trash mr-1"></i>Supprimer
                </button>
            </div>
        </div>
    `;

    articlesContainer.appendChild(articleCard);

    mettreAJourTotalCommande();

    // Fermer la modale d'ajout
    const modal = document.getElementById('addArticleModal');
    if(modal) {
        modal.classList.add('hidden');
    }
    
    showNotification('✅ Article ajouté au panier', 'success');
}

// La fonction mettreAJourTotalCommande est déjà définie plus haut dans le fichier

// Fonction pour afficher une notification
function showNotification(message, type = 'info', duration = 3000) {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-orange-500'
    };
    
    // Créer l'élément de notification
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-md shadow-lg z-50 animate-fade-in`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : type === 'warning' ? 'exclamation' : 'info'}-circle mr-2"></i>${message}`;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Ajouter une animation d'entrée
    notification.style.animation = 'fadeIn 0.3s ease-in-out';
    notification.style.opacity = '0';
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 10);
    
    // Supprimer après la durée spécifiée
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.animation = 'fadeOut 0.3s ease-in-out';
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, duration);
}

// Fonction pour rafraîchir les données de stock d'un article
function rafraichirStockArticle(articleId) {
    console.log('🔄 Rafraîchissement du stock pour l\'article ID:', articleId);
    
    // Récupérer le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('❌ Token CSRF introuvable');
        return Promise.reject('Token CSRF manquant');
    }
    
    // Appel AJAX pour récupérer les données à jour de l'article
    return fetch(`{% url 'operatConfirme:api_recherche_article_ref' %}?id=${articleId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📊 Données article rafraîchies:', data);
        
        try {
            if (data.success && data.article) {
                // Mettre à jour l'affichage du stock
                const infoStock = document.getElementById('info-stock');
                const stockProgressBar = document.getElementById('stock-progress');
                const stockPercentage = document.getElementById('stock-percentage');
                
                if (infoStock) {
                    // S'assurer que qte_disponible est un nombre valide
                    let stock = 0;
                    try {
                        stock = typeof data.article.qte_disponible === 'number' ? 
                                data.article.qte_disponible : 
                                (data.article.qte_disponible ? parseInt(data.article.qte_disponible) : 0);
                        
                        // Si la conversion a échoué, utiliser 0
                        if (isNaN(stock)) {
                            console.warn('⚠️ Valeur de stock non numérique:', data.article.qte_disponible);
                            stock = 0;
                        }
                    } catch (e) {
                        console.error('❌ Erreur lors de la conversion du stock:', e);
                        stock = 0;
                    }
                    
                    // Mettre à jour l'affichage du stock avec style conditionnel
                    if (stockProgressBar && stockPercentage) {
                        // Définir une capacité maximale théorique pour la barre de progression
                        const capaciteMaximale = Math.max(stock, 100);
                        
                        // Calculer le pourcentage du stock
                        const pourcentage = Math.min(Math.round((stock / capaciteMaximale) * 100), 100);
                        
                        // Mettre à jour le texte et la couleur selon le niveau de stock
                        if (stock <= 0) {
                            infoStock.textContent = 'Épuisé';
                            infoStock.className = 'px-3 py-1 bg-red-100 text-red-700 rounded-full font-medium';
                            stockProgressBar.style.width = '0%';
                            stockProgressBar.className = 'h-2.5 rounded-full bg-red-500';
                            stockPercentage.textContent = '0%';
                            stockPercentage.className = 'ml-2 text-xs font-medium text-red-700';
                        } else if (stock < 5) {
                            infoStock.textContent = `${stock} unité(s) - Faible`;
                            infoStock.className = 'px-3 py-1 bg-orange-100 text-orange-700 rounded-full font-medium';
                            stockProgressBar.style.width = `${pourcentage}%`;
                            stockProgressBar.className = 'h-2.5 rounded-full bg-orange-500';
                            stockPercentage.textContent = `${pourcentage}%`;
                            stockPercentage.className = 'ml-2 text-xs font-medium text-orange-700';
                        } else {
                            infoStock.textContent = `${stock} unité(s)`;
                            infoStock.className = 'px-3 py-1 bg-teal-100 text-teal-700 rounded-full font-medium';
                            stockProgressBar.style.width = `${pourcentage}%`;
                            stockProgressBar.className = 'h-2.5 rounded-full bg-teal-600';
                            stockPercentage.textContent = `${pourcentage}%`;
                            stockPercentage.className = 'ml-2 text-xs font-medium text-teal-700';
                        }
                    } else {
                        // Fallback si les éléments de la barre de progression n'existent pas
                        infoStock.textContent = `${stock} unité(s)`;
                    }
                    
                    console.log('📦 Stock mis à jour:', stock);
                    
                    // Mettre à jour les badges avec les informations de l'article
                    try {
                        const caracteristiques = {
                            stock: `Stock: ${stock}`
                        };
                        mettreAJourBadgesModale(caracteristiques);
                    } catch (e) {
                        console.warn('⚠️ Erreur lors de la mise à jour des badges:', e);
                    }
                    
                    // Afficher une notification discrète
                    showNotification(`📦 Stock mis à jour: ${stock} unité(s)`, 'info', 2000);
                    
                    return data.article;
                }
            } else {
                console.warn('⚠️ Impossible de rafraîchir le stock:', data.error || 'Erreur inconnue');
                // Ne pas afficher de notification pour ne pas déranger l'utilisateur
                return null;
            }
        } catch (e) {
            console.error('❌ Erreur lors du traitement des données de stock:', e);
            return null;
        }
    })
    .catch(error => {
        console.error('❌ Erreur lors du rafraîchissement du stock:', error);
        // Ne pas afficher de notification pour éviter de déranger l'utilisateur
        // avec des erreurs techniques
        return null;
    });
}

function modifierArticle(panierId) {
    console.log('🔧 Modification article demandée pour ID:', panierId);
    
    isEditingArticle = true;
    currentArticleId = panierId;
    
    // Mettre à jour le titre
    document.getElementById('articleModalTitle').textContent = 'Modifier l\'article';
    
    // Toujours afficher le champ de sélection pour permettre de changer l'article
    document.getElementById('article-selection-field').classList.remove('hidden');
    document.getElementById('article-display-field').classList.add('hidden');
    
    // Charger la liste des articles
    chargerArticlesDisponibles();
    
    // Récupérer les données de l'article depuis la carte
    const articleCard = document.querySelector(`[data-article-id="${panierId}"]`);
    console.log('🔍 Article card trouvé:', articleCard ? 'OUI' : 'NON', articleCard);
    
    if (articleCard) {
        // Récupérer la quantité avec vérification de sécurité
        const quantiteElement = articleCard.querySelector('input[type="number"]');
        if (quantiteElement && quantiteElement.value) {
            document.getElementById('quantiteInput').value = quantiteElement.value;
        } else {
            document.getElementById('quantiteInput').value = '1'; // Valeur par défaut
        }
        
        // Récupérer la référence de l'article pour le pré-sélectionner avec vérification de sécurité
        const referenceElement = articleCard.querySelector('.text-sm.text-gray-500');
        let reference = '';
        if (referenceElement && referenceElement.textContent) {
            const referenceText = referenceElement.textContent;
            reference = referenceText.replace('Réf: ', '').replace('Référence: ', '').trim();
        }
        
        // Récupérer les données complètes de l'article depuis le dataset
        try {
            const articleData = JSON.parse(articleCard.dataset.article || '{}');
            console.log('📊 Données article récupérées:', articleData);
            
            // Afficher les informations de l'article avec les données complètes
            if (articleData && articleData.id) {
                afficherInfosArticle(articleData);
                
                // Rafraîchir les données de stock en temps réel
                rafraichirStockArticle(articleData.id).then(articleMisAJour => {
                    if (articleMisAJour) {
                        // Mettre à jour les données de l'article dans le dataset
                        articleData.qte_disponible = articleMisAJour.qte_disponible;
                        articleCard.dataset.article = JSON.stringify(articleData);
                    }
                });
            } else {
                // Fallback à l'ancienne méthode si les données ne sont pas disponibles
                afficherInfosArticleExistant(articleCard);
            }
        } catch (error) {
            console.error('❌ Erreur lors de la récupération des données article:', error);
            // Fallback à l'ancienne méthode
            afficherInfosArticleExistant(articleCard);
        }
        
        // Attendre que les articles soient chargés puis pré-sélectionner l'article actuel
        setTimeout(() => {
            preselectionnerArticle(reference);
        }, 500);
    }
    
    // Afficher la modale
    const modal = document.getElementById('articleModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    } else {
        console.error('❌ Modale articleModal introuvable lors de la modification d\'article');
    }
}

</script>

<!-- Modal de Confirmation Tailwind -->
<div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-lg m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f7d9c4;">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center pb-4 border-b" style="border-color: #f7d9c4;">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full flex items-center justify-center mr-4" style="background: linear-gradient(135deg, #4B352A, #6d4b3b);">
                    <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold" style="color: #4B352A;">Confirmer la Commande</h3>
            </div>
            <button onclick="hideConfirmationModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Êtes-vous sûr de vouloir confirmer cette commande ?</h4>
                    <div class="text-gray-600 space-y-2">
                        <p class="flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Cette action va décrémenter le stock des articles
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-ban mr-2 text-red-500"></i>
                            Cette action ne peut pas être annulée
                        </p>
                        <p class="flex items-center">
                            <i class="fas fa-paper-plane mr-2 text-green-500"></i>
                            La commande sera envoyée vers l'administration
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t" style="border-color: #f7d9c4;">
            <button onclick="hideConfirmationModal()" 
                    class="px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300" 
                    style="background-color: #f7d9c4; color: #4B352A;">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button onclick="proceedWithConfirmation()" 
                    class="px-6 py-3 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" 
                    style="background: linear-gradient(135deg, #4B352A, #6d4b3b); focus:ring-color: #4B352A;">
                <i class="fas fa-check mr-2"></i>
                Confirmer la Commande
            </button>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in-down {
        0% {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        100% {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    .animate-fade-in-down {
        animation: fade-in-down 0.4s ease-out;
    }
    
    /* Styles pour le tableau croisé des variantes */
    .variant-table {
        border-collapse: collapse;
        width: 100%;
    }
    
    .variant-table th,
    .variant-table td {
        border: 1px solid #d1d5db;
        padding: 0.75rem;
        text-align: center;
    }
    
    .variant-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #374151;
    }
    
    .variant-table td {
        background-color: white;
    }
    
    .variant-table tr:nth-child(even) td:first-child {
        background-color: #f9fafb;
    }
    
    .variant-checkbox {
        width: 1.2rem;
        height: 1.2rem;
        cursor: pointer;
    }
    
    .variant-checkbox:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .variant-table .stock-rupture {
        background-color: #fef2f2;
        color: #dc2626;
    }
    
    .variant-table .stock-disponible {
        background-color: #f0fdf4;
        color: #16a34a;
    }
    
    /* Responsive design pour le tableau */
    @media (max-width: 768px) {
        .variant-table {
            font-size: 0.875rem;
        }
        
        .variant-table th,
        .variant-table td {
            padding: 0.5rem;
        }
        
        .variant-checkbox {
            width: 1rem;
            height: 1rem;
        }
    }
    
    /* Animation pour la sélection */
    .variant-checkbox:checked + label {
        color: #2563eb;
        font-weight: 600;
    }
    
    /* Hover effects */
    .variant-table tr:hover td {
        background-color: #f8fafc;
    }
    
    .variant-table tr:hover td:first-child {
        background-color: #f1f5f9;
    }
</style>

<!-- Modal de Stock Insuffisant Tailwind -->
<div id="stockInsuffisantModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-2xl m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #f87171;">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center pb-4 border-b border-red-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-red-700">Stock Insuffisant</h3>
            </div>
            <button onclick="hideStockInsuffisantModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-times-circle text-red-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Confirmation impossible</h4>
                    <p class="text-gray-600">Les articles suivants n'ont pas un stock suffisant pour traiter cette commande :</p>
                </div>
            </div>
            
            <!-- Liste des articles en rupture -->
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <ul id="stockInsuffisantList" class="space-y-3">
                    <!-- Les éléments seront ajoutés dynamiquement par JavaScript -->
                </ul>
            </div>
            
            <!-- Suggestions d'action -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-lightbulb text-blue-600"></i>
                    </div>
                    <div>
                        <h5 class="font-semibold text-blue-900 mb-2">Suggestions :</h5>
                        <ul class="text-sm text-blue-800 space-y-1">
                            <li class="flex items-center">
                                <i class="fas fa-edit mr-2"></i>
                                Modifier les quantités des articles concernés
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-trash-alt mr-2"></i>
                                Retirer les articles en rupture de stock
                            </li>
                            <li class="flex items-center">
                                <i class="fas fa-exchange-alt mr-2"></i>
                                Remplacer par des articles similaires disponibles
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-red-200">
            <button onclick="hideStockInsuffisantModal()" 
                    class="px-6 py-3 bg-red-600 text-white rounded-lg font-medium transition-all duration-200 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transform hover:-translate-y-0.5">
                <i class="fas fa-check mr-2"></i>
                Compris
            </button>
        </div>
    </div>
</div>

<!-- Modal de Suppression d'Article Tailwind -->
<div id="deleteArticleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
    <div class="relative p-8 bg-white w-full max-w-md m-auto flex-col flex rounded-xl shadow-2xl animate-fade-in-down" style="border: 2px solid #ef4444;">
        <!-- En-tête du modal -->
        <div class="flex justify-between items-center pb-4 border-b border-red-200">
            <div class="flex items-center">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-red-700">Confirmer la Suppression</h3>
            </div>
            <button onclick="hideDeleteArticleModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenu du modal -->
        <div class="py-6">
            <div class="flex items-start space-x-4 mb-6">
                <div class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-600 text-lg"></i>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-gray-900 mb-2">Êtes-vous sûr de vouloir supprimer cet article ?</h4>
                    <p class="text-gray-600">Cette action est irréversible et l'article sera retiré de la commande.</p>
                </div>
            </div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
            <button onclick="hideDeleteArticleModal()" 
                    class="px-6 py-3 rounded-lg font-medium transition-all duration-200 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-300 bg-gray-200 text-gray-700">
                <i class="fas fa-times mr-2"></i>
                Annuler
            </button>
            <button id="confirmDeleteArticleBtn"
                    class="px-6 py-3 text-white rounded-lg font-medium transition-all duration-200 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:-translate-y-0.5" 
                    style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                <i class="fas fa-trash-alt mr-2"></i>
                Confirmer la suppression
            </button>
        </div>
    </div>
</div>

<!-- Modal d'explication du calcul du total -->
<div id="modalExplicationTotal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-calculator text-blue-500 mr-3"></i>
                Comprendre le calcul du total
            </h3>
            <button type="button" onclick="fermerModalExplicationTotal()" 
                    class="text-gray-400 hover:text-gray-600 text-xl font-bold">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Explication générale -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h4 class="font-semibold text-blue-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>Comment est calculé le total ?
                </h4>
                <p class="text-blue-700 text-sm">
                    Le total de la commande est la somme du sous-total des articles et des frais de livraison de la ville sélectionnée.
                </p>
            </div>
            
            <!-- Détail du calcul -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-3">
                    <i class="fas fa-list-ol mr-2"></i>Étapes de calcul
                </h4>
                
                <div class="space-y-3">
                    <!-- Articles -->
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-0.5">1</div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">Calcul du sous-total des articles</div>
                            <div class="text-sm text-gray-600 mt-1">
                                Pour chaque article: <strong>Prix unitaire × Quantité</strong>
                                <br>Puis addition de tous les sous-totaux
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upsells -->
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-0.5">2</div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">Application des prix upsell</div>
                            <div class="text-sm text-gray-600 mt-1">
                                Si la commande a un niveau upsell (compteur > 0), les prix upsell sont appliqués automatiquement
                                <br><strong>Niveau {{ commande.compteur }}</strong> {% if commande.compteur > 0 %}actif{% else %}aucun upsell{% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Frais livraison -->
                    <div class="flex items-start">
                        <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-sm font-bold mr-3 mt-0.5">3</div>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">Ajout des frais de livraison</div>
                            <div class="text-sm text-gray-600 mt-1">
                                Selon la ville sélectionnée: <strong>{% if commande.ville %}{{ commande.ville.nom }} = {{ commande.frais_livraison|floatformat:2 }} DH{% else %}Aucune ville sélectionnée{% endif %}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formule finale -->
            <div class="bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4">
                <h4 class="font-semibold text-gray-800 mb-2">
                    <i class="fas fa-equals mr-2"></i>Formule finale
                </h4>
                <div class="text-center">
                    <div class="text-lg font-mono bg-white rounded p-3 shadow-sm">
                        <span class="text-green-600 font-bold">Sous-total Articles</span>
                        <span class="text-gray-500 mx-2">+</span>
                        <span class="text-blue-600 font-bold">Frais Livraison</span>
                        <span class="text-gray-500 mx-2">=</span>
                        <span class="text-purple-600 font-bold">Total Commande</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-2">
                        <span id="calcul-exemple">
                            {{ commande.sous_total_articles|floatformat:2 }} DH + {{ commande.frais_livraison|floatformat:2 }} DH = {{ commande.total_cmd|floatformat:2 }} DH
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="flex justify-end pt-4 border-t">
                <button type="button" onclick="fermerModalExplicationTotal()" 
                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors">
                    <i class="fas fa-check mr-2"></i>Compris !
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de sélection des variantes -->
<div id="variantModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50" style="backdrop-filter: blur(8px); display: none;">
    <div class="bg-white rounded-xl p-6 w-full max-w-6xl mx-4 shadow-2xl">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-table text-blue-500 mr-3"></i>
                <span>Sélectionner des variantes - Tableau croisé</span>
            </div>
            <span class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalVariantes()">
                <i class="fas fa-times text-xl"></i>
            </span>
        </h3>

        <!-- Informations de l'article sélectionné -->
        <div id="articleInfo" class="mb-4 p-4 bg-gray-50 rounded-lg">
            <h4 id="articleNom" class="font-medium text-gray-900"></h4>
            <p id="articleReference" class="text-sm text-gray-600"></p>
        </div>

        <!-- Tableau croisé des variantes -->
        <div id="variantsTableContainer" class="mb-4">
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-table text-4xl mb-4 text-gray-300"></i>
                <p class="text-lg">Sélectionnez un article pour voir ses variantes</p>
            </div>
        </div>

        <!-- Informations des variantes sélectionnées -->
        <div id="selectedVariantsInfo" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg hidden">
            <h5 class="font-medium text-blue-900 mb-2">Variantes sélectionnées:</h5>
            <div id="selectedVariantsDetails" class="text-sm text-blue-800"></div>
        </div>

        <div class="flex justify-between items-center mt-6">
            <button type="button" id="clearSelectionBtn" onclick="effacerSelectionVariantes()" 
                    class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg transition-colors hidden">
                <i class="fas fa-times mr-2"></i>Effacer la sélection
            </button>
            
            <div class="flex space-x-3">
                <button type="button" id="addSelectedVariantsBtn" onclick="ajouterVariantesSelectionnees()" 
                        class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors hidden">
                    <i class="fas fa-plus mr-2"></i>Ajouter les variantes sélectionnées
                </button>
                <button type="button" onclick="fermerModalVariantes()" 
                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition-colors">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

</script>

{% endblock %} 