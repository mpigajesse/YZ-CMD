{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}

{% block title %}Nouvelle Commande - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }

    .btn-confirm {
        background: linear-gradient(to right, #4B352A, #6d4b3b);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-confirm:hover {
        background: linear-gradient(to right, #6d4b3b, #8B5A2B);
        transform: translateY(-1px);
        box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.2);
    }

    .form-card {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #f7d9c4;
        transition: all 0.3s ease;
    }

    .form-section {
        background: linear-gradient(to right, #f7d9c4, #ede0d3);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .panier-section {
        background: linear-gradient(135deg, #4B352A, #6d4b3b);
        color: #f7d9c4;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
    }

    .input-field {
        border: 1px solid #f7d9c4;
        border-radius: 0.5rem;
        padding: 0.75rem;
        transition: all 0.3s ease;
        background: white;
    }

    .input-field:focus {
        border-color: #6d4b3b;
        ring-color: #4B352A;
        box-shadow: 0 0 0 3px rgba(75, 53, 42, 0.1);
        outline: none;
    }

    .label-style {
        color: #4B352A;
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }

    .panier-item {
        background: rgba(255, 255, 255, 0.95);
        color: #4B352A;
        border-radius: 0.5rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid #f7d9c4;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .panier-item .font-semibold {
        color: #1f2937 !important;
    }

    .panier-item .text-xs {
        color: #4b5563 !important;
    }

    .panier-item .text-sm {
        color: #1f2937 !important;
    }

    .btn-action {
        background-color: #8B5A2B;
        color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-action:hover {
        background-color: #6d4b3b;
        transform: scale(1.05);
    }

    .btn-success {
        background-color: #059669;
    }

    .btn-success:hover {
        background-color: #047857;
    }

    .btn-danger {
        background-color: #DC2626;
    }

    .btn-danger:hover {
        background-color: #B91C1C;
    }

    /* Styles pour le syst√®me de basculement client */
    .client-type-btn {
        background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        color: #6b7280;
        border: 2px solid #e5e7eb;
        min-width: 150px;
        justify-content: center;
    }

    .client-type-btn.active {
        background: linear-gradient(135deg, #4B352A, #6d4b3b);
        color: white;
        border-color: #4B352A;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(75, 53, 42, 0.3);
    }

    .client-type-btn:hover:not(.active) {
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        color: #4B352A;
        border-color: #d1d5db;
        transform: translateY(-1px);
    }

    /* Toggle Switch */
    .toggle-switch {
        width: 60px;
        height: 30px;
        background: linear-gradient(135deg, #e5e7eb, #d1d5db);
        border-radius: 15px;
        position: relative;
        cursor: pointer;
        transition: all 0.4s ease;
        border: 2px solid #d1d5db;
    }

    .toggle-switch.active {
        background: linear-gradient(135deg, #4B352A, #6d4b3b);
        border-color: #4B352A;
    }

    .toggle-handle {
        width: 22px;
        height: 22px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch.active .toggle-handle {
        transform: translateX(30px);
        box-shadow: 0 2px 8px rgba(75, 53, 42, 0.3);
    }

    /* Styles pour les badges de filtrage */
    .filter-badge {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .filter-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .filter-badge.active {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        font-weight: bold;
    }

    .filter-badge.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: currentColor;
        opacity: 0.7;
    }

    /* Styles sp√©cifiques pour chaque type de badge actif */
    #filter-all.active {
        background: linear-gradient(135deg, #6b7280, #9ca3af) !important;
        color: white !important;
    }

    #filter-promo.active {
        background: linear-gradient(135deg, #dc2626, #ef4444) !important;
        color: white !important;
    }

    #filter-liquidation.active {
        background: linear-gradient(135deg, #ea580c, #f97316) !important;
        color: white !important;
    }

    #filter-test.active {
        background: linear-gradient(135deg, #2563eb, #3b82f6) !important;
        color: white !important;
    }

    #filter-upsell.active {
        background: linear-gradient(135deg, #16a34a, #22c55e) !important;
        color: white !important;
    }

    /* Styles pour le tableau des articles */
    #articlesScrollContainer {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }

    #articlesScrollContainer::-webkit-scrollbar {
        width: 8px;
    }

    #articlesScrollContainer::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }

    #articlesScrollContainer::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }

    #articlesScrollContainer::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }

    /* Styles de scrollbar pour le modal des variantes */
    #modalVariantes .overflow-y-scroll {
        scrollbar-width: auto;
        scrollbar-color: #4B352A #e2e8f0;
        overflow-y: scroll !important;
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar {
        width: 16px;
        background: #f1f5f9;
        display: block !important;
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        margin: 4px;
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #4B352A, #6d4b3b);
        border-radius: 8px;
        border: 2px solid #f1f5f9;
        min-height: 40px;
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #6d4b3b, #8B5A2B);
        box-shadow: 0 4px 8px rgba(75, 53, 42, 0.4);
        border-color: #e2e8f0;
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar-thumb:active {
        background: linear-gradient(135deg, #3d2a1f, #4B352A);
    }

    #modalVariantes .overflow-y-scroll::-webkit-scrollbar-corner {
        background: #f1f5f9;
    }

    /* Animation pour les lignes du tableau */
    #articlesTableBody tr {
        transition: all 0.2s ease;
    }

    #articlesTableBody tr:hover {
        transform: translateX(2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Styles pour les boutons de quantit√© */
    #articlesTableBody button {
        transition: all 0.2s ease;
    }

    #articlesTableBody button:hover {
        transform: scale(1.1);
    }

    /* Styles pour les badges de caract√©ristiques */
    .badge-legend .filter-badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }

    /* Responsive pour les badges */
    @media (max-width: 768px) {
        .badge-legend {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .badge-legend .filter-badge {
            flex: none;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300">
    <!-- En-t√™te de la page -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-plus-circle mr-3" style="color: #f7d9c4;"></i>
                Nouvelle Commande
            </h1>
            <p style="color: #f7d9c4;">Enregistrez une nouvelle commande dans le syst√®me</p>
        </div>
        <a href="{% url 'operatConfirme:liste_commandes' %}" class="mt-4 md:mt-0 inline-flex items-center text-white px-4 py-2 rounded-lg font-medium transition-all shadow-md hover:shadow-lg" style="background-color: #f7d9c4; color: #4B352A; hover:background-color: #ede0d3;">
            <i class="fas fa-arrow-left mr-2"></i>Retour √† la liste
        </a>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert mb-6 p-4 rounded-xl border-l-4 animate-slideInUp
                    {% if message.tags == 'success' %}border-green-500 bg-green-50 text-green-700{% endif %}
                    {% if message.tags == 'error' %}border-red-500 bg-red-50 text-red-700{% endif %}
                    {% if message.tags == 'warning' %}border-yellow-500 bg-yellow-50 text-yellow-700{% endif %}">
            <i class="{% if message.tags == 'success' %}fas fa-check-circle{% elif message.tags == 'error' %}fas fa-exclamation-circle{% else %}fas fa-info-circle{% endif %} mr-2"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <div class="form-card shadow-lg p-6 md:p-8 mb-8 animate-slideInUp">
        <form method="post" id="commandeForm">
            {% csrf_token %}
            
            <!-- Section Information Commande -->
            <div class="form-section">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-info-circle mr-2" style="color: #6d4b3b;"></i>
                    Informations de la commande
                </h3>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-3"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800">G√©n√©ration automatique</h4>
                            <p class="text-blue-700 text-sm">L'ID YZ et la date de commande seront g√©n√©r√©s automatiquement par le syst√®me</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Client -->
            <div class="bg-white rounded-xl p-6 mb-6 shadow-lg">
                <h3 class="text-lg font-semibold mb-4" style="color: #4B352A;">
                    <i class="fas fa-user mr-2"></i>
                    Informations Client
                </h3>
                
                <!-- S√©lection du type de client -->
                <div class="mb-4">
                    <label class="label-style">Type de client</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="type_client" value="existant" checked class="form-radio text-brown-600">
                            <span class="ml-2">Client existant</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="type_client" value="nouveau" class="form-radio text-brown-600">
                            <span class="ml-2">Nouveau client</span>
                        </label>
                    </div>
                </div>

                <!-- Recherche rapide par num√©ro de t√©l√©phone -->
                <div class="mb-3">
                    <label for="search_phone" class="label-style">Rechercher par num√©ro de t√©l√©phone</label>
                    <input type="tel" id="search_phone" class="input-field w-full" placeholder="Saisir un num√©ro de t√©l√©phone...">
                    <div id="search_phone_results" class="bg-white border border-gray-200 rounded-lg mt-1 shadow-lg z-50 absolute w-full hidden"></div>
                </div>

                <!-- Section pour s√©lectionner un client existant -->
                <div id="section-client-existant">
                    <label for="client" class="label-style">S√©lectionner un client</label>
                    <select id="client" name="client" class="input-field w-full">
                        <option value="" disabled selected>-- Rechercher et choisir un client --</option>
                        {% for c in clients %}
                        <option value="{{ c.pk }}">{{ c.get_full_name }} ({{ c.numero_tel }})</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Section pour cr√©er un nouveau client -->
                <div id="section-nouveau-client" style="display: none;">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="nouveau_prenom" class="label-style">Pr√©nom</label>
                            <input type="text" id="nouveau_prenom" name="nouveau_prenom" class="input-field w-full">
                        </div>
                        <div>
                            <label for="nouveau_nom" class="label-style">Nom</label>
                            <input type="text" id="nouveau_nom" name="nouveau_nom" class="input-field w-full">
                        </div>
                        <div>
                            <label for="nouveau_telephone" class="label-style">T√©l√©phone</label>
                            <input type="tel" id="nouveau_telephone" name="nouveau_telephone" class="input-field w-full">
                        </div>
                        <div>
                            <label for="nouveau_email" class="label-style">Email (Optionnel)</label>
                            <input type="email" id="nouveau_email" name="nouveau_email" class="input-field w-full">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section Livraison -->
            <div class="form-section">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-truck mr-2" style="color: #6d4b3b;"></i>
                    Livraison
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="ville_livraison" class="label-style">Ville de livraison:</label>
                        <select id="ville_livraison" name="ville_livraison" class="input-field w-full" required>
                            <option value="" disabled selected>-- Choisir une ville --</option>
                            {% for ville in villes %}
                            <option value="{{ ville.pk }}" data-frais="{{ ville.frais_livraison|default_if_none:0 }}" data-region="{{ ville.region.nom_region|default:'' }}">{{ ville.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="frais_livraison" class="label-style">Frais de livraison (DH):</label>
                        <input type="text" id="frais_livraison" class="input-field w-full bg-gray-100" readonly>
                    </div>
                    <div>
                        <label for="region_livraison" class="label-style">R√©gion:</label>
                        <input type="text" id="region_livraison" class="input-field w-full bg-gray-100" readonly>
                    </div>
                     <div>
                        <label for="adresse" class="label-style">Adresse compl√®te:</label>
                        <input type="text" id="adresse" name="adresse" class="input-field w-full" placeholder="Entrez l'adresse compl√®te..." required>
                    </div>
                </div>
            </div>

            <!-- Section Articles -->
            <div class="form-section">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-box mr-2" style="color: #6d4b3b;"></i>
                    S√©lection des articles
                </h3>
                
                <!-- Recherche rapide par r√©f√©rence d'article -->
                <div class="mb-3 relative">
                    <label for="search_article_ref" class="label-style">Rechercher d'article</label>
                    <input id="recherche-article-input" type="text" placeholder="Nom, r√©f√©rence, couleur, pointure..." 
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                   oninput="rechercherArticles(this.value)" />
                    <div id="search_article_results" class="bg-white border border-gray-200 rounded-lg mt-1 shadow-lg z-50 absolute w-full hidden"></div>
                </div>

                <!-- L√©gende des badges -->
                <div class="mb-3 p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border border-gray-200 shadow-sm">
                    <div class="flex items-center justify-between mb-3">
                        <div class="text-sm font-semibold text-gray-700 flex items-center">
                            <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                            Types d'articles :
                        </div>
                    </div>
                    <div class="badge-legend flex justify-between gap-3 text-sm">
                        <span id="filter-all" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-gray-100 text-gray-700 rounded-full font-medium cursor-pointer filter-badge active whitespace-nowrap hover:bg-gray-200 transition-colors" 
                              onclick="filtrerArticles('all')" title="Afficher tous les articles">
                            üîç TOUS
                        </span>
                        <span id="filter-promo" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-red-100 text-red-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-red-200 transition-colors" 
                              onclick="filtrerArticles('promo')" title="Filtrer les articles en promotion">
                            üî• PROMO
                        </span>
                        <span id="filter-liquidation" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-orange-100 text-orange-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-orange-200 transition-colors" 
                              onclick="filtrerArticles('liquidation')" title="Filtrer les articles en liquidation">
                            üè∑Ô∏è LIQUIDATION
                        </span>
                        <span id="filter-test" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-blue-200 transition-colors" 
                              onclick="filtrerArticles('test')" title="Filtrer les articles en test">
                            üß™ TEST
                        </span>
                        <span id="filter-upsell" class="flex-1 inline-flex items-center justify-center px-4 py-2 bg-green-100 text-green-700 rounded-full font-medium cursor-pointer filter-badge whitespace-nowrap hover:bg-green-200 transition-colors" 
                              onclick="filtrerArticles('upsell')" title="Filtrer les articles upsell">
                            ‚¨ÜÔ∏è UPSELL
                        </span>
                    </div>
                </div>

                <!-- Select d'origine conserv√© (masqu√©) pour compatibilit√© -->
                <select id="article-select" class="input-field flex-grow hidden">
                    <option value="">S√©lectionner un article‚Ä¶</option>
                    {% for article in articles %}
                        <option value="{{ article.pk }}" data-prix="{{ article.prix_actuel }}">{{ article.nom }} ({{ article.reference }}) ‚Äì {{ article.prix_actuel }} DH</option>
                    {% endfor %}
                </select>

                <!-- Section des articles avec navigation fixe -->
                <div class="mt-4 border border-gray-200 rounded-lg overflow-hidden">
                    <!-- En-t√™te fixe du tableau -->
                    <div class="bg-gray-50 border-b border-gray-200">
                        <table class="min-w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Article</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Prix</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Stock</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    
                    <!-- Zone de scroll avec barre de navigation personnalis√©e -->
                    <div class="relative">
                        <!-- Conteneur principal avec scroll -->
                        <div id="articlesScrollContainer" class="max-h-96 overflow-y-auto">
                            <table class="min-w-full">
                                <tbody id="articlesTableBody" class="bg-white divide-y divide-gray-100">
                                    <!-- Lignes d'articles rendues dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Barre de navigation personnalis√©e -->
                        <div id="customScrollbar" class="absolute right-0 top-0 bottom-0 w-3 bg-gray-100 rounded-r-lg">
                            <div id="scrollThumb" class="w-3 bg-gray-400 rounded-full cursor-pointer hover:bg-gray-500 transition-colors" style="height: 50px; top: 0; position: absolute;"></div>
                        </div>
                    </div>
                    
                    <!-- Indicateur de navigation -->
                    <div class="bg-gray-50 border-t border-gray-200 px-4 py-2 flex items-center justify-between text-xs text-gray-500">
                        <span id="scrollInfo">Articles disponibles</span>
                        <div class="flex items-center space-x-2">
                            <button id="scrollUp" class="p-1 hover:bg-gray-200 rounded" title="Monter">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button id="scrollDown" class="p-1 hover:bg-gray-200 rounded" title="Descendre">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panier dynamique -->
            <div id="panier-items-container" class="mb-6 hidden">
                <div class="panier-section">
                    <h3 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fas fa-shopping-basket mr-2"></i>
                        Panier de la commande
                    </h3>
                    <div id="panierItems" class="space-y-3 text-ellipsis">
                        <!-- Les articles seront ajout√©s ici dynamiquement -->
                    </div>
                    <div class="border-t border-white/20 mt-4 pt-4">
                        <div class="flex justify-between items-center text-lg font-semibold">
                            <span>Total Panier:</span>
                            <span id="totalPanier">0.00 DH</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total et options -->
            <div class="form-section">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-calculator mr-2" style="color: #6d4b3b;"></i>
                    Total et options
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
             
                    <div>
                        <label for="total_cmd" class="label-style">Total Commande (DH):</label>
                        <input type="number" name="total_cmd" id="total_cmd" step="0.01" min="0" class="input-field w-full bg-gray-100 cursor-not-allowed" readonly required>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-confirm">
                <i class="fas fa-save mr-2"></i> Cr√©er la commande
            </button>
        </form>
    </div>
</div>

<!-- Modal de s√©lection des variantes -->
<div id="modalVariantes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">

    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
            <!-- En-t√™te du modal -->
            <div class="bg-gradient-to-r from-[#000000] to-[#080808] text-white p-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-palette mr-2"></i>
                        Choisir une variante
                    </h3>
                    <button type="button" id="fermerModalVariantes" class="text-white hover:text-red-300 transition-all p-3 rounded-full hover:bg-red-500/20 border-2 border-white/20 hover:border-red-300 hover:scale-110">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="infoArticle" class="mt-2 text-sm opacity-90">
                    <!-- Informations de l'article s√©lectionn√© -->
                </div>
            </div>

            <!-- Contenu du modal -->
            <div class="p-6 overflow-y-scroll max-h-[60vh] min-h-[400px]">
                <!-- Message de chargement -->
                <div id="loadingVariantes" class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-3xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Chargement des variantes...</p>
                </div>

                <!-- Message d'erreur -->
                <div id="errorVariantes" class="hidden text-center py-8">
                    <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-4"></i>
                    <p class="text-red-600">Erreur lors du chargement des variantes</p>
                </div>

                <!-- Grille des variantes moderne -->
                <div id="tableauVariantes" class="hidden">
                    <!-- Filtre rapide des couleurs -->
                    <div id="filtresCouleurs" class="mb-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <i class="fas fa-filter mr-2"></i>
                            Filtrer par couleur
                        </h4>
                        <div id="boutonsCouleurs" class="flex flex-wrap gap-2">
                            <button class="filtre-couleur active px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border-2 border-blue-200" 
                                    data-couleur="all">
                                Toutes
                            </button>
                        </div>
                    </div>

                    <!-- Grille des variantes -->
                    <div id="grilleVariantes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Les cartes de variantes seront ajout√©es ici dynamiquement -->
                    </div>
                    
                    <!-- R√©sum√© s√©lection -->
                    <div id="resumeSelection" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center text-blue-800">
                                <i class="fas fa-shopping-cart mr-2"></i>
                                <span id="texteResume" class="font-medium">0 variante(s) s√©lectionn√©e(s)</span>
                            </div>
                            <button id="ajouterToutesSelection" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors hidden">
                                <i class="fas fa-plus mr-2"></i>
                                Ajouter toutes au panier
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Message si aucune variante -->
                <div id="aucuneVariante" class="hidden text-center py-8">
                    <i class="fas fa-info-circle text-3xl text-blue-500 mb-4"></i>
                    <p class="text-gray-600">Aucune variante disponible pour cet article</p>
                </div>
            </div>

            <!-- Pied du modal -->
            <div class="bg-gray-50 p-4 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    S√©lectionnez une variante pour l'ajouter au panier
                </div>
                <div class="flex space-x-3">
                    <button type="button" id="annulerVariantes" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors">
                        <i class="fas fa-times mr-1"></i>
                        Fermer 
                    </button>
            
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{{ block.super }} {# Garde le script de la sidebar du template de base #}

<script>
    // Le script pour la page de cr√©ation de commande commence ici
    // On n'utilise PAS 'DOMContentLoaded' ici car le bloc est d√©j√† √† la fin du body
    
    console.log("Initialisation du script sp√©cifique √† la cr√©ation de commande...");

    // ---- ELEMENTS DU DOM ----
    const clientTypeToggle = document.getElementById('client-type-toggle');
    const btnClientExistant = document.getElementById('btn-client-existant');
    const btnNouveauClient = document.getElementById('btn-nouveau-client');
    const sectionClientExistant = document.getElementById('section-client-existant');
    const sectionNouveauClient = document.getElementById('section-nouveau-client');
    const typeClientHidden = document.getElementById('type_client_hidden');

    const selectClient = document.getElementById('client');
    const nouveauPrenom = document.getElementById('nouveau_prenom');
    const nouveauNom = document.getElementById('nouveau_nom');
    const nouveauTelephone = document.getElementById('nouveau_telephone');

    const selectVille = document.getElementById('ville_livraison');
    const fraisLivraisonInput = document.getElementById('frais_livraison');
    const regionLivraisonInput = document.getElementById('region_livraison');
    const fraisLivraisonDisplay = document.getElementById('frais-livraison-display');

    // ---- DIAGNOSTIC ----
    console.log({
        clientTypeToggle,
        btnClientExistant,
        btnNouveauClient,
        sectionClientExistant,
        sectionNouveauClient,
        typeClientHidden,
        selectVille,
        fraisLivraisonInput,
        regionLivraisonInput,
        fraisLivraisonDisplay
    });

    // 1. Syst√®me de basculement Client
    function setupClientToggle() {
        if (!clientTypeToggle || !btnClientExistant || !btnNouveauClient) {
            console.error("Erreur critique: Un des boutons de basculement est manquant. Le script ne peut continuer.");
            return;
        }

        function setClientMode(isExistant) {
            console.log(`Basculement vers le mode: ${isExistant ? 'Existant' : 'Nouveau'}`);
            
            // Affichage des sections
            sectionClientExistant.style.display = isExistant ? 'block' : 'none';
            sectionNouveauClient.style.display = isExistant ? 'none' : 'block';

            // Style des boutons
            btnClientExistant.classList.toggle('active', isExistant);
            btnNouveauClient.classList.toggle('active', !isExistant);
            clientTypeToggle.classList.toggle('active', !isExistant);
            
            // Mise √† jour du champ cach√©
            if (typeClientHidden) {
                typeClientHidden.value = isExistant ? 'existant' : 'nouveau';
            }

            // Gestion des champs requis
            if (selectClient) selectClient.required = isExistant;
            if (nouveauPrenom) nouveauPrenom.required = !isExistant;
            if (nouveauNom) nouveauNom.required = !isExistant;
            if (nouveauTelephone) nouveauTelephone.required = !isExistant;
        }

        btnClientExistant.addEventListener('click', () => setClientMode(true));
        btnNouveauClient.addEventListener('click', () => setClientMode(false));
        clientTypeToggle.addEventListener('click', () => {
            const currentModeIsExistant = !clientTypeToggle.classList.contains('active');
            setClientMode(!currentModeIsExistant);
        });

        // Initialisation
        setClientMode(true);
    }

    // 2. Gestion de la s√©lection de ville
    function setupVilleSelection() {
        if (!selectVille) {
            console.error("L'√©l√©ment de s√©lection de ville est manquant.");
            return;
        }

        selectVille.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const frais = selectedOption.dataset.frais || '0';
            const region = selectedOption.dataset.region || 'N/A';

            if (fraisLivraisonInput) fraisLivraisonInput.value = parseFloat(frais).toFixed(2);
            if (regionLivraisonInput) regionLivraisonInput.value = region;
            
            // Mettre √† jour √©galement l'affichage dans le r√©sum√©
            if (fraisLivraisonDisplay) fraisLivraisonDisplay.textContent = `${parseFloat(frais).toFixed(2)} DH`;

            // Recalculer le total g√©n√©ral de la commande
            calculerTotal();
        });
    }

    function calculerTotal() {
        let totalPanier = 0;
        panierItemsContainer.querySelectorAll('.panier-item').forEach(row => {
            const quantite = parseInt(row.querySelector('.quantite-input').value) || 0;
            const prix = parseFloat(row.querySelector('.quantite-input').dataset.price) || 0;
            totalPanier += quantite * prix;
        });
        
        // On r√©cup√®re les frais depuis l'input qui est toujours √† jour
        const fraisLivraison = parseFloat(fraisLivraisonInput.value) || 0;
        const totalCommande = totalPanier ;

        if(totalPanierElement) totalPanierElement.textContent = `${totalPanier.toFixed(2)} DH`;
        if(fraisLivraisonDisplay) fraisLivraisonDisplay.textContent = `${fraisLivraison.toFixed(2)} DH`;
        if(totalCmdInput) totalCmdInput.value = totalCommande.toFixed(2);
    }

    // Gestion du panier
    const articleSelect = document.getElementById('article-select');
    const panierItemsContainer = document.getElementById('panier-items-container');
    const panierItems = document.getElementById('panierItems');
    const totalPanierElement = document.getElementById('totalPanier');
    const totalCmdInput = document.getElementById('total_cmd');

    // Fonction pour charger les articles (appel√©e √† l'initialisation)
    function chargerArticles() {
        if (!articleSelect) {
            console.error("L'√©l√©ment de s√©lection d'article est manquant.");
            return;
        }

        // Ajouter un √©v√©nement pour ajouter un article au panier
        articleSelect.addEventListener('change', function() {
            if (this.value) {
                const selectedOption = this.options[this.selectedIndex];
                const articleId = this.value;
                const articleNom = selectedOption.text.split(' (')[0];
                const articleRef = selectedOption.text.match(/\(([^)]+)\)/)[1];
                const articlePrix = parseFloat(selectedOption.dataset.prix);
                
                ajouterArticleAuPanier(articleId, articleNom, articleRef, articlePrix);
                
                // R√©initialiser la s√©lection
                this.selectedIndex = 0;
            }
        });
    }

    // Fonction pour ajouter un article au panier
    function ajouterArticleAuPanier(id, nom, reference, prix) {
        // Afficher le conteneur du panier s'il √©tait cach√©
        panierItemsContainer.classList.remove('hidden');
        
        // Cr√©er un √©l√©ment pour l'article
        const articleElement = document.createElement('div');
        articleElement.className = 'panier-item';
        articleElement.dataset.articleId = id;
        
        // G√©n√©rer un ID unique pour cet article dans le panier
        const uniqueId = `article_${Date.now()}`;
        
        articleElement.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex-1">
                    <div class="font-semibold text-gray-800">${nom}</div>
                    <div class="text-xs text-gray-600">R√©f: ${reference}</div>
                </div>
                <div class="flex items-center gap-2">
                    <input type="number" min="1" value="1" class="quantite-input w-16 p-1 text-center rounded bg-white/90 text-gray-800" 
                           data-price="${prix}" data-article-id="${id}">
                    <div class="text-sm font-semibold whitespace-nowrap text-gray-800">${prix.toFixed(2)} DH</div>
                    <button type="button" class="btn-action btn-danger remove-article">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            <input type="hidden" name="article_id" value="${id}">
            <input type="hidden" name="quantite" value="1">
        `;
        
        // Ajouter l'√©l√©ment au panier
        panierItems.appendChild(articleElement);
        
        // Ajouter les √©couteurs d'√©v√©nements pour la quantit√© et la suppression
        const quantiteInput = articleElement.querySelector('.quantite-input');
        quantiteInput.addEventListener('change', function() {
            // Mettre √† jour la valeur dans le champ cach√©
            const hiddenInput = articleElement.querySelector('input[name="quantite"]');
            hiddenInput.value = this.value;
            calculerTotal();
        });
        
        const removeButton = articleElement.querySelector('.remove-article');
        removeButton.addEventListener('click', function() {
            articleElement.remove();
            calculerTotal();
            
            // Cacher le conteneur si le panier est vide
            if (panierItems.children.length === 0) {
                panierItemsContainer.classList.add('hidden');
            }
        });
        
        // Calculer le total
        calculerTotal();
    }

    // Gestion de l'affichage des sections selon le type de client
    document.querySelectorAll('input[name="type_client"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const clientExistantSection = document.getElementById('section-client-existant');
            const nouveauClientSection = document.getElementById('section-nouveau-client');
            
            if (this.value === 'existant') {
                clientExistantSection.style.display = 'block';
                nouveauClientSection.style.display = 'none';
                // R√©initialiser les champs du nouveau client
                document.getElementById('nouveau_prenom').value = '';
                document.getElementById('nouveau_nom').value = '';
                document.getElementById('nouveau_telephone').value = '';
                document.getElementById('nouveau_email').value = '';
            } else {
                clientExistantSection.style.display = 'none';
                nouveauClientSection.style.display = 'block';
                // R√©initialiser la s√©lection du client existant
                document.getElementById('client').selectedIndex = 0;
            }
        });
    });

    // Initialisation au chargement de la page
    window.addEventListener('load', function() {
        const typeClientRadios = document.querySelectorAll('input[name="type_client"]');
        const checkedRadio = Array.from(typeClientRadios).find(radio => radio.checked);
        if (checkedRadio) {
            checkedRadio.dispatchEvent(new Event('change'));
        }
    });

    // ---- INITIALISATION ----
    setupClientToggle();
    setupVilleSelection();
    chargerArticles();
</script>

<script>
// --- S√âCURISATION DES VARIABLES ET √âVITEMENT DES DOUBLONS ---
(function() {
    // Recherche client par num√©ro de t√©l√©phone
    var searchPhoneInput = document.getElementById('search_phone');
    var searchPhoneResults = document.getElementById('search_phone_results');
    var clientSelect = document.getElementById('client');
    var searchTimeout = null;

    if (searchPhoneInput && searchPhoneResults && clientSelect) {
        searchPhoneInput.addEventListener('input', function() {
            var query = this.value.trim();
            if (searchTimeout) clearTimeout(searchTimeout);
            if (query.length < 3) {
                searchPhoneResults.classList.add('hidden');
                searchPhoneResults.innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(function() {
                fetch('/operateur-confirme/api/recherche-client-tel/?q=' + encodeURIComponent(query))
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        if (data.results && data.results.length > 0) {
                            searchPhoneResults.innerHTML = data.results.map(function(client) {
                                return '<div class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100" data-client-id="' + client.id + '"><span class="font-semibold">' + client.full_name + '</span> <span class="text-gray-500">(' + client.numero_tel + ')</span></div>';
                            }).join('');
                            searchPhoneResults.classList.remove('hidden');
                            Array.prototype.forEach.call(searchPhoneResults.children, function(item) {
                                item.addEventListener('click', function() {
                                    var clientId = this.getAttribute('data-client-id');
                                    clientSelect.value = clientId;
                                    clientSelect.dispatchEvent(new Event('change'));
                                    searchPhoneResults.classList.add('hidden');
                                    searchPhoneResults.innerHTML = '';
                                    searchPhoneInput.value = '';
                                });
                            });
                        } else {
                            searchPhoneResults.innerHTML = '<div class="px-4 py-2 text-gray-500">Aucun client trouv√©</div>';
                            searchPhoneResults.classList.remove('hidden');
                        }
                    })
                    .catch(function() {
                        searchPhoneResults.innerHTML = '<div class="px-4 py-2 text-red-500">Erreur de recherche</div>';
                        searchPhoneResults.classList.remove('hidden');
                    });
            }, 300);
        });
        document.addEventListener('click', function(e) {
            if (!searchPhoneResults.contains(e.target) && e.target !== searchPhoneInput) {
                searchPhoneResults.classList.add('hidden');
            }
        });
    }
})();
</script>



<script>
// ================== SYST√àME DE FILTRAGE ET AFFICHAGE DES ARTICLES ==================

// Variables globales
let articlesDisponibles = [];
let filtreActuel = 'all';

// Fonction pour charger les articles disponibles
function chargerArticlesDisponibles() {
    console.log('üì¶ Chargement des articles disponibles depuis l\'API...');
    
    const select = document.getElementById('article-select');
    const tableBody = document.getElementById('articlesTableBody');
    
    if (!select || !tableBody) {
        console.error('‚ùå √âl√©ments de s√©lection d\'articles introuvables');
        return;
    }
    
    // R√©cup√©rer le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('‚ùå Token CSRF manquant');
        return;
    }
    
    // Appel √† l'API pour r√©cup√©rer les articles
    fetch('{% url "operatConfirme:api_articles_disponibles" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        console.log('üì° Statut de la r√©ponse:', response.status, response.statusText);
        
        if (!response.ok) {
            return response.text().then(text => {
                console.error('‚ùå R√©ponse d\'erreur:', text);
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es re√ßues:', data);
        
        // Gestion des deux formats possibles (tableau direct ou objet avec propri√©t√© articles)
        if (Array.isArray(data)) {
            articlesDisponibles = data;
            console.log(`üì¶ ${articlesDisponibles.length} article(s) trouv√©(s) (format tableau)`);
        } else if (data.success && data.articles) {
            articlesDisponibles = data.articles;
            console.log(`üì¶ ${articlesDisponibles.length} article(s) trouv√©(s) (format objet)`);
        } else {
            console.warn('‚ö†Ô∏è Format de donn√©es inattendu:', data);
            articlesDisponibles = [];
        }
        
        // Mettre √† jour le select pour compatibilit√©
        select.innerHTML = '<option value="">-- S√©lectionner un article --</option>';
        
        if (articlesDisponibles.length === 0) {
            select.innerHTML = '<option value="">-- Aucun article disponible --</option>';
            tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Aucun article disponible</td></tr>`;
            console.warn('‚ö†Ô∏è Aucun article trouv√© dans la base de donn√©es');
            showNotification('‚ö†Ô∏è Aucun article disponible', 'error');
            return;
        }
        
        // Ajouter les options au select pour compatibilit√©
        articlesDisponibles.forEach((article, index) => {
            try {
                const option = document.createElement('option');
                option.value = article.id;
                
                // Construire le texte de l'option
                let optionText = article.nom || 'Article sans nom';
                
                // Ajouter les badges de statut
                const badges = [];
                if (article.has_promo_active) badges.push('üî•PROMO');
                if (article.phase === 'LIQUIDATION') badges.push('üè∑Ô∏èLIQUIDATION');
                if (article.phase === 'EN_TEST') badges.push('üß™TEST');
                if (article.isUpsell) badges.push('‚¨ÜÔ∏èUPSELL');
                
                if (badges.length > 0) {
                    optionText += ` [${badges.join(' ')}]`;
                }
                
                if (article.prix_actuel) {
                    optionText += ` - ${article.prix_actuel} DH`;
                }
                
                // Ajouter d√©tails
                const details = [];
                if (article.pointure && article.pointure.trim()) {
                    details.push(`T:${article.pointure}`);
                }
                if (article.couleur && article.couleur.trim()) {
                    details.push(`C:${article.couleur}`);
                }
                
                if (details.length > 0) {
                    optionText += ` (${details.join(', ')})`;
                }
                
                option.textContent = optionText;
                option.dataset.article = JSON.stringify(article);
                option.dataset.prix = article.prix_actuel;
                
                select.appendChild(option);
                
            } catch (error) {
                console.error(`‚ùå Erreur lors de l'ajout de l'article ${index + 1}:`, error);
            }
        });
        
        console.log(`‚úÖ ${articlesDisponibles.length} articles charg√©s avec succ√®s`);
        
        // Debug des premiers articles pour v√©rifier les donn√©es
        if (articlesDisponibles.length > 0) {
            console.log('üîç DEBUG: Premier article charg√©:', articlesDisponibles[0]);
            console.log('üîç DEBUG: Champs disponibles:', Object.keys(articlesDisponibles[0]));
        }
        
        // Sauvegarder dans la variable globale
        window.articlesDisponibles = articlesDisponibles;
        
        // Initialiser l'affichage avec tous les articles
        filtrerArticles('all');
        
        showNotification(`‚úÖ ${articlesDisponibles.length} article(s) charg√©(s)`, 'success');
        
    })
    .catch(error => {
        console.error('‚ùå Erreur lors du chargement des articles:', error);
        showNotification('‚ùå Erreur lors du chargement des articles', 'error');
        
        // Fallback : utiliser les donn√©es du template Django
        console.log('üîÑ Fallback vers les donn√©es du template Django...');
        chargerArticlesDepuisTemplate();
    });
}

// Fonction de fallback pour charger les articles depuis le template Django
function chargerArticlesDepuisTemplate() {
    console.log('üì¶ Chargement des articles depuis le template Django (fallback)...');
    
    const select = document.getElementById('article-select');
    const tableBody = document.getElementById('articlesTableBody');
    
    if (!select || !tableBody) {
        console.error('‚ùå √âl√©ments de s√©lection d\'articles introuvables');
        return;
    }
    
    // R√©cup√©rer les articles depuis le template Django
    const options = select.querySelectorAll('option');
    articlesDisponibles = [];
    
    options.forEach((option, index) => {
        if (option.value && index > 0) { // Ignorer l'option par d√©faut
            const articleData = {
                id: option.value,
                nom: option.textContent.split(' (')[0],
                reference: option.textContent.match(/\(([^)]+)\)/)?.[1] || '',
                prix_actuel: parseFloat(option.dataset.prix) || 0,
                // Donn√©es par d√©faut pour les nouveaux champs
                has_promo_active: false,
                phase: 'NORMAL',
                isUpsell: false,
                qte_disponible: 10, // Valeur par d√©faut
                pointure: '',
                couleur: '',
                categorie: '',
                image_url: ''
            };
            articlesDisponibles.push(articleData);
        }
    });
    
    console.log(`‚úÖ ${articlesDisponibles.length} articles charg√©s depuis le template`);
    
    // Initialiser l'affichage
    filtrerArticles('all');
}

// Fonction principale de filtrage des articles
function filtrerArticles(typeFiltre) {
    console.log(`üîç Filtrage des articles par type: ${typeFiltre}`);
    
    filtreActuel = typeFiltre;
    
    // Mettre √† jour l'√©tat visuel des badges
    mettreAJourBadgesActifs(typeFiltre);
    
    // Appliquer le filtre sur le tableau
    appliquerFiltreTableau(typeFiltre);
    
    // Afficher une notification
    const compteur = compterArticlesParType(typeFiltre);
    const message = typeFiltre === 'all' ? 
        `üîç Affichage de tous les articles (${compteur} total)` :
        `üîç Filtrage par ${typeFiltre.toUpperCase()}: ${compteur} article(s) trouv√©(s)`;
    
    showNotification(message, 'info', 2000);
}

// Fonction pour mettre √† jour l'√©tat visuel des badges
function mettreAJourBadgesActifs(typeActif) {
    // Retirer la classe active de tous les badges
    document.querySelectorAll('.filter-badge').forEach(badge => {
        badge.classList.remove('active');
    });
    
    // Ajouter la classe active au badge s√©lectionn√©
    const badgeActif = document.getElementById(`filter-${typeActif}`);
    if (badgeActif) {
        badgeActif.classList.add('active');
    }
}

// Fonction pour appliquer le filtre sur le tableau
function appliquerFiltreTableau(typeFiltre) {
    const tableBody = document.getElementById('articlesTableBody');
    if (!tableBody) {
        console.warn('‚ö†Ô∏è Tableau des articles introuvable');
        return;
    }
    
    // Vider le tableau
    tableBody.innerHTML = '';
    
    if (!articlesDisponibles || articlesDisponibles.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">Aucun article disponible</td></tr>`;
        return;
    }
    
    let articlesAffiches = 0;
    
    articlesDisponibles.forEach((article, index) => {
        // V√©rifier si l'article correspond au filtre
        if (typeFiltre === 'all' || correspondAuFiltre(article, typeFiltre)) {
            try {
                // Ligne du tableau
                const tr = document.createElement('tr');
                tr.dataset.article = JSON.stringify(article);

                // D√©terminer classes de fond/texte selon type
                let rowBg = '';
                let badgeHtml = '';
                if (article.has_promo_active) {
                    rowBg = 'bg-red-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-fire mr-1"></i>PROMO</span>';
                }
                if (article.phase === 'LIQUIDATION') {
                    rowBg = 'bg-orange-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-orange-100 text-orange-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-tags mr-1"></i>LIQUIDATION</span>';
                }
                if (article.phase === 'EN_TEST') {
                    rowBg = 'bg-blue-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-flask mr-1"></i>TEST</span>';
                }
                if (article.isUpsell) {
                    rowBg = 'bg-green-50';
                    badgeHtml += '<span class="inline-flex items-center px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-semibold mr-2"><i class="fas fa-arrow-up mr-1"></i>UPSELL</span>';
                }
                tr.className = rowBg;

                const prixActuel = (typeof article.prix_actuel === 'number' ? article.prix_actuel : (article.prix_unitaire || 0));
                const stock = (typeof article.qte_disponible === 'number' ? article.qte_disponible : (parseInt(article.qte_disponible || '0') || 0));

                tr.innerHTML = `
                    <td class="px-4 py-3">
                        <div class="flex items-start space-x-4">
                            <!-- Image de l'article -->
                            <div class="flex-shrink-0">
                                <div class="w-16 h-16 rounded-lg overflow-hidden bg-gray-100 border-2 border-gray-200 shadow-sm hover:shadow-md transition-shadow">
                                    ${article.image_url ? 
                                        `<img src="${article.image_url}" alt="Image de ${article.nom}" class="w-full h-full object-cover hover:scale-105 transition-transform duration-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` : 
                                        ''
                                    }
                                    <div class="w-full h-full flex items-center justify-center text-gray-400 ${article.image_url ? 'hidden' : ''}">
                                        <i class="fas fa-image text-xl"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Informations de l'article -->
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900">${article.nom || ''}</div>
                                <div class="text-xs text-gray-500">R√©f: ${article.reference || '-'}</div>
                                <div class="mt-1">${badgeHtml}</div>
                                <div class="mt-1 flex flex-wrap gap-2 text-xs">
                                    ${typeof article.categorie === 'string' ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded-full"><i class="fas fa-tag mr-1"></i>${article.categorie}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center font-semibold text-green-600">${prixActuel} DH</td>
                    <td class="px-4 py-3 text-center">
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${stock <= 0 ? 'bg-red-100 text-red-700' : (stock < 5 ? 'bg-orange-100 text-orange-700' : 'bg-teal-100 text-teal-700')}">
                            ${stock <= 0 ? '√âpuis√©' : stock + ' unit√©s'}
                        </span>
                    </td>

                    <td class="px-4 py-3 text-center">
                        <button type="button" class="px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-lg" onclick="ajouterDepuisLigne(this)">
                            <i class="fas fa-plus mr-1"></i>Ajouter
                        </button>
                    </td>`;
                tableBody.appendChild(tr);
                articlesAffiches++;
                
            } catch (error) {
                console.error(`‚ùå Erreur lors de l'ajout de l'article filtr√© ${index + 1}:`, error);
            }
        }
    });
    
    console.log(`üìä Filtrage termin√©: ${articlesAffiches} article(s) affich√©(s) sur ${articlesDisponibles.length} total`);
}

// Fonction pour v√©rifier si un article correspond au filtre
function correspondAuFiltre(article, typeFiltre) {
    switch (typeFiltre) {
        case 'promo':
            return article.has_promo_active === true;
        case 'liquidation':
            return article.phase === 'LIQUIDATION';
        case 'test':
            return article.phase === 'EN_TEST';
        case 'upsell':
            return article.isUpsell === true;
        default:
            return true;
    }
}

// Fonction pour compter les articles par type
function compterArticlesParType(typeFiltre) {
    if (!articlesDisponibles) return 0;
    
    if (typeFiltre === 'all') {
        return articlesDisponibles.length;
    }
    
    return articlesDisponibles.filter(article => correspondAuFiltre(article, typeFiltre)).length;
}



// Fonction pour ajouter un article depuis une ligne du tableau
function ajouterDepuisLigne(button) {
    const row = button.closest('tr');
    const articleData = JSON.parse(row.dataset.article || '{}');
    const quantite = 1; // Quantit√© par d√©faut puisque la colonne quantit√© a √©t√© supprim√©e
    
    console.log('‚ûï Ouverture modal variantes pour article:', {
        article: articleData.nom,
        quantite: quantite,
        prix: articleData.prix_actuel
    });
    
    // Ouvrir le modal de s√©lection des variantes
    ouvrirModalVariantes(articleData.id, articleData, quantite);
}

// Fonction pour ajouter un article au panier (compatible avec le syst√®me existant)
function ajouterAuPanier(articleId, quantite) {
    // R√©cup√©rer les informations de l'article depuis le select
    const articleSelect = document.getElementById('article-select');
    const selectedOption = articleSelect.querySelector(`option[value="${articleId}"]`);
    
    if (!selectedOption) {
        console.error('‚ùå Article non trouv√© dans le select:', articleId);
        return;
    }
    
    const articleNom = selectedOption.text.split(' (')[0];
    const articleRef = selectedOption.text.match(/\(([^)]+)\)/)?.[1] || '';
    const articlePrix = parseFloat(selectedOption.dataset.prix) || 0;
    
    // Utiliser la fonction existante pour ajouter au panier
    ajouterArticleAuPanier(articleId, articleNom, articleRef, articlePrix, quantite);
}

// Fonction modifi√©e pour ajouter un article au panier avec quantit√©
function ajouterArticleAuPanier(id, nom, reference, prix, quantiteInitiale = 1) {
    // Afficher le conteneur du panier s'il √©tait cach√©
    const panierItemsContainer = document.getElementById('panier-items-container');
    if (panierItemsContainer) {
        panierItemsContainer.classList.remove('hidden');
    }
    
    const panierItems = document.getElementById('panierItems');
    if (!panierItems) {
        console.error('‚ùå Conteneur du panier introuvable');
        return;
    }
    
    // V√©rifier si l'article est d√©j√† dans le panier
    const existingArticle = panierItems.querySelector(`[data-article-id="${id}"]`);
    if (existingArticle) {
        // Si l'article existe d√©j√†, augmenter la quantit√©
        const quantiteInput = existingArticle.querySelector('.quantite-input');
        if (quantiteInput) {
            const currentQte = parseInt(quantiteInput.value) || 1;
            quantiteInput.value = currentQte + quantiteInitiale;
            quantiteInput.dispatchEvent(new Event('change'));
        }
        return;
    }
    
    // Cr√©er un √©l√©ment pour l'article
    const articleElement = document.createElement('div');
    articleElement.className = 'panier-item';
    articleElement.dataset.articleId = id;
    
    // G√©n√©rer un ID unique pour cet article dans le panier
    const uniqueId = `article_${Date.now()}`;
    
    articleElement.innerHTML = `
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <div class="font-semibold">${nom}</div>
                <div class="text-xs text-gray-200">R√©f: ${reference}</div>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" min="1" value="${quantiteInitiale}" class="quantite-input w-16 p-1 text-center rounded bg-white/90 text-gray-800" 
                       data-price="${prix}" data-article-id="${id}">
                <div class="text-sm font-semibold whitespace-nowrap">${prix.toFixed(2)} DH</div>
                <button type="button" class="btn-action btn-danger remove-article">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <input type="hidden" name="article_id" value="${id}">
        <input type="hidden" name="quantite" value="${quantiteInitiale}">
    `;
    
    // Ajouter l'√©l√©ment au panier
    panierItems.appendChild(articleElement);
    
    // Ajouter les √©couteurs d'√©v√©nements pour la quantit√© et la suppression
    const quantiteInput = articleElement.querySelector('.quantite-input');
    quantiteInput.addEventListener('change', function() {
        // Mettre √† jour la valeur dans le champ cach√©
        const hiddenInput = articleElement.querySelector('input[name="quantite"]');
        hiddenInput.value = this.value;
        calculerTotal();
    });
    
    const removeButton = articleElement.querySelector('.remove-article');
    removeButton.addEventListener('click', function() {
        articleElement.remove();
        calculerTotal();
        
        // Cacher le conteneur si le panier est vide
        if (panierItems.children.length === 0 && panierItemsContainer) {
            panierItemsContainer.classList.add('hidden');
        }
    });
    
    // Calculer le total
    calculerTotal();
}

// Fonction pour afficher des notifications
function showNotification(message, type = 'info', duration = 3000) {
    try {
        const notification = document.createElement('div');
        
        // D√©terminer les couleurs selon le type
        let bgColor = 'bg-blue-500'; // info par d√©faut
        if (type === 'success') bgColor = 'bg-green-500';
        else if (type === 'error') bgColor = 'bg-red-500';
        else if (type === 'warning') bgColor = 'bg-yellow-500';
        
        notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm z-50 transition-all duration-300 ${bgColor} max-w-sm`;
        notification.style.whiteSpace = 'pre-line';
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Supprimer apr√®s la dur√©e d√©termin√©e
        setTimeout(() => {
            try {
                if (notification && notification.parentNode) {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        try {
                            if (notification && notification.parentNode) {
                                document.body.removeChild(notification);
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Erreur lors de la suppression de la notification:', error);
                        }
                    }, 300);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur lors de la modification de l\'opacit√© de la notification:', error);
            }
        }, duration);
    } catch (error) {
        console.error('‚ùå Erreur lors de la cr√©ation de la notification:', error);
        alert(message);
    }
}


function rechercherArticles(terme) {
    const value = (terme || '').toString().toLowerCase();
    const rows = document.querySelectorAll('#articlesTableBody tr');
    rows.forEach(row => {
        try {
            const article = JSON.parse(row.dataset.article || '{}');
            const cible = [article.nom, article.reference, article.couleur, article.pointure, article.categorie]
                .filter(Boolean)
                .join(' ')
                .toLowerCase();
            row.style.display = !value || cible.includes(value) ? '' : 'none';
        } catch (_) {}
    });
}

// ================== SYST√àME DE GESTION DES VARIANTES ==================

// Variables globales pour le modal des variantes
let articleSelectionne = null;
let quantiteInitiale = 1;

// Fonction pour ouvrir le modal de s√©lection des variantes
function ouvrirModalVariantes(articleId, articleData, quantite = 1) {
    console.log('üéØ Ouverture modal variantes:', { articleId, articleData, quantite });
    
    articleSelectionne = articleData;
    quantiteInitiale = quantite;
    
    // Afficher le modal
    const modal = document.getElementById('modalVariantes');
    const infoArticle = document.getElementById('infoArticle');
    
    if (!modal || !infoArticle) {
        console.error('‚ùå √âl√©ments du modal non trouv√©s');
        return;
    }
    
    // Mettre √† jour les informations de l'article
    infoArticle.innerHTML = `
        <div class="flex items-center space-x-4">
            <div>
                <div class="font-medium">${articleData.nom}</div>
                <div class="text-xs opacity-75">R√©f: ${articleData.reference || 'N/A'} - Prix: ${articleData.prix_actuel} DH</div>
            </div>
        </div>
    `;
    
    // Afficher le modal
    modal.classList.remove('hidden');
    
    // Charger les variantes
    chargerVariantesArticle(articleId);
}

// Fonction pour charger les variantes d'un article via AJAX
function chargerVariantesArticle(articleId) {
    console.log('üì° Chargement des variantes pour l\'article:', articleId);
    
    // Afficher le loading et masquer les autres √©l√©ments
    document.getElementById('loadingVariantes').classList.remove('hidden');
    document.getElementById('errorVariantes').classList.add('hidden');
    document.getElementById('tableauVariantes').classList.add('hidden');
    document.getElementById('aucuneVariante').classList.add('hidden');
    
    // R√©cup√©rer le token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('‚ùå Token CSRF manquant');
        afficherErreurVariantes('Token CSRF manquant');
        return;
    }
    
    // URL pour r√©cup√©rer les variantes (utilise l'URL existante)
    const url = `{% url 'operatConfirme:get_article_variants' 0 %}`.replace('0', articleId);
    
    // Appel AJAX
    fetch(url, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken.value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        credentials: 'same-origin',
    })
    .then(response => {
        console.log('üì° Statut de la r√©ponse variantes:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('üìä Variantes re√ßues:', data);
        
        if (data.success && data.variants) {
            afficherVariantes(data.variants);
        } else {
            throw new Error(data.error || 'Erreur inconnue');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur lors du chargement des variantes:', error);
        afficherErreurVariantes(error.message);
    });
}

// Fonction pour afficher les variantes dans la grille moderne
function afficherVariantes(variantes) {
    console.log('üìã Affichage de', variantes.length, 'variantes');
    
    // Masquer le loading
    document.getElementById('loadingVariantes').classList.add('hidden');
    
    if (variantes.length === 0) {
        document.getElementById('aucuneVariante').classList.remove('hidden');
        return;
    }
    
    // Afficher la grille
    document.getElementById('tableauVariantes').classList.remove('hidden');
    
    // G√©n√©rer les filtres de couleurs
    genererFiltresCouleurs(variantes);
    
    // Afficher les variantes en cartes
    const grille = document.getElementById('grilleVariantes');
    grille.innerHTML = '';
    
    variantes.forEach(variante => {
        const carte = document.createElement('div');
        carte.className = 'variante-card bg-white rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 overflow-hidden';
        carte.dataset.couleur = variante.couleur;
        
        // D√©terminer les styles selon le stock
        const stockInfo = getStockInfo(variante.stock);
        const couleurBadge = getCouleurBadge(variante.couleur);
        
        carte.innerHTML = `
            <div class="p-4">
                <!-- En-t√™te de la carte -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        ${couleurBadge}
                        <div>
                            <h5 class="font-semibold text-gray-900">${variante.couleur || 'Couleur standard'}</h5>
                            <p class="text-xs text-gray-500">Pointure ${variante.pointure || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-lg font-bold text-[#4B352A]">${variante.prix_actuel?.toFixed(2) || '0.00'} DH</div>
                        <div class="text-xs text-gray-500">Prix unitaire</div>
                    </div>
                </div>
                
                <!-- Badge de pointure -->
                <div class="mb-3">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                        <i class="fas fa-shoe-prints mr-1 text-xs"></i>
                        ${variante.pointure || 'N/A'}
                    </span>
                </div>
                
                <!-- Indicateur de stock -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">Stock disponible</span>
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${stockInfo.class}">
                            ${stockInfo.text}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${stockInfo.barClass}" style="width: ${Math.min(variante.stock / 10 * 100, 100)}%"></div>
                    </div>
                </div>
                
                <!-- Contr√¥les de quantit√© et ajout -->
                <div class="space-y-3">
                    <div class="flex items-center justify-center space-x-3">
                        <button type="button" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors ${variante.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                onclick="changerQuantiteVariante(this, -1)" ${variante.stock <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-minus text-sm"></i>
                        </button>
                        <input type="number" min="1" max="${variante.stock || 0}" value="${quantiteInitiale}" 
                               class="w-20 text-center border-2 border-gray-300 rounded-lg px-3 py-2 font-semibold focus:border-[#4B352A] focus:outline-none transition-colors" 
                               ${variante.stock <= 0 ? 'disabled' : ''} />
                        <button type="button" class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors ${variante.stock <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                                onclick="changerQuantiteVariante(this, 1)" ${variante.stock <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-plus text-sm"></i>
                        </button>
                    </div>
                    
                    <button type="button" class="w-full px-4 py-3 rounded-lg font-semibold transition-all duration-200 flex items-center justify-center space-x-2 ${
                        variante.stock <= 0 
                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
                            : 'bg-[#4B352A] hover:bg-[#6d4b3b] text-white hover:shadow-lg transform hover:-translate-y-0.5'
                    }" 
                            onclick="ajouterVarianteAuPanier(${JSON.stringify(variante).replace(/"/g, '&quot;')}, this)"
                            ${variante.stock <= 0 ? 'disabled' : ''}>
                        <i class="fas fa-shopping-cart"></i>
                        <span>${variante.stock <= 0 ? 'Indisponible' : 'Ajouter au panier'}</span>
                    </button>
                </div>
                
                <!-- R√©f√©rence de la variante -->
                ${variante.reference_variante ? `
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <div class="text-xs text-gray-500 font-mono">${variante.reference_variante}</div>
                    </div>
                ` : ''}
            </div>
        `;
        
        grille.appendChild(carte);
    });
}

// Fonction pour g√©n√©rer les informations de stock
function getStockInfo(stock) {
    if (stock <= 0) {
        return {
            class: 'bg-red-100 text-red-800',
            barClass: 'bg-red-500',
            text: '√âpuis√©'
        };
    } else if (stock < 5) {
        return {
            class: 'bg-orange-100 text-orange-800',
            barClass: 'bg-orange-500',
            text: `${stock} restant${stock > 1 ? 's' : ''}`
        };
    } else {
        return {
            class: 'bg-green-100 text-green-800',
            barClass: 'bg-green-500',
            text: `${stock} disponible${stock > 1 ? 's' : ''}`
        };
    }
}

// Fonction pour g√©n√©rer le badge de couleur
function getCouleurBadge(couleur) {
    const couleurs = {
        'Noir': { bg: '#000000', text: 'white' },
        'Blanc': { bg: '#ffffff', text: 'black', border: true },
        'Rouge': { bg: '#dc2626', text: 'white' },
        'Bleu': { bg: '#2563eb', text: 'white' },
        'Vert': { bg: '#16a34a', text: 'white' },
        'Jaune': { bg: '#eab308', text: 'black' },
        'Rose': { bg: '#ec4899', text: 'white' },
        'Violet': { bg: '#7c3aed', text: 'white' },
        'Orange': { bg: '#ea580c', text: 'white' },
        'Gris': { bg: '#6b7280', text: 'white' },
        'Marron': { bg: '#92400e', text: 'white' },
        'Beige': { bg: '#d6d3d1', text: 'black' },
        'Camel': { bg: '#c2910a', text: 'white' },
        'Grenat': { bg: '#7f1d1d', text: 'white' },
    };
    
    const couleurInfo = couleurs[couleur] || { bg: '#66cccc', text: 'white' };
    const borderStyle = couleurInfo.border ? 'border-2 border-gray-300' : '';
    
    return `
        <div class="flex-shrink-0 w-8 h-8 rounded-full ${borderStyle} shadow-sm" 
             style="background-color: ${couleurInfo.bg};" 
             title="${couleur}">
        </div>
    `;
}

// Fonction pour g√©n√©rer les filtres de couleurs
function genererFiltresCouleurs(variantes) {
    const couleursUniques = [...new Set(variantes.map(v => v.couleur).filter(Boolean))];
    const boutonsCouleurs = document.getElementById('boutonsCouleurs');
    
    // Garder le bouton "Toutes"
    const boutonsExistants = boutonsCouleurs.innerHTML;
    boutonsCouleurs.innerHTML = boutonsExistants;
    
    couleursUniques.forEach(couleur => {
        const bouton = document.createElement('button');
        bouton.className = 'filtre-couleur px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border-2 border-transparent hover:border-gray-300 transition-colors';
        bouton.dataset.couleur = couleur;
        bouton.innerHTML = `
            <div class="flex items-center space-x-1">
                ${getCouleurBadge(couleur).replace('w-8 h-8', 'w-3 h-3')}
                <span>${couleur}</span>
            </div>
        `;
        
        bouton.addEventListener('click', () => filtrerParCouleur(couleur));
        boutonsCouleurs.appendChild(bouton);
    });
}

// Fonction pour filtrer les variantes par couleur
function filtrerParCouleur(couleurFiltre) {
    const cartes = document.querySelectorAll('.variante-card');
    const boutons = document.querySelectorAll('.filtre-couleur');
    
    // Mettre √† jour l'√©tat actif des boutons
    boutons.forEach(btn => {
        btn.classList.remove('active', 'bg-blue-100', 'text-blue-800', 'border-blue-200');
        btn.classList.add('bg-gray-100', 'text-gray-700', 'border-transparent');
    });
    
    const boutonActif = document.querySelector(`[data-couleur="${couleurFiltre}"]`);
    if (boutonActif) {
        boutonActif.classList.add('active', 'bg-blue-100', 'text-blue-800', 'border-blue-200');
        boutonActif.classList.remove('bg-gray-100', 'text-gray-700', 'border-transparent');
    }
    
    // Filtrer les cartes
    cartes.forEach(carte => {
        if (couleurFiltre === 'all' || carte.dataset.couleur === couleurFiltre) {
            carte.style.display = 'block';
        } else {
            carte.style.display = 'none';
        }
    });
}

// Gestionnaire pour le bouton "Toutes"
document.addEventListener('DOMContentLoaded', function() {
    const boutonToutes = document.querySelector('[data-couleur="all"]');
    if (boutonToutes) {
        boutonToutes.addEventListener('click', () => filtrerParCouleur('all'));
    }
});

// Fonction pour afficher une erreur de chargement des variantes
function afficherErreurVariantes(message) {
    document.getElementById('loadingVariantes').classList.add('hidden');
    document.getElementById('errorVariantes').classList.remove('hidden');
    document.getElementById('errorVariantes').querySelector('p').textContent = message || 'Erreur lors du chargement des variantes';
}

// Fonction pour changer la quantit√© d'une variante
function changerQuantiteVariante(button, delta) {
    const input = button.parentNode.querySelector('input[type="number"]');
    if (input && !input.disabled) {
        let newValue = parseInt(input.value) + delta;
        const max = parseInt(input.max) || 999;
        if (newValue < 1) newValue = 1;
        if (newValue > max) newValue = max;
        input.value = newValue;
    }
}

// Fonction pour ajouter une variante au panier
function ajouterVarianteAuPanier(variante, button) {
    console.log('üöÄ D√©but ajout variante au panier');
    console.log('Button clicked:', button);
    console.log('Variante data:', variante);
    console.log('Article s√©lectionn√©:', articleSelectionne);
    
    const carte = button.closest('.bg-white');
    console.log('Carte trouv√©e:', carte);
    
    const quantiteInput = carte ? carte.querySelector('input[type="number"]') : null;
    console.log('Input quantit√© trouv√©:', quantiteInput);
    
    const quantite = quantiteInput ? parseInt(quantiteInput.value) || 1 : 1;
    console.log('Quantit√© finale:', quantite);
    
    if (!articleSelectionne) {
        console.error('‚ùå Aucun article s√©lectionn√©');
        return;
    }
    
    console.log('üõí Ajout variante au panier:', {
        article: articleSelectionne.nom,
        variante: variante,
        quantite: quantite
    });
    
    // Utiliser la fonction existante mais adapt√©e pour les variantes
    ajouterVarianteAuPanierDetaille(articleSelectionne, variante, quantite);
    
    // Fermer le modal
    fermerModalVariantes();
    
    // Notification de succ√®s
    showNotification(`‚úÖ ${articleSelectionne.nom} (${variante.couleur} - ${variante.pointure}) ajout√© au panier`, 'success');
}

// Fonction adapt√©e pour ajouter une variante au panier avec tous les d√©tails
function ajouterVarianteAuPanierDetaille(articleData, variante, quantiteInitiale = 1) {
    console.log('üì¶ D√©but ajout variante d√©taill√©:', {articleData, variante, quantiteInitiale});
    
    // Afficher le conteneur du panier s'il √©tait cach√©
    const panierItemsContainer = document.getElementById('panier-items-container');
    console.log('Container panier trouv√©:', panierItemsContainer);
    if (panierItemsContainer) {
        panierItemsContainer.classList.remove('hidden');
    }
    
    const panierItems = document.getElementById('panierItems');
    console.log('PanierItems trouv√©:', panierItems);
    if (!panierItems) {
        console.error('‚ùå Conteneur du panier introuvable');
        return;
    }
    
    // Cr√©er un ID unique pour cette variante (article + couleur + pointure)
    const varianteId = `${articleData.id}_${variante.couleur}_${variante.pointure}`;
    
    // V√©rifier si cette variante est d√©j√† dans le panier
    const existingVariante = panierItems.querySelector(`[data-variante-id="${varianteId}"]`);
    if (existingVariante) {
        // Si la variante existe d√©j√†, augmenter la quantit√©
        const quantiteInput = existingVariante.querySelector('.quantite-input');
        if (quantiteInput) {
            const currentQte = parseInt(quantiteInput.value) || 1;
            quantiteInput.value = currentQte + quantiteInitiale;
            quantiteInput.dispatchEvent(new Event('change'));
        }
        return;
    }
    
    // Cr√©er un √©l√©ment pour la variante
    const varianteElement = document.createElement('div');
    varianteElement.className = 'panier-item';
    varianteElement.dataset.varianteId = varianteId;
    varianteElement.dataset.articleId = articleData.id;
    
    varianteElement.innerHTML = `
        <div class="flex justify-between items-center">
            <div class="flex-1">
                <div class="font-semibold text-gray-800">${articleData.nom}</div>
                <div class="text-xs text-gray-600">R√©f: ${articleData.reference || 'N/A'}</div>
                <div class="text-xs text-gray-700 mt-1">
                    <span class="inline-block mr-2">üé® ${variante.couleur}</span>
                    <span class="inline-block">üëü ${variante.pointure}</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" min="1" value="${quantiteInitiale}" 
                       class="quantite-input w-16 p-1 text-center rounded bg-white/90 text-gray-800" 
                       data-price="${variante.prix_actuel}" 
                       data-article-id="${articleData.id}"
                       data-variante-id="${variante.id}">
                <div class="text-sm font-semibold whitespace-nowrap text-gray-800">${variante.prix_actuel?.toFixed(2) || '0.00'} DH</div>
                <button type="button" class="btn-action btn-danger remove-article">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <input type="hidden" name="article_id" value="${articleData.id}">
        <input type="hidden" name="variante_id" value="${variante.id}">
        <input type="hidden" name="quantite" value="${quantiteInitiale}">
    `;
    
    // Ajouter l'√©l√©ment au panier
    panierItems.appendChild(varianteElement);
    
    // Ajouter les √©couteurs d'√©v√©nements pour la quantit√© et la suppression
    const quantiteInput = varianteElement.querySelector('.quantite-input');
    quantiteInput.addEventListener('change', function() {
        // Mettre √† jour la valeur dans le champ cach√©
        const hiddenInput = varianteElement.querySelector('input[name="quantite"]');
        hiddenInput.value = this.value;
        calculerTotal();
    });
    
    const removeButton = varianteElement.querySelector('.remove-article');
    removeButton.addEventListener('click', function() {
        varianteElement.remove();
        calculerTotal();
        
        // Cacher le conteneur si le panier est vide
        if (panierItems.children.length === 0 && panierItemsContainer) {
            panierItemsContainer.classList.add('hidden');
        }
    });
    
    // Calculer le total
    calculerTotal();
}

// Fonction pour fermer le modal des variantes
function fermerModalVariantes() {
    const modal = document.getElementById('modalVariantes');
    if (modal) {
        modal.classList.add('hidden');
    }
    
    // R√©initialiser les variables
    articleSelectionne = null;
    quantiteInitiale = 1;
}

// Gestionnaires d'√©v√©nements pour le modal des variantes
document.addEventListener('DOMContentLoaded', function() {
    // Bouton fermer modal
    const fermerBtn = document.getElementById('fermerModalVariantes');
    if (fermerBtn) {
        fermerBtn.addEventListener('click', fermerModalVariantes);
    }
    
    // Bouton annuler
    const annulerBtn = document.getElementById('annulerVariantes');
    if (annulerBtn) {
        annulerBtn.addEventListener('click', fermerModalVariantes);
    }
    
    // Bouton fermer (bas du modal)
    const fermerBasBtn = document.getElementById('fermerVariantesBas');
    if (fermerBasBtn) {
        fermerBasBtn.addEventListener('click', fermerModalVariantes);
    }
    
    // Bouton fermer flottant
    const fermerFloatBtn = document.getElementById('fermerModalFloat');
    if (fermerFloatBtn) {
        fermerFloatBtn.addEventListener('click', fermerModalVariantes);
    }
    
    // Clic en dehors du modal pour fermer
    const modal = document.getElementById('modalVariantes');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                fermerModalVariantes();
            }
        });
    }
});

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initialisation du syst√®me de filtrage des articles...');
    chargerArticlesDisponibles();
});
</script>
{% endblock %}

{% endblock %} 