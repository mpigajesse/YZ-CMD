{% extends 'composant_generale/operatConfirme/base.html' %}
{% load static %}

{% block title %}Détail Commande {{ commande.id_yz }} - YZ-CMD{% endblock %}

{% block extra_css %}
<style>
    .card-shadow {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .editable-field {
        position: relative;
    }
    
    .edit-icon {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.6;
        cursor: pointer;
        transition: opacity 0.3s;
    }
    
    .edit-icon:hover {
        opacity: 1;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: capitalize;
    }
    
    .animate-fadeIn {
        animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-slideInUp {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
    <!-- En-tête avec navigation -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, #4B352A, #6d4b3b);">
        <div class="flex items-center space-x-4">
            <a href="{% url 'operatConfirme:liste_commandes' %}" 
               class="flex items-center px-4 py-2 hover:text-white hover:bg-white hover:bg-opacity-20 rounded-lg transition-all duration-300" style="color: #f7d9c4;">
                <i class="fas fa-arrow-left mr-2"></i>
                Retour à la liste
            </a>
            <div class="text-2xl font-bold">
                <i class="fas fa-file-alt mr-3" style="color: #f7d9c4;"></i>
                Commande {{ commande.id_yz }}
            </div>
        </div>
        
        <!-- Actions rapides -->
        <div class="flex space-x-3 mt-4 md:mt-0">
            <a href="{% url 'operatConfirme:modifier_commande' commande.id %}" id="editModeBtn" 
                    class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 text-white rounded-lg transition-all duration-300">
                <i class="fas fa-edit mr-2"></i>
                Modifier
            </a>
            {% comment %} Bouton selon l'état de la commande {% endcomment %}
            {% if commande.etat_actuel %}
                {% if commande.etat_actuel.enum_etat.libelle == 'Affectée' %}
                <button onclick="lancerConfirmationDetail({{ commande.id }})" 
                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-play mr-2"></i>
                    Lancer Confirmation
                </button>
                
                {% endif %}
            {% endif %}

        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert mb-6 p-4 rounded-xl border-l-4 animate-slideInUp
                    {% if message.tags == 'success' %}border-green-500 bg-green-50 text-green-700{% endif %}
                    {% if message.tags == 'error' %}border-red-500 bg-red-50 text-red-700{% endif %}
                    {% if message.tags == 'warning' %}border-yellow-500 bg-yellow-50 text-yellow-700{% endif %}">
            <i class="{% if message.tags == 'success' %}fas fa-check-circle{% elif message.tags == 'error' %}fas fa-exclamation-circle{% else %}fas fa-info-circle{% endif %} mr-2"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Informations principales -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Informations de la commande -->
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.1s;">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-shopping-cart mr-3" style="color: #6d4b3b;"></i>
                    Informations de la commande
                </h3>
                
                <form id="editForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="modifier_commande">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-hashtag mr-1" style="color: #6d4b3b;"></i>
                                ID YZ
                            </label>
                            <div class="p-3 rounded-lg font-bold text-lg" style="background: linear-gradient(to right, #f7d9c4, #ede0d3); color: #4B352A;">
                                {{ commande.id_yz }}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-receipt mr-1" style="color: #6d4b3b;"></i>
                                Numéro de commande
                            </label>
                            <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {{ commande.num_cmd }}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calendar mr-1" style="color: #6d4b3b;"></i>
                                Date de commande
                            </label>
                            <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {{ commande.date_cmd|date:"d/m/Y" }}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-clock mr-1" style="color: #6d4b3b;"></i>
                                Date de création
                            </label>
                            <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {{ commande.date_creation|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-edit mr-1" style="color: #6d4b3b;"></i>
                                Dernière modification
                            </label>
                            <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {{ commande.date_modification|date:"d/m/Y H:i" }}
                            </div>
                        </div>
                        
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-calculator mr-1" style="color: #6d4b3b;"></i>
                                Détail financier
                            </label>
                            <div class="p-3 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg">
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Sous-total articles:</span>
                                        <span class="font-medium">{{ commande.sous_total_articles|floatformat:2 }} DH</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Frais de livraison:</span>
                                        <span class="font-medium text-blue-600">
                                            Appliquer directement sur le prix de la commande DH
                                        </span>
                                    </div>
                                    <hr class="border-gray-300">
                                    <div class="flex justify-between">
                                        <span class="font-bold text-gray-900">Total commande:</span>
                                        <span class="font-bold text-lg" style="color: #4B352A;">
                                            {% with total_final=commande.sous_total_articles%}{{ total_final|floatformat:2 }}{% endwith %} DH
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if commande.is_upsell %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-arrow-up mr-1" style="color: #6d4b3b;"></i>
                                Upsell
                            </label>
                            <div class="p-3 bg-blue-50 rounded-lg text-blue-800 font-medium">
                                <i class="fas fa-check-circle mr-2"></i>
                                Cette commande est un upsell
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if commande.motif_annulation %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-ban mr-1" style="color: #6d4b3b;"></i>
                                Motif d'annulation
                            </label>
                            <div class="p-3 bg-red-50 border border-red-200 rounded-lg text-red-800">
                                {{ commande.motif_annulation }}
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-map-marker-alt mr-1" style="color: #6d4b3b;"></i>
                                Adresse de livraison
                            </label>
                            <div class="editable-field">
                                <textarea name="adresse" id="adresse" rows="3" 
                                          class="w-full p-3 border rounded-lg focus:ring-2 bg-gray-50 transition-all" 
                                          style="border-color: #f7d9c4; focus:ring-color: #6d4b3b; focus:border-color: #4B352A;"
                                          readonly>{{ commande.adresse }}</textarea>
                                <i class="fas fa-edit edit-icon" style="color: #6d4b3b;"></i>
                            </div>
                        </div>
                        
                        {% if commande.ville_init %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-city mr-1" style="color: #6d4b3b;"></i>
                                Ville initiale (CSV)
                            </label>
                            <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                                {{ commande.ville_init }}
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if commande.produit_init %}
                        <div class="md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-file-csv mr-1" style="color: #6d4b3b;"></i>
                                Produit initial (CSV)
                            </label>
                            <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800 text-sm">
                                {{ commande.produit_init }}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Informations client -->
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.2s;">
                <h3 class="text-xl font-semibold mb-6 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-user mr-3" style="color: #6d4b3b;"></i>
                    Informations client
                </h3>
                
                <!-- Numéro de téléphone - EN TÊTE ET EN ÉVIDENCE -->
                <div class="mb-6 p-6 rounded-xl shadow-lg" style="background: linear-gradient(135deg, #4B352A 0%, #6d4b3b 100%);">
                    <div class="text-center">
                        <div class="text-white mb-2">
                            <i class="fas fa-phone-alt text-2xl mb-2"></i>
                            <div class="text-sm font-medium opacity-90">NUMÉRO DE TÉLÉPHONE PRINCIPAL</div>
                        </div>
                        <div class="bg-white bg-opacity-20 rounded-lg p-4 mb-3">
                            <div class="text-3xl font-bold text-white mb-1">{{ commande.client.numero_tel }}</div>
                            <div class="text-sm text-white opacity-80">Cliquez pour appeler directement</div>
                        </div>
                        <div class="flex justify-center gap-3">
                            <a href="tel:{{ commande.client.numero_tel }}" 
                               class="flex items-center px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                <i class="fas fa-phone mr-2"></i>
                                Appeler
                            </a>
                            <button type="button" onclick="copyToClipboard('{{ commande.client.numero_tel }}')" 
                                    class="flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                                <i class="fas fa-copy mr-2"></i>
                                Copier
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Informations détaillées -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="lg:col-span-3 mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-id-card mr-1" style="color: #6d4b3b;"></i>
                            Identité complète
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">PRÉNOM</div>
                                <div class="font-medium text-gray-800">{{ commande.client.prenom|default:"Non renseigné" }}</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <div class="text-xs text-gray-600 mb-1">NOM</div>
                                <div class="font-medium text-gray-800">{{ commande.client.nom|default:"Non renseigné" }}</div>
                            </div>
                            <div class="p-3 rounded-lg font-bold" style="background: linear-gradient(to right, #f7d9c4, #ede0d3); color: #4B352A;">
                                <div class="text-xs opacity-80 mb-1">NOM COMPLET</div>
                                <div class="text-lg">{{ commande.client.get_full_name|default:"Client sans nom" }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-envelope mr-1" style="color: #6d4b3b;"></i>
                            Email
                        </label>
                        <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                            {% if commande.client.email %}
                                <a href="mailto:{{ commande.client.email }}" class="text-blue-600 hover:text-blue-800">
                                    {{ commande.client.email }}
                                </a>
                            {% else %}
                                Non renseigné
                            {% endif %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-calendar-plus mr-1" style="color: #6d4b3b;"></i>
                            Client depuis
                        </label>
                        <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                            {{ commande.client.date_creation|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-edit mr-1" style="color: #6d4b3b;"></i>
                            Dernière modif client
                        </label>
                        <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                            {{ commande.client.date_modification|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    
                    {% if commande.client.adresse %}
                    <div class="md:col-span-2 lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-home mr-1" style="color: #6d4b3b;"></i>
                            Adresse client (profil)
                        </label>
                        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg text-blue-800">
                            {{ commande.client.adresse }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if commande.client.note %}
                    <div class="md:col-span-2 lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-sticky-note mr-1" style="color: #6d4b3b;"></i>
                            Note sur le client
                        </label>
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
                            {{ commande.client.note }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-map-marker-alt mr-1" style="color: #6d4b3b;"></i>
                            Ville de livraison
                        </label>
                        <div class="p-3 bg-gray-50 rounded-lg text-gray-800">
                            {% if commande.ville %}
                                <div class="font-medium">{{ commande.ville.nom }}</div>
                                {% if commande.ville.region %}
                                    <div class="text-sm text-gray-600">Région: {{ commande.ville.region.nom_region }}</div>
                                {% endif %}
                            {% else %}
                                {{ commande.ville_init|default:"Non spécifiée" }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-toggle-on mr-1" style="color: #6d4b3b;"></i>
                            Statut client
                        </label>
                        <div class="p-3 rounded-lg">
                            {% if commande.client.is_active %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Actif
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle mr-1"></i>
                                    Inactif
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <i class="fas fa-shopping-cart mr-1" style="color: #6d4b3b;"></i>
                            Nombre de commandes
                        </label>
                        <div class="p-3 rounded-lg font-bold" style="background: linear-gradient(to right, #f7d9c4, #ede0d3); color: #4B352A;">
                            {{ commande.client.commandes.count }} commande{{ commande.client.commandes.count|pluralize }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Détail des articles -->
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.3s;">
                <h3 class="text-xl font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-box mr-3" style="color: #6d4b3b;"></i>
                    Détail des articles
                </h3>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead style="background-color: #4B352A;">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Article</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Prix unitaire</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Quantité</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Sous-total</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for panier in commande.paniers.all %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ panier.article.nom }}</div>
                                    <div class="text-sm text-gray-500">Réf: {{ panier.article.reference }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                    {{ panier.article.prix_unitaire }} DH
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                        {{ panier.quantite }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-green-600">
                                    {{ panier.sous_total }} DH
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-shopping-basket text-4xl mb-2 opacity-50"></i>
                                    <div>Aucun article dans cette commande</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot style="background-color: #f7d9c4;">
                            <tr>
                                <td colspan="3" class="px-4 py-3 text-right font-medium" style="color: #4B352A;">
                                    Sous-total articles:
                                </td>
                                <td class="px-4 py-3 font-bold" style="color: #6d4b3b;">
                                    {{ total_articles }} DH
                                </td>
                            </tr>
                            <tr style="background-color: #e0f2fe;">
                                <td colspan="3" class="px-4 py-3 text-right font-medium text-blue-800">
                                    Frais de livraison 
                                </td>
                                <td class="px-4 py-3 font-bold text-blue-800">
                                    Appliquer directement sur le prix de la commande DH
                                </td>
                            </tr>
                            <tr style="background-color: #4B352A;">
                                <td colspan="3" class="px-4 py-3 text-right font-bold text-white">
                                    Total commande:
                                </td>
                                <td class="px-4 py-3 font-bold text-lg text-white">
                                    {% with total_final=total_articles %}{{ total_final|floatformat:2 }}{% endwith %} DH
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar avec état et actions -->
        <div class="space-y-6">
            <!-- État actuel -->
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.4s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-info-circle mr-3" style="color: #6d4b3b;"></i>
                    État actuel
                </h3>
                
                <div class="space-y-4">
                    <div class="p-4 rounded-lg border" style="background: linear-gradient(to right, #f7d9c4, #ede0d3); border-color: #f7d9c4;">
                        <div class="flex items-center justify-between">
                            <span class="status-badge" style="background-color: #f7d9c4; color: #4B352A;">
                                <i class="fas fa-clock mr-2"></i>
                                {{ etat_actuel.enum_etat.libelle|capfirst }}
                            </span>
                        </div>
                        <div class="mt-2 text-sm" style="color: #6d4b3b;">
                            <i class="fas fa-calendar mr-1"></i>
                            Depuis: {{ etat_actuel.date_debut|date:"d/m/Y H:i" }}
                        </div>
                        {% if etat_actuel.commentaire %}
                        <div class="mt-2 text-sm text-gray-600 bg-white p-2 rounded">
                            <strong>Commentaire:</strong> {{ etat_actuel.commentaire }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Boutons d'actions en mode édition -->
                    <div id="editActions" style="display: none;" class="space-y-2">
                        <button type="submit" form="editForm"
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors shadow-lg">
                            <i class="fas fa-save mr-2"></i>
                            Sauvegarder les modifications
                        </button>
                        <button type="button" onclick="cancelEdit()"
                                class="w-full px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-times mr-2"></i>
                            Annuler
                        </button>
                    </div>
                </div>
            </div>

            <!-- Historique des états -->
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.5s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-history mr-3" style="color: #6d4b3b;"></i>
                    Historique des états
                </h3>
                
                <div class="space-y-3">
                    {% for etat in historique_etats %}
                    <div class="flex items-start space-x-3 p-3 {% if not etat.date_fin %}border{% else %}bg-gray-50{% endif %} rounded-lg transition-all hover:shadow-md" {% if not etat.date_fin %}style="background-color: #f7d9c4; border-color: #f7d9c4;"{% endif %}>
                        <div class="flex-shrink-0">
                            <div class="w-3 h-3 rounded-full mt-2" {% if not etat.date_fin %}style="background-color: #6d4b3b;"{% else %}style="background-color: #999;"{% endif %}></div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900">
                                {{ etat.enum_etat.libelle|capfirst }}
                            </div>
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-clock mr-1"></i>
                                {{ etat.date_debut|date:"d/m/Y H:i" }}
                                {% if etat.date_fin %} - {{ etat.date_fin|date:"d/m/Y H:i" }}{% endif %}
                            </div>
                            {% if etat.operateur %}
                            <div class="text-xs text-gray-600">
                                <i class="fas fa-user mr-1"></i>
                                Par: {{ etat.operateur.nom_complet }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-history text-2xl mb-2 opacity-50"></i>
                        <div>Aucun historique disponible</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Résumé de ma confirmation -->
            {% if commande.etat_actuel.enum_etat.libelle == 'Confirmée' %}
            <div class="bg-gradient-to-r from-green-50 to-green-100 border border-green-200 rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.55s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center text-green-800">
                    <i class="fas fa-check-circle mr-3 text-green-600"></i>
                    Ma Confirmation Effectuée
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-1">Date de confirmation</label>
                        <div class="p-3 bg-white rounded-lg border border-green-200">
                            {% for etat in commande.etats.all %}
                                {% if etat.enum_etat.libelle == 'Confirmée' and etat.operateur.user == request.user %}
                                    <i class="fas fa-calendar mr-2 text-green-600"></i>
                                    {{ etat.date_debut|date:"d/m/Y à H:i" }}
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-green-700 mb-1">Opération réalisée</label>
                        <div class="p-3 bg-white rounded-lg border border-green-200">
                            {% if commande.operations.exists %}
                                {% with operation_confirmee=commande.operations.first %}
                                    <i class="fas fa-cogs mr-2 text-green-600"></i>
                                    {{ operation_confirmee.get_type_operation_display }}
                                {% endwith %}
                            {% else %}
                                <span class="text-green-600">Aucune opération spécifique</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if commande.operations.exists and commande.operations.first.conclusion %}
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-green-700 mb-1">Commentaire de l'opération</label>
                        <div class="p-3 bg-white rounded-lg border border-green-200">
                            <i class="fas fa-comment mr-2 text-green-600"></i>
                            {{ commande.operations.first.conclusion }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="md:col-span-2">
                        <div class="flex items-center p-3 bg-green-600 text-white rounded-lg">
                            <i class="fas fa-info-circle mr-3"></i>
                            <span class="font-medium">Cette commande a été confirmée et envoyée vers l'administration pour traitement.</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Historique des opérations (lecture seule) -->
            {% if commande.operations.all %}
            <div class="bg-white rounded-xl p-6 card-shadow animate-slideInUp" style="animation-delay: 0.6s;">
                <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: #4B352A;">
                    <i class="fas fa-history mr-3" style="color: #6d4b3b;"></i>
                    Historique Complet des Opérations
                </h3>
                
                <div class="space-y-2 max-h-60 overflow-y-auto">
                    {% for operation in commande.operations.all %}
                    <div class="p-3 bg-gray-50 rounded-lg border-l-4" style="border-left-color: #6d4b3b;">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-sm" style="color: #4B352A;">
                                    {{ operation.get_type_operation_display }}
                                </div>
                                <div class="text-xs text-gray-500 mb-1">
                                    <i class="fas fa-clock mr-1"></i>
                                    {{ operation.date_operation|date:"d/m/Y H:i" }}
                                    par {{ operation.operateur.nom_complet }}
                                </div>
                                <div class="text-sm text-gray-700">
                                    {{ operation.conclusion }}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>



<script>
let isEditMode = false;

function toggleEditMode() {
    isEditMode = !isEditMode;
    const editableFields = document.querySelectorAll('textarea[name="adresse"], input[name="telephone"]');
    const editActions = document.getElementById('editActions');
    const editBtn = document.getElementById('editModeBtn');
    
    editableFields.forEach(field => {
        field.readOnly = !isEditMode;
                 if (isEditMode) {
             field.classList.remove('bg-gray-50');
             field.classList.add('bg-white');
             field.style.borderColor = '#4B352A';
         } else {
             field.classList.add('bg-gray-50');
             field.classList.remove('bg-white');
             field.style.borderColor = '#f7d9c4';
         }
    });
    
    if (isEditMode) {
        editActions.style.display = 'block';
        editBtn.innerHTML = '<i class="fas fa-times mr-2"></i>Annuler';
        editBtn.classList.remove('bg-white', 'bg-opacity-20', 'hover:bg-opacity-30');
        editBtn.classList.add('bg-red-600', 'hover:bg-red-700');
    } else {
        editActions.style.display = 'none';
        editBtn.innerHTML = '<i class="fas fa-edit mr-2"></i>Modifier';
        editBtn.classList.add('bg-white', 'bg-opacity-20', 'hover:bg-opacity-30');
        editBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
    }
}

function cancelEdit() {
    // Restaurer les valeurs originales
    document.getElementById('adresse').value = '{{ commande.adresse|escapejs }}';
    document.getElementById('telephone').value = '{{ commande.client.numero_tel|escapejs }}';
    document.querySelector('textarea[name="commentaire"]').value = '';
    
    toggleEditMode();
}





// Fonction pour copier le numéro de téléphone
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Afficher une notification temporaire
        const notification = document.createElement('div');
        notification.textContent = 'Numéro copié dans le presse-papiers !';
        notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 2000);
    }).catch(function(err) {
        console.error('Erreur lors de la copie: ', err);
        alert('Erreur lors de la copie du numéro');
    });
}

// Animation des cartes
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.animate-slideInUp');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
        }, index * 100);
    });
});

// ================== FONCTION LANCER CONFIRMATION DETAIL ==================

function lancerConfirmationDetail(commandeId) {
    // Afficher une notification de traitement en cours
    showNotification('⏳ Lancement de la confirmation en cours...', 'info');
    
    fetch(`/operateur-confirme/commandes/${commandeId}/lancer-confirmation/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('✅ ' + data.message, 'success');
            // Rediriger vers la page modifier_commande après un court délai
            setTimeout(() => {
                window.location.href = `/operateur-confirme/commandes/${commandeId}/modifier/`;
            }, 1500);
        } else {
            showNotification('❌ ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('❌ Une erreur est survenue lors du lancement de la confirmation', 'error');
    });
}

// ================== SYSTÈME DE NOTIFICATIONS ==================

function showNotification(message, type = 'info') {
    // Supprimer les notifications existantes
    const existingNotifications = document.querySelectorAll('.notification-toast');
    existingNotifications.forEach(notif => notif.remove());
    
    // Créer la notification
    const notification = document.createElement('div');
    notification.className = 'notification-toast fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transform transition-all duration-300 max-w-md';
    
    // Styles selon le type
    if (type === 'success') {
        notification.classList.add('bg-green-500', 'text-white');
    } else if (type === 'error') {
        notification.classList.add('bg-red-500', 'text-white');
    } else if (type === 'warning') {
        notification.classList.add('bg-yellow-500', 'text-white');
    } else {
        notification.classList.add('bg-blue-500', 'text-white');
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <div class="flex-1">
                ${message}
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-3 text-white hover:text-gray-200">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto-suppression après 5 secondes
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}

</script>
{% endblock %}
