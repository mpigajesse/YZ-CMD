{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}

{% block title %}{{ page_title }} - YZ-CMD{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}
{% block page_subtitle %}{{ page_subtitle }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="main-content transition-all duration-300" id="mainContent">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg"
         style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-dark));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-boxes mr-3" style="color: var(--preparation-border-accent);"></i>
                {{ page_title }}
            </h1>
            <p style="color: white;">{{ page_subtitle }}</p>
        </div>
    </div>

    <!-- Statistiques rapides -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- Total des commandes -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-purple-100 to-purple-200 text-purple-600 transition-all duration-300 group-hover:from-purple-500 group-hover:to-purple-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-boxes text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Emballées</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-purple-600">{{ stats.total_commandes }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Valeur totale -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-green-100 to-green-200 text-green-600 transition-all duration-300 group-hover:from-green-500 group-hover:to-green-600 group-hover:text-white group-hover:scale-110">
                        <i class="fas fa-coins text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Valeur Totale</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300 group-hover:text-green-600">{{ stats.valeur_totale|floatformat:0 }} DH</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commandes urgentes -->
        <div class="group bg-white rounded-xl shadow-lg p-6 transition-all duration-300 hover:shadow-2xl hover:scale-105 border border-gray-100" style="border-color: var(--preparation-border-accent);">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="p-4 rounded-full bg-gradient-to-r from-red-100 to-red-200 transition-all duration-300 group-hover:from-red-500 group-hover:to-red-600 group-hover:text-white group-hover:scale-110" style="color: var(--preparation-primary);">
                        <i class="fas fa-exclamation-triangle text-2xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600 group-hover:text-gray-700 transition-colors duration-300">Urgentes</p>
                        <p class="text-3xl font-bold text-gray-900 transition-all duration-300" style="group-hover:color: var(--preparation-primary);">{{ stats.commandes_urgentes }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre d'outils avec recherche intelligente -->
    <div class="mb-6 flex flex-wrap gap-2 bg-gray-50 p-3 rounded-lg border border-gray-200">
        <!-- Sélecteur éléments par page -->
        <form method="GET" class="flex items-center">
            {% if search_query %}
                <input type="hidden" name="search" value="{{ search_query }}">
            {% endif %}
            
            <div class="flex items-center bg-white rounded-xl shadow-sm border border-gray-200 px-4 py-2 hover:shadow-md transition-all duration-300 group">
                <div class="mr-3 p-1.5 rounded-lg bg-gradient-to-r from-purple-50 to-indigo-50 group-hover:from-purple-100 group-hover:to-indigo-100 transition-all duration-300">
                    <i class="fas fa-list-ol text-purple-600 text-sm"></i>
                </div>
                
                <label for="itemsPerPage" class="mr-3 text-sm font-medium text-gray-700 group-hover:text-gray-900 transition-colors duration-300">
                    Éléments/page
                </label>
                
                <div class="w-px h-6 bg-gray-300 mx-2"></div>
                
                <select id="itemsPerPage" name="items_per_page" onchange="this.form.submit()" 
                        class="px-3 py-1.5 text-sm font-semibold text-purple-600 hover:text-purple-700 transition-colors duration-300 cursor-pointer">
                    <option value="10" {% if items_per_page|default:10 == 10 %}selected{% endif %}>10</option>
                    <option value="25" {% if items_per_page == 25 %}selected{% endif %}>25</option>
                    <option value="50" {% if items_per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if items_per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
        </form>

        <!-- Barre de recherche intelligente -->
        <div class="relative ml-auto">
            <div class="flex items-center space-x-2">
                <div class="relative">
                    <input type="text" id="smartSearch" 
                           placeholder="Recherche intelligente..." 
                           class="block px-4 py-2 pr-10 border border-gray-300 rounded shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 text-sm w-64 h-10"
                           autocomplete="off">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <button onclick="clearSmartSearch()" 
                        class="inline-flex items-center px-3 py-2 bg-gray-500 hover:bg-gray-600 text-white text-sm font-medium rounded transition-colors h-10">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
        
    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead style="background-color: var(--preparation-primary);">
                <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">ID YZ</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">N° Externe</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Client</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Téléphone</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville Client</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Ville & Région</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Date Emballage</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Total</th>

                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État</th>
                        <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">État Préparation</th>
                        <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Panier</th>
                    <th scope="col" class="px-4 py-3 text-center text-xs font-medium text-white uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% if commandes %}
                    {% for commande in commandes %}
                    <tr class="hover:bg-gray-50 commande-row" 
                        data-id-yz="{{ commande.id_yz }}"
                        data-num-cmd="{{ commande.num_cmd|default:'' }}"
                        data-client="{{ commande.client.prenom }} {{ commande.client.nom }}"
                        data-phone="{{ commande.client.numero_tel|default:'' }}"
                        data-email="{{ commande.client.email|default:'' }}"
                        data-ville-client="{{ commande.ville_init|default:'' }}"
                        data-ville-region="{% if commande.ville %}{{ commande.ville.nom }} {{ commande.ville.region.nom_region }}{% endif %}"
                        data-date-emballage="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel %}{{ etat_actuel.date_debut|date:'d/m/Y' }}{% endif %}{% endwith %}"
                        data-total="{{ commande.total_cmd }}"
                        data-etat="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel %}{{ etat_actuel.enum_etat.libelle }}{% endif %}{% endwith %}"
                        data-operateur="{% with etat_actuel=commande.etat_actuel %}{% if etat_actuel and etat_actuel.operateur %}{{ etat_actuel.operateur.prenom }} {{ etat_actuel.operateur.nom }}{% endif %}{% endwith %}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ commande.id_yz }}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{{ commande.num_cmd|default:"-" }}</td>
                        <!-- Colonne Client -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ commande.client.prenom }} {{ commande.client.nom }}</div>
                            {% if commande.client.email %}
                            <div class="text-xs text-gray-500">{{ commande.client.email }}</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Téléphone -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% if commande.client.numero_tel %}
                            <div class="text-sm text-gray-900 font-medium">
                                <i class="fas fa-phone mr-1"></i>
                                {{ commande.client.numero_tel }}
                            </div>
                            {% else %}
                            <div class="text-sm text-gray-500">Non renseigné</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Ville Client -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            {% if commande.ville_init and commande.ville_init != '' %}
                                <div style="color: var(--preparation-primary);" class="font-medium">{{ commande.ville_init }}</div>
                            {% else %}
                                <div style="color: var(--preparation-primary);">Non spécifiée</div>
                            {% endif %}
                        </td>
                        <!-- Colonne Ville & Région (ville de livraison) -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% if commande.ville %}
                                <div class="text-sm text-gray-900">{{ commande.ville.nom }}</div>
                                <div class="text-xs text-gray-500">{{ commande.ville.region.nom_region }}</div>
                            {% else %}
                                <div class="text-sm text-gray-500">Non définie</div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            {% with etat_actuel=commande.etat_actuel %}
                                {% if etat_actuel %}
                                    <div class="text-sm text-gray-900">{{ etat_actuel.date_debut|date:"d/m/Y" }}</div>
                                    <div class="text-xs text-gray-500">{{ etat_actuel.date_debut|date:"H:i" }}</div>
                                {% else %}
                                    <div class="text-sm text-gray-500">Non définie</div>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-green-600">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        </td>

                        <td class="px-4 py-4 whitespace-nowrap">
                            {% with etat_actuel=commande.etat_actuel %}
                                <div class="flex items-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        <i class="fas fa-boxes mr-1"></i>
                                        Emballée
                                    </span>
                                </div>
                            {% endwith %}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="flex flex-col space-y-1">
                                <!-- État actuel avec icône d'information -->
                                <div class="flex items-center">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                                        <i class="fas fa-boxes mr-1"></i>
                                        Emballée
                                    </span>
                                    
                                    <!-- Bouton pour afficher/masquer les détails d'état -->
                                    <button onclick="toggleEtatDetails('{{ commande.id }}')" 
                                            class="ml-2 w-6 h-6 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-all duration-300 transform hover:scale-110"
                                            title="Afficher/masquer les détails d'état">
                                        <i class="fas fa-info text-gray-600 text-xs"></i>
                                    </button>
                                </div>
                                
                                <!-- Détails d'état (masqués par défaut) -->
                                <div id="etat-details-{{ commande.id }}" class="hidden mt-2 space-y-1">
                                    <!-- Affichage des étapes de préparation -->
                                    <div class="mt-2 pt-2 border-t border-gray-200">
                                        <div class="text-xs font-medium text-gray-700 mb-1">Étapes de préparation :</div>
                                        
                                        <!-- Étape 1: En préparation -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-green-600">En préparation</span>
                                            <span class="text-xs text-green-500 ml-2">
                                                <i class="fas fa-check mr-1"></i>Terminé
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 2: Collectée -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-green-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-green-600">Collectée</span>
                                            <span class="text-xs text-green-500 ml-2">
                                                <i class="fas fa-check mr-1"></i>Terminé
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 3: Emballée -->
                                        <div class="flex items-center mb-1">
                                            <span class="w-3 h-3 rounded-full bg-purple-500 flex items-center justify-center mr-2">
                                                <i class="fas fa-check text-white text-xs"></i>
                                            </span>
                                            <span class="text-xs text-purple-600">Emballée</span>
                                            <span class="text-xs text-purple-500 ml-2">
                                                <i class="fas fa-clock mr-1"></i>En cours
                                            </span>
                                        </div>
                                        
                                        <!-- Étape 4: Préparée (finalisée par superviseur) -->
                                        <div class="flex items-center">
                                            <span class="w-3 h-3 rounded-full bg-gray-300 flex items-center justify-center mr-2">
                                                <i class="fas fa-circle text-gray-400 text-xs"></i>
                                            </span>
                                            <span class="text-xs text-gray-400">Préparée</span>
                                            <span class="text-xs text-gray-500 ml-2">
                                                <i class="fas fa-clock mr-1"></i>En attente
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center" style="min-width: 96px;">
                            <div class="flex items-center justify-center space-x-2">
                                <!-- Panier (icône + compteur) -->
                                <button type="button"
                                   onclick="openPanierModal({{ commande.id }})"
                                   class="inline-flex items-center px-2.5 py-1 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: var(--preparation-primary); hover:background-color: var(--preparation-dark);"
                                   title="Voir le panier">
                                    <i class="fas fa-shopping-cart text-sm mr-1"></i>
                                    <span class="text-xs">{{ commande.paniers.count }}</span>
                                </button>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-center" style="min-width: 120px;">
                            <div class="flex items-center justify-center space-x-2">
                                <!-- Détails (icône seule) -->
                                <a href="{% url 'Superpreparation:detail_prepa' commande.pk %}"
                                   class="inline-flex items-center justify-center w-9 h-9 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: var(--preparation-primary); hover:background-color: var(--preparation-dark);"
                                   title="Voir la commande" aria-label="Détails">
                                    <i class="fas fa-eye text-sm"></i>
                                    <span class="sr-only">Détails</span>
                                </a>
                                <!-- Finaliser (icône seule) - pour les commandes emballées -->
                                <button onclick="finaliserCommande({{ commande.id }})"
                                   class="inline-flex items-center justify-center w-9 h-9 rounded-md shadow-sm text-white transition-all hover:shadow-lg"
                                   style="background-color: #10b981; hover:background-color: #059669;"
                                   title="Finaliser la préparation" aria-label="Finaliser">
                                    <i class="fas fa-check text-sm"></i>
                                    <span class="sr-only">Finaliser</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="12" class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <i class="fas fa-boxes text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-medium text-gray-600 mb-2">Aucune commande emballée</h3>
                                <p class="text-gray-500">Aucune commande n'attend actuellement la finalisation.</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/Suivi_des_Commandes/liste-prepra-smart-search.js' %}"></script>

<script>
function formatMoney(v) { try { return parseFloat(v).toFixed(2) + ' DH'; } catch(e) { return '0.00 DH'; } }

function openPanierModal(commandeId) {
    fetch(`/Superpreparation/api/commande/${commandeId}/panier/`, { headers: { 'X-Requested-With': 'XMLHttpRequest' }})
      .then(r => r.json())
      .then(data => {
        if (!data || data.error || data.success === false) {
            return showToast(data?.error || data?.message || 'Impossible de charger le panier', 'error');
        }
        const cmd = data.commande || {};
        const articles = data.articles || [];

        // Entête
        document.getElementById('panierCmdId').textContent = 'Commande ' + (cmd.id_yz || '');
        document.getElementById('panierClient').textContent = cmd.client_nom || '';
        document.getElementById('panierCount').textContent = (cmd.total_articles || 0) + ' article' + ((cmd.total_articles||0)>1?'s':'');
        document.getElementById('panierTotalEntete').textContent = formatMoney(cmd.total_final || 0);

        // Liste
        const list = document.getElementById('panierItems');
        list.innerHTML = '';
        if (articles.length === 0) {
            document.getElementById('panierEmpty').classList.remove('hidden');
        } else {
            document.getElementById('panierEmpty').classList.add('hidden');
            articles.forEach(a => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between py-2 border-b last:border-b-0';
                row.innerHTML = `
                    <div>
                        <div class="text-sm font-medium text-gray-800">${a.nom || ''}</div>
                        <div class="text-xs text-gray-500">Ref: ${a.reference || 'N/A'} · PU: ${formatMoney(a.prix_unitaire || 0)}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-700">${a.quantite || 0} × ${parseFloat(a.prix_unitaire||0).toFixed(2)}</div>
                        <div class="text-sm font-semibold text-gray-900">${formatMoney(a.sous_total || 0)}</div>
                    </div>`;
                list.appendChild(row);
            });
        }

        // Totaux
        document.getElementById('panierSousTotal').textContent = formatMoney(cmd.total_montant || cmd.total_articles_montant || 0);
        document.getElementById('panierTotalFinal').textContent = formatMoney(cmd.total_final || 0);

        document.getElementById('panierModal').classList.remove('hidden');
      })
      .catch(() => showToast('Erreur réseau', 'error'));
}

// Fonction pour finaliser une commande depuis la liste
function finaliserCommande(commandeId) {
    Swal.fire({
        title: 'Finaliser la préparation',
        text: "Voulez-vous vraiment finaliser cette commande emballée ?",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Oui, finaliser !',
        cancelButtonText: 'Annuler'
    }).then((result) => {
        if (result.isConfirmed) {
            // Afficher un indicateur de chargement
            Swal.fire({
                title: 'Finalisation en cours...',
                text: 'Veuillez patienter',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Envoyer la requête AJAX
            fetch(`/Superpreparation/api/commande/${commandeId}/finaliser/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: 'Succès !',
                        text: data.message,
                        icon: 'success',
                        confirmButtonColor: '#10b981'
                    }).then(() => {
                        // Recharger la page pour mettre à jour la liste
                        window.location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Erreur',
                        text: data.message || 'Une erreur est survenue',
                        icon: 'error',
                        confirmButtonColor: '#ef4444'
                    });
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                Swal.fire({
                    title: 'Erreur',
                    text: 'Erreur de connexion',
                    icon: 'error',
                    confirmButtonColor: '#ef4444'
                });
            });
        }
    });
}

// Fonction pour afficher/masquer les détails d'état
function toggleEtatDetails(commandeId) {
    const detailsElement = document.getElementById(`etat-details-${commandeId}`);
    if (detailsElement) {
        detailsElement.classList.toggle('hidden');
    }
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transition-all transform translate-x-full opacity-0 max-w-sm`;
    
    if (type === 'success') {
        toast.classList.add('bg-green-500', 'text-white');
    } else if (type === 'error') {
        toast.classList.add('bg-red-500', 'text-white');
    } else {
        toast.classList.add('bg-gray-800', 'text-white');
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Animer l'entrée
    setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');
    }, 100);
    
    // Animer la sortie
    setTimeout(() => {
        toast.classList.remove('translate-x-0', 'opacity-100');
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => toast.remove(), 500);
    }, duration);
}
</script>

<!-- Modal panier -->
<div id="panierModal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black bg-opacity-50" onclick="closePanierModal()"></div>
  <div class="relative z-10 max-w-3xl mx-auto mt-20 bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b">
      <h3 class="text-2xl font-bold">Détails du panier</h3>
      <button class="text-gray-500 hover:text-gray-700" onclick="closePanierModal()"><i class="fas fa-times text-xl"></i></button>
    </div>
    <div class="m-6 p-4 rounded-lg border bg-purple-50">
      <div class="flex items-center justify-between">
        <div>
          <div id="panierCmdId" class="font-semibold text-purple-800">Commande</div>
          <div class="text-sm text-purple-700">Client: <span id="panierClient"></span></div>
        </div>
        <div class="text-right">
          <div id="panierCount" class="text-purple-700 font-semibold"></div>
          <div class="text-sm text-purple-700">Total: <span id="panierTotalEntete"></span></div>
        </div>
      </div>
    </div>
    <div class="px-6 pb-4">
      <div id="panierEmpty" class="text-center py-12 text-gray-500 hidden">
        <i class="fas fa-shopping-basket text-4xl mb-3"></i>
        <div class="text-lg font-semibold">Panier vide</div>
        <div class="text-sm">Cette commande ne contient aucun article.</div>
      </div>
      <div id="panierItems" class="space-y-2"></div>
    </div>
    <div class="px-6 py-4 bg-gray-50 border-t">
      <div class="flex items-center justify-between text-sm mb-2">
        <div class="text-gray-600">Sous-total articles:</div>
        <div id="panierSousTotal" class="text-gray-900">0.00 DH</div>
      </div>
      <div class="flex items-center justify-between font-bold text-lg">
        <div>Total commande:</div>
        <div id="panierTotalFinal" class="text-green-600">0.00 DH</div>
      </div>
    </div>
  </div>
</div>

<script>
function closePanierModal() { document.getElementById('panierModal').classList.add('hidden'); }
</script>
{% endblock %}
