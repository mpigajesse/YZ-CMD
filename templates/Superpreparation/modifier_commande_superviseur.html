{% extends 'composant_generale/Superpreparation/base.html' %}
{% load static %}
{% load prepa_filters %}

{% block title %}Modifier Commande {{ commande.id_yz }} - Préparation{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    .animate-slideInUp { animation: slideInUp 0.6s ease-out forwards; opacity: 0; }
    @keyframes slideInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .btn-prepa { background: linear-gradient(to right, var(--preparation-primary), var(--preparation-light)); color: white; transition: all 0.3s; }
    .btn-prepa:hover { background: var(--preparation-dark); }
    .section-title { color: var(--preparation-primary); }
    .renvoi-alert { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; }
    .renvoi-badge { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
    .modification-section { background: linear-gradient(135deg, #e5e7eb, #e0e7ff); border: 2px solid var(--preparation-border-accent); }
    .quick-action-btn { transition: all 0.3s ease; }
    .quick-action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .filter-btn { transition: all 0.3s ease; }
    .filter-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .filter-btn.active { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    
    /* Styles pour la logique upsell */
    .upsell-badge {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
        color: white;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    .compteur-upsell {
        transition: all 0.3s ease;
    }
    
    .compteur-upsell.updated {
        animation: highlight 1s ease-out;
    }
    
    @keyframes highlight {
        0% { background-color: #fef3c7; }
        100% { background-color: transparent; }
    }
    
    .prix-upsell {
        color: #f59e0b;
        font-weight: bold;
    }
    
    .prix-normal {
        color: #059669;
    }
    
    .prix-promo {
        color: #dc2626;
    }
    
    .prix-liquidation {
        color: #ea580c;
    }
    
    .prix-test {
        color: #7c3aed;
    }
    
    /* Styles améliorés pour la liste des articles */
    #articlesList {
        max-height: 70vh;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    #articlesList::-webkit-scrollbar {
        width: 8px;
    }
    
    #articlesList::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }
    
    #articlesList::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }
    
    #articlesList::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
    
    /* Animations pour les cartes d'articles */
    .article-card {
        animation: slideInUp 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }
    
    .article-card:nth-child(1) { animation-delay: 0.1s; }
    .article-card:nth-child(2) { animation-delay: 0.2s; }
    .article-card:nth-child(3) { animation-delay: 0.3s; }
    .article-card:nth-child(4) { animation-delay: 0.4s; }
    .article-card:nth-child(5) { animation-delay: 0.5s; }
    
    /* Styles pour les badges et indicateurs */
    .badge-gradient {
        background: linear-gradient(135deg, var(--tw-gradient-stops));
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .stock-indicator {
        animation: pulse 2s infinite;
    }
    
    /* Hover effects améliorés */
    .article-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    /* Styles pour les contrôles de quantité */
    .quantity-control {
        transition: all 0.2s ease;
    }
    
    .quantity-control:hover {
        transform: scale(1.05);
    }
    
    .quantity-control:active {
        transform: scale(0.95);
    }
    
    /* Styles pour le bouton d'ajout */
    .add-button {
        transition: all 0.3s ease;
    }
    
    .add-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive design pour les cartes */
    @media (max-width: 768px) {
        .article-card {
            margin-bottom: 1rem;
        }
        
        .basic-info-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Styles pour les sections d'information */
    .info-section {
        border-left: 4px solid;
        border-radius: 0 8px 8px 0;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .info-section.blue {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #eff6ff, #dbeafe);
    }
    
    .info-section.yellow {
        border-color: #eab308;
        background: linear-gradient(135deg, #fefce8, #fef3c7);
    }
    
    .info-section.purple {
        border-color: #8b5cf6;
        background: linear-gradient(135deg, #faf5ff, #f3e8ff);
    }
    
    .info-section.indigo {
        border-color: #6366f1;
        background: linear-gradient(135deg, #eef2ff, #e0e7ff);
    }
    
    /* Styles pour la modal d'information sur le stock */
    .stock-info-modal .swal2-popup {
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .stock-info-popup {
        max-width: 600px;
    }
    
    /* Animation pour l'icône d'information */
    .fa-info-circle {
        transition: all 0.3s ease;
    }
    
    .fa-info-circle:hover {
        transform: scale(1.1);
        color: #3b82f6;
    }
    
    /* Limitation du texte à 2 lignes */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Styles pour les indicateurs de statut */
    .stock-status-indicator {
        animation: pulse 2s infinite;
    }
    
    .stock-status-indicator.limited {
        animation: pulse 1s infinite;
    }
    
    .stock-status-indicator.critical {
        animation: pulse 0.5s infinite;
    }
    
    /* Styles pour le catalogue premium */
    .article-card {
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .article-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .article-card:hover::before {
        opacity: 1;
    }
    
    .article-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border-color: #3b82f6;
    }
    
    /* Animations d'apparition en cascade */
    .article-card {
        animation: slideInUp 0.6s ease-out forwards;
        opacity: 0;
        transform: translateY(30px);
    }
    
    @keyframes slideInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
        /* Grille responsive - plus compacte */
    .catalog-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
    
    /* Badges premium - plus compacts */
    .badge-premium {
        background: linear-gradient(135deg, var(--tw-gradient-stops));
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
    }
    
    /* Boutons premium - plus compacts */
    .btn-premium {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    }
    
    .btn-premium:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Effets de survol pour les contrôles - plus subtils */
    .quantity-control {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .quantity-control:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .quantity-control:active {
        transform: scale(0.95);
    }
    
    /* Input de quantité stylisé - plus compact */
    .quantity-input {
        background: transparent;
        border: none;
        text-align: center;
        font-weight: bold;
        font-size: 1rem;
        color: #1f2937;
        transition: all 0.2s ease;
    }
    
    .quantity-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        background: rgba(59, 130, 246, 0.05);
    }
    
    /* Bouton d'ajout premium - plus compact */
    .add-button {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
        color: white;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
    }
    
    .add-button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .add-button:hover::before {
        left: 100%;
    }
    
    .add-button:hover {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1);
    }
    
    .add-button:active {
        transform: translateY(0) scale(1);
    }
    
    /* Responsive design - plus compact */
    @media (max-width: 1024px) {
        .catalog-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    }
    
    @media (max-width: 768px) {
        .catalog-grid {
            grid-template-columns: 1fr;
        }
        
        .article-card {
            margin: 0 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-content transition-all duration-300" id="mainContent">
        <!-- En-tête avec informations de renvoi -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 text-white p-6 rounded-xl shadow-lg" style="background: linear-gradient(to right, var(--preparation-primary), var(--preparation-light));">
        <div>
            <h1 class="text-3xl font-bold flex items-center mb-2">
                <i class="fas fa-edit mr-3"></i> Modifier Commande {{ commande.id_yz }}
                <button type="button" onclick="ouvrirModalInfoTotal()" class="ml-3 text-white/80 hover:text-white">
                    <i class="fas fa-info-circle text-lg"></i>
                </button>
            </h1>
            <p>Modification des détails de la commande en préparation</p>
            
            <!-- Badge de renvoi si applicable -->
            {% if is_commande_renvoyee %}
                <div class="mt-3 renvoi-badge inline-flex items-center px-3 py-1 rounded-full text-sm font-medium">
                    <i class="fas fa-undo mr-2"></i>
                    Commande renvoyée par la logistique
                </div>
            {% endif %}
        </div>
        <div class="flex items-center gap-4 mt-4 md:mt-0">
            <div class="text-right">
                <div class="text-2xl font-bold total-final-commande">{{ total_articles|add:commande.ville.frais_livraison|default:0|floatformat:2 }} DH</div>
                <div class="text-sm opacity-80">Total commande</div>
            </div>
            <div class="text-right">
                <div class="text-xl font-bold compteur-upsell" id="compteur-upsell-header">
                    {% if commande.compteur > 0 %}
                        <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                    {% else %}
                        <i class="fas fa-info-circle mr-1"></i>Aucun upsell
                    {% endif %}
                </div>
                <div class="text-sm opacity-80">Niveau upsell actuel</div>
            </div>
        </div>
    </div>

    <!-- Section d'alerte pour les commandes renvoyées -->
    {% if is_commande_renvoyee and operation_renvoi %}
        <div class="renvoi-alert rounded-lg p-4 mb-4 animate-slideInUp">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-amber-600 text-lg mr-3"></i>
                <div class="flex-1">
                    <h3 class="text-base font-bold text-amber-800 mb-1">
                        <i class="fas fa-undo mr-2"></i>Commande renvoyée pour modification
                    </h3>
                    <p class="text-sm text-amber-700 mb-1">{{ operation_renvoi.conclusion }}</p>
                    <div class="text-xs text-amber-600">
                        <i class="fas fa-clock mr-1"></i>
                        Renvoyée le {{ operation_renvoi.date_operation|date:"d/m/Y à H:i" }}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Section spéciale pour les commandes livrées partiellement -->
    {% if is_commande_livree_partiellement %}
    <div class="bg-orange-50 border-l-4 border-orange-400 rounded-lg p-6 mb-6 animate-slideInUp">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-full flex items-center justify-center bg-orange-100">
                    <i class="fas fa-exclamation-triangle text-orange-400 text-xl"></i>
                </div>
            </div>
            <div class="ml-4 flex-1">
                <h3 class="text-lg font-semibold text-orange-800 mb-3">Modification d'une Commande Livrée Partiellement</h3>
                
                <div class="bg-orange-100 border border-orange-200 p-4 rounded-lg mb-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-orange-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-orange-700">
                                <strong>Important :</strong> Cette commande a été livrée partiellement. Certains articles ont été livrés au client, d'autres ont été renvoyés pour correction.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Articles Livrés -->
                {% if articles_livres %}
                <div class="mb-4">
                    <h4 class="font-medium text-green-800 mb-2 flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-2"></i>
                        Articles Livrés au Client (Ne pas modifier)
                    </h4>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="space-y-2">
                            {% for article_data in articles_livres %}
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2 border border-green-200">
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 mr-3">
                                        <i class="fas fa-check-circle mr-1"></i>Livré
                                    </span>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900">{{ article_data.article.nom }}</div>
                                        <div class="text-xs text-gray-500">
                                            Réf: {{ article_data.article.reference }} | 
                                            {{ article_data.article.couleur }} | 
                                            {{ article_data.article.pointure }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-green-600">
                                        {{ article_data.quantite_livree }}x
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ article_data.prix|floatformat:2 }} DH
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Articles Renvoyés -->
                {% if articles_renvoyes %}
                <div class="mb-4">
                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                        <i class="fas fa-undo text-red-500 mr-2"></i>
                        Articles Renvoyés pour Correction
                    </h4>
                    <!-- DEBUG: Afficher la liste complète des articles_renvoyes -->
                    <pre style="background:#fff0f0;color:#b91c1c;padding:8px;border-radius:6px;font-size:12px;overflow-x:auto;">DEBUG articles_renvoyes: {{ articles_renvoyes|safe }}</pre>
                    <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                        <div class="space-y-2">
                            {% for article_data in articles_renvoyes %}
                            <!-- DEBUG: Afficher chaque article_data -->
                            <pre style="background:#fef9c3;color:#92400e;padding:4px 8px;border-radius:4px;font-size:11px;overflow-x:auto;">DEBUG article_data: {{ article_data|safe }}</pre>
                            <div class="flex items-center justify-between bg-white rounded px-3 py-2 border border-red-200">
                                <div class="flex items-center">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 mr-3">
                                        <i class="fas fa-undo mr-1"></i>Renvoyé
                                    </span>
                                    <div>
                                        <div class="text-sm font-medium text-gray-900 flex items-center">
                                            {{ article_data.article.nom }}
                                            {% if article_data.etat == 'defectueux' %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold bg-red-100 text-red-700 ml-3">
                                                    <i class="fas fa-times-circle mr-2"></i>Défectueux
                                                </span>
                                            {% elif article_data.etat == 'bon' %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-base font-bold bg-green-100 text-green-700 ml-3">
                                                    <i class="fas fa-check-circle mr-2"></i>Bon
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gray-100 text-gray-700 ml-3"><i class="fas fa-question-circle mr-2"></i>État inconnu: {{ article_data.etat }}</span>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            Réf: {{ article_data.article.reference }} | 
                                            {{ article_data.article.couleur }} | 
                                            {{ article_data.article.pointure }}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-medium text-red-600">
                                        {{ article_data.quantite }}x
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ article_data.prix|floatformat:2 }} DH
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-medium text-blue-800 mb-2 flex items-center">
                        <i class="fas fa-list-ol text-blue-500 mr-2"></i>
                        Actions de Modification Autorisées
                    </h4>
                    <ol class="text-sm text-blue-700 space-y-2 ml-6">
                        <li><strong>1.</strong> <span class="text-red-600 font-medium">Remplacer</span> les articles renvoyés par des articles disponibles</li>
                        <li><strong>2.</strong> <span class="text-red-600 font-medium">Modifier</span> les quantités des articles renvoyés</li>
                        <li><strong>3.</strong> <span class="text-red-600 font-medium">Supprimer</span> les articles renvoyés si non disponibles</li>
                        <li><strong>4.</strong> <span class="text-green-600 font-medium">Conserver</span> les articles déjà livrés</li>
                        <li><strong>5.</strong> <span class="text-blue-600 font-medium">Ajouter</span> de nouveaux articles si nécessaire</li>
                    </ol>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        <span class="text-sm font-medium text-yellow-800">Conseil :</span>
                    </div>
                    <p class="text-sm text-yellow-700 mt-1">
                        Utilisez les filtres et la recherche pour trouver rapidement des articles de remplacement. 
                        Vérifiez toujours la disponibilité en stock avant de faire des modifications.
                    </p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" id="modification-form">
        {% csrf_token %}
        <div class="space-y-6">
            
            <!-- Section Actions Rapides pour les commandes renvoyées -->
            {% if is_commande_renvoyee %}
                <div class="modification-section rounded-lg p-4 animate-slideInUp">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-semibold text-blue-800">
                            <i class="fas fa-tools mr-2"></i>Actions Rapides
                        </h3>
                        <button type="button" onclick="ouvrirModalAjoutArticle()" class="quick-action-btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="fas fa-plus mr-2"></i>Ajouter Article
                        </button>
                    </div>
                </div>
            {% endif %}

            <!-- Informations principales -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                    <h3 class="text-lg font-semibold mb-4 section-title">
                        <i class="fas fa-receipt mr-3"></i>Informations Commande
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ID YZ</label>
                            <input type="text" value="{{ commande.id_yz }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Numéro Commande</label>
                            <input type="text" value="{{ commande.num_cmd }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Commande</label>
                            <input type="text" value="{{ commande.date_cmd|date:'d/m/Y' }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total</label>
                            <input type="text" value="{{ commande.total_cmd|floatformat:2 }} DH" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                    <h3 class="text-lg font-semibold mb-4 section-title">
                        <i class="fas fa-user mr-3"></i>Client
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom</label>
                            <input type="text" name="client_nom" value="{{ commande.client.nom }}" readonly class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Prénom</label>
                            <input type="text" name="client_prenom" readonly value="{{ commande.client.prenom }}" class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Téléphone</label>
                            <input type="text" name="client_telephone" readonly value="{{ commande.client.numero_tel }}" class="w-full p-3 border bg-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ville Client</label>
                            <input type="text" value="{{ commande.ville_init|default:'Non spécifiée' }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                        </div>
                    </div>
                </div>
            </div>



            <!-- Livraison -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <h3 class="text-lg font-semibold mb-4 section-title">
                    <i class="fas fa-truck mr-3"></i>Livraison
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ville de livraison</label>
                        <select name="ville_id" id="ville-select" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Sélectionner une ville --</option>
                            {% for ville in villes %}
                                <option value="{{ ville.id }}" 
                                        data-region="{{ ville.region.nom_region }}" 
                                        data-frais="{{ ville.frais_livraison|default:0 }}"
                                        {% if commande.ville.id == ville.id %}selected{% endif %}>
                                    {{ ville.nom }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Région</label>
                        <input type="text" id="region-display" value="{{ commande.ville.region.nom_region }}" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Frais de livraison</label>
                        <input type="text" id="frais-display" value="{{ commande.ville.frais_livraison|default:0 }} DH" readonly class="w-full p-3 bg-gray-100 border rounded-lg text-gray-600">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Adresse de livraison</label>
                    <textarea name="adresse" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Adresse complète de livraison">{{ commande.adresse }}</textarea>
                </div>
            </div>

            <!-- Panier avec fonctionnalités améliorées et logique upsell -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold section-title">
                    <i class="fas fa-box mr-3"></i>Articles du Panier
                        <span class="text-sm font-normal text-gray-600 ml-2">
                            (<span id="articles-count">{{ paniers.count }}</span> article<span id="articles-plural">{{ paniers.count|pluralize }}</span>)
                        </span>
                        {% if commande.compteur > 0 %}
                        <span class="inline-flex items-center px-2 py-1 upsell-badge rounded-full text-sm font-medium ml-2">
                            <i class="fas fa-arrow-up mr-1"></i>Upsell Niveau {{ commande.compteur }}
                        </span>
                        {% endif %}
                        
                        <!-- Bouton de diagnostic du compteur upsell -->
                        <button type="button" onclick="diagnostiquerCompteur()" 
                                class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-medium ml-2 hover:bg-blue-200"
                                title="Diagnostiquer et corriger le compteur upsell">
                            <i class="fas fa-tools mr-1"></i>Diagnostic Upsell
                        </button>
                        
                        <!-- Bouton d'information sur la logique upsell -->
                        <button type="button" onclick="ouvrirModalInfoUpsell()" 
                                class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium ml-2 hover:bg-purple-200"
                                title="En savoir plus sur la logique upsell">
                            <i class="fas fa-info-circle mr-1"></i>Info Upsell
                        </button>
                        
                        <!-- Bouton de debug pour vérifier la base de données -->
                        <button type="button" onclick="verifierEtatBaseDeDonnees()" 
                                class="inline-flex items-center px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium ml-2 hover:bg-yellow-200"
                                title="Vérifier l'état de la base de données">
                            <i class="fas fa-database mr-1"></i>Debug DB
                        </button>
                        
                        <!-- Bouton pour forcer la synchronisation -->
                        <button type="button" onclick="forcerSynchronisation()" 
                                class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium ml-2 hover:bg-green-200"
                                title="Forcer la synchronisation des données">
                            <i class="fas fa-sync-alt mr-1"></i>Sync
                        </button>
                        
                        <!-- Bouton de debug pour les boutons d'ajout -->
                        <button type="button" onclick="debugBoutonsAjoutPanier()" 
                                class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium ml-2 hover:bg-purple-200"
                                title="Debugger les boutons d'ajout au panier">
                            <i class="fas fa-bug mr-1"></i>Debug Boutons
                        </button>
                        
                        <!-- Bouton pour vérifier les boutons dans le DOM -->
                        <button type="button" onclick="checkButtonsInDOM()" 
                                class="inline-flex items-center px-2 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-medium ml-2 hover:bg-orange-200"
                                title="Vérifier l'état des boutons dans le DOM">
                            <i class="fas fa-search mr-1"></i>Check DOM
                        </button>
                </h3>
                    <div class="flex gap-2">
                        <button type="button" class="btn-prepa px-3 py-2 rounded text-sm" onclick="ouvrirModalAjoutArticle()">
                            <i class="fas fa-plus mr-1"></i>Ajouter
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                <table class="w-full bg-white rounded-lg shadow-sm border border-gray-200 mb-4">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="px-4 py-3 text-left">Article</th>
                                <th class="px-4 py-3 text-left">Référence</th>
                                <th class="px-4 py-3 text-left">Couleur</th>
                                <th class="px-4 py-3 text-left">Pointure</th>
                                <th class="px-4 py-3 text-center">Quantité</th>
                                <th class="px-4 py-3 text-right">
                                    Prix 
                                    <button type="button" onclick="ouvrirModalInfoPrix()" class="ml-1 text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-right">
                                    Sous-total
                                    <button type="button" onclick="ouvrirModalInfoSousTotal()" class="ml-1 text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </th>
                                <th class="px-4 py-3 text-center w-36">État</th>
                                <th class="px-4 py-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for panier in paniers %}
                            <tr class="border-b border-gray-100 hover:bg-gray-50" data-panier-id="{{ panier.id }}" data-article-id="{{ panier.article.id }}">
                                <td class="px-4 py-3">
                                    <div class="font-medium flex items-center">
                                        {{ panier.article.nom }}
                                        {% if panier.article.isUpsell %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ml-2">
                                                <i class="fas fa-arrow-up mr-1"></i>Upsell
                                            </span>
                                        {% endif %}
                                        {% for article_data in articles_renvoyes %}
                                            {% if article_data.article.id == panier.article.id %}
                                                {% if article_data.etat == 'defectueux' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 ml-2">
                                                        <i class="fas fa-times-circle mr-1"></i>Défectueux
                                                    </span>
                                                {% elif article_data.etat == 'bon' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 ml-2">
                                                        <i class="fas fa-check-circle mr-1"></i>Bon
                                                    </span>
                                                {% elif article_data.etat == 'inconnu' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 ml-2">
                                                        <i class="fas fa-question-circle mr-1"></i>Inconnu
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% if panier.article.description %}
                                        <div class="text-sm text-gray-500">{{ panier.article.description|truncatechars:50 }}</div>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.reference }}</td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.couleur }}</td>
                                <td class="px-4 py-3 text-sm">{{ panier.article.pointure }}</td>
                                <td class="px-4 py-3 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <button type="button" onclick="modifierQuantite({{ panier.id }}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-red-200">-</button>
                                        <input type="number" id="quantite-{{ panier.id }}" value="{{ panier.quantite }}" min="1" max="99" 
                                               data-previous-value="{{ panier.quantite }}"
                                               class="w-16 text-center font-medium border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                                               onchange="modifierQuantiteDirecte({{ panier.id }}, this.value)"
                                               onblur="modifierQuantiteDirecte({{ panier.id }}, this.value)">
                                        <button type="button" onclick="modifierQuantite({{ panier.id }}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-green-200">+</button>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    {% load commande_filters %}
                                    {% with prix_info=panier.article|get_prix_avec_phase_info:commande.compteur %}
                                        <div class="text-right">
                                            <div class="font-medium prix-{{ prix_info.type }}" id="prix-unitaire-{{ panier.id }}">
                                                {{ prix_info.prix|floatformat:2 }} DH
                                            </div>
                                            {% if prix_info.libelle != "Prix normal" %}
                                                <div class="text-xs prix-{{ prix_info.type }} flex items-center justify-end gap-1" id="prix-libelle-{{ panier.id }}">
                                                    {% if panier.article.isUpsell and commande.compteur > 0 %}
                                                        <i class="fas fa-arrow-up"></i>
                                                    {% elif panier.article.has_promo_active %}
                                                        <i class="fas fa-fire"></i>
                                                    {% elif panier.article.phase == 'LIQUIDATION' %}
                                                        <i class="fas fa-percentage"></i>
                                                    {% elif panier.article.phase == 'EN_TEST' %}
                                                        <i class="fas fa-flask"></i>
                                                    {% endif %}
                                                    {{ prix_info.libelle}}
                                                </div>
                                            {% endif %}
                                            {% if panier.article.prix_unitaire != prix_info.prix %}
                                                <div class="text-xs text-gray-400 line-through">{{ panier.article.prix_unitaire|floatformat:2 }} DH</div>
                                            {% endif %}
                                        </div>
                                    {% endwith %}
                                </td>
                                <td class="px-4 py-3 text-right font-bold" id="sous-total-{{ panier.id }}">{{ panier.sous_total|floatformat:2 }} DH</td>
                                <td class="px-4 py-3 text-center">
                                    <div class="flex flex-col gap-1">
                                        <!-- État de l'article (phase) -->
                                        {% if panier.article.phase == 'EN_COURS' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">
                                                <i class="fas fa-play-circle mr-1"></i>En Cours
                                            </span>
                                        {% elif panier.article.phase == 'LIQUIDATION' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                                                <i class="fas fa-percentage mr-1"></i>Liquidation
                                            </span>
                                        {% elif panier.article.phase == 'EN_TEST' %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">
                                                <i class="fas fa-flask mr-1"></i>Test
                                            </span>
                                        {% else %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">
                                                <i class="fas fa-question-circle mr-1"></i>{{ panier.article.phase }}
                                            </span>
                                        {% endif %}
                                        
                                        <!-- État de retour (si applicable) -->
                                    {% for article_data in articles_renvoyes %}
                                        {% if article_data.article.id == panier.article.id %}
                                            {% if article_data.etat == 'defectueux' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-200 text-red-800">
                                                        <i class="fas fa-exclamation-triangle mr-1"></i>Défectueux
                                                </span>
                                            {% elif article_data.etat == 'bon' %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-green-200 text-green-800">
                                                        <i class="fas fa-check-circle mr-1"></i>Retour Bon
                                                </span>
                                            {% else %}
                                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-200 text-gray-800">
                                                        <i class="fas fa-question-circle mr-1"></i>{{ article_data.etat }}
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                        
                                        <!-- État upsell (si applicable) -->
                                        {% if panier.article.isUpsell %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                                                <i class="fas fa-arrow-up mr-1"></i>Upsell
                                            </span>
                                    {% endif %}
                                        
                                        <!-- État promotion (si applicable) -->
                                        {% if panier.article.has_promo_active %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                                                <i class="fas fa-fire mr-1"></i>Promo
                                            </span>
                                        {% endif %}
                                        
                                        <!-- État du stock (si rupture) -->
                                        {% if panier.article.qte_disponible <= 0 %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Rupture
                                            </span>
                                        {% elif panier.article.qte_disponible <= 5 %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                                                <i class="fas fa-exclamation mr-1"></i>Stock Faible
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <button type="button" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" onclick="supprimerArticle({{ panier.id }})" title="Supprimer cet article">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-box-open text-3xl mb-2"></i>
                                    <div>Aucun article dans le panier</div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                </div>
                
                <div class="flex justify-between items-center mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        <span id="articles-count-bottom">{{ paniers.count }}</span> article<span id="articles-plural-bottom">{{ paniers.count|pluralize }}</span> dans le panier
                        {% if commande.compteur > 0 %}
                            <span class="ml-2 text-purple-600 font-medium" id="upsell-badge-container">
                                <i class="fas fa-arrow-up mr-1"></i>
                                Upsell niveau <span id="niveau-upsell-dashboard">{{ commande.compteur }}</span>
                            </span>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Total articles</div>
                        <div class="text-2xl font-bold text-blue-600 total-commande" id="sous-total-articles">{{ commande.sous_total_articles|floatformat:2 }} DH</div>
                        <div class="text-sm text-gray-500 total-livraison">+ {{ commande.ville.frais_livraison|default:0|floatformat:2 }} DH livraison</div>
                        <div class="text-lg font-bold text-green-600 total-final-commande" id="total-commande">{{ commande.total_cmd|floatformat:2 }} DH</div>
                        <button type="button" onclick="ouvrirModalInfoTotal()" class="text-xs text-blue-500 hover:text-blue-700 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>Détails
                        </button>
                    </div>
                </div>
            </div>

















            <!-- Section Commentaires -->
            <div class="bg-white rounded-xl shadow-lg p-4 animate-slideInUp">
                <h3 class="text-lg font-semibold mb-4 section-title">
                    <i class="fas fa-sticky-note mr-3"></i>Commentaires
                </h3>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire opérateur <span class="text-gray-500">(optionnel)</span></label>
                    <textarea name="commentaire_operateur" rows="3" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ajouter un commentaire sur les modifications effectuées..."></textarea>
                </div>
            </div>

            <!-- Boutons d'action -->
            <div class="flex justify-between items-center mt-6 p-6 bg-gray-50 rounded-xl">
                <div class="flex gap-3">
                    <a href="{% url 'Superpreparation:detail_prepa' commande.id %}" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Retour
                    </a>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-prepa px-8 py-3 rounded-lg text-lg font-bold">
                        <i class="fas fa-check mr-2"></i>Enregistrer les modifications
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modales améliorées -->
<div id="modalAjoutArticle" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold section-title">Ajouter un article</h3>
                    <button type="button" onclick="fermerModalAjoutArticle()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rechercher un article</label>
                    <div class="relative">
                        <input type="text" id="searchArticle" placeholder="Nom, référence, couleur, pointure..." 
                               class="w-full p-4 border rounded-lg pl-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                
                <!-- Légende des types d'articles -->
                <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex items-center mb-2">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <span class="text-sm font-medium text-blue-800">Légende des types d'articles :</span>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                        <div class="flex items-center">
                            <i class="fas fa-box text-gray-600 mr-1"></i>
                            <span class="text-gray-700">Normal</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-arrow-up text-purple-600 mr-1"></i>
                            <span class="text-green-500">Upsell</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-fire text-orange-600 mr-1"></i>
                            <span class="text-orange-700">Promotion</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-money-bill-wave text-red-600 mr-1"></i>
                            <span class="text-red-700">Liquidation</span>
                        </div>
                    </div>
                </div>

                <!-- Filtres rapides -->
                <div class="mb-4 flex flex-wrap gap-2">
                    <button type="button" onclick="filtrerArticles('tous')" class="filter-btn active px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-search mr-1"></i>
                        TOUS
                        <span class="ml-1 bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-tous">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('disponible')" class="filter-btn px-3 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-check-circle mr-1"></i>
                        En stock
                        <span class="ml-1 bg-gray-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-disponible">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('promo')" class="filter-btn px-3 py-2 bg-orange-200 text-orange-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-fire mr-1"></i>
                        PROMO
                        <span class="ml-1 bg-orange-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-promo">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('upsell')" class="filter-btn px-3 py-2 bg-green-500 text-green-800 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-arrow-up mr-1"></i>
                        UPSELL
                        <span class="ml-1 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-upsell">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('liquidation')" class="filter-btn px-3 py-2 bg-red-200 text-red-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-money-bill-wave mr-1"></i>
                        LIQUIDATION
                        <span class="ml-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-liquidation">0</span>
                    </button>
                    <button type="button" onclick="filtrerArticles('test')" class="filter-btn px-3 py-2 bg-yellow-200 text-yellow-700 rounded-lg text-sm font-medium flex items-center">
                        <i class="fas fa-flask mr-1"></i>
                        TEST
                        <span class="ml-1 bg-yellow-500 text-white text-xs px-2 py-0.5 rounded-full" id="count-test">0</span>
                    </button>
                </div>
                
                <div id="articlesList" class="max-h-96 overflow-y-auto"></div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="fermerModalAjoutArticle()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Annuler</button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Modales d'information sur les calculs -->
<div id="modalInfoPrix" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-tag text-blue-500 mr-2"></i>Comment sont calculés les prix unitaires ?
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Prix de base</h4>
                        <p class="text-sm text-blue-700">Le prix unitaire défini pour chaque article.</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800 mb-2">
                            <i class="fas fa-arrow-up mr-1"></i>Prix Upsell (niveau {{ commande.compteur }})
                        </h4>
                        <p class="text-sm text-purple-700">
                            {% if commande.compteur > 0 %}
                                Les articles upsell bénéficient d'un prix réduit selon le niveau atteint dans la commande.
                                <br><strong>Logique simplifiée :</strong> prix_actuel par défaut, prix upsell seulement pour les articles marqués "Upsell".
                            {% else %}
                                Aucun niveau upsell actif pour cette commande.
                                <br><strong>Logique simplifiée :</strong> tous les articles utilisent leur prix_actuel.
                            {% endif %}
                        </p>
                    </div>
                    
                    <div class="bg-red-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-red-800 mb-2">
                            <i class="fas fa-fire mr-1"></i>Prix Promotionnel
                        </h4>
                        <p class="text-sm text-red-700">Articles en promotion avec réduction appliquée.</p>
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-orange-800 mb-2">
                            <i class="fas fa-percentage mr-1"></i>Prix Liquidation
                        </h4>
                        <p class="text-sm text-orange-700">Articles en liquidation avec forte réduction.</p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoPrix()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalInfoSousTotal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-calculator text-green-500 mr-2"></i>Calcul des sous-totaux
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-green-800 mb-2">Formule de base</h4>
                        <p class="text-sm text-green-700 font-mono bg-white p-2 rounded border">
                            Sous-total = Prix unitaire × Quantité
                        </p>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-2">Prise en compte automatique</h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li>• Réductions promotionnelles</li>
                            <li>• Prix upsell selon le niveau de la commande</li>
                            <li>• Prix de liquidation</li>
                            <li>• Prix de test</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoSousTotal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalInfoTotal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-receipt text-purple-500 mr-2"></i>Détail complet du calcul - Commande {{ commande.id_yz }}
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Résumé des articles -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-list mr-2"></i>Articles de la commande
                        </h4>
                        {% for panier in paniers %}
                            {% load commande_filters %}
                            {% with prix_info=panier.article|get_prix_avec_phase_info:commande.compteur %}
                            <div class="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                                <div class="flex-1">
                                    <div class="font-medium">{{ panier.article.nom }}</div>
                                    <div class="text-sm text-gray-500">{{ panier.quantite }} × {{ prix_info.prix|floatformat:2 }} DH</div>
                                    {% if prix_info.libelle != "Prix normal" %}
                                        <div class="text-xs {{ prix_info.couleur_classe }}">{{ prix_info.libelle }}</div>
                                    {% endif %}
                                </div>
                                <div class="text-right font-semibold">{{ panier.sous_total|floatformat:2 }} DH</div>
                            </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                    
                    <!-- Calcul du total -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-blue-800 mb-3">
                            <i class="fas fa-calculator mr-2"></i>Calcul du total
                        </h4>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span>Sous-total articles :</span>
                                <span class="font-semibold">{{ total_articles|floatformat:2 }} DH</span>
                            </div>
                            {% if commande.ville.frais_livraison > 0 %}
                                <div class="flex justify-between">
                                    <span>Frais de livraison ({{ commande.ville.nom }}) :</span>
                                    <span class="font-semibold">+ {{ commande.ville.frais_livraison|floatformat:2 }} DH</span>
                                </div>
                            {% endif %}
                            <div class="border-t border-blue-300 pt-2 flex justify-between text-lg font-bold text-blue-800">
                                <span>Total final :</span>
                                <span>{{ total_articles|add:commande.ville.frais_livraison|default:0|floatformat:2 }} DH</span>
                            </div>
                        </div>
                    </div>
                    
                    {% if commande.compteur > 0 %}
                    <!-- Informations sur l'upsell -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-purple-800 mb-2">
                            <i class="fas fa-arrow-up mr-2"></i>Niveau Upsell {{ commande.compteur }}
                        </h4>
                        <p class="text-sm text-purple-700">
                            Cette commande bénéficie du niveau upsell {{ commande.compteur }}, 
                            appliquant automatiquement les prix réduits aux articles éligibles.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoTotal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation améliorée -->
<div id="modalConfirmation" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div class="p-6 text-center">
                <i class="fas fa-question-circle text-4xl text-yellow-500 mb-4"></i>
                <h3 class="text-xl font-semibold mb-2">Confirmation</h3>
                <p id="messageConfirmation" class="text-gray-600 mb-6"></p>
                <div class="flex justify-center space-x-3">
                    <button type="button" onclick="fermerModalConfirmation()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">Annuler</button>
                    <button type="button" id="btnConfirmer" 
                            class="btn-prepa px-4 py-2 rounded-lg">Confirmer</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'information sur la logique upsell -->
<div id="modalInfoUpsell" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-arrow-up text-orange-500 mr-2"></i>Système de Compteur Upsell
                    </h3>
                    <button type="button" onclick="fermerModalInfoUpsell()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-6">
                    <!-- Explication générale -->
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-semibold text-blue-800 mb-2 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>Qu'est-ce que le compteur upsell ?
                        </h4>
                        <p class="text-blue-700 text-sm">
                            Le compteur upsell détermine automatiquement le niveau de réduction appliqué aux articles upsell 
                            selon le nombre total d'unités d'articles upsell dans la commande.
                            <br><br><strong>Logique simplifiée :</strong>
                            <br>• Articles normaux → Utilisent leur <strong>prix_actuel</strong>
                            <br>• Articles upsell → Utilisent les <strong>prix upsell</strong> selon le compteur
                        </p>
                    </div>

                    <!-- Logique de calcul -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>Logique de calcul du compteur (basée sur l'opérateur de confirmation)
                        </h4>
                        <div class="space-y-2 text-sm text-green-700">
                            <div class="flex items-center">
                                <span class="font-medium w-32">0-1 unité :</span>
                                <span>Compteur = 0 (pas de réduction)</span>
                            </div>
                            <div class="flex items-center">
                                <span class="font-medium w-32">2+ unités :</span>
                                <span>Compteur = Nombre total d'unités - 1</span>
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-white rounded border border-green-300">
                            <div class="text-xs font-mono text-green-800">
                                <strong>Exemple :</strong> 5 unités d'articles upsell → Compteur = 4 → Niveau 4
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-100 rounded border border-blue-300">
                            <div class="text-xs text-blue-800">
                                <strong>Logique identique à l'opérateur de confirmation :</strong>
                                <br>• Compteur basé sur le total des unités d'articles upsell
                                <br>• Recalcul automatique de tous les prix après chaque modification
                                <br>• Prix upsell appliqués selon le niveau du compteur
                            </div>
                        </div>
                    </div>

                    <!-- Niveaux de prix -->
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                        <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
                            <i class="fas fa-tags mr-2"></i>Niveaux de prix upsell
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 1</div>
                                <div class="text-gray-600">Prix upsell 1 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 2</div>
                                <div class="text-gray-600">Prix upsell 2 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 3</div>
                                <div class="text-gray-600">Prix upsell 3 appliqué</div>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <div class="font-medium text-orange-700">Niveau 4+</div>
                                <div class="text-gray-600">Prix upsell 4 appliqué</div>
                            </div>
                        </div>
                    </div>

                    <!-- État actuel -->
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-semibold text-purple-800 mb-2 flex items-center">
                            <i class="fas fa-chart-line mr-2"></i>État actuel de la commande
                        </h4>
                        <div class="space-y-2 text-sm text-purple-700">
                            <div class="flex justify-between">
                                <span>Compteur actuel :</span>
                                <span class="font-bold">{{ commande.compteur }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Articles upsell :</span>
                                <span class="font-bold">{{ paniers|length }} article(s)</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Total unités upsell :</span>
                                <span class="font-bold">
                                    {% with total_upsell=0 %}
                                        {% for panier in paniers %}
                                            {% if panier.article.isUpsell %}
                                                {% with total_upsell=total_upsell|add:panier.quantite %}{% endwith %}
                                            {% endif %}
                                        {% endfor %}
                                        {{ total_upsell }}
                                    {% endwith %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions disponibles -->
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <h4 class="font-semibold text-yellow-800 mb-2 flex items-center">
                            <i class="fas fa-tools mr-2"></i>Actions disponibles
                        </h4>
                        <div class="space-y-2 text-sm text-yellow-700">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Diagnostic automatique du compteur</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Correction automatique si nécessaire</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Mise à jour dynamique des prix</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span>Recalcul automatique des totaux</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 text-right">
                <button type="button" onclick="fermerModalInfoUpsell()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Fermer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
// Fonctions globales pour les `onclick` - définies en dehors du DOMContentLoaded
    window.ouvrirModalAjoutArticle = function() {
        console.log('🔧 Fonction ouvrirModalAjoutArticle appelée');
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) {
            modal.classList.remove('hidden');
        if (typeof chargerArticlesDisponibles === 'function') {
            chargerArticlesDisponibles();
        }
        } else {
            console.error('❌ Modal modalAjoutArticle non trouvée');
        }
    };

    window.fermerModalAjoutArticle = function() {
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) modal.classList.add('hidden');
    
        // Réinitialiser les variantes sélectionnées
        window.selectedArticleWithVariant = null;
        window._varianteSelection = {};
        
        // Réinitialiser l'affichage des boutons
        const boutonsAjouterPanier = document.querySelectorAll('[id^="btn-ajouter-panier-"]');
        boutonsAjouterPanier.forEach(btn => {
            btn.classList.add('hidden');
            btn.classList.remove('inline-flex');
        });
        
        // Réafficher tous les boutons "Sélectionner"
        const boutonsSelectionner = document.querySelectorAll('[id^="btn-selectionner-"]');
        boutonsSelectionner.forEach(btn => {
            btn.classList.remove('hidden');
        });
        
        // Masquer tous les boutons "Choisir variante"
        const boutonsVariantes = document.querySelectorAll('[id^="btn-variantes-"]');
        boutonsVariantes.forEach(btn => {
            btn.classList.add('hidden');
            btn.classList.remove('inline-flex');
        });
        
        // Recharger la liste des articles pour réinitialiser l'affichage
        if (typeof chargerArticlesDisponibles === 'function') {
            chargerArticlesDisponibles();
        }
    };

// Initialisation des variables globales
window.selectedArticleWithVariant = null;
window._varianteSelection = {};

// Fonctions de base pour les modales
window.ouvrirModalConfirmation = function(message, action) {
    const msgElem = document.getElementById('messageConfirmation');
    if (msgElem) msgElem.textContent = message;
    const btnConfirm = document.getElementById('btnConfirmer');
    if (btnConfirm) btnConfirm.onclick = action;
    const modal = document.getElementById('modalConfirmation');
    if (modal) modal.classList.remove('hidden');
};

window.fermerModalConfirmation = function() {
    const modal = document.getElementById('modalConfirmation');
    if (modal) modal.classList.add('hidden');
};

// Fonction de base pour changer la quantité
window.changeQuantite = function(articleId, delta) {
    const input = document.getElementById(`qte-article-${articleId}`);
    if (input) {
        const newValue = Math.max(1, parseInt(input.value) + delta);
        input.value = newValue;
    }
};

// Fonction pour charger les articles disponibles
window.chargerArticlesDisponibles = function(filterType = 'tous') {
    console.log(`🔄 Chargement des articles avec filtre: ${filterType}`);
    const url = new URL("{% url 'Superpreparation:api_articles_disponibles_prepa' %}", window.location.origin);
    url.searchParams.set('filter', filterType);
    console.log(`🌐 URL de l'API: ${url.toString()}`);
    
    fetch(url)
        .then(response => {
            console.log(`📡 Réponse reçue, status: ${response.status}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📥 Données brutes reçues:', data);
            
            // Gestion des deux formats possibles (tableau direct ou objet avec propriété articles)
            let articles = [];
            if (Array.isArray(data)) {
                articles = data;
                console.log(`📦 ${articles.length} article(s) trouvé(s) (format tableau)`);
            } else if (data.success && data.articles) {
                articles = data.articles;
                console.log(`📦 ${articles.length} article(s) trouvé(s) (format objet)`);
            } else {
                console.warn('⚠️ Format de données inattendu:', data);
                console.log('🔍 Propriétés disponibles:', Object.keys(data));
                return;
            }
            
            console.log(`🎯 Articles à afficher:`, articles);
            window.articlesDisponibles = articles;
            if (typeof window.afficherArticles === 'function') {
                window.afficherArticles(articles);
            } else {
                console.error('❌ Fonction afficherArticles non trouvée');
            }
            
            // Calculer les statistiques basiques si pas fournies
            if (!data.stats) {
                const stats = {
                    'tous': articles.length,
                    'disponible': articles.filter(a => a.qte_disponible > 0).length,
                    'upsell': articles.filter(a => a.isUpsell).length,
                    'promo': articles.filter(a => a.has_reduction).length,
                    'liquidation': articles.filter(a => a.phase === 'LIQUIDATION').length,
                    'test': articles.filter(a => a.phase === 'EN_TEST').length
                };
                if (typeof window.mettreAJourStatistiques === 'function') {
                    window.mettreAJourStatistiques(stats);
                }
            } else {
                if (typeof window.mettreAJourStatistiques === 'function') {
                    window.mettreAJourStatistiques(data.stats);
                }
            }
            
            if (typeof window.mettreAJourFiltreActif === 'function') {
                window.mettreAJourFiltreActif(filterType);
            }
        }).catch(error => console.error('Erreur de chargement des articles:', error));
};

document.addEventListener('DOMContentLoaded', function() {
    let commandeId = {{ commande.id }};
    let articlesDisponibles = [];
    let modificationsQuantites = {};
    let compteurCommande = {{ commande.compteur|default:0 }};

    // Fonction pour diagnostiquer le compteur upsell
    window.diagnostiquerCompteur = function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Afficher un indicateur de chargement
        const diagnosticBtn = document.querySelector('[onclick="diagnostiquerCompteur()"]');
        const originalText = diagnosticBtn.innerHTML;
        diagnosticBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Diagnostic...';
        diagnosticBtn.disabled = true;
        
        fetch(`{% url "Superpreparation:diagnostiquer_compteur" commande.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Diagnostic upsell:', data.message);
                
                // Afficher le résultat avec mise à jour dynamique
                if (data.ancien_compteur !== undefined) {
                    // Utiliser l'animation pour la mise à jour du compteur
                    mettreAJourCompteurAvecAnimation(data.ancien_compteur, data.nouveau_compteur);
                    
                    // Afficher un résumé détaillé
                    afficherResumeDiagnostic(data);
                    
                    // Mise à jour dynamique au lieu de recharger la page
                    const updatedData = {
                        compteur: data.nouveau_compteur,
                        total_commande: data.total_commande || document.querySelector('.total-final-commande')?.textContent?.replace(' DH', ''),
                        articles_count: data.articles_count,
                        sous_total_articles: data.sous_total_articles
                    };
                    
                    // Appeler la fonction de mise à jour centralisée
                    mettreAJourTousLesTotaux(updatedData);
                    
                    // Rafraîchir la section des articles pour voir les prix upsell mis à jour
                    setTimeout(() => {
                        rafraichirSectionArticles();
                    }, 2000);
                    
                } else {
                    // Afficher un résumé même si pas de correction
                    afficherResumeDiagnostic(data);
                    
                    // Même si pas de correction, s'assurer que l'affichage est correct
                    const currentData = {
                        compteur: data.compteur,
                        total_commande: data.total_commande,
                        articles_count: data.articles_count,
                        sous_total_articles: data.sous_total_articles
                    };
                    mettreAJourTousLesTotaux(currentData);
                }
            } else {
                console.error('❌ Erreur:', data.error);
                showNotificationToast('❌ Erreur lors du diagnostic: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau:', error);
            showNotificationToast('❌ Erreur de réseau lors du diagnostic', 'error');
        })
        .finally(() => {
            // Restaurer le bouton
            diagnosticBtn.innerHTML = originalText;
            diagnosticBtn.disabled = false;
        });
    };

    // Fonction pour mettre à jour tous les totaux et le compteur
    function mettreAJourTousLesTotaux(data) {
        console.log('🔄 Mise à jour des totaux:', data);
        
        // Mettre à jour le compteur upsell
        if (data.compteur !== undefined) {
            compteurCommande = data.compteur;
            mettreAJourCompteurUpsell(data.compteur);
        }
        
        // Mettre à jour le total des articles
        if (data.sous_total_articles !== undefined) {
            const totalElements = document.querySelectorAll('.total-commande');
            totalElements.forEach(element => {
                element.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le total final
        if (data.total_commande !== undefined) {
            const totalFinals = document.querySelectorAll('.total-final-commande');
            totalFinals.forEach(element => {
                element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le nombre d'articles
        if (data.articles_count !== undefined) {
            const articlesCount = document.getElementById('articles-count');
            const articlesPlural = document.getElementById('articles-plural');
            if (articlesCount) {
                articlesCount.textContent = data.articles_count;
            }
            if (articlesPlural) {
                articlesPlural.textContent = data.articles_count > 1 ? 's' : '';
            }
        }
        
        console.log('✅ Tous les totaux mis à jour:', {
            sous_total_articles: data.sous_total_articles,
            total_commande: data.total_commande,
            articles_count: data.articles_count,
            compteur: data.compteur
        });
    }

    // Fonction pour mettre à jour le compteur upsell dans tous les endroits
    function mettreAJourCompteurUpsell(nouveauCompteur) {
        console.log(`🔄 Mise à jour du compteur upsell: ${nouveauCompteur}`);
        
        // Mettre à jour la variable globale
        compteurCommande = nouveauCompteur;
        
        // Mettre à jour l'en-tête du compteur
        const compteurHeader = document.getElementById('compteur-upsell-header');
        if (compteurHeader) {
            if (nouveauCompteur > 0) {
                compteurHeader.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau ${nouveauCompteur}`;
            } else {
                compteurHeader.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Aucun upsell`;
            }
            
            // Ajouter une animation de mise à jour
            compteurHeader.classList.add('updated');
            setTimeout(() => {
                compteurHeader.classList.remove('updated');
            }, 1000);
        }
        
        // Mettre à jour les prix unitaires
        mettreAJourPrixUnitaires(nouveauCompteur);
        
        console.log(`✅ Compteur upsell mis à jour vers: ${nouveauCompteur}`);
    }

    // Fonction pour mettre à jour dynamiquement les prix unitaires
    function mettreAJourPrixUnitaires(nouveauCompteur) {
        console.log(`🔄 Mise à jour des prix unitaires pour le compteur: ${nouveauCompteur}`);
        
        // Faire un appel AJAX pour récupérer les prix mis à jour depuis le serveur
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(`{% url "Superpreparation:api_prix_upsell_articles" commande.id %}`, {
            method: 'GET',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('✅ Prix récupérés depuis le serveur:', data.message);
                console.log('📊 Données reçues:', data.prix_articles);
                
                // Mettre à jour chaque article avec les nouveaux prix
                Object.keys(data.prix_articles).forEach(panierId => {
                    const prixInfo = data.prix_articles[panierId];
                    const prixElement = document.getElementById(`prix-unitaire-${panierId}`);
                    const libelleElement = document.getElementById(`prix-libelle-${panierId}`);
                    const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
                    
                    if (prixElement) {
                        // S'assurer que le prix est un nombre
                        const prix = parseFloat(prixInfo.prix) || 0;
                        const sousTotal = parseFloat(prixInfo.sous_total) || 0;
                        
                        console.log(`🔍 Traitement article ${panierId}:`, {
                            prix_original: prixInfo.prix,
                            prix_converti: prix,
                            sous_total_original: prixInfo.sous_total,
                            sous_total_converti: sousTotal,
                            type: prixInfo.type
                        });
                        
                        // Mettre à jour le prix
                        prixElement.textContent = `${prix.toFixed(2)} DH`;
                        prixElement.className = `font-medium prix-${prixInfo.type}`;
                        
                        // Mettre à jour le libellé
                        if (libelleElement) {
                            if (prixInfo.libelle !== "Prix normal") {
                                libelleElement.innerHTML = `<i class="${prixInfo.icone}"></i> ${prixInfo.libelle}`;
                                libelleElement.className = `text-xs prix-${prixInfo.type} flex items-center justify-end gap-1`;
                                if (libelleElement.style) {
                                    libelleElement.style.display = 'block';
                                }
                            } else {
                                if (libelleElement.style) {
                                    libelleElement.style.display = 'none';
                                }
                            }
                        }
                        
                        // Mettre à jour le sous-total
                        if (sousTotalElement) {
                            sousTotalElement.textContent = `${sousTotal.toFixed(2)} DH`;
                        }
                        
                        console.log(`✅ Prix mis à jour pour article ${panierId}: ${prixInfo.prix.toFixed(2)} DH (${prixInfo.libelle})`);
                    }
                });
                
                // Mettre à jour le total de la commande
                mettreAJourTotalCommande();
                
            } else {
                console.error('❌ Erreur lors de la récupération des prix:', data.error);
            }
        })
        .catch(error => {
            console.error('❌ Erreur réseau lors de la récupération des prix:', error);
        });
    }



    // Fonction pour mettre à jour le sous-total d'un article
    function mettreAJourSousTotalArticle(panierId, prixUnitaire) {
        const sousTotalElement = document.getElementById(`sous-total-${panierId}`);
        if (sousTotalElement) {
            // Récupérer la quantité depuis l'input
            const quantiteInput = document.getElementById(`quantite-${panierId}`);
            const quantite = quantiteInput ? parseInt(quantiteInput.value) || 1 : 1;
            
            // Calculer le nouveau sous-total
            const nouveauSousTotal = prixUnitaire * quantite;
            
            // Mettre à jour l'affichage
            sousTotalElement.textContent = `${nouveauSousTotal.toFixed(2)} DH`;
            
            console.log(`✅ Sous-total mis à jour pour article ${panierId}: ${nouveauSousTotal.toFixed(2)} DH`);
        }
    }

    // Fonction pour mettre à jour le total de la commande
    function mettreAJourTotalCommande() {
        console.log('🔄 Mise à jour du total de la commande...');
        
        // Récupérer tous les sous-totaux
        const sousTotalElements = document.querySelectorAll('[id^="sous-total-"]');
        let totalArticles = 0;
        
        sousTotalElements.forEach(element => {
            const sousTotalText = element.textContent.replace(' DH', '');
            const sousTotal = parseFloat(sousTotalText) || 0;
            totalArticles += sousTotal;
        });
        
        // Mettre à jour l'affichage du total
        const totalElements = document.querySelectorAll('.total-commande');
        totalElements.forEach(element => {
            element.textContent = `${totalArticles.toFixed(2)} DH`;
        });
        
        // Calculer le total final avec livraison
        const fraisLivraisonElement = document.querySelector('.total-livraison');
        let fraisLivraison = 0;
        if (fraisLivraisonElement) {
            const livraisonMatch = fraisLivraisonElement.textContent.match(/\+ ([\d.]+) DH/);
            fraisLivraison = parseFloat(livraisonMatch?.[1] || 0);
        }
        
        const totalFinal = totalArticles + fraisLivraison;
        
        const totalFinalElements = document.querySelectorAll('.total-final-commande');
        totalFinalElements.forEach(element => {
            element.textContent = `Total: ${totalFinal.toFixed(2)} DH`;
        });
        
        console.log(`✅ Total mis à jour: ${totalArticles.toFixed(2)} DH + ${fraisLivraison.toFixed(2)} DH livraison = ${totalFinal.toFixed(2)} DH`);
    }

    // Fonction pour rafraîchir la section des articles (utilisée seulement en cas de problème)
    function rafraichirSectionArticles() {
        console.log('🔄 Rafraîchissement complet de la section des articles...');
        
        // Trouver le conteneur des articles (tableau principal)
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
            console.error('❌ Conteneur d\'articles introuvable');
            showNotificationToast('❌ Erreur lors du rafraîchissement: conteneur introuvable', 'error');
            return;
        }
        
        // Afficher un indicateur de chargement
        const originalContent = tableBody.innerHTML;
        tableBody.innerHTML = '<tr><td colspan="9" class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-gray-500"></i><p class="mt-2">Rafraîchissement en cours...</p></td></tr>';

        fetch(`{% url 'Superpreparation:rafraichir_articles_commande_prepa' commande.id %}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Mettre à jour la liste des articles avec le HTML du serveur
                    tableBody.innerHTML = data.html;

                    // Utiliser la fonction centralisée pour mettre à jour tous les totaux
                    mettreAJourTousLesTotaux(data);

                    showNotificationToast('🔄 Section des articles mise à jour.', 'info');
                    
                    // Déclencher des événements personnalisés pour d'autres scripts qui pourraient écouter
                    window.dispatchEvent(new CustomEvent('articlesRefreshed', { 
                        detail: { 
                            articles_count: data.articles_count,
                            total_commande: data.total_commande,
                            sous_total_articles: data.sous_total_articles,
                            compteur: data.compteur
                        }
                    }));
                } else {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 bg-red-100 text-red-700 rounded-lg">${data.error || 'Erreur inconnue'}</td></tr>`;
                    showNotificationToast(`❌ Erreur de rafraîchissement: ${data.error || 'Erreur inconnue'}`, 'error');
                }
            })
            .catch(error => {
                console.error('Erreur de rafraîchissement:', error);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 bg-red-100 text-red-700 rounded-lg">
                    <div class="font-bold mb-2">Erreur de connexion</div>
                    <div class="text-sm">${error.message || 'Impossible de contacter le serveur'}</div>
                    <button onclick="rafraichirSectionArticles()" class="mt-3 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
                        <i class="fas fa-sync-alt mr-1"></i>Réessayer
                    </button>
                </td></tr>`;
                showNotificationToast('❌ Erreur de connexion lors du rafraîchissement.', 'error');
            });
    }

    // Fonction pour mettre à jour une ligne d'article spécifique
    function mettreAJourLigneArticle(panierId, nouvelleQuantite, nouveauSousTotal, nouveauPrix) {
        const ligne = document.querySelector(`tr[data-panier-id="${panierId}"]`);
        if (!ligne) {
            console.warn(`Ligne pour panier ${panierId} non trouvée`);
            return;
        }
        
        // Mettre à jour la quantité
        const quantiteInput = ligne.querySelector('input[type="number"]');
        if (quantiteInput) {
            quantiteInput.value = nouvelleQuantite;
        }
        
        // Mettre à jour le prix unitaire
        const prixCell = ligne.querySelector('.prix-unitaire');
        if (prixCell && nouveauPrix !== undefined) {
            prixCell.textContent = `${parseFloat(nouveauPrix).toFixed(2)} DH`;
        }
        
        // Mettre à jour le sous-total
        const sousTotalCell = ligne.querySelector('.sous-total');
        if (sousTotalCell) {
            sousTotalCell.textContent = `${parseFloat(nouveauSousTotal).toFixed(2)} DH`;
        }
    }

    // Fonction pour ajouter dynamiquement une nouvelle ligne d'article
    function ajouterLigneArticle(articleData) {
        const tableBody = document.querySelector('table tbody');
        if (!tableBody) {
            console.error('Table body non trouvé');
            return;
        }
        
        // Créer la ligne avec le même format que le template Django
        const newRow = document.createElement('tr');
        newRow.className = 'border-b border-gray-100 hover:bg-gray-50';
        newRow.setAttribute('data-panier-id', articleData.panier_id);
        newRow.setAttribute('data-article-id', articleData.article_id || '');
        
        // Fonction pour générer les badges d'état
        function genererBadgesEtat(article) {
            let badges = [];
            
            // État de phase
            const phase = article.phase || 'EN_COURS';
            if (phase === 'EN_COURS') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700">
                        <i class="fas fa-play-circle mr-1"></i>En Cours
                    </span>
                `);
            } else if (phase === 'LIQUIDATION') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <i class="fas fa-percentage mr-1"></i>Liquidation
                    </span>
                `);
            } else if (phase === 'EN_TEST') {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">
                        <i class="fas fa-flask mr-1"></i>Test
                    </span>
                `);
            } else {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">
                        <i class="fas fa-question-circle mr-1"></i>${phase}
                    </span>
                `);
            }
            
            // État upsell
            if (article.is_upsell) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-700">
                        <i class="fas fa-arrow-up mr-1"></i>Upsell
                    </span>
                `);
            }
            
            // État promotion
            if (article.has_promo_active) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                        <i class="fas fa-fire mr-1"></i>Promo
                    </span>
                `);
            }
            
            // État de stock
            const stock = parseInt(article.qte_disponible || article.stock || 0);
            if (stock <= 0) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Rupture
                    </span>
                `);
            } else if (stock <= 5) {
                badges.push(`
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700">
                        <i class="fas fa-exclamation mr-1"></i>Stock Faible
                    </span>
                `);
            }
            
            return badges.join('');
        }
        
        // Construire le HTML de la ligne
        const upsellBadge = articleData.is_upsell ? 
            '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-700 ml-2"><i class="fas fa-arrow-up mr-1"></i>Upsell</span>' : '';
        
        const prixClass = articleData.is_upsell ? 'prix-upsell' : 'prix-normal';
        const prixLibelle = articleData.is_upsell ? 
            `<div class="text-xs prix-upsell flex items-center justify-end gap-1" id="prix-libelle-${articleData.panier_id}"><i class="fas fa-arrow-up"></i>↑ Upsell Niveau ${articleData.compteur || 0}</div>` : '';
        
        newRow.innerHTML = `
            <td class="px-4 py-3">
                <div class="font-medium flex items-center">
                    ${articleData.nom}
                    ${upsellBadge}
                </div>
                ${articleData.description ? `<div class="text-sm text-gray-500">${articleData.description}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-sm">${articleData.reference || 'N/A'}</td>
            <td class="px-4 py-3 text-sm">${articleData.couleur_fr || ''}</td>
            <td class="px-4 py-3 text-sm">${articleData.pointure || ''}</td>
            <td class="px-4 py-3 text-center">
                <div class="flex items-center justify-center gap-1">
                    <button type="button" onclick="modifierQuantite(${articleData.panier_id}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-red-200">-</button>
                    <input type="number" id="quantite-${articleData.panier_id}" value="${articleData.quantite}" min="1" max="99" 
                           data-previous-value="${articleData.quantite}"
                           class="w-16 text-center font-medium border border-gray-300 rounded px-2 py-1 focus:border-blue-500 focus:outline-none"
                           onchange="modifierQuantiteDirecte(${articleData.panier_id}, this.value)"
                           onblur="modifierQuantiteDirecte(${articleData.panier_id}, this.value)">
                    <button type="button" onclick="modifierQuantite(${articleData.panier_id}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors hover:bg-green-200">+</button>
                </div>
            </td>
            <td class="px-4 py-3 text-right">
                <div class="text-right">
                    <div class="font-medium ${prixClass}" id="prix-unitaire-${articleData.panier_id}">
                        ${parseFloat(articleData.prix).toFixed(2)} DH
                    </div>
                    ${prixLibelle}
                </div>
            </td>
            <td class="px-4 py-3 text-right font-bold" id="sous-total-${articleData.panier_id}">${parseFloat(articleData.sous_total).toFixed(2)} DH</td>
            <td class="px-4 py-3 text-center">
                <div class="flex flex-col gap-1">
                    ${genererBadgesEtat(articleData)}
                </div>
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-colors" onclick="supprimerArticle(${articleData.panier_id})" title="Supprimer cet article">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        // Ajouter la ligne au tableau
        tableBody.appendChild(newRow);
        console.log(`✅ Nouvelle ligne d'article ${articleData.panier_id} ajoutée à l'interface`);
        
        // Ajouter une animation d'apparition
        newRow.style.opacity = '0';
        newRow.style.transform = 'translateY(-10px)';
        newRow.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
            newRow.style.opacity = '1';
            newRow.style.transform = 'translateY(0)';
        }, 10);
    }

    // Fonction pour supprimer dynamiquement une ligne d'article
    function supprimerLigneArticle(panierId) {
        const ligne = document.querySelector(`tr[data-panier-id="${panierId}"]`);
        if (ligne) {
            ligne.remove();
            console.log(`✅ Ligne d'article ${panierId} supprimée de l'interface`);
        } else {
            console.warn(`Ligne pour panier ${panierId} non trouvée pour suppression`);
        }
    }

    // Fonction centralisée pour mettre à jour tous les totaux et compteurs
    function mettreAJourTousLesTotaux(data) {
        console.log('🔄 Mise à jour des totaux avec les données:', data);
        
        // Mettre à jour le sous-total global des articles
        if (data.sous_total_articles !== undefined) {
            const sousTotalGlobalElement = document.getElementById('sous-total-articles');
            if (sousTotalGlobalElement) {
                sousTotalGlobalElement.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
                console.log('✅ Sous-total articles mis à jour:', data.sous_total_articles);
            }
        }
        
        // Mettre à jour le total de la commande
        if (data.total_commande !== undefined) {
            const totalElement = document.getElementById('total-commande');
            if (totalElement) {
                totalElement.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                console.log('✅ Total commande mis à jour:', data.total_commande);
            }
            
            // Également mettre à jour tous les éléments avec la classe total-commande
            const totalElements = document.querySelectorAll('.total-commande');
            totalElements.forEach(el => {
                el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
        }
        
        // Mettre à jour le compteur d'articles
        if (data.articles_count !== undefined) {
            // Compteur en haut
            const countElement = document.getElementById('articles-count');
            if (countElement) {
                countElement.textContent = data.articles_count;
            }
            
            const pluralElement = document.getElementById('articles-plural');
            if (pluralElement) {
                pluralElement.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            // Compteur en bas
            const countElementBottom = document.getElementById('articles-count-bottom');
            if (countElementBottom) {
                countElementBottom.textContent = data.articles_count;
            }
            
            const pluralElementBottom = document.getElementById('articles-plural-bottom');
            if (pluralElementBottom) {
                pluralElementBottom.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            console.log('✅ Compteur d\'articles mis à jour:', data.articles_count);
        }
        
        // Mettre à jour le compteur upsell dans tous les endroits possibles
        if (data.compteur !== undefined) {
            // Niveau upsell dashboard
            const niveauUpsellDash = document.getElementById('niveau-upsell-dashboard');
            if (niveauUpsellDash) {
                niveauUpsellDash.textContent = data.compteur;
            }
            
            // Mettre à jour le badge upsell s'il existe
            const upsellBadge = document.getElementById('upsell-badge-container');
            if (upsellBadge && data.compteur > 0) {
                upsellBadge.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell niveau <span id="niveau-upsell-dashboard">${data.compteur}</span>`;
            } else if (upsellBadge && data.compteur === 0) {
                upsellBadge.innerHTML = '';
            }
            
            console.log('✅ Compteur upsell mis à jour:', data.compteur);
        }
        
        console.log('✅ Tous les totaux mis à jour avec succès');
    }

    // Fonctions pour la modale d'information upsell
    window.ouvrirModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.remove('hidden');
            console.log('📖 Modal d\'information upsell ouverte');
        }
    };

    window.fermerModalInfoUpsell = function() {
        const modal = document.getElementById('modalInfoUpsell');
        if (modal) {
            modal.classList.add('hidden');
            console.log('📖 Modal d\'information upsell fermée');
        }
    };

    // Fonction pour calculer le total des unités upsell
    function calculerTotalUnitesUpsell() {
        let total = 0;
        const articleRows = document.querySelectorAll('tr[data-panier-id]');
        
        articleRows.forEach(row => {
            const articleId = row.getAttribute('data-article-id');
            const quantiteInput = document.getElementById(`quantite-${row.getAttribute('data-panier-id')}`);
            const quantite = quantiteInput ? parseInt(quantiteInput.value) || 0 : 0;
            
            // Vérifier si c'est un article upsell (on peut ajouter un attribut data-upsell)
            const upsellBadge = row.querySelector('.bg-orange-100.text-orange-700');
            if (upsellBadge) {
                total += quantite;
            }
        });
        
        return total;
    }

    // Fonction pour mettre à jour l'affichage du compteur avec animation
    function mettreAJourCompteurAvecAnimation(ancienCompteur, nouveauCompteur) {
        const compteurHeader = document.getElementById('compteur-upsell-header');
        
        // Vérification robuste de l'existence de l'élément
        if (!compteurHeader) {
            console.warn('⚠️ Élément compteur-upsell-header non trouvé');
            return;
        }
        
        if (!compteurHeader.style) {
            console.warn('⚠️ Propriété style non disponible sur compteur-upsell-header');
            return;
        }
        
        try {
            // Animation de transition
            compteurHeader.style.transition = 'all 0.5s ease';
            compteurHeader.style.transform = 'scale(1.1)';
            compteurHeader.style.backgroundColor = '#fef3c7';
            
            setTimeout(() => {
                // Vérification à nouveau dans le setTimeout
                if (!compteurHeader || !compteurHeader.style) {
                    console.warn('⚠️ Élément compteur-upsell-header non disponible dans setTimeout');
                    return;
                }
                
                try {
                    if (nouveauCompteur > 0) {
                        compteurHeader.innerHTML = `<i class="fas fa-arrow-up mr-1"></i>Upsell Niveau ${nouveauCompteur}`;
                    } else {
                        compteurHeader.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Aucun upsell`;
                    }
                    
                    compteurHeader.style.transform = 'scale(1)';
                    compteurHeader.style.backgroundColor = 'transparent';
                    
                    // Ajouter une classe pour l'animation CSS
                    compteurHeader.classList.add('updated');
                    setTimeout(() => {
                        if (compteurHeader && compteurHeader.classList) {
                            compteurHeader.classList.remove('updated');
                        }
                    }, 1000);
                } catch (error) {
                    console.error('❌ Erreur lors de la mise à jour du compteur:', error);
                }
            }, 250);
        } catch (error) {
            console.error('❌ Erreur lors de l\'animation du compteur:', error);
        }
    }

    // Fonction pour afficher un résumé du diagnostic
    function afficherResumeDiagnostic(data) {
        const message = `
            <div class="text-left">
                <div class="font-bold mb-2">📊 Résumé du diagnostic :</div>
                <div class="space-y-1 text-sm">
                    <div><strong>Compteur :</strong> ${data.ancien_compteur || data.compteur} → ${data.nouveau_compteur || data.compteur}</div>
                    <div><strong>Articles upsell :</strong> ${data.articles_upsell || 0}</div>
                    <div><strong>Unités totales :</strong> ${data.quantite_totale_upsell || 0}</div>
                    <div><strong>Logique :</strong> 0-1 unité = compteur 0 | 2+ unités = compteur total-1</div>
                </div>
            </div>
        `;
        
        showNotificationToast(message, 'info');
    }


    window.fermerModalConfirmation = function() {
        const modal = document.getElementById('modalConfirmation');
        if (modal) modal.classList.add('hidden');
    };

    // Fonction globale pour sélectionner un article
    window.selectionnerArticle = function(articleId, articleName, varianteId) {
        console.log(`🎯 Sélection de l'article ${articleId}: "${articleName}"`);
        
        // Marquer l'article comme sélectionné (quantité sera définie lors de la sélection de variante)
        window.selectedArticleWithVariant = {
            articleId: articleId,
            articleName: articleName,
            quantite: 1, // Quantité par défaut, sera modifiée lors de la sélection de variante
            variante_id: null
        };
        
        // Masquer le bouton "Sélectionner" et afficher le bouton "Choisir variante"
        const btnSelectionner = document.getElementById(`btn-selectionner-${articleId}`);
        const btnVariantes = document.getElementById(`btn-variantes-${articleId}`);
        
        if (btnSelectionner) {
            btnSelectionner.classList.add('hidden');
        }
        
        if (btnVariantes) {
            btnVariantes.classList.remove('hidden');
            btnVariantes.classList.add('inline-flex');
        }
        
        // Vérifier si l'article a des variantes
        try {
            const data = (window.articlesDisponibles || []).find(a => a.id === articleId);
            const hasVar = data && Array.isArray(data.variantes_all) && data.variantes_all.length > 0;
            
            if (hasVar) {
                // Si l'article a des variantes, afficher le bouton "Choisir variante"
                showNotificationToast(`Article "${articleName}" sélectionné. Cliquez sur "Choisir variante" pour continuer.`, 'info');
            } else {
                // Si l'article n'a pas de variantes, afficher directement le bouton "Ajouter au panier"
                const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
                if (btnAjouterPanier) {
                    btnAjouterPanier.classList.remove('hidden');
                    btnAjouterPanier.classList.add('inline-flex');
                }
                showNotificationToast(`Article "${articleName}" sélectionné. Cliquez sur "Ajouter au panier" pour confirmer.`, 'info');
            }
        } catch(e) { 
            console.warn('⚠️ Erreur détection variantes', e);
            // En cas d'erreur, afficher directement le bouton "Ajouter au panier"
            const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
            if (btnAjouterPanier) {
                btnAjouterPanier.classList.remove('hidden');
                btnAjouterPanier.classList.add('inline-flex');
            }
        }
    };

    window.supprimerArticle = function(panierId) {
        ouvrirModalConfirmation('Êtes-vous sûr de vouloir supprimer cet article ?', () => {
            const formData = new FormData();
            formData.append('action', 'delete_article');
            formData.append('panier_id', panierId);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
            
            fetch(`{% url 'Superpreparation:modifier_commande_superviseur' commande.id %}`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    debugDatabaseInteraction('supprimer_article', data);
                    if (data.success) {
                        showNotificationToast('Article supprimé avec succès', 'success');
                        // Recharger la page après suppression
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erreur',
                            text: data.error || 'Impossible de supprimer l\'article.'
                        });
                    }
                })
                .catch(error => {
                    handleError(error, 'suppression d\'article');
                });
        });
    };

    window.modifierQuantite = function(panierId, delta) {
        const input = document.getElementById(`quantite-${panierId}`);
        if (input) {
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(1, currentValue + delta);
            input.value = newValue;
            modifierQuantiteDirecte(panierId, newValue);
        }
    };

    window.modifierQuantiteDirecte = function(panierId, nouvelleQuantite) {
        const quantite = parseInt(nouvelleQuantite);
        
        // Validation
        if (isNaN(quantite) || quantite < 1) {
            // Restaurer la valeur précédente
            const input = document.getElementById(`quantite-${panierId}`);
            if (input) {
                input.value = input.getAttribute('data-previous-value') || 1;
            }
            Swal.fire({
                icon: 'warning',
                title: 'Quantité invalide',
                text: 'La quantité doit être au moins de 1.',
                timer: 2000,
                showConfirmButton: false
            });
            return;
        }

        // Sauvegarder la valeur précédente
        const input = document.getElementById(`quantite-${panierId}`);
        if (input) {
            input.setAttribute('data-previous-value', input.value);
        }

        // Envoyer la modification au serveur
        const formData = new FormData();
        formData.append('action', 'modifier_quantite_directe');
        formData.append('panier_id', panierId);
        formData.append('nouvelle_quantite', quantite);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
        
        fetch(`{% url 'Superpreparation:modifier_commande_superviseur' commande.id %}`, { 
            method: 'POST', 
            body: formData 
        })
        .then(res => res.json())
        .then(data => {
            debugDatabaseInteraction('modifier_quantite_directe', data);
            if (data.success) {
                if (quantite === 0) {
                    // Supprimer la ligne du tableau si l'article a été supprimé
                    const tableRow = document.querySelector(`tr[data-panier-id="${panierId}"]`);
                    if (tableRow) {
                        tableRow.remove();
                    }
                    showNotificationToast('Article supprimé', 'success');
                } else {
                    // Mettre à jour l'affichage du sous-total et du total
                    mettreAJourTotaux(panierId, data);
                    showNotificationToast('Quantité mise à jour', 'success');
                }
                
                // Mettre à jour le total général dans tous les cas
                if (data.total_commande) {
                    const totalElements = document.querySelectorAll('.total-commande');
                    totalElements.forEach(element => {
                        element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                    });
                }
                
                // Mettre à jour le compteur upsell si nécessaire
                if (data.compteur !== undefined) {
                    mettreAJourCompteurUpsell(data.compteur);
                }
            } else {
                // Restaurer la valeur précédente en cas d'erreur
                if (input) {
                    input.value = input.getAttribute('data-previous-value') || 1;
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: data.error || 'Impossible de modifier la quantité.'
                });
            }
        })
        .catch(error => {
            // Restaurer la valeur précédente en cas d'erreur
            if (input) {
                input.value = input.getAttribute('data-previous-value') || 1;
            }
            handleError(error, 'modification de quantité');
        });
    };

    // Fonction pour mettre à jour les totaux après modification
    function mettreAJourTotaux(panierId, data) {
        console.log('🔄 Mise à jour des totaux pour panier', panierId, ':', data);
        
        // Mettre à jour le sous-total de la ligne
        if (data.sous_total !== undefined) {
            const sousTotalCell = document.querySelector(`tr[data-panier-id="${panierId}"] td:nth-child(7)`);
            if (sousTotalCell) {
                sousTotalCell.textContent = `${parseFloat(data.sous_total).toFixed(2)} DH`;
                console.log('✅ Sous-total ligne mis à jour:', data.sous_total);
            }
        }
        
        // Mettre à jour le total articles
        if (data.sous_total_articles !== undefined) {
            const totalArticles = document.querySelectorAll('.total-commande');
            totalArticles.forEach(el => {
                el.textContent = `${parseFloat(data.sous_total_articles).toFixed(2)} DH`;
            });
            console.log('✅ Total articles mis à jour:', data.sous_total_articles);
        }
        
        // Mettre à jour le total livraison et total final
        if (data.total_commande !== undefined) {
            // Total final (header, modale, etc.)
            const totalFinals = document.querySelectorAll('.total-final-commande');
            totalFinals.forEach(el => {
                el.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
            });
            
            // Si il y a un champ livraison
            if (data.frais_livraison !== undefined) {
                const livraisonEls = document.querySelectorAll('.total-livraison');
                livraisonEls.forEach(el => {
                    el.textContent = `+ ${parseFloat(data.frais_livraison).toFixed(2)} DH livraison`;
                });
            }
            
            console.log('✅ Total commande mis à jour:', data.total_commande);
        }
        
        // Mettre à jour le compteur d'articles
        if (data.articles_count !== undefined) {
            // Compteur en haut
            const countElement = document.getElementById('articles-count');
            if (countElement) {
                countElement.textContent = data.articles_count;
            }
            
            const pluralElement = document.getElementById('articles-plural');
            if (pluralElement) {
                pluralElement.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            // Compteur en bas
            const countElementBottom = document.getElementById('articles-count-bottom');
            if (countElementBottom) {
                countElementBottom.textContent = data.articles_count;
            }
            
            const pluralElementBottom = document.getElementById('articles-plural-bottom');
            if (pluralElementBottom) {
                pluralElementBottom.textContent = data.articles_count > 1 ? 's' : '';
            }
            
            console.log('✅ Compteur d\'articles mis à jour:', data.articles_count);
        }
    }

    // Fonction de debug pour vérifier les interactions avec la base de données
    function debugDatabaseInteraction(action, data) {
        console.log(`🔍 DEBUG - Action: ${action}`);
        console.log(`📊 Données reçues:`, data);
        console.log(`✅ Succès: ${data.success}`);
        if (data.success) {
            console.log(`💰 Total commande: ${data.total_commande}`);
            console.log(`📦 Nombre articles: ${data.nb_articles}`);
            console.log(`⬆️ Compteur upsell: ${data.compteur}`);
        } else {
            console.log(`❌ Erreur: ${data.error}`);
        }
        console.log('---');
    }

    // Fonction pour afficher des notifications toast discrètes
    function showNotificationToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium transition-all duration-300 transform translate-x-full opacity-0`;
        
        if (type === 'success') {
            toast.classList.add('bg-green-500');
        } else if (type === 'error') {
            toast.classList.add('bg-red-500');
        } else if (type === 'info') {
            toast.classList.add('bg-blue-500');
        } else {
            toast.classList.add('bg-gray-500');
        }
        
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        // Animation d'apparition
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
        }, 100);
        
        // Animation de disparition après 5 secondes
        setTimeout(() => {
            toast.classList.add('translate-x-full', 'opacity-0');
            setTimeout(() => {
                if (document.body.contains(toast)) {
                document.body.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }

    // Fonctions pour les boutons individuels dans le template des articles
    window.modifierQuantitePrepa = function(panierId, quantiteActuelle) {
        // Ouvrir une modal simple pour modifier la quantité
        Swal.fire({
            title: 'Modifier la quantité',
            input: 'number',
            inputValue: quantiteActuelle,
            inputAttributes: {
                min: '0',
                step: '1'
            },
            showCancelButton: true,
            confirmButtonText: 'Modifier',
            cancelButtonText: 'Annuler',
            inputValidator: (value) => {
                if (value < 0) {
                    return 'La quantité ne peut pas être négative';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const nouvelleQuantite = parseInt(result.value);
                if (nouvelleQuantite === 0) {
                    // Supprimer l'article si quantité = 0
                    supprimerArticle(panierId);
                } else {
                    // Modifier la quantité
                    const formData = new FormData();
                    formData.append('action', 'modifier_quantite_directe');
                    formData.append('panier_id', panierId);
                    formData.append('nouvelle_quantite', nouvelleQuantite);
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
                    if (csrfToken) formData.append('csrfmiddlewaretoken', csrfToken.value);
                    
                    fetch(`{% url 'Superpreparation:modifier_commande_superviseur' commande.id %}`, { 
                        method: 'POST', 
                        body: formData 
                    })
                    .then(res => res.json())
                    .then(data => {
                        debugDatabaseInteraction('modifier_quantite_prepa', data);
                        if (data.success) {
                            // Mettre à jour l'interface dynamiquement
                            mettreAJourTousLesTotaux(data);
                            
                            // Mettre à jour la ligne spécifique
                            mettreAJourLigneArticle(panierId, nouvelleQuantite, data.sous_total);
                            
                            // Mettre à jour les prix upsell si nécessaire
                            if (data.compteur !== undefined) {
                                mettreAJourPrixUnitaires();
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Succès !',
                                text: 'Quantité modifiée avec succès.',
                                timer: 2000,
                                showConfirmButton: false
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erreur',
                                text: data.error || 'Une erreur est survenue.'
                            });
                        }
                    })
                    .catch(handleError);
                }
            }
        });
    };

    window.supprimerArticlePrepa = function(panierId) {
        supprimerArticle(panierId);
    };



    // Fonctions internes
    function chargerRegionEtFrais() {
        const select = document.getElementById('ville-select');
        if (!select) return;
        const selectedOption = select.options[select.selectedIndex];
        const region = selectedOption ? selectedOption.getAttribute('data-region') : '';
        const frais = selectedOption ? selectedOption.getAttribute('data-frais') : '0';
        const regionDisplay = document.getElementById('region-display');
        const fraisDisplay = document.getElementById('frais-display');
        if(regionDisplay) regionDisplay.value = region || '';
        if(fraisDisplay) fraisDisplay.value = `${frais || 0} DH`;
    }







// Fonction pour mettre à jour les statistiques
window.mettreAJourStatistiques = function(stats) {
        if (!stats) {
            console.warn('Stats non définies');
            return;
        }
        
        // Mettre à jour les compteurs avec animation
        Object.keys(stats).forEach(key => {
            const element = document.getElementById(`count-${key}`);
            if (element) {
                const currentValue = parseInt(element.textContent) || 0;
                const newValue = stats[key];
                
                // Animation de mise à jour
                element.style.transform = 'scale(1.1)';
                element.style.color = '#3b82f6';
                element.textContent = newValue;
                
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                    element.style.color = '';
                }, 300);
            } else {
                console.warn(`Element count-${key} non trouvé`);
            }
        });
        
        // Afficher un résumé des statistiques
    if (typeof window.afficherResumeStatistiques === 'function') {
        window.afficherResumeStatistiques(stats);
    }
};

// Fonction pour mettre à jour le filtre actif
window.mettreAJourFiltreActif = function(filterType) {
        // Retirer la classe active de tous les boutons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
        });
        
        // Ajouter la classe active au bouton sélectionné
        const activeBtn = document.querySelector(`[onclick="filtrerArticles('${filterType}')"]`);
        if (activeBtn) {
            activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
        }
};

// Fonction pour filtrer les articles
    window.filtrerArticles = function(filterType) {
    if (typeof window.chargerArticlesDisponibles === 'function') {
        window.chargerArticlesDisponibles(filterType);
    }
};

// Fonction pour ajouter un article au panier depuis le bouton
window.ajouterArticleAuPanierDepuisBouton = function(articleId) {
    console.log('🔄 ===== DÉBUT ajouterArticleAuPanierDepuisBouton =====');
    console.log('📦 articleId reçu:', articleId);
    console.log('📦 Type de articleId:', typeof articleId);
    console.log('📦 window.selectedArticleWithVariant:', window.selectedArticleWithVariant);
    console.log('📦 window._varianteSelection:', window._varianteSelection);
    console.log('🔍 Vérification des fonctions critiques:');
    console.log('- ouvrirModalConfirmation:', typeof window.ouvrirModalConfirmation);
    console.log('- ajouterArticleAuPanier:', typeof window.ajouterArticleAuPanier);
    
    // Récupérer la quantité depuis la sélection de variante ou utiliser 1 par défaut
    let quantite = 1;
    let articleName = 'Article';
    
    // Si une variante a été sélectionnée, récupérer la quantité depuis le modal de variantes
    console.log('🔍 Vérification selectedArticleWithVariant...');
    if (window.selectedArticleWithVariant && window.selectedArticleWithVariant.articleId === articleId) {
        quantite = window.selectedArticleWithVariant.quantite || 1;
        articleName = window.selectedArticleWithVariant.articleName || 'Article';
        console.log('✅ Quantité récupérée depuis selectedArticleWithVariant:', quantite);
        console.log('✅ Nom de l\'article récupéré:', articleName);
    } else {
        console.log('⚠️ Aucune variante sélectionnée pour cet article');
        // Sinon, récupérer le nom de l'article depuis le tableau
        const row = document.querySelector(`[onclick*="selectionnerArticle(${articleId}"]`)?.closest('tr');
        console.log('🔍 Recherche de la ligne dans le tableau:', row);
        if (row) {
            articleName = row.querySelector('.text-sm.font-medium')?.textContent || 'Article';
            console.log('✅ Nom de l\'article trouvé dans le tableau:', articleName);
        } else {
            console.log('⚠️ Ligne non trouvée dans le tableau');
        }
        console.log('⚠️ Utilisation de la quantité par défaut (1)');
    }
    
    console.log('📊 Données finales:', { quantite, articleName });
    
    // Ouvrir le modal de confirmation
    console.log('🔍 Tentative d\'ouverture du modal de confirmation...');
    if (typeof window.ouvrirModalConfirmation === 'function') {
        console.log('✅ Fonction ouvrirModalConfirmation trouvée, ouverture du modal...');
        window.ouvrirModalConfirmation(`Ajouter ${quantite} x "${articleName}" au panier ?`, () => {
            console.log('🔄 Callback du modal de confirmation exécuté');
            if (typeof window.ajouterArticleAuPanier === 'function') {
                console.log('✅ Fonction ajouterArticleAuPanier trouvée, appel...');
                window.ajouterArticleAuPanier(articleId, quantite);
            } else {
                console.error('❌ Fonction ajouterArticleAuPanier non trouvée');
            }
            
            // Réinitialiser l'affichage après ajout
            const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${articleId}`);
            const btnVariantes = document.getElementById(`btn-variantes-${articleId}`);
            const btnSelectionner = document.getElementById(`btn-selectionner-${articleId}`);
            
            if (btnAjouterPanier) {
                btnAjouterPanier.classList.add('hidden');
                btnAjouterPanier.classList.remove('inline-flex');
            }
            
            if (btnVariantes) {
                btnVariantes.classList.add('hidden');
                btnVariantes.classList.remove('inline-flex');
            }
            
            if (btnSelectionner) {
                btnSelectionner.classList.remove('hidden');
            }
            
            // Réinitialiser les variables globales après l'ajout
            window.selectedArticleWithVariant = null;
            if (window._varianteSelection && window._varianteSelection[articleId]) {
                delete window._varianteSelection[articleId];
            }
        });
    } else {
        console.error('❌ Fonction ouvrirModalConfirmation non trouvée');
        console.error('❌ ===== FIN ajouterArticleAuPanierDepuisBouton (ERREUR) =====');
    }
    console.log('✅ ===== FIN ajouterArticleAuPanierDepuisBouton =====');
};

// Fonction pour afficher les articles
window.afficherArticles = function(articles) {
        const container = document.getElementById('articlesList');
        if (!container) {
            console.warn('Container articlesList non trouvé');
            return;
        }
    
    // Filtrer les doublons basés sur l'ID de l'article
    const articlesUniques = [];
    const articlesIds = new Set();
    
    articles.forEach(article => {
        if (!articlesIds.has(article.id)) {
            articlesIds.add(article.id);
            articlesUniques.push(article);
        }
    });
    
    console.log(`📊 Articles originaux: ${articles.length}, Articles uniques: ${articlesUniques.length}`);
    
    // Stocker les articles uniques dans une variable globale pour pouvoir les réutiliser
    window.articlesList = articlesUniques;
    
        container.innerHTML = '';
        
    if (articlesUniques.length === 0) {
            container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-search text-4xl mb-4"></i>
                <div class="text-lg font-medium">Aucun article trouvé</div>
                <div class="text-sm">Essayez de modifier vos critères de recherche</div>
                </div>
            `;
            return;
        }
        
    // Créer un tableau HTML complet avec des bordures visibles
    const tableHTML = `
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border-2 border-gray-300 rounded-lg shadow-lg" style="border-collapse: collapse;">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Article</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Prix</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Stock Général</th>
                        <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white">
                    ${articlesUniques.map(article => {
        // Badge de type d'article
        const typeBadge = article.article_type !== 'normal' ? `
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${article.type_color ? article.type_color.replace('text-', 'bg-').replace('-600', '-100') : 'bg-blue-100 text-blue-600'} ${article.type_color || 'text-blue-600'} ml-2">
                <i class="${article.type_icon || 'fas fa-tag'} mr-1"></i>
                ${article.article_type.toUpperCase()}
            </span>
        ` : '';
        
        // Affichage du prix avec réduction si applicable
        const prixDisplay = article.has_reduction ? `
            <div class="text-sm">
                <span class="font-semibold text-green-600">${article.prix} DH</span>
                <span class="line-through text-gray-400 ml-2">${article.prix_original} DH</span>
                <span class="bg-red-100 text-red-700 px-2 py-1 rounded-full text-xs ml-2">-${article.reduction_pourcentage}%</span>
            </div>
        ` : `
            <div class="text-sm font-semibold text-green-600">${article.prix} DH</div>
        `;
        
        // Calculer le stock général (somme de tous les stocks des variantes)
        let stockGeneral = 0;
        let variantesEnRupture = [];
        
        if (article.variantes_all && Array.isArray(article.variantes_all)) {
            console.log(`🔍 Calcul stock général pour ${article.nom} - ${article.variantes_all.length} variantes:`);
            stockGeneral = article.variantes_all.reduce((total, variante) => {
                const stockVariante = parseInt(variante.qte_disponible || variante.stock) || 0;
                console.log(`  - Variante ${variante.id}: ${stockVariante} unités`);
                if (stockVariante === 0) {
                    variantesEnRupture.push(variante);
                }
                return total + stockVariante;
            }, 0);
            console.log(`✅ Stock général calculé: ${stockGeneral} unités (${variantesEnRupture.length} variantes en rupture)`);
        } else {
            // Si pas de variantes, utiliser le stock de l'article principal
            stockGeneral = parseInt(article.qte_disponible) || 0;
        }
        
        // Statut du stock général amélioré
        let stockStatus;
        if (stockGeneral > 0) {
            const totalVariantes = article.variantes_all ? article.variantes_all.length : 1;
            const variantesDisponibles = totalVariantes - variantesEnRupture.length;
            
            if (variantesEnRupture.length === 0) {
                // Toutes les variantes sont disponibles
                stockStatus = `<span class="font-semibold text-green-600">${stockGeneral}</span>`;
            } else {
                // Certaines variantes en rupture, d'autres disponibles
                stockStatus = `<div class="text-center">
                    <span class="font-semibold text-green-600">${stockGeneral}</span>
                    <div class="text-xs text-orange-600 mt-1">
                        ${variantesDisponibles}/${totalVariantes} variantes disp.
                    </div>
                </div>`;
            }
        } else {
            // Rupture totale
            stockStatus = `<span class="font-semibold text-red-600">Rupture</span>`;
        }
        
        // Icône d'information pour les variantes en rupture (si applicable)
        const infoIcon = variantesEnRupture.length > 0 && stockGeneral > 0 ? 
            `<button type="button" class="ml-2 text-blue-500 hover:text-blue-700" onclick="afficherVariantesEnRupture(${article.id}, ${JSON.stringify(variantesEnRupture).replace(/"/g, '&quot;')})" title="${variantesEnRupture.length} variante(s) en rupture">
                <i class="fas fa-info-circle"></i>
            </button>` : '';
        
        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 border-2 border-gray-300">
                    <div class="flex items-center">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${article.nom}</div>
                            <div class="text-sm text-gray-500">Réf: ${article.reference || 'N/A'}</div>
                            ${typeBadge}
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center border-2 border-gray-300">
                    ${prixDisplay}
                </td>
                <td class="px-4 py-3 text-center border-2 border-gray-300">
                    <div class="flex items-center justify-center">
                        <span class="text-sm text-gray-900">${stockStatus}</span>
                        ${infoIcon}
                    </div>
                </td>
                <td class="px-4 py-3 text-center border-2 border-gray-300">
                    <div class="flex items-center justify-center gap-2">
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors" 
                                onclick="selectionnerArticle(${article.id}, '${article.nom.replace(/'/g, "\\'")}')" 
                                id="btn-selectionner-${article.id}">
                            <i class="fas fa-check mr-1"></i>Sélectionner
                        </button>
                        <button type="button" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors hidden" 
                                id="btn-variantes-${article.id}"
                                onclick="ouvrirModalVariantes(${JSON.stringify(article).replace(/"/g, '&quot;')})">
                            <i class="fas fa-layer-group mr-1"></i>Choisir variante
                        </button>
                        <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors hidden btn-ajouter-panier" 
                                id="btn-ajouter-panier-${article.id}"
                                data-article-id="${article.id}"
                                onclick="ajouterArticleAuPanierDepuisBouton(${article.id})"
                                ${stockGeneral <= 0 ? 'disabled' : ''}>
                            <i class="fas fa-shopping-cart mr-1"></i>Ajouter au panier
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = tableHTML;
};
    
    function creerCarteArticle(article, index) {
        const card = document.createElement('div');
        card.className = 'article-card bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-500 transform hover:-translate-y-2 border border-gray-100 overflow-hidden';
        card.style.animationDelay = `${index * 0.1}s`;
        
        // En-tête de la carte avec image et badges
        const headerCard = creerHeaderCarte(article);
        
        // Corps de la carte avec informations
        const bodyCard = creerBodyCarte(article);
        
        // Pied de la carte avec actions
        const footerCard = creerFooterCarte(article);
        
        card.innerHTML = `
            ${headerCard}
            ${bodyCard}
            ${footerCard}
        `;
        
        return card;
    }
    
    function creerHeaderCarte(article) {
        // Badges de statut
        const badges = creerBadgesStatut(article);
        
        // Image de l'article (placeholder si pas d'image) - plus compacte
        const imageArticle = article.image_url ? 
            `<img src="${article.image_url}" alt="${article.nom}" class="w-full h-32 object-cover">` :
            `<div class="w-full h-32 bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                <i class="fas fa-image text-2xl text-gray-400"></i>
            </div>`;
        
        // Informations supplémentaires en haut à gauche
        const infosSupplementaires = `
            <div class="absolute top-2 left-2 flex flex-col gap-1">
                ${article.modele ? `
                    <div class="bg-black/60 text-white px-2 py-1 rounded text-xs font-bold">
                        ${article.modele}
                    </div>
                ` : ''}
                ${article.variantes_count > 0 ? `
                    <div class="bg-blue-600/80 text-white px-2 py-1 rounded text-xs font-bold">
                        ${article.variantes_count} var.
                    </div>
                ` : ''}
            </div>
        `;
        
        return `
            <div class="relative overflow-hidden">
                ${imageArticle}
                ${infosSupplementaires}
                <div class="absolute top-2 right-2 flex flex-col gap-1">
                    ${badges}
                </div>
                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                    <h3 class="text-lg font-bold text-white leading-tight">${article.nom}</h3>
                    ${article.description ? `
                        <p class="text-xs text-white/80 mt-1 line-clamp-2">${article.description}</p>
                    ` : ''}
                </div>
            </div>
        `;
    }
    
    function creerBadgesStatut(article) {
        const badges = [];
            
            // Badge de type d'article
        if (article.article_type !== 'normal') {
            const badgeColor = article.article_type === 'upsell' ? 'from-purple-500 to-purple-600' :
                              article.article_type === 'promo' ? 'from-red-500 to-red-600' :
                              article.article_type === 'liquidation' ? 'from-orange-500 to-orange-600' :
                              'from-blue-500 to-blue-600';
            
            badges.push(`
                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r ${badgeColor} text-white shadow-md">
                    <i class="${article.type_icon} mr-1"></i>
                    ${article.article_type.toUpperCase()}
                </div>
            `);
        }
        
        // Badge variante
        if (article.is_variante) {
            badges.push(`
                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-md">
                    <i class="fas fa-layer-group mr-1"></i>Var
                </div>
            `);
        }
        
        // Badge stock critique
        if (article.qte_disponible <= 5 && article.qte_disponible > 0) {
            badges.push(`
                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-md animate-pulse">
                    <i class="fas fa-exclamation-triangle mr-1"></i>Lim
                </div>
            `);
        }
        
        // Badge phase spéciale
        if (article.phase && article.phase !== 'EN_COURS') {
            const phaseColor = article.phase === 'LIQUIDATION' ? 'from-red-500 to-red-600' :
                              article.phase === 'EN_TEST' ? 'from-yellow-500 to-yellow-600' :
                              'from-blue-500 to-blue-600';
            
            badges.push(`
                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r ${phaseColor} text-white shadow-md">
                    <i class="fas fa-tag mr-1"></i>
                    ${article.phase === 'LIQUIDATION' ? 'LIQ' : 
                      article.phase === 'EN_TEST' ? 'TEST' : 
                      article.phase === 'PROMO' ? 'PROMO' : article.phase}
                </div>
            `);
        }
        
        // Badge upsell
        if (article.isUpsell) {
            badges.push(`
                <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-bold bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-md">
                    <i class="fas fa-arrow-up mr-1"></i>UP
                </div>
            `);
        }
        
        return badges.join('');
    }
    
    function creerBodyCarte(article) {
        // Section 1: Informations de base et prix en ligne
        const infosBasePrix = `
            <div class="p-3 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-gray-200">
                <div class="grid grid-cols-2 lg:grid-cols-5 gap-2 items-center">
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1 font-medium">Référence</div>
                        <div class="font-mono text-xs font-bold text-gray-800 bg-white px-2 py-1 rounded-lg">${article.reference || 'N/A'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1 font-medium">Modèle</div>
                        <div class="text-xs font-bold text-gray-800 bg-white px-2 py-1 rounded-lg">${article.modele || 'N/A'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1 font-medium">Couleur</div>
                        <div class="text-xs font-bold text-gray-800 bg-white px-2 py-1 rounded-lg">${article.couleur || 'N/A'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1 font-medium">Pointure</div>
                        <div class="text-xs font-bold text-gray-800 bg-white px-2 py-1 rounded-lg">${article.pointure || 'N/A'}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1 font-medium">Prix</div>
                        ${article.has_reduction ? `
                            <div class="space-y-1">
                                <div class="text-sm font-bold text-green-600">${article.prix} DH</div>
                                <div class="text-xs text-red-600 font-medium">-${article.reduction_pourcentage}%</div>
                </div>
            ` : `
                            <div class="text-sm font-bold text-blue-600">${article.prix} DH</div>
                        `}
                    </div>
                </div>
            </div>
        `;
        
        // Section 2: Informations détaillées et statut
        const infosDetaillees = `
            <div class="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                    <!-- Statut du stock -->
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-white rounded-full flex items-center justify-center shadow-sm">
                            <i class="${article.qte_disponible === 0 ? 'fas fa-times-circle text-red-600' : 
                                       article.qte_disponible <= 5 ? 'fas fa-exclamation-triangle text-orange-600' : 
                                       'fas fa-check-circle text-green-600'} text-xs"></i>
                        </div>
                        <div class="text-xs">
                            <div class="font-bold text-gray-800">${article.qte_disponible}</div>
                            <div class="text-gray-600">en stock</div>
                        </div>
                    </div>
                    
                    <!-- Phase et type -->
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">Phase</div>
                        <div class="text-xs font-bold ${article.phase === 'LIQUIDATION' ? 'text-red-600' : 
                                                      article.phase === 'EN_TEST' ? 'text-yellow-600' : 
                                                      article.phase === 'PROMO' ? 'text-orange-600' : 'text-blue-600'}">
                            ${article.phase || 'NORMAL'}
                    </div>
                </div>
                    
                    <!-- Upsell -->
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">Upsell</div>
                        <div class="text-xs font-bold ${article.isUpsell ? 'text-purple-600' : 'text-gray-400'}">
                            ${article.isUpsell ? 'OUI' : 'NON'}
                        </div>
                    </div>
                    
                    <!-- Variantes -->
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">Variantes</div>
                        <div class="text-xs font-bold text-blue-600">
                            ${article.variantes_count || 0}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Section 3: Informations variante et catégories
        const infosVarianteCategories = `
            <div class="p-3 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-200">
                <div class="flex flex-wrap items-center justify-between gap-3">
                    <!-- Informations variante -->
                    ${article.is_variante ? `
                <div class="flex items-center gap-2">
                            <div class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-layer-group text-purple-600 text-xs"></i>
                    </div>
                            <div class="text-xs text-purple-800">
                                <div class="font-medium">Réf. Variante</div>
                                <div class="font-mono">${article.reference_variante || 'N/A'}</div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Catégorie et genre -->
                    <div class="flex gap-2">
                        ${article.categorie ? `
                            <span class="inline-flex items-center px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                                <i class="fas fa-tag mr-1"></i>${article.categorie}
                            </span>
                        ` : ''}
                        ${article.genre ? `
                            <span class="inline-flex items-center px-2 py-1 bg-pink-100 text-pink-800 rounded-full text-xs font-medium">
                                <i class="fas fa-user mr-1"></i>${article.genre}
                            </span>
                        ` : ''}
                    </div>
                    
                    <!-- Prix unitaire vs prix actuel -->
                    ${article.prix_unitaire && article.prix_unitaire !== article.prix ? `
                        <div class="text-center">
                            <div class="text-xs text-gray-500">Prix unitaire</div>
                            <div class="text-xs font-bold text-gray-600 line-through">${article.prix_unitaire} DH</div>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Section 4: Description compacte (si disponible)
        const descriptionCompact = article.description ? `
            <div class="p-3 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-xl border border-yellow-200">
                <div class="flex items-start gap-2">
                    <div class="w-6 h-6 bg-yellow-100 rounded-full flex items-center justify-center mt-0.5">
                        <i class="fas fa-align-left text-yellow-600 text-xs"></i>
                    </div>
                    <div class="text-xs text-yellow-800">
                        <div class="font-medium mb-1">Description</div>
                        <div class="italic bg-white p-2 rounded border border-yellow-200">"${article.description}"</div>
                    </div>
                </div>
            </div>
        ` : '';
        
        return `
            <div class="p-3 space-y-2">
                ${infosBasePrix}
                ${infosDetaillees}
                ${infosVarianteCategories}
                ${descriptionCompact}
            </div>
        `;
    }
    
    function creerStatutStock(article) {
        if (article.qte_disponible === 0) {
            return `
                <div class="p-4 bg-gradient-to-r from-red-50 to-pink-50 rounded-xl border border-red-200">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                    </div>
                            <div>
                                <h4 class="font-bold text-red-800 text-lg">Rupture de stock</h4>
                                <p class="text-sm text-red-600">Article temporairement indisponible</p>
                            </div>
                        </div>
                        <button type="button" 
                                onclick="afficherInfoStock(${article.id}, ${article.qte_disponible}, '${article.nom.replace(/'/g, "\\'")}')"
                                class="text-red-500 hover:text-red-700 transition-colors p-2 hover:bg-red-100 rounded-lg">
                            <i class="fas fa-info-circle text-lg"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        let stockClass, stockIcon, stockMessage;
        if (article.qte_disponible <= 5) {
            stockClass = 'from-orange-50 to-red-50 border-orange-200';
            stockIcon = 'fas fa-exclamation-triangle text-orange-600';
            stockMessage = 'Stock très limité - Commandez rapidement';
        } else if (article.qte_disponible <= 20) {
            stockClass = 'from-yellow-50 to-orange-50 border-yellow-200';
            stockIcon = 'fas fa-exclamation-circle text-yellow-600';
            stockMessage = 'Stock modéré - Disponible pour commande';
        } else {
            stockClass = 'from-green-50 to-emerald-50 border-green-200';
            stockIcon = 'fas fa-check-circle text-green-600';
            stockMessage = 'Stock disponible - Commandez en toute sérénité';
        }
        
        return `
            <div class="p-4 bg-gradient-to-r ${stockClass} rounded-xl border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-lg">
                            <i class="${stockIcon} text-2xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 text-lg">${article.qte_disponible} en stock</h4>
                            <p class="text-sm text-gray-600">${stockMessage}</p>
                        </div>
                    </div>
                    <button type="button" 
                            onclick="afficherInfoStock(${article.id}, ${article.qte_disponible}, '${article.nom.replace(/'/g, "\\'")}')"
                            class="text-blue-500 hover:text-blue-700 transition-colors p-2 hover:bg-blue-100 rounded-lg">
                        <i class="fas fa-info-circle text-lg"></i>
                    </button>
                </div>
            </div>
        `;
    }
    
    function creerFooterCarte(article) {
        // Contrôles de quantité et bouton d'ajout en ligne
        const footerContent = `
            <div class="p-3 bg-gray-50 rounded-xl">
                <div class="flex items-center justify-between gap-3">
                    <!-- Contrôles de quantité -->
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-medium text-gray-600">Qté:</span>
                        <div class="flex items-center gap-1 bg-white border border-gray-200 rounded-lg p-1 shadow-sm">
                            <button type="button" 
                                    class="quantity-control w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 font-bold text-sm transition-all duration-200 flex items-center justify-center hover:scale-105 active:scale-95"
                                    data-article-id="${article.id}" data-action="decrease">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <input type="number" id="qte-article-${article.id}" 
                                   class="w-16 text-center font-bold text-sm border-none focus:ring-2 focus:ring-blue-500 focus:outline-none bg-transparent" 
                                   value="1" min="1" max="${article.qte_disponible}" 
                                   ${article.qte_disponible <= 0 ? 'disabled' : ''}>
                            <button type="button" 
                                    class="quantity-control w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 font-bold text-sm transition-all duration-200 flex items-center justify-center hover:scale-105 active:scale-95"
                                    data-article-id="${article.id}" data-action="increase">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-1 text-xs text-gray-500">
                            <span>Max: <span class="font-bold text-blue-600">${article.qte_disponible}</span></span>
                            <button type="button" 
                                    onclick="afficherInfoStock(${article.id}, ${article.qte_disponible}, '${article.nom.replace(/'/g, "\\'")}')"
                                    class="text-blue-500 hover:text-blue-700 transition-colors p-0.5 hover:bg-blue-100 rounded">
                                <i class="fas fa-info-circle text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Bouton d'ajout -->
                    <button type="button" 
                            class="add-button bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg ${article.qte_disponible <= 0 ? 'opacity-50 cursor-not-allowed' : ''}" 
                            onclick="selectionnerArticle(${article.id}, '${article.nom.replace(/'/g, "\\'")}', ${article.is_variante ? (article.variante_id || 'null') : 'null'})" 
                            ${article.qte_disponible <= 0 ? 'disabled' : ''}>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-shopping-cart text-sm"></i>
                            <span class="text-sm">${article.qte_disponible <= 0 ? 'Rupture' : 'Ajouter'}</span>
                        </div>
                    </button>
                </div>
            </div>
        `;
        
        return `
            <div class="border-t border-gray-100">
                ${footerContent}
            </div>
        `;
    }





    window.ajouterArticleAuPanier = function(articleId, quantite) {
        console.log('🔄 ===== DÉBUT ajouterArticleAuPanier =====');
        console.log('📦 Paramètres reçus:', { articleId, quantite });
        console.log('📦 Types des paramètres:', { articleId: typeof articleId, quantite: typeof quantite });
        console.log('📦 window._varianteSelection:', window._varianteSelection);
        console.log('📦 variante_id pour cet article:', window._varianteSelection ? window._varianteSelection[articleId] : undefined);
        
        console.log('🔧 Préparation des données FormData...');
        const formData = new FormData();
        formData.append('action', 'add_article');
        formData.append('article_id', articleId);
        formData.append('quantite', quantite);
        
        // Inclure la variante sélectionnée si disponible
        if (window._varianteSelection && window._varianteSelection[articleId]) {
            console.log('📦 Envoi variante_id:', window._varianteSelection[articleId]);
            formData.append('variante_id', window._varianteSelection[articleId]);
        } else {
            console.log('⚠️ Aucune variante_id jointe');
        }
        
        // Log du FormData
        console.log('📦 FormData préparé:');
        for (let [key, value] of formData.entries()) {
            console.log(`  - ${key}: ${value}`);
        }
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        console.log('🔍 CSRF Token trouvé:', csrfToken ? 'OUI' : 'NON');
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken.value);
            console.log('✅ CSRF Token ajouté au FormData');
        } else {
            console.error('❌ CSRF Token non trouvé');
        }
        
        const url = `{% url 'Superpreparation:ajouter_article_commande_prepa' commande.id %}`;
        console.log('🌐 URL de la requête:', url);
        console.log('📡 Début de la requête fetch...');
        
        fetch(url, { method: 'POST', body: formData })
            .then(res => {
                console.log('🌐 Réponse HTTP reçue:', res.status, res.statusText);
                console.log('🌐 Headers de la réponse:', Object.fromEntries(res.headers.entries()));
                if (!res.ok) {
                    console.error('❌ Erreur HTTP:', res.status, res.statusText);
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                return res.json();
            })
            .then(data => {
                console.log('📥 Réponse JSON reçue:', data);
                console.log('📥 Type de la réponse:', typeof data);
                debugDatabaseInteraction('ajouter_article', data);
                if (data.success) {
                    console.log('✅ Article ajouté avec succès:', data);
                    console.log('✅ ===== FIN ajouterArticleAuPanier (SUCCÈS) =====');
                    
                    // Fermer les modales
                    console.log('🔧 Fermeture des modales...');
                    if (typeof window.fermerModalConfirmation === 'function') {
                        window.fermerModalConfirmation();
                    }
                    if (typeof window.fermerModalAjoutArticle === 'function') {
                        window.fermerModalAjoutArticle();
                    }
                    
                    // Si nous avons les données de l'article, l'ajouter dynamiquement
                    if (data.article_data) {
                        ajouterLigneArticle(data.article_data);
                        console.log('✅ Ligne d\'article ajoutée dynamiquement');
                    } else {
                        // Sinon, rafraîchir la section complète
                        setTimeout(() => {
                            rafraichirSectionArticles();
                        }, 300);
                    }
                    
                    // Mettre à jour tous les totaux et compteurs
                    mettreAJourTousLesTotaux(data);
                    
                    showNotificationToast(data.message || 'Article ajouté avec succès', 'success');
                } else {
                    console.error('❌ Erreur lors de l\'ajout:', data.error);
                    console.error('❌ ===== FIN ajouterArticleAuPanier (ERREUR) =====');
                    if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: data.error || 'Impossible d\'ajouter l\'article.'
                    });
                    } else {
                        console.error('❌ SweetAlert2 non disponible');
                        alert('Erreur: ' + (data.error || 'Impossible d\'ajouter l\'article.'));
                    }
                }
            })
            .catch(error => {
                console.error('❌ Erreur fetch:', error);
                console.error('❌ ===== FIN ajouterArticleAuPanier (ERREUR RÉSEAU) =====');
                if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'error',
                        title: 'Erreur réseau',
                        text: 'Impossible de communiquer avec le serveur: ' + error.message
                });
                } else {
                    console.error('❌ SweetAlert2 non disponible');
                    alert('Erreur réseau: ' + error.message);
                }
            });
    }

    function handleResponse(data) {
        if (data.success) {
            // Mettre à jour l'interface dynamiquement au lieu de recharger
            if (data.total_commande !== undefined) {
                const totalElements = document.querySelectorAll('.total-commande, .total-final-commande');
                totalElements.forEach(element => {
                    element.textContent = `${parseFloat(data.total_commande).toFixed(2)} DH`;
                });
            }
            
            if (data.compteur !== undefined) {
                mettreAJourCompteurUpsell(data.compteur);
            }
            
            if (data.articles_count !== undefined) {
                const articlesCount = document.getElementById('articles-count');
                if (articlesCount) {
                    articlesCount.textContent = data.articles_count;
                }
            }
            
            // Mettre à jour les prix upsell si nécessaire
            if (data.compteur !== undefined) {
                mettreAJourPrixUnitaires();
            }
            
            Swal.fire({ 
                icon: 'success', 
                title: 'Succès !', 
                text: data.message || 'Opération réussie.', 
                timer: 2000, 
                showConfirmButton: false 
            });
        } else {
            Swal.fire({ 
                icon: 'error', 
                title: 'Erreur', 
                text: data.error || 'Une erreur est survenue.' 
            });
        }
    }

    function handleError(error) {
        console.error('Erreur:', error);
        Swal.fire({ 
            icon: 'error', 
            title: 'Erreur de communication', 
            text: 'Impossible de contacter le serveur.' 
        });
    }

    // Event Listeners avec vérifications
    const searchInput = document.getElementById('searchArticle');
    if (searchInput) {
        let searchTimeout;
        
        // Moteur de recherche intelligent (client-only)
        const normalize = (s) => (s || '').toString().normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase();
        const tokenize = (s) => normalize(s).split(/[^\p{L}\p{N}]+/u).filter(Boolean);
        const fieldWeights = {
            nom: 3.0,
            reference: 2.5,
            reference_variante: 2.2,
            couleur: 1.8,
            pointure: 1.6,
            categorie: 1.2,
            genre: 1.0
        };
        function buildIndex(list) {
            window._articlesIndex = list.map(a => {
                const entry = {
                    id: a.id,
                    tokens: new Set(),
                    raw: a
                };
                const fields = [
                    a.nom,
                    a.reference,
                    a.couleur,
                    a.pointure,
                    a.categorie,
                    a.genre,
                    a.reference_variante
                ];
                const variantRefs = Array.isArray(a.variantes_all) ? a.variantes_all.map(v => [v.reference_variante, v.couleur, v.pointure]).flat() : [];
                fields.concat(variantRefs).forEach(val => tokenize(val || '').forEach(t => entry.tokens.add(t)));
                return entry;
            });
        }
        function stringScore(qTok, token) {
            if (token.startsWith(qTok)) return 1.0; // prefix match
            if (token.includes(qTok)) return 0.75;  // substring
            // fuzzy: sous-séquence
            let i = 0; for (const ch of token) { if (ch === qTok[i]) i++; if (i === qTok.length) break; }
            if (i === qTok.length) return 0.5;
            return 0;
        }
        function scoreArticle(article, query) {
            const qTokens = tokenize(query);
            if (qTokens.length === 0) return 0;
            let score = 0;
            const fields = {
                nom: article.nom,
                reference: article.reference,
                reference_variante: article.reference_variante,
                couleur: article.couleur,
                pointure: article.pointure,
                categorie: article.categorie,
                genre: article.genre
            };
            // Ajouter les variantes
            if (Array.isArray(article.variantes_all)) {
                article.variantes_all.forEach(v => {
                    fields.reference_variante = (fields.reference_variante ? fields.reference_variante + ' ' : '') + (v.reference_variante || '');
                    fields.couleur = (fields.couleur ? fields.couleur + ' ' : '') + ((v.couleur && v.couleur.nom) || v.couleur || '');
                    fields.pointure = (fields.pointure ? fields.pointure + ' ' : '') + ((v.pointure && v.pointure.pointure) || v.pointure || '');
                });
            }
            for (const [field, value] of Object.entries(fields)) {
                const tokens = tokenize(value || '');
                if (tokens.length === 0) continue;
                let local = 0;
                for (const q of qTokens) {
                    let best = 0;
                    for (const t of tokens) best = Math.max(best, stringScore(q, t));
                    local += best;
                }
                score += local * (fieldWeights[field] || 1.0);
            }
            return score;
        }
        function smartFilter(list, query) {
            if (!window._articlesIndex || window._articlesIndex.length !== list.length) buildIndex(list);
            const results = list.map(a => ({ a, s: scoreArticle(a, query) }))
                                .filter(x => x.s > 0)
                                .sort((x, y) => y.s - x.s)
                                .map(x => x.a);
            return results;
        }
        searchInput.addEventListener('input', function() {
            const query = this.value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (!query || query.trim().length === 0) {
                    afficherArticles(articlesDisponibles);
                    afficherResultatsRecherche('', articlesDisponibles.length);
                    return;
                }
                const filtered = smartFilter(articlesDisponibles, query);
                afficherArticles(filtered);
                afficherResultatsRecherche(query, filtered.length);
            }, 200);
        });
        
        // Ajouter des suggestions de recherche
        searchInput.addEventListener('focus', function() {
            afficherSuggestionsRecherche();
        });
        
        // Effacer les suggestions quand on clique ailleurs
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target)) {
                effacerSuggestionsRecherche();
            }
        });
    } else {
        console.warn('Element searchArticle non trouvé');
    }
    
    function afficherResultatsRecherche(query, count) {
        const container = document.getElementById('articlesList');
        if (!container) return;
        
        // Supprimer l'ancien message de résultats
        const oldMessage = container.querySelector('.search-results-message');
        if (oldMessage) oldMessage.remove();
        
        if (query.length > 0) {
            const messageElement = document.createElement('div');
            messageElement.className = 'search-results-message mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg';
            messageElement.innerHTML = `
                <div class="flex items-center gap-2 text-blue-800">
                    <i class="fas fa-search"></i>
                    <span class="font-medium">Recherche: "${query}"</span>
                    <span class="text-sm">(${count} résultat${count > 1 ? 's' : ''})</span>
                </div>
            `;
            
            if (container.firstChild) {
                container.insertBefore(messageElement, container.firstChild);
            } else {
                container.appendChild(messageElement);
            }
        }
    }
    
    function afficherSuggestionsRecherche() {
        const searchInput = document.getElementById('searchArticle');
        if (!searchInput) return;
        
        // Créer des suggestions basées sur les articles disponibles
        const suggestions = [
            'Chaussures', 'Sandales', 'Baskets', 'Bottes',
            'Homme', 'Femme', 'Enfant', 'Promo', 'Upsell'
        ];
        
        const suggestionsContainer = document.createElement('div');
        suggestionsContainer.className = 'search-suggestions absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg z-10 mt-1';
        suggestionsContainer.innerHTML = `
            <div class="p-2">
                <div class="text-xs text-gray-500 mb-2 px-2">Suggestions:</div>
                ${suggestions.map(suggestion => `
                    <div class="suggestion-item px-2 py-1 hover:bg-gray-100 rounded cursor-pointer text-sm" 
                         onclick="appliquerSuggestion('${suggestion}')">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>${suggestion}
                    </div>
                `).join('')}
            </div>
        `;
        
        // Positionner les suggestions
        searchInput.parentNode.style.position = 'relative';
        searchInput.parentNode.appendChild(suggestionsContainer);
    }
    
    function effacerSuggestionsRecherche() {
        const suggestions = document.querySelector('.search-suggestions');
        if (suggestions) {
            suggestions.remove();
        }
    }
    
    function appliquerSuggestion(suggestion) {
        const searchInput = document.getElementById('searchArticle');
        if (searchInput) {
            searchInput.value = suggestion;
            searchInput.dispatchEvent(new Event('input'));
            effacerSuggestionsRecherche();
        }
    }
    
    // Fonction globale pour modifier la quantité d'un article dans la modale
    window.modifierQuantiteArticle = function(articleId, delta) {
        console.log(`🔄 Modification quantité article ${articleId}: delta = ${delta}`);
        
        const input = document.getElementById(`qte-article-${articleId}`);
        if (!input) {
            console.error(`❌ Input de quantité non trouvé pour l'article ${articleId}`);
            return;
        }
        
        const currentValue = parseInt(input.value) || 1;
        const newValue = Math.max(1, currentValue + delta);
        
        // Vérifier que la nouvelle valeur ne dépasse pas le stock disponible
        const maxStock = parseInt(input.getAttribute('max')) || 99;
        if (newValue > maxStock) {
            newValue = maxStock;
            console.log(`⚠️ Quantité limitée au stock maximum: ${maxStock}`);
        }
        
        // Mettre à jour la valeur
        input.value = newValue;
        
        // Ajouter une animation de feedback
        input.style.transform = 'scale(1.05)';
        input.style.backgroundColor = '#f0f9ff';
        input.style.transition = 'all 0.2s ease';
        
        setTimeout(() => {
            input.style.transform = 'scale(1)';
            input.style.backgroundColor = '';
        }, 200);
        
        console.log(`✅ Quantité modifiée pour l'article ${articleId}: ${currentValue} → ${newValue}`);
        
        // Déclencher un événement personnalisé pour notifier le changement
        input.dispatchEvent(new CustomEvent('quantityChanged', {
            detail: { articleId, oldValue: currentValue, newValue, delta }
        }));
    };

    const villeSelect = document.getElementById('ville-select');
    if (villeSelect) {
        villeSelect.addEventListener('change', chargerRegionEtFrais);
    } else {
        console.warn('Element ville-select non trouvé');
    }
    
    // Initialisation
    chargerRegionEtFrais();
    
    // Fonctions pour les modales d'information
    window.ouvrirModalInfoPrix = function() {
        const modal = document.getElementById('modalInfoPrix');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoPrix = function() {
        const modal = document.getElementById('modalInfoPrix');
        if (modal) modal.classList.add('hidden');
    };

    window.ouvrirModalInfoSousTotal = function() {
        const modal = document.getElementById('modalInfoSousTotal');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoSousTotal = function() {
        const modal = document.getElementById('modalInfoSousTotal');
        if (modal) modal.classList.add('hidden');
    };

    window.ouvrirModalInfoTotal = function() {
        const modal = document.getElementById('modalInfoTotal');
        if (modal) modal.classList.remove('hidden');
    };

    window.fermerModalInfoTotal = function() {
        const modal = document.getElementById('modalInfoTotal');
        if (modal) modal.classList.add('hidden');
    };

    // Vérification que tous les éléments critiques sont présents
    console.log('🔍 Vérification des éléments DOM:');
    console.log('- modalAjoutArticle:', document.getElementById('modalAjoutArticle') ? '✅ OK' : '❌ MANQUANT');
    console.log('- articlesList:', document.getElementById('articlesList') ? '✅ OK' : '❌ MANQUANT');
    console.log('- searchArticle:', document.getElementById('searchArticle') ? '✅ OK' : '❌ MANQUANT');
    console.log('- ville-select:', document.getElementById('ville-select') ? '✅ OK' : '❌ MANQUANT');
    console.log('- modalInfoUpsell:', document.getElementById('modalInfoUpsell') ? '✅ OK' : '❌ MANQUANT');
    console.log('- compteur-upsell-header:', document.getElementById('compteur-upsell-header') ? '✅ OK' : '❌ MANQUANT');
    
    // Vérification des fonctions critiques
    console.log('🔍 Vérification des fonctions critiques:');
    console.log('- modifierQuantiteArticle:', typeof modifierQuantiteArticle === 'function' ? '✅ OK' : '❌ MANQUANT');
    console.log('- selectionnerArticle:', typeof window.selectionnerArticle === 'function' ? '✅ OK' : '❌ MANQUANT');
    console.log('- afficherArticles:', typeof afficherArticles === 'function' ? '✅ OK' : '❌ MANQUANT');
    console.log('- handleError:', typeof handleError === 'function' ? '✅ OK' : '❌ MANQUANT');
    
    // Fonction de validation globale
    function validerFonctionsCritiques() {
        const fonctionsRequises = [
            'modifierQuantiteArticle',
            'selectionnerArticle',
            'afficherArticles',
            'handleError',
            'ajouterArticleAuPanier',
            'ouvrirModalConfirmation'
        ];
        
        const fonctionsManquantes = fonctionsRequises.filter(fn => typeof window[fn] !== 'function' && typeof eval(fn) !== 'function');
        
        if (fonctionsManquantes.length > 0) {
            console.error('❌ Fonctions manquantes:', fonctionsManquantes);
            console.warn('💡 Certaines fonctionnalités peuvent ne pas fonctionner correctement');
            return false;
        }
        
        console.log('✅ Toutes les fonctions critiques sont définies');
        return true;
    }
    
    // Exécuter la validation
    validerFonctionsCritiques();
    
    // Test de la fonction modifierQuantiteArticle
    console.log('🧪 Test de la fonction modifierQuantiteArticle:');
    console.log('- Fonction accessible:', typeof window.modifierQuantiteArticle === 'function' ? '✅ OUI' : '❌ NON');
    
    // Créer un système de fallback si la fonction n'est pas accessible
    if (typeof window.modifierQuantiteArticle !== 'function') {
        console.warn('⚠️ Création d\'un fallback pour modifierQuantiteArticle');
        window.modifierQuantiteArticle = function(articleId, delta) {
            console.log(`🔄 FALLBACK - Modification quantité article ${articleId}: delta = ${delta}`);
            
            const input = document.getElementById(`qte-article-${articleId}`);
            if (!input) {
                console.error(`❌ Input de quantité non trouvé pour l'article ${articleId}`);
                return;
            }
            
            const currentValue = parseInt(input.value) || 1;
            const newValue = Math.max(1, currentValue + delta);
            const maxStock = parseInt(input.getAttribute('max')) || 99;
            
            if (newValue > maxStock) {
                input.value = maxStock;
            } else {
                input.value = newValue;
            }
            
            console.log(`✅ FALLBACK - Quantité modifiée: ${currentValue} → ${input.value}`);
        };
    }
    
    // Système de fallback avec event listeners pour les boutons de quantité
    function configurerEventListenersQuantite() {
        console.log('🔧 Configuration des event listeners pour les boutons de quantité...');
        
        // Attendre que le DOM soit chargé
        setTimeout(() => {
            // Configurer les boutons de quantité (decrease/increase)
            const boutonsQuantite = document.querySelectorAll('[data-action="decrease"], [data-action="increase"]');
            console.log(`📦 ${boutonsQuantite.length} boutons de quantité trouvés`);
            
            // Configurer les boutons d'ajout au panier
            const boutonsAjoutPanier = document.querySelectorAll('.btn-ajouter-panier');
            console.log(`🛒 ${boutonsAjoutPanier.length} boutons d'ajout au panier trouvés`);
            
            boutonsQuantite.forEach(bouton => {
                const articleId = bouton.getAttribute('data-article-id');
                const action = bouton.getAttribute('data-action');
                const delta = action === 'decrease' ? -1 : 1;
                
                // Supprimer l'ancien event listener s'il existe
                bouton.removeEventListener('click', bouton._quantiteHandler);
                
                // Créer un nouveau handler
                bouton._quantiteHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(`🖱️ Clic sur bouton ${action} pour article ${articleId}`);
                    
                    if (typeof window.modifierQuantiteArticle === 'function') {
                        window.modifierQuantiteArticle(articleId, delta);
                    } else {
                        console.error('❌ Fonction modifierQuantiteArticle non accessible via event listener');
                        // Fallback direct
                        const input = document.getElementById(`qte-article-${articleId}`);
                        if (input) {
                            const currentValue = parseInt(input.value) || 1;
                            const newValue = Math.max(1, currentValue + delta);
                            const maxStock = parseInt(input.getAttribute('max')) || 99;
                            input.value = Math.min(newValue, maxStock);
                            console.log(`✅ Fallback direct: quantité ${currentValue} → ${input.value}`);
                        }
                    }
                };
                
                // Ajouter le nouvel event listener
                bouton.addEventListener('click', bouton._quantiteHandler);
                console.log(`✅ Event listener configuré pour bouton ${action} de l'article ${articleId}`);
            });
        }, 1000); // Attendre 1 seconde pour que les articles soient chargés
    }
    
    // Configurer les event listeners au chargement et après chaque mise à jour
    configurerEventListenersQuantite();
    
    // Event listener global pour les boutons d'ajout au panier
    document.addEventListener('click', function(e) {
        console.log('🖱️ Clic détecté sur:', e.target);
        console.log('🔍 Classes de l\'élément cliqué:', e.target.className);
        console.log('🔍 ID de l\'élément cliqué:', e.target.id);
        
        if (e.target && e.target.classList.contains('btn-ajouter-panier')) {
            e.preventDefault();
            e.stopPropagation();
            const articleId = e.target.getAttribute('data-article-id');
            console.log('🖱️ Clic global détecté sur bouton ajouter panier pour article', articleId);
            if (articleId && typeof window.ajouterArticleAuPanierDepuisBouton === 'function') {
                window.ajouterArticleAuPanierDepuisBouton(articleId);
            }
        }
        
        // Vérifier aussi si c'est un bouton avec data-article-id
        if (e.target && e.target.getAttribute('data-article-id')) {
            console.log('🖱️ Clic détecté sur élément avec data-article-id:', e.target.getAttribute('data-article-id'));
        }
    });
    
    // Reconfigurer après chaque mise à jour de la liste d'articles
    const originalAfficherArticles = afficherArticles;
    afficherArticles = function(articles) {
        originalAfficherArticles(articles);
        // Reconfigurer les event listeners après l'affichage
        setTimeout(configurerEventListenersQuantite, 100);
    };
    
    // Fonction pour afficher les informations sur le stock
    window.afficherInfoStock = function(articleId, stockDisponible, nomArticle) {
        console.log(`ℹ️ Affichage des informations de stock pour l'article ${articleId}`);
        
        // Déterminer le statut du stock
        let statutStock, couleurStatut, iconeStatut, messageStatut;
        
        if (stockDisponible === 0) {
            statutStock = 'Rupture de stock';
            couleurStatut = 'red';
            iconeStatut = 'fas fa-exclamation-triangle';
            messageStatut = 'Cet article n\'est plus disponible en stock.';
        } else if (stockDisponible <= 5) {
            statutStock = 'Stock limité';
            couleurStatut = 'orange';
            iconeStatut = 'fas fa-exclamation-circle';
            messageStatut = 'Attention : Le stock est très limité.';
        } else if (stockDisponible <= 20) {
            statutStock = 'Stock modéré';
            couleurStatut = 'yellow';
            iconeStatut = 'fas fa-info-circle';
            messageStatut = 'Le stock est modéré, commandez rapidement.';
        } else {
            statutStock = 'Stock disponible';
            couleurStatut = 'green';
            iconeStatut = 'fas fa-check-circle';
            messageStatut = 'Le stock est suffisant pour votre commande.';
        }
        
        // Créer le contenu de l'information
        const contenuInfo = `
            <div class="text-left space-y-4">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center bg-${couleurStatut}-100">
                        <i class="${iconeStatut} text-${couleurStatut}-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">${nomArticle}</h3>
                        <p class="text-sm text-gray-600">Informations sur le stock</p>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Stock disponible :</span>
                        <span class="font-bold text-${couleurStatut}-600 text-lg">${stockDisponible} unité${stockDisponible > 1 ? 's' : ''}</span>
                    </div>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">Statut :</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-${couleurStatut}-100 text-${couleurStatut}-800">
                            ${statutStock}
                        </span>
                    </div>
                    
                    <div class="p-3 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                        <div class="flex items-start gap-2">
                            <i class="fas fa-lightbulb text-blue-600 mt-1"></i>
                            <div>
                                <p class="font-medium text-blue-800 mb-1">${messageStatut}</p>
                                <p class="text-sm text-blue-700">
                                    La quantité maximale que vous pouvez commander est limitée à <strong>${stockDisponible}</strong> unité${stockDisponible > 1 ? 's' : ''} pour respecter le stock disponible.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${stockDisponible > 0 ? `
                        <div class="p-3 bg-green-50 border-l-4 border-green-400 rounded-r-lg">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-check text-green-600 mt-1"></i>
                                <div>
                                    <p class="font-medium text-green-800 mb-1">Commande possible</p>
                                    <p class="text-sm text-green-700">
                                        Vous pouvez commander jusqu'à <strong>${stockDisponible}</strong> unité${stockDisponible > 1 ? 's' : ''} de cet article.
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="p-3 bg-red-50 border-l-4 border-red-400 rounded-r-lg">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-times text-red-600 mt-1"></i>
                                <div>
                                    <p class="font-medium text-red-800 mb-1">Commande impossible</p>
                                    <p class="text-sm text-red-700">
                                        Cet article n'est plus disponible en stock. Contactez l'équipe pour plus d'informations.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
                
                <div class="text-xs text-gray-500 text-center pt-2 border-t border-gray-200">
                    <i class="fas fa-info-circle mr-1"></i>
                    Cette limite est mise à jour en temps réel selon les stocks disponibles.
                </div>
            </div>
        `;
        
        // Afficher la modal d'information avec SweetAlert2
        Swal.fire({
            title: '',
            html: contenuInfo,
            width: '600px',
            showCloseButton: true,
            showConfirmButton: false,
            customClass: {
                container: 'stock-info-modal',
                popup: 'stock-info-popup'
            }
        });
        
        console.log(`✅ Informations de stock affichées pour l'article ${articleId}`);
    };
    
    // Event listeners pour fermer les modales en cliquant à l'extérieur
    const modals = ['modalAjoutArticle', 'modalInfoUpsell', 'modalInfoPrix', 'modalInfoSousTotal', 'modalInfoTotal', 'modalConfirmation'];
    
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === this) {
                    // Fermer la modale selon son type
                    switch(modalId) {
                        case 'modalAjoutArticle':
                            fermerModalAjoutArticle();
                            break;
                        case 'modalInfoUpsell':
                            fermerModalInfoUpsell();
                            break;
                        case 'modalInfoPrix':
                            fermerModalInfoPrix();
                            break;
                        case 'modalInfoSousTotal':
                            fermerModalInfoSousTotal();
                            break;
                        case 'modalInfoTotal':
                            fermerModalInfoTotal();
                            break;
                        case 'modalConfirmation':
                            fermerModalConfirmation();
                            break;
                    }
                }
            });
        }
    });
    
    // Event listener pour fermer les modales avec la touche Escape
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            // Fermer la première modale ouverte
            if (!document.getElementById('modalAjoutArticle').classList.contains('hidden')) {
                fermerModalAjoutArticle();
            } else if (!document.getElementById('modalInfoUpsell').classList.contains('hidden')) {
                fermerModalInfoUpsell();
            } else if (!document.getElementById('modalInfoPrix').classList.contains('hidden')) {
                fermerModalInfoPrix();
            } else if (!document.getElementById('modalInfoSousTotal').classList.contains('hidden')) {
                fermerModalInfoSousTotal();
            } else if (!document.getElementById('modalInfoTotal').classList.contains('hidden')) {
                fermerModalInfoTotal();
            } else if (!document.getElementById('modalConfirmation').classList.contains('hidden')) {
                fermerModalConfirmation();
            }
        }
    });
    
    // Fonction pour vérifier l'état de la base de données
    function verifierEtatBaseDeDonnees() {
        console.log('🔍 Vérification de l\'état de la base de données...');
        
        // Vérifier les éléments de l'interface
        const articlesCount = document.querySelectorAll('tr[data-panier-id]').length;
        const compteurHeader = document.getElementById('compteur-upsell-header');
        const totalElements = document.querySelectorAll('.total-commande');
        
        console.log(`📦 Articles dans l'interface: ${articlesCount}`);
        console.log(`⬆️ Compteur upsell affiché: ${compteurHeader ? compteurHeader.textContent : 'Non trouvé'}`);
        console.log(`💰 Total affiché: ${totalElements.length > 0 ? totalElements[0].textContent : 'Non trouvé'}`);
        
        // Faire un appel API pour vérifier l'état réel
        fetch(`{% url 'Superpreparation:rafraichir_articles_commande_prepa' commande.id %}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('📊 État réel de la base de données:');
                console.log(`📦 Articles en DB: ${data.articles_count || 'Non défini'}`);
                console.log(`💰 Total en DB: ${data.total_commande || 'Non défini'}`);
                console.log(`⬆️ Compteur en DB: ${data.compteur || 'Non défini'}`);
                
                // Comparer avec l'interface
                if (data.articles_count !== undefined && data.articles_count !== articlesCount) {
                    console.warn(`⚠️ Incohérence: nombre d'articles différent entre interface (${articlesCount}) et DB (${data.articles_count})`);
                }
                if (data.compteur !== undefined && data.compteur !== compteurCommande) {
                    console.warn(`⚠️ Incohérence: compteur upsell différent entre interface (${compteurCommande}) et DB (${data.compteur})`);
                }
                
                // Si tout est cohérent
                if (data.articles_count === articlesCount && data.compteur === compteurCommande) {
                    console.log('✅ Interface et base de données sont cohérentes');
                }
            })
            .catch(error => {
                console.error('❌ Erreur lors de la vérification:', error);
                console.log('💡 Essayez de rafraîchir la page ou de recharger les données');
            });
    }

    // Initialisation du système upsell
    console.log('🚀 Initialisation du système upsell...');
    console.log(`📊 Compteur initial: ${compteurCommande}`);
    console.log(`📦 Articles dans le panier: ${document.querySelectorAll('tr[data-panier-id]').length}`);
    
    // Vérifier que l'élément compteur existe
    const compteurHeader = document.getElementById('compteur-upsell-header');
    if (!compteurHeader) {
        console.error('❌ Élément compteur-upsell-header non trouvé dans le DOM');
    } else {
        console.log('✅ Élément compteur-upsell-header trouvé');
    }
    
    // Fonction pour forcer la synchronisation des données
    function forcerSynchronisation() {
        console.log('🔄 Forçage de la synchronisation...');
        
        // Afficher un indicateur de chargement
        const syncBtn = document.querySelector('[onclick="forcerSynchronisation()"]');
        const originalText = syncBtn.innerHTML;
        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Sync...';
        syncBtn.disabled = true;
        
        // Vérifier l'état de la base de données
        verifierEtatBaseDeDonnees();
        
        // Restaurer le bouton après un délai
        setTimeout(() => {
            syncBtn.innerHTML = originalText;
            syncBtn.disabled = false;
        }, 2000);
    }

    // Fonction pour debugger les boutons d'ajout au panier
    window.debugBoutonsAjoutPanier = function() {
        console.log('🔍 Debug des boutons d\'ajout au panier...');
        
        const boutons = document.querySelectorAll('.btn-ajouter-panier');
        console.log(`📦 ${boutons.length} boutons d'ajout au panier trouvés`);
        
        boutons.forEach((btn, index) => {
            const articleId = btn.getAttribute('data-article-id');
            const onclick = btn.getAttribute('onclick');
            const isVisible = !btn.classList.contains('hidden');
            
            console.log(`🔍 Bouton ${index + 1}:`, {
                articleId: articleId,
                onclick: onclick,
                visible: isVisible,
                id: btn.id,
                classes: btn.className,
                disabled: btn.disabled,
                style: btn.style.cssText
            });
            
            // Vérifier si le bouton est dans le DOM et visible
            const rect = btn.getBoundingClientRect();
            console.log(`📐 Position du bouton ${index + 1}:`, {
                top: rect.top,
                left: rect.left,
                width: rect.width,
                height: rect.height,
                visible: rect.width > 0 && rect.height > 0
            });
            
            // Tester si le bouton a un event listener
            let eventTriggered = false;
            
            const originalOnClick = btn.onclick;
            btn.onclick = function(e) {
                eventTriggered = true;
                console.log(`✅ Event déclenché pour bouton ${index + 1} (article ${articleId})`);
                if (originalOnClick) originalOnClick.call(this, e);
            };
            
            // Déclencher un clic de test
            setTimeout(() => {
                console.log(`🧪 Test de clic pour bouton ${index + 1} (article ${articleId})`);
                btn.click();
                setTimeout(() => {
                    if (!eventTriggered) {
                        console.warn(`⚠️ Aucun event déclenché pour bouton ${index + 1} (article ${articleId})`);
                        // Essayer de déclencher manuellement
                        console.log(`🔄 Tentative de déclenchement manuel pour bouton ${index + 1}`);
                        const clickEvent = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        btn.dispatchEvent(clickEvent);
                    }
                    btn.onclick = originalOnClick;
                }, 100);
            }, index * 200);
        });
    };

    // Vérifier l'état de la base de données au chargement
    setTimeout(verifierEtatBaseDeDonnees, 1000);
    
    // Fonction globale pour forcer l'ajout d'un article (pour debug)
    window.forceAddArticle = function(articleId) {
        console.log('🚀 Force add article:', articleId);
        if (typeof window.ajouterArticleAuPanierDepuisBouton === 'function') {
            window.ajouterArticleAuPanierDepuisBouton(articleId);
        } else {
            console.error('❌ Fonction ajouterArticleAuPanierDepuisBouton non trouvée');
        }
    };
    
    // Fonction pour vérifier l'état des boutons dans le DOM
    window.checkButtonsInDOM = function() {
        console.log('🔍 Vérification des boutons dans le DOM...');
        
        // Vérifier tous les boutons d'ajout au panier
        const allButtons = document.querySelectorAll('[id^="btn-ajouter-panier-"]');
        console.log(`📦 ${allButtons.length} boutons d'ajout au panier trouvés dans le DOM`);
        
        allButtons.forEach((btn, index) => {
            const articleId = btn.id.replace('btn-ajouter-panier-', '');
            const rect = btn.getBoundingClientRect();
            const isVisible = !btn.classList.contains('hidden');
            const isInViewport = rect.width > 0 && rect.height > 0;
            
            console.log(`🔍 Bouton ${index + 1} (article ${articleId}):`, {
                id: btn.id,
                visible: isVisible,
                inViewport: isInViewport,
                position: { top: rect.top, left: rect.left, width: rect.width, height: rect.height },
                classes: btn.className,
                onclick: btn.getAttribute('onclick'),
                dataArticleId: btn.getAttribute('data-article-id')
            });
        });
        
        // Vérifier spécifiquement le bouton pour l'article 22
        const btn22 = document.getElementById('btn-ajouter-panier-22');
        if (btn22) {
            console.log('🎯 Bouton spécifique pour article 22 trouvé:', {
                visible: !btn22.classList.contains('hidden'),
                classes: btn22.className,
                onclick: btn22.getAttribute('onclick'),
                innerHTML: btn22.innerHTML
            });
        } else {
            console.error('❌ Bouton pour article 22 non trouvé dans le DOM');
        }
    };
    
    // Calculer et afficher le total des unités upsell
    const totalUpsell = calculerTotalUnitesUpsell();
    console.log(`⬆️ Total unités upsell: ${totalUpsell}`);
    
    // Vérifier la cohérence du compteur
    if (compteurCommande > 0 && totalUpsell === 0) {
        console.warn('⚠️ Compteur > 0 mais aucun article upsell trouvé');
        showNotificationToast('⚠️ Attention: Compteur upsell actif mais aucun article upsell détecté', 'warning');
    } else if (compteurCommande === 0 && totalUpsell > 1) {
        console.warn('⚠️ Articles upsell présents mais compteur = 0');
        showNotificationToast('⚠️ Attention: Articles upsell détectés mais compteur = 0. Utilisez le diagnostic pour corriger.', 'warning');
    }

    // Fonction pour ajouter un nouvel article
    window.ajouterNouvelArticle = function() {
        isEditingArticle = false;
        currentArticleId = null;
        
        // Mettre à jour le titre
        document.getElementById('articleModalTitle').textContent = 'Ajouter un article';
        
        // Afficher le champ de sélection, cacher l'affichage
        document.getElementById('article-selection-field').classList.remove('hidden');
        document.getElementById('article-display-field').classList.add('hidden');
        
        // Réinitialiser le formulaire
        document.getElementById('articleSelect').value = '';
        document.getElementById('quantiteInput').value = '1';
        document.getElementById('article-info').classList.add('hidden');
        
        // Charger la liste des articles
        chargerArticlesDisponibles();
        
        // Afficher la modale
        const modal = document.getElementById('modalAjoutArticle');
        
        if (!modal) {
            console.error('❌ Modale modalAjoutArticle introuvable lors de l\'ajout d\'article');
            return;
        }
        
        if (!modal.style) {
            console.error('❌ Propriété style non disponible sur modalAjoutArticle');
            return;
        }
        
        try {
            modal.style.display = 'flex';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        } catch (error) {
            console.error('❌ Erreur lors de l\'ouverture de la modal:', error);
        }
    };

    // Fonction pour sauvegarder l'article
    window.saveArticle = function() {
        const quantite = parseInt(document.getElementById('quantiteInput').value);
        
        if (!quantite || quantite < 1) {
            alert('⚠️ Veuillez saisir une quantité valide (minimum 1)');
            return;
        }
        
        const select = document.getElementById('articleSelect');
        if (!select.value) {
            alert('⚠️ Veuillez sélectionner un article');
            return;
        }
        
        const articleId = select.value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;

        if (!csrfToken) {
            showToast('❌ Erreur: Token de sécurité manquant. Veuillez rafraîchir la page.', 'error');
            return;
        }

        let action = isEditingArticle ? 'update_article' : 'add_article';
        
        let body = new URLSearchParams({
            'action': action,
            'article_id': articleId,
            'quantite': quantite,
        });

        if(isEditingArticle) {
            body.append('panier_id', currentArticleId);
        }

        fetch('{% url "Superpreparation:modifier_commande_superviseur" commande.id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: body
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => { 
                    throw new Error(`Erreur ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                let message = data.message || (isEditingArticle ? '✅ Article modifié' : '✅ Article ajouté');
                
                showToast(message, 'success');
                
                // Fermer la modale
                closeArticleModal();
                
             
            } else {
                showToast(`❌ Erreur: ${data.error}`, 'error');
            }
        })
        .catch(error => {
            handleError(error, 'ajout d\'article');
        });
    };

    // Fonction pour gérer les erreurs de manière globale
    function handleError(error, context = '') {
        console.error(`❌ Erreur ${context}:`, error);
        
        let errorMessage = 'Une erreur inattendue s\'est produite.';
        let errorTitle = 'Erreur';
        let errorIcon = 'error';
        
        if (error.message) {
            if (error.message.includes('couleur_fr')) {
                errorMessage = 'Erreur de configuration des couleurs d\'article. Veuillez contacter l\'administrateur.';
                errorTitle = 'Erreur de configuration';
            } else if (error.message.includes('total_articles')) {
                errorMessage = 'Erreur de calcul des totaux. Veuillez rafraîchir la page.';
                errorTitle = 'Erreur de calcul';
            } else if (error.message.includes('ReferenceError')) {
                errorMessage = 'Fonction non définie. Veuillez rafraîchir la page ou contacter l\'administrateur.';
                errorTitle = 'Erreur de fonction';
                errorIcon = 'warning';
            } else {
                errorMessage = error.message;
            }
        }
        
        // Afficher l'erreur avec plus de détails en mode développement
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            console.group('🔍 Détails de l\'erreur pour le développeur');
            console.error('Contexte:', context);
            console.error('Erreur complète:', error);
            console.error('Stack trace:', error.stack);
            console.groupEnd();
        }
        
        Swal.fire({
            icon: errorIcon,
            title: errorTitle,
            text: errorMessage,
            confirmButtonText: 'OK',
            footer: context ? `<small>Contexte: ${context}</small>` : ''
        });
    }

    // Fonction pour fermer la modale d'ajout d'article
    window.closeArticleModal = function() {
        const modal = document.getElementById('modalAjoutArticle');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    };

    // Surcouche pour trier les variantes par stock disponible avant affichage
    const _afficherArticlesOriginal = typeof afficherArticles === 'function' ? afficherArticles : null;
    if (_afficherArticlesOriginal) {
        afficherArticles = function(articles) {
            try {
                const prepared = (articles || []).map(a => {
                    const variants = Array.isArray(a.variantes_all) ? a.variantes_all.slice() : [];
                    variants.sort((va, vb) => {
                        const aHas = (va.qte_disponible || 0) > 0 ? 1 : 0;
                        const bHas = (vb.qte_disponible || 0) > 0 ? 1 : 0;
                        if (aHas !== bHas) return bHas - aHas; // disponibles d'abord
                        return (vb.qte_disponible || 0) - (va.qte_disponible || 0); // puis décroissant
                    });
                    a.variantes_all = variants;
                    return a;
                });
                _afficherArticlesOriginal(prepared);
                setTimeout(configurerEventListenersQuantite, 50);
            } catch (e) {
                console.warn('Tri variantes ignoré (erreur mineure):', e);
                _afficherArticlesOriginal(articles);
            }
        }
    }

    // Améliorer la limite de quantité: désactiver/activer les boutons +/- selon min/max
    function _majEtatsBoutonsQuantite(articleId) {
        const input = document.getElementById(`qte-article-${articleId}`);
        if (!input) return;
        const min = parseInt(input.getAttribute('min')) || 1;
        const max = parseInt(input.getAttribute('max')) || 999999;
        const val = parseInt(input.value) || min;
        const dec = document.querySelector(`[data-article-id="${articleId}"][data-action="decrease"]`);
        const inc = document.querySelector(`[data-article-id="${articleId}"][data-action="increase"]`);
        if (dec) dec.disabled = val <= min;
        if (inc) inc.disabled = val >= max;
    }

    // Étendre la fonction existante pour prendre en compte le max dynamique
    const _modifierQuantiteArticleOrig = window.modifierQuantiteArticle;
    window.modifierQuantiteArticle = function(articleId, delta) {
        if (typeof _modifierQuantiteArticleOrig === 'function') {
            _modifierQuantiteArticleOrig(articleId, delta);
        } else {
            const input = document.getElementById(`qte-article-${articleId}`);
            if (!input) return;
            const min = parseInt(input.getAttribute('min')) || 1;
            const max = parseInt(input.getAttribute('max')) || 999999;
            const cur = parseInt(input.value) || min;
            const next = Math.min(Math.max(cur + delta, min), max);
            input.value = next;
        }
        _majEtatsBoutonsQuantite(articleId);
    };

    // Lors de la sélection d'une variante, caler le max de quantité et badges visuels
    const _selectionnerArticleOrig = window.selectionnerArticle;
    window.selectionnerArticle = function(articleId, articleName, varianteId) {
        try {
            // mémoriser la variante
            if (typeof varianteId !== 'undefined' && varianteId !== null) {
                window._varianteSelection = window._varianteSelection || {};
                window._varianteSelection[articleId] = parseInt(varianteId);
            }
            // si on connaît la variante dans la carte, récupérer son stock pour limiter
            if (window._articlesCache && window._articlesCache[articleId]) {
                const art = window._articlesCache[articleId];
                const list = Array.isArray(art.variantes_all) ? art.variantes_all : [];
                const vId = window._varianteSelection ? window._varianteSelection[articleId] : null;
                const found = list.find(v => parseInt(v.id) === parseInt(vId));
                if (found) {
                    const input = document.getElementById(`qte-article-${articleId}`);
                    if (input) {
                        input.setAttribute('max', Math.max(0, parseInt(found.qte_disponible || 0)));
                        if (parseInt(input.value) > parseInt(input.getAttribute('max'))) {
                            input.value = input.getAttribute('max') || '1';
                        }
                        _majEtatsBoutonsQuantite(articleId);
                    }
                }
            }
        } catch (e) { console.warn('sélection variante: max non appliqué', e); }
        if (typeof _selectionnerArticleOrig === 'function') {
            return _selectionnerArticleOrig(articleId, articleName, varianteId);
        }
    };

    // Enrichir le rendu des cartes variantes avec badges (si le rendu existe)
    window._renderBadgeVariante = function(qte) {
        if (!qte || qte <= 0) {
            return '<span class="ml-2 px-2 py-0.5 rounded-full text-[10px] font-bold bg-red-100 text-red-700">Rupture</span>';
        }
        if (qte <= 5) {
            return '<span class="ml-2 px-2 py-0.5 rounded-full text-[10px] font-bold bg-orange-100 text-orange-700">Faible stock</span>';
        }
        return '';
    };

    // Après affichage, recalculer l'état des boutons
    document.addEventListener('input', function(e){
        if (e.target && e.target.id && e.target.id.startsWith('qte-article-')) {
            const id = e.target.id.replace('qte-article-', '');
            _majEtatsBoutonsQuantite(id);
        }
    });

    // Fonctions pour le modal des variantes
    window.ouvrirModalVariantes = function(article) {
        try {
            console.log('🎯 Ouverture modal variantes pour article:', article);
            
            const modal = document.getElementById('modalVariantes');
            if (!modal) {
                console.error('❌ Modal variantes non trouvé');
                return;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Charger les variantes de l'article
            chargerVariantesArticle(article);
            
        } catch (e) {
            console.error('❌ Erreur ouverture modal variantes:', e);
        }
    };

    window.fermerModalVariantes = function() {
        const modal = document.getElementById('modalVariantes');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
    };

    function chargerVariantesArticle(article) {
        const variantsList = document.getElementById('variantsList');
        if (!variantsList) {
            console.error('❌ Container variantsList non trouvé');
            return;
        }
        
        // Afficher un indicateur de chargement
        variantsList.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Chargement des variantes...</div>';
        
        // Appel AJAX pour récupérer les variantes
        fetch(`{% url 'Superpreparation:get_article_variants' 0 %}`.replace('0', article.id))
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('✅ Variantes chargées:', data.variants);
                    afficherVariantes(data.variants, article);
                } else {
                    console.error('❌ Erreur chargement variantes:', data.error);
                    variantsList.innerHTML = '<div class="text-center py-4 text-red-500">Erreur lors du chargement des variantes</div>';
                }
            })
            .catch(error => {
                console.error('❌ Erreur réseau:', error);
                variantsList.innerHTML = '<div class="text-center py-4 text-red-500">Erreur de connexion</div>';
            });
    }

    function afficherVariantes(variants, article) {
        const variantsList = document.getElementById('variantsList');
        
        if (!variants || variants.length === 0) {
            variantsList.innerHTML = '<div class="text-center py-4 text-gray-500">Aucune variante disponible</div>';
            return;
        }

        // Créer un tableau HTML complet pour les variantes avec des bordures visibles
        const tableHTML = `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border-2 border-gray-300 rounded-lg shadow-lg" style="border-collapse: collapse;">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Variante</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Prix</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Stock</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Quantité</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Référence</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700 uppercase tracking-wider border-2 border-gray-300 bg-gray-200">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                        ${variants.map(variant => {
                            const stockDisponible = parseInt(variant.qte_disponible || variant.stock) || 0;
                            const stockClass = stockDisponible > 0 ? 'text-green-600' : 'text-red-600';
                            const stockStatus = stockDisponible > 0 ? 
                                `<span class="font-semibold text-green-600">${stockDisponible}</span>` : 
                                `<span class="font-semibold text-red-600">Rupture</span>`;
                            
                            return `
                                <tr class="hover:bg-gray-50 transition-colors ${stockDisponible <= 0 ? 'opacity-50' : ''}">
                                    <td class="px-4 py-3 border-2 border-gray-300">
                                        <div class="text-sm font-medium text-gray-900">
                                            ${variant.couleur || 'N/A'} - ${variant.pointure || 'N/A'}
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <div class="text-sm font-semibold text-green-600">${variant.prix_actuel} DH</div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <span class="text-sm ${stockClass}">${stockStatus}</span>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        ${stockDisponible > 0 ? `
                                            <div class="flex items-center justify-center gap-2">
                                                <button type="button" onclick="changeQuantiteVariante(${variant.id}, -1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors">-</button>
                                                <input type="number" id="qte-variante-${variant.id}" class="w-16 p-2 border rounded-lg text-center text-sm" value="1" min="1" max="${stockDisponible}">
                                                <button type="button" onclick="changeQuantiteVariante(${variant.id}, 1)" class="w-6 h-6 bg-gray-200 hover:bg-gray-300 rounded text-sm transition-colors">+</button>
                                            </div>
                                        ` : `
                                            <span class="text-red-500 text-sm font-medium">-</span>
                                        `}
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        <div class="text-sm text-gray-600">${variant.reference_variante || 'N/A'}</div>
                                    </td>
                                    <td class="px-4 py-3 text-center border-2 border-gray-300">
                                        ${stockDisponible > 0 ? `
                                            <button type="button" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors" 
                                                    onclick="console.log('🖱️ Clic sur Sélectionner variante', ${variant.id}); selectionnerVariante(${variant.id}, ${article.id})">
                                                <i class="fas fa-check mr-1"></i>Sélectionner
                                            </button>
                                        ` : `
                                            <span class="text-red-500 text-sm font-medium">Indisponible</span>
                                        `}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        variantsList.innerHTML = tableHTML;
    }

    window.selectionnerVariante = function(variantId, articleId) {
        console.log('🔄 ===== DÉBUT selectionnerVariante =====');
        console.log('📦 Variante ID reçu:', variantId);
        console.log('📦 Article ID reçu:', articleId);
        console.log('📦 Type de variantId:', typeof variantId);
        console.log('📦 Type de articleId:', typeof articleId);
        
        try {
            // Récupérer les objets complets depuis les données stockées
            const article = window.articlesList ? window.articlesList.find(a => a.id === parseInt(articleId)) : null;
            const variant = article && article.variantes_all ? article.variantes_all.find(v => v.id === parseInt(variantId)) : null;
            
            console.log('🔍 Article trouvé:', article);
            console.log('🔍 Variante trouvée:', variant);
            
            if (!article || !variant) {
                console.error('❌ Article ou variante non trouvé');
                return;
            }
            
            console.log('🎯 Sélection de variante:', variant);
            
            // Fermer le modal des variantes
            fermerModalVariantes();
            
            // Récupérer la quantité depuis l'input de la variante
            const quantiteInput = document.getElementById(`qte-variante-${variant.id}`);
            if (!quantiteInput) {
                console.error(`❌ Input de quantité non trouvé pour la variante ${variant.id}`);
                return;
            }
            
            const quantite = parseInt(quantiteInput.value, 10);
            if (isNaN(quantite) || quantite <= 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Quantité invalide',
                    text: 'Veuillez entrer une quantité valide (minimum 1).',
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Vérifier que la quantité ne dépasse pas le stock disponible
            if (quantite > variant.stock) {
                Swal.fire({
                    icon: 'error',
                    title: 'Quantité trop élevée',
                    text: `La quantité demandée (${quantite}) dépasse le stock disponible (${variant.stock}).`,
                    confirmButtonText: 'OK'
                });
                return;
            }
            
            // Créer un article combiné avec les données de la variante
            const articleAvecVariante = {
                ...article,
                // Ajouter les caractéristiques de la variante
                couleur: variant.couleur,
                pointure: variant.pointure,
                // Utiliser les prix et stock de la variante
                prix_actuel: variant.prix_actuel,
                qte_disponible: variant.stock,
                // Ajouter l'ID de la variante pour référence
                variante_id: variant.id,
                reference_variante: variant.reference_variante,
                // Ajouter la quantité sélectionnée
                quantite: quantite
            };
            
            console.log('🔄 Article avec variante créé:', articleAvecVariante);
            
            // Stocker l'article avec variante pour l'utiliser lors de l'ajout
            window.selectedArticleWithVariant = articleAvecVariante;
            
            // Mettre à jour la variante sélectionnée dans la sélection globale
            window._varianteSelection = window._varianteSelection || {};
            window._varianteSelection[article.id] = variant.id;
            
            // Masquer le bouton "Choisir variante" et afficher le bouton "Ajouter au panier"
            console.log('🔧 Recherche des boutons pour article ID:', article.id);
            const btnVariantes = document.getElementById(`btn-variantes-${article.id}`);
            const btnAjouterPanier = document.getElementById(`btn-ajouter-panier-${article.id}`);
            
            console.log('🔍 Boutons trouvés:', {
                btnVariantes: btnVariantes ? 'OUI' : 'NON',
                btnAjouterPanier: btnAjouterPanier ? 'OUI' : 'NON'
            });
            
            if (btnVariantes) {
                btnVariantes.classList.add('hidden');
                btnVariantes.classList.remove('inline-flex');
                console.log('✅ Bouton variantes masqué');
            } else {
                console.error('❌ Bouton variantes non trouvé');
            }
            
            if (btnAjouterPanier) {
                btnAjouterPanier.classList.remove('hidden');
                btnAjouterPanier.classList.add('inline-flex');
                
                // Utiliser uniquement l'attribut onclick qui fonctionne
                const articleId = btnAjouterPanier.getAttribute('data-article-id');
                
                // Modifier le contenu AVANT d'ajouter l'onclick
                btnAjouterPanier.innerHTML = `
                    <i class="fas fa-shopping-cart mr-1"></i>Ajouter variante au panier
                `;
                
                // Ajouter l'onclick APRÈS avoir modifié le contenu
                btnAjouterPanier.setAttribute('onclick', `console.log('🖱️ Clic sur bouton principal pour article ${articleId}'); ajouterArticleAuPanierDepuisBouton(${articleId})`);
                
                // Ajouter également un event listener comme fallback
                btnAjouterPanier.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🖱️ Event listener déclenché pour article', articleId);
                    if (typeof window.ajouterArticleAuPanierDepuisBouton === 'function') {
                        window.ajouterArticleAuPanierDepuisBouton(articleId);
                    } else {
                        console.error('❌ Fonction ajouterArticleAuPanierDepuisBouton non trouvée');
                    }
                });
                
                console.log('✅ Onclick ajouté au bouton principal pour article', articleId);
                console.log('✅ Event listener ajouté comme fallback pour article', articleId);
                console.log('🔍 Onclick final:', btnAjouterPanier.getAttribute('onclick'));
                
                // Vérifier l'état final du bouton
                console.log('🔍 État final du bouton:');
                console.log('  - Visible:', !btnAjouterPanier.classList.contains('hidden'));
                console.log('  - Classes:', btnAjouterPanier.className);
                console.log('  - ID:', btnAjouterPanier.id);
                console.log('  - data-article-id:', btnAjouterPanier.getAttribute('data-article-id'));
                console.log('  - onclick:', btnAjouterPanier.getAttribute('onclick'));
                console.log('  - innerHTML:', btnAjouterPanier.innerHTML);
                
                console.log('✅ Bouton ajouter panier affiché avec event listener ajouté pour article', articleId);
                
                // Test manuel du bouton après 1 seconde
                setTimeout(() => {
                    console.log('🧪 Test manuel du bouton pour article', articleId);
                    const testBtn = document.getElementById(`btn-ajouter-panier-${articleId}`);
                    if (testBtn) {
                        console.log('🔍 Bouton trouvé pour test, déclenchement du clic...');
                        
                        // Vérifier si le bouton est réellement visible
                        const rect = testBtn.getBoundingClientRect();
                        console.log('📐 Position du bouton de test:', {
                            top: rect.top,
                            left: rect.left,
                            width: rect.width,
                            height: rect.height,
                            visible: rect.width > 0 && rect.height > 0
                        });
                        
                        // Vérifier si le bouton est dans le viewport
                        const isInViewport = rect.top >= 0 && rect.left >= 0 && 
                                           rect.bottom <= window.innerHeight && 
                                           rect.right <= window.innerWidth;
                        console.log('👁️ Bouton dans le viewport:', isInViewport);
                        
                        // Essayer de cliquer sur le bouton
                        testBtn.click();
                        
                        // Si le clic ne fonctionne pas, essayer de déclencher l'événement manuellement
                        setTimeout(() => {
                            console.log('🔄 Tentative de déclenchement manuel de l\'événement...');
                            const clickEvent = new MouseEvent('click', {
                                bubbles: true,
                                cancelable: true,
                                view: window
                            });
                            testBtn.dispatchEvent(clickEvent);
                        }, 100);
                        
                    } else {
                        console.error('❌ Bouton non trouvé pour test manuel');
                    }
                }, 1000);
            } else {
                console.error('❌ Bouton ajouter panier non trouvé');
            }
            
            // Modifier l'affichage de l'article dans la liste pour montrer la variante sélectionnée
            const row = document.querySelector(`[onclick*="selectionnerArticle(${article.id}"]`)?.closest('tr');
            if (row) {
                const articleInfo = row.querySelector('.text-sm.text-gray-500');
                if (articleInfo) {
                    articleInfo.innerHTML = `Réf: ${article.reference || 'N/A'} | <span class="text-blue-600 font-medium">${variant.couleur || 'N/A'}</span> | <span class="text-blue-600 font-medium">${variant.pointure || 'N/A'}</span> | <span class="text-orange-600 font-medium">Qte: ${quantite}</span> <span class="text-green-600">(Variante sélectionnée)</span>`;
                }
            }
            
            // Afficher une notification de succès
            if (typeof showNotificationToast === 'function') {
                showNotificationToast(`✅ Variante sélectionnée: ${variant.couleur || 'N/A'} - ${variant.pointure || 'N/A'} (${quantite} unités). Cliquez sur "Ajouter variante au panier" pour confirmer.`, 'success');
            }
            
            console.log('✅ ===== FIN selectionnerVariante (SUCCÈS) =====');
            
        } catch (e) {
            console.error('❌ ===== ERREUR selectionnerVariante =====');
            console.error('❌ Exception:', e);
            console.error('❌ Stack trace:', e.stack);
            if (typeof showNotificationToast === 'function') {
                showNotificationToast('❌ Erreur lors de la sélection de la variante', 'error');
            }
        }
    };
    
    // Fonction pour changer la quantité d'une variante
    window.changeQuantiteVariante = function(variantId, delta) {
        const input = document.getElementById(`qte-variante-${variantId}`);
        if (input) {
            const newValue = Math.max(1, parseInt(input.value) + delta);
            const maxStock = parseInt(input.getAttribute('max')) || 99;
            if (newValue <= maxStock) {
                input.value = newValue;
            }
        }
    };
    
    // Fonction pour afficher les variantes en rupture
    window.afficherVariantesEnRupture = function(articleId, variantesEnRupture) {
        console.log('📋 Affichage des variantes en rupture pour l\'article', articleId, variantesEnRupture);
        
        // Créer le contenu HTML pour le modal
        let variantesHTML = '';
        if (variantesEnRupture && variantesEnRupture.length > 0) {
            variantesHTML = `
                <div class="space-y-3">
                    ${variantesEnRupture.map(variante => `
                        <div class="p-3 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
                                            ${variante.couleur || 'N/A'}
                                        </span>
                                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
                                            ${variante.pointure || 'N/A'}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        Réf: ${variante.reference_variante || 'N/A'}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm font-semibold text-red-600">Rupture</div>
                                    <div class="text-xs text-gray-500">Stock: 0</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            variantesHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-info-circle text-2xl mb-2"></i>
                    <p>Aucune variante en rupture</p>
                </div>
            `;
        }
        
        // Afficher le modal avec SweetAlert2
        Swal.fire({
            title: '<div class="flex items-center gap-2"><i class="fas fa-exclamation-triangle text-red-500"></i><span>Variantes en rupture</span></div>',
            html: `
                <div class="text-left">
                    <p class="mb-4 text-sm text-gray-600">Les variantes suivantes sont actuellement en rupture de stock :</p>
                    ${variantesHTML}
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Compris',
            confirmButtonColor: '#3085d6',
            width: '600px'
        });
    };

    // Fonction de test pour valider le calcul du stock général
    window.testerCalculStockGeneral = function() {
        console.log('🧪 Test du calcul du stock général...');
        
        // Créer des données de test
        const articleTest = {
            id: 999,
            nom: "Article Test",
            variantes_all: [
                { id: 1, qte_disponible: 5, couleur: "Rouge", pointure: "42" },
                { id: 2, qte_disponible: 0, couleur: "Bleu", pointure: "42" },
                { id: 3, qte_disponible: 3, couleur: "Vert", pointure: "43" },
                { id: 4, qte_disponible: null, stock: 2, couleur: "Noir", pointure: "44" }, // Test fallback
            ]
        };
        
        // Test du calcul
        let stockGeneral = 0;
        let variantesEnRupture = [];
        
        if (articleTest.variantes_all && Array.isArray(articleTest.variantes_all)) {
            stockGeneral = articleTest.variantes_all.reduce((total, variante) => {
                const stockVariante = parseInt(variante.qte_disponible || variante.stock) || 0;
                console.log(`  - Variante ${variante.id} (${variante.couleur} ${variante.pointure}): ${stockVariante} unités`);
                if (stockVariante === 0) {
                    variantesEnRupture.push(variante);
                }
                return total + stockVariante;
            }, 0);
        }
        
        const resultExpected = 5 + 0 + 3 + 2; // = 10
        const success = stockGeneral === resultExpected;
        
        console.log(`📊 Résultat du test:`);
        console.log(`   Stock calculé: ${stockGeneral}`);
        console.log(`   Stock attendu: ${resultExpected}`);
        console.log(`   Variantes en rupture: ${variantesEnRupture.length}`);
        console.log(`   Test ${success ? '✅ RÉUSSI' : '❌ ÉCHOUÉ'}`);
        
        if (success) {
            showNotificationToast('✅ Test du calcul de stock réussi!', 'success');
        } else {
            showNotificationToast('❌ Test du calcul de stock échoué!', 'error');
        }
        
        return success;
    };


});
</script>

<!-- Modal de sélection des variantes -->
<div id="modalVariantes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b border-gray-200">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-layer-group text-blue-500 mr-2"></i>
                        <span>Sélectionner une variante</span>
                    </h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600">
                        <span class="text-gray-500 hover:text-gray-700 cursor-pointer transition-colors" onclick="fermerModalVariantes()">
                            <i class="fas fa-times text-xl"></i>
                        </span>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <p class="text-sm text-gray-600">Sélectionnez une variante de l'article pour l'ajouter au panier :</p>
                </div>
                
                <!-- Liste des variantes -->
                <div id="variantsList">
                    <!-- Les variantes seront chargées dynamiquement ici -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="fermerModalVariantes()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">Fermer</button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %} 